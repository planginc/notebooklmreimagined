{"type":"file-history-snapshot","messageId":"973ebb96-60df-4671-b9c2-0c4aefc8516e","snapshot":{"messageId":"973ebb96-60df-4671-b9c2-0c4aefc8516e","trackedFileBackups":{},"timestamp":"2026-01-10T17:26:46.087Z"},"isSnapshotUpdate":false}
{"parentUuid":null,"isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","type":"user","message":{"role":"user","content":"Read .claude/skills/implement-notebook-export.md and implement everything in it"},"uuid":"973ebb96-60df-4671-b9c2-0c4aefc8516e","timestamp":"2026-01-10T17:26:46.072Z","thinkingMetadata":{"level":"high","disabled":false,"triggers":[]},"todos":[]}
{"parentUuid":"973ebb96-60df-4671-b9c2-0c4aefc8516e","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","message":{"model":"claude-opus-4-5-20251101","id":"msg_01XkcjzDyKQd79zHrw6DrEtA","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"The user wants me to read a skills file and implement everything in it. Let me start by reading that file.","signature":"EpICCkYICxgCKkCTS4kjlRyOT26f4ka5E+25Zv2G5TEz/7rpDCwjvmHzcpqPKmn89GbtnQzVe00Eg/OMwYFCdVMFWVy+znrQirSPEgwXkjJVMJo4dvDOm0oaDP3w4T4bd6DhC+koDyIwXKfRPy9cIUeyJyfor2WoTGHcerkBYZCAJreWuwjtoaPvcohRc7vd44yorKEV2aQrKnrWHsMbn9tysIMH56HIRhwOkh9ifumUjaV/SontnhwhErLkH+bDyKKS3lpppOfJPBdHzdPhZSYfL9nE/uUmhkhDMEnzGlI7IononJIuVBOB8StSBx+hnCIHSIIvjNnX7Eko5/99De3nloe/1MAPH/PAQdSe11+cbADYSBgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":9,"cache_creation_input_tokens":2607,"cache_read_input_tokens":33616,"cache_creation":{"ephemeral_5m_input_tokens":2607,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CWz6A8xAuCJk9iXCpDDUT","type":"assistant","uuid":"0427b47b-d64d-4fc5-bafb-ce23b796a2c7","timestamp":"2026-01-10T17:26:49.639Z"}
{"parentUuid":"0427b47b-d64d-4fc5-bafb-ce23b796a2c7","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","message":{"model":"claude-opus-4-5-20251101","id":"msg_01XkcjzDyKQd79zHrw6DrEtA","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_013BmeN3c83jKCtWTcxmMAM8","name":"Read","input":{"file_path":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/.claude/skills/implement-notebook-export.md"}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":9,"cache_creation_input_tokens":2607,"cache_read_input_tokens":33616,"cache_creation":{"ephemeral_5m_input_tokens":2607,"ephemeral_1h_input_tokens":0},"output_tokens":118,"service_tier":"standard"}},"requestId":"req_011CWz6A8xAuCJk9iXCpDDUT","type":"assistant","uuid":"4616ba8a-37db-47c6-9e32-49fd9328e6dc","timestamp":"2026-01-10T17:26:50.203Z"}
{"parentUuid":"4616ba8a-37db-47c6-9e32-49fd9328e6dc","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_013BmeN3c83jKCtWTcxmMAM8","type":"tool_result","content":"     1→# Skill: Implement Full Notebook Export\n     2→\n     3→Use this skill to implement the One-Click Full Notebook Export feature for NotebookLM Reimagined.\n     4→\n     5→## Overview\n     6→\n     7→Add the ability to export an entire notebook as a downloadable bundle containing:\n     8→- All sources (files, text content, URLs)\n     9→- All chat conversations with citations\n    10→- All notes\n    11→- All generated content (audio scripts, study materials, reports, etc.)\n    12→- Notebook metadata\n    13→\n    14→Export formats: ZIP (with JSON + files) or single PDF document.\n    15→\n    16→## Codebase Context\n    17→\n    18→### Project Structure\n    19→```\n    20→frontend/src/\n    21→├── lib/export-utils.ts              # EXPAND THIS FILE\n    22→├── app/notebooks/[id]/page.tsx      # Add export button (minor)\n    23→├── components/studio/studio-panel.tsx # Alternative location for export button\n    24→└── lib/supabase.ts                  # Supabase client reference\n    25→\n    26→backend/app/\n    27→├── routers/                         # CREATE: export.py\n    28→├── main.py                          # Register new router\n    29→└── services/supabase_client.py      # Reference for storage access\n    30→```\n    31→\n    32→### Database Tables to Export\n    33→```sql\n    34→-- notebooks: id, name, description, emoji, settings, created_at\n    35→-- sources: id, name, type, status, metadata, source_guide, file_path\n    36→-- chat_sessions: id, title, created_at\n    37→-- chat_messages: session_id, role, content, citations, created_at\n    38→-- notes: id, title, content, tags, is_pinned, created_at\n    39→-- audio_overviews: id, format, script, audio_file_path, status\n    40→-- video_overviews: id, style, script, video_file_path, status\n    41→-- study_materials: id, type, data\n    42→-- studio_outputs: id, type, title, content\n    43→-- research_tasks: id, query, report_content, report_citations\n    44→```\n    45→\n    46→### Existing Export Utils\n    47→File `frontend/src/lib/export-utils.ts` already has:\n    48→- `downloadAsExcel()` - Excel export\n    49→- `downloadAsPDF()` - PDF generation with jsPDF\n    50→- `exportSVGToPNG()` - Image export\n    51→- `downloadBlob()` - Generic blob download\n    52→- Various study material exporters\n    53→\n    54→## Implementation Plan\n    55→\n    56→### Step 1: Create Backend Export Router\n    57→File: `backend/app/routers/export.py`\n    58→\n    59→```python\n    60→from fastapi import APIRouter, HTTPException, Depends\n    61→from fastapi.responses import StreamingResponse\n    62→from typing import Optional\n    63→from uuid import UUID\n    64→import json\n    65→import zipfile\n    66→import io\n    67→\n    68→from app.services.auth import get_current_user\n    69→from app.services.supabase_client import get_supabase_client\n    70→\n    71→router = APIRouter(prefix=\"/notebooks/{notebook_id}/export\", tags=[\"export\"])\n    72→\n    73→@router.get(\"/json\")\n    74→async def export_notebook_json(\n    75→    notebook_id: UUID,\n    76→    include_sources: bool = True,\n    77→    include_chats: bool = True,\n    78→    include_notes: bool = True,\n    79→    include_generated: bool = True,\n    80→    user: dict = Depends(get_current_user),\n    81→):\n    82→    \"\"\"Export notebook data as JSON.\"\"\"\n    83→    # Verify access, gather all data, return JSON\n    84→    pass\n    85→\n    86→@router.get(\"/zip\")\n    87→async def export_notebook_zip(\n    88→    notebook_id: UUID,\n    89→    include_sources: bool = True,\n    90→    include_chats: bool = True,\n    91→    include_notes: bool = True,\n    92→    include_generated: bool = True,\n    93→    user: dict = Depends(get_current_user),\n    94→):\n    95→    \"\"\"Export notebook as ZIP with all files.\"\"\"\n    96→    # Create ZIP in memory with:\n    97→    # - notebook.json (metadata)\n    98→    # - sources/ folder with actual files from storage\n    99→    # - chats.json\n   100→    # - notes.json\n   101→    # - generated/ folder\n   102→    pass\n   103→```\n   104→\n   105→### Step 2: Register Router in main.py\n   106→```python\n   107→from app.routers import export\n   108→app.include_router(export.router)\n   109→```\n   110→\n   111→### Step 3: Add Frontend API Route\n   112→File: `frontend/src/app/api/notebooks/[id]/export/route.ts`\n   113→\n   114→Proxy to backend export endpoints.\n   115→\n   116→### Step 4: Expand export-utils.ts\n   117→Add new functions:\n   118→```typescript\n   119→export async function exportNotebookAsZip(\n   120→  notebookId: string,\n   121→  options: ExportOptions\n   122→): Promise<void> {\n   123→  // Call backend /export/zip endpoint\n   124→  // Trigger download\n   125→}\n   126→\n   127→export async function exportNotebookAsPDF(\n   128→  notebookId: string,\n   129→  options: ExportOptions\n   130→): Promise<void> {\n   131→  // Fetch all data via /export/json\n   132→  // Generate comprehensive PDF client-side\n   133→}\n   134→\n   135→interface ExportOptions {\n   136→  includeSources?: boolean\n   137→  includeChats?: boolean\n   138→  includeNotes?: boolean\n   139→  includeGenerated?: boolean\n   140→  format: 'zip' | 'pdf'\n   141→}\n   142→```\n   143→\n   144→### Step 5: Add Export UI\n   145→Location: `frontend/src/components/studio/studio-panel.tsx` OR notebook header\n   146→\n   147→Add:\n   148→- Export button with dropdown (ZIP / PDF)\n   149→- Options dialog for include/exclude toggles\n   150→- Progress indicator for large exports\n   151→\n   152→## ZIP Structure\n   153→```\n   154→notebook-export-{name}-{date}/\n   155→├── notebook.json           # Metadata: name, description, settings\n   156→├── sources/\n   157→│   ├── index.json         # Source metadata\n   158→│   ├── document1.pdf      # Actual files from storage\n   159→│   └── document2.txt\n   160→├── chats/\n   161→│   ├── index.json         # All sessions and messages\n   162→│   └── session-{id}.json  # Individual session files\n   163→├── notes/\n   164→│   └── index.json         # All notes\n   165→├── generated/\n   166→│   ├── audio/\n   167→│   │   └── podcast.mp3\n   168→│   ├── study-materials/\n   169→│   │   ├── flashcards.json\n   170→│   │   └── quiz.json\n   171→│   └── studio/\n   172→│       ├── report.json\n   173→│       └── slides.json\n   174→└── README.md              # Export info and instructions\n   175→```\n   176→\n   177→## Files to Create/Modify\n   178→\n   179→| File | Action |\n   180→|------|--------|\n   181→| `backend/app/routers/export.py` | CREATE - Export endpoints |\n   182→| `backend/app/main.py` | MODIFY - Register router |\n   183→| `frontend/src/app/api/notebooks/[id]/export/route.ts` | CREATE - API route |\n   184→| `frontend/src/lib/export-utils.ts` | MODIFY - Add notebook export functions |\n   185→| `frontend/src/components/studio/studio-panel.tsx` | MODIFY - Add export button |\n   186→\n   187→## Files NOT to Touch\n   188→- `chat-panel.tsx`\n   189→- `sources-panel.tsx`\n   190→- Database schema (read-only)\n   191→- Any other routers\n   192→\n   193→## Testing Checklist\n   194→- [ ] ZIP export downloads correctly\n   195→- [ ] ZIP contains all expected folders/files\n   196→- [ ] Source files are included from storage\n   197→- [ ] Chat history exports with citations\n   198→- [ ] Notes export correctly\n   199→- [ ] Generated content (audio, study materials) included\n   200→- [ ] Large notebooks don't timeout\n   201→- [ ] Empty notebooks export gracefully\n   202→- [ ] PDF export generates readable document\n   203→\n   204→## Definition of Done\n   205→1. User can export notebook as ZIP with one click\n   206→2. ZIP contains organized folder structure\n   207→3. All notebook data is included based on options\n   208→4. Export works for notebooks of any size\n   209→5. Clear error handling for edge cases\n   210→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"1d6174ca-2ecf-4479-9f79-2b5e318b2d8d","timestamp":"2026-01-10T17:26:50.234Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/.claude/skills/implement-notebook-export.md","content":"# Skill: Implement Full Notebook Export\n\nUse this skill to implement the One-Click Full Notebook Export feature for NotebookLM Reimagined.\n\n## Overview\n\nAdd the ability to export an entire notebook as a downloadable bundle containing:\n- All sources (files, text content, URLs)\n- All chat conversations with citations\n- All notes\n- All generated content (audio scripts, study materials, reports, etc.)\n- Notebook metadata\n\nExport formats: ZIP (with JSON + files) or single PDF document.\n\n## Codebase Context\n\n### Project Structure\n```\nfrontend/src/\n├── lib/export-utils.ts              # EXPAND THIS FILE\n├── app/notebooks/[id]/page.tsx      # Add export button (minor)\n├── components/studio/studio-panel.tsx # Alternative location for export button\n└── lib/supabase.ts                  # Supabase client reference\n\nbackend/app/\n├── routers/                         # CREATE: export.py\n├── main.py                          # Register new router\n└── services/supabase_client.py      # Reference for storage access\n```\n\n### Database Tables to Export\n```sql\n-- notebooks: id, name, description, emoji, settings, created_at\n-- sources: id, name, type, status, metadata, source_guide, file_path\n-- chat_sessions: id, title, created_at\n-- chat_messages: session_id, role, content, citations, created_at\n-- notes: id, title, content, tags, is_pinned, created_at\n-- audio_overviews: id, format, script, audio_file_path, status\n-- video_overviews: id, style, script, video_file_path, status\n-- study_materials: id, type, data\n-- studio_outputs: id, type, title, content\n-- research_tasks: id, query, report_content, report_citations\n```\n\n### Existing Export Utils\nFile `frontend/src/lib/export-utils.ts` already has:\n- `downloadAsExcel()` - Excel export\n- `downloadAsPDF()` - PDF generation with jsPDF\n- `exportSVGToPNG()` - Image export\n- `downloadBlob()` - Generic blob download\n- Various study material exporters\n\n## Implementation Plan\n\n### Step 1: Create Backend Export Router\nFile: `backend/app/routers/export.py`\n\n```python\nfrom fastapi import APIRouter, HTTPException, Depends\nfrom fastapi.responses import StreamingResponse\nfrom typing import Optional\nfrom uuid import UUID\nimport json\nimport zipfile\nimport io\n\nfrom app.services.auth import get_current_user\nfrom app.services.supabase_client import get_supabase_client\n\nrouter = APIRouter(prefix=\"/notebooks/{notebook_id}/export\", tags=[\"export\"])\n\n@router.get(\"/json\")\nasync def export_notebook_json(\n    notebook_id: UUID,\n    include_sources: bool = True,\n    include_chats: bool = True,\n    include_notes: bool = True,\n    include_generated: bool = True,\n    user: dict = Depends(get_current_user),\n):\n    \"\"\"Export notebook data as JSON.\"\"\"\n    # Verify access, gather all data, return JSON\n    pass\n\n@router.get(\"/zip\")\nasync def export_notebook_zip(\n    notebook_id: UUID,\n    include_sources: bool = True,\n    include_chats: bool = True,\n    include_notes: bool = True,\n    include_generated: bool = True,\n    user: dict = Depends(get_current_user),\n):\n    \"\"\"Export notebook as ZIP with all files.\"\"\"\n    # Create ZIP in memory with:\n    # - notebook.json (metadata)\n    # - sources/ folder with actual files from storage\n    # - chats.json\n    # - notes.json\n    # - generated/ folder\n    pass\n```\n\n### Step 2: Register Router in main.py\n```python\nfrom app.routers import export\napp.include_router(export.router)\n```\n\n### Step 3: Add Frontend API Route\nFile: `frontend/src/app/api/notebooks/[id]/export/route.ts`\n\nProxy to backend export endpoints.\n\n### Step 4: Expand export-utils.ts\nAdd new functions:\n```typescript\nexport async function exportNotebookAsZip(\n  notebookId: string,\n  options: ExportOptions\n): Promise<void> {\n  // Call backend /export/zip endpoint\n  // Trigger download\n}\n\nexport async function exportNotebookAsPDF(\n  notebookId: string,\n  options: ExportOptions\n): Promise<void> {\n  // Fetch all data via /export/json\n  // Generate comprehensive PDF client-side\n}\n\ninterface ExportOptions {\n  includeSources?: boolean\n  includeChats?: boolean\n  includeNotes?: boolean\n  includeGenerated?: boolean\n  format: 'zip' | 'pdf'\n}\n```\n\n### Step 5: Add Export UI\nLocation: `frontend/src/components/studio/studio-panel.tsx` OR notebook header\n\nAdd:\n- Export button with dropdown (ZIP / PDF)\n- Options dialog for include/exclude toggles\n- Progress indicator for large exports\n\n## ZIP Structure\n```\nnotebook-export-{name}-{date}/\n├── notebook.json           # Metadata: name, description, settings\n├── sources/\n│   ├── index.json         # Source metadata\n│   ├── document1.pdf      # Actual files from storage\n│   └── document2.txt\n├── chats/\n│   ├── index.json         # All sessions and messages\n│   └── session-{id}.json  # Individual session files\n├── notes/\n│   └── index.json         # All notes\n├── generated/\n│   ├── audio/\n│   │   └── podcast.mp3\n│   ├── study-materials/\n│   │   ├── flashcards.json\n│   │   └── quiz.json\n│   └── studio/\n│       ├── report.json\n│       └── slides.json\n└── README.md              # Export info and instructions\n```\n\n## Files to Create/Modify\n\n| File | Action |\n|------|--------|\n| `backend/app/routers/export.py` | CREATE - Export endpoints |\n| `backend/app/main.py` | MODIFY - Register router |\n| `frontend/src/app/api/notebooks/[id]/export/route.ts` | CREATE - API route |\n| `frontend/src/lib/export-utils.ts` | MODIFY - Add notebook export functions |\n| `frontend/src/components/studio/studio-panel.tsx` | MODIFY - Add export button |\n\n## Files NOT to Touch\n- `chat-panel.tsx`\n- `sources-panel.tsx`\n- Database schema (read-only)\n- Any other routers\n\n## Testing Checklist\n- [ ] ZIP export downloads correctly\n- [ ] ZIP contains all expected folders/files\n- [ ] Source files are included from storage\n- [ ] Chat history exports with citations\n- [ ] Notes export correctly\n- [ ] Generated content (audio, study materials) included\n- [ ] Large notebooks don't timeout\n- [ ] Empty notebooks export gracefully\n- [ ] PDF export generates readable document\n\n## Definition of Done\n1. User can export notebook as ZIP with one click\n2. ZIP contains organized folder structure\n3. All notebook data is included based on options\n4. Export works for notebooks of any size\n5. Clear error handling for edge cases\n","numLines":210,"startLine":1,"totalLines":210}},"sourceToolAssistantUUID":"4616ba8a-37db-47c6-9e32-49fd9328e6dc"}
{"parentUuid":"1d6174ca-2ecf-4479-9f79-2b5e318b2d8d","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","message":{"model":"claude-opus-4-5-20251101","id":"msg_017B6hWRXvAs5C9Hb45BsfCU","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"This is a skill document that outlines how to implement a full notebook export feature. Let me create a todo list and start implementing this feature. This will involve:\n\n1. Creating the backend export router\n2. Registering the router in main.py\n3. Creating the frontend API route\n4. Expanding export-utils.ts\n5. Adding the export UI to studio-panel.tsx\n\nLet me start by reading the existing files to understand the current codebase structure, then implement each step.","signature":"EvgECkYICxgCKkAIRjLNItdkY7ZXP6fLJJTYz8Qpk3QHjwVK2FJzzRpK982EDDRmQ/Ze6APIPnc/BvjTxBX7bZjnmQISvN0DJM+yEgyGuMdPFFopqCekTEAaDBQmwCZ6Uv4R6bZ2CyIwhGbpLGZb0uWJW0T3X15z80Q76GqHvkpYDmz8k9eogNcdTrghxNYhMhEcww7dsb3rKt8DW6sjbY4S8VXjyOzdd0xpiBuHnEhCwWq9I78PTAGfUIQJdtWr/us6noLCtgdaf9qV2HLlwfUeZGT8YPDy1YoOVl9Qhrx2He5W/XSxkQitlothhLL8Pt69dH/wfqtX0TTkgs6/JSpMcruLMxiXYKj/7DHRw5xTwf8n2tDjdH0R3I5eTEiSMGMXyryWcFBlBPDMAPUyAlfiUgZiFRDo8923kd4NLfpvdW8lQRyACNhD1/4V/5JO5kE1Cy92AUVdvIAg704inNRG/YMx2iV7pjzeYYEK/CriplEpNLP5TvpJEBuOK3pQv9JwBe0JDhCIcza68ENNsW0tH3ceHvg/HrDL6Q6SSZ7Zt2X8Gq77CDzjrsC3NkjpR/6VLs2SBHp5k7VeA9o80SofvuQnKGoU0uRtfIzETvvieebX6pipEiAhsNc5sX3ik9K7DQaftqMAo9aOTsh4OqlXTDdBzLaFDpomXiPs5WybeZz+m7vd10jiWQyJcqG68ltwAHW67rYbDAjq1pLswL/zy4GJ5L9i42+EFpXuKeehoQZMrLQiUP+M0FYE5Z6o/SFvCT7ATpLFlGe5U/tAFkxt0RcSg+7iwR0UgZxG5GIFm8bZrkNVUr9C4MvE/KqoNp0m+9ybBV8N1DQYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":2666,"cache_read_input_tokens":36223,"cache_creation":{"ephemeral_5m_input_tokens":2666,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWz6ATTAQ3TCC7r9X1Giw","type":"assistant","uuid":"7e44a74d-a47a-454f-9c2a-baca89b19693","timestamp":"2026-01-10T17:26:55.692Z"}
{"parentUuid":"7e44a74d-a47a-454f-9c2a-baca89b19693","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","message":{"model":"claude-opus-4-5-20251101","id":"msg_017B6hWRXvAs5C9Hb45BsfCU","type":"message","role":"assistant","content":[{"type":"text","text":"I'll implement the full notebook export feature. Let me start by creating a todo list and reading the existing files to understand the current structure."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":2666,"cache_read_input_tokens":36223,"cache_creation":{"ephemeral_5m_input_tokens":2666,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWz6ATTAQ3TCC7r9X1Giw","type":"assistant","uuid":"b6dbd039-f486-4465-a113-23c86007a276","timestamp":"2026-01-10T17:26:56.290Z"}
{"parentUuid":"b6dbd039-f486-4465-a113-23c86007a276","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","message":{"model":"claude-opus-4-5-20251101","id":"msg_017B6hWRXvAs5C9Hb45BsfCU","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01LTiyDpFdtJVFsA7jWfHP25","name":"TodoWrite","input":{"todos":[{"content":"Create backend export router (export.py)","status":"pending","activeForm":"Creating backend export router"},{"content":"Register export router in main.py","status":"pending","activeForm":"Registering export router in main.py"},{"content":"Create frontend API route for export","status":"pending","activeForm":"Creating frontend API route for export"},{"content":"Expand export-utils.ts with notebook export functions","status":"pending","activeForm":"Expanding export-utils.ts"},{"content":"Add export UI to studio-panel.tsx","status":"pending","activeForm":"Adding export UI to studio-panel.tsx"},{"content":"Test the export functionality","status":"pending","activeForm":"Testing export functionality"}]}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":2666,"cache_read_input_tokens":36223,"cache_creation":{"ephemeral_5m_input_tokens":2666,"ephemeral_1h_input_tokens":0},"output_tokens":395,"service_tier":"standard"}},"requestId":"req_011CWz6ATTAQ3TCC7r9X1Giw","type":"assistant","uuid":"6437b45e-d039-43e5-9c55-8b2b42cbae2a","timestamp":"2026-01-10T17:26:58.494Z"}
{"parentUuid":"6437b45e-d039-43e5-9c55-8b2b42cbae2a","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01LTiyDpFdtJVFsA7jWfHP25","type":"tool_result","content":"Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable"}]},"uuid":"133e62e6-f0f2-48bb-93a7-047b4d62594a","timestamp":"2026-01-10T17:26:58.517Z","toolUseResult":{"oldTodos":[],"newTodos":[{"content":"Create backend export router (export.py)","status":"pending","activeForm":"Creating backend export router"},{"content":"Register export router in main.py","status":"pending","activeForm":"Registering export router in main.py"},{"content":"Create frontend API route for export","status":"pending","activeForm":"Creating frontend API route for export"},{"content":"Expand export-utils.ts with notebook export functions","status":"pending","activeForm":"Expanding export-utils.ts"},{"content":"Add export UI to studio-panel.tsx","status":"pending","activeForm":"Adding export UI to studio-panel.tsx"},{"content":"Test the export functionality","status":"pending","activeForm":"Testing export functionality"}]},"sourceToolAssistantUUID":"6437b45e-d039-43e5-9c55-8b2b42cbae2a"}
{"parentUuid":"133e62e6-f0f2-48bb-93a7-047b4d62594a","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","message":{"model":"claude-opus-4-5-20251101","id":"msg_01GxvY8q8oEhkNpyWneNT7Cy","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Good, now let me read the existing files to understand the current structure:\n1. backend/app/main.py - to see how routers are registered\n2. backend/app/services/supabase_client.py - to see the supabase client\n3. frontend/src/lib/export-utils.ts - to see existing export utilities\n4. frontend/src/components/studio/studio-panel.tsx - to see where to add export button","signature":"EpUECkYICxgCKkCWwiyGq/ylevUkjvX+tFUkeES8ItHmk84ZGoClUPV9VYnVs30VQVrHFuefXgtf783xdUOjTYPLQ2tv5YWt4T+kEgwctrDcRtHcmfi8GmkaDEKfd/atYFMau4oUwCIwtVmMZpFiU8huE+WKIssG9fGuX3I8Cw4EN6rSbM7jCRqDT6ZdLGyE6Q6VcsSWkiK7KvwCsAL4K+huv5PNV/kWuQEnNwxIb05DXr+AJspXpZq2otrLG6DJJvaSTAGwmP9BKZG5uu5kjfgPXDmIXHSCK1Brf2ppE6EVSj6vX1whRO2KLiI3t18VXvK6FhzlkyPK6aXVmMF/T4UNUn4nFa/t/BmqYGcouQ27LebZuTlheZEJCPuzD2Dv7rquPciR/ctgHs6eKVyHOtH34tuSZPRL0CjX6ecQnLpVh54FwGnrCdFS8cSnEaCK+E/X4OYwyhYyS+P8mde7yTbHF8G91xwrCsXNSoZk3wJk0A2+mNPMXPlhc2IVGSnNqqQ4aXTDse3BTC7C0miuwuavXj+2wA8prY4j38Ma34UjvoZfmpQ9P5U8zPzcVVshrIkHEcn2KzpN5aiK4K/NArL4w4ob/E9GbYc2wpek6EaMzng//tMcFevPV2FrPo7gbzIeoA9lNFDNdP32IYUdZkINUp1BBsxTC6/rTi5uncUvQZ7ahLH58Hu6NIgfw4m/6yD9szWUOMEYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":434,"cache_read_input_tokens":38889,"cache_creation":{"ephemeral_5m_input_tokens":434,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CWz6B3jBJL9p3NvFrGFtR","type":"assistant","uuid":"94cce0dd-a05f-4b15-b872-3ccd18f83208","timestamp":"2026-01-10T17:27:03.064Z"}
{"parentUuid":"94cce0dd-a05f-4b15-b872-3ccd18f83208","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","message":{"model":"claude-opus-4-5-20251101","id":"msg_01GxvY8q8oEhkNpyWneNT7Cy","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01N5pgzH1zVp19meGtCfEfQJ","name":"Read","input":{"file_path":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/backend/app/main.py"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":434,"cache_read_input_tokens":38889,"cache_creation":{"ephemeral_5m_input_tokens":434,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CWz6B3jBJL9p3NvFrGFtR","type":"assistant","uuid":"4096e590-dfba-4f78-9ac2-3c5354687c19","timestamp":"2026-01-10T17:27:03.526Z"}
{"parentUuid":"4096e590-dfba-4f78-9ac2-3c5354687c19","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","message":{"model":"claude-opus-4-5-20251101","id":"msg_01GxvY8q8oEhkNpyWneNT7Cy","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01U54eDzAgKYTNrkBGDH2Jte","name":"Read","input":{"file_path":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/backend/app/services/supabase_client.py"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":434,"cache_read_input_tokens":38889,"cache_creation":{"ephemeral_5m_input_tokens":434,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CWz6B3jBJL9p3NvFrGFtR","type":"assistant","uuid":"fd717944-1da1-4389-a506-04dbf4856e8d","timestamp":"2026-01-10T17:27:04.009Z"}
{"parentUuid":"fd717944-1da1-4389-a506-04dbf4856e8d","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","message":{"model":"claude-opus-4-5-20251101","id":"msg_01GxvY8q8oEhkNpyWneNT7Cy","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01KS76XMUsbTKNXQyRDdq8Y2","name":"Read","input":{"file_path":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend/src/lib/export-utils.ts"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":434,"cache_read_input_tokens":38889,"cache_creation":{"ephemeral_5m_input_tokens":434,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CWz6B3jBJL9p3NvFrGFtR","type":"assistant","uuid":"6c02d764-7efb-4708-b926-2fbc9bd9e44c","timestamp":"2026-01-10T17:27:04.463Z"}
{"parentUuid":"6c02d764-7efb-4708-b926-2fbc9bd9e44c","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","message":{"model":"claude-opus-4-5-20251101","id":"msg_01GxvY8q8oEhkNpyWneNT7Cy","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01GhWaTHNPZpvZSqCNNGE5ir","name":"Read","input":{"file_path":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend/src/components/studio/studio-panel.tsx"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":434,"cache_read_input_tokens":38889,"cache_creation":{"ephemeral_5m_input_tokens":434,"ephemeral_1h_input_tokens":0},"output_tokens":406,"service_tier":"standard"}},"requestId":"req_011CWz6B3jBJL9p3NvFrGFtR","type":"assistant","uuid":"b3e99e6a-9ef9-497b-aa52-a4c32d61926e","timestamp":"2026-01-10T17:27:04.926Z"}
{"parentUuid":"4096e590-dfba-4f78-9ac2-3c5354687c19","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01N5pgzH1zVp19meGtCfEfQJ","type":"tool_result","content":"     1→from fastapi import FastAPI, HTTPException, Request\n     2→from fastapi.middleware.cors import CORSMiddleware\n     3→from fastapi.responses import JSONResponse\n     4→import uuid\n     5→\n     6→from app.config import get_settings\n     7→from app.routers import notebooks, sources, chat, audio, video, research, study, notes, api_keys, global_chat, studio\n     8→\n     9→settings = get_settings()\n    10→\n    11→app = FastAPI(\n    12→    title=settings.app_name,\n    13→    description=\"NotebookLM Reimagined - An API-first research intelligence platform\",\n    14→    version=\"1.0.0\",\n    15→    docs_url=\"/docs\",\n    16→    redoc_url=\"/redoc\",\n    17→)\n    18→\n    19→# CORS middleware\n    20→app.add_middleware(\n    21→    CORSMiddleware,\n    22→    allow_origins=[\"*\"],  # Configure appropriately for production\n    23→    allow_credentials=True,\n    24→    allow_methods=[\"*\"],\n    25→    allow_headers=[\"*\"],\n    26→)\n    27→\n    28→\n    29→# Request ID middleware\n    30→@app.middleware(\"http\")\n    31→async def add_request_id(request: Request, call_next):\n    32→    request_id = str(uuid.uuid4())[:8]\n    33→    request.state.request_id = request_id\n    34→    response = await call_next(request)\n    35→    response.headers[\"X-Request-ID\"] = request_id\n    36→    return response\n    37→\n    38→\n    39→# Exception handlers\n    40→@app.exception_handler(HTTPException)\n    41→async def http_exception_handler(request: Request, exc: HTTPException):\n    42→    return JSONResponse(\n    43→        status_code=exc.status_code,\n    44→        content={\n    45→            \"error\": {\n    46→                \"code\": exc.status_code,\n    47→                \"message\": exc.detail,\n    48→            }\n    49→        },\n    50→    )\n    51→\n    52→\n    53→@app.exception_handler(Exception)\n    54→async def general_exception_handler(request: Request, exc: Exception):\n    55→    return JSONResponse(\n    56→        status_code=500,\n    57→        content={\n    58→            \"error\": {\n    59→                \"code\": 500,\n    60→                \"message\": \"Internal server error\",\n    61→                \"details\": str(exc) if settings.debug else None,\n    62→            }\n    63→        },\n    64→    )\n    65→\n    66→\n    67→# Include routers\n    68→app.include_router(api_keys.router, prefix=\"/api/v1\")\n    69→app.include_router(notebooks.router, prefix=\"/api/v1\")\n    70→app.include_router(sources.router, prefix=\"/api/v1\")\n    71→app.include_router(chat.router, prefix=\"/api/v1\")\n    72→app.include_router(audio.router, prefix=\"/api/v1\")\n    73→app.include_router(video.router, prefix=\"/api/v1\")\n    74→app.include_router(research.router, prefix=\"/api/v1\")\n    75→app.include_router(study.router, prefix=\"/api/v1\")\n    76→app.include_router(notes.router, prefix=\"/api/v1\")\n    77→app.include_router(studio.router, prefix=\"/api/v1\")\n    78→app.include_router(global_chat.router, prefix=\"/api/v1\")\n    79→\n    80→\n    81→@app.get(\"/\")\n    82→async def root():\n    83→    return {\n    84→        \"name\": settings.app_name,\n    85→        \"version\": \"1.0.0\",\n    86→        \"docs\": \"/docs\",\n    87→    }\n    88→\n    89→\n    90→@app.get(\"/health\")\n    91→async def health():\n    92→    return {\"status\": \"healthy\"}\n    93→\n    94→\n    95→if __name__ == \"__main__\":\n    96→    import uvicorn\n    97→    uvicorn.run(app, host=\"0.0.0.0\", port=8000)\n    98→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"54a4142d-00e4-4b48-8c58-09f18f8ee09c","timestamp":"2026-01-10T17:27:04.984Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/backend/app/main.py","content":"from fastapi import FastAPI, HTTPException, Request\nfrom fastapi.middleware.cors import CORSMiddleware\nfrom fastapi.responses import JSONResponse\nimport uuid\n\nfrom app.config import get_settings\nfrom app.routers import notebooks, sources, chat, audio, video, research, study, notes, api_keys, global_chat, studio\n\nsettings = get_settings()\n\napp = FastAPI(\n    title=settings.app_name,\n    description=\"NotebookLM Reimagined - An API-first research intelligence platform\",\n    version=\"1.0.0\",\n    docs_url=\"/docs\",\n    redoc_url=\"/redoc\",\n)\n\n# CORS middleware\napp.add_middleware(\n    CORSMiddleware,\n    allow_origins=[\"*\"],  # Configure appropriately for production\n    allow_credentials=True,\n    allow_methods=[\"*\"],\n    allow_headers=[\"*\"],\n)\n\n\n# Request ID middleware\n@app.middleware(\"http\")\nasync def add_request_id(request: Request, call_next):\n    request_id = str(uuid.uuid4())[:8]\n    request.state.request_id = request_id\n    response = await call_next(request)\n    response.headers[\"X-Request-ID\"] = request_id\n    return response\n\n\n# Exception handlers\n@app.exception_handler(HTTPException)\nasync def http_exception_handler(request: Request, exc: HTTPException):\n    return JSONResponse(\n        status_code=exc.status_code,\n        content={\n            \"error\": {\n                \"code\": exc.status_code,\n                \"message\": exc.detail,\n            }\n        },\n    )\n\n\n@app.exception_handler(Exception)\nasync def general_exception_handler(request: Request, exc: Exception):\n    return JSONResponse(\n        status_code=500,\n        content={\n            \"error\": {\n                \"code\": 500,\n                \"message\": \"Internal server error\",\n                \"details\": str(exc) if settings.debug else None,\n            }\n        },\n    )\n\n\n# Include routers\napp.include_router(api_keys.router, prefix=\"/api/v1\")\napp.include_router(notebooks.router, prefix=\"/api/v1\")\napp.include_router(sources.router, prefix=\"/api/v1\")\napp.include_router(chat.router, prefix=\"/api/v1\")\napp.include_router(audio.router, prefix=\"/api/v1\")\napp.include_router(video.router, prefix=\"/api/v1\")\napp.include_router(research.router, prefix=\"/api/v1\")\napp.include_router(study.router, prefix=\"/api/v1\")\napp.include_router(notes.router, prefix=\"/api/v1\")\napp.include_router(studio.router, prefix=\"/api/v1\")\napp.include_router(global_chat.router, prefix=\"/api/v1\")\n\n\n@app.get(\"/\")\nasync def root():\n    return {\n        \"name\": settings.app_name,\n        \"version\": \"1.0.0\",\n        \"docs\": \"/docs\",\n    }\n\n\n@app.get(\"/health\")\nasync def health():\n    return {\"status\": \"healthy\"}\n\n\nif __name__ == \"__main__\":\n    import uvicorn\n    uvicorn.run(app, host=\"0.0.0.0\", port=8000)\n","numLines":98,"startLine":1,"totalLines":98}},"sourceToolAssistantUUID":"4096e590-dfba-4f78-9ac2-3c5354687c19"}
{"parentUuid":"fd717944-1da1-4389-a506-04dbf4856e8d","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01U54eDzAgKYTNrkBGDH2Jte","type":"tool_result","content":"     1→from supabase import create_client, Client\n     2→from app.config import get_settings\n     3→\n     4→settings = get_settings()\n     5→\n     6→\n     7→def get_supabase_client() -> Client:\n     8→    \"\"\"Get Supabase client with service role key for backend operations.\"\"\"\n     9→    return create_client(settings.supabase_url, settings.supabase_service_role_key)\n    10→\n    11→\n    12→def get_supabase_anon_client() -> Client:\n    13→    \"\"\"Get Supabase client with anon key for user-facing operations.\"\"\"\n    14→    return create_client(settings.supabase_url, settings.supabase_anon_key)\n    15→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"812b24d4-522b-43fa-b6ad-fac9a2912fcb","timestamp":"2026-01-10T17:27:04.984Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/backend/app/services/supabase_client.py","content":"from supabase import create_client, Client\nfrom app.config import get_settings\n\nsettings = get_settings()\n\n\ndef get_supabase_client() -> Client:\n    \"\"\"Get Supabase client with service role key for backend operations.\"\"\"\n    return create_client(settings.supabase_url, settings.supabase_service_role_key)\n\n\ndef get_supabase_anon_client() -> Client:\n    \"\"\"Get Supabase client with anon key for user-facing operations.\"\"\"\n    return create_client(settings.supabase_url, settings.supabase_anon_key)\n","numLines":15,"startLine":1,"totalLines":15}},"sourceToolAssistantUUID":"fd717944-1da1-4389-a506-04dbf4856e8d"}
{"parentUuid":"6c02d764-7efb-4708-b926-2fbc9bd9e44c","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01KS76XMUsbTKNXQyRDdq8Y2","type":"tool_result","content":"     1→/**\n     2→ * Export utilities for downloading study materials\n     3→ * Supports XLSX (Excel), PDF, and PNG exports\n     4→ */\n     5→\n     6→// ============================================================================\n     7→// Types\n     8→// ============================================================================\n     9→\n    10→export interface Flashcard {\n    11→  id?: string\n    12→  front: string\n    13→  back: string\n    14→  question?: string\n    15→  answer?: string\n    16→}\n    17→\n    18→export interface QuizQuestion {\n    19→  id?: string\n    20→  question: string\n    21→  options: string[]\n    22→  correct_index: number\n    23→  explanation: string\n    24→}\n    25→\n    26→export interface FAQItem {\n    27→  question: string\n    28→  answer: string\n    29→}\n    30→\n    31→export interface StudyGuideSection {\n    32→  heading: string\n    33→  content: string\n    34→}\n    35→\n    36→export interface StudyGuide {\n    37→  title: string\n    38→  sections: StudyGuideSection[]\n    39→}\n    40→\n    41→export interface MindMapNode {\n    42→  id: string\n    43→  label: string\n    44→  description?: string\n    45→  children?: MindMapNode[]\n    46→}\n    47→\n    48→// ============================================================================\n    49→// Excel (XLSX) Export\n    50→// ============================================================================\n    51→\n    52→/**\n    53→ * Download data as an Excel file\n    54→ */\n    55→export async function downloadAsExcel(\n    56→  data: Record<string, unknown>[],\n    57→  filename: string,\n    58→  sheetName = 'Sheet1'\n    59→): Promise<void> {\n    60→  // Dynamically import xlsx to avoid SSR issues\n    61→  const XLSX = await import('xlsx')\n    62→\n    63→  // Create workbook and worksheet\n    64→  const workbook = XLSX.utils.book_new()\n    65→  const worksheet = XLSX.utils.json_to_sheet(data)\n    66→\n    67→  // Auto-size columns\n    68→  const maxWidths: number[] = []\n    69→  data.forEach(row => {\n    70→    Object.values(row).forEach((val, idx) => {\n    71→      const len = String(val || '').length\n    72→      maxWidths[idx] = Math.max(maxWidths[idx] || 10, Math.min(len, 50))\n    73→    })\n    74→  })\n    75→\n    76→  // Set column widths\n    77→  worksheet['!cols'] = maxWidths.map(w => ({ wch: w + 2 }))\n    78→\n    79→  // Add worksheet to workbook\n    80→  XLSX.utils.book_append_sheet(workbook, worksheet, sheetName)\n    81→\n    82→  // Generate and download\n    83→  XLSX.writeFile(workbook, `${filename}.xlsx`)\n    84→}\n    85→\n    86→/**\n    87→ * Export flashcards to Excel\n    88→ */\n    89→export async function exportFlashcardsToExcel(\n    90→  flashcards: Flashcard[],\n    91→  filename = 'flashcards'\n    92→): Promise<void> {\n    93→  const data = flashcards.map((card, idx) => ({\n    94→    '#': idx + 1,\n    95→    'Question': card.front || card.question || '',\n    96→    'Answer': card.back || card.answer || ''\n    97→  }))\n    98→\n    99→  await downloadAsExcel(data, filename, 'Flashcards')\n   100→}\n   101→\n   102→/**\n   103→ * Export quiz to Excel\n   104→ */\n   105→export async function exportQuizToExcel(\n   106→  questions: QuizQuestion[],\n   107→  filename = 'quiz'\n   108→): Promise<void> {\n   109→  const data = questions.map((q, idx) => ({\n   110→    '#': idx + 1,\n   111→    'Question': q.question,\n   112→    'Option A': q.options[0] || '',\n   113→    'Option B': q.options[1] || '',\n   114→    'Option C': q.options[2] || '',\n   115→    'Option D': q.options[3] || '',\n   116→    'Correct Answer': String.fromCharCode(65 + q.correct_index), // A, B, C, D\n   117→    'Explanation': q.explanation\n   118→  }))\n   119→\n   120→  await downloadAsExcel(data, filename, 'Quiz Questions')\n   121→}\n   122→\n   123→/**\n   124→ * Export FAQ to Excel\n   125→ */\n   126→export async function exportFAQToExcel(\n   127→  items: FAQItem[],\n   128→  filename = 'faq'\n   129→): Promise<void> {\n   130→  const data = items.map((item, idx) => ({\n   131→    '#': idx + 1,\n   132→    'Question': item.question,\n   133→    'Answer': item.answer\n   134→  }))\n   135→\n   136→  await downloadAsExcel(data, filename, 'FAQ')\n   137→}\n   138→\n   139→// ============================================================================\n   140→// PDF Export\n   141→// ============================================================================\n   142→\n   143→/**\n   144→ * Generate and download a PDF document\n   145→ */\n   146→export async function downloadAsPDF(\n   147→  content: PDFContent,\n   148→  filename: string\n   149→): Promise<void> {\n   150→  const { jsPDF } = await import('jspdf')\n   151→\n   152→  const doc = new jsPDF({\n   153→    orientation: 'portrait',\n   154→    unit: 'mm',\n   155→    format: 'a4'\n   156→  })\n   157→\n   158→  const pageWidth = doc.internal.pageSize.getWidth()\n   159→  const pageHeight = doc.internal.pageSize.getHeight()\n   160→  const margin = 20\n   161→  const contentWidth = pageWidth - (margin * 2)\n   162→  let y = margin\n   163→\n   164→  // Helper to check for page break\n   165→  const checkPageBreak = (height: number) => {\n   166→    if (y + height > pageHeight - margin) {\n   167→      doc.addPage()\n   168→      y = margin\n   169→      return true\n   170→    }\n   171→    return false\n   172→  }\n   173→\n   174→  // Title\n   175→  if (content.title) {\n   176→    doc.setFontSize(24)\n   177→    doc.setFont('helvetica', 'bold')\n   178→    doc.setTextColor(51, 51, 51)\n   179→    const titleLines = doc.splitTextToSize(content.title, contentWidth)\n   180→    doc.text(titleLines, margin, y)\n   181→    y += titleLines.length * 10 + 10\n   182→  }\n   183→\n   184→  // Subtitle\n   185→  if (content.subtitle) {\n   186→    doc.setFontSize(12)\n   187→    doc.setFont('helvetica', 'normal')\n   188→    doc.setTextColor(102, 102, 102)\n   189→    doc.text(content.subtitle, margin, y)\n   190→    y += 15\n   191→  }\n   192→\n   193→  // Divider line\n   194→  doc.setDrawColor(200, 200, 200)\n   195→  doc.line(margin, y, pageWidth - margin, y)\n   196→  y += 15\n   197→\n   198→  // Sections\n   199→  if (content.sections) {\n   200→    for (const section of content.sections) {\n   201→      checkPageBreak(30)\n   202→\n   203→      // Section heading\n   204→      doc.setFontSize(16)\n   205→      doc.setFont('helvetica', 'bold')\n   206→      doc.setTextColor(51, 51, 51)\n   207→      const headingLines = doc.splitTextToSize(section.heading, contentWidth)\n   208→      doc.text(headingLines, margin, y)\n   209→      y += headingLines.length * 7 + 5\n   210→\n   211→      // Section content\n   212→      doc.setFontSize(11)\n   213→      doc.setFont('helvetica', 'normal')\n   214→      doc.setTextColor(68, 68, 68)\n   215→\n   216→      const contentLines = doc.splitTextToSize(section.content, contentWidth)\n   217→      for (const line of contentLines) {\n   218→        checkPageBreak(6)\n   219→        doc.text(line, margin, y)\n   220→        y += 6\n   221→      }\n   222→\n   223→      y += 10 // Space after section\n   224→    }\n   225→  }\n   226→\n   227→  // Footer with page numbers\n   228→  const pageCount = doc.getNumberOfPages()\n   229→  for (let i = 1; i <= pageCount; i++) {\n   230→    doc.setPage(i)\n   231→    doc.setFontSize(9)\n   232→    doc.setFont('helvetica', 'normal')\n   233→    doc.setTextColor(150, 150, 150)\n   234→    doc.text(\n   235→      `Page ${i} of ${pageCount}`,\n   236→      pageWidth / 2,\n   237→      pageHeight - 10,\n   238→      { align: 'center' }\n   239→    )\n   240→    doc.text(\n   241→      'Generated by NotebookLM Reimagined',\n   242→      margin,\n   243→      pageHeight - 10\n   244→    )\n   245→  }\n   246→\n   247→  doc.save(`${filename}.pdf`)\n   248→}\n   249→\n   250→interface PDFContent {\n   251→  title?: string\n   252→  subtitle?: string\n   253→  sections?: { heading: string; content: string }[]\n   254→}\n   255→\n   256→/**\n   257→ * Export study guide to PDF\n   258→ */\n   259→export async function exportStudyGuideToPDF(\n   260→  guide: StudyGuide,\n   261→  filename = 'study-guide'\n   262→): Promise<void> {\n   263→  await downloadAsPDF(\n   264→    {\n   265→      title: guide.title,\n   266→      subtitle: `${guide.sections.length} sections • Generated study guide`,\n   267→      sections: guide.sections.map(section => ({\n   268→        heading: section.heading,\n   269→        content: section.content.replace(/\\*\\*/g, '').replace(/\\*/g, '') // Strip markdown\n   270→      }))\n   271→    },\n   272→    filename\n   273→  )\n   274→}\n   275→\n   276→/**\n   277→ * Export flashcards to PDF\n   278→ */\n   279→export async function exportFlashcardsToPDF(\n   280→  flashcards: Flashcard[],\n   281→  title = 'Flashcards',\n   282→  filename = 'flashcards'\n   283→): Promise<void> {\n   284→  const { jsPDF } = await import('jspdf')\n   285→\n   286→  const doc = new jsPDF({\n   287→    orientation: 'portrait',\n   288→    unit: 'mm',\n   289→    format: 'a4'\n   290→  })\n   291→\n   292→  const pageWidth = doc.internal.pageSize.getWidth()\n   293→  const pageHeight = doc.internal.pageSize.getHeight()\n   294→  const margin = 20\n   295→  const contentWidth = pageWidth - (margin * 2)\n   296→  let y = margin\n   297→\n   298→  // Title\n   299→  doc.setFontSize(24)\n   300→  doc.setFont('helvetica', 'bold')\n   301→  doc.setTextColor(51, 51, 51)\n   302→  doc.text(title, margin, y)\n   303→  y += 15\n   304→\n   305→  // Subtitle\n   306→  doc.setFontSize(12)\n   307→  doc.setFont('helvetica', 'normal')\n   308→  doc.setTextColor(102, 102, 102)\n   309→  doc.text(`${flashcards.length} cards`, margin, y)\n   310→  y += 15\n   311→\n   312→  // Cards\n   313→  flashcards.forEach((card, idx) => {\n   314→    // Check if we need a new page\n   315→    if (y + 50 > pageHeight - margin) {\n   316→      doc.addPage()\n   317→      y = margin\n   318→    }\n   319→\n   320→    // Card container\n   321→    doc.setFillColor(245, 245, 245)\n   322→    doc.roundedRect(margin, y, contentWidth, 45, 3, 3, 'F')\n   323→\n   324→    // Card number\n   325→    doc.setFontSize(10)\n   326→    doc.setFont('helvetica', 'bold')\n   327→    doc.setTextColor(102, 102, 102)\n   328→    doc.text(`Card ${idx + 1}`, margin + 5, y + 8)\n   329→\n   330→    // Question\n   331→    doc.setFontSize(11)\n   332→    doc.setFont('helvetica', 'bold')\n   333→    doc.setTextColor(51, 51, 51)\n   334→    const question = card.front || card.question || ''\n   335→    const qLines = doc.splitTextToSize(`Q: ${question}`, contentWidth - 10)\n   336→    doc.text(qLines.slice(0, 2), margin + 5, y + 18)\n   337→\n   338→    // Answer\n   339→    doc.setFont('helvetica', 'normal')\n   340→    doc.setTextColor(68, 68, 68)\n   341→    const answer = card.back || card.answer || ''\n   342→    const aLines = doc.splitTextToSize(`A: ${answer}`, contentWidth - 10)\n   343→    doc.text(aLines.slice(0, 2), margin + 5, y + 32)\n   344→\n   345→    y += 52\n   346→  })\n   347→\n   348→  doc.save(`${filename}.pdf`)\n   349→}\n   350→\n   351→/**\n   352→ * Export quiz to PDF\n   353→ */\n   354→export async function exportQuizToPDF(\n   355→  questions: QuizQuestion[],\n   356→  title = 'Quiz',\n   357→  filename = 'quiz'\n   358→): Promise<void> {\n   359→  const { jsPDF } = await import('jspdf')\n   360→\n   361→  const doc = new jsPDF({\n   362→    orientation: 'portrait',\n   363→    unit: 'mm',\n   364→    format: 'a4'\n   365→  })\n   366→\n   367→  const pageWidth = doc.internal.pageSize.getWidth()\n   368→  const pageHeight = doc.internal.pageSize.getHeight()\n   369→  const margin = 20\n   370→  const contentWidth = pageWidth - (margin * 2)\n   371→  let y = margin\n   372→\n   373→  // Title\n   374→  doc.setFontSize(24)\n   375→  doc.setFont('helvetica', 'bold')\n   376→  doc.setTextColor(51, 51, 51)\n   377→  doc.text(title, margin, y)\n   378→  y += 15\n   379→\n   380→  // Subtitle\n   381→  doc.setFontSize(12)\n   382→  doc.setFont('helvetica', 'normal')\n   383→  doc.setTextColor(102, 102, 102)\n   384→  doc.text(`${questions.length} questions`, margin, y)\n   385→  y += 15\n   386→\n   387→  // Questions\n   388→  questions.forEach((q, idx) => {\n   389→    // Check if we need a new page\n   390→    if (y + 60 > pageHeight - margin) {\n   391→      doc.addPage()\n   392→      y = margin\n   393→    }\n   394→\n   395→    // Question number and text\n   396→    doc.setFontSize(12)\n   397→    doc.setFont('helvetica', 'bold')\n   398→    doc.setTextColor(51, 51, 51)\n   399→    const qLines = doc.splitTextToSize(`${idx + 1}. ${q.question}`, contentWidth)\n   400→    doc.text(qLines, margin, y)\n   401→    y += qLines.length * 6 + 4\n   402→\n   403→    // Options\n   404→    doc.setFontSize(10)\n   405→    doc.setFont('helvetica', 'normal')\n   406→    q.options.forEach((opt, optIdx) => {\n   407→      const isCorrect = optIdx === q.correct_index\n   408→      doc.setTextColor(isCorrect ? 34 : 68, isCorrect ? 139 : 68, isCorrect ? 34 : 68)\n   409→      const optLine = `${String.fromCharCode(65 + optIdx)}) ${opt}${isCorrect ? ' ✓' : ''}`\n   410→      const optLines = doc.splitTextToSize(optLine, contentWidth - 10)\n   411→      doc.text(optLines, margin + 5, y)\n   412→      y += optLines.length * 5 + 2\n   413→    })\n   414→\n   415→    // Explanation\n   416→    if (q.explanation) {\n   417→      doc.setFontSize(9)\n   418→      doc.setFont('helvetica', 'italic')\n   419→      doc.setTextColor(102, 102, 102)\n   420→      const expLines = doc.splitTextToSize(`💡 ${q.explanation}`, contentWidth - 10)\n   421→      doc.text(expLines.slice(0, 2), margin + 5, y + 2)\n   422→      y += Math.min(expLines.length, 2) * 4 + 4\n   423→    }\n   424→\n   425→    y += 10\n   426→  })\n   427→\n   428→  doc.save(`${filename}.pdf`)\n   429→}\n   430→\n   431→/**\n   432→ * Export FAQ to PDF\n   433→ */\n   434→export async function exportFAQToPDF(\n   435→  items: FAQItem[],\n   436→  title = 'Frequently Asked Questions',\n   437→  filename = 'faq'\n   438→): Promise<void> {\n   439→  await downloadAsPDF(\n   440→    {\n   441→      title,\n   442→      subtitle: `${items.length} questions`,\n   443→      sections: items.map((item, idx) => ({\n   444→        heading: `Q${idx + 1}: ${item.question}`,\n   445→        content: item.answer\n   446→      }))\n   447→    },\n   448→    filename\n   449→  )\n   450→}\n   451→\n   452→// ============================================================================\n   453→// Image (PNG) Export\n   454→// ============================================================================\n   455→\n   456→/**\n   457→ * Export SVG element to PNG\n   458→ */\n   459→export async function exportSVGToPNG(\n   460→  svgElement: SVGSVGElement,\n   461→  filename: string,\n   462→  options: { scale?: number; backgroundColor?: string } = {}\n   463→): Promise<void> {\n   464→  const { scale = 2, backgroundColor = '#1a1a2e' } = options\n   465→\n   466→  // Get SVG dimensions\n   467→  const bbox = svgElement.getBBox()\n   468→  const viewBox = svgElement.getAttribute('viewBox')?.split(' ').map(Number) || [0, 0, 800, 600]\n   469→  const width = viewBox[2] || bbox.width || 800\n   470→  const height = viewBox[3] || bbox.height || 600\n   471→\n   472→  // Create canvas\n   473→  const canvas = document.createElement('canvas')\n   474→  canvas.width = width * scale\n   475→  canvas.height = height * scale\n   476→  const ctx = canvas.getContext('2d')\n   477→\n   478→  if (!ctx) {\n   479→    throw new Error('Could not get canvas context')\n   480→  }\n   481→\n   482→  // Fill background\n   483→  ctx.fillStyle = backgroundColor\n   484→  ctx.fillRect(0, 0, canvas.width, canvas.height)\n   485→  ctx.scale(scale, scale)\n   486→\n   487→  // Clone SVG and inline styles to avoid cross-origin issues\n   488→  const clonedSvg = svgElement.cloneNode(true) as SVGSVGElement\n   489→\n   490→  // Ensure SVG has proper dimensions\n   491→  clonedSvg.setAttribute('width', String(width))\n   492→  clonedSvg.setAttribute('height', String(height))\n   493→\n   494→  // Remove any external references that could cause CORS issues\n   495→  const images = clonedSvg.querySelectorAll('image')\n   496→  images.forEach(img => {\n   497→    const href = img.getAttribute('href') || img.getAttribute('xlink:href')\n   498→    // Remove external image references that could taint canvas\n   499→    if (href && !href.startsWith('data:')) {\n   500→      img.remove()\n   501→    }\n   502→  })\n   503→\n   504→  // Convert SVG to base64 data URL (avoids CORS tainting)\n   505→  const svgData = new XMLSerializer().serializeToString(clonedSvg)\n   506→  const svgBase64 = btoa(unescape(encodeURIComponent(svgData)))\n   507→  const svgDataUrl = `data:image/svg+xml;base64,${svgBase64}`\n   508→\n   509→  return new Promise((resolve, reject) => {\n   510→    const img = new Image()\n   511→    img.onload = () => {\n   512→      try {\n   513→        ctx.drawImage(img, 0, 0)\n   514→        // Download\n   515→        const link = document.createElement('a')\n   516→        link.download = `${filename}.png`\n   517→        link.href = canvas.toDataURL('image/png')\n   518→        link.click()\n   519→        resolve()\n   520→      } catch (error) {\n   521→        // Fallback: download as SVG if PNG export fails\n   522→        console.error('PNG export failed, falling back to SVG:', error)\n   523→        const svgBlob = new Blob([svgData], { type: 'image/svg+xml;charset=utf-8' })\n   524→        const link = document.createElement('a')\n   525→        link.download = `${filename}.svg`\n   526→        link.href = URL.createObjectURL(svgBlob)\n   527→        link.click()\n   528→        URL.revokeObjectURL(link.href)\n   529→        resolve()\n   530→      }\n   531→    }\n   532→    img.onerror = () => {\n   533→      // Fallback: download as SVG if image load fails\n   534→      console.error('Image load failed, falling back to SVG')\n   535→      const svgBlob = new Blob([svgData], { type: 'image/svg+xml;charset=utf-8' })\n   536→      const link = document.createElement('a')\n   537→      link.download = `${filename}.svg`\n   538→      link.href = URL.createObjectURL(svgBlob)\n   539→      link.click()\n   540→      URL.revokeObjectURL(link.href)\n   541→      resolve()\n   542→    }\n   543→    img.src = svgDataUrl\n   544→  })\n   545→}\n   546→\n   547→/**\n   548→ * Export Mind Map to PNG\n   549→ * Takes the SVG element from the mind map viewer and converts to PNG\n   550→ */\n   551→export async function exportMindMapToPNG(\n   552→  svgElement: SVGSVGElement,\n   553→  title: string,\n   554→  filename = 'mind-map'\n   555→): Promise<void> {\n   556→  await exportSVGToPNG(svgElement, filename, {\n   557→    scale: 2,\n   558→    backgroundColor: '#1e1e2e'\n   559→  })\n   560→}\n   561→\n   562→// ============================================================================\n   563→// Generic Utilities\n   564→// ============================================================================\n   565→\n   566→/**\n   567→ * Generate a timestamped filename\n   568→ */\n   569→export function generateFilename(base: string): string {\n   570→  const date = new Date()\n   571→  const timestamp = date.toISOString().slice(0, 10).replace(/-/g, '')\n   572→  return `${base}_${timestamp}`\n   573→}\n   574→\n   575→/**\n   576→ * Trigger file download from blob\n   577→ */\n   578→export function downloadBlob(blob: Blob, filename: string): void {\n   579→  const url = URL.createObjectURL(blob)\n   580→  const link = document.createElement('a')\n   581→  link.href = url\n   582→  link.download = filename\n   583→  document.body.appendChild(link)\n   584→  link.click()\n   585→  document.body.removeChild(link)\n   586→  URL.revokeObjectURL(url)\n   587→}\n   588→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"d5fd7103-db81-42fa-97c8-2280b57a85d4","timestamp":"2026-01-10T17:27:04.984Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend/src/lib/export-utils.ts","content":"/**\n * Export utilities for downloading study materials\n * Supports XLSX (Excel), PDF, and PNG exports\n */\n\n// ============================================================================\n// Types\n// ============================================================================\n\nexport interface Flashcard {\n  id?: string\n  front: string\n  back: string\n  question?: string\n  answer?: string\n}\n\nexport interface QuizQuestion {\n  id?: string\n  question: string\n  options: string[]\n  correct_index: number\n  explanation: string\n}\n\nexport interface FAQItem {\n  question: string\n  answer: string\n}\n\nexport interface StudyGuideSection {\n  heading: string\n  content: string\n}\n\nexport interface StudyGuide {\n  title: string\n  sections: StudyGuideSection[]\n}\n\nexport interface MindMapNode {\n  id: string\n  label: string\n  description?: string\n  children?: MindMapNode[]\n}\n\n// ============================================================================\n// Excel (XLSX) Export\n// ============================================================================\n\n/**\n * Download data as an Excel file\n */\nexport async function downloadAsExcel(\n  data: Record<string, unknown>[],\n  filename: string,\n  sheetName = 'Sheet1'\n): Promise<void> {\n  // Dynamically import xlsx to avoid SSR issues\n  const XLSX = await import('xlsx')\n\n  // Create workbook and worksheet\n  const workbook = XLSX.utils.book_new()\n  const worksheet = XLSX.utils.json_to_sheet(data)\n\n  // Auto-size columns\n  const maxWidths: number[] = []\n  data.forEach(row => {\n    Object.values(row).forEach((val, idx) => {\n      const len = String(val || '').length\n      maxWidths[idx] = Math.max(maxWidths[idx] || 10, Math.min(len, 50))\n    })\n  })\n\n  // Set column widths\n  worksheet['!cols'] = maxWidths.map(w => ({ wch: w + 2 }))\n\n  // Add worksheet to workbook\n  XLSX.utils.book_append_sheet(workbook, worksheet, sheetName)\n\n  // Generate and download\n  XLSX.writeFile(workbook, `${filename}.xlsx`)\n}\n\n/**\n * Export flashcards to Excel\n */\nexport async function exportFlashcardsToExcel(\n  flashcards: Flashcard[],\n  filename = 'flashcards'\n): Promise<void> {\n  const data = flashcards.map((card, idx) => ({\n    '#': idx + 1,\n    'Question': card.front || card.question || '',\n    'Answer': card.back || card.answer || ''\n  }))\n\n  await downloadAsExcel(data, filename, 'Flashcards')\n}\n\n/**\n * Export quiz to Excel\n */\nexport async function exportQuizToExcel(\n  questions: QuizQuestion[],\n  filename = 'quiz'\n): Promise<void> {\n  const data = questions.map((q, idx) => ({\n    '#': idx + 1,\n    'Question': q.question,\n    'Option A': q.options[0] || '',\n    'Option B': q.options[1] || '',\n    'Option C': q.options[2] || '',\n    'Option D': q.options[3] || '',\n    'Correct Answer': String.fromCharCode(65 + q.correct_index), // A, B, C, D\n    'Explanation': q.explanation\n  }))\n\n  await downloadAsExcel(data, filename, 'Quiz Questions')\n}\n\n/**\n * Export FAQ to Excel\n */\nexport async function exportFAQToExcel(\n  items: FAQItem[],\n  filename = 'faq'\n): Promise<void> {\n  const data = items.map((item, idx) => ({\n    '#': idx + 1,\n    'Question': item.question,\n    'Answer': item.answer\n  }))\n\n  await downloadAsExcel(data, filename, 'FAQ')\n}\n\n// ============================================================================\n// PDF Export\n// ============================================================================\n\n/**\n * Generate and download a PDF document\n */\nexport async function downloadAsPDF(\n  content: PDFContent,\n  filename: string\n): Promise<void> {\n  const { jsPDF } = await import('jspdf')\n\n  const doc = new jsPDF({\n    orientation: 'portrait',\n    unit: 'mm',\n    format: 'a4'\n  })\n\n  const pageWidth = doc.internal.pageSize.getWidth()\n  const pageHeight = doc.internal.pageSize.getHeight()\n  const margin = 20\n  const contentWidth = pageWidth - (margin * 2)\n  let y = margin\n\n  // Helper to check for page break\n  const checkPageBreak = (height: number) => {\n    if (y + height > pageHeight - margin) {\n      doc.addPage()\n      y = margin\n      return true\n    }\n    return false\n  }\n\n  // Title\n  if (content.title) {\n    doc.setFontSize(24)\n    doc.setFont('helvetica', 'bold')\n    doc.setTextColor(51, 51, 51)\n    const titleLines = doc.splitTextToSize(content.title, contentWidth)\n    doc.text(titleLines, margin, y)\n    y += titleLines.length * 10 + 10\n  }\n\n  // Subtitle\n  if (content.subtitle) {\n    doc.setFontSize(12)\n    doc.setFont('helvetica', 'normal')\n    doc.setTextColor(102, 102, 102)\n    doc.text(content.subtitle, margin, y)\n    y += 15\n  }\n\n  // Divider line\n  doc.setDrawColor(200, 200, 200)\n  doc.line(margin, y, pageWidth - margin, y)\n  y += 15\n\n  // Sections\n  if (content.sections) {\n    for (const section of content.sections) {\n      checkPageBreak(30)\n\n      // Section heading\n      doc.setFontSize(16)\n      doc.setFont('helvetica', 'bold')\n      doc.setTextColor(51, 51, 51)\n      const headingLines = doc.splitTextToSize(section.heading, contentWidth)\n      doc.text(headingLines, margin, y)\n      y += headingLines.length * 7 + 5\n\n      // Section content\n      doc.setFontSize(11)\n      doc.setFont('helvetica', 'normal')\n      doc.setTextColor(68, 68, 68)\n\n      const contentLines = doc.splitTextToSize(section.content, contentWidth)\n      for (const line of contentLines) {\n        checkPageBreak(6)\n        doc.text(line, margin, y)\n        y += 6\n      }\n\n      y += 10 // Space after section\n    }\n  }\n\n  // Footer with page numbers\n  const pageCount = doc.getNumberOfPages()\n  for (let i = 1; i <= pageCount; i++) {\n    doc.setPage(i)\n    doc.setFontSize(9)\n    doc.setFont('helvetica', 'normal')\n    doc.setTextColor(150, 150, 150)\n    doc.text(\n      `Page ${i} of ${pageCount}`,\n      pageWidth / 2,\n      pageHeight - 10,\n      { align: 'center' }\n    )\n    doc.text(\n      'Generated by NotebookLM Reimagined',\n      margin,\n      pageHeight - 10\n    )\n  }\n\n  doc.save(`${filename}.pdf`)\n}\n\ninterface PDFContent {\n  title?: string\n  subtitle?: string\n  sections?: { heading: string; content: string }[]\n}\n\n/**\n * Export study guide to PDF\n */\nexport async function exportStudyGuideToPDF(\n  guide: StudyGuide,\n  filename = 'study-guide'\n): Promise<void> {\n  await downloadAsPDF(\n    {\n      title: guide.title,\n      subtitle: `${guide.sections.length} sections • Generated study guide`,\n      sections: guide.sections.map(section => ({\n        heading: section.heading,\n        content: section.content.replace(/\\*\\*/g, '').replace(/\\*/g, '') // Strip markdown\n      }))\n    },\n    filename\n  )\n}\n\n/**\n * Export flashcards to PDF\n */\nexport async function exportFlashcardsToPDF(\n  flashcards: Flashcard[],\n  title = 'Flashcards',\n  filename = 'flashcards'\n): Promise<void> {\n  const { jsPDF } = await import('jspdf')\n\n  const doc = new jsPDF({\n    orientation: 'portrait',\n    unit: 'mm',\n    format: 'a4'\n  })\n\n  const pageWidth = doc.internal.pageSize.getWidth()\n  const pageHeight = doc.internal.pageSize.getHeight()\n  const margin = 20\n  const contentWidth = pageWidth - (margin * 2)\n  let y = margin\n\n  // Title\n  doc.setFontSize(24)\n  doc.setFont('helvetica', 'bold')\n  doc.setTextColor(51, 51, 51)\n  doc.text(title, margin, y)\n  y += 15\n\n  // Subtitle\n  doc.setFontSize(12)\n  doc.setFont('helvetica', 'normal')\n  doc.setTextColor(102, 102, 102)\n  doc.text(`${flashcards.length} cards`, margin, y)\n  y += 15\n\n  // Cards\n  flashcards.forEach((card, idx) => {\n    // Check if we need a new page\n    if (y + 50 > pageHeight - margin) {\n      doc.addPage()\n      y = margin\n    }\n\n    // Card container\n    doc.setFillColor(245, 245, 245)\n    doc.roundedRect(margin, y, contentWidth, 45, 3, 3, 'F')\n\n    // Card number\n    doc.setFontSize(10)\n    doc.setFont('helvetica', 'bold')\n    doc.setTextColor(102, 102, 102)\n    doc.text(`Card ${idx + 1}`, margin + 5, y + 8)\n\n    // Question\n    doc.setFontSize(11)\n    doc.setFont('helvetica', 'bold')\n    doc.setTextColor(51, 51, 51)\n    const question = card.front || card.question || ''\n    const qLines = doc.splitTextToSize(`Q: ${question}`, contentWidth - 10)\n    doc.text(qLines.slice(0, 2), margin + 5, y + 18)\n\n    // Answer\n    doc.setFont('helvetica', 'normal')\n    doc.setTextColor(68, 68, 68)\n    const answer = card.back || card.answer || ''\n    const aLines = doc.splitTextToSize(`A: ${answer}`, contentWidth - 10)\n    doc.text(aLines.slice(0, 2), margin + 5, y + 32)\n\n    y += 52\n  })\n\n  doc.save(`${filename}.pdf`)\n}\n\n/**\n * Export quiz to PDF\n */\nexport async function exportQuizToPDF(\n  questions: QuizQuestion[],\n  title = 'Quiz',\n  filename = 'quiz'\n): Promise<void> {\n  const { jsPDF } = await import('jspdf')\n\n  const doc = new jsPDF({\n    orientation: 'portrait',\n    unit: 'mm',\n    format: 'a4'\n  })\n\n  const pageWidth = doc.internal.pageSize.getWidth()\n  const pageHeight = doc.internal.pageSize.getHeight()\n  const margin = 20\n  const contentWidth = pageWidth - (margin * 2)\n  let y = margin\n\n  // Title\n  doc.setFontSize(24)\n  doc.setFont('helvetica', 'bold')\n  doc.setTextColor(51, 51, 51)\n  doc.text(title, margin, y)\n  y += 15\n\n  // Subtitle\n  doc.setFontSize(12)\n  doc.setFont('helvetica', 'normal')\n  doc.setTextColor(102, 102, 102)\n  doc.text(`${questions.length} questions`, margin, y)\n  y += 15\n\n  // Questions\n  questions.forEach((q, idx) => {\n    // Check if we need a new page\n    if (y + 60 > pageHeight - margin) {\n      doc.addPage()\n      y = margin\n    }\n\n    // Question number and text\n    doc.setFontSize(12)\n    doc.setFont('helvetica', 'bold')\n    doc.setTextColor(51, 51, 51)\n    const qLines = doc.splitTextToSize(`${idx + 1}. ${q.question}`, contentWidth)\n    doc.text(qLines, margin, y)\n    y += qLines.length * 6 + 4\n\n    // Options\n    doc.setFontSize(10)\n    doc.setFont('helvetica', 'normal')\n    q.options.forEach((opt, optIdx) => {\n      const isCorrect = optIdx === q.correct_index\n      doc.setTextColor(isCorrect ? 34 : 68, isCorrect ? 139 : 68, isCorrect ? 34 : 68)\n      const optLine = `${String.fromCharCode(65 + optIdx)}) ${opt}${isCorrect ? ' ✓' : ''}`\n      const optLines = doc.splitTextToSize(optLine, contentWidth - 10)\n      doc.text(optLines, margin + 5, y)\n      y += optLines.length * 5 + 2\n    })\n\n    // Explanation\n    if (q.explanation) {\n      doc.setFontSize(9)\n      doc.setFont('helvetica', 'italic')\n      doc.setTextColor(102, 102, 102)\n      const expLines = doc.splitTextToSize(`💡 ${q.explanation}`, contentWidth - 10)\n      doc.text(expLines.slice(0, 2), margin + 5, y + 2)\n      y += Math.min(expLines.length, 2) * 4 + 4\n    }\n\n    y += 10\n  })\n\n  doc.save(`${filename}.pdf`)\n}\n\n/**\n * Export FAQ to PDF\n */\nexport async function exportFAQToPDF(\n  items: FAQItem[],\n  title = 'Frequently Asked Questions',\n  filename = 'faq'\n): Promise<void> {\n  await downloadAsPDF(\n    {\n      title,\n      subtitle: `${items.length} questions`,\n      sections: items.map((item, idx) => ({\n        heading: `Q${idx + 1}: ${item.question}`,\n        content: item.answer\n      }))\n    },\n    filename\n  )\n}\n\n// ============================================================================\n// Image (PNG) Export\n// ============================================================================\n\n/**\n * Export SVG element to PNG\n */\nexport async function exportSVGToPNG(\n  svgElement: SVGSVGElement,\n  filename: string,\n  options: { scale?: number; backgroundColor?: string } = {}\n): Promise<void> {\n  const { scale = 2, backgroundColor = '#1a1a2e' } = options\n\n  // Get SVG dimensions\n  const bbox = svgElement.getBBox()\n  const viewBox = svgElement.getAttribute('viewBox')?.split(' ').map(Number) || [0, 0, 800, 600]\n  const width = viewBox[2] || bbox.width || 800\n  const height = viewBox[3] || bbox.height || 600\n\n  // Create canvas\n  const canvas = document.createElement('canvas')\n  canvas.width = width * scale\n  canvas.height = height * scale\n  const ctx = canvas.getContext('2d')\n\n  if (!ctx) {\n    throw new Error('Could not get canvas context')\n  }\n\n  // Fill background\n  ctx.fillStyle = backgroundColor\n  ctx.fillRect(0, 0, canvas.width, canvas.height)\n  ctx.scale(scale, scale)\n\n  // Clone SVG and inline styles to avoid cross-origin issues\n  const clonedSvg = svgElement.cloneNode(true) as SVGSVGElement\n\n  // Ensure SVG has proper dimensions\n  clonedSvg.setAttribute('width', String(width))\n  clonedSvg.setAttribute('height', String(height))\n\n  // Remove any external references that could cause CORS issues\n  const images = clonedSvg.querySelectorAll('image')\n  images.forEach(img => {\n    const href = img.getAttribute('href') || img.getAttribute('xlink:href')\n    // Remove external image references that could taint canvas\n    if (href && !href.startsWith('data:')) {\n      img.remove()\n    }\n  })\n\n  // Convert SVG to base64 data URL (avoids CORS tainting)\n  const svgData = new XMLSerializer().serializeToString(clonedSvg)\n  const svgBase64 = btoa(unescape(encodeURIComponent(svgData)))\n  const svgDataUrl = `data:image/svg+xml;base64,${svgBase64}`\n\n  return new Promise((resolve, reject) => {\n    const img = new Image()\n    img.onload = () => {\n      try {\n        ctx.drawImage(img, 0, 0)\n        // Download\n        const link = document.createElement('a')\n        link.download = `${filename}.png`\n        link.href = canvas.toDataURL('image/png')\n        link.click()\n        resolve()\n      } catch (error) {\n        // Fallback: download as SVG if PNG export fails\n        console.error('PNG export failed, falling back to SVG:', error)\n        const svgBlob = new Blob([svgData], { type: 'image/svg+xml;charset=utf-8' })\n        const link = document.createElement('a')\n        link.download = `${filename}.svg`\n        link.href = URL.createObjectURL(svgBlob)\n        link.click()\n        URL.revokeObjectURL(link.href)\n        resolve()\n      }\n    }\n    img.onerror = () => {\n      // Fallback: download as SVG if image load fails\n      console.error('Image load failed, falling back to SVG')\n      const svgBlob = new Blob([svgData], { type: 'image/svg+xml;charset=utf-8' })\n      const link = document.createElement('a')\n      link.download = `${filename}.svg`\n      link.href = URL.createObjectURL(svgBlob)\n      link.click()\n      URL.revokeObjectURL(link.href)\n      resolve()\n    }\n    img.src = svgDataUrl\n  })\n}\n\n/**\n * Export Mind Map to PNG\n * Takes the SVG element from the mind map viewer and converts to PNG\n */\nexport async function exportMindMapToPNG(\n  svgElement: SVGSVGElement,\n  title: string,\n  filename = 'mind-map'\n): Promise<void> {\n  await exportSVGToPNG(svgElement, filename, {\n    scale: 2,\n    backgroundColor: '#1e1e2e'\n  })\n}\n\n// ============================================================================\n// Generic Utilities\n// ============================================================================\n\n/**\n * Generate a timestamped filename\n */\nexport function generateFilename(base: string): string {\n  const date = new Date()\n  const timestamp = date.toISOString().slice(0, 10).replace(/-/g, '')\n  return `${base}_${timestamp}`\n}\n\n/**\n * Trigger file download from blob\n */\nexport function downloadBlob(blob: Blob, filename: string): void {\n  const url = URL.createObjectURL(blob)\n  const link = document.createElement('a')\n  link.href = url\n  link.download = filename\n  document.body.appendChild(link)\n  link.click()\n  document.body.removeChild(link)\n  URL.revokeObjectURL(url)\n}\n","numLines":588,"startLine":1,"totalLines":588}},"sourceToolAssistantUUID":"6c02d764-7efb-4708-b926-2fbc9bd9e44c"}
{"parentUuid":"b3e99e6a-9ef9-497b-aa52-a4c32d61926e","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01GhWaTHNPZpvZSqCNNGE5ir","type":"tool_result","content":"     1→'use client'\n     2→\n     3→import { useState } from 'react'\n     4→import { motion, AnimatePresence } from 'framer-motion'\n     5→import {\n     6→  Microphone,\n     7→  VideoCamera,\n     8→  MagnifyingGlass,\n     9→  GraduationCap,\n    10→  CaretDown,\n    11→  CaretRight,\n    12→  Play,\n    13→  SpinnerGap,\n    14→  BookOpen,\n    15→  ListChecks,\n    16→  FileText,\n    17→  Question,\n    18→  Note,\n    19→  Plus,\n    20→  ShareNetwork,\n    21→  ArrowsClockwise,\n    22→  Clock,\n    23→  WarningCircle,\n    24→  Table,\n    25→  ChartBar,\n    26→  PresentationChart,\n    27→  Image,\n    28→  Palette,\n    29→  Cards,\n    30→  TreeStructure,\n    31→  ChatCircleText,\n    32→  Sparkle\n    33→} from '@phosphor-icons/react'\n    34→import { Button } from '@/components/ui/button'\n    35→import { Input } from '@/components/ui/input'\n    36→import { Textarea } from '@/components/ui/textarea'\n    37→import { Badge } from '@/components/ui/badge'\n    38→import { ScrollArea } from '@/components/ui/scroll-area'\n    39→import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select'\n    40→import { Tooltip, TooltipContent, TooltipTrigger } from '@/components/ui/tooltip'\n    41→import { GenerationConfigDialog, GenerationType, GenerationConfig } from './generation-config-dialog'\n    42→\n    43→// Metadata for a generated study material\n    44→export interface StudyMaterialMeta {\n    45→  id: string\n    46→  type: string\n    47→  sourceIds: string[]\n    48→  sourceNames: string[]\n    49→  createdAt: string\n    50→  itemCount?: number\n    51→}\n    52→\n    53→// Helper to format relative time\n    54→function getTimeAgo(dateString: string): string {\n    55→  const date = new Date(dateString)\n    56→  const now = new Date()\n    57→  const diffMs = now.getTime() - date.getTime()\n    58→  const diffMins = Math.floor(diffMs / 60000)\n    59→  const diffHours = Math.floor(diffMs / 3600000)\n    60→  const diffDays = Math.floor(diffMs / 86400000)\n    61→\n    62→  if (diffMins < 1) return 'Just now'\n    63→  if (diffMins < 60) return `${diffMins}m ago`\n    64→  if (diffHours < 24) return `${diffHours}h ago`\n    65→  if (diffDays < 7) return `${diffDays}d ago`\n    66→  return date.toLocaleDateString()\n    67→}\n    68→\n    69→// Source type for selection\n    70→export interface SourceInfo {\n    71→  id: string\n    72→  name: string\n    73→}\n    74→\n    75→interface StudioPanelProps {\n    76→  notebookId: string\n    77→  selectedSourcesCount: number\n    78→  selectedSourceIds: string[]\n    79→  sources?: SourceInfo[]\n    80→  // Audio\n    81→  audioFormat: string\n    82→  onAudioFormatChange: (format: string) => void\n    83→  audioInstructions: string\n    84→  onAudioInstructionsChange: (instructions: string) => void\n    85→  onGenerateAudio: () => void\n    86→  generatingAudio: boolean\n    87→  // Video\n    88→  videoStyle: string\n    89→  onVideoStyleChange: (style: string) => void\n    90→  onGenerateVideo: () => void\n    91→  generatingVideo: boolean\n    92→  // Research\n    93→  researchQuery: string\n    94→  onResearchQueryChange: (query: string) => void\n    95→  researchMode: string\n    96→  onResearchModeChange: (mode: string) => void\n    97→  onRunResearch: () => void\n    98→  researching: boolean\n    99→  // Study - now accepts config\n   100→  onGenerateStudyMaterial: (config: GenerationConfig) => void\n   101→  generatingFlashcards: boolean\n   102→  generatingQuiz: boolean\n   103→  generatingStudyGuide: boolean\n   104→  generatingFaq: boolean\n   105→  generatingMindMap: boolean\n   106→  // Creative Outputs - now accepts config\n   107→  onGenerateCreativeOutput?: (config: GenerationConfig) => void\n   108→  generatingDataTable?: boolean\n   109→  generatingReport?: boolean\n   110→  generatingSlideDeck?: boolean\n   111→  generatingInfographic?: boolean\n   112→  // Creative outputs results\n   113→  creativeOutputs?: Array<{\n   114→    id: string\n   115→    type: string\n   116→    title: string\n   117→    status: string\n   118→    createdAt: string\n   119→  }>\n   120→  onOpenCreativeOutput?: (type: string) => void\n   121→  // Results - now with metadata\n   122→  studyMaterials?: StudyMaterialMeta[]\n   123→  onOpenStudyMaterial?: (type: string) => void\n   124→  // Notes\n   125→  notesCount?: number\n   126→  onAddNote?: () => void\n   127→  onOpenNotes?: () => void\n   128→  // Generated content\n   129→  hasGeneratedAudio?: boolean\n   130→  hasGeneratedVideo?: boolean\n   131→  hasGeneratedResearch?: boolean\n   132→  onOpenAudio?: () => void\n   133→  onOpenVideo?: () => void\n   134→  onOpenResearch?: () => void\n   135→}\n   136→\n   137→export function StudioPanel({\n   138→  notebookId,\n   139→  selectedSourcesCount,\n   140→  selectedSourceIds,\n   141→  sources = [],\n   142→  audioFormat,\n   143→  onAudioFormatChange,\n   144→  audioInstructions,\n   145→  onAudioInstructionsChange,\n   146→  onGenerateAudio,\n   147→  generatingAudio,\n   148→  videoStyle,\n   149→  onVideoStyleChange,\n   150→  onGenerateVideo,\n   151→  generatingVideo,\n   152→  researchQuery,\n   153→  onResearchQueryChange,\n   154→  researchMode,\n   155→  onResearchModeChange,\n   156→  onRunResearch,\n   157→  researching,\n   158→  onGenerateStudyMaterial,\n   159→  generatingFlashcards,\n   160→  generatingQuiz,\n   161→  generatingStudyGuide,\n   162→  generatingFaq,\n   163→  generatingMindMap,\n   164→  onGenerateCreativeOutput,\n   165→  generatingDataTable = false,\n   166→  generatingReport = false,\n   167→  generatingSlideDeck = false,\n   168→  generatingInfographic = false,\n   169→  creativeOutputs = [],\n   170→  onOpenCreativeOutput,\n   171→  studyMaterials = [],\n   172→  onOpenStudyMaterial,\n   173→  notesCount = 0,\n   174→  onAddNote,\n   175→  onOpenNotes,\n   176→  hasGeneratedAudio = false,\n   177→  hasGeneratedVideo = false,\n   178→  hasGeneratedResearch = false,\n   179→  onOpenAudio,\n   180→  onOpenVideo,\n   181→  onOpenResearch,\n   182→}: StudioPanelProps) {\n   183→  const [expandedSection, setExpandedSection] = useState<string | null>('audio')\n   184→  const [configDialogOpen, setConfigDialogOpen] = useState(false)\n   185→  const [configDialogType, setConfigDialogType] = useState<GenerationType>('flashcards')\n   186→\n   187→  // Open config dialog for a specific type\n   188→  const openConfigDialog = (type: GenerationType) => {\n   189→    setConfigDialogType(type)\n   190→    setConfigDialogOpen(true)\n   191→  }\n   192→\n   193→  // Handle generation from config dialog\n   194→  const handleGenerate = (config: GenerationConfig) => {\n   195→    setConfigDialogOpen(false)\n   196→\n   197→    // Route to appropriate handler based on type\n   198→    const studyTypes = ['flashcards', 'quiz', 'study-guide', 'faq', 'mind-map']\n   199→    if (studyTypes.includes(config.type)) {\n   200→      onGenerateStudyMaterial(config)\n   201→    } else {\n   202→      onGenerateCreativeOutput?.(config)\n   203→    }\n   204→  }\n   205→\n   206→  // Check if currently generating for a type\n   207→  const isGenerating = (type: GenerationType): boolean => {\n   208→    switch (type) {\n   209→      case 'flashcards': return generatingFlashcards\n   210→      case 'quiz': return generatingQuiz\n   211→      case 'study-guide': return generatingStudyGuide\n   212→      case 'faq': return generatingFaq\n   213→      case 'mind-map': return generatingMindMap\n   214→      case 'data_table': return generatingDataTable\n   215→      case 'report': return generatingReport\n   216→      case 'slide_deck': return generatingSlideDeck\n   217→      case 'infographic': return generatingInfographic\n   218→      default: return false\n   219→    }\n   220→  }\n   221→\n   222→  const toggleSection = (section: string) => {\n   223→    setExpandedSection(expandedSection === section ? null : section)\n   224→  }\n   225→\n   226→  // Check if a material's sources match current selection\n   227→  const isMaterialStale = (material: StudyMaterialMeta) => {\n   228→    const sortedMaterialIds = [...material.sourceIds].sort()\n   229→    const sortedSelectedIds = [...selectedSourceIds].sort()\n   230→    if (sortedMaterialIds.length !== sortedSelectedIds.length) return true\n   231→    return !sortedMaterialIds.every((id, idx) => id === sortedSelectedIds[idx])\n   232→  }\n   233→\n   234→  // Format relative time\n   235→  const formatTimeAgo = (dateStr: string) => {\n   236→    const date = new Date(dateStr)\n   237→    const now = new Date()\n   238→    const diffMs = now.getTime() - date.getTime()\n   239→    const diffMins = Math.floor(diffMs / 60000)\n   240→    const diffHours = Math.floor(diffMins / 60)\n   241→    const diffDays = Math.floor(diffHours / 24)\n   242→\n   243→    if (diffMins < 1) return 'Just now'\n   244→    if (diffMins < 60) return `${diffMins}m ago`\n   245→    if (diffHours < 24) return `${diffHours}h ago`\n   246→    if (diffDays < 7) return `${diffDays}d ago`\n   247→    return date.toLocaleDateString()\n   248→  }\n   249→\n   250→  // Get material by type\n   251→  const getMaterial = (type: string) => studyMaterials.find(m => m.type === type)\n   252→\n   253→  return (\n   254→    <ScrollArea className=\"h-full\">\n   255→      <div className=\"p-4 space-y-3\">\n   256→        {/* Audio Overview Section */}\n   257→        <StudioSection\n   258→          id=\"audio\"\n   259→          title=\"Audio Overview\"\n   260→          subtitle=\"Podcast-style discussion\"\n   261→          icon={<Microphone className=\"h-5 w-5\" weight=\"duotone\" />}\n   262→          iconGradient=\"from-orange-500/20 to-red-500/20\"\n   263→          iconColor=\"text-orange-500\"\n   264→          expanded={expandedSection === 'audio'}\n   265→          onToggle={() => toggleSection('audio')}\n   266→        >\n   267→          <div className=\"space-y-3\">\n   268→            <div className=\"space-y-1.5\">\n   269→              <label className=\"text-xs font-medium text-[var(--text-primary)]\">Format</label>\n   270→              <Select value={audioFormat} onValueChange={onAudioFormatChange}>\n   271→                <SelectTrigger className=\"h-9 text-sm bg-[var(--bg-tertiary)] border-[rgba(255,255,255,0.1)] rounded-lg\">\n   272→                  <SelectValue />\n   273→                </SelectTrigger>\n   274→                <SelectContent className=\"bg-[var(--bg-secondary)] border-[rgba(255,255,255,0.1)]\">\n   275→                  <SelectItem value=\"deep_dive\">Deep Dive (10-15 min)</SelectItem>\n   276→                  <SelectItem value=\"brief\">Brief Summary (2-3 min)</SelectItem>\n   277→                  <SelectItem value=\"critique\">Analytical (5-10 min)</SelectItem>\n   278→                  <SelectItem value=\"debate\">Debate (8-15 min)</SelectItem>\n   279→                </SelectContent>\n   280→              </Select>\n   281→            </div>\n   282→            <div className=\"space-y-1.5\">\n   283→              <label className=\"text-xs font-medium text-[var(--text-primary)]\">Custom Instructions</label>\n   284→              <Textarea\n   285→                placeholder=\"Optional instructions for hosts...\"\n   286→                value={audioInstructions}\n   287→                onChange={(e) => onAudioInstructionsChange(e.target.value)}\n   288→                rows={2}\n   289→                className=\"text-sm resize-none bg-[var(--bg-tertiary)] border-[rgba(255,255,255,0.1)] text-[var(--text-primary)] placeholder:text-[var(--text-tertiary)] focus:border-[var(--accent-primary)] rounded-lg\"\n   290→              />\n   291→            </div>\n   292→            <div className=\"flex gap-2\">\n   293→              <Button\n   294→                className=\"flex-1 rounded-lg bg-orange-500 hover:bg-orange-500/90 text-white\"\n   295→                onClick={onGenerateAudio}\n   296→                disabled={generatingAudio || selectedSourcesCount === 0}\n   297→              >\n   298→                {generatingAudio ? (\n   299→                  <SpinnerGap className=\"h-4 w-4 mr-2 animate-spin\" weight=\"bold\" />\n   300→                ) : (\n   301→                  <Play className=\"h-4 w-4 mr-2\" />\n   302→                )}\n   303→                Generate\n   304→              </Button>\n   305→              {hasGeneratedAudio && onOpenAudio && (\n   306→                <Button\n   307→                  variant=\"outline\"\n   308→                  className=\"rounded-lg border-orange-500/30 text-orange-500 hover:bg-orange-500/10\"\n   309→                  onClick={onOpenAudio}\n   310→                >\n   311→                  View\n   312→                  <CaretRight className=\"h-4 w-4 ml-1\" weight=\"bold\" />\n   313→                </Button>\n   314→              )}\n   315→            </div>\n   316→            {selectedSourcesCount === 0 && (\n   317→              <p className=\"text-xs text-[var(--text-tertiary)] text-center\">\n   318→                Select sources to generate\n   319→              </p>\n   320→            )}\n   321→          </div>\n   322→        </StudioSection>\n   323→\n   324→        {/* Video Overview Section */}\n   325→        <StudioSection\n   326→          id=\"video\"\n   327→          title=\"Video Overview\"\n   328→          subtitle=\"AI-generated video clip\"\n   329→          icon={<VideoCamera className=\"h-5 w-5\" weight=\"duotone\" />}\n   330→          iconGradient=\"from-purple-500/20 to-pink-500/20\"\n   331→          iconColor=\"text-purple-500\"\n   332→          expanded={expandedSection === 'video'}\n   333→          onToggle={() => toggleSection('video')}\n   334→        >\n   335→          <div className=\"space-y-3\">\n   336→            <div className=\"space-y-1.5\">\n   337→              <label className=\"text-xs font-medium text-[var(--text-primary)]\">Style</label>\n   338→              <Select value={videoStyle} onValueChange={onVideoStyleChange}>\n   339→                <SelectTrigger className=\"h-9 text-sm bg-[var(--bg-tertiary)] border-[rgba(255,255,255,0.1)] rounded-lg\">\n   340→                  <SelectValue />\n   341→                </SelectTrigger>\n   342→                <SelectContent className=\"bg-[var(--bg-secondary)] border-[rgba(255,255,255,0.1)]\">\n   343→                  <SelectItem value=\"explainer\">Explainer (5s)</SelectItem>\n   344→                  <SelectItem value=\"documentary\">Documentary (10s)</SelectItem>\n   345→                  <SelectItem value=\"presentation\">Presentation (5s)</SelectItem>\n   346→                </SelectContent>\n   347→              </Select>\n   348→            </div>\n   349→            <p className=\"text-xs text-[var(--text-tertiary)]\">\n   350→              Generates an AI video clip using Wan 2.5. Estimated cost: ~$0.10-0.20\n   351→            </p>\n   352→            <div className=\"flex gap-2\">\n   353→              <Button\n   354→                className=\"flex-1 rounded-lg bg-purple-500 hover:bg-purple-500/90 text-white\"\n   355→                onClick={onGenerateVideo}\n   356→                disabled={generatingVideo || selectedSourcesCount === 0}\n   357→              >\n   358→                {generatingVideo ? (\n   359→                  <SpinnerGap className=\"h-4 w-4 mr-2 animate-spin\" weight=\"bold\" />\n   360→                ) : (\n   361→                  <VideoCamera className=\"h-4 w-4 mr-2\" weight=\"duotone\" />\n   362→                )}\n   363→                {generatingVideo ? 'Generating...' : 'Generate Video'}\n   364→              </Button>\n   365→              {hasGeneratedVideo && onOpenVideo && (\n   366→                <Button\n   367→                  variant=\"outline\"\n   368→                  className=\"rounded-lg border-purple-500/30 text-purple-500 hover:bg-purple-500/10\"\n   369→                  onClick={onOpenVideo}\n   370→                >\n   371→                  View\n   372→                  <CaretRight className=\"h-4 w-4 ml-1\" weight=\"bold\" />\n   373→                </Button>\n   374→              )}\n   375→            </div>\n   376→            {selectedSourcesCount === 0 && (\n   377→              <p className=\"text-xs text-[var(--text-tertiary)] text-center\">\n   378→                Select sources to generate\n   379→              </p>\n   380→            )}\n   381→          </div>\n   382→        </StudioSection>\n   383→\n   384→        {/* Deep Research Section */}\n   385→        <StudioSection\n   386→          id=\"research\"\n   387→          title=\"Deep Research\"\n   388→          subtitle=\"Autonomous web research\"\n   389→          icon={<MagnifyingGlass className=\"h-5 w-5\" weight=\"duotone\" />}\n   390→          iconGradient=\"from-blue-500/20 to-cyan-500/20\"\n   391→          iconColor=\"text-blue-500\"\n   392→          expanded={expandedSection === 'research'}\n   393→          onToggle={() => toggleSection('research')}\n   394→        >\n   395→          <div className=\"space-y-3\">\n   396→            <div className=\"space-y-1.5\">\n   397→              <label className=\"text-xs font-medium text-[var(--text-primary)]\">Research Query</label>\n   398→              <Input\n   399→                placeholder=\"What would you like to research?\"\n   400→                value={researchQuery}\n   401→                onChange={(e) => onResearchQueryChange(e.target.value)}\n   402→                className=\"h-9 text-sm bg-[var(--bg-tertiary)] border-[rgba(255,255,255,0.1)] text-[var(--text-primary)] placeholder:text-[var(--text-tertiary)] focus:border-[var(--accent-primary)] rounded-lg\"\n   403→              />\n   404→            </div>\n   405→            <div className=\"space-y-1.5\">\n   406→              <label className=\"text-xs font-medium text-[var(--text-primary)]\">Mode</label>\n   407→              <Select value={researchMode} onValueChange={onResearchModeChange}>\n   408→                <SelectTrigger className=\"h-9 text-sm bg-[var(--bg-tertiary)] border-[rgba(255,255,255,0.1)] rounded-lg\">\n   409→                  <SelectValue />\n   410→                </SelectTrigger>\n   411→                <SelectContent className=\"bg-[var(--bg-secondary)] border-[rgba(255,255,255,0.1)]\">\n   412→                  <SelectItem value=\"fast\">Fast (3-5 min)</SelectItem>\n   413→                  <SelectItem value=\"deep\">Deep (10-15 min)</SelectItem>\n   414→                </SelectContent>\n   415→              </Select>\n   416→            </div>\n   417→            <div className=\"flex gap-2\">\n   418→              <Button\n   419→                className=\"flex-1 rounded-lg bg-blue-500 hover:bg-blue-500/90 text-white\"\n   420→                onClick={onRunResearch}\n   421→                disabled={researching || !researchQuery.trim()}\n   422→              >\n   423→                {researching ? (\n   424→                  <SpinnerGap className=\"h-4 w-4 mr-2 animate-spin\" weight=\"bold\" />\n   425→                ) : (\n   426→                  <MagnifyingGlass className=\"h-4 w-4 mr-2\" weight=\"duotone\" />\n   427→                )}\n   428→                Research\n   429→              </Button>\n   430→              {hasGeneratedResearch && onOpenResearch && (\n   431→                <Button\n   432→                  variant=\"outline\"\n   433→                  className=\"rounded-lg border-blue-500/30 text-blue-500 hover:bg-blue-500/10\"\n   434→                  onClick={onOpenResearch}\n   435→                >\n   436→                  View\n   437→                  <CaretRight className=\"h-4 w-4 ml-1\" weight=\"bold\" />\n   438→                </Button>\n   439→              )}\n   440→            </div>\n   441→          </div>\n   442→        </StudioSection>\n   443→\n   444→        {/* Study Materials Section */}\n   445→        <StudioSection\n   446→          id=\"study\"\n   447→          title=\"Study Materials\"\n   448→          subtitle=\"Flashcards, quizzes, and more\"\n   449→          icon={<GraduationCap className=\"h-5 w-5\" />}\n   450→          iconGradient=\"from-emerald-500/20 to-teal-500/20\"\n   451→          iconColor=\"text-emerald-500\"\n   452→          expanded={expandedSection === 'study'}\n   453→          onToggle={() => toggleSection('study')}\n   454→        >\n   455→          <div className=\"space-y-4\">\n   456→            {/* Study Tools Grid */}\n   457→            <div className=\"grid grid-cols-2 gap-2\">\n   458→              <StudyToolButton\n   459→                icon={<BookOpen className=\"h-5 w-5\" />}\n   460→                label=\"Flashcards\"\n   461→                color=\"text-blue-500\"\n   462→                onClick={() => openConfigDialog('flashcards')}\n   463→                loading={generatingFlashcards}\n   464→                disabled={selectedSourcesCount === 0}\n   465→              />\n   466→              <StudyToolButton\n   467→                icon={<ListChecks className=\"h-5 w-5\" />}\n   468→                label=\"Quiz\"\n   469→                color=\"text-purple-500\"\n   470→                onClick={() => openConfigDialog('quiz')}\n   471→                loading={generatingQuiz}\n   472→                disabled={selectedSourcesCount === 0}\n   473→              />\n   474→              <StudyToolButton\n   475→                icon={<FileText className=\"h-5 w-5\" />}\n   476→                label=\"Study Guide\"\n   477→                color=\"text-orange-500\"\n   478→                onClick={() => openConfigDialog('study-guide')}\n   479→                loading={generatingStudyGuide}\n   480→                disabled={selectedSourcesCount === 0}\n   481→              />\n   482→              <StudyToolButton\n   483→                icon={<Question className=\"h-5 w-5\" weight=\"duotone\" />}\n   484→                label=\"FAQ\"\n   485→                color=\"text-teal-500\"\n   486→                onClick={() => openConfigDialog('faq')}\n   487→                loading={generatingFaq}\n   488→                disabled={selectedSourcesCount === 0}\n   489→              />\n   490→              <StudyToolButton\n   491→                icon={<TreeStructure className=\"h-5 w-5\" weight=\"duotone\" />}\n   492→                label=\"Mind Map\"\n   493→                color=\"text-cyan-500\"\n   494→                onClick={() => openConfigDialog('mind-map')}\n   495→                loading={generatingMindMap}\n   496→                disabled={selectedSourcesCount === 0}\n   497→              />\n   498→            </div>\n   499→\n   500→            {selectedSourcesCount === 0 && (\n   501→              <p className=\"text-xs text-[var(--text-tertiary)] text-center\">\n   502→                Select sources to generate study materials\n   503→              </p>\n   504→            )}\n   505→\n   506→            {/* Generated Materials */}\n   507→            {studyMaterials.length > 0 && (\n   508→              <div className=\"pt-3 border-t border-[rgba(255,255,255,0.1)]\">\n   509→                <p className=\"text-xs font-medium text-[var(--text-tertiary)] mb-2\">Generated Materials</p>\n   510→                <div className=\"space-y-2\">\n   511→                  {studyMaterials.map((material) => {\n   512→                    const isStale = isMaterialStale(material)\n   513→                    const iconMap: Record<string, { icon: React.ReactNode; color: string; label: string }> = {\n   514→                      flashcards: { icon: <BookOpen className=\"h-4 w-4\" />, color: 'text-blue-500', label: `${material.itemCount || 0} Flashcards` },\n   515→                      quiz: { icon: <ListChecks className=\"h-4 w-4\" />, color: 'text-purple-500', label: `${material.itemCount || 0} Quiz Questions` },\n   516→                      study_guide: { icon: <FileText className=\"h-4 w-4\" />, color: 'text-orange-500', label: 'Study Guide' },\n   517→                      faq: { icon: <ChatCircleText className=\"h-4 w-4\" weight=\"duotone\" />, color: 'text-teal-500', label: `${material.itemCount || 0} FAQ Items` },\n   518→                      mind_map: { icon: <TreeStructure className=\"h-4 w-4\" weight=\"duotone\" />, color: 'text-cyan-500', label: 'Mind Map' },\n   519→                    }\n   520→                    const info = iconMap[material.type] || { icon: <FileText className=\"h-4 w-4\" />, color: 'text-gray-500', label: material.type }\n   521→\n   522→                    return (\n   523→                      <div\n   524→                        key={material.id}\n   525→                        className={`rounded-lg border ${isStale ? 'border-amber-500/30 bg-amber-500/5' : 'border-[rgba(255,255,255,0.1)]'} overflow-hidden`}\n   526→                      >\n   527→                        <button\n   528→                          onClick={() => onOpenStudyMaterial?.(material.type)}\n   529→                          className=\"w-full flex items-center gap-2 px-3 py-2 text-sm hover:bg-[var(--bg-tertiary)] transition-colors\"\n   530→                        >\n   531→                          <span className={info.color}>{info.icon}</span>\n   532→                          <span className=\"text-[var(--text-primary)] flex-1 text-left\">{info.label}</span>\n   533→                          {isStale && (\n   534→                            <Tooltip>\n   535→                              <TooltipTrigger asChild>\n   536→                                <WarningCircle className=\"h-3.5 w-3.5 text-amber-500\" weight=\"fill\" />\n   537→                              </TooltipTrigger>\n   538→                              <TooltipContent>\n   539→                                <p>Sources changed - regenerate for updated content</p>\n   540→                              </TooltipContent>\n   541→                            </Tooltip>\n   542→                          )}\n   543→                          <CaretRight className=\"h-4 w-4 text-[var(--text-tertiary)]\" weight=\"bold\" />\n   544→                        </button>\n   545→                        <div className=\"px-3 py-1.5 bg-[var(--bg-tertiary)]/50 border-t border-[rgba(255,255,255,0.05)] flex items-center gap-3 text-[10px] text-[var(--text-tertiary)]\">\n   546→                          <span className=\"flex items-center gap-1\">\n   547→                            <Clock className=\"h-3 w-3\" />\n   548→                            {formatTimeAgo(material.createdAt)}\n   549→                          </span>\n   550→                          <span>•</span>\n   551→                          <span className=\"truncate\">\n   552→                            {material.sourceNames.length === 1\n   553→                              ? material.sourceNames[0]\n   554→                              : `${material.sourceNames.length} sources`}\n   555→                          </span>\n   556→                        </div>\n   557→                      </div>\n   558→                    )\n   559→                  })}\n   560→                </div>\n   561→              </div>\n   562→            )}\n   563→          </div>\n   564→        </StudioSection>\n   565→\n   566→        {/* Creative Outputs Section */}\n   567→        <StudioSection\n   568→          id=\"creative\"\n   569→          title=\"Creative Outputs\"\n   570→          subtitle=\"Tables, reports, slides, infographics\"\n   571→          icon={<Palette className=\"h-5 w-5\" />}\n   572→          iconGradient=\"from-pink-500/20 to-rose-500/20\"\n   573→          iconColor=\"text-pink-500\"\n   574→          expanded={expandedSection === 'creative'}\n   575→          onToggle={() => toggleSection('creative')}\n   576→        >\n   577→          <div className=\"space-y-4\">\n   578→            {/* Creative Tools Grid */}\n   579→            <div className=\"grid grid-cols-2 gap-2\">\n   580→              <StudyToolButton\n   581→                icon={<Table className=\"h-5 w-5\" />}\n   582→                label=\"Data Table\"\n   583→                color=\"text-emerald-500\"\n   584→                onClick={() => openConfigDialog('data_table')}\n   585→                loading={generatingDataTable}\n   586→                disabled={selectedSourcesCount === 0}\n   587→              />\n   588→              <StudyToolButton\n   589→                icon={<Palette className=\"h-5 w-5\" weight=\"duotone\" />}\n   590→                label=\"Report\"\n   591→                color=\"text-blue-500\"\n   592→                onClick={() => openConfigDialog('report')}\n   593→                loading={generatingReport}\n   594→                disabled={selectedSourcesCount === 0}\n   595→              />\n   596→              <StudyToolButton\n   597→                icon={<PresentationChart className=\"h-5 w-5\" />}\n   598→                label=\"Slide Deck\"\n   599→                color=\"text-violet-500\"\n   600→                onClick={() => openConfigDialog('slide_deck')}\n   601→                loading={generatingSlideDeck}\n   602→                disabled={selectedSourcesCount === 0}\n   603→              />\n   604→              <StudyToolButton\n   605→                icon={<Image className=\"h-5 w-5\" />}\n   606→                label=\"Infographic\"\n   607→                color=\"text-rose-500\"\n   608→                onClick={() => openConfigDialog('infographic')}\n   609→                loading={generatingInfographic}\n   610→                disabled={selectedSourcesCount === 0}\n   611→              />\n   612→            </div>\n   613→\n   614→            {selectedSourcesCount === 0 && (\n   615→              <p className=\"text-xs text-[var(--text-tertiary)] text-center\">\n   616→                Select sources to generate creative outputs\n   617→              </p>\n   618→            )}\n   619→\n   620→            {/* Generated Outputs */}\n   621→            {creativeOutputs.length > 0 && (\n   622→              <div className=\"mt-4 pt-4 border-t border-[rgba(255,255,255,0.1)]\">\n   623→                <p className=\"text-xs font-medium text-[var(--text-tertiary)] mb-3\">Generated Outputs</p>\n   624→                <div className=\"space-y-2\">\n   625→                  {creativeOutputs.map((output) => {\n   626→                    const typeConfig: Record<string, { icon: React.ReactNode; label: string; color: string }> = {\n   627→                      data_table: { icon: <Table className=\"h-4 w-4\" />, label: 'Data Table', color: 'text-emerald-500' },\n   628→                      report: { icon: <ChartBar className=\"h-4 w-4\" weight=\"duotone\" />, label: 'Report', color: 'text-blue-500' },\n   629→                      slide_deck: { icon: <PresentationChart className=\"h-4 w-4\" />, label: 'Slide Deck', color: 'text-violet-500' },\n   630→                      infographic: { icon: <Image className=\"h-4 w-4\" />, label: 'Infographic', color: 'text-rose-500' },\n   631→                    }\n   632→                    const config = typeConfig[output.type] || { icon: <FileText className=\"h-4 w-4\" />, label: output.type, color: 'text-gray-500' }\n   633→                    const timeAgo = getTimeAgo(output.createdAt)\n   634→\n   635→                    return (\n   636→                      <button\n   637→                        key={output.id}\n   638→                        onClick={() => onOpenCreativeOutput?.(output.type)}\n   639→                        className=\"w-full flex items-center gap-3 p-3 rounded-xl bg-[var(--bg-tertiary)] hover:bg-[var(--bg-tertiary)]/80 transition-colors text-left\"\n   640→                      >\n   641→                        <div className={`${config.color}`}>{config.icon}</div>\n   642→                        <div className=\"flex-1 min-w-0\">\n   643→                          <p className=\"text-sm font-medium text-[var(--text-primary)] truncate\">{config.label}</p>\n   644→                          <p className=\"text-xs text-[var(--text-tertiary)]\">{timeAgo}</p>\n   645→                        </div>\n   646→                        <CaretRight className=\"h-4 w-4 text-[var(--text-tertiary)]\" weight=\"bold\" />\n   647→                      </button>\n   648→                    )\n   649→                  })}\n   650→                </div>\n   651→              </div>\n   652→            )}\n   653→          </div>\n   654→        </StudioSection>\n   655→\n   656→        {/* Notes Section */}\n   657→        <StudioSection\n   658→          id=\"notes\"\n   659→          title=\"Notes\"\n   660→          subtitle={`${notesCount} saved`}\n   661→          icon={<Note className=\"h-5 w-5\" weight=\"duotone\" />}\n   662→          iconGradient=\"from-amber-500/20 to-yellow-500/20\"\n   663→          iconColor=\"text-amber-500\"\n   664→          expanded={expandedSection === 'notes'}\n   665→          onToggle={() => toggleSection('notes')}\n   666→          action={\n   667→            <Button\n   668→              size=\"sm\"\n   669→              variant=\"ghost\"\n   670→              className=\"h-7 w-7 p-0\"\n   671→              onClick={(e) => {\n   672→                e.stopPropagation()\n   673→                onAddNote?.()\n   674→              }}\n   675→            >\n   676→              <Plus className=\"h-3.5 w-3.5\" />\n   677→            </Button>\n   678→          }\n   679→        >\n   680→          <div className=\"space-y-3\">\n   681→            {notesCount === 0 ? (\n   682→              <div className=\"text-center py-6\">\n   683→                <Note className=\"h-8 w-8 mx-auto mb-2 text-[var(--text-tertiary)]/50\" weight=\"duotone\" />\n   684→                <p className=\"text-sm text-[var(--text-tertiary)]\">No notes yet</p>\n   685→                <p className=\"text-xs text-[var(--text-tertiary)] mt-1\">Create notes or save chat responses</p>\n   686→              </div>\n   687→            ) : (\n   688→              <Button\n   689→                variant=\"outline\"\n   690→                className=\"w-full justify-start rounded-lg border-[rgba(255,255,255,0.1)] text-[var(--text-primary)] hover:bg-[var(--bg-tertiary)]\"\n   691→                onClick={onOpenNotes}\n   692→              >\n   693→                <Note className=\"h-4 w-4 mr-2 text-amber-500\" weight=\"duotone\" />\n   694→                View All Notes ({notesCount})\n   695→                <CaretRight className=\"h-4 w-4 ml-auto text-[var(--text-tertiary)]\" weight=\"bold\" />\n   696→              </Button>\n   697→            )}\n   698→          </div>\n   699→        </StudioSection>\n   700→      </div>\n   701→\n   702→      {/* Generation Config Dialog */}\n   703→      <GenerationConfigDialog\n   704→        open={configDialogOpen}\n   705→        onOpenChange={setConfigDialogOpen}\n   706→        type={configDialogType}\n   707→        sources={sources}\n   708→        onGenerate={handleGenerate}\n   709→        isGenerating={isGenerating(configDialogType)}\n   710→      />\n   711→    </ScrollArea>\n   712→  )\n   713→}\n   714→\n   715→// Studio Section Component\n   716→function StudioSection({\n   717→  id,\n   718→  title,\n   719→  subtitle,\n   720→  icon,\n   721→  iconGradient,\n   722→  iconColor,\n   723→  expanded,\n   724→  onToggle,\n   725→  action,\n   726→  children,\n   727→}: {\n   728→  id: string\n   729→  title: string\n   730→  subtitle: string\n   731→  icon: React.ReactNode\n   732→  iconGradient: string\n   733→  iconColor: string\n   734→  expanded: boolean\n   735→  onToggle: () => void\n   736→  action?: React.ReactNode\n   737→  children: React.ReactNode\n   738→}) {\n   739→  return (\n   740→    <div className=\"glass-card rounded-2xl overflow-hidden\">\n   741→      <div className=\"flex items-center justify-between p-4 hover:bg-white/[0.02] transition-all duration-200 group\">\n   742→        <button\n   743→          onClick={onToggle}\n   744→          className=\"flex items-center gap-3 flex-1\"\n   745→        >\n   746→          <div className={`relative w-10 h-10 rounded-xl bg-gradient-to-br ${iconGradient} flex items-center justify-center shadow-lg`}>\n   747→            <div className=\"absolute inset-0 rounded-xl bg-gradient-to-br from-white/10 to-transparent\" />\n   748→            <span className={`relative z-10 ${iconColor}`}>{icon}</span>\n   749→          </div>\n   750→          <div className=\"text-left\">\n   751→            <p className=\"font-medium text-sm text-[var(--text-primary)] group-hover:text-white transition-colors\">{title}</p>\n   752→            <p className=\"text-xs text-[var(--text-tertiary)]\">{subtitle}</p>\n   753→          </div>\n   754→        </button>\n   755→        <div className=\"flex items-center gap-2\">\n   756→          {action}\n   757→          <button onClick={onToggle} className=\"p-1.5 rounded-lg hover:bg-white/5 transition-colors\">\n   758→            <CaretDown weight=\"bold\" className={`h-4 w-4 text-[var(--text-tertiary)] transition-transform duration-200 ${expanded ? 'rotate-180' : ''}`} />\n   759→          </button>\n   760→        </div>\n   761→      </div>\n   762→\n   763→      <AnimatePresence>\n   764→        {expanded && (\n   765→          <motion.div\n   766→            initial={{ height: 0, opacity: 0 }}\n   767→            animate={{ height: 'auto', opacity: 1 }}\n   768→            exit={{ height: 0, opacity: 0 }}\n   769→            transition={{ duration: 0.2 }}\n   770→            className=\"overflow-hidden\"\n   771→          >\n   772→            <div className=\"px-4 pb-4 pt-2 border-t border-[rgba(255,255,255,0.1)] bg-[var(--bg-tertiary)]/30\">\n   773→              {children}\n   774→            </div>\n   775→          </motion.div>\n   776→        )}\n   777→      </AnimatePresence>\n   778→    </div>\n   779→  )\n   780→}\n   781→\n   782→// Study Tool Button\n   783→function StudyToolButton({\n   784→  icon,\n   785→  label,\n   786→  color,\n   787→  onClick,\n   788→  loading,\n   789→  disabled,\n   790→}: {\n   791→  icon: React.ReactNode\n   792→  label: string\n   793→  color: string\n   794→  onClick: () => void\n   795→  loading: boolean\n   796→  disabled: boolean\n   797→}) {\n   798→  return (\n   799→    <button\n   800→      onClick={onClick}\n   801→      disabled={disabled || loading}\n   802→      className=\"flex flex-col items-center gap-2 p-4 rounded-xl border border-[rgba(255,255,255,0.1)] bg-[var(--bg-secondary)] hover:bg-[var(--bg-tertiary)]/50 transition-colors disabled:opacity-50 disabled:cursor-not-allowed\"\n   803→    >\n   804→      {loading ? (\n   805→        <SpinnerGap className=\"h-5 w-5 animate-spin text-[var(--text-tertiary)]\" weight=\"bold\" />\n   806→      ) : (\n   807→        <span className={color}>{icon}</span>\n   808→      )}\n   809→      <span className=\"text-xs font-medium text-[var(--text-primary)]\">{label}</span>\n   810→    </button>\n   811→  )\n   812→}\n   813→\n   814→// Material Button\n   815→function MaterialButton({\n   816→  icon,\n   817→  label,\n   818→  onClick,\n   819→}: {\n   820→  icon: React.ReactNode\n   821→  label: string\n   822→  onClick?: () => void\n   823→}) {\n   824→  return (\n   825→    <button\n   826→      onClick={onClick}\n   827→      className=\"w-full flex items-center gap-2 px-3 py-2 text-sm rounded-lg hover:bg-[var(--bg-tertiary)] transition-colors\"\n   828→    >\n   829→      {icon}\n   830→      <span className=\"text-[var(--text-primary)]\">{label}</span>\n   831→      <CaretRight className=\"h-4 w-4 ml-auto text-[var(--text-tertiary)]\" weight=\"bold\" />\n   832→    </button>\n   833→  )\n   834→}\n   835→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"fe5e20fa-81ea-499d-b63e-51d42534bd47","timestamp":"2026-01-10T17:27:05.427Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend/src/components/studio/studio-panel.tsx","content":"'use client'\n\nimport { useState } from 'react'\nimport { motion, AnimatePresence } from 'framer-motion'\nimport {\n  Microphone,\n  VideoCamera,\n  MagnifyingGlass,\n  GraduationCap,\n  CaretDown,\n  CaretRight,\n  Play,\n  SpinnerGap,\n  BookOpen,\n  ListChecks,\n  FileText,\n  Question,\n  Note,\n  Plus,\n  ShareNetwork,\n  ArrowsClockwise,\n  Clock,\n  WarningCircle,\n  Table,\n  ChartBar,\n  PresentationChart,\n  Image,\n  Palette,\n  Cards,\n  TreeStructure,\n  ChatCircleText,\n  Sparkle\n} from '@phosphor-icons/react'\nimport { Button } from '@/components/ui/button'\nimport { Input } from '@/components/ui/input'\nimport { Textarea } from '@/components/ui/textarea'\nimport { Badge } from '@/components/ui/badge'\nimport { ScrollArea } from '@/components/ui/scroll-area'\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select'\nimport { Tooltip, TooltipContent, TooltipTrigger } from '@/components/ui/tooltip'\nimport { GenerationConfigDialog, GenerationType, GenerationConfig } from './generation-config-dialog'\n\n// Metadata for a generated study material\nexport interface StudyMaterialMeta {\n  id: string\n  type: string\n  sourceIds: string[]\n  sourceNames: string[]\n  createdAt: string\n  itemCount?: number\n}\n\n// Helper to format relative time\nfunction getTimeAgo(dateString: string): string {\n  const date = new Date(dateString)\n  const now = new Date()\n  const diffMs = now.getTime() - date.getTime()\n  const diffMins = Math.floor(diffMs / 60000)\n  const diffHours = Math.floor(diffMs / 3600000)\n  const diffDays = Math.floor(diffMs / 86400000)\n\n  if (diffMins < 1) return 'Just now'\n  if (diffMins < 60) return `${diffMins}m ago`\n  if (diffHours < 24) return `${diffHours}h ago`\n  if (diffDays < 7) return `${diffDays}d ago`\n  return date.toLocaleDateString()\n}\n\n// Source type for selection\nexport interface SourceInfo {\n  id: string\n  name: string\n}\n\ninterface StudioPanelProps {\n  notebookId: string\n  selectedSourcesCount: number\n  selectedSourceIds: string[]\n  sources?: SourceInfo[]\n  // Audio\n  audioFormat: string\n  onAudioFormatChange: (format: string) => void\n  audioInstructions: string\n  onAudioInstructionsChange: (instructions: string) => void\n  onGenerateAudio: () => void\n  generatingAudio: boolean\n  // Video\n  videoStyle: string\n  onVideoStyleChange: (style: string) => void\n  onGenerateVideo: () => void\n  generatingVideo: boolean\n  // Research\n  researchQuery: string\n  onResearchQueryChange: (query: string) => void\n  researchMode: string\n  onResearchModeChange: (mode: string) => void\n  onRunResearch: () => void\n  researching: boolean\n  // Study - now accepts config\n  onGenerateStudyMaterial: (config: GenerationConfig) => void\n  generatingFlashcards: boolean\n  generatingQuiz: boolean\n  generatingStudyGuide: boolean\n  generatingFaq: boolean\n  generatingMindMap: boolean\n  // Creative Outputs - now accepts config\n  onGenerateCreativeOutput?: (config: GenerationConfig) => void\n  generatingDataTable?: boolean\n  generatingReport?: boolean\n  generatingSlideDeck?: boolean\n  generatingInfographic?: boolean\n  // Creative outputs results\n  creativeOutputs?: Array<{\n    id: string\n    type: string\n    title: string\n    status: string\n    createdAt: string\n  }>\n  onOpenCreativeOutput?: (type: string) => void\n  // Results - now with metadata\n  studyMaterials?: StudyMaterialMeta[]\n  onOpenStudyMaterial?: (type: string) => void\n  // Notes\n  notesCount?: number\n  onAddNote?: () => void\n  onOpenNotes?: () => void\n  // Generated content\n  hasGeneratedAudio?: boolean\n  hasGeneratedVideo?: boolean\n  hasGeneratedResearch?: boolean\n  onOpenAudio?: () => void\n  onOpenVideo?: () => void\n  onOpenResearch?: () => void\n}\n\nexport function StudioPanel({\n  notebookId,\n  selectedSourcesCount,\n  selectedSourceIds,\n  sources = [],\n  audioFormat,\n  onAudioFormatChange,\n  audioInstructions,\n  onAudioInstructionsChange,\n  onGenerateAudio,\n  generatingAudio,\n  videoStyle,\n  onVideoStyleChange,\n  onGenerateVideo,\n  generatingVideo,\n  researchQuery,\n  onResearchQueryChange,\n  researchMode,\n  onResearchModeChange,\n  onRunResearch,\n  researching,\n  onGenerateStudyMaterial,\n  generatingFlashcards,\n  generatingQuiz,\n  generatingStudyGuide,\n  generatingFaq,\n  generatingMindMap,\n  onGenerateCreativeOutput,\n  generatingDataTable = false,\n  generatingReport = false,\n  generatingSlideDeck = false,\n  generatingInfographic = false,\n  creativeOutputs = [],\n  onOpenCreativeOutput,\n  studyMaterials = [],\n  onOpenStudyMaterial,\n  notesCount = 0,\n  onAddNote,\n  onOpenNotes,\n  hasGeneratedAudio = false,\n  hasGeneratedVideo = false,\n  hasGeneratedResearch = false,\n  onOpenAudio,\n  onOpenVideo,\n  onOpenResearch,\n}: StudioPanelProps) {\n  const [expandedSection, setExpandedSection] = useState<string | null>('audio')\n  const [configDialogOpen, setConfigDialogOpen] = useState(false)\n  const [configDialogType, setConfigDialogType] = useState<GenerationType>('flashcards')\n\n  // Open config dialog for a specific type\n  const openConfigDialog = (type: GenerationType) => {\n    setConfigDialogType(type)\n    setConfigDialogOpen(true)\n  }\n\n  // Handle generation from config dialog\n  const handleGenerate = (config: GenerationConfig) => {\n    setConfigDialogOpen(false)\n\n    // Route to appropriate handler based on type\n    const studyTypes = ['flashcards', 'quiz', 'study-guide', 'faq', 'mind-map']\n    if (studyTypes.includes(config.type)) {\n      onGenerateStudyMaterial(config)\n    } else {\n      onGenerateCreativeOutput?.(config)\n    }\n  }\n\n  // Check if currently generating for a type\n  const isGenerating = (type: GenerationType): boolean => {\n    switch (type) {\n      case 'flashcards': return generatingFlashcards\n      case 'quiz': return generatingQuiz\n      case 'study-guide': return generatingStudyGuide\n      case 'faq': return generatingFaq\n      case 'mind-map': return generatingMindMap\n      case 'data_table': return generatingDataTable\n      case 'report': return generatingReport\n      case 'slide_deck': return generatingSlideDeck\n      case 'infographic': return generatingInfographic\n      default: return false\n    }\n  }\n\n  const toggleSection = (section: string) => {\n    setExpandedSection(expandedSection === section ? null : section)\n  }\n\n  // Check if a material's sources match current selection\n  const isMaterialStale = (material: StudyMaterialMeta) => {\n    const sortedMaterialIds = [...material.sourceIds].sort()\n    const sortedSelectedIds = [...selectedSourceIds].sort()\n    if (sortedMaterialIds.length !== sortedSelectedIds.length) return true\n    return !sortedMaterialIds.every((id, idx) => id === sortedSelectedIds[idx])\n  }\n\n  // Format relative time\n  const formatTimeAgo = (dateStr: string) => {\n    const date = new Date(dateStr)\n    const now = new Date()\n    const diffMs = now.getTime() - date.getTime()\n    const diffMins = Math.floor(diffMs / 60000)\n    const diffHours = Math.floor(diffMins / 60)\n    const diffDays = Math.floor(diffHours / 24)\n\n    if (diffMins < 1) return 'Just now'\n    if (diffMins < 60) return `${diffMins}m ago`\n    if (diffHours < 24) return `${diffHours}h ago`\n    if (diffDays < 7) return `${diffDays}d ago`\n    return date.toLocaleDateString()\n  }\n\n  // Get material by type\n  const getMaterial = (type: string) => studyMaterials.find(m => m.type === type)\n\n  return (\n    <ScrollArea className=\"h-full\">\n      <div className=\"p-4 space-y-3\">\n        {/* Audio Overview Section */}\n        <StudioSection\n          id=\"audio\"\n          title=\"Audio Overview\"\n          subtitle=\"Podcast-style discussion\"\n          icon={<Microphone className=\"h-5 w-5\" weight=\"duotone\" />}\n          iconGradient=\"from-orange-500/20 to-red-500/20\"\n          iconColor=\"text-orange-500\"\n          expanded={expandedSection === 'audio'}\n          onToggle={() => toggleSection('audio')}\n        >\n          <div className=\"space-y-3\">\n            <div className=\"space-y-1.5\">\n              <label className=\"text-xs font-medium text-[var(--text-primary)]\">Format</label>\n              <Select value={audioFormat} onValueChange={onAudioFormatChange}>\n                <SelectTrigger className=\"h-9 text-sm bg-[var(--bg-tertiary)] border-[rgba(255,255,255,0.1)] rounded-lg\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent className=\"bg-[var(--bg-secondary)] border-[rgba(255,255,255,0.1)]\">\n                  <SelectItem value=\"deep_dive\">Deep Dive (10-15 min)</SelectItem>\n                  <SelectItem value=\"brief\">Brief Summary (2-3 min)</SelectItem>\n                  <SelectItem value=\"critique\">Analytical (5-10 min)</SelectItem>\n                  <SelectItem value=\"debate\">Debate (8-15 min)</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n            <div className=\"space-y-1.5\">\n              <label className=\"text-xs font-medium text-[var(--text-primary)]\">Custom Instructions</label>\n              <Textarea\n                placeholder=\"Optional instructions for hosts...\"\n                value={audioInstructions}\n                onChange={(e) => onAudioInstructionsChange(e.target.value)}\n                rows={2}\n                className=\"text-sm resize-none bg-[var(--bg-tertiary)] border-[rgba(255,255,255,0.1)] text-[var(--text-primary)] placeholder:text-[var(--text-tertiary)] focus:border-[var(--accent-primary)] rounded-lg\"\n              />\n            </div>\n            <div className=\"flex gap-2\">\n              <Button\n                className=\"flex-1 rounded-lg bg-orange-500 hover:bg-orange-500/90 text-white\"\n                onClick={onGenerateAudio}\n                disabled={generatingAudio || selectedSourcesCount === 0}\n              >\n                {generatingAudio ? (\n                  <SpinnerGap className=\"h-4 w-4 mr-2 animate-spin\" weight=\"bold\" />\n                ) : (\n                  <Play className=\"h-4 w-4 mr-2\" />\n                )}\n                Generate\n              </Button>\n              {hasGeneratedAudio && onOpenAudio && (\n                <Button\n                  variant=\"outline\"\n                  className=\"rounded-lg border-orange-500/30 text-orange-500 hover:bg-orange-500/10\"\n                  onClick={onOpenAudio}\n                >\n                  View\n                  <CaretRight className=\"h-4 w-4 ml-1\" weight=\"bold\" />\n                </Button>\n              )}\n            </div>\n            {selectedSourcesCount === 0 && (\n              <p className=\"text-xs text-[var(--text-tertiary)] text-center\">\n                Select sources to generate\n              </p>\n            )}\n          </div>\n        </StudioSection>\n\n        {/* Video Overview Section */}\n        <StudioSection\n          id=\"video\"\n          title=\"Video Overview\"\n          subtitle=\"AI-generated video clip\"\n          icon={<VideoCamera className=\"h-5 w-5\" weight=\"duotone\" />}\n          iconGradient=\"from-purple-500/20 to-pink-500/20\"\n          iconColor=\"text-purple-500\"\n          expanded={expandedSection === 'video'}\n          onToggle={() => toggleSection('video')}\n        >\n          <div className=\"space-y-3\">\n            <div className=\"space-y-1.5\">\n              <label className=\"text-xs font-medium text-[var(--text-primary)]\">Style</label>\n              <Select value={videoStyle} onValueChange={onVideoStyleChange}>\n                <SelectTrigger className=\"h-9 text-sm bg-[var(--bg-tertiary)] border-[rgba(255,255,255,0.1)] rounded-lg\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent className=\"bg-[var(--bg-secondary)] border-[rgba(255,255,255,0.1)]\">\n                  <SelectItem value=\"explainer\">Explainer (5s)</SelectItem>\n                  <SelectItem value=\"documentary\">Documentary (10s)</SelectItem>\n                  <SelectItem value=\"presentation\">Presentation (5s)</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n            <p className=\"text-xs text-[var(--text-tertiary)]\">\n              Generates an AI video clip using Wan 2.5. Estimated cost: ~$0.10-0.20\n            </p>\n            <div className=\"flex gap-2\">\n              <Button\n                className=\"flex-1 rounded-lg bg-purple-500 hover:bg-purple-500/90 text-white\"\n                onClick={onGenerateVideo}\n                disabled={generatingVideo || selectedSourcesCount === 0}\n              >\n                {generatingVideo ? (\n                  <SpinnerGap className=\"h-4 w-4 mr-2 animate-spin\" weight=\"bold\" />\n                ) : (\n                  <VideoCamera className=\"h-4 w-4 mr-2\" weight=\"duotone\" />\n                )}\n                {generatingVideo ? 'Generating...' : 'Generate Video'}\n              </Button>\n              {hasGeneratedVideo && onOpenVideo && (\n                <Button\n                  variant=\"outline\"\n                  className=\"rounded-lg border-purple-500/30 text-purple-500 hover:bg-purple-500/10\"\n                  onClick={onOpenVideo}\n                >\n                  View\n                  <CaretRight className=\"h-4 w-4 ml-1\" weight=\"bold\" />\n                </Button>\n              )}\n            </div>\n            {selectedSourcesCount === 0 && (\n              <p className=\"text-xs text-[var(--text-tertiary)] text-center\">\n                Select sources to generate\n              </p>\n            )}\n          </div>\n        </StudioSection>\n\n        {/* Deep Research Section */}\n        <StudioSection\n          id=\"research\"\n          title=\"Deep Research\"\n          subtitle=\"Autonomous web research\"\n          icon={<MagnifyingGlass className=\"h-5 w-5\" weight=\"duotone\" />}\n          iconGradient=\"from-blue-500/20 to-cyan-500/20\"\n          iconColor=\"text-blue-500\"\n          expanded={expandedSection === 'research'}\n          onToggle={() => toggleSection('research')}\n        >\n          <div className=\"space-y-3\">\n            <div className=\"space-y-1.5\">\n              <label className=\"text-xs font-medium text-[var(--text-primary)]\">Research Query</label>\n              <Input\n                placeholder=\"What would you like to research?\"\n                value={researchQuery}\n                onChange={(e) => onResearchQueryChange(e.target.value)}\n                className=\"h-9 text-sm bg-[var(--bg-tertiary)] border-[rgba(255,255,255,0.1)] text-[var(--text-primary)] placeholder:text-[var(--text-tertiary)] focus:border-[var(--accent-primary)] rounded-lg\"\n              />\n            </div>\n            <div className=\"space-y-1.5\">\n              <label className=\"text-xs font-medium text-[var(--text-primary)]\">Mode</label>\n              <Select value={researchMode} onValueChange={onResearchModeChange}>\n                <SelectTrigger className=\"h-9 text-sm bg-[var(--bg-tertiary)] border-[rgba(255,255,255,0.1)] rounded-lg\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent className=\"bg-[var(--bg-secondary)] border-[rgba(255,255,255,0.1)]\">\n                  <SelectItem value=\"fast\">Fast (3-5 min)</SelectItem>\n                  <SelectItem value=\"deep\">Deep (10-15 min)</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n            <div className=\"flex gap-2\">\n              <Button\n                className=\"flex-1 rounded-lg bg-blue-500 hover:bg-blue-500/90 text-white\"\n                onClick={onRunResearch}\n                disabled={researching || !researchQuery.trim()}\n              >\n                {researching ? (\n                  <SpinnerGap className=\"h-4 w-4 mr-2 animate-spin\" weight=\"bold\" />\n                ) : (\n                  <MagnifyingGlass className=\"h-4 w-4 mr-2\" weight=\"duotone\" />\n                )}\n                Research\n              </Button>\n              {hasGeneratedResearch && onOpenResearch && (\n                <Button\n                  variant=\"outline\"\n                  className=\"rounded-lg border-blue-500/30 text-blue-500 hover:bg-blue-500/10\"\n                  onClick={onOpenResearch}\n                >\n                  View\n                  <CaretRight className=\"h-4 w-4 ml-1\" weight=\"bold\" />\n                </Button>\n              )}\n            </div>\n          </div>\n        </StudioSection>\n\n        {/* Study Materials Section */}\n        <StudioSection\n          id=\"study\"\n          title=\"Study Materials\"\n          subtitle=\"Flashcards, quizzes, and more\"\n          icon={<GraduationCap className=\"h-5 w-5\" />}\n          iconGradient=\"from-emerald-500/20 to-teal-500/20\"\n          iconColor=\"text-emerald-500\"\n          expanded={expandedSection === 'study'}\n          onToggle={() => toggleSection('study')}\n        >\n          <div className=\"space-y-4\">\n            {/* Study Tools Grid */}\n            <div className=\"grid grid-cols-2 gap-2\">\n              <StudyToolButton\n                icon={<BookOpen className=\"h-5 w-5\" />}\n                label=\"Flashcards\"\n                color=\"text-blue-500\"\n                onClick={() => openConfigDialog('flashcards')}\n                loading={generatingFlashcards}\n                disabled={selectedSourcesCount === 0}\n              />\n              <StudyToolButton\n                icon={<ListChecks className=\"h-5 w-5\" />}\n                label=\"Quiz\"\n                color=\"text-purple-500\"\n                onClick={() => openConfigDialog('quiz')}\n                loading={generatingQuiz}\n                disabled={selectedSourcesCount === 0}\n              />\n              <StudyToolButton\n                icon={<FileText className=\"h-5 w-5\" />}\n                label=\"Study Guide\"\n                color=\"text-orange-500\"\n                onClick={() => openConfigDialog('study-guide')}\n                loading={generatingStudyGuide}\n                disabled={selectedSourcesCount === 0}\n              />\n              <StudyToolButton\n                icon={<Question className=\"h-5 w-5\" weight=\"duotone\" />}\n                label=\"FAQ\"\n                color=\"text-teal-500\"\n                onClick={() => openConfigDialog('faq')}\n                loading={generatingFaq}\n                disabled={selectedSourcesCount === 0}\n              />\n              <StudyToolButton\n                icon={<TreeStructure className=\"h-5 w-5\" weight=\"duotone\" />}\n                label=\"Mind Map\"\n                color=\"text-cyan-500\"\n                onClick={() => openConfigDialog('mind-map')}\n                loading={generatingMindMap}\n                disabled={selectedSourcesCount === 0}\n              />\n            </div>\n\n            {selectedSourcesCount === 0 && (\n              <p className=\"text-xs text-[var(--text-tertiary)] text-center\">\n                Select sources to generate study materials\n              </p>\n            )}\n\n            {/* Generated Materials */}\n            {studyMaterials.length > 0 && (\n              <div className=\"pt-3 border-t border-[rgba(255,255,255,0.1)]\">\n                <p className=\"text-xs font-medium text-[var(--text-tertiary)] mb-2\">Generated Materials</p>\n                <div className=\"space-y-2\">\n                  {studyMaterials.map((material) => {\n                    const isStale = isMaterialStale(material)\n                    const iconMap: Record<string, { icon: React.ReactNode; color: string; label: string }> = {\n                      flashcards: { icon: <BookOpen className=\"h-4 w-4\" />, color: 'text-blue-500', label: `${material.itemCount || 0} Flashcards` },\n                      quiz: { icon: <ListChecks className=\"h-4 w-4\" />, color: 'text-purple-500', label: `${material.itemCount || 0} Quiz Questions` },\n                      study_guide: { icon: <FileText className=\"h-4 w-4\" />, color: 'text-orange-500', label: 'Study Guide' },\n                      faq: { icon: <ChatCircleText className=\"h-4 w-4\" weight=\"duotone\" />, color: 'text-teal-500', label: `${material.itemCount || 0} FAQ Items` },\n                      mind_map: { icon: <TreeStructure className=\"h-4 w-4\" weight=\"duotone\" />, color: 'text-cyan-500', label: 'Mind Map' },\n                    }\n                    const info = iconMap[material.type] || { icon: <FileText className=\"h-4 w-4\" />, color: 'text-gray-500', label: material.type }\n\n                    return (\n                      <div\n                        key={material.id}\n                        className={`rounded-lg border ${isStale ? 'border-amber-500/30 bg-amber-500/5' : 'border-[rgba(255,255,255,0.1)]'} overflow-hidden`}\n                      >\n                        <button\n                          onClick={() => onOpenStudyMaterial?.(material.type)}\n                          className=\"w-full flex items-center gap-2 px-3 py-2 text-sm hover:bg-[var(--bg-tertiary)] transition-colors\"\n                        >\n                          <span className={info.color}>{info.icon}</span>\n                          <span className=\"text-[var(--text-primary)] flex-1 text-left\">{info.label}</span>\n                          {isStale && (\n                            <Tooltip>\n                              <TooltipTrigger asChild>\n                                <WarningCircle className=\"h-3.5 w-3.5 text-amber-500\" weight=\"fill\" />\n                              </TooltipTrigger>\n                              <TooltipContent>\n                                <p>Sources changed - regenerate for updated content</p>\n                              </TooltipContent>\n                            </Tooltip>\n                          )}\n                          <CaretRight className=\"h-4 w-4 text-[var(--text-tertiary)]\" weight=\"bold\" />\n                        </button>\n                        <div className=\"px-3 py-1.5 bg-[var(--bg-tertiary)]/50 border-t border-[rgba(255,255,255,0.05)] flex items-center gap-3 text-[10px] text-[var(--text-tertiary)]\">\n                          <span className=\"flex items-center gap-1\">\n                            <Clock className=\"h-3 w-3\" />\n                            {formatTimeAgo(material.createdAt)}\n                          </span>\n                          <span>•</span>\n                          <span className=\"truncate\">\n                            {material.sourceNames.length === 1\n                              ? material.sourceNames[0]\n                              : `${material.sourceNames.length} sources`}\n                          </span>\n                        </div>\n                      </div>\n                    )\n                  })}\n                </div>\n              </div>\n            )}\n          </div>\n        </StudioSection>\n\n        {/* Creative Outputs Section */}\n        <StudioSection\n          id=\"creative\"\n          title=\"Creative Outputs\"\n          subtitle=\"Tables, reports, slides, infographics\"\n          icon={<Palette className=\"h-5 w-5\" />}\n          iconGradient=\"from-pink-500/20 to-rose-500/20\"\n          iconColor=\"text-pink-500\"\n          expanded={expandedSection === 'creative'}\n          onToggle={() => toggleSection('creative')}\n        >\n          <div className=\"space-y-4\">\n            {/* Creative Tools Grid */}\n            <div className=\"grid grid-cols-2 gap-2\">\n              <StudyToolButton\n                icon={<Table className=\"h-5 w-5\" />}\n                label=\"Data Table\"\n                color=\"text-emerald-500\"\n                onClick={() => openConfigDialog('data_table')}\n                loading={generatingDataTable}\n                disabled={selectedSourcesCount === 0}\n              />\n              <StudyToolButton\n                icon={<Palette className=\"h-5 w-5\" weight=\"duotone\" />}\n                label=\"Report\"\n                color=\"text-blue-500\"\n                onClick={() => openConfigDialog('report')}\n                loading={generatingReport}\n                disabled={selectedSourcesCount === 0}\n              />\n              <StudyToolButton\n                icon={<PresentationChart className=\"h-5 w-5\" />}\n                label=\"Slide Deck\"\n                color=\"text-violet-500\"\n                onClick={() => openConfigDialog('slide_deck')}\n                loading={generatingSlideDeck}\n                disabled={selectedSourcesCount === 0}\n              />\n              <StudyToolButton\n                icon={<Image className=\"h-5 w-5\" />}\n                label=\"Infographic\"\n                color=\"text-rose-500\"\n                onClick={() => openConfigDialog('infographic')}\n                loading={generatingInfographic}\n                disabled={selectedSourcesCount === 0}\n              />\n            </div>\n\n            {selectedSourcesCount === 0 && (\n              <p className=\"text-xs text-[var(--text-tertiary)] text-center\">\n                Select sources to generate creative outputs\n              </p>\n            )}\n\n            {/* Generated Outputs */}\n            {creativeOutputs.length > 0 && (\n              <div className=\"mt-4 pt-4 border-t border-[rgba(255,255,255,0.1)]\">\n                <p className=\"text-xs font-medium text-[var(--text-tertiary)] mb-3\">Generated Outputs</p>\n                <div className=\"space-y-2\">\n                  {creativeOutputs.map((output) => {\n                    const typeConfig: Record<string, { icon: React.ReactNode; label: string; color: string }> = {\n                      data_table: { icon: <Table className=\"h-4 w-4\" />, label: 'Data Table', color: 'text-emerald-500' },\n                      report: { icon: <ChartBar className=\"h-4 w-4\" weight=\"duotone\" />, label: 'Report', color: 'text-blue-500' },\n                      slide_deck: { icon: <PresentationChart className=\"h-4 w-4\" />, label: 'Slide Deck', color: 'text-violet-500' },\n                      infographic: { icon: <Image className=\"h-4 w-4\" />, label: 'Infographic', color: 'text-rose-500' },\n                    }\n                    const config = typeConfig[output.type] || { icon: <FileText className=\"h-4 w-4\" />, label: output.type, color: 'text-gray-500' }\n                    const timeAgo = getTimeAgo(output.createdAt)\n\n                    return (\n                      <button\n                        key={output.id}\n                        onClick={() => onOpenCreativeOutput?.(output.type)}\n                        className=\"w-full flex items-center gap-3 p-3 rounded-xl bg-[var(--bg-tertiary)] hover:bg-[var(--bg-tertiary)]/80 transition-colors text-left\"\n                      >\n                        <div className={`${config.color}`}>{config.icon}</div>\n                        <div className=\"flex-1 min-w-0\">\n                          <p className=\"text-sm font-medium text-[var(--text-primary)] truncate\">{config.label}</p>\n                          <p className=\"text-xs text-[var(--text-tertiary)]\">{timeAgo}</p>\n                        </div>\n                        <CaretRight className=\"h-4 w-4 text-[var(--text-tertiary)]\" weight=\"bold\" />\n                      </button>\n                    )\n                  })}\n                </div>\n              </div>\n            )}\n          </div>\n        </StudioSection>\n\n        {/* Notes Section */}\n        <StudioSection\n          id=\"notes\"\n          title=\"Notes\"\n          subtitle={`${notesCount} saved`}\n          icon={<Note className=\"h-5 w-5\" weight=\"duotone\" />}\n          iconGradient=\"from-amber-500/20 to-yellow-500/20\"\n          iconColor=\"text-amber-500\"\n          expanded={expandedSection === 'notes'}\n          onToggle={() => toggleSection('notes')}\n          action={\n            <Button\n              size=\"sm\"\n              variant=\"ghost\"\n              className=\"h-7 w-7 p-0\"\n              onClick={(e) => {\n                e.stopPropagation()\n                onAddNote?.()\n              }}\n            >\n              <Plus className=\"h-3.5 w-3.5\" />\n            </Button>\n          }\n        >\n          <div className=\"space-y-3\">\n            {notesCount === 0 ? (\n              <div className=\"text-center py-6\">\n                <Note className=\"h-8 w-8 mx-auto mb-2 text-[var(--text-tertiary)]/50\" weight=\"duotone\" />\n                <p className=\"text-sm text-[var(--text-tertiary)]\">No notes yet</p>\n                <p className=\"text-xs text-[var(--text-tertiary)] mt-1\">Create notes or save chat responses</p>\n              </div>\n            ) : (\n              <Button\n                variant=\"outline\"\n                className=\"w-full justify-start rounded-lg border-[rgba(255,255,255,0.1)] text-[var(--text-primary)] hover:bg-[var(--bg-tertiary)]\"\n                onClick={onOpenNotes}\n              >\n                <Note className=\"h-4 w-4 mr-2 text-amber-500\" weight=\"duotone\" />\n                View All Notes ({notesCount})\n                <CaretRight className=\"h-4 w-4 ml-auto text-[var(--text-tertiary)]\" weight=\"bold\" />\n              </Button>\n            )}\n          </div>\n        </StudioSection>\n      </div>\n\n      {/* Generation Config Dialog */}\n      <GenerationConfigDialog\n        open={configDialogOpen}\n        onOpenChange={setConfigDialogOpen}\n        type={configDialogType}\n        sources={sources}\n        onGenerate={handleGenerate}\n        isGenerating={isGenerating(configDialogType)}\n      />\n    </ScrollArea>\n  )\n}\n\n// Studio Section Component\nfunction StudioSection({\n  id,\n  title,\n  subtitle,\n  icon,\n  iconGradient,\n  iconColor,\n  expanded,\n  onToggle,\n  action,\n  children,\n}: {\n  id: string\n  title: string\n  subtitle: string\n  icon: React.ReactNode\n  iconGradient: string\n  iconColor: string\n  expanded: boolean\n  onToggle: () => void\n  action?: React.ReactNode\n  children: React.ReactNode\n}) {\n  return (\n    <div className=\"glass-card rounded-2xl overflow-hidden\">\n      <div className=\"flex items-center justify-between p-4 hover:bg-white/[0.02] transition-all duration-200 group\">\n        <button\n          onClick={onToggle}\n          className=\"flex items-center gap-3 flex-1\"\n        >\n          <div className={`relative w-10 h-10 rounded-xl bg-gradient-to-br ${iconGradient} flex items-center justify-center shadow-lg`}>\n            <div className=\"absolute inset-0 rounded-xl bg-gradient-to-br from-white/10 to-transparent\" />\n            <span className={`relative z-10 ${iconColor}`}>{icon}</span>\n          </div>\n          <div className=\"text-left\">\n            <p className=\"font-medium text-sm text-[var(--text-primary)] group-hover:text-white transition-colors\">{title}</p>\n            <p className=\"text-xs text-[var(--text-tertiary)]\">{subtitle}</p>\n          </div>\n        </button>\n        <div className=\"flex items-center gap-2\">\n          {action}\n          <button onClick={onToggle} className=\"p-1.5 rounded-lg hover:bg-white/5 transition-colors\">\n            <CaretDown weight=\"bold\" className={`h-4 w-4 text-[var(--text-tertiary)] transition-transform duration-200 ${expanded ? 'rotate-180' : ''}`} />\n          </button>\n        </div>\n      </div>\n\n      <AnimatePresence>\n        {expanded && (\n          <motion.div\n            initial={{ height: 0, opacity: 0 }}\n            animate={{ height: 'auto', opacity: 1 }}\n            exit={{ height: 0, opacity: 0 }}\n            transition={{ duration: 0.2 }}\n            className=\"overflow-hidden\"\n          >\n            <div className=\"px-4 pb-4 pt-2 border-t border-[rgba(255,255,255,0.1)] bg-[var(--bg-tertiary)]/30\">\n              {children}\n            </div>\n          </motion.div>\n        )}\n      </AnimatePresence>\n    </div>\n  )\n}\n\n// Study Tool Button\nfunction StudyToolButton({\n  icon,\n  label,\n  color,\n  onClick,\n  loading,\n  disabled,\n}: {\n  icon: React.ReactNode\n  label: string\n  color: string\n  onClick: () => void\n  loading: boolean\n  disabled: boolean\n}) {\n  return (\n    <button\n      onClick={onClick}\n      disabled={disabled || loading}\n      className=\"flex flex-col items-center gap-2 p-4 rounded-xl border border-[rgba(255,255,255,0.1)] bg-[var(--bg-secondary)] hover:bg-[var(--bg-tertiary)]/50 transition-colors disabled:opacity-50 disabled:cursor-not-allowed\"\n    >\n      {loading ? (\n        <SpinnerGap className=\"h-5 w-5 animate-spin text-[var(--text-tertiary)]\" weight=\"bold\" />\n      ) : (\n        <span className={color}>{icon}</span>\n      )}\n      <span className=\"text-xs font-medium text-[var(--text-primary)]\">{label}</span>\n    </button>\n  )\n}\n\n// Material Button\nfunction MaterialButton({\n  icon,\n  label,\n  onClick,\n}: {\n  icon: React.ReactNode\n  label: string\n  onClick?: () => void\n}) {\n  return (\n    <button\n      onClick={onClick}\n      className=\"w-full flex items-center gap-2 px-3 py-2 text-sm rounded-lg hover:bg-[var(--bg-tertiary)] transition-colors\"\n    >\n      {icon}\n      <span className=\"text-[var(--text-primary)]\">{label}</span>\n      <CaretRight className=\"h-4 w-4 ml-auto text-[var(--text-tertiary)]\" weight=\"bold\" />\n    </button>\n  )\n}\n","numLines":835,"startLine":1,"totalLines":835}},"sourceToolAssistantUUID":"b3e99e6a-9ef9-497b-aa52-a4c32d61926e"}
{"parentUuid":"fe5e20fa-81ea-499d-b63e-51d42534bd47","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","message":{"model":"claude-opus-4-5-20251101","id":"msg_01TdKYvi6eS1B8x1tPPpwZYq","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Now I have a good understanding of the codebase. Let me also read one existing router to understand the pattern used for authentication and database queries.","signature":"EsYCCkYICxgCKkB3jnMZ3HRu/xKsaE5Khc12X93JhKKrCOXEArsae08irF5uq5M/lm372LWOqKskR4in7eOGgGsgvqVVFKtAZEohEgzhZg+sLW43hLHFeFYaDK29Uv1D+NMrqoPDuiIwp8JdBIXdpLyPRudJxQpj40pwoqk87+T9n09pTmobpWbiZjZKTzCriwaeGtbdkDIyKq0BDv1hXrdaOxUyweutufi1czCmSnWxSZbnvIyh4OG0bndRE+m5YBpAGNeVM7fu3e6QrrTt8dp6Q7bXTIr0ebLgvoK9xj9Cb99zm9S8opysD957T5XjeLipO1GRcuUdQb+SvV16xyJW5ZEgHkj0fhVfWRwDM4LDTmBYgqBT3rDS06AttH/Rth65rzLsaiBGiOkXNqCU5gW1gpZhAtmEJ26Wx+8mz+qe3NDAl5mAfkUYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":21203,"cache_read_input_tokens":39323,"cache_creation":{"ephemeral_5m_input_tokens":21203,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWz6BZWpWMKZfugHv3y3z","type":"assistant","uuid":"f400ba83-ba74-4d3f-8dee-f4b5ff02803d","timestamp":"2026-01-10T17:27:09.839Z"}
{"parentUuid":"f400ba83-ba74-4d3f-8dee-f4b5ff02803d","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","message":{"model":"claude-opus-4-5-20251101","id":"msg_01TdKYvi6eS1B8x1tPPpwZYq","type":"message","role":"assistant","content":[{"type":"text","text":"Let me also check an existing router to understand the auth pattern."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":21203,"cache_read_input_tokens":39323,"cache_creation":{"ephemeral_5m_input_tokens":21203,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWz6BZWpWMKZfugHv3y3z","type":"assistant","uuid":"aa14784b-50c3-4fe0-b56d-6db0cbf8a3b3","timestamp":"2026-01-10T17:27:10.164Z"}
{"parentUuid":"aa14784b-50c3-4fe0-b56d-6db0cbf8a3b3","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","message":{"model":"claude-opus-4-5-20251101","id":"msg_01TdKYvi6eS1B8x1tPPpwZYq","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01147PCCmjfvBQZtjpTSU4TP","name":"Read","input":{"file_path":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/backend/app/routers/notebooks.py"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":21203,"cache_read_input_tokens":39323,"cache_creation":{"ephemeral_5m_input_tokens":21203,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWz6BZWpWMKZfugHv3y3z","type":"assistant","uuid":"0d4506e1-957b-45e2-a306-5416fef970b2","timestamp":"2026-01-10T17:27:11.648Z"}
{"parentUuid":"0d4506e1-957b-45e2-a306-5416fef970b2","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","message":{"model":"claude-opus-4-5-20251101","id":"msg_01TdKYvi6eS1B8x1tPPpwZYq","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01FvhPBgNBkRNFPT6rXQk75c","name":"Read","input":{"file_path":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/backend/app/services/auth.py"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":21203,"cache_read_input_tokens":39323,"cache_creation":{"ephemeral_5m_input_tokens":21203,"ephemeral_1h_input_tokens":0},"output_tokens":206,"service_tier":"standard"}},"requestId":"req_011CWz6BZWpWMKZfugHv3y3z","type":"assistant","uuid":"ee4a83b4-1833-4f03-a645-96d1d99d4f6f","timestamp":"2026-01-10T17:27:12.164Z"}
{"parentUuid":"0d4506e1-957b-45e2-a306-5416fef970b2","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01147PCCmjfvBQZtjpTSU4TP","type":"tool_result","content":"     1→from fastapi import APIRouter, HTTPException, Depends\n     2→from typing import List\n     3→from uuid import UUID\n     4→\n     5→from app.models.schemas import (\n     6→    NotebookCreate,\n     7→    NotebookUpdate,\n     8→    NotebookResponse,\n     9→    ApiResponse,\n    10→)\n    11→from app.services.auth import get_current_user\n    12→from app.services.supabase_client import get_supabase_client\n    13→\n    14→router = APIRouter(prefix=\"/notebooks\", tags=[\"notebooks\"])\n    15→\n    16→\n    17→@router.post(\"\", response_model=ApiResponse)\n    18→async def create_notebook(\n    19→    notebook: NotebookCreate,\n    20→    user: dict = Depends(get_current_user),\n    21→):\n    22→    \"\"\"Create a new notebook.\"\"\"\n    23→    supabase = get_supabase_client()\n    24→\n    25→    # Create notebook record\n    26→    data = {\n    27→        \"user_id\": user[\"id\"],\n    28→        \"name\": notebook.name,\n    29→        \"description\": notebook.description,\n    30→        \"emoji\": notebook.emoji,\n    31→        \"settings\": {},\n    32→    }\n    33→\n    34→    result = supabase.table(\"notebooks\").insert(data).execute()\n    35→\n    36→    if not result.data:\n    37→        raise HTTPException(status_code=400, detail=\"Failed to create notebook\")\n    38→\n    39→    return ApiResponse(data=result.data[0])\n    40→\n    41→\n    42→@router.get(\"\", response_model=ApiResponse)\n    43→async def list_notebooks(\n    44→    user: dict = Depends(get_current_user),\n    45→):\n    46→    \"\"\"List all notebooks for the current user.\"\"\"\n    47→    supabase = get_supabase_client()\n    48→\n    49→    result = (\n    50→        supabase.table(\"notebooks\")\n    51→        .select(\"*\")\n    52→        .eq(\"user_id\", user[\"id\"])\n    53→        .order(\"created_at\", desc=True)\n    54→        .execute()\n    55→    )\n    56→\n    57→    return ApiResponse(data=result.data)\n    58→\n    59→\n    60→@router.get(\"/{notebook_id}\", response_model=ApiResponse)\n    61→async def get_notebook(\n    62→    notebook_id: UUID,\n    63→    user: dict = Depends(get_current_user),\n    64→):\n    65→    \"\"\"Get a specific notebook.\"\"\"\n    66→    supabase = get_supabase_client()\n    67→\n    68→    result = (\n    69→        supabase.table(\"notebooks\")\n    70→        .select(\"*\")\n    71→        .eq(\"id\", str(notebook_id))\n    72→        .eq(\"user_id\", user[\"id\"])\n    73→        .single()\n    74→        .execute()\n    75→    )\n    76→\n    77→    if not result.data:\n    78→        raise HTTPException(status_code=404, detail=\"Notebook not found\")\n    79→\n    80→    return ApiResponse(data=result.data)\n    81→\n    82→\n    83→@router.patch(\"/{notebook_id}\", response_model=ApiResponse)\n    84→async def update_notebook(\n    85→    notebook_id: UUID,\n    86→    notebook: NotebookUpdate,\n    87→    user: dict = Depends(get_current_user),\n    88→):\n    89→    \"\"\"Update a notebook.\"\"\"\n    90→    supabase = get_supabase_client()\n    91→\n    92→    # Build update data (only include non-None fields)\n    93→    update_data = {}\n    94→    if notebook.name is not None:\n    95→        update_data[\"name\"] = notebook.name\n    96→    if notebook.description is not None:\n    97→        update_data[\"description\"] = notebook.description\n    98→    if notebook.emoji is not None:\n    99→        update_data[\"emoji\"] = notebook.emoji\n   100→    if notebook.settings is not None:\n   101→        update_data[\"settings\"] = notebook.settings\n   102→\n   103→    if not update_data:\n   104→        raise HTTPException(status_code=400, detail=\"No fields to update\")\n   105→\n   106→    result = (\n   107→        supabase.table(\"notebooks\")\n   108→        .update(update_data)\n   109→        .eq(\"id\", str(notebook_id))\n   110→        .eq(\"user_id\", user[\"id\"])\n   111→        .execute()\n   112→    )\n   113→\n   114→    if not result.data:\n   115→        raise HTTPException(status_code=404, detail=\"Notebook not found\")\n   116→\n   117→    return ApiResponse(data=result.data[0])\n   118→\n   119→\n   120→@router.delete(\"/{notebook_id}\", response_model=ApiResponse)\n   121→async def delete_notebook(\n   122→    notebook_id: UUID,\n   123→    user: dict = Depends(get_current_user),\n   124→):\n   125→    \"\"\"Delete a notebook and all its contents.\"\"\"\n   126→    supabase = get_supabase_client()\n   127→\n   128→    # Delete notebook (cascades to sources, sessions, etc.)\n   129→    result = (\n   130→        supabase.table(\"notebooks\")\n   131→        .delete()\n   132→        .eq(\"id\", str(notebook_id))\n   133→        .eq(\"user_id\", user[\"id\"])\n   134→        .execute()\n   135→    )\n   136→\n   137→    if not result.data:\n   138→        raise HTTPException(status_code=404, detail=\"Notebook not found\")\n   139→\n   140→    return ApiResponse(data={\"deleted\": True, \"id\": str(notebook_id)})\n   141→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"3c59d459-7ba5-460b-8543-d8c9630c0dfc","timestamp":"2026-01-10T17:27:12.198Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/backend/app/routers/notebooks.py","content":"from fastapi import APIRouter, HTTPException, Depends\nfrom typing import List\nfrom uuid import UUID\n\nfrom app.models.schemas import (\n    NotebookCreate,\n    NotebookUpdate,\n    NotebookResponse,\n    ApiResponse,\n)\nfrom app.services.auth import get_current_user\nfrom app.services.supabase_client import get_supabase_client\n\nrouter = APIRouter(prefix=\"/notebooks\", tags=[\"notebooks\"])\n\n\n@router.post(\"\", response_model=ApiResponse)\nasync def create_notebook(\n    notebook: NotebookCreate,\n    user: dict = Depends(get_current_user),\n):\n    \"\"\"Create a new notebook.\"\"\"\n    supabase = get_supabase_client()\n\n    # Create notebook record\n    data = {\n        \"user_id\": user[\"id\"],\n        \"name\": notebook.name,\n        \"description\": notebook.description,\n        \"emoji\": notebook.emoji,\n        \"settings\": {},\n    }\n\n    result = supabase.table(\"notebooks\").insert(data).execute()\n\n    if not result.data:\n        raise HTTPException(status_code=400, detail=\"Failed to create notebook\")\n\n    return ApiResponse(data=result.data[0])\n\n\n@router.get(\"\", response_model=ApiResponse)\nasync def list_notebooks(\n    user: dict = Depends(get_current_user),\n):\n    \"\"\"List all notebooks for the current user.\"\"\"\n    supabase = get_supabase_client()\n\n    result = (\n        supabase.table(\"notebooks\")\n        .select(\"*\")\n        .eq(\"user_id\", user[\"id\"])\n        .order(\"created_at\", desc=True)\n        .execute()\n    )\n\n    return ApiResponse(data=result.data)\n\n\n@router.get(\"/{notebook_id}\", response_model=ApiResponse)\nasync def get_notebook(\n    notebook_id: UUID,\n    user: dict = Depends(get_current_user),\n):\n    \"\"\"Get a specific notebook.\"\"\"\n    supabase = get_supabase_client()\n\n    result = (\n        supabase.table(\"notebooks\")\n        .select(\"*\")\n        .eq(\"id\", str(notebook_id))\n        .eq(\"user_id\", user[\"id\"])\n        .single()\n        .execute()\n    )\n\n    if not result.data:\n        raise HTTPException(status_code=404, detail=\"Notebook not found\")\n\n    return ApiResponse(data=result.data)\n\n\n@router.patch(\"/{notebook_id}\", response_model=ApiResponse)\nasync def update_notebook(\n    notebook_id: UUID,\n    notebook: NotebookUpdate,\n    user: dict = Depends(get_current_user),\n):\n    \"\"\"Update a notebook.\"\"\"\n    supabase = get_supabase_client()\n\n    # Build update data (only include non-None fields)\n    update_data = {}\n    if notebook.name is not None:\n        update_data[\"name\"] = notebook.name\n    if notebook.description is not None:\n        update_data[\"description\"] = notebook.description\n    if notebook.emoji is not None:\n        update_data[\"emoji\"] = notebook.emoji\n    if notebook.settings is not None:\n        update_data[\"settings\"] = notebook.settings\n\n    if not update_data:\n        raise HTTPException(status_code=400, detail=\"No fields to update\")\n\n    result = (\n        supabase.table(\"notebooks\")\n        .update(update_data)\n        .eq(\"id\", str(notebook_id))\n        .eq(\"user_id\", user[\"id\"])\n        .execute()\n    )\n\n    if not result.data:\n        raise HTTPException(status_code=404, detail=\"Notebook not found\")\n\n    return ApiResponse(data=result.data[0])\n\n\n@router.delete(\"/{notebook_id}\", response_model=ApiResponse)\nasync def delete_notebook(\n    notebook_id: UUID,\n    user: dict = Depends(get_current_user),\n):\n    \"\"\"Delete a notebook and all its contents.\"\"\"\n    supabase = get_supabase_client()\n\n    # Delete notebook (cascades to sources, sessions, etc.)\n    result = (\n        supabase.table(\"notebooks\")\n        .delete()\n        .eq(\"id\", str(notebook_id))\n        .eq(\"user_id\", user[\"id\"])\n        .execute()\n    )\n\n    if not result.data:\n        raise HTTPException(status_code=404, detail=\"Notebook not found\")\n\n    return ApiResponse(data={\"deleted\": True, \"id\": str(notebook_id)})\n","numLines":141,"startLine":1,"totalLines":141}},"sourceToolAssistantUUID":"0d4506e1-957b-45e2-a306-5416fef970b2"}
{"parentUuid":"ee4a83b4-1833-4f03-a645-96d1d99d4f6f","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01FvhPBgNBkRNFPT6rXQk75c","type":"tool_result","content":"     1→from fastapi import HTTPException, Depends, Header, Request\n     2→from fastapi.security import HTTPBearer, HTTPAuthorizationCredentials, APIKeyHeader\n     3→from typing import Optional, Tuple\n     4→from jose import jwt, JWTError\n     5→import hashlib\n     6→import secrets\n     7→from datetime import datetime, timezone\n     8→from collections import defaultdict\n     9→import time\n    10→\n    11→from app.config import get_settings\n    12→from app.services.supabase_client import get_supabase_client\n    13→\n    14→settings = get_settings()\n    15→security = HTTPBearer(auto_error=False)\n    16→api_key_header = APIKeyHeader(name=\"X-API-Key\", auto_error=False)\n    17→\n    18→# Simple in-memory rate limiter (for production, use Redis)\n    19→rate_limit_store: dict = defaultdict(lambda: {\"minute\": {}, \"day\": {}})\n    20→\n    21→\n    22→def generate_api_key() -> Tuple[str, str, str]:\n    23→    \"\"\"Generate a new API key.\n    24→\n    25→    Returns:\n    26→        Tuple of (full_key, key_prefix, key_hash)\n    27→    \"\"\"\n    28→    # Generate 32 random bytes = 64 hex characters\n    29→    random_part = secrets.token_hex(32)\n    30→    full_key = f\"nb_live_{random_part}\"\n    31→    key_prefix = f\"nb_live_{random_part[:8]}...\"\n    32→    key_hash = hashlib.sha256(full_key.encode()).hexdigest()\n    33→\n    34→    return full_key, key_prefix, key_hash\n    35→\n    36→\n    37→def hash_api_key(key: str) -> str:\n    38→    \"\"\"Hash an API key for comparison.\"\"\"\n    39→    return hashlib.sha256(key.encode()).hexdigest()\n    40→\n    41→\n    42→def check_rate_limit(api_key_id: str, rpm_limit: int, rpd_limit: int) -> bool:\n    43→    \"\"\"Check if the API key is within rate limits.\n    44→\n    45→    Returns True if allowed, raises HTTPException if rate limited.\n    46→    \"\"\"\n    47→    now = time.time()\n    48→    minute_key = int(now // 60)\n    49→    day_key = int(now // 86400)\n    50→\n    51→    store = rate_limit_store[api_key_id]\n    52→\n    53→    # Clean old entries\n    54→    store[\"minute\"] = {k: v for k, v in store[\"minute\"].items() if k >= minute_key - 1}\n    55→    store[\"day\"] = {k: v for k, v in store[\"day\"].items() if k >= day_key - 1}\n    56→\n    57→    # Check minute limit\n    58→    minute_count = store[\"minute\"].get(minute_key, 0)\n    59→    if minute_count >= rpm_limit:\n    60→        raise HTTPException(\n    61→            status_code=429,\n    62→            detail=f\"Rate limit exceeded: {rpm_limit} requests per minute\",\n    63→            headers={\"Retry-After\": str(60 - int(now % 60))}\n    64→        )\n    65→\n    66→    # Check day limit\n    67→    day_count = store[\"day\"].get(day_key, 0)\n    68→    if day_count >= rpd_limit:\n    69→        raise HTTPException(\n    70→            status_code=429,\n    71→            detail=f\"Rate limit exceeded: {rpd_limit} requests per day\",\n    72→            headers={\"Retry-After\": str(86400 - int(now % 86400))}\n    73→        )\n    74→\n    75→    # Increment counters\n    76→    store[\"minute\"][minute_key] = minute_count + 1\n    77→    store[\"day\"][day_key] = day_count + 1\n    78→\n    79→    return True\n    80→\n    81→\n    82→async def validate_api_key(api_key: str, request: Request) -> Optional[dict]:\n    83→    \"\"\"Validate an API key and return user info if valid.\"\"\"\n    84→    if not api_key or not api_key.startswith(\"nb_live_\"):\n    85→        return None\n    86→\n    87→    supabase = get_supabase_client()\n    88→    key_hash = hash_api_key(api_key)\n    89→\n    90→    # Look up API key by hash\n    91→    result = supabase.table(\"api_keys\").select(\"*\").eq(\"key_hash\", key_hash).execute()\n    92→\n    93→    if not result.data or len(result.data) == 0:\n    94→        return None\n    95→\n    96→    api_key_record = result.data[0]\n    97→\n    98→    # Check if active\n    99→    if not api_key_record[\"is_active\"]:\n   100→        raise HTTPException(status_code=401, detail=\"API key is disabled\")\n   101→\n   102→    # Check expiration\n   103→    if api_key_record[\"expires_at\"]:\n   104→        expires_str = api_key_record[\"expires_at\"]\n   105→        if isinstance(expires_str, str):\n   106→            expires = datetime.fromisoformat(expires_str.replace(\"Z\", \"+00:00\"))\n   107→        else:\n   108→            expires = expires_str\n   109→        if expires < datetime.now(timezone.utc):\n   110→            raise HTTPException(status_code=401, detail=\"API key has expired\")\n   111→\n   112→    # Check IP allowlist\n   113→    if api_key_record[\"allowed_ips\"]:\n   114→        client_ip = request.client.host if request.client else None\n   115→        if client_ip and client_ip not in api_key_record[\"allowed_ips\"]:\n   116→            raise HTTPException(status_code=403, detail=\"IP address not allowed\")\n   117→\n   118→    # Check rate limits\n   119→    check_rate_limit(\n   120→        api_key_record[\"id\"],\n   121→        api_key_record[\"rate_limit_rpm\"],\n   122→        api_key_record[\"rate_limit_rpd\"]\n   123→    )\n   124→\n   125→    # Update last used and increment request count\n   126→    supabase.table(\"api_keys\").update({\n   127→        \"last_used_at\": datetime.now(timezone.utc).isoformat(),\n   128→        \"total_requests\": api_key_record[\"total_requests\"] + 1\n   129→    }).eq(\"id\", api_key_record[\"id\"]).execute()\n   130→\n   131→    # Store api_key_id in request state for usage logging\n   132→    request.state.api_key_id = api_key_record[\"id\"]\n   133→\n   134→    return {\n   135→        \"id\": api_key_record[\"user_id\"],\n   136→        \"email\": None,  # API keys don't have email context\n   137→        \"token\": None,\n   138→        \"api_key_id\": api_key_record[\"id\"],\n   139→        \"api_key_scopes\": api_key_record[\"scopes\"],\n   140→        \"auth_method\": \"api_key\"\n   141→    }\n   142→\n   143→\n   144→async def validate_jwt(token: str) -> Optional[dict]:\n   145→    \"\"\"Validate a JWT token and return user info.\"\"\"\n   146→    try:\n   147→        payload = jwt.decode(\n   148→            token,\n   149→            key=\"\",  # Key not needed when verify_signature is False\n   150→            options={\n   151→                \"verify_signature\": False,\n   152→                \"verify_aud\": False,\n   153→            },\n   154→            algorithms=[\"HS256\", \"ES256\", \"RS256\"],\n   155→        )\n   156→\n   157→        user_id = payload.get(\"sub\")\n   158→        email = payload.get(\"email\")\n   159→\n   160→        if not user_id:\n   161→            return None\n   162→\n   163→        return {\n   164→            \"id\": user_id,\n   165→            \"email\": email,\n   166→            \"token\": token,\n   167→            \"api_key_id\": None,\n   168→            \"api_key_scopes\": [\"*\"],\n   169→            \"auth_method\": \"jwt\"\n   170→        }\n   171→    except JWTError:\n   172→        return None\n   173→    except Exception:\n   174→        return None\n   175→\n   176→\n   177→async def get_current_user(\n   178→    request: Request,\n   179→    credentials: Optional[HTTPAuthorizationCredentials] = Depends(security),\n   180→    x_api_key: Optional[str] = Depends(api_key_header),\n   181→) -> dict:\n   182→    \"\"\"\n   183→    Validate authentication via either JWT or API key.\n   184→\n   185→    Priority:\n   186→    1. X-API-Key header (API key auth)\n   187→    2. Authorization: Bearer (JWT auth)\n   188→    \"\"\"\n   189→    # Try API key first\n   190→    if x_api_key:\n   191→        user = await validate_api_key(x_api_key, request)\n   192→        if user:\n   193→            return user\n   194→        raise HTTPException(status_code=401, detail=\"Invalid API key\")\n   195→\n   196→    # Fall back to JWT\n   197→    if credentials:\n   198→        user = await validate_jwt(credentials.credentials)\n   199→        if user:\n   200→            return user\n   201→        raise HTTPException(status_code=401, detail=\"Invalid token\")\n   202→\n   203→    raise HTTPException(status_code=401, detail=\"Authentication required. Provide either X-API-Key header or Authorization: Bearer token\")\n   204→\n   205→\n   206→async def get_optional_user(\n   207→    request: Request,\n   208→    authorization: Optional[str] = Header(None),\n   209→    x_api_key: Optional[str] = Header(None, alias=\"X-API-Key\"),\n   210→) -> Optional[dict]:\n   211→    \"\"\"Get user if authenticated, None otherwise.\"\"\"\n   212→    # Try API key\n   213→    if x_api_key:\n   214→        try:\n   215→            return await validate_api_key(x_api_key, request)\n   216→        except HTTPException:\n   217→            return None\n   218→\n   219→    # Try JWT\n   220→    if authorization and authorization.startswith(\"Bearer \"):\n   221→        token = authorization.replace(\"Bearer \", \"\")\n   222→        return await validate_jwt(token)\n   223→\n   224→    return None\n   225→\n   226→\n   227→def require_scope(required_scope: str):\n   228→    \"\"\"Dependency to check if the user has the required scope.\"\"\"\n   229→    async def check_scope(user: dict = Depends(get_current_user)):\n   230→        scopes = user.get(\"api_key_scopes\", [\"*\"])\n   231→\n   232→        # Wildcard allows all\n   233→        if \"*\" in scopes:\n   234→            return user\n   235→\n   236→        # Read scope allows all read operations\n   237→        if required_scope == \"read\" and \"read\" in scopes:\n   238→            return user\n   239→\n   240→        # Check specific scope\n   241→        if required_scope not in scopes:\n   242→            raise HTTPException(\n   243→                status_code=403,\n   244→                detail=f\"API key lacks required scope: {required_scope}\"\n   245→            )\n   246→\n   247→        return user\n   248→\n   249→    return check_scope\n   250→\n   251→\n   252→def require_jwt_auth():\n   253→    \"\"\"Dependency that requires JWT authentication (not API key).\n   254→\n   255→    Use this for sensitive operations like managing API keys.\n   256→    \"\"\"\n   257→    async def check_jwt(user: dict = Depends(get_current_user)):\n   258→        if user.get(\"auth_method\") == \"api_key\":\n   259→            raise HTTPException(\n   260→                status_code=403,\n   261→                detail=\"This operation requires JWT authentication, not API key\"\n   262→            )\n   263→        return user\n   264→\n   265→    return check_jwt\n   266→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"b1356ad4-97a8-4a14-b2e0-02ac944d0742","timestamp":"2026-01-10T17:27:12.198Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/backend/app/services/auth.py","content":"from fastapi import HTTPException, Depends, Header, Request\nfrom fastapi.security import HTTPBearer, HTTPAuthorizationCredentials, APIKeyHeader\nfrom typing import Optional, Tuple\nfrom jose import jwt, JWTError\nimport hashlib\nimport secrets\nfrom datetime import datetime, timezone\nfrom collections import defaultdict\nimport time\n\nfrom app.config import get_settings\nfrom app.services.supabase_client import get_supabase_client\n\nsettings = get_settings()\nsecurity = HTTPBearer(auto_error=False)\napi_key_header = APIKeyHeader(name=\"X-API-Key\", auto_error=False)\n\n# Simple in-memory rate limiter (for production, use Redis)\nrate_limit_store: dict = defaultdict(lambda: {\"minute\": {}, \"day\": {}})\n\n\ndef generate_api_key() -> Tuple[str, str, str]:\n    \"\"\"Generate a new API key.\n\n    Returns:\n        Tuple of (full_key, key_prefix, key_hash)\n    \"\"\"\n    # Generate 32 random bytes = 64 hex characters\n    random_part = secrets.token_hex(32)\n    full_key = f\"nb_live_{random_part}\"\n    key_prefix = f\"nb_live_{random_part[:8]}...\"\n    key_hash = hashlib.sha256(full_key.encode()).hexdigest()\n\n    return full_key, key_prefix, key_hash\n\n\ndef hash_api_key(key: str) -> str:\n    \"\"\"Hash an API key for comparison.\"\"\"\n    return hashlib.sha256(key.encode()).hexdigest()\n\n\ndef check_rate_limit(api_key_id: str, rpm_limit: int, rpd_limit: int) -> bool:\n    \"\"\"Check if the API key is within rate limits.\n\n    Returns True if allowed, raises HTTPException if rate limited.\n    \"\"\"\n    now = time.time()\n    minute_key = int(now // 60)\n    day_key = int(now // 86400)\n\n    store = rate_limit_store[api_key_id]\n\n    # Clean old entries\n    store[\"minute\"] = {k: v for k, v in store[\"minute\"].items() if k >= minute_key - 1}\n    store[\"day\"] = {k: v for k, v in store[\"day\"].items() if k >= day_key - 1}\n\n    # Check minute limit\n    minute_count = store[\"minute\"].get(minute_key, 0)\n    if minute_count >= rpm_limit:\n        raise HTTPException(\n            status_code=429,\n            detail=f\"Rate limit exceeded: {rpm_limit} requests per minute\",\n            headers={\"Retry-After\": str(60 - int(now % 60))}\n        )\n\n    # Check day limit\n    day_count = store[\"day\"].get(day_key, 0)\n    if day_count >= rpd_limit:\n        raise HTTPException(\n            status_code=429,\n            detail=f\"Rate limit exceeded: {rpd_limit} requests per day\",\n            headers={\"Retry-After\": str(86400 - int(now % 86400))}\n        )\n\n    # Increment counters\n    store[\"minute\"][minute_key] = minute_count + 1\n    store[\"day\"][day_key] = day_count + 1\n\n    return True\n\n\nasync def validate_api_key(api_key: str, request: Request) -> Optional[dict]:\n    \"\"\"Validate an API key and return user info if valid.\"\"\"\n    if not api_key or not api_key.startswith(\"nb_live_\"):\n        return None\n\n    supabase = get_supabase_client()\n    key_hash = hash_api_key(api_key)\n\n    # Look up API key by hash\n    result = supabase.table(\"api_keys\").select(\"*\").eq(\"key_hash\", key_hash).execute()\n\n    if not result.data or len(result.data) == 0:\n        return None\n\n    api_key_record = result.data[0]\n\n    # Check if active\n    if not api_key_record[\"is_active\"]:\n        raise HTTPException(status_code=401, detail=\"API key is disabled\")\n\n    # Check expiration\n    if api_key_record[\"expires_at\"]:\n        expires_str = api_key_record[\"expires_at\"]\n        if isinstance(expires_str, str):\n            expires = datetime.fromisoformat(expires_str.replace(\"Z\", \"+00:00\"))\n        else:\n            expires = expires_str\n        if expires < datetime.now(timezone.utc):\n            raise HTTPException(status_code=401, detail=\"API key has expired\")\n\n    # Check IP allowlist\n    if api_key_record[\"allowed_ips\"]:\n        client_ip = request.client.host if request.client else None\n        if client_ip and client_ip not in api_key_record[\"allowed_ips\"]:\n            raise HTTPException(status_code=403, detail=\"IP address not allowed\")\n\n    # Check rate limits\n    check_rate_limit(\n        api_key_record[\"id\"],\n        api_key_record[\"rate_limit_rpm\"],\n        api_key_record[\"rate_limit_rpd\"]\n    )\n\n    # Update last used and increment request count\n    supabase.table(\"api_keys\").update({\n        \"last_used_at\": datetime.now(timezone.utc).isoformat(),\n        \"total_requests\": api_key_record[\"total_requests\"] + 1\n    }).eq(\"id\", api_key_record[\"id\"]).execute()\n\n    # Store api_key_id in request state for usage logging\n    request.state.api_key_id = api_key_record[\"id\"]\n\n    return {\n        \"id\": api_key_record[\"user_id\"],\n        \"email\": None,  # API keys don't have email context\n        \"token\": None,\n        \"api_key_id\": api_key_record[\"id\"],\n        \"api_key_scopes\": api_key_record[\"scopes\"],\n        \"auth_method\": \"api_key\"\n    }\n\n\nasync def validate_jwt(token: str) -> Optional[dict]:\n    \"\"\"Validate a JWT token and return user info.\"\"\"\n    try:\n        payload = jwt.decode(\n            token,\n            key=\"\",  # Key not needed when verify_signature is False\n            options={\n                \"verify_signature\": False,\n                \"verify_aud\": False,\n            },\n            algorithms=[\"HS256\", \"ES256\", \"RS256\"],\n        )\n\n        user_id = payload.get(\"sub\")\n        email = payload.get(\"email\")\n\n        if not user_id:\n            return None\n\n        return {\n            \"id\": user_id,\n            \"email\": email,\n            \"token\": token,\n            \"api_key_id\": None,\n            \"api_key_scopes\": [\"*\"],\n            \"auth_method\": \"jwt\"\n        }\n    except JWTError:\n        return None\n    except Exception:\n        return None\n\n\nasync def get_current_user(\n    request: Request,\n    credentials: Optional[HTTPAuthorizationCredentials] = Depends(security),\n    x_api_key: Optional[str] = Depends(api_key_header),\n) -> dict:\n    \"\"\"\n    Validate authentication via either JWT or API key.\n\n    Priority:\n    1. X-API-Key header (API key auth)\n    2. Authorization: Bearer (JWT auth)\n    \"\"\"\n    # Try API key first\n    if x_api_key:\n        user = await validate_api_key(x_api_key, request)\n        if user:\n            return user\n        raise HTTPException(status_code=401, detail=\"Invalid API key\")\n\n    # Fall back to JWT\n    if credentials:\n        user = await validate_jwt(credentials.credentials)\n        if user:\n            return user\n        raise HTTPException(status_code=401, detail=\"Invalid token\")\n\n    raise HTTPException(status_code=401, detail=\"Authentication required. Provide either X-API-Key header or Authorization: Bearer token\")\n\n\nasync def get_optional_user(\n    request: Request,\n    authorization: Optional[str] = Header(None),\n    x_api_key: Optional[str] = Header(None, alias=\"X-API-Key\"),\n) -> Optional[dict]:\n    \"\"\"Get user if authenticated, None otherwise.\"\"\"\n    # Try API key\n    if x_api_key:\n        try:\n            return await validate_api_key(x_api_key, request)\n        except HTTPException:\n            return None\n\n    # Try JWT\n    if authorization and authorization.startswith(\"Bearer \"):\n        token = authorization.replace(\"Bearer \", \"\")\n        return await validate_jwt(token)\n\n    return None\n\n\ndef require_scope(required_scope: str):\n    \"\"\"Dependency to check if the user has the required scope.\"\"\"\n    async def check_scope(user: dict = Depends(get_current_user)):\n        scopes = user.get(\"api_key_scopes\", [\"*\"])\n\n        # Wildcard allows all\n        if \"*\" in scopes:\n            return user\n\n        # Read scope allows all read operations\n        if required_scope == \"read\" and \"read\" in scopes:\n            return user\n\n        # Check specific scope\n        if required_scope not in scopes:\n            raise HTTPException(\n                status_code=403,\n                detail=f\"API key lacks required scope: {required_scope}\"\n            )\n\n        return user\n\n    return check_scope\n\n\ndef require_jwt_auth():\n    \"\"\"Dependency that requires JWT authentication (not API key).\n\n    Use this for sensitive operations like managing API keys.\n    \"\"\"\n    async def check_jwt(user: dict = Depends(get_current_user)):\n        if user.get(\"auth_method\") == \"api_key\":\n            raise HTTPException(\n                status_code=403,\n                detail=\"This operation requires JWT authentication, not API key\"\n            )\n        return user\n\n    return check_jwt\n","numLines":266,"startLine":1,"totalLines":266}},"sourceToolAssistantUUID":"ee4a83b4-1833-4f03-a645-96d1d99d4f6f"}
{"parentUuid":"b1356ad4-97a8-4a14-b2e0-02ac944d0742","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","message":{"model":"claude-opus-4-5-20251101","id":"msg_01SCmoqCGgkhiFWMXAhbaN5z","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Now I have a good understanding of the codebase. Let me start implementing the export feature step by step.\n\n1. First, I'll create the backend export router\n2. Register it in main.py\n3. Create the frontend API route\n4. Expand export-utils.ts\n5. Add the export UI to studio-panel.tsx\n\nLet me start with step 1 - creating the backend export router.","signature":"Ev4DCkYICxgCKkBiWtegr9QbdcpEfJiEjxDyjwL//9NFc+kVef/U6Pb7RY7JadgJvM6cCrA/hR7a8faFTuu6k3weTR1e6126Tr9AEgxrZq8Ny9MS3epV8P0aDNh3ln3Jjljq1XcuCSIwAOgPw11AOuY+iT1tJlBE9kz0fBJiOY+zGuZbmVg46KMpsGnxWcBp8RYTOhlk8QXkKuUCnk2Mn0MKqzvOTqUzaI/I+0kpz/D6FE/g598D3GRMkum26dCxfKWgkf47k2QvlxOtnTZAZKi9lx23yDFNY8jVV6PoGXj7Ualt0Nw51CXaoJJj7BWpn0U46FG8cV2T4SQPVmJbAJLr/fe6K6iyRYY0NdyG2UjQvI9HpkPuxwyxOL0cfLISwvci5V6GEPN0Uwp6S6Sregmjps0uOtqt2cXsYr4qlVFp09a7RnzT02jy1fPMxjRNf9IhtAbatvWEBIvm4Fp2iekMTgZA8PZUjeGy6/Y8eUhe76OpVN2Tgd2tOtWGAuHgOujyilPpCUP6YRjPAUc/K3Y1j980KycurBrxMNn30GZtUkA4VpTCB4yaR75PU0H2BrAyZkvlSx9qVkqhNxBJoZ8cKXG4Ae5ufG5Gb+n2CiVe6n6c6dgcbo3ZMpfgQXkcihEIQNYncY4JHpEkiyg0HoR1FjBctt0ghkoGit0LCGvtGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":5260,"cache_read_input_tokens":60526,"cache_creation":{"ephemeral_5m_input_tokens":5260,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWz6C8t1qsF6FZoE26EqW","type":"assistant","uuid":"14645b78-8cc5-4c0a-8131-7095216d2019","timestamp":"2026-01-10T17:27:19.163Z"}
{"parentUuid":"14645b78-8cc5-4c0a-8131-7095216d2019","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","message":{"model":"claude-opus-4-5-20251101","id":"msg_01SCmoqCGgkhiFWMXAhbaN5z","type":"message","role":"assistant","content":[{"type":"text","text":"Now I have a good understanding of the codebase. Let me start implementing the export feature."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":5260,"cache_read_input_tokens":60526,"cache_creation":{"ephemeral_5m_input_tokens":5260,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWz6C8t1qsF6FZoE26EqW","type":"assistant","uuid":"c995ae07-e0b7-4fe6-957a-1991face6a9a","timestamp":"2026-01-10T17:27:19.651Z"}
{"parentUuid":"c995ae07-e0b7-4fe6-957a-1991face6a9a","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","message":{"model":"claude-opus-4-5-20251101","id":"msg_01SCmoqCGgkhiFWMXAhbaN5z","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_015SyioSTX2ULiaX2rW9cwJk","name":"TodoWrite","input":{"todos":[{"content":"Create backend export router (export.py)","status":"in_progress","activeForm":"Creating backend export router"},{"content":"Register export router in main.py","status":"pending","activeForm":"Registering export router in main.py"},{"content":"Create frontend API route for export","status":"pending","activeForm":"Creating frontend API route for export"},{"content":"Expand export-utils.ts with notebook export functions","status":"pending","activeForm":"Expanding export-utils.ts"},{"content":"Add export UI to studio-panel.tsx","status":"pending","activeForm":"Adding export UI to studio-panel.tsx"},{"content":"Test the export functionality","status":"pending","activeForm":"Testing export functionality"}]}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":5260,"cache_read_input_tokens":60526,"cache_creation":{"ephemeral_5m_input_tokens":5260,"ephemeral_1h_input_tokens":0},"output_tokens":365,"service_tier":"standard"}},"requestId":"req_011CWz6C8t1qsF6FZoE26EqW","type":"assistant","uuid":"494cbe65-18e6-4a19-b70b-de6e25d3061a","timestamp":"2026-01-10T17:27:22.129Z"}
{"parentUuid":"494cbe65-18e6-4a19-b70b-de6e25d3061a","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_015SyioSTX2ULiaX2rW9cwJk","type":"tool_result","content":"Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable"}]},"uuid":"fed919ad-2069-4a99-ba8f-c60ae5f771bf","timestamp":"2026-01-10T17:27:22.149Z","toolUseResult":{"oldTodos":[{"content":"Create backend export router (export.py)","status":"pending","activeForm":"Creating backend export router"},{"content":"Register export router in main.py","status":"pending","activeForm":"Registering export router in main.py"},{"content":"Create frontend API route for export","status":"pending","activeForm":"Creating frontend API route for export"},{"content":"Expand export-utils.ts with notebook export functions","status":"pending","activeForm":"Expanding export-utils.ts"},{"content":"Add export UI to studio-panel.tsx","status":"pending","activeForm":"Adding export UI to studio-panel.tsx"},{"content":"Test the export functionality","status":"pending","activeForm":"Testing export functionality"}],"newTodos":[{"content":"Create backend export router (export.py)","status":"in_progress","activeForm":"Creating backend export router"},{"content":"Register export router in main.py","status":"pending","activeForm":"Registering export router in main.py"},{"content":"Create frontend API route for export","status":"pending","activeForm":"Creating frontend API route for export"},{"content":"Expand export-utils.ts with notebook export functions","status":"pending","activeForm":"Expanding export-utils.ts"},{"content":"Add export UI to studio-panel.tsx","status":"pending","activeForm":"Adding export UI to studio-panel.tsx"},{"content":"Test the export functionality","status":"pending","activeForm":"Testing export functionality"}]},"sourceToolAssistantUUID":"494cbe65-18e6-4a19-b70b-de6e25d3061a"}
{"parentUuid":"fed919ad-2069-4a99-ba8f-c60ae5f771bf","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","message":{"model":"claude-opus-4-5-20251101","id":"msg_01E3fc6u8cyZQBhjSUFowMpn","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Let me first check if there's an existing API route pattern I should follow for the frontend.","signature":"EoUCCkYICxgCKkBlVCF1k1M/SQNxJkbrbwbCwcDB5dtk0MGzdluqX3mEgImzu2u3UoGaTBK13lV/9VF5wa18/uuwTcG4b4z2U4OuEgzqD2eEASEQrRrHvhcaDHOaFzD+hBdPkn09qiIwuJA4R4LIBxFW2vgmJNCyEHC7Nb2NxD7U6z6VQm+br9DQDCjVssZWFdkDCJozzLdWKm0Y5cIvwZZ3r6g2S1EKXp/oL9+xlHmuRTDcTxrHxuKRuz6s/wt69I2VAfP8IN8aJGHfRTQ4XIVKAafOsCjfS/uJ92KSsXOA2yi4JBmUELmJFIuUNuapHFWPce8+Hn73G82L3hAtIJIZCEFP8PYFGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":412,"cache_read_input_tokens":65786,"cache_creation":{"ephemeral_5m_input_tokens":412,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWz6Cp1UuHfdMMZteTKBM","type":"assistant","uuid":"12b82d56-b66e-40ef-9b7e-f8e592b80815","timestamp":"2026-01-10T17:27:26.298Z"}
{"parentUuid":"12b82d56-b66e-40ef-9b7e-f8e592b80815","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","message":{"model":"claude-opus-4-5-20251101","id":"msg_01E3fc6u8cyZQBhjSUFowMpn","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_017FSSMqTuRvVZsoDLyzbgQF","name":"Glob","input":{"pattern":"frontend/src/app/api/notebooks/**/*.ts"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":412,"cache_read_input_tokens":65786,"cache_creation":{"ephemeral_5m_input_tokens":412,"ephemeral_1h_input_tokens":0},"output_tokens":90,"service_tier":"standard"}},"requestId":"req_011CWz6Cp1UuHfdMMZteTKBM","type":"assistant","uuid":"60cac0e2-0709-4e7b-be3a-6f05112882f7","timestamp":"2026-01-10T17:27:26.715Z"}
{"parentUuid":"60cac0e2-0709-4e7b-be3a-6f05112882f7","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_017FSSMqTuRvVZsoDLyzbgQF","type":"tool_result","content":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend/src/app/api/notebooks/[id]/notes/route.ts\n/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend/src/app/api/notebooks/[id]/notes/[noteId]/route.ts\n/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend/src/app/api/notebooks/[id]/sources/route.ts\n/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend/src/app/api/notebooks/[id]/sources/[sourceId]/route.ts\n/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend/src/app/api/notebooks/[id]/research/route.ts\n/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend/src/app/api/notebooks/[id]/audio/route.ts\n/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend/src/app/api/notebooks/[id]/chat/sessions/route.ts\n/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend/src/app/api/notebooks/[id]/chat/sessions/[sessionId]/route.ts\n/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend/src/app/api/notebooks/[id]/chat/route.ts\n/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend/src/app/api/notebooks/[id]/study/route.ts\n/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend/src/app/api/notebooks/[id]/studio/route.ts\n/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend/src/app/api/notebooks/[id]/history/route.ts\n/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend/src/app/api/notebooks/[id]/video/route.ts"}]},"uuid":"1a76a6d9-1d45-49f8-a764-c60dd2e6ce4d","timestamp":"2026-01-10T17:27:26.939Z","toolUseResult":{"filenames":["/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend/src/app/api/notebooks/[id]/notes/route.ts","/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend/src/app/api/notebooks/[id]/notes/[noteId]/route.ts","/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend/src/app/api/notebooks/[id]/sources/route.ts","/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend/src/app/api/notebooks/[id]/sources/[sourceId]/route.ts","/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend/src/app/api/notebooks/[id]/research/route.ts","/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend/src/app/api/notebooks/[id]/audio/route.ts","/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend/src/app/api/notebooks/[id]/chat/sessions/route.ts","/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend/src/app/api/notebooks/[id]/chat/sessions/[sessionId]/route.ts","/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend/src/app/api/notebooks/[id]/chat/route.ts","/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend/src/app/api/notebooks/[id]/study/route.ts","/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend/src/app/api/notebooks/[id]/studio/route.ts","/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend/src/app/api/notebooks/[id]/history/route.ts","/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend/src/app/api/notebooks/[id]/video/route.ts"],"durationMs":193,"numFiles":13,"truncated":false},"sourceToolAssistantUUID":"60cac0e2-0709-4e7b-be3a-6f05112882f7"}
{"parentUuid":"1a76a6d9-1d45-49f8-a764-c60dd2e6ce4d","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","message":{"model":"claude-opus-4-5-20251101","id":"msg_01XA78T3h3fgvuBhfagjCwHz","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Let me read one of the existing API routes to understand the pattern used for proxying to the backend.","signature":"Eo4CCkYICxgCKkA3n09z66ao2cdtZa90f3rIoPYvCXRv/37sm1+cDzOOcTf3kQf0zIX/Pe8Fs8J91dVbCVre6sjBm6Ymhdiz4ozmEgytJpakOqvVEf5S15EaDKqNwWlGMsNAZojLkiIwgvtiRrzkEkQpc7+NMnRLzn9hzH95wV5KsLoPTz/nMNCSfdMx//6Q77LlD1OhoSFGKnZBG73Ky4sKhak0oeI9atU/VxkIDC4c5sr6kLNLDQdn8nF8QaoHFBqvILU3WxsEvFmIyZc3PgSnHaGBSa1IQv2IJFdF5/rwCOFd3qs78vYdsCIR5deeB2OYxOJBnE241K0PHhfOgcZNRA6V7K/cMJbar0g9cgvzGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":682,"cache_read_input_tokens":66198,"cache_creation":{"ephemeral_5m_input_tokens":682,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CWz6DNXKyu7NAJM77FzX6","type":"assistant","uuid":"ac177ccc-5c38-4d19-ab2d-1a5dba83ee5f","timestamp":"2026-01-10T17:27:33.518Z"}
{"parentUuid":"ac177ccc-5c38-4d19-ab2d-1a5dba83ee5f","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","message":{"model":"claude-opus-4-5-20251101","id":"msg_01XA78T3h3fgvuBhfagjCwHz","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_013qUeu4X7gqfcd9XeiJyPzS","name":"Read","input":{"file_path":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend/src/app/api/notebooks/[id]/sources/route.ts"}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":682,"cache_read_input_tokens":66198,"cache_creation":{"ephemeral_5m_input_tokens":682,"ephemeral_1h_input_tokens":0},"output_tokens":123,"service_tier":"standard"}},"requestId":"req_011CWz6DNXKyu7NAJM77FzX6","type":"assistant","uuid":"fe6557ce-efec-4a96-8fba-50c9e3445911","timestamp":"2026-01-10T17:27:34.080Z"}
{"parentUuid":"fe6557ce-efec-4a96-8fba-50c9e3445911","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_013qUeu4X7gqfcd9XeiJyPzS","type":"tool_result","content":"     1→import { NextRequest, NextResponse } from 'next/server'\n     2→import { createClient } from '@supabase/supabase-js'\n     3→\n     4→const supabase = createClient(\n     5→  process.env.NEXT_PUBLIC_SUPABASE_URL!,\n     6→  process.env.SUPABASE_SERVICE_ROLE_KEY || process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!\n     7→)\n     8→\n     9→async function verifyAccess(request: NextRequest, notebookId: string) {\n    10→  const authHeader = request.headers.get('authorization')\n    11→  if (!authHeader) return null\n    12→\n    13→  const token = authHeader.replace('Bearer ', '')\n    14→  const { data: { user } } = await supabase.auth.getUser(token)\n    15→\n    16→  if (!user) return null\n    17→\n    18→  const { data: notebook } = await supabase\n    19→    .from('notebooks')\n    20→    .select('id')\n    21→    .eq('id', notebookId)\n    22→    .eq('user_id', user.id)\n    23→    .single()\n    24→\n    25→  if (!notebook) return null\n    26→\n    27→  return user\n    28→}\n    29→\n    30→export async function GET(\n    31→  request: NextRequest,\n    32→  { params }: { params: Promise<{ id: string }> }\n    33→) {\n    34→  try {\n    35→    const { id: notebookId } = await params\n    36→    const user = await verifyAccess(request, notebookId)\n    37→\n    38→    if (!user) {\n    39→      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })\n    40→    }\n    41→\n    42→    const { data: sources } = await supabase\n    43→      .from('sources')\n    44→      .select('*')\n    45→      .eq('notebook_id', notebookId)\n    46→      .order('created_at', { ascending: false })\n    47→\n    48→    return NextResponse.json({ data: sources || [] })\n    49→  } catch (error) {\n    50→    console.error('List sources error:', error)\n    51→    return NextResponse.json({ error: 'Failed to list sources' }, { status: 500 })\n    52→  }\n    53→}\n    54→\n    55→export async function POST(\n    56→  request: NextRequest,\n    57→  { params }: { params: Promise<{ id: string }> }\n    58→) {\n    59→  try {\n    60→    const { id: notebookId } = await params\n    61→    const user = await verifyAccess(request, notebookId)\n    62→\n    63→    if (!user) {\n    64→      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })\n    65→    }\n    66→\n    67→    const formData = await request.formData()\n    68→    const type = formData.get('type') as string\n    69→\n    70→    if (type === 'text') {\n    71→      const name = formData.get('name') as string\n    72→      const content = formData.get('content') as string\n    73→\n    74→      const { data: source, error } = await supabase\n    75→        .from('sources')\n    76→        .insert({\n    77→          notebook_id: notebookId,\n    78→          type: 'text',\n    79→          name: name || 'Pasted Text',\n    80→          status: 'ready',\n    81→          metadata: { content: content?.slice(0, 100000) },\n    82→        })\n    83→        .select()\n    84→        .single()\n    85→\n    86→      if (error) {\n    87→        return NextResponse.json({ error: 'Failed to create source' }, { status: 400 })\n    88→      }\n    89→\n    90→      return NextResponse.json({ data: source })\n    91→    }\n    92→\n    93→    if (type === 'url') {\n    94→      const url = formData.get('url') as string\n    95→      const name = formData.get('name') as string\n    96→\n    97→      const { data: source, error } = await supabase\n    98→        .from('sources')\n    99→        .insert({\n   100→          notebook_id: notebookId,\n   101→          type: 'url',\n   102→          name: name || url?.slice(0, 100),\n   103→          status: 'ready',\n   104→          metadata: { url },\n   105→        })\n   106→        .select()\n   107→        .single()\n   108→\n   109→      if (error) {\n   110→        return NextResponse.json({ error: 'Failed to create source' }, { status: 400 })\n   111→      }\n   112→\n   113→      return NextResponse.json({ data: source })\n   114→    }\n   115→\n   116→    if (type === 'youtube') {\n   117→      const url = formData.get('url') as string\n   118→      const name = formData.get('name') as string\n   119→\n   120→      let videoId = null\n   121→      if (url.includes('youtube.com/watch?v=')) {\n   122→        videoId = url.split('v=')[1]?.split('&')[0]\n   123→      } else if (url.includes('youtu.be/')) {\n   124→        videoId = url.split('youtu.be/')[1]?.split('?')[0]\n   125→      }\n   126→\n   127→      const { data: source, error } = await supabase\n   128→        .from('sources')\n   129→        .insert({\n   130→          notebook_id: notebookId,\n   131→          type: 'youtube',\n   132→          name: name || `YouTube: ${videoId || url}`,\n   133→          status: 'ready',\n   134→          metadata: { url, video_id: videoId },\n   135→        })\n   136→        .select()\n   137→        .single()\n   138→\n   139→      if (error) {\n   140→        return NextResponse.json({ error: 'Failed to create source' }, { status: 400 })\n   141→      }\n   142→\n   143→      return NextResponse.json({ data: source })\n   144→    }\n   145→\n   146→    // File upload\n   147→    const file = formData.get('file') as File\n   148→    if (!file) {\n   149→      return NextResponse.json({ error: 'No file provided' }, { status: 400 })\n   150→    }\n   151→\n   152→    const buffer = Buffer.from(await file.arrayBuffer())\n   153→    const filename = file.name\n   154→    const ext = filename.split('.').pop()?.toLowerCase() || 'txt'\n   155→    const storagePath = `${user.id}/${notebookId}/${Date.now()}_${filename}`\n   156→\n   157→    const { error: uploadError } = await supabase.storage\n   158→      .from('sources')\n   159→      .upload(storagePath, buffer, {\n   160→        contentType: file.type || 'application/octet-stream',\n   161→      })\n   162→\n   163→    if (uploadError) {\n   164→      return NextResponse.json({ error: 'Failed to upload file' }, { status: 400 })\n   165→    }\n   166→\n   167→    const typeMap: Record<string, string> = {\n   168→      pdf: 'pdf',\n   169→      docx: 'docx',\n   170→      doc: 'docx',\n   171→      txt: 'txt',\n   172→      md: 'txt',\n   173→    }\n   174→\n   175→    const { data: source, error } = await supabase\n   176→      .from('sources')\n   177→      .insert({\n   178→        notebook_id: notebookId,\n   179→        type: typeMap[ext] || 'txt',\n   180→        name: filename,\n   181→        status: 'ready',\n   182→        file_path: storagePath,\n   183→        original_filename: filename,\n   184→        mime_type: file.type,\n   185→        file_size_bytes: buffer.length,\n   186→      })\n   187→      .select()\n   188→      .single()\n   189→\n   190→    if (error) {\n   191→      return NextResponse.json({ error: 'Failed to create source' }, { status: 400 })\n   192→    }\n   193→\n   194→    return NextResponse.json({ data: source })\n   195→  } catch (error) {\n   196→    console.error('Create source error:', error)\n   197→    return NextResponse.json({ error: 'Failed to create source' }, { status: 500 })\n   198→  }\n   199→}\n   200→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"028e06dd-94e0-42ab-b7cb-637879d21171","timestamp":"2026-01-10T17:27:34.106Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend/src/app/api/notebooks/[id]/sources/route.ts","content":"import { NextRequest, NextResponse } from 'next/server'\nimport { createClient } from '@supabase/supabase-js'\n\nconst supabase = createClient(\n  process.env.NEXT_PUBLIC_SUPABASE_URL!,\n  process.env.SUPABASE_SERVICE_ROLE_KEY || process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!\n)\n\nasync function verifyAccess(request: NextRequest, notebookId: string) {\n  const authHeader = request.headers.get('authorization')\n  if (!authHeader) return null\n\n  const token = authHeader.replace('Bearer ', '')\n  const { data: { user } } = await supabase.auth.getUser(token)\n\n  if (!user) return null\n\n  const { data: notebook } = await supabase\n    .from('notebooks')\n    .select('id')\n    .eq('id', notebookId)\n    .eq('user_id', user.id)\n    .single()\n\n  if (!notebook) return null\n\n  return user\n}\n\nexport async function GET(\n  request: NextRequest,\n  { params }: { params: Promise<{ id: string }> }\n) {\n  try {\n    const { id: notebookId } = await params\n    const user = await verifyAccess(request, notebookId)\n\n    if (!user) {\n      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })\n    }\n\n    const { data: sources } = await supabase\n      .from('sources')\n      .select('*')\n      .eq('notebook_id', notebookId)\n      .order('created_at', { ascending: false })\n\n    return NextResponse.json({ data: sources || [] })\n  } catch (error) {\n    console.error('List sources error:', error)\n    return NextResponse.json({ error: 'Failed to list sources' }, { status: 500 })\n  }\n}\n\nexport async function POST(\n  request: NextRequest,\n  { params }: { params: Promise<{ id: string }> }\n) {\n  try {\n    const { id: notebookId } = await params\n    const user = await verifyAccess(request, notebookId)\n\n    if (!user) {\n      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })\n    }\n\n    const formData = await request.formData()\n    const type = formData.get('type') as string\n\n    if (type === 'text') {\n      const name = formData.get('name') as string\n      const content = formData.get('content') as string\n\n      const { data: source, error } = await supabase\n        .from('sources')\n        .insert({\n          notebook_id: notebookId,\n          type: 'text',\n          name: name || 'Pasted Text',\n          status: 'ready',\n          metadata: { content: content?.slice(0, 100000) },\n        })\n        .select()\n        .single()\n\n      if (error) {\n        return NextResponse.json({ error: 'Failed to create source' }, { status: 400 })\n      }\n\n      return NextResponse.json({ data: source })\n    }\n\n    if (type === 'url') {\n      const url = formData.get('url') as string\n      const name = formData.get('name') as string\n\n      const { data: source, error } = await supabase\n        .from('sources')\n        .insert({\n          notebook_id: notebookId,\n          type: 'url',\n          name: name || url?.slice(0, 100),\n          status: 'ready',\n          metadata: { url },\n        })\n        .select()\n        .single()\n\n      if (error) {\n        return NextResponse.json({ error: 'Failed to create source' }, { status: 400 })\n      }\n\n      return NextResponse.json({ data: source })\n    }\n\n    if (type === 'youtube') {\n      const url = formData.get('url') as string\n      const name = formData.get('name') as string\n\n      let videoId = null\n      if (url.includes('youtube.com/watch?v=')) {\n        videoId = url.split('v=')[1]?.split('&')[0]\n      } else if (url.includes('youtu.be/')) {\n        videoId = url.split('youtu.be/')[1]?.split('?')[0]\n      }\n\n      const { data: source, error } = await supabase\n        .from('sources')\n        .insert({\n          notebook_id: notebookId,\n          type: 'youtube',\n          name: name || `YouTube: ${videoId || url}`,\n          status: 'ready',\n          metadata: { url, video_id: videoId },\n        })\n        .select()\n        .single()\n\n      if (error) {\n        return NextResponse.json({ error: 'Failed to create source' }, { status: 400 })\n      }\n\n      return NextResponse.json({ data: source })\n    }\n\n    // File upload\n    const file = formData.get('file') as File\n    if (!file) {\n      return NextResponse.json({ error: 'No file provided' }, { status: 400 })\n    }\n\n    const buffer = Buffer.from(await file.arrayBuffer())\n    const filename = file.name\n    const ext = filename.split('.').pop()?.toLowerCase() || 'txt'\n    const storagePath = `${user.id}/${notebookId}/${Date.now()}_${filename}`\n\n    const { error: uploadError } = await supabase.storage\n      .from('sources')\n      .upload(storagePath, buffer, {\n        contentType: file.type || 'application/octet-stream',\n      })\n\n    if (uploadError) {\n      return NextResponse.json({ error: 'Failed to upload file' }, { status: 400 })\n    }\n\n    const typeMap: Record<string, string> = {\n      pdf: 'pdf',\n      docx: 'docx',\n      doc: 'docx',\n      txt: 'txt',\n      md: 'txt',\n    }\n\n    const { data: source, error } = await supabase\n      .from('sources')\n      .insert({\n        notebook_id: notebookId,\n        type: typeMap[ext] || 'txt',\n        name: filename,\n        status: 'ready',\n        file_path: storagePath,\n        original_filename: filename,\n        mime_type: file.type,\n        file_size_bytes: buffer.length,\n      })\n      .select()\n      .single()\n\n    if (error) {\n      return NextResponse.json({ error: 'Failed to create source' }, { status: 400 })\n    }\n\n    return NextResponse.json({ data: source })\n  } catch (error) {\n    console.error('Create source error:', error)\n    return NextResponse.json({ error: 'Failed to create source' }, { status: 500 })\n  }\n}\n","numLines":200,"startLine":1,"totalLines":200}},"sourceToolAssistantUUID":"fe6557ce-efec-4a96-8fba-50c9e3445911"}
{"parentUuid":"028e06dd-94e0-42ab-b7cb-637879d21171","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","message":{"model":"claude-opus-4-5-20251101","id":"msg_01TJ6eEgytivoPXxNMP6x2NQ","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"I see the pattern now. The frontend routes use direct Supabase client for accessing the database. Let me now create the backend export router and the frontend API route.\n\nActually, looking at the pattern, it seems like the frontend routes handle data directly via Supabase client rather than proxying to the FastAPI backend. I should follow this pattern for the frontend export route as well.\n\nBut let me first create the backend export router for completeness, since the skill document specifies it. Then I'll create the frontend route that can be used either way.","signature":"EtoFCkYICxgCKkAWJkXmftVc9wIhufOpNxBGJOsO4mzbjX30wHe3k3O24yZtiwEXygyL1aR/ejeHTorJpr0rCCO1I6a9aLd9lZYyEgyNcwkeCXmc4uCY8k4aDLjcpUz88mQzsHjP7iIwFwAKdLXsrjolF5mBwaWYkKjU/SkAgI+LuVWCuHEH3pdSglzRReFvc5ryZQmKVp0AKsEEVP7FoEiL7fBFVJ/OH+D6DV2FJdlwpWvhEozDHA6zcH5MiMSUC9H4Fy5OrJ3u+GvN0Ph070g/KiBChD4mc2qamnLF3eUKrs4RKUKm2EMLKFWSlXDujimol8EbK8RgI2bUm/p5HFiH75GXWP7rH04ZKYVQhEBtbpEx0n899RBBo8fmlXEia7fD5+OidqXPiJcqI8TL8iplQnGpCqY7DoTEwuC5/HwgE5qJp96OpxHA2SL5voMm3dv/aLboWbkoz/bC54VNbelh7CuRhObTghV77++Hy4cQtSaFjtmdMHRDTaMSzajm3LgbedFMwXp5DPGOcmI6qk/R/96YiNpnanWJMOFIph3I+DVXjTYsRzoyEAAL9vIHhPLas7IEuBGxCJd7RxfYm0WqTTaJg7+bwcAwcgBkkUrr9t2cHIO9IhF1Sac1A/fTHonWJM4PF0rCZnZ/1UWdz04smszl+daR3aY6YDi7Ljv/6LsqSboXAsNPkhXG/efeY61wQ0Nzl2ocLjBpg+Rt5GO00UEOuMeSerQ08xWVUUKAM7dCcmL88Pss7W1tIlkyuapCK2sHFP4oZcoF5erGwxf096nQX3F6nUQKwsTSD42UP2U7EL3wl+SQBMSOCymmxBV+JBVgFOkmkg/ym+6QOtpDmeoUlpV3iaOokhI7+ZQHr7hS73wyhd8kTWHhvZ8bhE4p9vA48B82hS8FqzvyCpI02xU5VFmVoxeJDSmmLcKouNGD1A29TeZEng6z6AwBNOxGL3oURz8Y1w4QmRgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":2602,"cache_read_input_tokens":66880,"cache_creation":{"ephemeral_5m_input_tokens":2602,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWz6Dh1a5WV9fqCuzdsYJ","type":"assistant","uuid":"d921c827-3ba3-4dbd-a13a-ef6ceead6b21","timestamp":"2026-01-10T17:27:39.918Z"}
{"parentUuid":"d921c827-3ba3-4dbd-a13a-ef6ceead6b21","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","message":{"model":"claude-opus-4-5-20251101","id":"msg_01TJ6eEgytivoPXxNMP6x2NQ","type":"message","role":"assistant","content":[{"type":"text","text":"Now I understand the patterns. Let me create the backend export router first."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":2602,"cache_read_input_tokens":66880,"cache_creation":{"ephemeral_5m_input_tokens":2602,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWz6Dh1a5WV9fqCuzdsYJ","type":"assistant","uuid":"234f052a-27bc-4636-8285-ecfbda31bb42","timestamp":"2026-01-10T17:27:40.420Z"}
{"parentUuid":"234f052a-27bc-4636-8285-ecfbda31bb42","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","message":{"model":"claude-opus-4-5-20251101","id":"msg_01TJ6eEgytivoPXxNMP6x2NQ","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01171ewd3tgdHcLxK9SPxVqC","name":"Write","input":{"file_path":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/backend/app/routers/export.py","content":"\"\"\"\nExport router for downloading complete notebook data.\nSupports JSON and ZIP export formats.\n\"\"\"\n\nfrom fastapi import APIRouter, HTTPException, Depends\nfrom fastapi.responses import StreamingResponse\nfrom typing import Optional\nfrom uuid import UUID\nimport json\nimport zipfile\nimport io\nfrom datetime import datetime\n\nfrom app.services.auth import get_current_user\nfrom app.services.supabase_client import get_supabase_client\n\nrouter = APIRouter(prefix=\"/notebooks/{notebook_id}/export\", tags=[\"export\"])\n\n\nasync def get_notebook_data(\n    notebook_id: str,\n    user_id: str,\n    include_sources: bool = True,\n    include_chats: bool = True,\n    include_notes: bool = True,\n    include_generated: bool = True,\n) -> dict:\n    \"\"\"Gather all notebook data for export.\"\"\"\n    supabase = get_supabase_client()\n\n    # Verify notebook access and get metadata\n    notebook_result = (\n        supabase.table(\"notebooks\")\n        .select(\"*\")\n        .eq(\"id\", notebook_id)\n        .eq(\"user_id\", user_id)\n        .single()\n        .execute()\n    )\n\n    if not notebook_result.data:\n        raise HTTPException(status_code=404, detail=\"Notebook not found\")\n\n    notebook = notebook_result.data\n    export_data = {\n        \"notebook\": {\n            \"id\": notebook[\"id\"],\n            \"name\": notebook[\"name\"],\n            \"description\": notebook.get(\"description\"),\n            \"emoji\": notebook.get(\"emoji\"),\n            \"settings\": notebook.get(\"settings\", {}),\n            \"created_at\": notebook[\"created_at\"],\n        },\n        \"exported_at\": datetime.utcnow().isoformat(),\n        \"export_version\": \"1.0\",\n    }\n\n    # Sources\n    if include_sources:\n        sources_result = (\n            supabase.table(\"sources\")\n            .select(\"*\")\n            .eq(\"notebook_id\", notebook_id)\n            .order(\"created_at\", desc=False)\n            .execute()\n        )\n        export_data[\"sources\"] = sources_result.data or []\n\n    # Chat sessions and messages\n    if include_chats:\n        sessions_result = (\n            supabase.table(\"chat_sessions\")\n            .select(\"*\")\n            .eq(\"notebook_id\", notebook_id)\n            .order(\"created_at\", desc=False)\n            .execute()\n        )\n        sessions = sessions_result.data or []\n\n        for session in sessions:\n            messages_result = (\n                supabase.table(\"chat_messages\")\n                .select(\"*\")\n                .eq(\"session_id\", session[\"id\"])\n                .order(\"created_at\", desc=False)\n                .execute()\n            )\n            session[\"messages\"] = messages_result.data or []\n\n        export_data[\"chat_sessions\"] = sessions\n\n    # Notes\n    if include_notes:\n        notes_result = (\n            supabase.table(\"notes\")\n            .select(\"*\")\n            .eq(\"notebook_id\", notebook_id)\n            .order(\"created_at\", desc=False)\n            .execute()\n        )\n        export_data[\"notes\"] = notes_result.data or []\n\n    # Generated content\n    if include_generated:\n        # Audio overviews\n        audio_result = (\n            supabase.table(\"audio_overviews\")\n            .select(\"*\")\n            .eq(\"notebook_id\", notebook_id)\n            .execute()\n        )\n        export_data[\"audio_overviews\"] = audio_result.data or []\n\n        # Video overviews\n        video_result = (\n            supabase.table(\"video_overviews\")\n            .select(\"*\")\n            .eq(\"notebook_id\", notebook_id)\n            .execute()\n        )\n        export_data[\"video_overviews\"] = video_result.data or []\n\n        # Study materials\n        study_result = (\n            supabase.table(\"study_materials\")\n            .select(\"*\")\n            .eq(\"notebook_id\", notebook_id)\n            .execute()\n        )\n        export_data[\"study_materials\"] = study_result.data or []\n\n        # Studio outputs\n        studio_result = (\n            supabase.table(\"studio_outputs\")\n            .select(\"*\")\n            .eq(\"notebook_id\", notebook_id)\n            .execute()\n        )\n        export_data[\"studio_outputs\"] = studio_result.data or []\n\n        # Research tasks\n        research_result = (\n            supabase.table(\"research_tasks\")\n            .select(\"*\")\n            .eq(\"notebook_id\", notebook_id)\n            .execute()\n        )\n        export_data[\"research_tasks\"] = research_result.data or []\n\n    return export_data\n\n\n@router.get(\"/json\")\nasync def export_notebook_json(\n    notebook_id: UUID,\n    include_sources: bool = True,\n    include_chats: bool = True,\n    include_notes: bool = True,\n    include_generated: bool = True,\n    user: dict = Depends(get_current_user),\n):\n    \"\"\"Export notebook data as JSON.\"\"\"\n    export_data = await get_notebook_data(\n        str(notebook_id),\n        user[\"id\"],\n        include_sources,\n        include_chats,\n        include_notes,\n        include_generated,\n    )\n\n    return export_data\n\n\n@router.get(\"/zip\")\nasync def export_notebook_zip(\n    notebook_id: UUID,\n    include_sources: bool = True,\n    include_chats: bool = True,\n    include_notes: bool = True,\n    include_generated: bool = True,\n    user: dict = Depends(get_current_user),\n):\n    \"\"\"Export notebook as ZIP with all files.\"\"\"\n    supabase = get_supabase_client()\n\n    export_data = await get_notebook_data(\n        str(notebook_id),\n        user[\"id\"],\n        include_sources,\n        include_chats,\n        include_notes,\n        include_generated,\n    )\n\n    notebook_name = export_data[\"notebook\"][\"name\"]\n    safe_name = \"\".join(c if c.isalnum() or c in \" -_\" else \"_\" for c in notebook_name)\n    date_str = datetime.utcnow().strftime(\"%Y%m%d\")\n    zip_name = f\"notebook-export-{safe_name}-{date_str}\"\n\n    # Create ZIP in memory\n    zip_buffer = io.BytesIO()\n\n    with zipfile.ZipFile(zip_buffer, \"w\", zipfile.ZIP_DEFLATED) as zf:\n        # Notebook metadata\n        zf.writestr(\n            f\"{zip_name}/notebook.json\",\n            json.dumps(export_data[\"notebook\"], indent=2, default=str)\n        )\n\n        # README\n        readme_content = f\"\"\"# {notebook_name} Export\n\nExported from NotebookLM Reimagined on {datetime.utcnow().strftime(\"%Y-%m-%d %H:%M UTC\")}\n\n## Contents\n\n- `notebook.json` - Notebook metadata (name, description, settings)\n- `sources/` - Source documents and metadata\n- `chats/` - Chat sessions and messages\n- `notes/` - User notes\n- `generated/` - AI-generated content (audio, video, study materials, etc.)\n\n## Re-importing\n\nThis export can be used as a backup. To re-import, use the NotebookLM Reimagined import feature.\n\"\"\"\n        zf.writestr(f\"{zip_name}/README.md\", readme_content)\n\n        # Sources\n        if include_sources and export_data.get(\"sources\"):\n            sources_index = []\n            for source in export_data[\"sources\"]:\n                source_info = {\n                    \"id\": source[\"id\"],\n                    \"name\": source[\"name\"],\n                    \"type\": source[\"type\"],\n                    \"status\": source[\"status\"],\n                    \"created_at\": source[\"created_at\"],\n                    \"metadata\": source.get(\"metadata\"),\n                    \"source_guide\": source.get(\"source_guide\"),\n                }\n                sources_index.append(source_info)\n\n                # Try to download actual file from storage\n                if source.get(\"file_path\"):\n                    try:\n                        file_data = supabase.storage.from_(\"sources\").download(source[\"file_path\"])\n                        if file_data:\n                            filename = source.get(\"original_filename\") or source[\"name\"]\n                            zf.writestr(f\"{zip_name}/sources/files/{filename}\", file_data)\n                            source_info[\"exported_file\"] = f\"files/{filename}\"\n                    except Exception as e:\n                        source_info[\"export_error\"] = str(e)\n\n                # For text sources, include content\n                if source[\"type\"] == \"text\" and source.get(\"metadata\"):\n                    metadata = source[\"metadata\"] or {}\n                    if content := metadata.get(\"content\"):\n                        filename = f\"{source['id']}.txt\"\n                        zf.writestr(f\"{zip_name}/sources/text/{filename}\", content)\n                        source_info[\"exported_file\"] = f\"text/{filename}\"\n\n            zf.writestr(\n                f\"{zip_name}/sources/index.json\",\n                json.dumps(sources_index, indent=2, default=str)\n            )\n\n        # Chats\n        if include_chats and export_data.get(\"chat_sessions\"):\n            sessions_index = []\n            for session in export_data[\"chat_sessions\"]:\n                session_info = {\n                    \"id\": session[\"id\"],\n                    \"title\": session.get(\"title\"),\n                    \"created_at\": session[\"created_at\"],\n                    \"message_count\": len(session.get(\"messages\", [])),\n                }\n                sessions_index.append(session_info)\n\n                # Individual session file\n                zf.writestr(\n                    f\"{zip_name}/chats/session-{session['id']}.json\",\n                    json.dumps(session, indent=2, default=str)\n                )\n\n            zf.writestr(\n                f\"{zip_name}/chats/index.json\",\n                json.dumps(sessions_index, indent=2, default=str)\n            )\n\n        # Notes\n        if include_notes and export_data.get(\"notes\"):\n            zf.writestr(\n                f\"{zip_name}/notes/index.json\",\n                json.dumps(export_data[\"notes\"], indent=2, default=str)\n            )\n\n        # Generated content\n        if include_generated:\n            generated_index = {\n                \"audio_overviews\": [],\n                \"video_overviews\": [],\n                \"study_materials\": [],\n                \"studio_outputs\": [],\n                \"research_tasks\": [],\n            }\n\n            # Audio\n            for audio in export_data.get(\"audio_overviews\", []):\n                audio_info = {\n                    \"id\": audio[\"id\"],\n                    \"format\": audio.get(\"format\"),\n                    \"status\": audio.get(\"status\"),\n                    \"created_at\": audio.get(\"created_at\"),\n                }\n                generated_index[\"audio_overviews\"].append(audio_info)\n\n                # Save script\n                if audio.get(\"script\"):\n                    zf.writestr(\n                        f\"{zip_name}/generated/audio/{audio['id']}_script.json\",\n                        json.dumps(audio[\"script\"], indent=2, default=str)\n                    )\n\n                # Try to download audio file\n                if audio.get(\"audio_file_path\"):\n                    try:\n                        audio_data = supabase.storage.from_(\"audio\").download(audio[\"audio_file_path\"])\n                        if audio_data:\n                            zf.writestr(f\"{zip_name}/generated/audio/{audio['id']}.mp3\", audio_data)\n                            audio_info[\"exported_file\"] = f\"{audio['id']}.mp3\"\n                    except Exception:\n                        pass\n\n            # Video\n            for video in export_data.get(\"video_overviews\", []):\n                video_info = {\n                    \"id\": video[\"id\"],\n                    \"style\": video.get(\"style\"),\n                    \"status\": video.get(\"status\"),\n                    \"created_at\": video.get(\"created_at\"),\n                }\n                generated_index[\"video_overviews\"].append(video_info)\n\n                if video.get(\"script\"):\n                    zf.writestr(\n                        f\"{zip_name}/generated/video/{video['id']}_script.json\",\n                        json.dumps(video[\"script\"], indent=2, default=str)\n                    )\n\n            # Study materials\n            for material in export_data.get(\"study_materials\", []):\n                material_info = {\n                    \"id\": material[\"id\"],\n                    \"type\": material.get(\"type\"),\n                    \"created_at\": material.get(\"created_at\"),\n                }\n                generated_index[\"study_materials\"].append(material_info)\n\n                zf.writestr(\n                    f\"{zip_name}/generated/study-materials/{material['type']}_{material['id']}.json\",\n                    json.dumps(material, indent=2, default=str)\n                )\n\n            # Studio outputs\n            for output in export_data.get(\"studio_outputs\", []):\n                output_info = {\n                    \"id\": output[\"id\"],\n                    \"type\": output.get(\"type\"),\n                    \"title\": output.get(\"title\"),\n                    \"created_at\": output.get(\"created_at\"),\n                }\n                generated_index[\"studio_outputs\"].append(output_info)\n\n                zf.writestr(\n                    f\"{zip_name}/generated/studio/{output['type']}_{output['id']}.json\",\n                    json.dumps(output, indent=2, default=str)\n                )\n\n            # Research tasks\n            for research in export_data.get(\"research_tasks\", []):\n                research_info = {\n                    \"id\": research[\"id\"],\n                    \"query\": research.get(\"query\"),\n                    \"status\": research.get(\"status\"),\n                    \"created_at\": research.get(\"created_at\"),\n                }\n                generated_index[\"research_tasks\"].append(research_info)\n\n                zf.writestr(\n                    f\"{zip_name}/generated/research/{research['id']}.json\",\n                    json.dumps(research, indent=2, default=str)\n                )\n\n            zf.writestr(\n                f\"{zip_name}/generated/index.json\",\n                json.dumps(generated_index, indent=2, default=str)\n            )\n\n    zip_buffer.seek(0)\n\n    return StreamingResponse(\n        zip_buffer,\n        media_type=\"application/zip\",\n        headers={\n            \"Content-Disposition\": f'attachment; filename=\"{zip_name}.zip\"',\n        },\n    )\n"}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":2602,"cache_read_input_tokens":66880,"cache_creation":{"ephemeral_5m_input_tokens":2602,"ephemeral_1h_input_tokens":0},"output_tokens":3988,"service_tier":"standard"}},"requestId":"req_011CWz6Dh1a5WV9fqCuzdsYJ","type":"assistant","uuid":"cd19c5fa-b1c6-4fbb-82a3-59cd8141a739","timestamp":"2026-01-10T17:28:16.414Z"}
{"type":"file-history-snapshot","messageId":"cd19c5fa-b1c6-4fbb-82a3-59cd8141a739","snapshot":{"messageId":"973ebb96-60df-4671-b9c2-0c4aefc8516e","trackedFileBackups":{"backend/app/routers/export.py":{"backupFileName":null,"version":1,"backupTime":"2026-01-10T17:28:16.452Z"}},"timestamp":"2026-01-10T17:26:46.087Z"},"isSnapshotUpdate":true}
{"parentUuid":"cd19c5fa-b1c6-4fbb-82a3-59cd8141a739","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01171ewd3tgdHcLxK9SPxVqC","type":"tool_result","content":"File created successfully at: /Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/backend/app/routers/export.py"}]},"uuid":"89f1e9b7-fc77-4077-92c7-892b463fb61a","timestamp":"2026-01-10T17:28:16.487Z","toolUseResult":{"type":"create","filePath":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/backend/app/routers/export.py","content":"\"\"\"\nExport router for downloading complete notebook data.\nSupports JSON and ZIP export formats.\n\"\"\"\n\nfrom fastapi import APIRouter, HTTPException, Depends\nfrom fastapi.responses import StreamingResponse\nfrom typing import Optional\nfrom uuid import UUID\nimport json\nimport zipfile\nimport io\nfrom datetime import datetime\n\nfrom app.services.auth import get_current_user\nfrom app.services.supabase_client import get_supabase_client\n\nrouter = APIRouter(prefix=\"/notebooks/{notebook_id}/export\", tags=[\"export\"])\n\n\nasync def get_notebook_data(\n    notebook_id: str,\n    user_id: str,\n    include_sources: bool = True,\n    include_chats: bool = True,\n    include_notes: bool = True,\n    include_generated: bool = True,\n) -> dict:\n    \"\"\"Gather all notebook data for export.\"\"\"\n    supabase = get_supabase_client()\n\n    # Verify notebook access and get metadata\n    notebook_result = (\n        supabase.table(\"notebooks\")\n        .select(\"*\")\n        .eq(\"id\", notebook_id)\n        .eq(\"user_id\", user_id)\n        .single()\n        .execute()\n    )\n\n    if not notebook_result.data:\n        raise HTTPException(status_code=404, detail=\"Notebook not found\")\n\n    notebook = notebook_result.data\n    export_data = {\n        \"notebook\": {\n            \"id\": notebook[\"id\"],\n            \"name\": notebook[\"name\"],\n            \"description\": notebook.get(\"description\"),\n            \"emoji\": notebook.get(\"emoji\"),\n            \"settings\": notebook.get(\"settings\", {}),\n            \"created_at\": notebook[\"created_at\"],\n        },\n        \"exported_at\": datetime.utcnow().isoformat(),\n        \"export_version\": \"1.0\",\n    }\n\n    # Sources\n    if include_sources:\n        sources_result = (\n            supabase.table(\"sources\")\n            .select(\"*\")\n            .eq(\"notebook_id\", notebook_id)\n            .order(\"created_at\", desc=False)\n            .execute()\n        )\n        export_data[\"sources\"] = sources_result.data or []\n\n    # Chat sessions and messages\n    if include_chats:\n        sessions_result = (\n            supabase.table(\"chat_sessions\")\n            .select(\"*\")\n            .eq(\"notebook_id\", notebook_id)\n            .order(\"created_at\", desc=False)\n            .execute()\n        )\n        sessions = sessions_result.data or []\n\n        for session in sessions:\n            messages_result = (\n                supabase.table(\"chat_messages\")\n                .select(\"*\")\n                .eq(\"session_id\", session[\"id\"])\n                .order(\"created_at\", desc=False)\n                .execute()\n            )\n            session[\"messages\"] = messages_result.data or []\n\n        export_data[\"chat_sessions\"] = sessions\n\n    # Notes\n    if include_notes:\n        notes_result = (\n            supabase.table(\"notes\")\n            .select(\"*\")\n            .eq(\"notebook_id\", notebook_id)\n            .order(\"created_at\", desc=False)\n            .execute()\n        )\n        export_data[\"notes\"] = notes_result.data or []\n\n    # Generated content\n    if include_generated:\n        # Audio overviews\n        audio_result = (\n            supabase.table(\"audio_overviews\")\n            .select(\"*\")\n            .eq(\"notebook_id\", notebook_id)\n            .execute()\n        )\n        export_data[\"audio_overviews\"] = audio_result.data or []\n\n        # Video overviews\n        video_result = (\n            supabase.table(\"video_overviews\")\n            .select(\"*\")\n            .eq(\"notebook_id\", notebook_id)\n            .execute()\n        )\n        export_data[\"video_overviews\"] = video_result.data or []\n\n        # Study materials\n        study_result = (\n            supabase.table(\"study_materials\")\n            .select(\"*\")\n            .eq(\"notebook_id\", notebook_id)\n            .execute()\n        )\n        export_data[\"study_materials\"] = study_result.data or []\n\n        # Studio outputs\n        studio_result = (\n            supabase.table(\"studio_outputs\")\n            .select(\"*\")\n            .eq(\"notebook_id\", notebook_id)\n            .execute()\n        )\n        export_data[\"studio_outputs\"] = studio_result.data or []\n\n        # Research tasks\n        research_result = (\n            supabase.table(\"research_tasks\")\n            .select(\"*\")\n            .eq(\"notebook_id\", notebook_id)\n            .execute()\n        )\n        export_data[\"research_tasks\"] = research_result.data or []\n\n    return export_data\n\n\n@router.get(\"/json\")\nasync def export_notebook_json(\n    notebook_id: UUID,\n    include_sources: bool = True,\n    include_chats: bool = True,\n    include_notes: bool = True,\n    include_generated: bool = True,\n    user: dict = Depends(get_current_user),\n):\n    \"\"\"Export notebook data as JSON.\"\"\"\n    export_data = await get_notebook_data(\n        str(notebook_id),\n        user[\"id\"],\n        include_sources,\n        include_chats,\n        include_notes,\n        include_generated,\n    )\n\n    return export_data\n\n\n@router.get(\"/zip\")\nasync def export_notebook_zip(\n    notebook_id: UUID,\n    include_sources: bool = True,\n    include_chats: bool = True,\n    include_notes: bool = True,\n    include_generated: bool = True,\n    user: dict = Depends(get_current_user),\n):\n    \"\"\"Export notebook as ZIP with all files.\"\"\"\n    supabase = get_supabase_client()\n\n    export_data = await get_notebook_data(\n        str(notebook_id),\n        user[\"id\"],\n        include_sources,\n        include_chats,\n        include_notes,\n        include_generated,\n    )\n\n    notebook_name = export_data[\"notebook\"][\"name\"]\n    safe_name = \"\".join(c if c.isalnum() or c in \" -_\" else \"_\" for c in notebook_name)\n    date_str = datetime.utcnow().strftime(\"%Y%m%d\")\n    zip_name = f\"notebook-export-{safe_name}-{date_str}\"\n\n    # Create ZIP in memory\n    zip_buffer = io.BytesIO()\n\n    with zipfile.ZipFile(zip_buffer, \"w\", zipfile.ZIP_DEFLATED) as zf:\n        # Notebook metadata\n        zf.writestr(\n            f\"{zip_name}/notebook.json\",\n            json.dumps(export_data[\"notebook\"], indent=2, default=str)\n        )\n\n        # README\n        readme_content = f\"\"\"# {notebook_name} Export\n\nExported from NotebookLM Reimagined on {datetime.utcnow().strftime(\"%Y-%m-%d %H:%M UTC\")}\n\n## Contents\n\n- `notebook.json` - Notebook metadata (name, description, settings)\n- `sources/` - Source documents and metadata\n- `chats/` - Chat sessions and messages\n- `notes/` - User notes\n- `generated/` - AI-generated content (audio, video, study materials, etc.)\n\n## Re-importing\n\nThis export can be used as a backup. To re-import, use the NotebookLM Reimagined import feature.\n\"\"\"\n        zf.writestr(f\"{zip_name}/README.md\", readme_content)\n\n        # Sources\n        if include_sources and export_data.get(\"sources\"):\n            sources_index = []\n            for source in export_data[\"sources\"]:\n                source_info = {\n                    \"id\": source[\"id\"],\n                    \"name\": source[\"name\"],\n                    \"type\": source[\"type\"],\n                    \"status\": source[\"status\"],\n                    \"created_at\": source[\"created_at\"],\n                    \"metadata\": source.get(\"metadata\"),\n                    \"source_guide\": source.get(\"source_guide\"),\n                }\n                sources_index.append(source_info)\n\n                # Try to download actual file from storage\n                if source.get(\"file_path\"):\n                    try:\n                        file_data = supabase.storage.from_(\"sources\").download(source[\"file_path\"])\n                        if file_data:\n                            filename = source.get(\"original_filename\") or source[\"name\"]\n                            zf.writestr(f\"{zip_name}/sources/files/{filename}\", file_data)\n                            source_info[\"exported_file\"] = f\"files/{filename}\"\n                    except Exception as e:\n                        source_info[\"export_error\"] = str(e)\n\n                # For text sources, include content\n                if source[\"type\"] == \"text\" and source.get(\"metadata\"):\n                    metadata = source[\"metadata\"] or {}\n                    if content := metadata.get(\"content\"):\n                        filename = f\"{source['id']}.txt\"\n                        zf.writestr(f\"{zip_name}/sources/text/{filename}\", content)\n                        source_info[\"exported_file\"] = f\"text/{filename}\"\n\n            zf.writestr(\n                f\"{zip_name}/sources/index.json\",\n                json.dumps(sources_index, indent=2, default=str)\n            )\n\n        # Chats\n        if include_chats and export_data.get(\"chat_sessions\"):\n            sessions_index = []\n            for session in export_data[\"chat_sessions\"]:\n                session_info = {\n                    \"id\": session[\"id\"],\n                    \"title\": session.get(\"title\"),\n                    \"created_at\": session[\"created_at\"],\n                    \"message_count\": len(session.get(\"messages\", [])),\n                }\n                sessions_index.append(session_info)\n\n                # Individual session file\n                zf.writestr(\n                    f\"{zip_name}/chats/session-{session['id']}.json\",\n                    json.dumps(session, indent=2, default=str)\n                )\n\n            zf.writestr(\n                f\"{zip_name}/chats/index.json\",\n                json.dumps(sessions_index, indent=2, default=str)\n            )\n\n        # Notes\n        if include_notes and export_data.get(\"notes\"):\n            zf.writestr(\n                f\"{zip_name}/notes/index.json\",\n                json.dumps(export_data[\"notes\"], indent=2, default=str)\n            )\n\n        # Generated content\n        if include_generated:\n            generated_index = {\n                \"audio_overviews\": [],\n                \"video_overviews\": [],\n                \"study_materials\": [],\n                \"studio_outputs\": [],\n                \"research_tasks\": [],\n            }\n\n            # Audio\n            for audio in export_data.get(\"audio_overviews\", []):\n                audio_info = {\n                    \"id\": audio[\"id\"],\n                    \"format\": audio.get(\"format\"),\n                    \"status\": audio.get(\"status\"),\n                    \"created_at\": audio.get(\"created_at\"),\n                }\n                generated_index[\"audio_overviews\"].append(audio_info)\n\n                # Save script\n                if audio.get(\"script\"):\n                    zf.writestr(\n                        f\"{zip_name}/generated/audio/{audio['id']}_script.json\",\n                        json.dumps(audio[\"script\"], indent=2, default=str)\n                    )\n\n                # Try to download audio file\n                if audio.get(\"audio_file_path\"):\n                    try:\n                        audio_data = supabase.storage.from_(\"audio\").download(audio[\"audio_file_path\"])\n                        if audio_data:\n                            zf.writestr(f\"{zip_name}/generated/audio/{audio['id']}.mp3\", audio_data)\n                            audio_info[\"exported_file\"] = f\"{audio['id']}.mp3\"\n                    except Exception:\n                        pass\n\n            # Video\n            for video in export_data.get(\"video_overviews\", []):\n                video_info = {\n                    \"id\": video[\"id\"],\n                    \"style\": video.get(\"style\"),\n                    \"status\": video.get(\"status\"),\n                    \"created_at\": video.get(\"created_at\"),\n                }\n                generated_index[\"video_overviews\"].append(video_info)\n\n                if video.get(\"script\"):\n                    zf.writestr(\n                        f\"{zip_name}/generated/video/{video['id']}_script.json\",\n                        json.dumps(video[\"script\"], indent=2, default=str)\n                    )\n\n            # Study materials\n            for material in export_data.get(\"study_materials\", []):\n                material_info = {\n                    \"id\": material[\"id\"],\n                    \"type\": material.get(\"type\"),\n                    \"created_at\": material.get(\"created_at\"),\n                }\n                generated_index[\"study_materials\"].append(material_info)\n\n                zf.writestr(\n                    f\"{zip_name}/generated/study-materials/{material['type']}_{material['id']}.json\",\n                    json.dumps(material, indent=2, default=str)\n                )\n\n            # Studio outputs\n            for output in export_data.get(\"studio_outputs\", []):\n                output_info = {\n                    \"id\": output[\"id\"],\n                    \"type\": output.get(\"type\"),\n                    \"title\": output.get(\"title\"),\n                    \"created_at\": output.get(\"created_at\"),\n                }\n                generated_index[\"studio_outputs\"].append(output_info)\n\n                zf.writestr(\n                    f\"{zip_name}/generated/studio/{output['type']}_{output['id']}.json\",\n                    json.dumps(output, indent=2, default=str)\n                )\n\n            # Research tasks\n            for research in export_data.get(\"research_tasks\", []):\n                research_info = {\n                    \"id\": research[\"id\"],\n                    \"query\": research.get(\"query\"),\n                    \"status\": research.get(\"status\"),\n                    \"created_at\": research.get(\"created_at\"),\n                }\n                generated_index[\"research_tasks\"].append(research_info)\n\n                zf.writestr(\n                    f\"{zip_name}/generated/research/{research['id']}.json\",\n                    json.dumps(research, indent=2, default=str)\n                )\n\n            zf.writestr(\n                f\"{zip_name}/generated/index.json\",\n                json.dumps(generated_index, indent=2, default=str)\n            )\n\n    zip_buffer.seek(0)\n\n    return StreamingResponse(\n        zip_buffer,\n        media_type=\"application/zip\",\n        headers={\n            \"Content-Disposition\": f'attachment; filename=\"{zip_name}.zip\"',\n        },\n    )\n","structuredPatch":[],"originalFile":null},"sourceToolAssistantUUID":"cd19c5fa-b1c6-4fbb-82a3-59cd8141a739"}
{"parentUuid":"89f1e9b7-fc77-4077-92c7-892b463fb61a","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Gp92rCC9QHTjVuK3krb4kP","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Now let me update the todo list and register the router in main.py.","signature":"EusBCkYICxgCKkA/nG2tin3AGbMsJ/5WPuGGYVJl1EO0rYTWr3pXuBc2Zsf8Ap8DV96Fa5PMjzHdavOWfuVTLgggUVVPO8AR28ArEgyN843iiGiWjL+QkegaDGZSJnLx/NQ6xkN6HSIwN/lx+bv62bhV18yfDYMEu1t1xg+J2MtcoOJU9wwMl1hkwx0y70KQ0NF2ejJXkKbLKlPghthooimT+A3+sA8JYBo8uypBRFpFeU5ZB/b2x0rRa7A7+nSKvtrMG6V7QgEHgk6Aq1fmUAbsDm7kbbT6DVRW57EF2jK1M7uVOxCSo/TyCW82pxgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":3958,"cache_read_input_tokens":69482,"cache_creation":{"ephemeral_5m_input_tokens":3958,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CWz6GpDzGM95NfXeuFzWX","type":"assistant","uuid":"652dbcd2-455a-44fe-af0d-f2c670be6653","timestamp":"2026-01-10T17:28:21.367Z"}
{"parentUuid":"652dbcd2-455a-44fe-af0d-f2c670be6653","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Gp92rCC9QHTjVuK3krb4kP","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01AV5Wd6ZYYiVui9FXczkqHu","name":"TodoWrite","input":{"todos":[{"content":"Create backend export router (export.py)","status":"completed","activeForm":"Creating backend export router"},{"content":"Register export router in main.py","status":"in_progress","activeForm":"Registering export router in main.py"},{"content":"Create frontend API route for export","status":"pending","activeForm":"Creating frontend API route for export"},{"content":"Expand export-utils.ts with notebook export functions","status":"pending","activeForm":"Expanding export-utils.ts"},{"content":"Add export UI to studio-panel.tsx","status":"pending","activeForm":"Adding export UI to studio-panel.tsx"},{"content":"Test the export functionality","status":"pending","activeForm":"Testing export functionality"}]}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":3958,"cache_read_input_tokens":69482,"cache_creation":{"ephemeral_5m_input_tokens":3958,"ephemeral_1h_input_tokens":0},"output_tokens":269,"service_tier":"standard"}},"requestId":"req_011CWz6GpDzGM95NfXeuFzWX","type":"assistant","uuid":"79ee5703-53dd-4b94-bbf4-4ba53b29f35f","timestamp":"2026-01-10T17:28:24.508Z"}
{"parentUuid":"79ee5703-53dd-4b94-bbf4-4ba53b29f35f","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01AV5Wd6ZYYiVui9FXczkqHu","type":"tool_result","content":"Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable"}]},"uuid":"9d875e6b-6377-40fd-a278-d57aaadf3d68","timestamp":"2026-01-10T17:28:24.536Z","toolUseResult":{"oldTodos":[{"content":"Create backend export router (export.py)","status":"in_progress","activeForm":"Creating backend export router"},{"content":"Register export router in main.py","status":"pending","activeForm":"Registering export router in main.py"},{"content":"Create frontend API route for export","status":"pending","activeForm":"Creating frontend API route for export"},{"content":"Expand export-utils.ts with notebook export functions","status":"pending","activeForm":"Expanding export-utils.ts"},{"content":"Add export UI to studio-panel.tsx","status":"pending","activeForm":"Adding export UI to studio-panel.tsx"},{"content":"Test the export functionality","status":"pending","activeForm":"Testing export functionality"}],"newTodos":[{"content":"Create backend export router (export.py)","status":"completed","activeForm":"Creating backend export router"},{"content":"Register export router in main.py","status":"in_progress","activeForm":"Registering export router in main.py"},{"content":"Create frontend API route for export","status":"pending","activeForm":"Creating frontend API route for export"},{"content":"Expand export-utils.ts with notebook export functions","status":"pending","activeForm":"Expanding export-utils.ts"},{"content":"Add export UI to studio-panel.tsx","status":"pending","activeForm":"Adding export UI to studio-panel.tsx"},{"content":"Test the export functionality","status":"pending","activeForm":"Testing export functionality"}]},"sourceToolAssistantUUID":"79ee5703-53dd-4b94-bbf4-4ba53b29f35f"}
{"parentUuid":"9d875e6b-6377-40fd-a278-d57aaadf3d68","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","message":{"model":"claude-opus-4-5-20251101","id":"msg_0178syrM4X4ieecZe7WLbh1u","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Now let me register the export router in main.py.","signature":"EtkBCkYICxgCKkDFnLiypCPtv2R7SmPNhzSOakz74MUYlaGMwCPYNjoGaodO64UDK5d8iDQ1zw4pZrU0wlfmhd6/zfzoXBrkquc2Egw8qCEKbbOrqpWs16AaDM+dMi/OLtq8onQgMiIwFW2zaEqTmlPjegW2AtmVxvMbWpHq4DjCbC2nCAvFeJ/iwL7MN+4K1xvQ/eQV4FLFKkEkONRzXf7q+iC38QfoXY+4i9xRwhRMB//hzJd0O2uXDcRSMtfe3YSTZZzHf5M7T6ajg1iNqvryUzuj7cXPhysHcBgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":318,"cache_read_input_tokens":73440,"cache_creation":{"ephemeral_5m_input_tokens":318,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWz6HQYEW7ZUbXxTA499Y","type":"assistant","uuid":"35ab0333-7abf-402c-ae1b-2e438cdb8765","timestamp":"2026-01-10T17:28:29.288Z"}
{"parentUuid":"35ab0333-7abf-402c-ae1b-2e438cdb8765","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","message":{"model":"claude-opus-4-5-20251101","id":"msg_0178syrM4X4ieecZe7WLbh1u","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_014ufBtwHFZRRw3sLcFXK4qb","name":"Edit","input":{"replace_all":false,"file_path":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/backend/app/main.py","old_string":"from app.routers import notebooks, sources, chat, audio, video, research, study, notes, api_keys, global_chat, studio","new_string":"from app.routers import notebooks, sources, chat, audio, video, research, study, notes, api_keys, global_chat, studio, export"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":318,"cache_read_input_tokens":73440,"cache_creation":{"ephemeral_5m_input_tokens":318,"ephemeral_1h_input_tokens":0},"output_tokens":203,"service_tier":"standard"}},"requestId":"req_011CWz6HQYEW7ZUbXxTA499Y","type":"assistant","uuid":"8699eb4c-a6b6-412c-aef3-056c3b56689d","timestamp":"2026-01-10T17:28:31.067Z"}
{"type":"file-history-snapshot","messageId":"8699eb4c-a6b6-412c-aef3-056c3b56689d","snapshot":{"messageId":"973ebb96-60df-4671-b9c2-0c4aefc8516e","trackedFileBackups":{"backend/app/routers/export.py":{"backupFileName":null,"version":1,"backupTime":"2026-01-10T17:28:16.452Z"},"backend/app/main.py":{"backupFileName":"f16da9f396306523@v1","version":1,"backupTime":"2026-01-10T17:28:31.217Z"}},"timestamp":"2026-01-10T17:26:46.087Z"},"isSnapshotUpdate":true}
{"parentUuid":"8699eb4c-a6b6-412c-aef3-056c3b56689d","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_014ufBtwHFZRRw3sLcFXK4qb","type":"tool_result","content":"The file /Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/backend/app/main.py has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n     3→from fastapi.responses import JSONResponse\n     4→import uuid\n     5→\n     6→from app.config import get_settings\n     7→from app.routers import notebooks, sources, chat, audio, video, research, study, notes, api_keys, global_chat, studio, export\n     8→\n     9→settings = get_settings()\n    10→\n    11→app = FastAPI("}]},"uuid":"6d375672-b799-4a7f-8c78-655987977a78","timestamp":"2026-01-10T17:28:31.211Z","toolUseResult":{"filePath":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/backend/app/main.py","oldString":"from app.routers import notebooks, sources, chat, audio, video, research, study, notes, api_keys, global_chat, studio","newString":"from app.routers import notebooks, sources, chat, audio, video, research, study, notes, api_keys, global_chat, studio, export","originalFile":"from fastapi import FastAPI, HTTPException, Request\nfrom fastapi.middleware.cors import CORSMiddleware\nfrom fastapi.responses import JSONResponse\nimport uuid\n\nfrom app.config import get_settings\nfrom app.routers import notebooks, sources, chat, audio, video, research, study, notes, api_keys, global_chat, studio\n\nsettings = get_settings()\n\napp = FastAPI(\n    title=settings.app_name,\n    description=\"NotebookLM Reimagined - An API-first research intelligence platform\",\n    version=\"1.0.0\",\n    docs_url=\"/docs\",\n    redoc_url=\"/redoc\",\n)\n\n# CORS middleware\napp.add_middleware(\n    CORSMiddleware,\n    allow_origins=[\"*\"],  # Configure appropriately for production\n    allow_credentials=True,\n    allow_methods=[\"*\"],\n    allow_headers=[\"*\"],\n)\n\n\n# Request ID middleware\n@app.middleware(\"http\")\nasync def add_request_id(request: Request, call_next):\n    request_id = str(uuid.uuid4())[:8]\n    request.state.request_id = request_id\n    response = await call_next(request)\n    response.headers[\"X-Request-ID\"] = request_id\n    return response\n\n\n# Exception handlers\n@app.exception_handler(HTTPException)\nasync def http_exception_handler(request: Request, exc: HTTPException):\n    return JSONResponse(\n        status_code=exc.status_code,\n        content={\n            \"error\": {\n                \"code\": exc.status_code,\n                \"message\": exc.detail,\n            }\n        },\n    )\n\n\n@app.exception_handler(Exception)\nasync def general_exception_handler(request: Request, exc: Exception):\n    return JSONResponse(\n        status_code=500,\n        content={\n            \"error\": {\n                \"code\": 500,\n                \"message\": \"Internal server error\",\n                \"details\": str(exc) if settings.debug else None,\n            }\n        },\n    )\n\n\n# Include routers\napp.include_router(api_keys.router, prefix=\"/api/v1\")\napp.include_router(notebooks.router, prefix=\"/api/v1\")\napp.include_router(sources.router, prefix=\"/api/v1\")\napp.include_router(chat.router, prefix=\"/api/v1\")\napp.include_router(audio.router, prefix=\"/api/v1\")\napp.include_router(video.router, prefix=\"/api/v1\")\napp.include_router(research.router, prefix=\"/api/v1\")\napp.include_router(study.router, prefix=\"/api/v1\")\napp.include_router(notes.router, prefix=\"/api/v1\")\napp.include_router(studio.router, prefix=\"/api/v1\")\napp.include_router(global_chat.router, prefix=\"/api/v1\")\n\n\n@app.get(\"/\")\nasync def root():\n    return {\n        \"name\": settings.app_name,\n        \"version\": \"1.0.0\",\n        \"docs\": \"/docs\",\n    }\n\n\n@app.get(\"/health\")\nasync def health():\n    return {\"status\": \"healthy\"}\n\n\nif __name__ == \"__main__\":\n    import uvicorn\n    uvicorn.run(app, host=\"0.0.0.0\", port=8000)\n","structuredPatch":[{"oldStart":4,"oldLines":7,"newStart":4,"newLines":7,"lines":[" import uuid"," "," from app.config import get_settings","-from app.routers import notebooks, sources, chat, audio, video, research, study, notes, api_keys, global_chat, studio","+from app.routers import notebooks, sources, chat, audio, video, research, study, notes, api_keys, global_chat, studio, export"," "," settings = get_settings()"," "]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"8699eb4c-a6b6-412c-aef3-056c3b56689d"}
{"parentUuid":"6d375672-b799-4a7f-8c78-655987977a78","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","message":{"model":"claude-opus-4-5-20251101","id":"msg_01JbkyveqFZu7cEDiYZ6cBka","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Now I need to add the include_router call for the export router.","signature":"EugBCkYICxgCKkBUk8hwBGfMHUFmPgQ1CP3dAZ88h7Z3QJgEwaxlYC35rWnP8xyVmuLqZCP7Ij36dYkx+ejuJpO5v/A9smf5ng8XEgzXvQG2WKSdPPMI3PQaDJN+pJVvqx+CrDTTcSIw5jDiqRk0TtRvjjbZQwjanrJVpGVlt/0z7K+/ausU56pBoWZiv/3H4cmCvzGZ6W1WKlDXM5eff11bExZGjzt7nIsyLdHqHnwRvMWZDO2KlROgX5boYISoqmb+t4B3fuaYU3gbreFlmINaPlhKoUD7QZQTgVESPMaqoD3C2N/UCSp2LxgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":395,"cache_read_input_tokens":73758,"cache_creation":{"ephemeral_5m_input_tokens":395,"ephemeral_1h_input_tokens":0},"output_tokens":7,"service_tier":"standard"}},"requestId":"req_011CWz6HufC9BYmmVt3xdx4i","type":"assistant","uuid":"0df49455-55da-409b-a2a4-fef7e1b09ca5","timestamp":"2026-01-10T17:28:35.077Z"}
{"parentUuid":"0df49455-55da-409b-a2a4-fef7e1b09ca5","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","message":{"model":"claude-opus-4-5-20251101","id":"msg_01JbkyveqFZu7cEDiYZ6cBka","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_011fmS1XCyTa9DWKGUXR2sT1","name":"Edit","input":{"replace_all":false,"file_path":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/backend/app/main.py","old_string":"app.include_router(global_chat.router, prefix=\"/api/v1\")","new_string":"app.include_router(global_chat.router, prefix=\"/api/v1\")\napp.include_router(export.router, prefix=\"/api/v1\")"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":395,"cache_read_input_tokens":73758,"cache_creation":{"ephemeral_5m_input_tokens":395,"ephemeral_1h_input_tokens":0},"output_tokens":198,"service_tier":"standard"}},"requestId":"req_011CWz6HufC9BYmmVt3xdx4i","type":"assistant","uuid":"88e8fe1c-b0d4-4f0a-bbfd-4e42ac3d4eca","timestamp":"2026-01-10T17:28:36.345Z"}
{"parentUuid":"88e8fe1c-b0d4-4f0a-bbfd-4e42ac3d4eca","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_011fmS1XCyTa9DWKGUXR2sT1","type":"tool_result","content":"The file /Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/backend/app/main.py has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n    74→app.include_router(research.router, prefix=\"/api/v1\")\n    75→app.include_router(study.router, prefix=\"/api/v1\")\n    76→app.include_router(notes.router, prefix=\"/api/v1\")\n    77→app.include_router(studio.router, prefix=\"/api/v1\")\n    78→app.include_router(global_chat.router, prefix=\"/api/v1\")\n    79→app.include_router(export.router, prefix=\"/api/v1\")\n    80→\n    81→\n    82→@app.get(\"/\")\n    83→async def root():"}]},"uuid":"2293141f-6aa9-461c-9d13-3a3d47866e36","timestamp":"2026-01-10T17:28:36.387Z","toolUseResult":{"filePath":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/backend/app/main.py","oldString":"app.include_router(global_chat.router, prefix=\"/api/v1\")","newString":"app.include_router(global_chat.router, prefix=\"/api/v1\")\napp.include_router(export.router, prefix=\"/api/v1\")","originalFile":"from fastapi import FastAPI, HTTPException, Request\nfrom fastapi.middleware.cors import CORSMiddleware\nfrom fastapi.responses import JSONResponse\nimport uuid\n\nfrom app.config import get_settings\nfrom app.routers import notebooks, sources, chat, audio, video, research, study, notes, api_keys, global_chat, studio, export\n\nsettings = get_settings()\n\napp = FastAPI(\n    title=settings.app_name,\n    description=\"NotebookLM Reimagined - An API-first research intelligence platform\",\n    version=\"1.0.0\",\n    docs_url=\"/docs\",\n    redoc_url=\"/redoc\",\n)\n\n# CORS middleware\napp.add_middleware(\n    CORSMiddleware,\n    allow_origins=[\"*\"],  # Configure appropriately for production\n    allow_credentials=True,\n    allow_methods=[\"*\"],\n    allow_headers=[\"*\"],\n)\n\n\n# Request ID middleware\n@app.middleware(\"http\")\nasync def add_request_id(request: Request, call_next):\n    request_id = str(uuid.uuid4())[:8]\n    request.state.request_id = request_id\n    response = await call_next(request)\n    response.headers[\"X-Request-ID\"] = request_id\n    return response\n\n\n# Exception handlers\n@app.exception_handler(HTTPException)\nasync def http_exception_handler(request: Request, exc: HTTPException):\n    return JSONResponse(\n        status_code=exc.status_code,\n        content={\n            \"error\": {\n                \"code\": exc.status_code,\n                \"message\": exc.detail,\n            }\n        },\n    )\n\n\n@app.exception_handler(Exception)\nasync def general_exception_handler(request: Request, exc: Exception):\n    return JSONResponse(\n        status_code=500,\n        content={\n            \"error\": {\n                \"code\": 500,\n                \"message\": \"Internal server error\",\n                \"details\": str(exc) if settings.debug else None,\n            }\n        },\n    )\n\n\n# Include routers\napp.include_router(api_keys.router, prefix=\"/api/v1\")\napp.include_router(notebooks.router, prefix=\"/api/v1\")\napp.include_router(sources.router, prefix=\"/api/v1\")\napp.include_router(chat.router, prefix=\"/api/v1\")\napp.include_router(audio.router, prefix=\"/api/v1\")\napp.include_router(video.router, prefix=\"/api/v1\")\napp.include_router(research.router, prefix=\"/api/v1\")\napp.include_router(study.router, prefix=\"/api/v1\")\napp.include_router(notes.router, prefix=\"/api/v1\")\napp.include_router(studio.router, prefix=\"/api/v1\")\napp.include_router(global_chat.router, prefix=\"/api/v1\")\n\n\n@app.get(\"/\")\nasync def root():\n    return {\n        \"name\": settings.app_name,\n        \"version\": \"1.0.0\",\n        \"docs\": \"/docs\",\n    }\n\n\n@app.get(\"/health\")\nasync def health():\n    return {\"status\": \"healthy\"}\n\n\nif __name__ == \"__main__\":\n    import uvicorn\n    uvicorn.run(app, host=\"0.0.0.0\", port=8000)\n","structuredPatch":[{"oldStart":76,"oldLines":6,"newStart":76,"newLines":7,"lines":[" app.include_router(notes.router, prefix=\"/api/v1\")"," app.include_router(studio.router, prefix=\"/api/v1\")"," app.include_router(global_chat.router, prefix=\"/api/v1\")","+app.include_router(export.router, prefix=\"/api/v1\")"," "," "," @app.get(\"/\")"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"88e8fe1c-b0d4-4f0a-bbfd-4e42ac3d4eca"}
{"parentUuid":"2293141f-6aa9-461c-9d13-3a3d47866e36","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","message":{"model":"claude-opus-4-5-20251101","id":"msg_01WkaAarqeqdtTH7YWraNecp","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Now let me update the todo and create the frontend API route.","signature":"EuUBCkYICxgCKkCYQM+FOB9emO7BrbciKuP4tQO+rCYvJhJb83iRmyAoc6oH0muCIlRG/Ysgb+PdORJHcbRudYPn9gupszC1voVzEgy09X/GJsSh8H9ZiPIaDIMw7DO0YxLBMnPzBiIwt17c7HToufBzD8ZlW+NjENU4J6s2EhPknLHBi6wCvxCWM/CGWtcwjQd22qOQ1jR5Kk2FhAAKbwRmlqr5g7S9gt9U+SXSFSWKHMQDc5uwyYGoVuN/XX/W8Q/yakV9aJIhv/RbMBYZYURbwyJ+R+DQ9aCOgA1BiygFEjoYwO3PVBgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":446,"cache_read_input_tokens":74153,"cache_creation":{"ephemeral_5m_input_tokens":446,"ephemeral_1h_input_tokens":0},"output_tokens":7,"service_tier":"standard"}},"requestId":"req_011CWz6JHw9PNqnxmg7Un34Y","type":"assistant","uuid":"7f41fc9d-4b69-4913-af28-dee989e540da","timestamp":"2026-01-10T17:28:40.058Z"}
{"parentUuid":"7f41fc9d-4b69-4913-af28-dee989e540da","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","message":{"model":"claude-opus-4-5-20251101","id":"msg_01WkaAarqeqdtTH7YWraNecp","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Vh1i2YkYQYwsoHsGhoDWn7","name":"TodoWrite","input":{"todos":[{"content":"Create backend export router (export.py)","status":"completed","activeForm":"Creating backend export router"},{"content":"Register export router in main.py","status":"completed","activeForm":"Registering export router in main.py"},{"content":"Create frontend API route for export","status":"in_progress","activeForm":"Creating frontend API route for export"},{"content":"Expand export-utils.ts with notebook export functions","status":"pending","activeForm":"Expanding export-utils.ts"},{"content":"Add export UI to studio-panel.tsx","status":"pending","activeForm":"Adding export UI to studio-panel.tsx"},{"content":"Test the export functionality","status":"pending","activeForm":"Testing export functionality"}]}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":446,"cache_read_input_tokens":74153,"cache_creation":{"ephemeral_5m_input_tokens":446,"ephemeral_1h_input_tokens":0},"output_tokens":266,"service_tier":"standard"}},"requestId":"req_011CWz6JHw9PNqnxmg7Un34Y","type":"assistant","uuid":"bf72b031-fa62-47fe-8754-7abc470e4236","timestamp":"2026-01-10T17:28:41.740Z"}
{"parentUuid":"bf72b031-fa62-47fe-8754-7abc470e4236","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Vh1i2YkYQYwsoHsGhoDWn7","type":"tool_result","content":"Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable"}]},"uuid":"ed36929c-8875-4469-96b0-96546cb2d407","timestamp":"2026-01-10T17:28:41.763Z","toolUseResult":{"oldTodos":[{"content":"Create backend export router (export.py)","status":"completed","activeForm":"Creating backend export router"},{"content":"Register export router in main.py","status":"in_progress","activeForm":"Registering export router in main.py"},{"content":"Create frontend API route for export","status":"pending","activeForm":"Creating frontend API route for export"},{"content":"Expand export-utils.ts with notebook export functions","status":"pending","activeForm":"Expanding export-utils.ts"},{"content":"Add export UI to studio-panel.tsx","status":"pending","activeForm":"Adding export UI to studio-panel.tsx"},{"content":"Test the export functionality","status":"pending","activeForm":"Testing export functionality"}],"newTodos":[{"content":"Create backend export router (export.py)","status":"completed","activeForm":"Creating backend export router"},{"content":"Register export router in main.py","status":"completed","activeForm":"Registering export router in main.py"},{"content":"Create frontend API route for export","status":"in_progress","activeForm":"Creating frontend API route for export"},{"content":"Expand export-utils.ts with notebook export functions","status":"pending","activeForm":"Expanding export-utils.ts"},{"content":"Add export UI to studio-panel.tsx","status":"pending","activeForm":"Adding export UI to studio-panel.tsx"},{"content":"Test the export functionality","status":"pending","activeForm":"Testing export functionality"}]},"sourceToolAssistantUUID":"bf72b031-fa62-47fe-8754-7abc470e4236"}
{"parentUuid":"ed36929c-8875-4469-96b0-96546cb2d407","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","message":{"model":"claude-opus-4-5-20251101","id":"msg_01VjgWfkP6fyrRTjTHuqwphE","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Now let me create the frontend API route for export. I'll follow the pattern used by the sources route, but for export functionality. The export route will handle both JSON and ZIP downloads.","signature":"EugCCkYICxgCKkCDScN+39lkmX9EGd0wz4ZHYUaGSfyitXKqBhgkKSc6g4wJ/Mtr06s87SB1Vb2JQU/A5CM/se11ay/49Zrvtcm3EgyARmUnysc8WWFG910aDDy+AtZ5unTwloT1ISIwZvq2WyqmbweVkrf8a0jzeGH92WvHxPgjRAjf9ZSK79rm8WoNMa4pI3i6FvPAPFJSKs8BTU+umaejr9VxTpO9NGtNEAJcygiKR3pn/T7sFpi+mb0dnOwG4BcGMfNNIfEsnvVVlX7W/y60e3kSJKlNh+Utcau+GoDVUOOOlPaVh6LRDolw2Kv4EcXMWhZg0gt7k2SMjR2Za0UM5HPwh1ovNou6qpz26UYKbqtbGzbGwD/iqMZXoI4y50iS2VSBPpFT65Njuuq3yEen9Xdwy5V9JGaCo9X5jTnwbxQdnOKvr5WC/HjOo6mODJlRVrdYoicMcmUN/r9FkES6KUHhsL9ATUGEGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":315,"cache_read_input_tokens":74599,"cache_creation":{"ephemeral_5m_input_tokens":315,"ephemeral_1h_input_tokens":0},"output_tokens":5,"service_tier":"standard"}},"requestId":"req_011CWz6JgaR3wiaPAm76DoPz","type":"assistant","uuid":"8d3243c7-565c-4427-86b3-4f66f3cd99b2","timestamp":"2026-01-10T17:28:46.116Z"}
{"parentUuid":"8d3243c7-565c-4427-86b3-4f66f3cd99b2","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","message":{"model":"claude-opus-4-5-20251101","id":"msg_01VjgWfkP6fyrRTjTHuqwphE","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_0175pw53PiXxArwoGAk5NWJG","name":"Bash","input":{"command":"mkdir -p /Users/marwankashef/Desktop/YouTube/NotebookLM\\ Re-Mastered/frontend/src/app/api/notebooks/\\[id\\]/export","description":"Create export API route directory"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":315,"cache_read_input_tokens":74599,"cache_creation":{"ephemeral_5m_input_tokens":315,"ephemeral_1h_input_tokens":0},"output_tokens":162,"service_tier":"standard"}},"requestId":"req_011CWz6JgaR3wiaPAm76DoPz","type":"assistant","uuid":"a2804163-9ba4-431a-8daa-014663723969","timestamp":"2026-01-10T17:28:47.138Z"}
{"parentUuid":"a2804163-9ba4-431a-8daa-014663723969","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_0175pw53PiXxArwoGAk5NWJG","type":"tool_result","content":"","is_error":false}]},"uuid":"048edba2-8ad9-4038-8f43-c0e68743a524","timestamp":"2026-01-10T17:28:47.344Z","toolUseResult":{"stdout":"","stderr":"","interrupted":false,"isImage":false},"sourceToolAssistantUUID":"a2804163-9ba4-431a-8daa-014663723969"}
{"parentUuid":"048edba2-8ad9-4038-8f43-c0e68743a524","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","message":{"model":"claude-opus-4-5-20251101","id":"msg_01D9fbPqwWVoNnKRnxeAC127","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Now let me create the frontend export API route.","signature":"EtgBCkYICxgCKkDliVnkzWJyMG+Bu67sn5ImDKsoNb1ke30GfiZZlBKuVMxQ6sx5+ZmdfnoWheFMKSEvqo3/ovkhwVFZzdM7ajPmEgyBSNkV5dRIHNjtQMcaDAONd5QnXm+rREZgHiIwjOpS2fuU2D5suuYiEGjnX8wNsoXpbrraG/cRotAfKffYCUxZP2zc97loJa5AhQtGKkBlg2s9N5orwxvf97AeUu1DQcMmC6qHGzNRNfkRwnPQ+jNyXkM5NdAKdDD2IcMc94yXv0e+5prU2ZdJyCd0cpr0GAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":195,"cache_read_input_tokens":74914,"cache_creation":{"ephemeral_5m_input_tokens":195,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWz6K8nFeXdVe7mwRccRo","type":"assistant","uuid":"86c70f65-9214-48d2-ad47-bfa8d8683751","timestamp":"2026-01-10T17:28:52.060Z"}
{"type":"file-history-snapshot","messageId":"e541fc8f-8bba-40b4-b2d4-3bbabb89761a","snapshot":{"messageId":"973ebb96-60df-4671-b9c2-0c4aefc8516e","trackedFileBackups":{"backend/app/routers/export.py":{"backupFileName":null,"version":1,"backupTime":"2026-01-10T17:28:16.452Z"},"backend/app/main.py":{"backupFileName":"f16da9f396306523@v1","version":1,"backupTime":"2026-01-10T17:28:31.217Z"},"frontend/src/app/api/notebooks/[id]/export/route.ts":{"backupFileName":"85dcaadfd8a8a6e9@v1","version":1,"backupTime":"2026-01-10T17:29:25.531Z"}},"timestamp":"2026-01-10T17:26:46.087Z"},"isSnapshotUpdate":true}
{"parentUuid":"86c70f65-9214-48d2-ad47-bfa8d8683751","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","message":{"model":"claude-opus-4-5-20251101","id":"msg_01D9fbPqwWVoNnKRnxeAC127","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Ki7sGGxCrvumJPqQ9UZTPY","name":"Write","input":{"file_path":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend/src/app/api/notebooks/[id]/export/route.ts","content":"import { NextRequest, NextResponse } from 'next/server'\nimport { createClient } from '@supabase/supabase-js'\nimport JSZip from 'jszip'\n\nconst supabase = createClient(\n  process.env.NEXT_PUBLIC_SUPABASE_URL!,\n  process.env.SUPABASE_SERVICE_ROLE_KEY || process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!\n)\n\nasync function verifyAccess(request: NextRequest, notebookId: string) {\n  const authHeader = request.headers.get('authorization')\n  if (!authHeader) return null\n\n  const token = authHeader.replace('Bearer ', '')\n  const { data: { user } } = await supabase.auth.getUser(token)\n\n  if (!user) return null\n\n  const { data: notebook } = await supabase\n    .from('notebooks')\n    .select('*')\n    .eq('id', notebookId)\n    .eq('user_id', user.id)\n    .single()\n\n  if (!notebook) return null\n\n  return { user, notebook }\n}\n\ninterface ExportOptions {\n  includeSources?: boolean\n  includeChats?: boolean\n  includeNotes?: boolean\n  includeGenerated?: boolean\n}\n\nasync function gatherExportData(notebookId: string, options: ExportOptions) {\n  const {\n    includeSources = true,\n    includeChats = true,\n    includeNotes = true,\n    includeGenerated = true,\n  } = options\n\n  const exportData: Record<string, unknown> = {\n    exported_at: new Date().toISOString(),\n    export_version: '1.0',\n  }\n\n  // Sources\n  if (includeSources) {\n    const { data: sources } = await supabase\n      .from('sources')\n      .select('*')\n      .eq('notebook_id', notebookId)\n      .order('created_at', { ascending: true })\n    exportData.sources = sources || []\n  }\n\n  // Chat sessions with messages\n  if (includeChats) {\n    const { data: sessions } = await supabase\n      .from('chat_sessions')\n      .select('*')\n      .eq('notebook_id', notebookId)\n      .order('created_at', { ascending: true })\n\n    if (sessions) {\n      for (const session of sessions) {\n        const { data: messages } = await supabase\n          .from('chat_messages')\n          .select('*')\n          .eq('session_id', session.id)\n          .order('created_at', { ascending: true })\n        session.messages = messages || []\n      }\n    }\n    exportData.chat_sessions = sessions || []\n  }\n\n  // Notes\n  if (includeNotes) {\n    const { data: notes } = await supabase\n      .from('notes')\n      .select('*')\n      .eq('notebook_id', notebookId)\n      .order('created_at', { ascending: true })\n    exportData.notes = notes || []\n  }\n\n  // Generated content\n  if (includeGenerated) {\n    // Audio overviews\n    const { data: audio } = await supabase\n      .from('audio_overviews')\n      .select('*')\n      .eq('notebook_id', notebookId)\n    exportData.audio_overviews = audio || []\n\n    // Video overviews\n    const { data: video } = await supabase\n      .from('video_overviews')\n      .select('*')\n      .eq('notebook_id', notebookId)\n    exportData.video_overviews = video || []\n\n    // Study materials\n    const { data: studyMaterials } = await supabase\n      .from('study_materials')\n      .select('*')\n      .eq('notebook_id', notebookId)\n    exportData.study_materials = studyMaterials || []\n\n    // Studio outputs\n    const { data: studioOutputs } = await supabase\n      .from('studio_outputs')\n      .select('*')\n      .eq('notebook_id', notebookId)\n    exportData.studio_outputs = studioOutputs || []\n\n    // Research tasks\n    const { data: research } = await supabase\n      .from('research_tasks')\n      .select('*')\n      .eq('notebook_id', notebookId)\n    exportData.research_tasks = research || []\n  }\n\n  return exportData\n}\n\nexport async function GET(\n  request: NextRequest,\n  { params }: { params: Promise<{ id: string }> }\n) {\n  try {\n    const { id: notebookId } = await params\n    const authResult = await verifyAccess(request, notebookId)\n\n    if (!authResult) {\n      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })\n    }\n\n    const { user, notebook } = authResult\n    const { searchParams } = new URL(request.url)\n    const format = searchParams.get('format') || 'json'\n    const includeSources = searchParams.get('includeSources') !== 'false'\n    const includeChats = searchParams.get('includeChats') !== 'false'\n    const includeNotes = searchParams.get('includeNotes') !== 'false'\n    const includeGenerated = searchParams.get('includeGenerated') !== 'false'\n\n    const exportData = await gatherExportData(notebookId, {\n      includeSources,\n      includeChats,\n      includeNotes,\n      includeGenerated,\n    })\n\n    // Add notebook metadata\n    exportData.notebook = {\n      id: notebook.id,\n      name: notebook.name,\n      description: notebook.description,\n      emoji: notebook.emoji,\n      settings: notebook.settings,\n      created_at: notebook.created_at,\n    }\n\n    if (format === 'json') {\n      return NextResponse.json({ data: exportData })\n    }\n\n    // ZIP format\n    if (format === 'zip') {\n      const zip = new JSZip()\n      const safeName = notebook.name.replace(/[^a-zA-Z0-9 _-]/g, '_')\n      const dateStr = new Date().toISOString().slice(0, 10).replace(/-/g, '')\n      const folderName = `notebook-export-${safeName}-${dateStr}`\n\n      // Add README\n      const readme = `# ${notebook.name} Export\n\nExported from NotebookLM Reimagined on ${new Date().toISOString()}\n\n## Contents\n\n- \\`notebook.json\\` - Notebook metadata\n- \\`sources/\\` - Source documents and metadata\n- \\`chats/\\` - Chat sessions and messages\n- \\`notes/\\` - User notes\n- \\`generated/\\` - AI-generated content\n\n## Re-importing\n\nThis export can be used as a backup or for migration.\n`\n      zip.file(`${folderName}/README.md`, readme)\n\n      // Notebook metadata\n      zip.file(`${folderName}/notebook.json`, JSON.stringify(exportData.notebook, null, 2))\n\n      // Sources\n      if (includeSources && Array.isArray(exportData.sources)) {\n        const sourcesIndex: unknown[] = []\n\n        for (const source of exportData.sources as Record<string, unknown>[]) {\n          const sourceInfo: Record<string, unknown> = {\n            id: source.id,\n            name: source.name,\n            type: source.type,\n            status: source.status,\n            created_at: source.created_at,\n            metadata: source.metadata,\n            source_guide: source.source_guide,\n          }\n          sourcesIndex.push(sourceInfo)\n\n          // Try to download file from storage\n          if (source.file_path) {\n            try {\n              const { data: fileData } = await supabase.storage\n                .from('sources')\n                .download(source.file_path as string)\n\n              if (fileData) {\n                const filename = (source.original_filename as string) || (source.name as string)\n                const arrayBuffer = await fileData.arrayBuffer()\n                zip.file(`${folderName}/sources/files/${filename}`, arrayBuffer)\n                sourceInfo.exported_file = `files/${filename}`\n              }\n            } catch (e) {\n              sourceInfo.export_error = 'Failed to download file'\n            }\n          }\n\n          // For text sources, save content\n          if (source.type === 'text' && source.metadata) {\n            const metadata = source.metadata as Record<string, unknown>\n            if (metadata.content) {\n              const filename = `${source.id}.txt`\n              zip.file(`${folderName}/sources/text/${filename}`, metadata.content as string)\n              sourceInfo.exported_file = `text/${filename}`\n            }\n          }\n        }\n\n        zip.file(`${folderName}/sources/index.json`, JSON.stringify(sourcesIndex, null, 2))\n      }\n\n      // Chats\n      if (includeChats && Array.isArray(exportData.chat_sessions)) {\n        const sessionsIndex: unknown[] = []\n\n        for (const session of exportData.chat_sessions as Record<string, unknown>[]) {\n          const sessionInfo = {\n            id: session.id,\n            title: session.title,\n            created_at: session.created_at,\n            message_count: Array.isArray(session.messages) ? session.messages.length : 0,\n          }\n          sessionsIndex.push(sessionInfo)\n\n          zip.file(\n            `${folderName}/chats/session-${session.id}.json`,\n            JSON.stringify(session, null, 2)\n          )\n        }\n\n        zip.file(`${folderName}/chats/index.json`, JSON.stringify(sessionsIndex, null, 2))\n      }\n\n      // Notes\n      if (includeNotes && Array.isArray(exportData.notes)) {\n        zip.file(`${folderName}/notes/index.json`, JSON.stringify(exportData.notes, null, 2))\n      }\n\n      // Generated content\n      if (includeGenerated) {\n        const generatedIndex: Record<string, unknown[]> = {\n          audio_overviews: [],\n          video_overviews: [],\n          study_materials: [],\n          studio_outputs: [],\n          research_tasks: [],\n        }\n\n        // Audio\n        if (Array.isArray(exportData.audio_overviews)) {\n          for (const audio of exportData.audio_overviews as Record<string, unknown>[]) {\n            const audioInfo: Record<string, unknown> = {\n              id: audio.id,\n              format: audio.format,\n              status: audio.status,\n              created_at: audio.created_at,\n            }\n            generatedIndex.audio_overviews.push(audioInfo)\n\n            if (audio.script) {\n              zip.file(\n                `${folderName}/generated/audio/${audio.id}_script.json`,\n                JSON.stringify(audio.script, null, 2)\n              )\n            }\n\n            // Try to download audio file\n            if (audio.audio_file_path) {\n              try {\n                const { data: audioData } = await supabase.storage\n                  .from('audio')\n                  .download(audio.audio_file_path as string)\n\n                if (audioData) {\n                  const arrayBuffer = await audioData.arrayBuffer()\n                  zip.file(`${folderName}/generated/audio/${audio.id}.mp3`, arrayBuffer)\n                  audioInfo.exported_file = `${audio.id}.mp3`\n                }\n              } catch (e) {\n                // Ignore download errors\n              }\n            }\n          }\n        }\n\n        // Video\n        if (Array.isArray(exportData.video_overviews)) {\n          for (const video of exportData.video_overviews as Record<string, unknown>[]) {\n            const videoInfo = {\n              id: video.id,\n              style: video.style,\n              status: video.status,\n              created_at: video.created_at,\n            }\n            generatedIndex.video_overviews.push(videoInfo)\n\n            if (video.script) {\n              zip.file(\n                `${folderName}/generated/video/${video.id}_script.json`,\n                JSON.stringify(video.script, null, 2)\n              )\n            }\n          }\n        }\n\n        // Study materials\n        if (Array.isArray(exportData.study_materials)) {\n          for (const material of exportData.study_materials as Record<string, unknown>[]) {\n            generatedIndex.study_materials.push({\n              id: material.id,\n              type: material.type,\n              created_at: material.created_at,\n            })\n\n            zip.file(\n              `${folderName}/generated/study-materials/${material.type}_${material.id}.json`,\n              JSON.stringify(material, null, 2)\n            )\n          }\n        }\n\n        // Studio outputs\n        if (Array.isArray(exportData.studio_outputs)) {\n          for (const output of exportData.studio_outputs as Record<string, unknown>[]) {\n            generatedIndex.studio_outputs.push({\n              id: output.id,\n              type: output.type,\n              title: output.title,\n              created_at: output.created_at,\n            })\n\n            zip.file(\n              `${folderName}/generated/studio/${output.type}_${output.id}.json`,\n              JSON.stringify(output, null, 2)\n            )\n          }\n        }\n\n        // Research tasks\n        if (Array.isArray(exportData.research_tasks)) {\n          for (const research of exportData.research_tasks as Record<string, unknown>[]) {\n            generatedIndex.research_tasks.push({\n              id: research.id,\n              query: research.query,\n              status: research.status,\n              created_at: research.created_at,\n            })\n\n            zip.file(\n              `${folderName}/generated/research/${research.id}.json`,\n              JSON.stringify(research, null, 2)\n            )\n          }\n        }\n\n        zip.file(`${folderName}/generated/index.json`, JSON.stringify(generatedIndex, null, 2))\n      }\n\n      // Generate ZIP\n      const zipBuffer = await zip.generateAsync({ type: 'arraybuffer' })\n\n      return new NextResponse(zipBuffer, {\n        status: 200,\n        headers: {\n          'Content-Type': 'application/zip',\n          'Content-Disposition': `attachment; filename=\"${folderName}.zip\"`,\n        },\n      })\n    }\n\n    return NextResponse.json({ error: 'Invalid format' }, { status: 400 })\n  } catch (error) {\n    console.error('Export error:', error)\n    return NextResponse.json({ error: 'Failed to export notebook' }, { status: 500 })\n  }\n}\n"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":195,"cache_read_input_tokens":74914,"cache_creation":{"ephemeral_5m_input_tokens":195,"ephemeral_1h_input_tokens":0},"output_tokens":3854,"service_tier":"standard"}},"requestId":"req_011CWz6K8nFeXdVe7mwRccRo","type":"assistant","uuid":"e541fc8f-8bba-40b4-b2d4-3bbabb89761a","timestamp":"2026-01-10T17:29:25.491Z"}
{"parentUuid":"e541fc8f-8bba-40b4-b2d4-3bbabb89761a","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Ki7sGGxCrvumJPqQ9UZTPY","type":"tool_result","content":"File created successfully at: /Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend/src/app/api/notebooks/[id]/export/route.ts"}]},"uuid":"506a4e57-9878-466a-b629-96401cd33f22","timestamp":"2026-01-10T17:29:25.524Z","toolUseResult":{"type":"create","filePath":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend/src/app/api/notebooks/[id]/export/route.ts","content":"import { NextRequest, NextResponse } from 'next/server'\nimport { createClient } from '@supabase/supabase-js'\nimport JSZip from 'jszip'\n\nconst supabase = createClient(\n  process.env.NEXT_PUBLIC_SUPABASE_URL!,\n  process.env.SUPABASE_SERVICE_ROLE_KEY || process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!\n)\n\nasync function verifyAccess(request: NextRequest, notebookId: string) {\n  const authHeader = request.headers.get('authorization')\n  if (!authHeader) return null\n\n  const token = authHeader.replace('Bearer ', '')\n  const { data: { user } } = await supabase.auth.getUser(token)\n\n  if (!user) return null\n\n  const { data: notebook } = await supabase\n    .from('notebooks')\n    .select('*')\n    .eq('id', notebookId)\n    .eq('user_id', user.id)\n    .single()\n\n  if (!notebook) return null\n\n  return { user, notebook }\n}\n\ninterface ExportOptions {\n  includeSources?: boolean\n  includeChats?: boolean\n  includeNotes?: boolean\n  includeGenerated?: boolean\n}\n\nasync function gatherExportData(notebookId: string, options: ExportOptions) {\n  const {\n    includeSources = true,\n    includeChats = true,\n    includeNotes = true,\n    includeGenerated = true,\n  } = options\n\n  const exportData: Record<string, unknown> = {\n    exported_at: new Date().toISOString(),\n    export_version: '1.0',\n  }\n\n  // Sources\n  if (includeSources) {\n    const { data: sources } = await supabase\n      .from('sources')\n      .select('*')\n      .eq('notebook_id', notebookId)\n      .order('created_at', { ascending: true })\n    exportData.sources = sources || []\n  }\n\n  // Chat sessions with messages\n  if (includeChats) {\n    const { data: sessions } = await supabase\n      .from('chat_sessions')\n      .select('*')\n      .eq('notebook_id', notebookId)\n      .order('created_at', { ascending: true })\n\n    if (sessions) {\n      for (const session of sessions) {\n        const { data: messages } = await supabase\n          .from('chat_messages')\n          .select('*')\n          .eq('session_id', session.id)\n          .order('created_at', { ascending: true })\n        session.messages = messages || []\n      }\n    }\n    exportData.chat_sessions = sessions || []\n  }\n\n  // Notes\n  if (includeNotes) {\n    const { data: notes } = await supabase\n      .from('notes')\n      .select('*')\n      .eq('notebook_id', notebookId)\n      .order('created_at', { ascending: true })\n    exportData.notes = notes || []\n  }\n\n  // Generated content\n  if (includeGenerated) {\n    // Audio overviews\n    const { data: audio } = await supabase\n      .from('audio_overviews')\n      .select('*')\n      .eq('notebook_id', notebookId)\n    exportData.audio_overviews = audio || []\n\n    // Video overviews\n    const { data: video } = await supabase\n      .from('video_overviews')\n      .select('*')\n      .eq('notebook_id', notebookId)\n    exportData.video_overviews = video || []\n\n    // Study materials\n    const { data: studyMaterials } = await supabase\n      .from('study_materials')\n      .select('*')\n      .eq('notebook_id', notebookId)\n    exportData.study_materials = studyMaterials || []\n\n    // Studio outputs\n    const { data: studioOutputs } = await supabase\n      .from('studio_outputs')\n      .select('*')\n      .eq('notebook_id', notebookId)\n    exportData.studio_outputs = studioOutputs || []\n\n    // Research tasks\n    const { data: research } = await supabase\n      .from('research_tasks')\n      .select('*')\n      .eq('notebook_id', notebookId)\n    exportData.research_tasks = research || []\n  }\n\n  return exportData\n}\n\nexport async function GET(\n  request: NextRequest,\n  { params }: { params: Promise<{ id: string }> }\n) {\n  try {\n    const { id: notebookId } = await params\n    const authResult = await verifyAccess(request, notebookId)\n\n    if (!authResult) {\n      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })\n    }\n\n    const { user, notebook } = authResult\n    const { searchParams } = new URL(request.url)\n    const format = searchParams.get('format') || 'json'\n    const includeSources = searchParams.get('includeSources') !== 'false'\n    const includeChats = searchParams.get('includeChats') !== 'false'\n    const includeNotes = searchParams.get('includeNotes') !== 'false'\n    const includeGenerated = searchParams.get('includeGenerated') !== 'false'\n\n    const exportData = await gatherExportData(notebookId, {\n      includeSources,\n      includeChats,\n      includeNotes,\n      includeGenerated,\n    })\n\n    // Add notebook metadata\n    exportData.notebook = {\n      id: notebook.id,\n      name: notebook.name,\n      description: notebook.description,\n      emoji: notebook.emoji,\n      settings: notebook.settings,\n      created_at: notebook.created_at,\n    }\n\n    if (format === 'json') {\n      return NextResponse.json({ data: exportData })\n    }\n\n    // ZIP format\n    if (format === 'zip') {\n      const zip = new JSZip()\n      const safeName = notebook.name.replace(/[^a-zA-Z0-9 _-]/g, '_')\n      const dateStr = new Date().toISOString().slice(0, 10).replace(/-/g, '')\n      const folderName = `notebook-export-${safeName}-${dateStr}`\n\n      // Add README\n      const readme = `# ${notebook.name} Export\n\nExported from NotebookLM Reimagined on ${new Date().toISOString()}\n\n## Contents\n\n- \\`notebook.json\\` - Notebook metadata\n- \\`sources/\\` - Source documents and metadata\n- \\`chats/\\` - Chat sessions and messages\n- \\`notes/\\` - User notes\n- \\`generated/\\` - AI-generated content\n\n## Re-importing\n\nThis export can be used as a backup or for migration.\n`\n      zip.file(`${folderName}/README.md`, readme)\n\n      // Notebook metadata\n      zip.file(`${folderName}/notebook.json`, JSON.stringify(exportData.notebook, null, 2))\n\n      // Sources\n      if (includeSources && Array.isArray(exportData.sources)) {\n        const sourcesIndex: unknown[] = []\n\n        for (const source of exportData.sources as Record<string, unknown>[]) {\n          const sourceInfo: Record<string, unknown> = {\n            id: source.id,\n            name: source.name,\n            type: source.type,\n            status: source.status,\n            created_at: source.created_at,\n            metadata: source.metadata,\n            source_guide: source.source_guide,\n          }\n          sourcesIndex.push(sourceInfo)\n\n          // Try to download file from storage\n          if (source.file_path) {\n            try {\n              const { data: fileData } = await supabase.storage\n                .from('sources')\n                .download(source.file_path as string)\n\n              if (fileData) {\n                const filename = (source.original_filename as string) || (source.name as string)\n                const arrayBuffer = await fileData.arrayBuffer()\n                zip.file(`${folderName}/sources/files/${filename}`, arrayBuffer)\n                sourceInfo.exported_file = `files/${filename}`\n              }\n            } catch (e) {\n              sourceInfo.export_error = 'Failed to download file'\n            }\n          }\n\n          // For text sources, save content\n          if (source.type === 'text' && source.metadata) {\n            const metadata = source.metadata as Record<string, unknown>\n            if (metadata.content) {\n              const filename = `${source.id}.txt`\n              zip.file(`${folderName}/sources/text/${filename}`, metadata.content as string)\n              sourceInfo.exported_file = `text/${filename}`\n            }\n          }\n        }\n\n        zip.file(`${folderName}/sources/index.json`, JSON.stringify(sourcesIndex, null, 2))\n      }\n\n      // Chats\n      if (includeChats && Array.isArray(exportData.chat_sessions)) {\n        const sessionsIndex: unknown[] = []\n\n        for (const session of exportData.chat_sessions as Record<string, unknown>[]) {\n          const sessionInfo = {\n            id: session.id,\n            title: session.title,\n            created_at: session.created_at,\n            message_count: Array.isArray(session.messages) ? session.messages.length : 0,\n          }\n          sessionsIndex.push(sessionInfo)\n\n          zip.file(\n            `${folderName}/chats/session-${session.id}.json`,\n            JSON.stringify(session, null, 2)\n          )\n        }\n\n        zip.file(`${folderName}/chats/index.json`, JSON.stringify(sessionsIndex, null, 2))\n      }\n\n      // Notes\n      if (includeNotes && Array.isArray(exportData.notes)) {\n        zip.file(`${folderName}/notes/index.json`, JSON.stringify(exportData.notes, null, 2))\n      }\n\n      // Generated content\n      if (includeGenerated) {\n        const generatedIndex: Record<string, unknown[]> = {\n          audio_overviews: [],\n          video_overviews: [],\n          study_materials: [],\n          studio_outputs: [],\n          research_tasks: [],\n        }\n\n        // Audio\n        if (Array.isArray(exportData.audio_overviews)) {\n          for (const audio of exportData.audio_overviews as Record<string, unknown>[]) {\n            const audioInfo: Record<string, unknown> = {\n              id: audio.id,\n              format: audio.format,\n              status: audio.status,\n              created_at: audio.created_at,\n            }\n            generatedIndex.audio_overviews.push(audioInfo)\n\n            if (audio.script) {\n              zip.file(\n                `${folderName}/generated/audio/${audio.id}_script.json`,\n                JSON.stringify(audio.script, null, 2)\n              )\n            }\n\n            // Try to download audio file\n            if (audio.audio_file_path) {\n              try {\n                const { data: audioData } = await supabase.storage\n                  .from('audio')\n                  .download(audio.audio_file_path as string)\n\n                if (audioData) {\n                  const arrayBuffer = await audioData.arrayBuffer()\n                  zip.file(`${folderName}/generated/audio/${audio.id}.mp3`, arrayBuffer)\n                  audioInfo.exported_file = `${audio.id}.mp3`\n                }\n              } catch (e) {\n                // Ignore download errors\n              }\n            }\n          }\n        }\n\n        // Video\n        if (Array.isArray(exportData.video_overviews)) {\n          for (const video of exportData.video_overviews as Record<string, unknown>[]) {\n            const videoInfo = {\n              id: video.id,\n              style: video.style,\n              status: video.status,\n              created_at: video.created_at,\n            }\n            generatedIndex.video_overviews.push(videoInfo)\n\n            if (video.script) {\n              zip.file(\n                `${folderName}/generated/video/${video.id}_script.json`,\n                JSON.stringify(video.script, null, 2)\n              )\n            }\n          }\n        }\n\n        // Study materials\n        if (Array.isArray(exportData.study_materials)) {\n          for (const material of exportData.study_materials as Record<string, unknown>[]) {\n            generatedIndex.study_materials.push({\n              id: material.id,\n              type: material.type,\n              created_at: material.created_at,\n            })\n\n            zip.file(\n              `${folderName}/generated/study-materials/${material.type}_${material.id}.json`,\n              JSON.stringify(material, null, 2)\n            )\n          }\n        }\n\n        // Studio outputs\n        if (Array.isArray(exportData.studio_outputs)) {\n          for (const output of exportData.studio_outputs as Record<string, unknown>[]) {\n            generatedIndex.studio_outputs.push({\n              id: output.id,\n              type: output.type,\n              title: output.title,\n              created_at: output.created_at,\n            })\n\n            zip.file(\n              `${folderName}/generated/studio/${output.type}_${output.id}.json`,\n              JSON.stringify(output, null, 2)\n            )\n          }\n        }\n\n        // Research tasks\n        if (Array.isArray(exportData.research_tasks)) {\n          for (const research of exportData.research_tasks as Record<string, unknown>[]) {\n            generatedIndex.research_tasks.push({\n              id: research.id,\n              query: research.query,\n              status: research.status,\n              created_at: research.created_at,\n            })\n\n            zip.file(\n              `${folderName}/generated/research/${research.id}.json`,\n              JSON.stringify(research, null, 2)\n            )\n          }\n        }\n\n        zip.file(`${folderName}/generated/index.json`, JSON.stringify(generatedIndex, null, 2))\n      }\n\n      // Generate ZIP\n      const zipBuffer = await zip.generateAsync({ type: 'arraybuffer' })\n\n      return new NextResponse(zipBuffer, {\n        status: 200,\n        headers: {\n          'Content-Type': 'application/zip',\n          'Content-Disposition': `attachment; filename=\"${folderName}.zip\"`,\n        },\n      })\n    }\n\n    return NextResponse.json({ error: 'Invalid format' }, { status: 400 })\n  } catch (error) {\n    console.error('Export error:', error)\n    return NextResponse.json({ error: 'Failed to export notebook' }, { status: 500 })\n  }\n}\n","structuredPatch":[],"originalFile":null},"sourceToolAssistantUUID":"e541fc8f-8bba-40b4-b2d4-3bbabb89761a"}
{"parentUuid":"506a4e57-9878-466a-b629-96401cd33f22","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","message":{"model":"claude-opus-4-5-20251101","id":"msg_01TPz8GgEFxUVpwQ6V7W6ixy","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Now I need to check if jszip is installed in the frontend, and if not, install it. Let me also update the todo and move on to expanding export-utils.ts.","signature":"EsECCkYICxgCKkD6Qre8mCfpqZM9DUO/X1vNhBKqViBexoriH1Gs4DxY/0o5chyt5Z0IaMIh0YQWh3N9FKyOH8hDKmCl2eoU+2rLEgzO6vuCSzfoyYavC+AaDHiv6kjmlRLTRNaDUCIwWGjKea1mC6I9glmPZL/fo0TccnaSELRoo/OZDkfkVeU+7TMs+bXBgzb/j7sKbhFrKqgBepGzMBqmc9L9SPCTPxK/3BJsfRLPemr+CFh4YenC7GSzBw3OiqiErrKkbOWPFp5qbr/1QqNXU2qH9yavp/UfWM8LZQBeSZ+0ljRwphqYDdL5AElpZb6gVYiC9lDT7MVYpm97dIIm+laGOWTVhVeyG2CIh/+xIOPjdBgFIy3nbJgDc5/T73FuQaLkQfn2QpXh3GSd943uetJSOECBJrR49LiQ15xi4EHxGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":3912,"cache_read_input_tokens":75109,"cache_creation":{"ephemeral_5m_input_tokens":3912,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CWz6MvHkZTj2p75VZex6n","type":"assistant","uuid":"bfe16d33-9fb2-47de-807a-dc443d5a5350","timestamp":"2026-01-10T17:29:30.948Z"}
{"parentUuid":"bfe16d33-9fb2-47de-807a-dc443d5a5350","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","message":{"model":"claude-opus-4-5-20251101","id":"msg_01TPz8GgEFxUVpwQ6V7W6ixy","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01U6batCof83MFZ4Pj92mc48","name":"Bash","input":{"command":"cd /Users/marwankashef/Desktop/YouTube/NotebookLM\\ Re-Mastered/frontend && grep -q \"jszip\" package.json && echo \"jszip already installed\" || npm install jszip","description":"Check and install jszip if needed"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":3912,"cache_read_input_tokens":75109,"cache_creation":{"ephemeral_5m_input_tokens":3912,"ephemeral_1h_input_tokens":0},"output_tokens":171,"service_tier":"standard"}},"requestId":"req_011CWz6MvHkZTj2p75VZex6n","type":"assistant","uuid":"aed72b05-0091-44d5-b92f-533ddda889ee","timestamp":"2026-01-10T17:29:31.845Z"}
{"parentUuid":"aed72b05-0091-44d5-b92f-533ddda889ee","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01U6batCof83MFZ4Pj92mc48","type":"tool_result","content":"added 13 packages, and audited 638 packages in 1s\n\n233 packages are looking for funding\n  run `npm fund` for details\n\n2 vulnerabilities (1 high, 1 critical)\n\nTo address all issues possible (including breaking changes), run:\n  npm audit fix --force\n\nSome issues need review, and may require choosing\na different dependency.\n\nRun `npm audit` for details.","is_error":false}]},"uuid":"2241318d-1684-4086-8f23-3e4cc20cb64f","timestamp":"2026-01-10T17:29:34.908Z","toolUseResult":{"stdout":"added 13 packages, and audited 638 packages in 1s\n\n233 packages are looking for funding\n  run `npm fund` for details\n\n2 vulnerabilities (1 high, 1 critical)\n\nTo address all issues possible (including breaking changes), run:\n  npm audit fix --force\n\nSome issues need review, and may require choosing\na different dependency.\n\nRun `npm audit` for details.","stderr":"","interrupted":false,"isImage":false},"sourceToolAssistantUUID":"aed72b05-0091-44d5-b92f-533ddda889ee"}
{"parentUuid":"2241318d-1684-4086-8f23-3e4cc20cb64f","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","message":{"model":"claude-opus-4-5-20251101","id":"msg_01M2nMT4T3k379RVLRGrkaJJ","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"JSZip is now installed. Let me update the todo list and expand the export-utils.ts file.","signature":"EoACCkYICxgCKkDvRFMoB2tcJwdrQdKx8FxV86BOxdAz5UJN4PH6idfE42zttco8eOaVozHbwiH5b8DQtgPxLcfu8+OtQYhkiK45EgwAG8a1xRTSCuNczvwaDFbLLi8CGEzXZp/UWiIwyaIpqp5fP0R0DaLPZQL/ANCtF+mBXRtaGcVER1s6an4CpZfJhkggKmkf2dMQDRvVKmhp2YEuNaSV7WqpRiAcdZDXULRSHm40mM9oQBtHIpmoGNA6m9CHoTD/rahuICew06yePtvAay+4sK9hk4K/rVF0ZCv1tSQxUmmdUt8tYLj2IZMaUpd6Q+LmoB/WK5FcJ4G57UfPekShkxgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":282,"cache_read_input_tokens":79021,"cache_creation":{"ephemeral_5m_input_tokens":282,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWz6NcTj4C5URxcFoscAM","type":"assistant","uuid":"6f4111ee-c916-4575-9d78-0961107dfc96","timestamp":"2026-01-10T17:29:38.987Z"}
{"parentUuid":"6f4111ee-c916-4575-9d78-0961107dfc96","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","message":{"model":"claude-opus-4-5-20251101","id":"msg_01M2nMT4T3k379RVLRGrkaJJ","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_012Ek79gVnkMio64hneQywuX","name":"TodoWrite","input":{"todos":[{"content":"Create backend export router (export.py)","status":"completed","activeForm":"Creating backend export router"},{"content":"Register export router in main.py","status":"completed","activeForm":"Registering export router in main.py"},{"content":"Create frontend API route for export","status":"completed","activeForm":"Creating frontend API route for export"},{"content":"Expand export-utils.ts with notebook export functions","status":"in_progress","activeForm":"Expanding export-utils.ts"},{"content":"Add export UI to studio-panel.tsx","status":"pending","activeForm":"Adding export UI to studio-panel.tsx"},{"content":"Test the export functionality","status":"pending","activeForm":"Testing export functionality"}]}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":282,"cache_read_input_tokens":79021,"cache_creation":{"ephemeral_5m_input_tokens":282,"ephemeral_1h_input_tokens":0},"output_tokens":276,"service_tier":"standard"}},"requestId":"req_011CWz6NcTj4C5URxcFoscAM","type":"assistant","uuid":"71a969c8-402e-44f8-9e13-1161819251d0","timestamp":"2026-01-10T17:29:42.024Z"}
{"parentUuid":"71a969c8-402e-44f8-9e13-1161819251d0","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_012Ek79gVnkMio64hneQywuX","type":"tool_result","content":"Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable"}]},"uuid":"906f2c76-aceb-4ab0-9d22-c03de4fe5b03","timestamp":"2026-01-10T17:29:42.050Z","toolUseResult":{"oldTodos":[{"content":"Create backend export router (export.py)","status":"completed","activeForm":"Creating backend export router"},{"content":"Register export router in main.py","status":"completed","activeForm":"Registering export router in main.py"},{"content":"Create frontend API route for export","status":"in_progress","activeForm":"Creating frontend API route for export"},{"content":"Expand export-utils.ts with notebook export functions","status":"pending","activeForm":"Expanding export-utils.ts"},{"content":"Add export UI to studio-panel.tsx","status":"pending","activeForm":"Adding export UI to studio-panel.tsx"},{"content":"Test the export functionality","status":"pending","activeForm":"Testing export functionality"}],"newTodos":[{"content":"Create backend export router (export.py)","status":"completed","activeForm":"Creating backend export router"},{"content":"Register export router in main.py","status":"completed","activeForm":"Registering export router in main.py"},{"content":"Create frontend API route for export","status":"completed","activeForm":"Creating frontend API route for export"},{"content":"Expand export-utils.ts with notebook export functions","status":"in_progress","activeForm":"Expanding export-utils.ts"},{"content":"Add export UI to studio-panel.tsx","status":"pending","activeForm":"Adding export UI to studio-panel.tsx"},{"content":"Test the export functionality","status":"pending","activeForm":"Testing export functionality"}]},"sourceToolAssistantUUID":"71a969c8-402e-44f8-9e13-1161819251d0"}
{"parentUuid":"906f2c76-aceb-4ab0-9d22-c03de4fe5b03","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","message":{"model":"claude-opus-4-5-20251101","id":"msg_01UyQELohcPCb3kHjCMMEPtm","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Now let me expand the export-utils.ts file with the notebook export functions.","signature":"EvYBCkYICxgCKkCY9lWb8Pg9rW//qt+cc+Evc3wsRNAdn4UJCpTpjwXXzA9XqnWpt9YexQRmgE9imoIPKjoU+15Y2KjTn9Teb/PgEgwkipBHcfW1cIira14aDJONxp3CkF/SfxPYTiIw9mJdsZIO8PDydgbLce/DONDQkLbJBAPbPiS7JwS8YdDvHTRf35elgmoGFTZL2/+NKl6rXDWaBaU7xwHvCHHGV3wI2gPO7YYRrWinhAiY9JFl7p8bv3pHGLF28XyiU45toJYSEQcMKlNAu2PxOe1zP8QKso+pC/raLu//ghsByFiGe4Jb4F3YzDSS1FFOGfyzGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":325,"cache_read_input_tokens":79303,"cache_creation":{"ephemeral_5m_input_tokens":325,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CWz6P8F88RZkAZTMsxjmM","type":"assistant","uuid":"49e4c840-7a78-48e1-a128-7b992c1477f0","timestamp":"2026-01-10T17:29:46.030Z"}
{"parentUuid":"49e4c840-7a78-48e1-a128-7b992c1477f0","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","message":{"model":"claude-opus-4-5-20251101","id":"msg_01UyQELohcPCb3kHjCMMEPtm","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_018MAQMEnvyWj4cYBkzQNLbD","name":"Edit","input":{"replace_all":false,"file_path":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend/src/lib/export-utils.ts","old_string":"/**\n * Trigger file download from blob\n */\nexport function downloadBlob(blob: Blob, filename: string): void {\n  const url = URL.createObjectURL(blob)\n  const link = document.createElement('a')\n  link.href = url\n  link.download = filename\n  document.body.appendChild(link)\n  link.click()\n  document.body.removeChild(link)\n  URL.revokeObjectURL(url)\n}","new_string":"/**\n * Trigger file download from blob\n */\nexport function downloadBlob(blob: Blob, filename: string): void {\n  const url = URL.createObjectURL(blob)\n  const link = document.createElement('a')\n  link.href = url\n  link.download = filename\n  document.body.appendChild(link)\n  link.click()\n  document.body.removeChild(link)\n  URL.revokeObjectURL(url)\n}\n\n// ============================================================================\n// Notebook Export\n// ============================================================================\n\n/**\n * Options for notebook export\n */\nexport interface NotebookExportOptions {\n  includeSources?: boolean\n  includeChats?: boolean\n  includeNotes?: boolean\n  includeGenerated?: boolean\n  format: 'zip' | 'pdf' | 'json'\n}\n\n/**\n * Notebook export data structure\n */\nexport interface NotebookExportData {\n  notebook: {\n    id: string\n    name: string\n    description?: string\n    emoji?: string\n    settings?: Record<string, unknown>\n    created_at: string\n  }\n  exported_at: string\n  export_version: string\n  sources?: Array<{\n    id: string\n    name: string\n    type: string\n    status: string\n    created_at: string\n    metadata?: Record<string, unknown>\n    source_guide?: Record<string, unknown>\n  }>\n  chat_sessions?: Array<{\n    id: string\n    title?: string\n    created_at: string\n    messages?: Array<{\n      id: string\n      role: string\n      content: string\n      citations?: unknown[]\n      created_at: string\n    }>\n  }>\n  notes?: Array<{\n    id: string\n    title?: string\n    content: string\n    tags?: string[]\n    is_pinned?: boolean\n    created_at: string\n  }>\n  audio_overviews?: Array<{\n    id: string\n    format?: string\n    status: string\n    script?: unknown\n    created_at: string\n  }>\n  video_overviews?: Array<{\n    id: string\n    style?: string\n    status: string\n    script?: unknown\n    created_at: string\n  }>\n  study_materials?: Array<{\n    id: string\n    type: string\n    data: unknown\n    created_at: string\n  }>\n  studio_outputs?: Array<{\n    id: string\n    type: string\n    title?: string\n    content: unknown\n    created_at: string\n  }>\n  research_tasks?: Array<{\n    id: string\n    query: string\n    status: string\n    report_content?: string\n    created_at: string\n  }>\n}\n\n/**\n * Export a notebook as a ZIP file\n */\nexport async function exportNotebookAsZip(\n  notebookId: string,\n  options: Omit<NotebookExportOptions, 'format'>,\n  authToken: string\n): Promise<void> {\n  const params = new URLSearchParams({\n    format: 'zip',\n    includeSources: String(options.includeSources ?? true),\n    includeChats: String(options.includeChats ?? true),\n    includeNotes: String(options.includeNotes ?? true),\n    includeGenerated: String(options.includeGenerated ?? true),\n  })\n\n  const response = await fetch(`/api/notebooks/${notebookId}/export?${params}`, {\n    headers: {\n      Authorization: `Bearer ${authToken}`,\n    },\n  })\n\n  if (!response.ok) {\n    throw new Error('Failed to export notebook')\n  }\n\n  const blob = await response.blob()\n  const contentDisposition = response.headers.get('Content-Disposition')\n  let filename = `notebook-export-${notebookId}.zip`\n\n  if (contentDisposition) {\n    const match = contentDisposition.match(/filename=\"?([^\"]+)\"?/)\n    if (match) {\n      filename = match[1]\n    }\n  }\n\n  downloadBlob(blob, filename)\n}\n\n/**\n * Export a notebook as JSON\n */\nexport async function exportNotebookAsJson(\n  notebookId: string,\n  options: Omit<NotebookExportOptions, 'format'>,\n  authToken: string\n): Promise<NotebookExportData> {\n  const params = new URLSearchParams({\n    format: 'json',\n    includeSources: String(options.includeSources ?? true),\n    includeChats: String(options.includeChats ?? true),\n    includeNotes: String(options.includeNotes ?? true),\n    includeGenerated: String(options.includeGenerated ?? true),\n  })\n\n  const response = await fetch(`/api/notebooks/${notebookId}/export?${params}`, {\n    headers: {\n      Authorization: `Bearer ${authToken}`,\n    },\n  })\n\n  if (!response.ok) {\n    throw new Error('Failed to export notebook')\n  }\n\n  const result = await response.json()\n  return result.data\n}\n\n/**\n * Export a notebook as a comprehensive PDF document\n */\nexport async function exportNotebookAsPDF(\n  notebookId: string,\n  options: Omit<NotebookExportOptions, 'format'>,\n  authToken: string\n): Promise<void> {\n  // First, fetch all data via JSON\n  const exportData = await exportNotebookAsJson(notebookId, options, authToken)\n\n  const { jsPDF } = await import('jspdf')\n\n  const doc = new jsPDF({\n    orientation: 'portrait',\n    unit: 'mm',\n    format: 'a4',\n  })\n\n  const pageWidth = doc.internal.pageSize.getWidth()\n  const pageHeight = doc.internal.pageSize.getHeight()\n  const margin = 20\n  const contentWidth = pageWidth - margin * 2\n  let y = margin\n\n  // Helper to check for page break\n  const checkPageBreak = (height: number) => {\n    if (y + height > pageHeight - margin) {\n      doc.addPage()\n      y = margin\n      return true\n    }\n    return false\n  }\n\n  // Helper to add a section header\n  const addSectionHeader = (title: string) => {\n    checkPageBreak(20)\n    doc.setFontSize(16)\n    doc.setFont('helvetica', 'bold')\n    doc.setTextColor(51, 51, 51)\n    doc.text(title, margin, y)\n    y += 10\n    doc.setDrawColor(200, 200, 200)\n    doc.line(margin, y, pageWidth - margin, y)\n    y += 8\n  }\n\n  // Title page\n  doc.setFontSize(28)\n  doc.setFont('helvetica', 'bold')\n  doc.setTextColor(51, 51, 51)\n  const title = exportData.notebook.name\n  const titleLines = doc.splitTextToSize(title, contentWidth)\n  doc.text(titleLines, margin, y + 30)\n  y += 30 + titleLines.length * 12\n\n  if (exportData.notebook.description) {\n    doc.setFontSize(12)\n    doc.setFont('helvetica', 'normal')\n    doc.setTextColor(102, 102, 102)\n    const descLines = doc.splitTextToSize(exportData.notebook.description, contentWidth)\n    doc.text(descLines, margin, y)\n    y += descLines.length * 6 + 10\n  }\n\n  doc.setFontSize(10)\n  doc.setTextColor(150, 150, 150)\n  doc.text(`Exported from NotebookLM Reimagined`, margin, y)\n  y += 6\n  doc.text(`Date: ${new Date().toLocaleDateString()}`, margin, y)\n\n  // New page for content\n  doc.addPage()\n  y = margin\n\n  // Table of Contents\n  addSectionHeader('Table of Contents')\n  doc.setFontSize(11)\n  doc.setFont('helvetica', 'normal')\n  doc.setTextColor(68, 68, 68)\n\n  let tocItems = []\n  if (options.includeSources !== false && exportData.sources?.length) {\n    tocItems.push(`Sources (${exportData.sources.length})`)\n  }\n  if (options.includeChats !== false && exportData.chat_sessions?.length) {\n    tocItems.push(`Chat Sessions (${exportData.chat_sessions.length})`)\n  }\n  if (options.includeNotes !== false && exportData.notes?.length) {\n    tocItems.push(`Notes (${exportData.notes.length})`)\n  }\n  if (options.includeGenerated !== false) {\n    if (exportData.study_materials?.length) {\n      tocItems.push(`Study Materials (${exportData.study_materials.length})`)\n    }\n    if (exportData.research_tasks?.length) {\n      tocItems.push(`Research Reports (${exportData.research_tasks.length})`)\n    }\n  }\n\n  tocItems.forEach((item, idx) => {\n    doc.text(`${idx + 1}. ${item}`, margin + 5, y)\n    y += 7\n  })\n\n  y += 10\n\n  // Sources section\n  if (options.includeSources !== false && exportData.sources?.length) {\n    doc.addPage()\n    y = margin\n    addSectionHeader('Sources')\n\n    for (const source of exportData.sources) {\n      checkPageBreak(25)\n\n      doc.setFontSize(12)\n      doc.setFont('helvetica', 'bold')\n      doc.setTextColor(51, 51, 51)\n      const sourceName = doc.splitTextToSize(source.name, contentWidth - 20)\n      doc.text(sourceName, margin + 5, y)\n      y += sourceName.length * 5 + 3\n\n      doc.setFontSize(9)\n      doc.setFont('helvetica', 'normal')\n      doc.setTextColor(102, 102, 102)\n      doc.text(`Type: ${source.type} | Status: ${source.status}`, margin + 5, y)\n      y += 5\n\n      // Add source guide summary if available\n      if (source.source_guide) {\n        const guide = source.source_guide as Record<string, unknown>\n        if (guide.summary) {\n          checkPageBreak(20)\n          doc.setFontSize(10)\n          doc.setTextColor(68, 68, 68)\n          const summaryLines = doc.splitTextToSize(String(guide.summary), contentWidth - 10)\n          doc.text(summaryLines.slice(0, 4), margin + 5, y)\n          y += Math.min(summaryLines.length, 4) * 5\n        }\n      }\n\n      y += 8\n    }\n  }\n\n  // Chat sessions section\n  if (options.includeChats !== false && exportData.chat_sessions?.length) {\n    doc.addPage()\n    y = margin\n    addSectionHeader('Chat Sessions')\n\n    for (const session of exportData.chat_sessions) {\n      checkPageBreak(15)\n\n      doc.setFontSize(12)\n      doc.setFont('helvetica', 'bold')\n      doc.setTextColor(51, 51, 51)\n      doc.text(session.title || 'Untitled Session', margin + 5, y)\n      y += 7\n\n      if (session.messages?.length) {\n        doc.setFontSize(9)\n        doc.setTextColor(102, 102, 102)\n        doc.text(`${session.messages.length} messages`, margin + 5, y)\n        y += 6\n\n        // Show first few messages as preview\n        const previewMessages = session.messages.slice(0, 4)\n        for (const msg of previewMessages) {\n          checkPageBreak(15)\n          doc.setFontSize(10)\n          doc.setFont('helvetica', msg.role === 'user' ? 'bold' : 'normal')\n          doc.setTextColor(msg.role === 'user' ? 51 : 68, msg.role === 'user' ? 51 : 68, msg.role === 'user' ? 51 : 68)\n\n          const prefix = msg.role === 'user' ? 'Q: ' : 'A: '\n          const msgText = String(msg.content || '').slice(0, 200)\n          const lines = doc.splitTextToSize(prefix + msgText + (msgText.length >= 200 ? '...' : ''), contentWidth - 15)\n          doc.text(lines.slice(0, 3), margin + 10, y)\n          y += Math.min(lines.length, 3) * 5 + 3\n        }\n\n        if (session.messages.length > 4) {\n          doc.setFontSize(9)\n          doc.setTextColor(150, 150, 150)\n          doc.text(`... and ${session.messages.length - 4} more messages`, margin + 10, y)\n          y += 5\n        }\n      }\n\n      y += 8\n    }\n  }\n\n  // Notes section\n  if (options.includeNotes !== false && exportData.notes?.length) {\n    doc.addPage()\n    y = margin\n    addSectionHeader('Notes')\n\n    for (const note of exportData.notes) {\n      checkPageBreak(30)\n\n      doc.setFontSize(12)\n      doc.setFont('helvetica', 'bold')\n      doc.setTextColor(51, 51, 51)\n      doc.text(note.title || 'Untitled Note', margin + 5, y)\n      y += 7\n\n      if (note.tags?.length) {\n        doc.setFontSize(9)\n        doc.setTextColor(102, 102, 102)\n        doc.text(`Tags: ${note.tags.join(', ')}`, margin + 5, y)\n        y += 5\n      }\n\n      doc.setFontSize(10)\n      doc.setFont('helvetica', 'normal')\n      doc.setTextColor(68, 68, 68)\n      const noteContent = String(note.content || '').slice(0, 500)\n      const lines = doc.splitTextToSize(noteContent + (noteContent.length >= 500 ? '...' : ''), contentWidth - 10)\n      doc.text(lines.slice(0, 8), margin + 5, y)\n      y += Math.min(lines.length, 8) * 5 + 10\n    }\n  }\n\n  // Study materials section\n  if (options.includeGenerated !== false && exportData.study_materials?.length) {\n    doc.addPage()\n    y = margin\n    addSectionHeader('Study Materials')\n\n    for (const material of exportData.study_materials) {\n      checkPageBreak(15)\n\n      doc.setFontSize(11)\n      doc.setFont('helvetica', 'bold')\n      doc.setTextColor(51, 51, 51)\n\n      const typeLabels: Record<string, string> = {\n        flashcards: 'Flashcards',\n        quiz: 'Quiz',\n        study_guide: 'Study Guide',\n        faq: 'FAQ',\n        mind_map: 'Mind Map',\n      }\n      doc.text(typeLabels[material.type] || material.type, margin + 5, y)\n      y += 6\n\n      doc.setFontSize(9)\n      doc.setTextColor(102, 102, 102)\n      doc.text(`Created: ${new Date(material.created_at).toLocaleDateString()}`, margin + 5, y)\n      y += 10\n    }\n  }\n\n  // Research reports section\n  if (options.includeGenerated !== false && exportData.research_tasks?.length) {\n    doc.addPage()\n    y = margin\n    addSectionHeader('Research Reports')\n\n    for (const research of exportData.research_tasks) {\n      checkPageBreak(30)\n\n      doc.setFontSize(12)\n      doc.setFont('helvetica', 'bold')\n      doc.setTextColor(51, 51, 51)\n      const queryLines = doc.splitTextToSize(research.query, contentWidth - 10)\n      doc.text(queryLines, margin + 5, y)\n      y += queryLines.length * 5 + 3\n\n      doc.setFontSize(9)\n      doc.setTextColor(102, 102, 102)\n      doc.text(`Status: ${research.status}`, margin + 5, y)\n      y += 6\n\n      if (research.report_content) {\n        doc.setFontSize(10)\n        doc.setFont('helvetica', 'normal')\n        doc.setTextColor(68, 68, 68)\n        const reportPreview = String(research.report_content).slice(0, 400)\n        const lines = doc.splitTextToSize(reportPreview + (reportPreview.length >= 400 ? '...' : ''), contentWidth - 10)\n        doc.text(lines.slice(0, 6), margin + 5, y)\n        y += Math.min(lines.length, 6) * 5\n      }\n\n      y += 10\n    }\n  }\n\n  // Footer with page numbers\n  const pageCount = doc.getNumberOfPages()\n  for (let i = 1; i <= pageCount; i++) {\n    doc.setPage(i)\n    doc.setFontSize(9)\n    doc.setFont('helvetica', 'normal')\n    doc.setTextColor(150, 150, 150)\n    doc.text(`Page ${i} of ${pageCount}`, pageWidth / 2, pageHeight - 10, { align: 'center' })\n    doc.text('Generated by NotebookLM Reimagined', margin, pageHeight - 10)\n  }\n\n  // Generate filename and save\n  const safeName = exportData.notebook.name.replace(/[^a-zA-Z0-9 _-]/g, '_')\n  const dateStr = new Date().toISOString().slice(0, 10).replace(/-/g, '')\n  doc.save(`notebook-export-${safeName}-${dateStr}.pdf`)\n}\n\n/**\n * Export a notebook with the specified format\n */\nexport async function exportNotebook(\n  notebookId: string,\n  options: NotebookExportOptions,\n  authToken: string\n): Promise<void> {\n  switch (options.format) {\n    case 'zip':\n      return exportNotebookAsZip(notebookId, options, authToken)\n    case 'pdf':\n      return exportNotebookAsPDF(notebookId, options, authToken)\n    case 'json':\n      const data = await exportNotebookAsJson(notebookId, options, authToken)\n      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' })\n      const safeName = data.notebook.name.replace(/[^a-zA-Z0-9 _-]/g, '_')\n      const dateStr = new Date().toISOString().slice(0, 10).replace(/-/g, '')\n      downloadBlob(blob, `notebook-export-${safeName}-${dateStr}.json`)\n      return\n    default:\n      throw new Error(`Unsupported format: ${options.format}`)\n  }\n}"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":325,"cache_read_input_tokens":79303,"cache_creation":{"ephemeral_5m_input_tokens":325,"ephemeral_1h_input_tokens":0},"output_tokens":5156,"service_tier":"standard"}},"requestId":"req_011CWz6P8F88RZkAZTMsxjmM","type":"assistant","uuid":"4dddbdaa-27a9-40a0-acf6-2d4dc0c0093f","timestamp":"2026-01-10T17:30:32.759Z"}
{"type":"file-history-snapshot","messageId":"4dddbdaa-27a9-40a0-acf6-2d4dc0c0093f","snapshot":{"messageId":"973ebb96-60df-4671-b9c2-0c4aefc8516e","trackedFileBackups":{"backend/app/routers/export.py":{"backupFileName":null,"version":1,"backupTime":"2026-01-10T17:28:16.452Z"},"backend/app/main.py":{"backupFileName":"f16da9f396306523@v1","version":1,"backupTime":"2026-01-10T17:28:31.217Z"},"frontend/src/app/api/notebooks/[id]/export/route.ts":{"backupFileName":"85dcaadfd8a8a6e9@v1","version":1,"backupTime":"2026-01-10T17:29:25.531Z"},"frontend/src/lib/export-utils.ts":{"backupFileName":"dc1af29a22407c10@v1","version":1,"backupTime":"2026-01-10T17:30:32.804Z"}},"timestamp":"2026-01-10T17:26:46.087Z"},"isSnapshotUpdate":true}
{"parentUuid":"4dddbdaa-27a9-40a0-acf6-2d4dc0c0093f","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_018MAQMEnvyWj4cYBkzQNLbD","type":"tool_result","content":"The file /Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend/src/lib/export-utils.ts has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n   571→  const timestamp = date.toISOString().slice(0, 10).replace(/-/g, '')\n   572→  return `${base}_${timestamp}`\n   573→}\n   574→\n   575→/**\n   576→ * Trigger file download from blob\n   577→ */\n   578→export function downloadBlob(blob: Blob, filename: string): void {\n   579→  const url = URL.createObjectURL(blob)\n   580→  const link = document.createElement('a')\n   581→  link.href = url\n   582→  link.download = filename\n   583→  document.body.appendChild(link)\n   584→  link.click()\n   585→  document.body.removeChild(link)\n   586→  URL.revokeObjectURL(url)\n   587→}\n   588→\n   589→// ============================================================================\n   590→// Notebook Export\n   591→// ============================================================================\n   592→\n   593→/**\n   594→ * Options for notebook export\n   595→ */\n   596→export interface NotebookExportOptions {\n   597→  includeSources?: boolean\n   598→  includeChats?: boolean\n   599→  includeNotes?: boolean\n   600→  includeGenerated?: boolean\n   601→  format: 'zip' | 'pdf' | 'json'\n   602→}\n   603→\n   604→/**\n   605→ * Notebook export data structure\n   606→ */\n   607→export interface NotebookExportData {\n   608→  notebook: {\n   609→    id: string\n   610→    name: string\n   611→    description?: string\n   612→    emoji?: string\n   613→    settings?: Record<string, unknown>\n   614→    created_at: string\n   615→  }\n   616→  exported_at: string\n   617→  export_version: string\n   618→  sources?: Array<{\n   619→    id: string\n   620→    name: string\n   621→    type: string\n   622→    status: string\n   623→    created_at: string\n   624→    metadata?: Record<string, unknown>\n   625→    source_guide?: Record<string, unknown>\n   626→  }>\n   627→  chat_sessions?: Array<{\n   628→    id: string\n   629→    title?: string\n   630→    created_at: string\n   631→    messages?: Array<{\n   632→      id: string\n   633→      role: string\n   634→      content: string\n   635→      citations?: unknown[]\n   636→      created_at: string\n   637→    }>\n   638→  }>\n   639→  notes?: Array<{\n   640→    id: string\n   641→    title?: string\n   642→    content: string\n   643→    tags?: string[]\n   644→    is_pinned?: boolean\n   645→    created_at: string\n   646→  }>\n   647→  audio_overviews?: Array<{\n   648→    id: string\n   649→    format?: string\n   650→    status: string\n   651→    script?: unknown\n   652→    created_at: string\n   653→  }>\n   654→  video_overviews?: Array<{\n   655→    id: string\n   656→    style?: string\n   657→    status: string\n   658→    script?: unknown\n   659→    created_at: string\n   660→  }>\n   661→  study_materials?: Array<{\n   662→    id: string\n   663→    type: string\n   664→    data: unknown\n   665→    created_at: string\n   666→  }>\n   667→  studio_outputs?: Array<{\n   668→    id: string\n   669→    type: string\n   670→    title?: string\n   671→    content: unknown\n   672→    created_at: string\n   673→  }>\n   674→  research_tasks?: Array<{\n   675→    id: string\n   676→    query: string\n   677→    status: string\n   678→    report_content?: string\n   679→    created_at: string\n   680→  }>\n   681→}\n   682→\n   683→/**\n   684→ * Export a notebook as a ZIP file\n   685→ */\n   686→export async function exportNotebookAsZip(\n   687→  notebookId: string,\n   688→  options: Omit<NotebookExportOptions, 'format'>,\n   689→  authToken: string\n   690→): Promise<void> {\n   691→  const params = new URLSearchParams({\n   692→    format: 'zip',\n   693→    includeSources: String(options.includeSources ?? true),\n   694→    includeChats: String(options.includeChats ?? true),\n   695→    includeNotes: String(options.includeNotes ?? true),\n   696→    includeGenerated: String(options.includeGenerated ?? true),\n   697→  })\n   698→\n   699→  const response = await fetch(`/api/notebooks/${notebookId}/export?${params}`, {\n   700→    headers: {\n   701→      Authorization: `Bearer ${authToken}`,\n   702→    },\n   703→  })\n   704→\n   705→  if (!response.ok) {\n   706→    throw new Error('Failed to export notebook')\n   707→  }\n   708→\n   709→  const blob = await response.blob()\n   710→  const contentDisposition = response.headers.get('Content-Disposition')\n   711→  let filename = `notebook-export-${notebookId}.zip`\n   712→\n   713→  if (contentDisposition) {\n   714→    const match = contentDisposition.match(/filename=\"?([^\"]+)\"?/)\n   715→    if (match) {\n   716→      filename = match[1]\n   717→    }\n   718→  }\n   719→\n   720→  downloadBlob(blob, filename)\n   721→}\n   722→\n   723→/**\n   724→ * Export a notebook as JSON\n   725→ */\n   726→export async function exportNotebookAsJson(\n   727→  notebookId: string,\n   728→  options: Omit<NotebookExportOptions, 'format'>,\n   729→  authToken: string\n   730→): Promise<NotebookExportData> {\n   731→  const params = new URLSearchParams({\n   732→    format: 'json',\n   733→    includeSources: String(options.includeSources ?? true),\n   734→    includeChats: String(options.includeChats ?? true),\n   735→    includeNotes: String(options.includeNotes ?? true),\n   736→    includeGenerated: String(options.includeGenerated ?? true),\n   737→  })\n   738→\n   739→  const response = await fetch(`/api/notebooks/${notebookId}/export?${params}`, {\n   740→    headers: {\n   741→      Authorization: `Bearer ${authToken}`,\n   742→    },\n   743→  })\n   744→\n   745→  if (!response.ok) {\n   746→    throw new Error('Failed to export notebook')\n   747→  }\n   748→\n   749→  const result = await response.json()\n   750→  return result.data\n   751→}\n   752→\n   753→/**\n   754→ * Export a notebook as a comprehensive PDF document\n   755→ */\n   756→export async function exportNotebookAsPDF(\n   757→  notebookId: string,\n   758→  options: Omit<NotebookExportOptions, 'format'>,\n   759→  authToken: string\n   760→): Promise<void> {\n   761→  // First, fetch all data via JSON\n   762→  const exportData = await exportNotebookAsJson(notebookId, options, authToken)\n   763→\n   764→  const { jsPDF } = await import('jspdf')\n   765→\n   766→  const doc = new jsPDF({\n   767→    orientation: 'portrait',\n   768→    unit: 'mm',\n   769→    format: 'a4',\n   770→  })\n   771→\n   772→  const pageWidth = doc.internal.pageSize.getWidth()\n   773→  const pageHeight = doc.internal.pageSize.getHeight()\n   774→  const margin = 20\n   775→  const contentWidth = pageWidth - margin * 2\n   776→  let y = margin\n   777→\n   778→  // Helper to check for page break\n   779→  const checkPageBreak = (height: number) => {\n   780→    if (y + height > pageHeight - margin) {\n   781→      doc.addPage()\n   782→      y = margin\n   783→      return true\n   784→    }\n   785→    return false\n   786→  }\n   787→\n   788→  // Helper to add a section header\n   789→  const addSectionHeader = (title: string) => {\n   790→    checkPageBreak(20)\n   791→    doc.setFontSize(16)\n   792→    doc.setFont('helvetica', 'bold')\n   793→    doc.setTextColor(51, 51, 51)\n   794→    doc.text(title, margin, y)\n   795→    y += 10\n   796→    doc.setDrawColor(200, 200, 200)\n   797→    doc.line(margin, y, pageWidth - margin, y)\n   798→    y += 8\n   799→  }\n   800→\n   801→  // Title page\n   802→  doc.setFontSize(28)\n   803→  doc.setFont('helvetica', 'bold')\n   804→  doc.setTextColor(51, 51, 51)\n   805→  const title = exportData.notebook.name\n   806→  const titleLines = doc.splitTextToSize(title, contentWidth)\n   807→  doc.text(titleLines, margin, y + 30)\n   808→  y += 30 + titleLines.length * 12\n   809→\n   810→  if (exportData.notebook.description) {\n   811→    doc.setFontSize(12)\n   812→    doc.setFont('helvetica', 'normal')\n   813→    doc.setTextColor(102, 102, 102)\n   814→    const descLines = doc.splitTextToSize(exportData.notebook.description, contentWidth)\n   815→    doc.text(descLines, margin, y)\n   816→    y += descLines.length * 6 + 10\n   817→  }\n   818→\n   819→  doc.setFontSize(10)\n   820→  doc.setTextColor(150, 150, 150)\n   821→  doc.text(`Exported from NotebookLM Reimagined`, margin, y)\n   822→  y += 6\n   823→  doc.text(`Date: ${new Date().toLocaleDateString()}`, margin, y)\n   824→\n   825→  // New page for content\n   826→  doc.addPage()\n   827→  y = margin\n   828→\n   829→  // Table of Contents\n   830→  addSectionHeader('Table of Contents')\n   831→  doc.setFontSize(11)\n   832→  doc.setFont('helvetica', 'normal')\n   833→  doc.setTextColor(68, 68, 68)\n   834→\n   835→  let tocItems = []\n   836→  if (options.includeSources !== false && exportData.sources?.length) {\n   837→    tocItems.push(`Sources (${exportData.sources.length})`)\n   838→  }\n   839→  if (options.includeChats !== false && exportData.chat_sessions?.length) {\n   840→    tocItems.push(`Chat Sessions (${exportData.chat_sessions.length})`)\n   841→  }\n   842→  if (options.includeNotes !== false && exportData.notes?.length) {\n   843→    tocItems.push(`Notes (${exportData.notes.length})`)\n   844→  }\n   845→  if (options.includeGenerated !== false) {\n   846→    if (exportData.study_materials?.length) {\n   847→      tocItems.push(`Study Materials (${exportData.study_materials.length})`)\n   848→    }\n   849→    if (exportData.research_tasks?.length) {\n   850→      tocItems.push(`Research Reports (${exportData.research_tasks.length})`)\n   851→    }\n   852→  }\n   853→\n   854→  tocItems.forEach((item, idx) => {\n   855→    doc.text(`${idx + 1}. ${item}`, margin + 5, y)\n   856→    y += 7\n   857→  })\n   858→\n   859→  y += 10\n   860→\n   861→  // Sources section\n   862→  if (options.includeSources !== false && exportData.sources?.length) {\n   863→    doc.addPage()\n   864→    y = margin\n   865→    addSectionHeader('Sources')\n   866→\n   867→    for (const source of exportData.sources) {\n   868→      checkPageBreak(25)\n   869→\n   870→      doc.setFontSize(12)\n   871→      doc.setFont('helvetica', 'bold')\n   872→      doc.setTextColor(51, 51, 51)\n   873→      const sourceName = doc.splitTextToSize(source.name, contentWidth - 20)\n   874→      doc.text(sourceName, margin + 5, y)\n   875→      y += sourceName.length * 5 + 3\n   876→\n   877→      doc.setFontSize(9)\n   878→      doc.setFont('helvetica', 'normal')\n   879→      doc.setTextColor(102, 102, 102)\n   880→      doc.text(`Type: ${source.type} | Status: ${source.status}`, margin + 5, y)\n   881→      y += 5\n   882→\n   883→      // Add source guide summary if available\n   884→      if (source.source_guide) {\n   885→        const guide = source.source_guide as Record<string, unknown>\n   886→        if (guide.summary) {\n   887→          checkPageBreak(20)\n   888→          doc.setFontSize(10)\n   889→          doc.setTextColor(68, 68, 68)\n   890→          const summaryLines = doc.splitTextToSize(String(guide.summary), contentWidth - 10)\n   891→          doc.text(summaryLines.slice(0, 4), margin + 5, y)\n   892→          y += Math.min(summaryLines.length, 4) * 5\n   893→        }\n   894→      }\n   895→\n   896→      y += 8\n   897→    }\n   898→  }\n   899→\n   900→  // Chat sessions section\n   901→  if (options.includeChats !== false && exportData.chat_sessions?.length) {\n   902→    doc.addPage()\n   903→    y = margin\n   904→    addSectionHeader('Chat Sessions')\n   905→\n   906→    for (const session of exportData.chat_sessions) {\n   907→      checkPageBreak(15)\n   908→\n   909→      doc.setFontSize(12)\n   910→      doc.setFont('helvetica', 'bold')\n   911→      doc.setTextColor(51, 51, 51)\n   912→      doc.text(session.title || 'Untitled Session', margin + 5, y)\n   913→      y += 7\n   914→\n   915→      if (session.messages?.length) {\n   916→        doc.setFontSize(9)\n   917→        doc.setTextColor(102, 102, 102)\n   918→        doc.text(`${session.messages.length} messages`, margin + 5, y)\n   919→        y += 6\n   920→\n   921→        // Show first few messages as preview\n   922→        const previewMessages = session.messages.slice(0, 4)\n   923→        for (const msg of previewMessages) {\n   924→          checkPageBreak(15)\n   925→          doc.setFontSize(10)\n   926→          doc.setFont('helvetica', msg.role === 'user' ? 'bold' : 'normal')\n   927→          doc.setTextColor(msg.role === 'user' ? 51 : 68, msg.role === 'user' ? 51 : 68, msg.role === 'user' ? 51 : 68)\n   928→\n   929→          const prefix = msg.role === 'user' ? 'Q: ' : 'A: '\n   930→          const msgText = String(msg.content || '').slice(0, 200)\n   931→          const lines = doc.splitTextToSize(prefix + msgText + (msgText.length >= 200 ? '...' : ''), contentWidth - 15)\n   932→          doc.text(lines.slice(0, 3), margin + 10, y)\n   933→          y += Math.min(lines.length, 3) * 5 + 3\n   934→        }\n   935→\n   936→        if (session.messages.length > 4) {\n   937→          doc.setFontSize(9)\n   938→          doc.setTextColor(150, 150, 150)\n   939→          doc.text(`... and ${session.messages.length - 4} more messages`, margin + 10, y)\n   940→          y += 5\n   941→        }\n   942→      }\n   943→\n   944→      y += 8\n   945→    }\n   946→  }\n   947→\n   948→  // Notes section\n   949→  if (options.includeNotes !== false && exportData.notes?.length) {\n   950→    doc.addPage()\n   951→    y = margin\n   952→    addSectionHeader('Notes')\n   953→\n   954→    for (const note of exportData.notes) {\n   955→      checkPageBreak(30)\n   956→\n   957→      doc.setFontSize(12)\n   958→      doc.setFont('helvetica', 'bold')\n   959→      doc.setTextColor(51, 51, 51)\n   960→      doc.text(note.title || 'Untitled Note', margin + 5, y)\n   961→      y += 7\n   962→\n   963→      if (note.tags?.length) {\n   964→        doc.setFontSize(9)\n   965→        doc.setTextColor(102, 102, 102)\n   966→        doc.text(`Tags: ${note.tags.join(', ')}`, margin + 5, y)\n   967→        y += 5\n   968→      }\n   969→\n   970→      doc.setFontSize(10)\n   971→      doc.setFont('helvetica', 'normal')\n   972→      doc.setTextColor(68, 68, 68)\n   973→      const noteContent = String(note.content || '').slice(0, 500)\n   974→      const lines = doc.splitTextToSize(noteContent + (noteContent.length >= 500 ? '...' : ''), contentWidth - 10)\n   975→      doc.text(lines.slice(0, 8), margin + 5, y)\n   976→      y += Math.min(lines.length, 8) * 5 + 10\n   977→    }\n   978→  }\n   979→\n   980→  // Study materials section\n   981→  if (options.includeGenerated !== false && exportData.study_materials?.length) {\n   982→    doc.addPage()\n   983→    y = margin\n   984→    addSectionHeader('Study Materials')\n   985→\n   986→    for (const material of exportData.study_materials) {\n   987→      checkPageBreak(15)\n   988→\n   989→      doc.setFontSize(11)\n   990→      doc.setFont('helvetica', 'bold')\n   991→      doc.setTextColor(51, 51, 51)\n   992→\n   993→      const typeLabels: Record<string, string> = {\n   994→        flashcards: 'Flashcards',\n   995→        quiz: 'Quiz',\n   996→        study_guide: 'Study Guide',\n   997→        faq: 'FAQ',\n   998→        mind_map: 'Mind Map',\n   999→      }\n  1000→      doc.text(typeLabels[material.type] || material.type, margin + 5, y)\n  1001→      y += 6\n  1002→\n  1003→      doc.setFontSize(9)\n  1004→      doc.setTextColor(102, 102, 102)\n  1005→      doc.text(`Created: ${new Date(material.created_at).toLocaleDateString()}`, margin + 5, y)\n  1006→      y += 10\n  1007→    }\n  1008→  }\n  1009→\n  1010→  // Research reports section\n  1011→  if (options.includeGenerated !== false && exportData.research_tasks?.length) {\n  1012→    doc.addPage()\n  1013→    y = margin\n  1014→    addSectionHeader('Research Reports')\n  1015→\n  1016→    for (const research of exportData.research_tasks) {\n  1017→      checkPageBreak(30)\n  1018→\n  1019→      doc.setFontSize(12)\n  1020→      doc.setFont('helvetica', 'bold')\n  1021→      doc.setTextColor(51, 51, 51)\n  1022→      const queryLines = doc.splitTextToSize(research.query, contentWidth - 10)\n  1023→      doc.text(queryLines, margin + 5, y)\n  1024→      y += queryLines.length * 5 + 3\n  1025→\n  1026→      doc.setFontSize(9)\n  1027→      doc.setTextColor(102, 102, 102)\n  1028→      doc.text(`Status: ${research.status}`, margin + 5, y)\n  1029→      y += 6\n  1030→\n  1031→      if (research.report_content) {\n  1032→        doc.setFontSize(10)\n  1033→        doc.setFont('helvetica', 'normal')\n  1034→        doc.setTextColor(68, 68, 68)\n  1035→        const reportPreview = String(research.report_content).slice(0, 400)\n  1036→        const lines = doc.splitTextToSize(reportPreview + (reportPreview.length >= 400 ? '...' : ''), contentWidth - 10)\n  1037→        doc.text(lines.slice(0, 6), margin + 5, y)\n  1038→        y += Math.min(lines.length, 6) * 5\n  1039→      }\n  1040→\n  1041→      y += 10\n  1042→    }\n  1043→  }\n  1044→\n  1045→  // Footer with page numbers\n  1046→  const pageCount = doc.getNumberOfPages()\n  1047→  for (let i = 1; i <= pageCount; i++) {\n  1048→    doc.setPage(i)\n  1049→    doc.setFontSize(9)\n  1050→    doc.setFont('helvetica', 'normal')\n  1051→    doc.setTextColor(150, 150, 150)\n  1052→    doc.text(`Page ${i} of ${pageCount}`, pageWidth / 2, pageHeight - 10, { align: 'center' })\n  1053→    doc.text('Generated by NotebookLM Reimagined', margin, pageHeight - 10)\n  1054→  }\n  1055→\n  1056→  // Generate filename and save\n  1057→  const safeName = exportData.notebook.name.replace(/[^a-zA-Z0-9 _-]/g, '_')\n  1058→  const dateStr = new Date().toISOString().slice(0, 10).replace(/-/g, '')\n  1059→  doc.save(`notebook-export-${safeName}-${dateStr}.pdf`)\n  1060→}\n  1061→\n  1062→/**\n  1063→ * Export a notebook with the specified format\n  1064→ */\n  1065→export async function exportNotebook(\n  1066→  notebookId: string,\n  1067→  options: NotebookExportOptions,\n  1068→  authToken: string\n  1069→): Promise<void> {\n  1070→  switch (options.format) {\n  1071→    case 'zip':\n  1072→      return exportNotebookAsZip(notebookId, options, authToken)\n  1073→    case 'pdf':\n  1074→      return exportNotebookAsPDF(notebookId, options, authToken)\n  1075→    case 'json':\n  1076→      const data = await exportNotebookAsJson(notebookId, options, authToken)\n  1077→      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' })\n  1078→      const safeName = data.notebook.name.replace(/[^a-zA-Z0-9 _-]/g, '_')\n  1079→      const dateStr = new Date().toISOString().slice(0, 10).replace(/-/g, '')\n  1080→      downloadBlob(blob, `notebook-export-${safeName}-${dateStr}.json`)\n  1081→      return\n  1082→    default:\n  1083→      throw new Error(`Unsupported format: ${options.format}`)\n  1084→  }\n  1085→}\n  1086→"}]},"uuid":"56c9f1de-5ae1-4a51-a256-c17bea273c27","timestamp":"2026-01-10T17:30:32.796Z","toolUseResult":{"filePath":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend/src/lib/export-utils.ts","oldString":"/**\n * Trigger file download from blob\n */\nexport function downloadBlob(blob: Blob, filename: string): void {\n  const url = URL.createObjectURL(blob)\n  const link = document.createElement('a')\n  link.href = url\n  link.download = filename\n  document.body.appendChild(link)\n  link.click()\n  document.body.removeChild(link)\n  URL.revokeObjectURL(url)\n}","newString":"/**\n * Trigger file download from blob\n */\nexport function downloadBlob(blob: Blob, filename: string): void {\n  const url = URL.createObjectURL(blob)\n  const link = document.createElement('a')\n  link.href = url\n  link.download = filename\n  document.body.appendChild(link)\n  link.click()\n  document.body.removeChild(link)\n  URL.revokeObjectURL(url)\n}\n\n// ============================================================================\n// Notebook Export\n// ============================================================================\n\n/**\n * Options for notebook export\n */\nexport interface NotebookExportOptions {\n  includeSources?: boolean\n  includeChats?: boolean\n  includeNotes?: boolean\n  includeGenerated?: boolean\n  format: 'zip' | 'pdf' | 'json'\n}\n\n/**\n * Notebook export data structure\n */\nexport interface NotebookExportData {\n  notebook: {\n    id: string\n    name: string\n    description?: string\n    emoji?: string\n    settings?: Record<string, unknown>\n    created_at: string\n  }\n  exported_at: string\n  export_version: string\n  sources?: Array<{\n    id: string\n    name: string\n    type: string\n    status: string\n    created_at: string\n    metadata?: Record<string, unknown>\n    source_guide?: Record<string, unknown>\n  }>\n  chat_sessions?: Array<{\n    id: string\n    title?: string\n    created_at: string\n    messages?: Array<{\n      id: string\n      role: string\n      content: string\n      citations?: unknown[]\n      created_at: string\n    }>\n  }>\n  notes?: Array<{\n    id: string\n    title?: string\n    content: string\n    tags?: string[]\n    is_pinned?: boolean\n    created_at: string\n  }>\n  audio_overviews?: Array<{\n    id: string\n    format?: string\n    status: string\n    script?: unknown\n    created_at: string\n  }>\n  video_overviews?: Array<{\n    id: string\n    style?: string\n    status: string\n    script?: unknown\n    created_at: string\n  }>\n  study_materials?: Array<{\n    id: string\n    type: string\n    data: unknown\n    created_at: string\n  }>\n  studio_outputs?: Array<{\n    id: string\n    type: string\n    title?: string\n    content: unknown\n    created_at: string\n  }>\n  research_tasks?: Array<{\n    id: string\n    query: string\n    status: string\n    report_content?: string\n    created_at: string\n  }>\n}\n\n/**\n * Export a notebook as a ZIP file\n */\nexport async function exportNotebookAsZip(\n  notebookId: string,\n  options: Omit<NotebookExportOptions, 'format'>,\n  authToken: string\n): Promise<void> {\n  const params = new URLSearchParams({\n    format: 'zip',\n    includeSources: String(options.includeSources ?? true),\n    includeChats: String(options.includeChats ?? true),\n    includeNotes: String(options.includeNotes ?? true),\n    includeGenerated: String(options.includeGenerated ?? true),\n  })\n\n  const response = await fetch(`/api/notebooks/${notebookId}/export?${params}`, {\n    headers: {\n      Authorization: `Bearer ${authToken}`,\n    },\n  })\n\n  if (!response.ok) {\n    throw new Error('Failed to export notebook')\n  }\n\n  const blob = await response.blob()\n  const contentDisposition = response.headers.get('Content-Disposition')\n  let filename = `notebook-export-${notebookId}.zip`\n\n  if (contentDisposition) {\n    const match = contentDisposition.match(/filename=\"?([^\"]+)\"?/)\n    if (match) {\n      filename = match[1]\n    }\n  }\n\n  downloadBlob(blob, filename)\n}\n\n/**\n * Export a notebook as JSON\n */\nexport async function exportNotebookAsJson(\n  notebookId: string,\n  options: Omit<NotebookExportOptions, 'format'>,\n  authToken: string\n): Promise<NotebookExportData> {\n  const params = new URLSearchParams({\n    format: 'json',\n    includeSources: String(options.includeSources ?? true),\n    includeChats: String(options.includeChats ?? true),\n    includeNotes: String(options.includeNotes ?? true),\n    includeGenerated: String(options.includeGenerated ?? true),\n  })\n\n  const response = await fetch(`/api/notebooks/${notebookId}/export?${params}`, {\n    headers: {\n      Authorization: `Bearer ${authToken}`,\n    },\n  })\n\n  if (!response.ok) {\n    throw new Error('Failed to export notebook')\n  }\n\n  const result = await response.json()\n  return result.data\n}\n\n/**\n * Export a notebook as a comprehensive PDF document\n */\nexport async function exportNotebookAsPDF(\n  notebookId: string,\n  options: Omit<NotebookExportOptions, 'format'>,\n  authToken: string\n): Promise<void> {\n  // First, fetch all data via JSON\n  const exportData = await exportNotebookAsJson(notebookId, options, authToken)\n\n  const { jsPDF } = await import('jspdf')\n\n  const doc = new jsPDF({\n    orientation: 'portrait',\n    unit: 'mm',\n    format: 'a4',\n  })\n\n  const pageWidth = doc.internal.pageSize.getWidth()\n  const pageHeight = doc.internal.pageSize.getHeight()\n  const margin = 20\n  const contentWidth = pageWidth - margin * 2\n  let y = margin\n\n  // Helper to check for page break\n  const checkPageBreak = (height: number) => {\n    if (y + height > pageHeight - margin) {\n      doc.addPage()\n      y = margin\n      return true\n    }\n    return false\n  }\n\n  // Helper to add a section header\n  const addSectionHeader = (title: string) => {\n    checkPageBreak(20)\n    doc.setFontSize(16)\n    doc.setFont('helvetica', 'bold')\n    doc.setTextColor(51, 51, 51)\n    doc.text(title, margin, y)\n    y += 10\n    doc.setDrawColor(200, 200, 200)\n    doc.line(margin, y, pageWidth - margin, y)\n    y += 8\n  }\n\n  // Title page\n  doc.setFontSize(28)\n  doc.setFont('helvetica', 'bold')\n  doc.setTextColor(51, 51, 51)\n  const title = exportData.notebook.name\n  const titleLines = doc.splitTextToSize(title, contentWidth)\n  doc.text(titleLines, margin, y + 30)\n  y += 30 + titleLines.length * 12\n\n  if (exportData.notebook.description) {\n    doc.setFontSize(12)\n    doc.setFont('helvetica', 'normal')\n    doc.setTextColor(102, 102, 102)\n    const descLines = doc.splitTextToSize(exportData.notebook.description, contentWidth)\n    doc.text(descLines, margin, y)\n    y += descLines.length * 6 + 10\n  }\n\n  doc.setFontSize(10)\n  doc.setTextColor(150, 150, 150)\n  doc.text(`Exported from NotebookLM Reimagined`, margin, y)\n  y += 6\n  doc.text(`Date: ${new Date().toLocaleDateString()}`, margin, y)\n\n  // New page for content\n  doc.addPage()\n  y = margin\n\n  // Table of Contents\n  addSectionHeader('Table of Contents')\n  doc.setFontSize(11)\n  doc.setFont('helvetica', 'normal')\n  doc.setTextColor(68, 68, 68)\n\n  let tocItems = []\n  if (options.includeSources !== false && exportData.sources?.length) {\n    tocItems.push(`Sources (${exportData.sources.length})`)\n  }\n  if (options.includeChats !== false && exportData.chat_sessions?.length) {\n    tocItems.push(`Chat Sessions (${exportData.chat_sessions.length})`)\n  }\n  if (options.includeNotes !== false && exportData.notes?.length) {\n    tocItems.push(`Notes (${exportData.notes.length})`)\n  }\n  if (options.includeGenerated !== false) {\n    if (exportData.study_materials?.length) {\n      tocItems.push(`Study Materials (${exportData.study_materials.length})`)\n    }\n    if (exportData.research_tasks?.length) {\n      tocItems.push(`Research Reports (${exportData.research_tasks.length})`)\n    }\n  }\n\n  tocItems.forEach((item, idx) => {\n    doc.text(`${idx + 1}. ${item}`, margin + 5, y)\n    y += 7\n  })\n\n  y += 10\n\n  // Sources section\n  if (options.includeSources !== false && exportData.sources?.length) {\n    doc.addPage()\n    y = margin\n    addSectionHeader('Sources')\n\n    for (const source of exportData.sources) {\n      checkPageBreak(25)\n\n      doc.setFontSize(12)\n      doc.setFont('helvetica', 'bold')\n      doc.setTextColor(51, 51, 51)\n      const sourceName = doc.splitTextToSize(source.name, contentWidth - 20)\n      doc.text(sourceName, margin + 5, y)\n      y += sourceName.length * 5 + 3\n\n      doc.setFontSize(9)\n      doc.setFont('helvetica', 'normal')\n      doc.setTextColor(102, 102, 102)\n      doc.text(`Type: ${source.type} | Status: ${source.status}`, margin + 5, y)\n      y += 5\n\n      // Add source guide summary if available\n      if (source.source_guide) {\n        const guide = source.source_guide as Record<string, unknown>\n        if (guide.summary) {\n          checkPageBreak(20)\n          doc.setFontSize(10)\n          doc.setTextColor(68, 68, 68)\n          const summaryLines = doc.splitTextToSize(String(guide.summary), contentWidth - 10)\n          doc.text(summaryLines.slice(0, 4), margin + 5, y)\n          y += Math.min(summaryLines.length, 4) * 5\n        }\n      }\n\n      y += 8\n    }\n  }\n\n  // Chat sessions section\n  if (options.includeChats !== false && exportData.chat_sessions?.length) {\n    doc.addPage()\n    y = margin\n    addSectionHeader('Chat Sessions')\n\n    for (const session of exportData.chat_sessions) {\n      checkPageBreak(15)\n\n      doc.setFontSize(12)\n      doc.setFont('helvetica', 'bold')\n      doc.setTextColor(51, 51, 51)\n      doc.text(session.title || 'Untitled Session', margin + 5, y)\n      y += 7\n\n      if (session.messages?.length) {\n        doc.setFontSize(9)\n        doc.setTextColor(102, 102, 102)\n        doc.text(`${session.messages.length} messages`, margin + 5, y)\n        y += 6\n\n        // Show first few messages as preview\n        const previewMessages = session.messages.slice(0, 4)\n        for (const msg of previewMessages) {\n          checkPageBreak(15)\n          doc.setFontSize(10)\n          doc.setFont('helvetica', msg.role === 'user' ? 'bold' : 'normal')\n          doc.setTextColor(msg.role === 'user' ? 51 : 68, msg.role === 'user' ? 51 : 68, msg.role === 'user' ? 51 : 68)\n\n          const prefix = msg.role === 'user' ? 'Q: ' : 'A: '\n          const msgText = String(msg.content || '').slice(0, 200)\n          const lines = doc.splitTextToSize(prefix + msgText + (msgText.length >= 200 ? '...' : ''), contentWidth - 15)\n          doc.text(lines.slice(0, 3), margin + 10, y)\n          y += Math.min(lines.length, 3) * 5 + 3\n        }\n\n        if (session.messages.length > 4) {\n          doc.setFontSize(9)\n          doc.setTextColor(150, 150, 150)\n          doc.text(`... and ${session.messages.length - 4} more messages`, margin + 10, y)\n          y += 5\n        }\n      }\n\n      y += 8\n    }\n  }\n\n  // Notes section\n  if (options.includeNotes !== false && exportData.notes?.length) {\n    doc.addPage()\n    y = margin\n    addSectionHeader('Notes')\n\n    for (const note of exportData.notes) {\n      checkPageBreak(30)\n\n      doc.setFontSize(12)\n      doc.setFont('helvetica', 'bold')\n      doc.setTextColor(51, 51, 51)\n      doc.text(note.title || 'Untitled Note', margin + 5, y)\n      y += 7\n\n      if (note.tags?.length) {\n        doc.setFontSize(9)\n        doc.setTextColor(102, 102, 102)\n        doc.text(`Tags: ${note.tags.join(', ')}`, margin + 5, y)\n        y += 5\n      }\n\n      doc.setFontSize(10)\n      doc.setFont('helvetica', 'normal')\n      doc.setTextColor(68, 68, 68)\n      const noteContent = String(note.content || '').slice(0, 500)\n      const lines = doc.splitTextToSize(noteContent + (noteContent.length >= 500 ? '...' : ''), contentWidth - 10)\n      doc.text(lines.slice(0, 8), margin + 5, y)\n      y += Math.min(lines.length, 8) * 5 + 10\n    }\n  }\n\n  // Study materials section\n  if (options.includeGenerated !== false && exportData.study_materials?.length) {\n    doc.addPage()\n    y = margin\n    addSectionHeader('Study Materials')\n\n    for (const material of exportData.study_materials) {\n      checkPageBreak(15)\n\n      doc.setFontSize(11)\n      doc.setFont('helvetica', 'bold')\n      doc.setTextColor(51, 51, 51)\n\n      const typeLabels: Record<string, string> = {\n        flashcards: 'Flashcards',\n        quiz: 'Quiz',\n        study_guide: 'Study Guide',\n        faq: 'FAQ',\n        mind_map: 'Mind Map',\n      }\n      doc.text(typeLabels[material.type] || material.type, margin + 5, y)\n      y += 6\n\n      doc.setFontSize(9)\n      doc.setTextColor(102, 102, 102)\n      doc.text(`Created: ${new Date(material.created_at).toLocaleDateString()}`, margin + 5, y)\n      y += 10\n    }\n  }\n\n  // Research reports section\n  if (options.includeGenerated !== false && exportData.research_tasks?.length) {\n    doc.addPage()\n    y = margin\n    addSectionHeader('Research Reports')\n\n    for (const research of exportData.research_tasks) {\n      checkPageBreak(30)\n\n      doc.setFontSize(12)\n      doc.setFont('helvetica', 'bold')\n      doc.setTextColor(51, 51, 51)\n      const queryLines = doc.splitTextToSize(research.query, contentWidth - 10)\n      doc.text(queryLines, margin + 5, y)\n      y += queryLines.length * 5 + 3\n\n      doc.setFontSize(9)\n      doc.setTextColor(102, 102, 102)\n      doc.text(`Status: ${research.status}`, margin + 5, y)\n      y += 6\n\n      if (research.report_content) {\n        doc.setFontSize(10)\n        doc.setFont('helvetica', 'normal')\n        doc.setTextColor(68, 68, 68)\n        const reportPreview = String(research.report_content).slice(0, 400)\n        const lines = doc.splitTextToSize(reportPreview + (reportPreview.length >= 400 ? '...' : ''), contentWidth - 10)\n        doc.text(lines.slice(0, 6), margin + 5, y)\n        y += Math.min(lines.length, 6) * 5\n      }\n\n      y += 10\n    }\n  }\n\n  // Footer with page numbers\n  const pageCount = doc.getNumberOfPages()\n  for (let i = 1; i <= pageCount; i++) {\n    doc.setPage(i)\n    doc.setFontSize(9)\n    doc.setFont('helvetica', 'normal')\n    doc.setTextColor(150, 150, 150)\n    doc.text(`Page ${i} of ${pageCount}`, pageWidth / 2, pageHeight - 10, { align: 'center' })\n    doc.text('Generated by NotebookLM Reimagined', margin, pageHeight - 10)\n  }\n\n  // Generate filename and save\n  const safeName = exportData.notebook.name.replace(/[^a-zA-Z0-9 _-]/g, '_')\n  const dateStr = new Date().toISOString().slice(0, 10).replace(/-/g, '')\n  doc.save(`notebook-export-${safeName}-${dateStr}.pdf`)\n}\n\n/**\n * Export a notebook with the specified format\n */\nexport async function exportNotebook(\n  notebookId: string,\n  options: NotebookExportOptions,\n  authToken: string\n): Promise<void> {\n  switch (options.format) {\n    case 'zip':\n      return exportNotebookAsZip(notebookId, options, authToken)\n    case 'pdf':\n      return exportNotebookAsPDF(notebookId, options, authToken)\n    case 'json':\n      const data = await exportNotebookAsJson(notebookId, options, authToken)\n      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' })\n      const safeName = data.notebook.name.replace(/[^a-zA-Z0-9 _-]/g, '_')\n      const dateStr = new Date().toISOString().slice(0, 10).replace(/-/g, '')\n      downloadBlob(blob, `notebook-export-${safeName}-${dateStr}.json`)\n      return\n    default:\n      throw new Error(`Unsupported format: ${options.format}`)\n  }\n}","originalFile":"/**\n * Export utilities for downloading study materials\n * Supports XLSX (Excel), PDF, and PNG exports\n */\n\n// ============================================================================\n// Types\n// ============================================================================\n\nexport interface Flashcard {\n  id?: string\n  front: string\n  back: string\n  question?: string\n  answer?: string\n}\n\nexport interface QuizQuestion {\n  id?: string\n  question: string\n  options: string[]\n  correct_index: number\n  explanation: string\n}\n\nexport interface FAQItem {\n  question: string\n  answer: string\n}\n\nexport interface StudyGuideSection {\n  heading: string\n  content: string\n}\n\nexport interface StudyGuide {\n  title: string\n  sections: StudyGuideSection[]\n}\n\nexport interface MindMapNode {\n  id: string\n  label: string\n  description?: string\n  children?: MindMapNode[]\n}\n\n// ============================================================================\n// Excel (XLSX) Export\n// ============================================================================\n\n/**\n * Download data as an Excel file\n */\nexport async function downloadAsExcel(\n  data: Record<string, unknown>[],\n  filename: string,\n  sheetName = 'Sheet1'\n): Promise<void> {\n  // Dynamically import xlsx to avoid SSR issues\n  const XLSX = await import('xlsx')\n\n  // Create workbook and worksheet\n  const workbook = XLSX.utils.book_new()\n  const worksheet = XLSX.utils.json_to_sheet(data)\n\n  // Auto-size columns\n  const maxWidths: number[] = []\n  data.forEach(row => {\n    Object.values(row).forEach((val, idx) => {\n      const len = String(val || '').length\n      maxWidths[idx] = Math.max(maxWidths[idx] || 10, Math.min(len, 50))\n    })\n  })\n\n  // Set column widths\n  worksheet['!cols'] = maxWidths.map(w => ({ wch: w + 2 }))\n\n  // Add worksheet to workbook\n  XLSX.utils.book_append_sheet(workbook, worksheet, sheetName)\n\n  // Generate and download\n  XLSX.writeFile(workbook, `${filename}.xlsx`)\n}\n\n/**\n * Export flashcards to Excel\n */\nexport async function exportFlashcardsToExcel(\n  flashcards: Flashcard[],\n  filename = 'flashcards'\n): Promise<void> {\n  const data = flashcards.map((card, idx) => ({\n    '#': idx + 1,\n    'Question': card.front || card.question || '',\n    'Answer': card.back || card.answer || ''\n  }))\n\n  await downloadAsExcel(data, filename, 'Flashcards')\n}\n\n/**\n * Export quiz to Excel\n */\nexport async function exportQuizToExcel(\n  questions: QuizQuestion[],\n  filename = 'quiz'\n): Promise<void> {\n  const data = questions.map((q, idx) => ({\n    '#': idx + 1,\n    'Question': q.question,\n    'Option A': q.options[0] || '',\n    'Option B': q.options[1] || '',\n    'Option C': q.options[2] || '',\n    'Option D': q.options[3] || '',\n    'Correct Answer': String.fromCharCode(65 + q.correct_index), // A, B, C, D\n    'Explanation': q.explanation\n  }))\n\n  await downloadAsExcel(data, filename, 'Quiz Questions')\n}\n\n/**\n * Export FAQ to Excel\n */\nexport async function exportFAQToExcel(\n  items: FAQItem[],\n  filename = 'faq'\n): Promise<void> {\n  const data = items.map((item, idx) => ({\n    '#': idx + 1,\n    'Question': item.question,\n    'Answer': item.answer\n  }))\n\n  await downloadAsExcel(data, filename, 'FAQ')\n}\n\n// ============================================================================\n// PDF Export\n// ============================================================================\n\n/**\n * Generate and download a PDF document\n */\nexport async function downloadAsPDF(\n  content: PDFContent,\n  filename: string\n): Promise<void> {\n  const { jsPDF } = await import('jspdf')\n\n  const doc = new jsPDF({\n    orientation: 'portrait',\n    unit: 'mm',\n    format: 'a4'\n  })\n\n  const pageWidth = doc.internal.pageSize.getWidth()\n  const pageHeight = doc.internal.pageSize.getHeight()\n  const margin = 20\n  const contentWidth = pageWidth - (margin * 2)\n  let y = margin\n\n  // Helper to check for page break\n  const checkPageBreak = (height: number) => {\n    if (y + height > pageHeight - margin) {\n      doc.addPage()\n      y = margin\n      return true\n    }\n    return false\n  }\n\n  // Title\n  if (content.title) {\n    doc.setFontSize(24)\n    doc.setFont('helvetica', 'bold')\n    doc.setTextColor(51, 51, 51)\n    const titleLines = doc.splitTextToSize(content.title, contentWidth)\n    doc.text(titleLines, margin, y)\n    y += titleLines.length * 10 + 10\n  }\n\n  // Subtitle\n  if (content.subtitle) {\n    doc.setFontSize(12)\n    doc.setFont('helvetica', 'normal')\n    doc.setTextColor(102, 102, 102)\n    doc.text(content.subtitle, margin, y)\n    y += 15\n  }\n\n  // Divider line\n  doc.setDrawColor(200, 200, 200)\n  doc.line(margin, y, pageWidth - margin, y)\n  y += 15\n\n  // Sections\n  if (content.sections) {\n    for (const section of content.sections) {\n      checkPageBreak(30)\n\n      // Section heading\n      doc.setFontSize(16)\n      doc.setFont('helvetica', 'bold')\n      doc.setTextColor(51, 51, 51)\n      const headingLines = doc.splitTextToSize(section.heading, contentWidth)\n      doc.text(headingLines, margin, y)\n      y += headingLines.length * 7 + 5\n\n      // Section content\n      doc.setFontSize(11)\n      doc.setFont('helvetica', 'normal')\n      doc.setTextColor(68, 68, 68)\n\n      const contentLines = doc.splitTextToSize(section.content, contentWidth)\n      for (const line of contentLines) {\n        checkPageBreak(6)\n        doc.text(line, margin, y)\n        y += 6\n      }\n\n      y += 10 // Space after section\n    }\n  }\n\n  // Footer with page numbers\n  const pageCount = doc.getNumberOfPages()\n  for (let i = 1; i <= pageCount; i++) {\n    doc.setPage(i)\n    doc.setFontSize(9)\n    doc.setFont('helvetica', 'normal')\n    doc.setTextColor(150, 150, 150)\n    doc.text(\n      `Page ${i} of ${pageCount}`,\n      pageWidth / 2,\n      pageHeight - 10,\n      { align: 'center' }\n    )\n    doc.text(\n      'Generated by NotebookLM Reimagined',\n      margin,\n      pageHeight - 10\n    )\n  }\n\n  doc.save(`${filename}.pdf`)\n}\n\ninterface PDFContent {\n  title?: string\n  subtitle?: string\n  sections?: { heading: string; content: string }[]\n}\n\n/**\n * Export study guide to PDF\n */\nexport async function exportStudyGuideToPDF(\n  guide: StudyGuide,\n  filename = 'study-guide'\n): Promise<void> {\n  await downloadAsPDF(\n    {\n      title: guide.title,\n      subtitle: `${guide.sections.length} sections • Generated study guide`,\n      sections: guide.sections.map(section => ({\n        heading: section.heading,\n        content: section.content.replace(/\\*\\*/g, '').replace(/\\*/g, '') // Strip markdown\n      }))\n    },\n    filename\n  )\n}\n\n/**\n * Export flashcards to PDF\n */\nexport async function exportFlashcardsToPDF(\n  flashcards: Flashcard[],\n  title = 'Flashcards',\n  filename = 'flashcards'\n): Promise<void> {\n  const { jsPDF } = await import('jspdf')\n\n  const doc = new jsPDF({\n    orientation: 'portrait',\n    unit: 'mm',\n    format: 'a4'\n  })\n\n  const pageWidth = doc.internal.pageSize.getWidth()\n  const pageHeight = doc.internal.pageSize.getHeight()\n  const margin = 20\n  const contentWidth = pageWidth - (margin * 2)\n  let y = margin\n\n  // Title\n  doc.setFontSize(24)\n  doc.setFont('helvetica', 'bold')\n  doc.setTextColor(51, 51, 51)\n  doc.text(title, margin, y)\n  y += 15\n\n  // Subtitle\n  doc.setFontSize(12)\n  doc.setFont('helvetica', 'normal')\n  doc.setTextColor(102, 102, 102)\n  doc.text(`${flashcards.length} cards`, margin, y)\n  y += 15\n\n  // Cards\n  flashcards.forEach((card, idx) => {\n    // Check if we need a new page\n    if (y + 50 > pageHeight - margin) {\n      doc.addPage()\n      y = margin\n    }\n\n    // Card container\n    doc.setFillColor(245, 245, 245)\n    doc.roundedRect(margin, y, contentWidth, 45, 3, 3, 'F')\n\n    // Card number\n    doc.setFontSize(10)\n    doc.setFont('helvetica', 'bold')\n    doc.setTextColor(102, 102, 102)\n    doc.text(`Card ${idx + 1}`, margin + 5, y + 8)\n\n    // Question\n    doc.setFontSize(11)\n    doc.setFont('helvetica', 'bold')\n    doc.setTextColor(51, 51, 51)\n    const question = card.front || card.question || ''\n    const qLines = doc.splitTextToSize(`Q: ${question}`, contentWidth - 10)\n    doc.text(qLines.slice(0, 2), margin + 5, y + 18)\n\n    // Answer\n    doc.setFont('helvetica', 'normal')\n    doc.setTextColor(68, 68, 68)\n    const answer = card.back || card.answer || ''\n    const aLines = doc.splitTextToSize(`A: ${answer}`, contentWidth - 10)\n    doc.text(aLines.slice(0, 2), margin + 5, y + 32)\n\n    y += 52\n  })\n\n  doc.save(`${filename}.pdf`)\n}\n\n/**\n * Export quiz to PDF\n */\nexport async function exportQuizToPDF(\n  questions: QuizQuestion[],\n  title = 'Quiz',\n  filename = 'quiz'\n): Promise<void> {\n  const { jsPDF } = await import('jspdf')\n\n  const doc = new jsPDF({\n    orientation: 'portrait',\n    unit: 'mm',\n    format: 'a4'\n  })\n\n  const pageWidth = doc.internal.pageSize.getWidth()\n  const pageHeight = doc.internal.pageSize.getHeight()\n  const margin = 20\n  const contentWidth = pageWidth - (margin * 2)\n  let y = margin\n\n  // Title\n  doc.setFontSize(24)\n  doc.setFont('helvetica', 'bold')\n  doc.setTextColor(51, 51, 51)\n  doc.text(title, margin, y)\n  y += 15\n\n  // Subtitle\n  doc.setFontSize(12)\n  doc.setFont('helvetica', 'normal')\n  doc.setTextColor(102, 102, 102)\n  doc.text(`${questions.length} questions`, margin, y)\n  y += 15\n\n  // Questions\n  questions.forEach((q, idx) => {\n    // Check if we need a new page\n    if (y + 60 > pageHeight - margin) {\n      doc.addPage()\n      y = margin\n    }\n\n    // Question number and text\n    doc.setFontSize(12)\n    doc.setFont('helvetica', 'bold')\n    doc.setTextColor(51, 51, 51)\n    const qLines = doc.splitTextToSize(`${idx + 1}. ${q.question}`, contentWidth)\n    doc.text(qLines, margin, y)\n    y += qLines.length * 6 + 4\n\n    // Options\n    doc.setFontSize(10)\n    doc.setFont('helvetica', 'normal')\n    q.options.forEach((opt, optIdx) => {\n      const isCorrect = optIdx === q.correct_index\n      doc.setTextColor(isCorrect ? 34 : 68, isCorrect ? 139 : 68, isCorrect ? 34 : 68)\n      const optLine = `${String.fromCharCode(65 + optIdx)}) ${opt}${isCorrect ? ' ✓' : ''}`\n      const optLines = doc.splitTextToSize(optLine, contentWidth - 10)\n      doc.text(optLines, margin + 5, y)\n      y += optLines.length * 5 + 2\n    })\n\n    // Explanation\n    if (q.explanation) {\n      doc.setFontSize(9)\n      doc.setFont('helvetica', 'italic')\n      doc.setTextColor(102, 102, 102)\n      const expLines = doc.splitTextToSize(`💡 ${q.explanation}`, contentWidth - 10)\n      doc.text(expLines.slice(0, 2), margin + 5, y + 2)\n      y += Math.min(expLines.length, 2) * 4 + 4\n    }\n\n    y += 10\n  })\n\n  doc.save(`${filename}.pdf`)\n}\n\n/**\n * Export FAQ to PDF\n */\nexport async function exportFAQToPDF(\n  items: FAQItem[],\n  title = 'Frequently Asked Questions',\n  filename = 'faq'\n): Promise<void> {\n  await downloadAsPDF(\n    {\n      title,\n      subtitle: `${items.length} questions`,\n      sections: items.map((item, idx) => ({\n        heading: `Q${idx + 1}: ${item.question}`,\n        content: item.answer\n      }))\n    },\n    filename\n  )\n}\n\n// ============================================================================\n// Image (PNG) Export\n// ============================================================================\n\n/**\n * Export SVG element to PNG\n */\nexport async function exportSVGToPNG(\n  svgElement: SVGSVGElement,\n  filename: string,\n  options: { scale?: number; backgroundColor?: string } = {}\n): Promise<void> {\n  const { scale = 2, backgroundColor = '#1a1a2e' } = options\n\n  // Get SVG dimensions\n  const bbox = svgElement.getBBox()\n  const viewBox = svgElement.getAttribute('viewBox')?.split(' ').map(Number) || [0, 0, 800, 600]\n  const width = viewBox[2] || bbox.width || 800\n  const height = viewBox[3] || bbox.height || 600\n\n  // Create canvas\n  const canvas = document.createElement('canvas')\n  canvas.width = width * scale\n  canvas.height = height * scale\n  const ctx = canvas.getContext('2d')\n\n  if (!ctx) {\n    throw new Error('Could not get canvas context')\n  }\n\n  // Fill background\n  ctx.fillStyle = backgroundColor\n  ctx.fillRect(0, 0, canvas.width, canvas.height)\n  ctx.scale(scale, scale)\n\n  // Clone SVG and inline styles to avoid cross-origin issues\n  const clonedSvg = svgElement.cloneNode(true) as SVGSVGElement\n\n  // Ensure SVG has proper dimensions\n  clonedSvg.setAttribute('width', String(width))\n  clonedSvg.setAttribute('height', String(height))\n\n  // Remove any external references that could cause CORS issues\n  const images = clonedSvg.querySelectorAll('image')\n  images.forEach(img => {\n    const href = img.getAttribute('href') || img.getAttribute('xlink:href')\n    // Remove external image references that could taint canvas\n    if (href && !href.startsWith('data:')) {\n      img.remove()\n    }\n  })\n\n  // Convert SVG to base64 data URL (avoids CORS tainting)\n  const svgData = new XMLSerializer().serializeToString(clonedSvg)\n  const svgBase64 = btoa(unescape(encodeURIComponent(svgData)))\n  const svgDataUrl = `data:image/svg+xml;base64,${svgBase64}`\n\n  return new Promise((resolve, reject) => {\n    const img = new Image()\n    img.onload = () => {\n      try {\n        ctx.drawImage(img, 0, 0)\n        // Download\n        const link = document.createElement('a')\n        link.download = `${filename}.png`\n        link.href = canvas.toDataURL('image/png')\n        link.click()\n        resolve()\n      } catch (error) {\n        // Fallback: download as SVG if PNG export fails\n        console.error('PNG export failed, falling back to SVG:', error)\n        const svgBlob = new Blob([svgData], { type: 'image/svg+xml;charset=utf-8' })\n        const link = document.createElement('a')\n        link.download = `${filename}.svg`\n        link.href = URL.createObjectURL(svgBlob)\n        link.click()\n        URL.revokeObjectURL(link.href)\n        resolve()\n      }\n    }\n    img.onerror = () => {\n      // Fallback: download as SVG if image load fails\n      console.error('Image load failed, falling back to SVG')\n      const svgBlob = new Blob([svgData], { type: 'image/svg+xml;charset=utf-8' })\n      const link = document.createElement('a')\n      link.download = `${filename}.svg`\n      link.href = URL.createObjectURL(svgBlob)\n      link.click()\n      URL.revokeObjectURL(link.href)\n      resolve()\n    }\n    img.src = svgDataUrl\n  })\n}\n\n/**\n * Export Mind Map to PNG\n * Takes the SVG element from the mind map viewer and converts to PNG\n */\nexport async function exportMindMapToPNG(\n  svgElement: SVGSVGElement,\n  title: string,\n  filename = 'mind-map'\n): Promise<void> {\n  await exportSVGToPNG(svgElement, filename, {\n    scale: 2,\n    backgroundColor: '#1e1e2e'\n  })\n}\n\n// ============================================================================\n// Generic Utilities\n// ============================================================================\n\n/**\n * Generate a timestamped filename\n */\nexport function generateFilename(base: string): string {\n  const date = new Date()\n  const timestamp = date.toISOString().slice(0, 10).replace(/-/g, '')\n  return `${base}_${timestamp}`\n}\n\n/**\n * Trigger file download from blob\n */\nexport function downloadBlob(blob: Blob, filename: string): void {\n  const url = URL.createObjectURL(blob)\n  const link = document.createElement('a')\n  link.href = url\n  link.download = filename\n  document.body.appendChild(link)\n  link.click()\n  document.body.removeChild(link)\n  URL.revokeObjectURL(url)\n}\n","structuredPatch":[{"oldStart":585,"oldLines":3,"newStart":585,"newLines":501,"lines":["   document.body.removeChild(link)","   URL.revokeObjectURL(url)"," }","+","+// ============================================================================","+// Notebook Export","+// ============================================================================","+","+/**","+ * Options for notebook export","+ */","+export interface NotebookExportOptions {","+  includeSources?: boolean","+  includeChats?: boolean","+  includeNotes?: boolean","+  includeGenerated?: boolean","+  format: 'zip' | 'pdf' | 'json'","+}","+","+/**","+ * Notebook export data structure","+ */","+export interface NotebookExportData {","+  notebook: {","+    id: string","+    name: string","+    description?: string","+    emoji?: string","+    settings?: Record<string, unknown>","+    created_at: string","+  }","+  exported_at: string","+  export_version: string","+  sources?: Array<{","+    id: string","+    name: string","+    type: string","+    status: string","+    created_at: string","+    metadata?: Record<string, unknown>","+    source_guide?: Record<string, unknown>","+  }>","+  chat_sessions?: Array<{","+    id: string","+    title?: string","+    created_at: string","+    messages?: Array<{","+      id: string","+      role: string","+      content: string","+      citations?: unknown[]","+      created_at: string","+    }>","+  }>","+  notes?: Array<{","+    id: string","+    title?: string","+    content: string","+    tags?: string[]","+    is_pinned?: boolean","+    created_at: string","+  }>","+  audio_overviews?: Array<{","+    id: string","+    format?: string","+    status: string","+    script?: unknown","+    created_at: string","+  }>","+  video_overviews?: Array<{","+    id: string","+    style?: string","+    status: string","+    script?: unknown","+    created_at: string","+  }>","+  study_materials?: Array<{","+    id: string","+    type: string","+    data: unknown","+    created_at: string","+  }>","+  studio_outputs?: Array<{","+    id: string","+    type: string","+    title?: string","+    content: unknown","+    created_at: string","+  }>","+  research_tasks?: Array<{","+    id: string","+    query: string","+    status: string","+    report_content?: string","+    created_at: string","+  }>","+}","+","+/**","+ * Export a notebook as a ZIP file","+ */","+export async function exportNotebookAsZip(","+  notebookId: string,","+  options: Omit<NotebookExportOptions, 'format'>,","+  authToken: string","+): Promise<void> {","+  const params = new URLSearchParams({","+    format: 'zip',","+    includeSources: String(options.includeSources ?? true),","+    includeChats: String(options.includeChats ?? true),","+    includeNotes: String(options.includeNotes ?? true),","+    includeGenerated: String(options.includeGenerated ?? true),","+  })","+","+  const response = await fetch(`/api/notebooks/${notebookId}/export?${params}`, {","+    headers: {","+      Authorization: `Bearer ${authToken}`,","+    },","+  })","+","+  if (!response.ok) {","+    throw new Error('Failed to export notebook')","+  }","+","+  const blob = await response.blob()","+  const contentDisposition = response.headers.get('Content-Disposition')","+  let filename = `notebook-export-${notebookId}.zip`","+","+  if (contentDisposition) {","+    const match = contentDisposition.match(/filename=\"?([^\"]+)\"?/)","+    if (match) {","+      filename = match[1]","+    }","+  }","+","+  downloadBlob(blob, filename)","+}","+","+/**","+ * Export a notebook as JSON","+ */","+export async function exportNotebookAsJson(","+  notebookId: string,","+  options: Omit<NotebookExportOptions, 'format'>,","+  authToken: string","+): Promise<NotebookExportData> {","+  const params = new URLSearchParams({","+    format: 'json',","+    includeSources: String(options.includeSources ?? true),","+    includeChats: String(options.includeChats ?? true),","+    includeNotes: String(options.includeNotes ?? true),","+    includeGenerated: String(options.includeGenerated ?? true),","+  })","+","+  const response = await fetch(`/api/notebooks/${notebookId}/export?${params}`, {","+    headers: {","+      Authorization: `Bearer ${authToken}`,","+    },","+  })","+","+  if (!response.ok) {","+    throw new Error('Failed to export notebook')","+  }","+","+  const result = await response.json()","+  return result.data","+}","+","+/**","+ * Export a notebook as a comprehensive PDF document","+ */","+export async function exportNotebookAsPDF(","+  notebookId: string,","+  options: Omit<NotebookExportOptions, 'format'>,","+  authToken: string","+): Promise<void> {","+  // First, fetch all data via JSON","+  const exportData = await exportNotebookAsJson(notebookId, options, authToken)","+","+  const { jsPDF } = await import('jspdf')","+","+  const doc = new jsPDF({","+    orientation: 'portrait',","+    unit: 'mm',","+    format: 'a4',","+  })","+","+  const pageWidth = doc.internal.pageSize.getWidth()","+  const pageHeight = doc.internal.pageSize.getHeight()","+  const margin = 20","+  const contentWidth = pageWidth - margin * 2","+  let y = margin","+","+  // Helper to check for page break","+  const checkPageBreak = (height: number) => {","+    if (y + height > pageHeight - margin) {","+      doc.addPage()","+      y = margin","+      return true","+    }","+    return false","+  }","+","+  // Helper to add a section header","+  const addSectionHeader = (title: string) => {","+    checkPageBreak(20)","+    doc.setFontSize(16)","+    doc.setFont('helvetica', 'bold')","+    doc.setTextColor(51, 51, 51)","+    doc.text(title, margin, y)","+    y += 10","+    doc.setDrawColor(200, 200, 200)","+    doc.line(margin, y, pageWidth - margin, y)","+    y += 8","+  }","+","+  // Title page","+  doc.setFontSize(28)","+  doc.setFont('helvetica', 'bold')","+  doc.setTextColor(51, 51, 51)","+  const title = exportData.notebook.name","+  const titleLines = doc.splitTextToSize(title, contentWidth)","+  doc.text(titleLines, margin, y + 30)","+  y += 30 + titleLines.length * 12","+","+  if (exportData.notebook.description) {","+    doc.setFontSize(12)","+    doc.setFont('helvetica', 'normal')","+    doc.setTextColor(102, 102, 102)","+    const descLines = doc.splitTextToSize(exportData.notebook.description, contentWidth)","+    doc.text(descLines, margin, y)","+    y += descLines.length * 6 + 10","+  }","+","+  doc.setFontSize(10)","+  doc.setTextColor(150, 150, 150)","+  doc.text(`Exported from NotebookLM Reimagined`, margin, y)","+  y += 6","+  doc.text(`Date: ${new Date().toLocaleDateString()}`, margin, y)","+","+  // New page for content","+  doc.addPage()","+  y = margin","+","+  // Table of Contents","+  addSectionHeader('Table of Contents')","+  doc.setFontSize(11)","+  doc.setFont('helvetica', 'normal')","+  doc.setTextColor(68, 68, 68)","+","+  let tocItems = []","+  if (options.includeSources !== false && exportData.sources?.length) {","+    tocItems.push(`Sources (${exportData.sources.length})`)","+  }","+  if (options.includeChats !== false && exportData.chat_sessions?.length) {","+    tocItems.push(`Chat Sessions (${exportData.chat_sessions.length})`)","+  }","+  if (options.includeNotes !== false && exportData.notes?.length) {","+    tocItems.push(`Notes (${exportData.notes.length})`)","+  }","+  if (options.includeGenerated !== false) {","+    if (exportData.study_materials?.length) {","+      tocItems.push(`Study Materials (${exportData.study_materials.length})`)","+    }","+    if (exportData.research_tasks?.length) {","+      tocItems.push(`Research Reports (${exportData.research_tasks.length})`)","+    }","+  }","+","+  tocItems.forEach((item, idx) => {","+    doc.text(`${idx + 1}. ${item}`, margin + 5, y)","+    y += 7","+  })","+","+  y += 10","+","+  // Sources section","+  if (options.includeSources !== false && exportData.sources?.length) {","+    doc.addPage()","+    y = margin","+    addSectionHeader('Sources')","+","+    for (const source of exportData.sources) {","+      checkPageBreak(25)","+","+      doc.setFontSize(12)","+      doc.setFont('helvetica', 'bold')","+      doc.setTextColor(51, 51, 51)","+      const sourceName = doc.splitTextToSize(source.name, contentWidth - 20)","+      doc.text(sourceName, margin + 5, y)","+      y += sourceName.length * 5 + 3","+","+      doc.setFontSize(9)","+      doc.setFont('helvetica', 'normal')","+      doc.setTextColor(102, 102, 102)","+      doc.text(`Type: ${source.type} | Status: ${source.status}`, margin + 5, y)","+      y += 5","+","+      // Add source guide summary if available","+      if (source.source_guide) {","+        const guide = source.source_guide as Record<string, unknown>","+        if (guide.summary) {","+          checkPageBreak(20)","+          doc.setFontSize(10)","+          doc.setTextColor(68, 68, 68)","+          const summaryLines = doc.splitTextToSize(String(guide.summary), contentWidth - 10)","+          doc.text(summaryLines.slice(0, 4), margin + 5, y)","+          y += Math.min(summaryLines.length, 4) * 5","+        }","+      }","+","+      y += 8","+    }","+  }","+","+  // Chat sessions section","+  if (options.includeChats !== false && exportData.chat_sessions?.length) {","+    doc.addPage()","+    y = margin","+    addSectionHeader('Chat Sessions')","+","+    for (const session of exportData.chat_sessions) {","+      checkPageBreak(15)","+","+      doc.setFontSize(12)","+      doc.setFont('helvetica', 'bold')","+      doc.setTextColor(51, 51, 51)","+      doc.text(session.title || 'Untitled Session', margin + 5, y)","+      y += 7","+","+      if (session.messages?.length) {","+        doc.setFontSize(9)","+        doc.setTextColor(102, 102, 102)","+        doc.text(`${session.messages.length} messages`, margin + 5, y)","+        y += 6","+","+        // Show first few messages as preview","+        const previewMessages = session.messages.slice(0, 4)","+        for (const msg of previewMessages) {","+          checkPageBreak(15)","+          doc.setFontSize(10)","+          doc.setFont('helvetica', msg.role === 'user' ? 'bold' : 'normal')","+          doc.setTextColor(msg.role === 'user' ? 51 : 68, msg.role === 'user' ? 51 : 68, msg.role === 'user' ? 51 : 68)","+","+          const prefix = msg.role === 'user' ? 'Q: ' : 'A: '","+          const msgText = String(msg.content || '').slice(0, 200)","+          const lines = doc.splitTextToSize(prefix + msgText + (msgText.length >= 200 ? '...' : ''), contentWidth - 15)","+          doc.text(lines.slice(0, 3), margin + 10, y)","+          y += Math.min(lines.length, 3) * 5 + 3","+        }","+","+        if (session.messages.length > 4) {","+          doc.setFontSize(9)","+          doc.setTextColor(150, 150, 150)","+          doc.text(`... and ${session.messages.length - 4} more messages`, margin + 10, y)","+          y += 5","+        }","+      }","+","+      y += 8","+    }","+  }","+","+  // Notes section","+  if (options.includeNotes !== false && exportData.notes?.length) {","+    doc.addPage()","+    y = margin","+    addSectionHeader('Notes')","+","+    for (const note of exportData.notes) {","+      checkPageBreak(30)","+","+      doc.setFontSize(12)","+      doc.setFont('helvetica', 'bold')","+      doc.setTextColor(51, 51, 51)","+      doc.text(note.title || 'Untitled Note', margin + 5, y)","+      y += 7","+","+      if (note.tags?.length) {","+        doc.setFontSize(9)","+        doc.setTextColor(102, 102, 102)","+        doc.text(`Tags: ${note.tags.join(', ')}`, margin + 5, y)","+        y += 5","+      }","+","+      doc.setFontSize(10)","+      doc.setFont('helvetica', 'normal')","+      doc.setTextColor(68, 68, 68)","+      const noteContent = String(note.content || '').slice(0, 500)","+      const lines = doc.splitTextToSize(noteContent + (noteContent.length >= 500 ? '...' : ''), contentWidth - 10)","+      doc.text(lines.slice(0, 8), margin + 5, y)","+      y += Math.min(lines.length, 8) * 5 + 10","+    }","+  }","+","+  // Study materials section","+  if (options.includeGenerated !== false && exportData.study_materials?.length) {","+    doc.addPage()","+    y = margin","+    addSectionHeader('Study Materials')","+","+    for (const material of exportData.study_materials) {","+      checkPageBreak(15)","+","+      doc.setFontSize(11)","+      doc.setFont('helvetica', 'bold')","+      doc.setTextColor(51, 51, 51)","+","+      const typeLabels: Record<string, string> = {","+        flashcards: 'Flashcards',","+        quiz: 'Quiz',","+        study_guide: 'Study Guide',","+        faq: 'FAQ',","+        mind_map: 'Mind Map',","+      }","+      doc.text(typeLabels[material.type] || material.type, margin + 5, y)","+      y += 6","+","+      doc.setFontSize(9)","+      doc.setTextColor(102, 102, 102)","+      doc.text(`Created: ${new Date(material.created_at).toLocaleDateString()}`, margin + 5, y)","+      y += 10","+    }","+  }","+","+  // Research reports section","+  if (options.includeGenerated !== false && exportData.research_tasks?.length) {","+    doc.addPage()","+    y = margin","+    addSectionHeader('Research Reports')","+","+    for (const research of exportData.research_tasks) {","+      checkPageBreak(30)","+","+      doc.setFontSize(12)","+      doc.setFont('helvetica', 'bold')","+      doc.setTextColor(51, 51, 51)","+      const queryLines = doc.splitTextToSize(research.query, contentWidth - 10)","+      doc.text(queryLines, margin + 5, y)","+      y += queryLines.length * 5 + 3","+","+      doc.setFontSize(9)","+      doc.setTextColor(102, 102, 102)","+      doc.text(`Status: ${research.status}`, margin + 5, y)","+      y += 6","+","+      if (research.report_content) {","+        doc.setFontSize(10)","+        doc.setFont('helvetica', 'normal')","+        doc.setTextColor(68, 68, 68)","+        const reportPreview = String(research.report_content).slice(0, 400)","+        const lines = doc.splitTextToSize(reportPreview + (reportPreview.length >= 400 ? '...' : ''), contentWidth - 10)","+        doc.text(lines.slice(0, 6), margin + 5, y)","+        y += Math.min(lines.length, 6) * 5","+      }","+","+      y += 10","+    }","+  }","+","+  // Footer with page numbers","+  const pageCount = doc.getNumberOfPages()","+  for (let i = 1; i <= pageCount; i++) {","+    doc.setPage(i)","+    doc.setFontSize(9)","+    doc.setFont('helvetica', 'normal')","+    doc.setTextColor(150, 150, 150)","+    doc.text(`Page ${i} of ${pageCount}`, pageWidth / 2, pageHeight - 10, { align: 'center' })","+    doc.text('Generated by NotebookLM Reimagined', margin, pageHeight - 10)","+  }","+","+  // Generate filename and save","+  const safeName = exportData.notebook.name.replace(/[^a-zA-Z0-9 _-]/g, '_')","+  const dateStr = new Date().toISOString().slice(0, 10).replace(/-/g, '')","+  doc.save(`notebook-export-${safeName}-${dateStr}.pdf`)","+}","+","+/**","+ * Export a notebook with the specified format","+ */","+export async function exportNotebook(","+  notebookId: string,","+  options: NotebookExportOptions,","+  authToken: string","+): Promise<void> {","+  switch (options.format) {","+    case 'zip':","+      return exportNotebookAsZip(notebookId, options, authToken)","+    case 'pdf':","+      return exportNotebookAsPDF(notebookId, options, authToken)","+    case 'json':","+      const data = await exportNotebookAsJson(notebookId, options, authToken)","+      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' })","+      const safeName = data.notebook.name.replace(/[^a-zA-Z0-9 _-]/g, '_')","+      const dateStr = new Date().toISOString().slice(0, 10).replace(/-/g, '')","+      downloadBlob(blob, `notebook-export-${safeName}-${dateStr}.json`)","+      return","+    default:","+      throw new Error(`Unsupported format: ${options.format}`)","+  }","+}"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"4dddbdaa-27a9-40a0-acf6-2d4dc0c0093f"}
{"parentUuid":"56c9f1de-5ae1-4a51-a256-c17bea273c27","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","message":{"model":"claude-opus-4-5-20251101","id":"msg_01J3F1FcGezjFqbm92Bf3Cks","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Now let me update the todo list and add the export UI to the studio-panel.tsx.","signature":"EvYBCkYICxgCKkDb8KE9uS/ts2jYTc8is4N12Hfe7hdJqSc/s5+TlXkZboBuRP7LnKcW3deNmpbZNWU//2Aehcydh8oEhb6kcnoVEgwS9MrTkM6N/10n+PkaDP1jrCpxj1VTKgkv6CIw0Kg+ppq9HRmeHWqsGd3s+rHgAee2wsLc0scGYu5zaA8EduuXqPkLGsKZh3LYwIeHKl7Oai/cjljAVW1mUvAsKL/x7Yarx7A3QwBaET12nRGG17q1csPSX1R3DyxGnWaLRn3aUGVnv60L5QnY1r+eP6JTRUYRpvHezwPO2RceQbG9Xn/Eh20fU1zfvxl9TbD1GAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":11852,"cache_read_input_tokens":79628,"cache_creation":{"ephemeral_5m_input_tokens":11852,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWz6SzA4hdT6477P2nrqK","type":"assistant","uuid":"edec3b54-dc14-4daa-a691-2eb1b16ba063","timestamp":"2026-01-10T17:30:39.352Z"}
{"parentUuid":"edec3b54-dc14-4daa-a691-2eb1b16ba063","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","message":{"model":"claude-opus-4-5-20251101","id":"msg_01J3F1FcGezjFqbm92Bf3Cks","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01JmStFk99rUELgJC8rXNMnp","name":"TodoWrite","input":{"todos":[{"content":"Create backend export router (export.py)","status":"completed","activeForm":"Creating backend export router"},{"content":"Register export router in main.py","status":"completed","activeForm":"Registering export router in main.py"},{"content":"Create frontend API route for export","status":"completed","activeForm":"Creating frontend API route for export"},{"content":"Expand export-utils.ts with notebook export functions","status":"completed","activeForm":"Expanding export-utils.ts"},{"content":"Add export UI to studio-panel.tsx","status":"in_progress","activeForm":"Adding export UI to studio-panel.tsx"},{"content":"Test the export functionality","status":"pending","activeForm":"Testing export functionality"}]}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":11852,"cache_read_input_tokens":79628,"cache_creation":{"ephemeral_5m_input_tokens":11852,"ephemeral_1h_input_tokens":0},"output_tokens":273,"service_tier":"standard"}},"requestId":"req_011CWz6SzA4hdT6477P2nrqK","type":"assistant","uuid":"46dda939-869c-4a2d-b2bb-0c54a30ed2cf","timestamp":"2026-01-10T17:30:42.176Z"}
{"parentUuid":"46dda939-869c-4a2d-b2bb-0c54a30ed2cf","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01JmStFk99rUELgJC8rXNMnp","type":"tool_result","content":"Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable"}]},"uuid":"e1182aa6-2654-44a8-bca5-377692673c77","timestamp":"2026-01-10T17:30:42.208Z","toolUseResult":{"oldTodos":[{"content":"Create backend export router (export.py)","status":"completed","activeForm":"Creating backend export router"},{"content":"Register export router in main.py","status":"completed","activeForm":"Registering export router in main.py"},{"content":"Create frontend API route for export","status":"completed","activeForm":"Creating frontend API route for export"},{"content":"Expand export-utils.ts with notebook export functions","status":"in_progress","activeForm":"Expanding export-utils.ts"},{"content":"Add export UI to studio-panel.tsx","status":"pending","activeForm":"Adding export UI to studio-panel.tsx"},{"content":"Test the export functionality","status":"pending","activeForm":"Testing export functionality"}],"newTodos":[{"content":"Create backend export router (export.py)","status":"completed","activeForm":"Creating backend export router"},{"content":"Register export router in main.py","status":"completed","activeForm":"Registering export router in main.py"},{"content":"Create frontend API route for export","status":"completed","activeForm":"Creating frontend API route for export"},{"content":"Expand export-utils.ts with notebook export functions","status":"completed","activeForm":"Expanding export-utils.ts"},{"content":"Add export UI to studio-panel.tsx","status":"in_progress","activeForm":"Adding export UI to studio-panel.tsx"},{"content":"Test the export functionality","status":"pending","activeForm":"Testing export functionality"}]},"sourceToolAssistantUUID":"46dda939-869c-4a2d-b2bb-0c54a30ed2cf"}
{"parentUuid":"e1182aa6-2654-44a8-bca5-377692673c77","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","message":{"model":"claude-opus-4-5-20251101","id":"msg_01HJmaMaC98EGxE2KJU7yhwz","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Now I need to add the Export section UI to the studio-panel.tsx. I'll add a new section for \"Export\" that allows users to export their notebook in different formats.\n\nLet me add the new export section to the studio-panel.tsx file. I'll add it after the Notes section but before the closing of the component.","signature":"EtoDCkYICxgCKkAgEoVlPl7XbcDYO7Phfq1SJhDtalHwooHAllqQqT2RBQZAoGqQdpPvorW3WRSF/k3pdpEcFr8g5wTlTXVusg8wEgyAiwAdu/31+ZtDI6kaDDngEBSaqNect5J/GSIwItq6O+cVYrLb8Pmm0S83hshEGFsFPCls7n4j2E/JlpfoR1SoM+9F0JQ/o5zqi/MjKsEC+JAib9KDaVPB7qsOtiEX6faYLeCOV2m+YnEpYQ7Hlz689uCeHx33f43IM6QQdBpGl70GEgWtpSUbFFVAMUvw/jTtyMjnFa66mUPU5+WOuK6Z2G1+zp4+QdpNh4TPfXhBM8QThL5vDmo7P/44ntaMzqbx/aLInpy/3pxH+C4+8FayYtSGHm+4+je3doIRy0PI5ddDC3tg4kfDfW9Oj1IunyM2mxFALuWEZ+8UrCuG8h9YJAZv2wHaC1h17NpmYL2KPYu+KrfrCZNjwpEzlS4T+0ESAT+CmAD1Rq58s6jN+IHyXdIBU5Gkqy5mSKQDVdKwLrwIgd0orj7yaIEPe8dUH9xcfh8ZgraWYGaE1w2BOXu2CVeEs2pHOIAeEwipXsF16YXZHT6w+94pY3/GPb4dtzG1Oa+mn5iUQjioMQ6a0mS7GAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":322,"cache_read_input_tokens":91480,"cache_creation":{"ephemeral_5m_input_tokens":322,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWz6TZz3W61SuyVb6RQgC","type":"assistant","uuid":"09eae03e-eedd-4c88-b137-c36ac7832af6","timestamp":"2026-01-10T17:30:48.197Z"}
{"parentUuid":"09eae03e-eedd-4c88-b137-c36ac7832af6","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","message":{"model":"claude-opus-4-5-20251101","id":"msg_01HJmaMaC98EGxE2KJU7yhwz","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01P8X9idRWYjKzKbBuZwwzGV","name":"Edit","input":{"replace_all":false,"file_path":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend/src/components/studio/studio-panel.tsx","old_string":"import {\n  Microphone,\n  VideoCamera,\n  MagnifyingGlass,\n  GraduationCap,\n  CaretDown,\n  CaretRight,\n  Play,\n  SpinnerGap,\n  BookOpen,\n  ListChecks,\n  FileText,\n  Question,\n  Note,\n  Plus,\n  ShareNetwork,\n  ArrowsClockwise,\n  Clock,\n  WarningCircle,\n  Table,\n  ChartBar,\n  PresentationChart,\n  Image,\n  Palette,\n  Cards,\n  TreeStructure,\n  ChatCircleText,\n  Sparkle\n} from '@phosphor-icons/react'","new_string":"import {\n  Microphone,\n  VideoCamera,\n  MagnifyingGlass,\n  GraduationCap,\n  CaretDown,\n  CaretRight,\n  Play,\n  SpinnerGap,\n  BookOpen,\n  ListChecks,\n  FileText,\n  Question,\n  Note,\n  Plus,\n  ShareNetwork,\n  ArrowsClockwise,\n  Clock,\n  WarningCircle,\n  Table,\n  ChartBar,\n  PresentationChart,\n  Image,\n  Palette,\n  Cards,\n  TreeStructure,\n  ChatCircleText,\n  Sparkle,\n  Export,\n  FilePdf,\n  FileZip,\n  FileJs,\n  CheckSquare\n} from '@phosphor-icons/react'"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":322,"cache_read_input_tokens":91480,"cache_creation":{"ephemeral_5m_input_tokens":322,"ephemeral_1h_input_tokens":0},"output_tokens":586,"service_tier":"standard"}},"requestId":"req_011CWz6TZz3W61SuyVb6RQgC","type":"assistant","uuid":"4208e924-bfd6-4333-8cba-4d7dc588bbdb","timestamp":"2026-01-10T17:30:53.965Z"}
{"type":"file-history-snapshot","messageId":"4208e924-bfd6-4333-8cba-4d7dc588bbdb","snapshot":{"messageId":"973ebb96-60df-4671-b9c2-0c4aefc8516e","trackedFileBackups":{"backend/app/routers/export.py":{"backupFileName":null,"version":1,"backupTime":"2026-01-10T17:28:16.452Z"},"backend/app/main.py":{"backupFileName":"f16da9f396306523@v1","version":1,"backupTime":"2026-01-10T17:28:31.217Z"},"frontend/src/app/api/notebooks/[id]/export/route.ts":{"backupFileName":"85dcaadfd8a8a6e9@v1","version":1,"backupTime":"2026-01-10T17:29:25.531Z"},"frontend/src/lib/export-utils.ts":{"backupFileName":"dc1af29a22407c10@v1","version":1,"backupTime":"2026-01-10T17:30:32.804Z"},"frontend/src/components/studio/studio-panel.tsx":{"backupFileName":"e902adf91d326abb@v1","version":1,"backupTime":"2026-01-10T17:30:54.009Z"}},"timestamp":"2026-01-10T17:26:46.087Z"},"isSnapshotUpdate":true}
{"parentUuid":"4208e924-bfd6-4333-8cba-4d7dc588bbdb","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01P8X9idRWYjKzKbBuZwwzGV","type":"tool_result","content":"The file /Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend/src/components/studio/studio-panel.tsx has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n     1→'use client'\n     2→\n     3→import { useState } from 'react'\n     4→import { motion, AnimatePresence } from 'framer-motion'\n     5→import {\n     6→  Microphone,\n     7→  VideoCamera,\n     8→  MagnifyingGlass,\n     9→  GraduationCap,\n    10→  CaretDown,\n    11→  CaretRight,\n    12→  Play,\n    13→  SpinnerGap,\n    14→  BookOpen,\n    15→  ListChecks,\n    16→  FileText,\n    17→  Question,\n    18→  Note,\n    19→  Plus,\n    20→  ShareNetwork,\n    21→  ArrowsClockwise,\n    22→  Clock,\n    23→  WarningCircle,\n    24→  Table,\n    25→  ChartBar,\n    26→  PresentationChart,\n    27→  Image,\n    28→  Palette,\n    29→  Cards,\n    30→  TreeStructure,\n    31→  ChatCircleText,\n    32→  Sparkle,\n    33→  Export,\n    34→  FilePdf,\n    35→  FileZip,\n    36→  FileJs,\n    37→  CheckSquare\n    38→} from '@phosphor-icons/react'\n    39→import { Button } from '@/components/ui/button'\n    40→import { Input } from '@/components/ui/input'\n    41→import { Textarea } from '@/components/ui/textarea'\n    42→import { Badge } from '@/components/ui/badge'"}]},"uuid":"b910c809-703d-49cc-9894-da8db78b3b0f","timestamp":"2026-01-10T17:30:54.003Z","toolUseResult":{"filePath":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend/src/components/studio/studio-panel.tsx","oldString":"import {\n  Microphone,\n  VideoCamera,\n  MagnifyingGlass,\n  GraduationCap,\n  CaretDown,\n  CaretRight,\n  Play,\n  SpinnerGap,\n  BookOpen,\n  ListChecks,\n  FileText,\n  Question,\n  Note,\n  Plus,\n  ShareNetwork,\n  ArrowsClockwise,\n  Clock,\n  WarningCircle,\n  Table,\n  ChartBar,\n  PresentationChart,\n  Image,\n  Palette,\n  Cards,\n  TreeStructure,\n  ChatCircleText,\n  Sparkle\n} from '@phosphor-icons/react'","newString":"import {\n  Microphone,\n  VideoCamera,\n  MagnifyingGlass,\n  GraduationCap,\n  CaretDown,\n  CaretRight,\n  Play,\n  SpinnerGap,\n  BookOpen,\n  ListChecks,\n  FileText,\n  Question,\n  Note,\n  Plus,\n  ShareNetwork,\n  ArrowsClockwise,\n  Clock,\n  WarningCircle,\n  Table,\n  ChartBar,\n  PresentationChart,\n  Image,\n  Palette,\n  Cards,\n  TreeStructure,\n  ChatCircleText,\n  Sparkle,\n  Export,\n  FilePdf,\n  FileZip,\n  FileJs,\n  CheckSquare\n} from '@phosphor-icons/react'","originalFile":"'use client'\n\nimport { useState } from 'react'\nimport { motion, AnimatePresence } from 'framer-motion'\nimport {\n  Microphone,\n  VideoCamera,\n  MagnifyingGlass,\n  GraduationCap,\n  CaretDown,\n  CaretRight,\n  Play,\n  SpinnerGap,\n  BookOpen,\n  ListChecks,\n  FileText,\n  Question,\n  Note,\n  Plus,\n  ShareNetwork,\n  ArrowsClockwise,\n  Clock,\n  WarningCircle,\n  Table,\n  ChartBar,\n  PresentationChart,\n  Image,\n  Palette,\n  Cards,\n  TreeStructure,\n  ChatCircleText,\n  Sparkle\n} from '@phosphor-icons/react'\nimport { Button } from '@/components/ui/button'\nimport { Input } from '@/components/ui/input'\nimport { Textarea } from '@/components/ui/textarea'\nimport { Badge } from '@/components/ui/badge'\nimport { ScrollArea } from '@/components/ui/scroll-area'\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select'\nimport { Tooltip, TooltipContent, TooltipTrigger } from '@/components/ui/tooltip'\nimport { GenerationConfigDialog, GenerationType, GenerationConfig } from './generation-config-dialog'\n\n// Metadata for a generated study material\nexport interface StudyMaterialMeta {\n  id: string\n  type: string\n  sourceIds: string[]\n  sourceNames: string[]\n  createdAt: string\n  itemCount?: number\n}\n\n// Helper to format relative time\nfunction getTimeAgo(dateString: string): string {\n  const date = new Date(dateString)\n  const now = new Date()\n  const diffMs = now.getTime() - date.getTime()\n  const diffMins = Math.floor(diffMs / 60000)\n  const diffHours = Math.floor(diffMs / 3600000)\n  const diffDays = Math.floor(diffMs / 86400000)\n\n  if (diffMins < 1) return 'Just now'\n  if (diffMins < 60) return `${diffMins}m ago`\n  if (diffHours < 24) return `${diffHours}h ago`\n  if (diffDays < 7) return `${diffDays}d ago`\n  return date.toLocaleDateString()\n}\n\n// Source type for selection\nexport interface SourceInfo {\n  id: string\n  name: string\n}\n\ninterface StudioPanelProps {\n  notebookId: string\n  selectedSourcesCount: number\n  selectedSourceIds: string[]\n  sources?: SourceInfo[]\n  // Audio\n  audioFormat: string\n  onAudioFormatChange: (format: string) => void\n  audioInstructions: string\n  onAudioInstructionsChange: (instructions: string) => void\n  onGenerateAudio: () => void\n  generatingAudio: boolean\n  // Video\n  videoStyle: string\n  onVideoStyleChange: (style: string) => void\n  onGenerateVideo: () => void\n  generatingVideo: boolean\n  // Research\n  researchQuery: string\n  onResearchQueryChange: (query: string) => void\n  researchMode: string\n  onResearchModeChange: (mode: string) => void\n  onRunResearch: () => void\n  researching: boolean\n  // Study - now accepts config\n  onGenerateStudyMaterial: (config: GenerationConfig) => void\n  generatingFlashcards: boolean\n  generatingQuiz: boolean\n  generatingStudyGuide: boolean\n  generatingFaq: boolean\n  generatingMindMap: boolean\n  // Creative Outputs - now accepts config\n  onGenerateCreativeOutput?: (config: GenerationConfig) => void\n  generatingDataTable?: boolean\n  generatingReport?: boolean\n  generatingSlideDeck?: boolean\n  generatingInfographic?: boolean\n  // Creative outputs results\n  creativeOutputs?: Array<{\n    id: string\n    type: string\n    title: string\n    status: string\n    createdAt: string\n  }>\n  onOpenCreativeOutput?: (type: string) => void\n  // Results - now with metadata\n  studyMaterials?: StudyMaterialMeta[]\n  onOpenStudyMaterial?: (type: string) => void\n  // Notes\n  notesCount?: number\n  onAddNote?: () => void\n  onOpenNotes?: () => void\n  // Generated content\n  hasGeneratedAudio?: boolean\n  hasGeneratedVideo?: boolean\n  hasGeneratedResearch?: boolean\n  onOpenAudio?: () => void\n  onOpenVideo?: () => void\n  onOpenResearch?: () => void\n}\n\nexport function StudioPanel({\n  notebookId,\n  selectedSourcesCount,\n  selectedSourceIds,\n  sources = [],\n  audioFormat,\n  onAudioFormatChange,\n  audioInstructions,\n  onAudioInstructionsChange,\n  onGenerateAudio,\n  generatingAudio,\n  videoStyle,\n  onVideoStyleChange,\n  onGenerateVideo,\n  generatingVideo,\n  researchQuery,\n  onResearchQueryChange,\n  researchMode,\n  onResearchModeChange,\n  onRunResearch,\n  researching,\n  onGenerateStudyMaterial,\n  generatingFlashcards,\n  generatingQuiz,\n  generatingStudyGuide,\n  generatingFaq,\n  generatingMindMap,\n  onGenerateCreativeOutput,\n  generatingDataTable = false,\n  generatingReport = false,\n  generatingSlideDeck = false,\n  generatingInfographic = false,\n  creativeOutputs = [],\n  onOpenCreativeOutput,\n  studyMaterials = [],\n  onOpenStudyMaterial,\n  notesCount = 0,\n  onAddNote,\n  onOpenNotes,\n  hasGeneratedAudio = false,\n  hasGeneratedVideo = false,\n  hasGeneratedResearch = false,\n  onOpenAudio,\n  onOpenVideo,\n  onOpenResearch,\n}: StudioPanelProps) {\n  const [expandedSection, setExpandedSection] = useState<string | null>('audio')\n  const [configDialogOpen, setConfigDialogOpen] = useState(false)\n  const [configDialogType, setConfigDialogType] = useState<GenerationType>('flashcards')\n\n  // Open config dialog for a specific type\n  const openConfigDialog = (type: GenerationType) => {\n    setConfigDialogType(type)\n    setConfigDialogOpen(true)\n  }\n\n  // Handle generation from config dialog\n  const handleGenerate = (config: GenerationConfig) => {\n    setConfigDialogOpen(false)\n\n    // Route to appropriate handler based on type\n    const studyTypes = ['flashcards', 'quiz', 'study-guide', 'faq', 'mind-map']\n    if (studyTypes.includes(config.type)) {\n      onGenerateStudyMaterial(config)\n    } else {\n      onGenerateCreativeOutput?.(config)\n    }\n  }\n\n  // Check if currently generating for a type\n  const isGenerating = (type: GenerationType): boolean => {\n    switch (type) {\n      case 'flashcards': return generatingFlashcards\n      case 'quiz': return generatingQuiz\n      case 'study-guide': return generatingStudyGuide\n      case 'faq': return generatingFaq\n      case 'mind-map': return generatingMindMap\n      case 'data_table': return generatingDataTable\n      case 'report': return generatingReport\n      case 'slide_deck': return generatingSlideDeck\n      case 'infographic': return generatingInfographic\n      default: return false\n    }\n  }\n\n  const toggleSection = (section: string) => {\n    setExpandedSection(expandedSection === section ? null : section)\n  }\n\n  // Check if a material's sources match current selection\n  const isMaterialStale = (material: StudyMaterialMeta) => {\n    const sortedMaterialIds = [...material.sourceIds].sort()\n    const sortedSelectedIds = [...selectedSourceIds].sort()\n    if (sortedMaterialIds.length !== sortedSelectedIds.length) return true\n    return !sortedMaterialIds.every((id, idx) => id === sortedSelectedIds[idx])\n  }\n\n  // Format relative time\n  const formatTimeAgo = (dateStr: string) => {\n    const date = new Date(dateStr)\n    const now = new Date()\n    const diffMs = now.getTime() - date.getTime()\n    const diffMins = Math.floor(diffMs / 60000)\n    const diffHours = Math.floor(diffMins / 60)\n    const diffDays = Math.floor(diffHours / 24)\n\n    if (diffMins < 1) return 'Just now'\n    if (diffMins < 60) return `${diffMins}m ago`\n    if (diffHours < 24) return `${diffHours}h ago`\n    if (diffDays < 7) return `${diffDays}d ago`\n    return date.toLocaleDateString()\n  }\n\n  // Get material by type\n  const getMaterial = (type: string) => studyMaterials.find(m => m.type === type)\n\n  return (\n    <ScrollArea className=\"h-full\">\n      <div className=\"p-4 space-y-3\">\n        {/* Audio Overview Section */}\n        <StudioSection\n          id=\"audio\"\n          title=\"Audio Overview\"\n          subtitle=\"Podcast-style discussion\"\n          icon={<Microphone className=\"h-5 w-5\" weight=\"duotone\" />}\n          iconGradient=\"from-orange-500/20 to-red-500/20\"\n          iconColor=\"text-orange-500\"\n          expanded={expandedSection === 'audio'}\n          onToggle={() => toggleSection('audio')}\n        >\n          <div className=\"space-y-3\">\n            <div className=\"space-y-1.5\">\n              <label className=\"text-xs font-medium text-[var(--text-primary)]\">Format</label>\n              <Select value={audioFormat} onValueChange={onAudioFormatChange}>\n                <SelectTrigger className=\"h-9 text-sm bg-[var(--bg-tertiary)] border-[rgba(255,255,255,0.1)] rounded-lg\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent className=\"bg-[var(--bg-secondary)] border-[rgba(255,255,255,0.1)]\">\n                  <SelectItem value=\"deep_dive\">Deep Dive (10-15 min)</SelectItem>\n                  <SelectItem value=\"brief\">Brief Summary (2-3 min)</SelectItem>\n                  <SelectItem value=\"critique\">Analytical (5-10 min)</SelectItem>\n                  <SelectItem value=\"debate\">Debate (8-15 min)</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n            <div className=\"space-y-1.5\">\n              <label className=\"text-xs font-medium text-[var(--text-primary)]\">Custom Instructions</label>\n              <Textarea\n                placeholder=\"Optional instructions for hosts...\"\n                value={audioInstructions}\n                onChange={(e) => onAudioInstructionsChange(e.target.value)}\n                rows={2}\n                className=\"text-sm resize-none bg-[var(--bg-tertiary)] border-[rgba(255,255,255,0.1)] text-[var(--text-primary)] placeholder:text-[var(--text-tertiary)] focus:border-[var(--accent-primary)] rounded-lg\"\n              />\n            </div>\n            <div className=\"flex gap-2\">\n              <Button\n                className=\"flex-1 rounded-lg bg-orange-500 hover:bg-orange-500/90 text-white\"\n                onClick={onGenerateAudio}\n                disabled={generatingAudio || selectedSourcesCount === 0}\n              >\n                {generatingAudio ? (\n                  <SpinnerGap className=\"h-4 w-4 mr-2 animate-spin\" weight=\"bold\" />\n                ) : (\n                  <Play className=\"h-4 w-4 mr-2\" />\n                )}\n                Generate\n              </Button>\n              {hasGeneratedAudio && onOpenAudio && (\n                <Button\n                  variant=\"outline\"\n                  className=\"rounded-lg border-orange-500/30 text-orange-500 hover:bg-orange-500/10\"\n                  onClick={onOpenAudio}\n                >\n                  View\n                  <CaretRight className=\"h-4 w-4 ml-1\" weight=\"bold\" />\n                </Button>\n              )}\n            </div>\n            {selectedSourcesCount === 0 && (\n              <p className=\"text-xs text-[var(--text-tertiary)] text-center\">\n                Select sources to generate\n              </p>\n            )}\n          </div>\n        </StudioSection>\n\n        {/* Video Overview Section */}\n        <StudioSection\n          id=\"video\"\n          title=\"Video Overview\"\n          subtitle=\"AI-generated video clip\"\n          icon={<VideoCamera className=\"h-5 w-5\" weight=\"duotone\" />}\n          iconGradient=\"from-purple-500/20 to-pink-500/20\"\n          iconColor=\"text-purple-500\"\n          expanded={expandedSection === 'video'}\n          onToggle={() => toggleSection('video')}\n        >\n          <div className=\"space-y-3\">\n            <div className=\"space-y-1.5\">\n              <label className=\"text-xs font-medium text-[var(--text-primary)]\">Style</label>\n              <Select value={videoStyle} onValueChange={onVideoStyleChange}>\n                <SelectTrigger className=\"h-9 text-sm bg-[var(--bg-tertiary)] border-[rgba(255,255,255,0.1)] rounded-lg\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent className=\"bg-[var(--bg-secondary)] border-[rgba(255,255,255,0.1)]\">\n                  <SelectItem value=\"explainer\">Explainer (5s)</SelectItem>\n                  <SelectItem value=\"documentary\">Documentary (10s)</SelectItem>\n                  <SelectItem value=\"presentation\">Presentation (5s)</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n            <p className=\"text-xs text-[var(--text-tertiary)]\">\n              Generates an AI video clip using Wan 2.5. Estimated cost: ~$0.10-0.20\n            </p>\n            <div className=\"flex gap-2\">\n              <Button\n                className=\"flex-1 rounded-lg bg-purple-500 hover:bg-purple-500/90 text-white\"\n                onClick={onGenerateVideo}\n                disabled={generatingVideo || selectedSourcesCount === 0}\n              >\n                {generatingVideo ? (\n                  <SpinnerGap className=\"h-4 w-4 mr-2 animate-spin\" weight=\"bold\" />\n                ) : (\n                  <VideoCamera className=\"h-4 w-4 mr-2\" weight=\"duotone\" />\n                )}\n                {generatingVideo ? 'Generating...' : 'Generate Video'}\n              </Button>\n              {hasGeneratedVideo && onOpenVideo && (\n                <Button\n                  variant=\"outline\"\n                  className=\"rounded-lg border-purple-500/30 text-purple-500 hover:bg-purple-500/10\"\n                  onClick={onOpenVideo}\n                >\n                  View\n                  <CaretRight className=\"h-4 w-4 ml-1\" weight=\"bold\" />\n                </Button>\n              )}\n            </div>\n            {selectedSourcesCount === 0 && (\n              <p className=\"text-xs text-[var(--text-tertiary)] text-center\">\n                Select sources to generate\n              </p>\n            )}\n          </div>\n        </StudioSection>\n\n        {/* Deep Research Section */}\n        <StudioSection\n          id=\"research\"\n          title=\"Deep Research\"\n          subtitle=\"Autonomous web research\"\n          icon={<MagnifyingGlass className=\"h-5 w-5\" weight=\"duotone\" />}\n          iconGradient=\"from-blue-500/20 to-cyan-500/20\"\n          iconColor=\"text-blue-500\"\n          expanded={expandedSection === 'research'}\n          onToggle={() => toggleSection('research')}\n        >\n          <div className=\"space-y-3\">\n            <div className=\"space-y-1.5\">\n              <label className=\"text-xs font-medium text-[var(--text-primary)]\">Research Query</label>\n              <Input\n                placeholder=\"What would you like to research?\"\n                value={researchQuery}\n                onChange={(e) => onResearchQueryChange(e.target.value)}\n                className=\"h-9 text-sm bg-[var(--bg-tertiary)] border-[rgba(255,255,255,0.1)] text-[var(--text-primary)] placeholder:text-[var(--text-tertiary)] focus:border-[var(--accent-primary)] rounded-lg\"\n              />\n            </div>\n            <div className=\"space-y-1.5\">\n              <label className=\"text-xs font-medium text-[var(--text-primary)]\">Mode</label>\n              <Select value={researchMode} onValueChange={onResearchModeChange}>\n                <SelectTrigger className=\"h-9 text-sm bg-[var(--bg-tertiary)] border-[rgba(255,255,255,0.1)] rounded-lg\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent className=\"bg-[var(--bg-secondary)] border-[rgba(255,255,255,0.1)]\">\n                  <SelectItem value=\"fast\">Fast (3-5 min)</SelectItem>\n                  <SelectItem value=\"deep\">Deep (10-15 min)</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n            <div className=\"flex gap-2\">\n              <Button\n                className=\"flex-1 rounded-lg bg-blue-500 hover:bg-blue-500/90 text-white\"\n                onClick={onRunResearch}\n                disabled={researching || !researchQuery.trim()}\n              >\n                {researching ? (\n                  <SpinnerGap className=\"h-4 w-4 mr-2 animate-spin\" weight=\"bold\" />\n                ) : (\n                  <MagnifyingGlass className=\"h-4 w-4 mr-2\" weight=\"duotone\" />\n                )}\n                Research\n              </Button>\n              {hasGeneratedResearch && onOpenResearch && (\n                <Button\n                  variant=\"outline\"\n                  className=\"rounded-lg border-blue-500/30 text-blue-500 hover:bg-blue-500/10\"\n                  onClick={onOpenResearch}\n                >\n                  View\n                  <CaretRight className=\"h-4 w-4 ml-1\" weight=\"bold\" />\n                </Button>\n              )}\n            </div>\n          </div>\n        </StudioSection>\n\n        {/* Study Materials Section */}\n        <StudioSection\n          id=\"study\"\n          title=\"Study Materials\"\n          subtitle=\"Flashcards, quizzes, and more\"\n          icon={<GraduationCap className=\"h-5 w-5\" />}\n          iconGradient=\"from-emerald-500/20 to-teal-500/20\"\n          iconColor=\"text-emerald-500\"\n          expanded={expandedSection === 'study'}\n          onToggle={() => toggleSection('study')}\n        >\n          <div className=\"space-y-4\">\n            {/* Study Tools Grid */}\n            <div className=\"grid grid-cols-2 gap-2\">\n              <StudyToolButton\n                icon={<BookOpen className=\"h-5 w-5\" />}\n                label=\"Flashcards\"\n                color=\"text-blue-500\"\n                onClick={() => openConfigDialog('flashcards')}\n                loading={generatingFlashcards}\n                disabled={selectedSourcesCount === 0}\n              />\n              <StudyToolButton\n                icon={<ListChecks className=\"h-5 w-5\" />}\n                label=\"Quiz\"\n                color=\"text-purple-500\"\n                onClick={() => openConfigDialog('quiz')}\n                loading={generatingQuiz}\n                disabled={selectedSourcesCount === 0}\n              />\n              <StudyToolButton\n                icon={<FileText className=\"h-5 w-5\" />}\n                label=\"Study Guide\"\n                color=\"text-orange-500\"\n                onClick={() => openConfigDialog('study-guide')}\n                loading={generatingStudyGuide}\n                disabled={selectedSourcesCount === 0}\n              />\n              <StudyToolButton\n                icon={<Question className=\"h-5 w-5\" weight=\"duotone\" />}\n                label=\"FAQ\"\n                color=\"text-teal-500\"\n                onClick={() => openConfigDialog('faq')}\n                loading={generatingFaq}\n                disabled={selectedSourcesCount === 0}\n              />\n              <StudyToolButton\n                icon={<TreeStructure className=\"h-5 w-5\" weight=\"duotone\" />}\n                label=\"Mind Map\"\n                color=\"text-cyan-500\"\n                onClick={() => openConfigDialog('mind-map')}\n                loading={generatingMindMap}\n                disabled={selectedSourcesCount === 0}\n              />\n            </div>\n\n            {selectedSourcesCount === 0 && (\n              <p className=\"text-xs text-[var(--text-tertiary)] text-center\">\n                Select sources to generate study materials\n              </p>\n            )}\n\n            {/* Generated Materials */}\n            {studyMaterials.length > 0 && (\n              <div className=\"pt-3 border-t border-[rgba(255,255,255,0.1)]\">\n                <p className=\"text-xs font-medium text-[var(--text-tertiary)] mb-2\">Generated Materials</p>\n                <div className=\"space-y-2\">\n                  {studyMaterials.map((material) => {\n                    const isStale = isMaterialStale(material)\n                    const iconMap: Record<string, { icon: React.ReactNode; color: string; label: string }> = {\n                      flashcards: { icon: <BookOpen className=\"h-4 w-4\" />, color: 'text-blue-500', label: `${material.itemCount || 0} Flashcards` },\n                      quiz: { icon: <ListChecks className=\"h-4 w-4\" />, color: 'text-purple-500', label: `${material.itemCount || 0} Quiz Questions` },\n                      study_guide: { icon: <FileText className=\"h-4 w-4\" />, color: 'text-orange-500', label: 'Study Guide' },\n                      faq: { icon: <ChatCircleText className=\"h-4 w-4\" weight=\"duotone\" />, color: 'text-teal-500', label: `${material.itemCount || 0} FAQ Items` },\n                      mind_map: { icon: <TreeStructure className=\"h-4 w-4\" weight=\"duotone\" />, color: 'text-cyan-500', label: 'Mind Map' },\n                    }\n                    const info = iconMap[material.type] || { icon: <FileText className=\"h-4 w-4\" />, color: 'text-gray-500', label: material.type }\n\n                    return (\n                      <div\n                        key={material.id}\n                        className={`rounded-lg border ${isStale ? 'border-amber-500/30 bg-amber-500/5' : 'border-[rgba(255,255,255,0.1)]'} overflow-hidden`}\n                      >\n                        <button\n                          onClick={() => onOpenStudyMaterial?.(material.type)}\n                          className=\"w-full flex items-center gap-2 px-3 py-2 text-sm hover:bg-[var(--bg-tertiary)] transition-colors\"\n                        >\n                          <span className={info.color}>{info.icon}</span>\n                          <span className=\"text-[var(--text-primary)] flex-1 text-left\">{info.label}</span>\n                          {isStale && (\n                            <Tooltip>\n                              <TooltipTrigger asChild>\n                                <WarningCircle className=\"h-3.5 w-3.5 text-amber-500\" weight=\"fill\" />\n                              </TooltipTrigger>\n                              <TooltipContent>\n                                <p>Sources changed - regenerate for updated content</p>\n                              </TooltipContent>\n                            </Tooltip>\n                          )}\n                          <CaretRight className=\"h-4 w-4 text-[var(--text-tertiary)]\" weight=\"bold\" />\n                        </button>\n                        <div className=\"px-3 py-1.5 bg-[var(--bg-tertiary)]/50 border-t border-[rgba(255,255,255,0.05)] flex items-center gap-3 text-[10px] text-[var(--text-tertiary)]\">\n                          <span className=\"flex items-center gap-1\">\n                            <Clock className=\"h-3 w-3\" />\n                            {formatTimeAgo(material.createdAt)}\n                          </span>\n                          <span>•</span>\n                          <span className=\"truncate\">\n                            {material.sourceNames.length === 1\n                              ? material.sourceNames[0]\n                              : `${material.sourceNames.length} sources`}\n                          </span>\n                        </div>\n                      </div>\n                    )\n                  })}\n                </div>\n              </div>\n            )}\n          </div>\n        </StudioSection>\n\n        {/* Creative Outputs Section */}\n        <StudioSection\n          id=\"creative\"\n          title=\"Creative Outputs\"\n          subtitle=\"Tables, reports, slides, infographics\"\n          icon={<Palette className=\"h-5 w-5\" />}\n          iconGradient=\"from-pink-500/20 to-rose-500/20\"\n          iconColor=\"text-pink-500\"\n          expanded={expandedSection === 'creative'}\n          onToggle={() => toggleSection('creative')}\n        >\n          <div className=\"space-y-4\">\n            {/* Creative Tools Grid */}\n            <div className=\"grid grid-cols-2 gap-2\">\n              <StudyToolButton\n                icon={<Table className=\"h-5 w-5\" />}\n                label=\"Data Table\"\n                color=\"text-emerald-500\"\n                onClick={() => openConfigDialog('data_table')}\n                loading={generatingDataTable}\n                disabled={selectedSourcesCount === 0}\n              />\n              <StudyToolButton\n                icon={<Palette className=\"h-5 w-5\" weight=\"duotone\" />}\n                label=\"Report\"\n                color=\"text-blue-500\"\n                onClick={() => openConfigDialog('report')}\n                loading={generatingReport}\n                disabled={selectedSourcesCount === 0}\n              />\n              <StudyToolButton\n                icon={<PresentationChart className=\"h-5 w-5\" />}\n                label=\"Slide Deck\"\n                color=\"text-violet-500\"\n                onClick={() => openConfigDialog('slide_deck')}\n                loading={generatingSlideDeck}\n                disabled={selectedSourcesCount === 0}\n              />\n              <StudyToolButton\n                icon={<Image className=\"h-5 w-5\" />}\n                label=\"Infographic\"\n                color=\"text-rose-500\"\n                onClick={() => openConfigDialog('infographic')}\n                loading={generatingInfographic}\n                disabled={selectedSourcesCount === 0}\n              />\n            </div>\n\n            {selectedSourcesCount === 0 && (\n              <p className=\"text-xs text-[var(--text-tertiary)] text-center\">\n                Select sources to generate creative outputs\n              </p>\n            )}\n\n            {/* Generated Outputs */}\n            {creativeOutputs.length > 0 && (\n              <div className=\"mt-4 pt-4 border-t border-[rgba(255,255,255,0.1)]\">\n                <p className=\"text-xs font-medium text-[var(--text-tertiary)] mb-3\">Generated Outputs</p>\n                <div className=\"space-y-2\">\n                  {creativeOutputs.map((output) => {\n                    const typeConfig: Record<string, { icon: React.ReactNode; label: string; color: string }> = {\n                      data_table: { icon: <Table className=\"h-4 w-4\" />, label: 'Data Table', color: 'text-emerald-500' },\n                      report: { icon: <ChartBar className=\"h-4 w-4\" weight=\"duotone\" />, label: 'Report', color: 'text-blue-500' },\n                      slide_deck: { icon: <PresentationChart className=\"h-4 w-4\" />, label: 'Slide Deck', color: 'text-violet-500' },\n                      infographic: { icon: <Image className=\"h-4 w-4\" />, label: 'Infographic', color: 'text-rose-500' },\n                    }\n                    const config = typeConfig[output.type] || { icon: <FileText className=\"h-4 w-4\" />, label: output.type, color: 'text-gray-500' }\n                    const timeAgo = getTimeAgo(output.createdAt)\n\n                    return (\n                      <button\n                        key={output.id}\n                        onClick={() => onOpenCreativeOutput?.(output.type)}\n                        className=\"w-full flex items-center gap-3 p-3 rounded-xl bg-[var(--bg-tertiary)] hover:bg-[var(--bg-tertiary)]/80 transition-colors text-left\"\n                      >\n                        <div className={`${config.color}`}>{config.icon}</div>\n                        <div className=\"flex-1 min-w-0\">\n                          <p className=\"text-sm font-medium text-[var(--text-primary)] truncate\">{config.label}</p>\n                          <p className=\"text-xs text-[var(--text-tertiary)]\">{timeAgo}</p>\n                        </div>\n                        <CaretRight className=\"h-4 w-4 text-[var(--text-tertiary)]\" weight=\"bold\" />\n                      </button>\n                    )\n                  })}\n                </div>\n              </div>\n            )}\n          </div>\n        </StudioSection>\n\n        {/* Notes Section */}\n        <StudioSection\n          id=\"notes\"\n          title=\"Notes\"\n          subtitle={`${notesCount} saved`}\n          icon={<Note className=\"h-5 w-5\" weight=\"duotone\" />}\n          iconGradient=\"from-amber-500/20 to-yellow-500/20\"\n          iconColor=\"text-amber-500\"\n          expanded={expandedSection === 'notes'}\n          onToggle={() => toggleSection('notes')}\n          action={\n            <Button\n              size=\"sm\"\n              variant=\"ghost\"\n              className=\"h-7 w-7 p-0\"\n              onClick={(e) => {\n                e.stopPropagation()\n                onAddNote?.()\n              }}\n            >\n              <Plus className=\"h-3.5 w-3.5\" />\n            </Button>\n          }\n        >\n          <div className=\"space-y-3\">\n            {notesCount === 0 ? (\n              <div className=\"text-center py-6\">\n                <Note className=\"h-8 w-8 mx-auto mb-2 text-[var(--text-tertiary)]/50\" weight=\"duotone\" />\n                <p className=\"text-sm text-[var(--text-tertiary)]\">No notes yet</p>\n                <p className=\"text-xs text-[var(--text-tertiary)] mt-1\">Create notes or save chat responses</p>\n              </div>\n            ) : (\n              <Button\n                variant=\"outline\"\n                className=\"w-full justify-start rounded-lg border-[rgba(255,255,255,0.1)] text-[var(--text-primary)] hover:bg-[var(--bg-tertiary)]\"\n                onClick={onOpenNotes}\n              >\n                <Note className=\"h-4 w-4 mr-2 text-amber-500\" weight=\"duotone\" />\n                View All Notes ({notesCount})\n                <CaretRight className=\"h-4 w-4 ml-auto text-[var(--text-tertiary)]\" weight=\"bold\" />\n              </Button>\n            )}\n          </div>\n        </StudioSection>\n      </div>\n\n      {/* Generation Config Dialog */}\n      <GenerationConfigDialog\n        open={configDialogOpen}\n        onOpenChange={setConfigDialogOpen}\n        type={configDialogType}\n        sources={sources}\n        onGenerate={handleGenerate}\n        isGenerating={isGenerating(configDialogType)}\n      />\n    </ScrollArea>\n  )\n}\n\n// Studio Section Component\nfunction StudioSection({\n  id,\n  title,\n  subtitle,\n  icon,\n  iconGradient,\n  iconColor,\n  expanded,\n  onToggle,\n  action,\n  children,\n}: {\n  id: string\n  title: string\n  subtitle: string\n  icon: React.ReactNode\n  iconGradient: string\n  iconColor: string\n  expanded: boolean\n  onToggle: () => void\n  action?: React.ReactNode\n  children: React.ReactNode\n}) {\n  return (\n    <div className=\"glass-card rounded-2xl overflow-hidden\">\n      <div className=\"flex items-center justify-between p-4 hover:bg-white/[0.02] transition-all duration-200 group\">\n        <button\n          onClick={onToggle}\n          className=\"flex items-center gap-3 flex-1\"\n        >\n          <div className={`relative w-10 h-10 rounded-xl bg-gradient-to-br ${iconGradient} flex items-center justify-center shadow-lg`}>\n            <div className=\"absolute inset-0 rounded-xl bg-gradient-to-br from-white/10 to-transparent\" />\n            <span className={`relative z-10 ${iconColor}`}>{icon}</span>\n          </div>\n          <div className=\"text-left\">\n            <p className=\"font-medium text-sm text-[var(--text-primary)] group-hover:text-white transition-colors\">{title}</p>\n            <p className=\"text-xs text-[var(--text-tertiary)]\">{subtitle}</p>\n          </div>\n        </button>\n        <div className=\"flex items-center gap-2\">\n          {action}\n          <button onClick={onToggle} className=\"p-1.5 rounded-lg hover:bg-white/5 transition-colors\">\n            <CaretDown weight=\"bold\" className={`h-4 w-4 text-[var(--text-tertiary)] transition-transform duration-200 ${expanded ? 'rotate-180' : ''}`} />\n          </button>\n        </div>\n      </div>\n\n      <AnimatePresence>\n        {expanded && (\n          <motion.div\n            initial={{ height: 0, opacity: 0 }}\n            animate={{ height: 'auto', opacity: 1 }}\n            exit={{ height: 0, opacity: 0 }}\n            transition={{ duration: 0.2 }}\n            className=\"overflow-hidden\"\n          >\n            <div className=\"px-4 pb-4 pt-2 border-t border-[rgba(255,255,255,0.1)] bg-[var(--bg-tertiary)]/30\">\n              {children}\n            </div>\n          </motion.div>\n        )}\n      </AnimatePresence>\n    </div>\n  )\n}\n\n// Study Tool Button\nfunction StudyToolButton({\n  icon,\n  label,\n  color,\n  onClick,\n  loading,\n  disabled,\n}: {\n  icon: React.ReactNode\n  label: string\n  color: string\n  onClick: () => void\n  loading: boolean\n  disabled: boolean\n}) {\n  return (\n    <button\n      onClick={onClick}\n      disabled={disabled || loading}\n      className=\"flex flex-col items-center gap-2 p-4 rounded-xl border border-[rgba(255,255,255,0.1)] bg-[var(--bg-secondary)] hover:bg-[var(--bg-tertiary)]/50 transition-colors disabled:opacity-50 disabled:cursor-not-allowed\"\n    >\n      {loading ? (\n        <SpinnerGap className=\"h-5 w-5 animate-spin text-[var(--text-tertiary)]\" weight=\"bold\" />\n      ) : (\n        <span className={color}>{icon}</span>\n      )}\n      <span className=\"text-xs font-medium text-[var(--text-primary)]\">{label}</span>\n    </button>\n  )\n}\n\n// Material Button\nfunction MaterialButton({\n  icon,\n  label,\n  onClick,\n}: {\n  icon: React.ReactNode\n  label: string\n  onClick?: () => void\n}) {\n  return (\n    <button\n      onClick={onClick}\n      className=\"w-full flex items-center gap-2 px-3 py-2 text-sm rounded-lg hover:bg-[var(--bg-tertiary)] transition-colors\"\n    >\n      {icon}\n      <span className=\"text-[var(--text-primary)]\">{label}</span>\n      <CaretRight className=\"h-4 w-4 ml-auto text-[var(--text-tertiary)]\" weight=\"bold\" />\n    </button>\n  )\n}\n","structuredPatch":[{"oldStart":29,"oldLines":7,"newStart":29,"newLines":12,"lines":["   Cards,","   TreeStructure,","   ChatCircleText,","-  Sparkle","+  Sparkle,","+  Export,","+  FilePdf,","+  FileZip,","+  FileJs,","+  CheckSquare"," } from '@phosphor-icons/react'"," import { Button } from '@/components/ui/button'"," import { Input } from '@/components/ui/input'"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"4208e924-bfd6-4333-8cba-4d7dc588bbdb"}
{"parentUuid":"b910c809-703d-49cc-9894-da8db78b3b0f","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","message":{"model":"claude-opus-4-5-20251101","id":"msg_01H8t3kgXCPN3Ay4GJxQJZZX","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Now I need to add the export handler props to the StudioPanelProps interface and add the Export section to the component. Let me first add the props.","signature":"Er4CCkYICxgCKkBii5oVVTuk7uqhcQZSg/xspiscFL2s2/kiOZgybRCPNQmcv2Sd0LPFNoLNZrBMOhZfN15Nc9V5KZrXaYSXThm5Egzq0WznWLR9XOuCvQ4aDLnmmB0y6qfxZxQYQCIwctxph3/H0HbXoL1yPY5WxFADMyij7UkOOmTo10aUpeGmO+V1JBI9T1PjzIffiNtTKqUBPKBp2tx1A+uwF4G/1+lAxW3IFm7dufbntXuaKUScVkBeJgslnmmmKepIfSTcOrjocFl6uB4QxWB9LsuKooGtXYt1QX3SJzwnwSHLMO6nlyf1ngmjVjzxxux4zRW0aB21WHGMIWZ02HNK+Ad02T4bJuQhNR6ukyhiGFbtJcq8/gsfBq/fwO9zimf8QDZSqaSCgDEhJFL+0Sm4WOutju7eykV7YuYDGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":1079,"cache_read_input_tokens":91802,"cache_creation":{"ephemeral_5m_input_tokens":1079,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CWz6UWTVMYPfG8yaFwxvP","type":"assistant","uuid":"c36b15f1-1474-4b4b-a22e-dd5791f75559","timestamp":"2026-01-10T17:31:00.189Z"}
{"parentUuid":"c36b15f1-1474-4b4b-a22e-dd5791f75559","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","message":{"model":"claude-opus-4-5-20251101","id":"msg_01H8t3kgXCPN3Ay4GJxQJZZX","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01B4Kj7ojExaAzyoksLp5pXn","name":"Edit","input":{"replace_all":false,"file_path":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend/src/components/studio/studio-panel.tsx","old_string":"  hasGeneratedAudio?: boolean\n  hasGeneratedVideo?: boolean\n  hasGeneratedResearch?: boolean\n  onOpenAudio?: () => void\n  onOpenVideo?: () => void\n  onOpenResearch?: () => void\n}","new_string":"  hasGeneratedAudio?: boolean\n  hasGeneratedVideo?: boolean\n  hasGeneratedResearch?: boolean\n  onOpenAudio?: () => void\n  onOpenVideo?: () => void\n  onOpenResearch?: () => void\n  // Export\n  onExportNotebook?: (format: 'zip' | 'pdf' | 'json', options: ExportOptionsState) => void\n  exportingNotebook?: boolean\n}\n\n// Export options state type\nexport interface ExportOptionsState {\n  includeSources: boolean\n  includeChats: boolean\n  includeNotes: boolean\n  includeGenerated: boolean\n}"}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":1079,"cache_read_input_tokens":91802,"cache_creation":{"ephemeral_5m_input_tokens":1079,"ephemeral_1h_input_tokens":0},"output_tokens":389,"service_tier":"standard"}},"requestId":"req_011CWz6UWTVMYPfG8yaFwxvP","type":"assistant","uuid":"9abe061e-a1b7-4d85-9cac-9fe219f676df","timestamp":"2026-01-10T17:31:03.209Z"}
{"parentUuid":"9abe061e-a1b7-4d85-9cac-9fe219f676df","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01B4Kj7ojExaAzyoksLp5pXn","type":"tool_result","content":"The file /Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend/src/components/studio/studio-panel.tsx has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n   130→  notesCount?: number\n   131→  onAddNote?: () => void\n   132→  onOpenNotes?: () => void\n   133→  // Generated content\n   134→  hasGeneratedAudio?: boolean\n   135→  hasGeneratedVideo?: boolean\n   136→  hasGeneratedResearch?: boolean\n   137→  onOpenAudio?: () => void\n   138→  onOpenVideo?: () => void\n   139→  onOpenResearch?: () => void\n   140→  // Export\n   141→  onExportNotebook?: (format: 'zip' | 'pdf' | 'json', options: ExportOptionsState) => void\n   142→  exportingNotebook?: boolean\n   143→}\n   144→\n   145→// Export options state type\n   146→export interface ExportOptionsState {\n   147→  includeSources: boolean\n   148→  includeChats: boolean\n   149→  includeNotes: boolean\n   150→  includeGenerated: boolean\n   151→}\n   152→\n   153→export function StudioPanel({\n   154→  notebookId,\n   155→  selectedSourcesCount,"}]},"uuid":"555da522-83a0-4567-a9c1-9b1cf6b056b0","timestamp":"2026-01-10T17:31:03.267Z","toolUseResult":{"filePath":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend/src/components/studio/studio-panel.tsx","oldString":"  hasGeneratedAudio?: boolean\n  hasGeneratedVideo?: boolean\n  hasGeneratedResearch?: boolean\n  onOpenAudio?: () => void\n  onOpenVideo?: () => void\n  onOpenResearch?: () => void\n}","newString":"  hasGeneratedAudio?: boolean\n  hasGeneratedVideo?: boolean\n  hasGeneratedResearch?: boolean\n  onOpenAudio?: () => void\n  onOpenVideo?: () => void\n  onOpenResearch?: () => void\n  // Export\n  onExportNotebook?: (format: 'zip' | 'pdf' | 'json', options: ExportOptionsState) => void\n  exportingNotebook?: boolean\n}\n\n// Export options state type\nexport interface ExportOptionsState {\n  includeSources: boolean\n  includeChats: boolean\n  includeNotes: boolean\n  includeGenerated: boolean\n}","originalFile":"'use client'\n\nimport { useState } from 'react'\nimport { motion, AnimatePresence } from 'framer-motion'\nimport {\n  Microphone,\n  VideoCamera,\n  MagnifyingGlass,\n  GraduationCap,\n  CaretDown,\n  CaretRight,\n  Play,\n  SpinnerGap,\n  BookOpen,\n  ListChecks,\n  FileText,\n  Question,\n  Note,\n  Plus,\n  ShareNetwork,\n  ArrowsClockwise,\n  Clock,\n  WarningCircle,\n  Table,\n  ChartBar,\n  PresentationChart,\n  Image,\n  Palette,\n  Cards,\n  TreeStructure,\n  ChatCircleText,\n  Sparkle,\n  Export,\n  FilePdf,\n  FileZip,\n  FileJs,\n  CheckSquare\n} from '@phosphor-icons/react'\nimport { Button } from '@/components/ui/button'\nimport { Input } from '@/components/ui/input'\nimport { Textarea } from '@/components/ui/textarea'\nimport { Badge } from '@/components/ui/badge'\nimport { ScrollArea } from '@/components/ui/scroll-area'\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select'\nimport { Tooltip, TooltipContent, TooltipTrigger } from '@/components/ui/tooltip'\nimport { GenerationConfigDialog, GenerationType, GenerationConfig } from './generation-config-dialog'\n\n// Metadata for a generated study material\nexport interface StudyMaterialMeta {\n  id: string\n  type: string\n  sourceIds: string[]\n  sourceNames: string[]\n  createdAt: string\n  itemCount?: number\n}\n\n// Helper to format relative time\nfunction getTimeAgo(dateString: string): string {\n  const date = new Date(dateString)\n  const now = new Date()\n  const diffMs = now.getTime() - date.getTime()\n  const diffMins = Math.floor(diffMs / 60000)\n  const diffHours = Math.floor(diffMs / 3600000)\n  const diffDays = Math.floor(diffMs / 86400000)\n\n  if (diffMins < 1) return 'Just now'\n  if (diffMins < 60) return `${diffMins}m ago`\n  if (diffHours < 24) return `${diffHours}h ago`\n  if (diffDays < 7) return `${diffDays}d ago`\n  return date.toLocaleDateString()\n}\n\n// Source type for selection\nexport interface SourceInfo {\n  id: string\n  name: string\n}\n\ninterface StudioPanelProps {\n  notebookId: string\n  selectedSourcesCount: number\n  selectedSourceIds: string[]\n  sources?: SourceInfo[]\n  // Audio\n  audioFormat: string\n  onAudioFormatChange: (format: string) => void\n  audioInstructions: string\n  onAudioInstructionsChange: (instructions: string) => void\n  onGenerateAudio: () => void\n  generatingAudio: boolean\n  // Video\n  videoStyle: string\n  onVideoStyleChange: (style: string) => void\n  onGenerateVideo: () => void\n  generatingVideo: boolean\n  // Research\n  researchQuery: string\n  onResearchQueryChange: (query: string) => void\n  researchMode: string\n  onResearchModeChange: (mode: string) => void\n  onRunResearch: () => void\n  researching: boolean\n  // Study - now accepts config\n  onGenerateStudyMaterial: (config: GenerationConfig) => void\n  generatingFlashcards: boolean\n  generatingQuiz: boolean\n  generatingStudyGuide: boolean\n  generatingFaq: boolean\n  generatingMindMap: boolean\n  // Creative Outputs - now accepts config\n  onGenerateCreativeOutput?: (config: GenerationConfig) => void\n  generatingDataTable?: boolean\n  generatingReport?: boolean\n  generatingSlideDeck?: boolean\n  generatingInfographic?: boolean\n  // Creative outputs results\n  creativeOutputs?: Array<{\n    id: string\n    type: string\n    title: string\n    status: string\n    createdAt: string\n  }>\n  onOpenCreativeOutput?: (type: string) => void\n  // Results - now with metadata\n  studyMaterials?: StudyMaterialMeta[]\n  onOpenStudyMaterial?: (type: string) => void\n  // Notes\n  notesCount?: number\n  onAddNote?: () => void\n  onOpenNotes?: () => void\n  // Generated content\n  hasGeneratedAudio?: boolean\n  hasGeneratedVideo?: boolean\n  hasGeneratedResearch?: boolean\n  onOpenAudio?: () => void\n  onOpenVideo?: () => void\n  onOpenResearch?: () => void\n}\n\nexport function StudioPanel({\n  notebookId,\n  selectedSourcesCount,\n  selectedSourceIds,\n  sources = [],\n  audioFormat,\n  onAudioFormatChange,\n  audioInstructions,\n  onAudioInstructionsChange,\n  onGenerateAudio,\n  generatingAudio,\n  videoStyle,\n  onVideoStyleChange,\n  onGenerateVideo,\n  generatingVideo,\n  researchQuery,\n  onResearchQueryChange,\n  researchMode,\n  onResearchModeChange,\n  onRunResearch,\n  researching,\n  onGenerateStudyMaterial,\n  generatingFlashcards,\n  generatingQuiz,\n  generatingStudyGuide,\n  generatingFaq,\n  generatingMindMap,\n  onGenerateCreativeOutput,\n  generatingDataTable = false,\n  generatingReport = false,\n  generatingSlideDeck = false,\n  generatingInfographic = false,\n  creativeOutputs = [],\n  onOpenCreativeOutput,\n  studyMaterials = [],\n  onOpenStudyMaterial,\n  notesCount = 0,\n  onAddNote,\n  onOpenNotes,\n  hasGeneratedAudio = false,\n  hasGeneratedVideo = false,\n  hasGeneratedResearch = false,\n  onOpenAudio,\n  onOpenVideo,\n  onOpenResearch,\n}: StudioPanelProps) {\n  const [expandedSection, setExpandedSection] = useState<string | null>('audio')\n  const [configDialogOpen, setConfigDialogOpen] = useState(false)\n  const [configDialogType, setConfigDialogType] = useState<GenerationType>('flashcards')\n\n  // Open config dialog for a specific type\n  const openConfigDialog = (type: GenerationType) => {\n    setConfigDialogType(type)\n    setConfigDialogOpen(true)\n  }\n\n  // Handle generation from config dialog\n  const handleGenerate = (config: GenerationConfig) => {\n    setConfigDialogOpen(false)\n\n    // Route to appropriate handler based on type\n    const studyTypes = ['flashcards', 'quiz', 'study-guide', 'faq', 'mind-map']\n    if (studyTypes.includes(config.type)) {\n      onGenerateStudyMaterial(config)\n    } else {\n      onGenerateCreativeOutput?.(config)\n    }\n  }\n\n  // Check if currently generating for a type\n  const isGenerating = (type: GenerationType): boolean => {\n    switch (type) {\n      case 'flashcards': return generatingFlashcards\n      case 'quiz': return generatingQuiz\n      case 'study-guide': return generatingStudyGuide\n      case 'faq': return generatingFaq\n      case 'mind-map': return generatingMindMap\n      case 'data_table': return generatingDataTable\n      case 'report': return generatingReport\n      case 'slide_deck': return generatingSlideDeck\n      case 'infographic': return generatingInfographic\n      default: return false\n    }\n  }\n\n  const toggleSection = (section: string) => {\n    setExpandedSection(expandedSection === section ? null : section)\n  }\n\n  // Check if a material's sources match current selection\n  const isMaterialStale = (material: StudyMaterialMeta) => {\n    const sortedMaterialIds = [...material.sourceIds].sort()\n    const sortedSelectedIds = [...selectedSourceIds].sort()\n    if (sortedMaterialIds.length !== sortedSelectedIds.length) return true\n    return !sortedMaterialIds.every((id, idx) => id === sortedSelectedIds[idx])\n  }\n\n  // Format relative time\n  const formatTimeAgo = (dateStr: string) => {\n    const date = new Date(dateStr)\n    const now = new Date()\n    const diffMs = now.getTime() - date.getTime()\n    const diffMins = Math.floor(diffMs / 60000)\n    const diffHours = Math.floor(diffMins / 60)\n    const diffDays = Math.floor(diffHours / 24)\n\n    if (diffMins < 1) return 'Just now'\n    if (diffMins < 60) return `${diffMins}m ago`\n    if (diffHours < 24) return `${diffHours}h ago`\n    if (diffDays < 7) return `${diffDays}d ago`\n    return date.toLocaleDateString()\n  }\n\n  // Get material by type\n  const getMaterial = (type: string) => studyMaterials.find(m => m.type === type)\n\n  return (\n    <ScrollArea className=\"h-full\">\n      <div className=\"p-4 space-y-3\">\n        {/* Audio Overview Section */}\n        <StudioSection\n          id=\"audio\"\n          title=\"Audio Overview\"\n          subtitle=\"Podcast-style discussion\"\n          icon={<Microphone className=\"h-5 w-5\" weight=\"duotone\" />}\n          iconGradient=\"from-orange-500/20 to-red-500/20\"\n          iconColor=\"text-orange-500\"\n          expanded={expandedSection === 'audio'}\n          onToggle={() => toggleSection('audio')}\n        >\n          <div className=\"space-y-3\">\n            <div className=\"space-y-1.5\">\n              <label className=\"text-xs font-medium text-[var(--text-primary)]\">Format</label>\n              <Select value={audioFormat} onValueChange={onAudioFormatChange}>\n                <SelectTrigger className=\"h-9 text-sm bg-[var(--bg-tertiary)] border-[rgba(255,255,255,0.1)] rounded-lg\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent className=\"bg-[var(--bg-secondary)] border-[rgba(255,255,255,0.1)]\">\n                  <SelectItem value=\"deep_dive\">Deep Dive (10-15 min)</SelectItem>\n                  <SelectItem value=\"brief\">Brief Summary (2-3 min)</SelectItem>\n                  <SelectItem value=\"critique\">Analytical (5-10 min)</SelectItem>\n                  <SelectItem value=\"debate\">Debate (8-15 min)</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n            <div className=\"space-y-1.5\">\n              <label className=\"text-xs font-medium text-[var(--text-primary)]\">Custom Instructions</label>\n              <Textarea\n                placeholder=\"Optional instructions for hosts...\"\n                value={audioInstructions}\n                onChange={(e) => onAudioInstructionsChange(e.target.value)}\n                rows={2}\n                className=\"text-sm resize-none bg-[var(--bg-tertiary)] border-[rgba(255,255,255,0.1)] text-[var(--text-primary)] placeholder:text-[var(--text-tertiary)] focus:border-[var(--accent-primary)] rounded-lg\"\n              />\n            </div>\n            <div className=\"flex gap-2\">\n              <Button\n                className=\"flex-1 rounded-lg bg-orange-500 hover:bg-orange-500/90 text-white\"\n                onClick={onGenerateAudio}\n                disabled={generatingAudio || selectedSourcesCount === 0}\n              >\n                {generatingAudio ? (\n                  <SpinnerGap className=\"h-4 w-4 mr-2 animate-spin\" weight=\"bold\" />\n                ) : (\n                  <Play className=\"h-4 w-4 mr-2\" />\n                )}\n                Generate\n              </Button>\n              {hasGeneratedAudio && onOpenAudio && (\n                <Button\n                  variant=\"outline\"\n                  className=\"rounded-lg border-orange-500/30 text-orange-500 hover:bg-orange-500/10\"\n                  onClick={onOpenAudio}\n                >\n                  View\n                  <CaretRight className=\"h-4 w-4 ml-1\" weight=\"bold\" />\n                </Button>\n              )}\n            </div>\n            {selectedSourcesCount === 0 && (\n              <p className=\"text-xs text-[var(--text-tertiary)] text-center\">\n                Select sources to generate\n              </p>\n            )}\n          </div>\n        </StudioSection>\n\n        {/* Video Overview Section */}\n        <StudioSection\n          id=\"video\"\n          title=\"Video Overview\"\n          subtitle=\"AI-generated video clip\"\n          icon={<VideoCamera className=\"h-5 w-5\" weight=\"duotone\" />}\n          iconGradient=\"from-purple-500/20 to-pink-500/20\"\n          iconColor=\"text-purple-500\"\n          expanded={expandedSection === 'video'}\n          onToggle={() => toggleSection('video')}\n        >\n          <div className=\"space-y-3\">\n            <div className=\"space-y-1.5\">\n              <label className=\"text-xs font-medium text-[var(--text-primary)]\">Style</label>\n              <Select value={videoStyle} onValueChange={onVideoStyleChange}>\n                <SelectTrigger className=\"h-9 text-sm bg-[var(--bg-tertiary)] border-[rgba(255,255,255,0.1)] rounded-lg\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent className=\"bg-[var(--bg-secondary)] border-[rgba(255,255,255,0.1)]\">\n                  <SelectItem value=\"explainer\">Explainer (5s)</SelectItem>\n                  <SelectItem value=\"documentary\">Documentary (10s)</SelectItem>\n                  <SelectItem value=\"presentation\">Presentation (5s)</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n            <p className=\"text-xs text-[var(--text-tertiary)]\">\n              Generates an AI video clip using Wan 2.5. Estimated cost: ~$0.10-0.20\n            </p>\n            <div className=\"flex gap-2\">\n              <Button\n                className=\"flex-1 rounded-lg bg-purple-500 hover:bg-purple-500/90 text-white\"\n                onClick={onGenerateVideo}\n                disabled={generatingVideo || selectedSourcesCount === 0}\n              >\n                {generatingVideo ? (\n                  <SpinnerGap className=\"h-4 w-4 mr-2 animate-spin\" weight=\"bold\" />\n                ) : (\n                  <VideoCamera className=\"h-4 w-4 mr-2\" weight=\"duotone\" />\n                )}\n                {generatingVideo ? 'Generating...' : 'Generate Video'}\n              </Button>\n              {hasGeneratedVideo && onOpenVideo && (\n                <Button\n                  variant=\"outline\"\n                  className=\"rounded-lg border-purple-500/30 text-purple-500 hover:bg-purple-500/10\"\n                  onClick={onOpenVideo}\n                >\n                  View\n                  <CaretRight className=\"h-4 w-4 ml-1\" weight=\"bold\" />\n                </Button>\n              )}\n            </div>\n            {selectedSourcesCount === 0 && (\n              <p className=\"text-xs text-[var(--text-tertiary)] text-center\">\n                Select sources to generate\n              </p>\n            )}\n          </div>\n        </StudioSection>\n\n        {/* Deep Research Section */}\n        <StudioSection\n          id=\"research\"\n          title=\"Deep Research\"\n          subtitle=\"Autonomous web research\"\n          icon={<MagnifyingGlass className=\"h-5 w-5\" weight=\"duotone\" />}\n          iconGradient=\"from-blue-500/20 to-cyan-500/20\"\n          iconColor=\"text-blue-500\"\n          expanded={expandedSection === 'research'}\n          onToggle={() => toggleSection('research')}\n        >\n          <div className=\"space-y-3\">\n            <div className=\"space-y-1.5\">\n              <label className=\"text-xs font-medium text-[var(--text-primary)]\">Research Query</label>\n              <Input\n                placeholder=\"What would you like to research?\"\n                value={researchQuery}\n                onChange={(e) => onResearchQueryChange(e.target.value)}\n                className=\"h-9 text-sm bg-[var(--bg-tertiary)] border-[rgba(255,255,255,0.1)] text-[var(--text-primary)] placeholder:text-[var(--text-tertiary)] focus:border-[var(--accent-primary)] rounded-lg\"\n              />\n            </div>\n            <div className=\"space-y-1.5\">\n              <label className=\"text-xs font-medium text-[var(--text-primary)]\">Mode</label>\n              <Select value={researchMode} onValueChange={onResearchModeChange}>\n                <SelectTrigger className=\"h-9 text-sm bg-[var(--bg-tertiary)] border-[rgba(255,255,255,0.1)] rounded-lg\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent className=\"bg-[var(--bg-secondary)] border-[rgba(255,255,255,0.1)]\">\n                  <SelectItem value=\"fast\">Fast (3-5 min)</SelectItem>\n                  <SelectItem value=\"deep\">Deep (10-15 min)</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n            <div className=\"flex gap-2\">\n              <Button\n                className=\"flex-1 rounded-lg bg-blue-500 hover:bg-blue-500/90 text-white\"\n                onClick={onRunResearch}\n                disabled={researching || !researchQuery.trim()}\n              >\n                {researching ? (\n                  <SpinnerGap className=\"h-4 w-4 mr-2 animate-spin\" weight=\"bold\" />\n                ) : (\n                  <MagnifyingGlass className=\"h-4 w-4 mr-2\" weight=\"duotone\" />\n                )}\n                Research\n              </Button>\n              {hasGeneratedResearch && onOpenResearch && (\n                <Button\n                  variant=\"outline\"\n                  className=\"rounded-lg border-blue-500/30 text-blue-500 hover:bg-blue-500/10\"\n                  onClick={onOpenResearch}\n                >\n                  View\n                  <CaretRight className=\"h-4 w-4 ml-1\" weight=\"bold\" />\n                </Button>\n              )}\n            </div>\n          </div>\n        </StudioSection>\n\n        {/* Study Materials Section */}\n        <StudioSection\n          id=\"study\"\n          title=\"Study Materials\"\n          subtitle=\"Flashcards, quizzes, and more\"\n          icon={<GraduationCap className=\"h-5 w-5\" />}\n          iconGradient=\"from-emerald-500/20 to-teal-500/20\"\n          iconColor=\"text-emerald-500\"\n          expanded={expandedSection === 'study'}\n          onToggle={() => toggleSection('study')}\n        >\n          <div className=\"space-y-4\">\n            {/* Study Tools Grid */}\n            <div className=\"grid grid-cols-2 gap-2\">\n              <StudyToolButton\n                icon={<BookOpen className=\"h-5 w-5\" />}\n                label=\"Flashcards\"\n                color=\"text-blue-500\"\n                onClick={() => openConfigDialog('flashcards')}\n                loading={generatingFlashcards}\n                disabled={selectedSourcesCount === 0}\n              />\n              <StudyToolButton\n                icon={<ListChecks className=\"h-5 w-5\" />}\n                label=\"Quiz\"\n                color=\"text-purple-500\"\n                onClick={() => openConfigDialog('quiz')}\n                loading={generatingQuiz}\n                disabled={selectedSourcesCount === 0}\n              />\n              <StudyToolButton\n                icon={<FileText className=\"h-5 w-5\" />}\n                label=\"Study Guide\"\n                color=\"text-orange-500\"\n                onClick={() => openConfigDialog('study-guide')}\n                loading={generatingStudyGuide}\n                disabled={selectedSourcesCount === 0}\n              />\n              <StudyToolButton\n                icon={<Question className=\"h-5 w-5\" weight=\"duotone\" />}\n                label=\"FAQ\"\n                color=\"text-teal-500\"\n                onClick={() => openConfigDialog('faq')}\n                loading={generatingFaq}\n                disabled={selectedSourcesCount === 0}\n              />\n              <StudyToolButton\n                icon={<TreeStructure className=\"h-5 w-5\" weight=\"duotone\" />}\n                label=\"Mind Map\"\n                color=\"text-cyan-500\"\n                onClick={() => openConfigDialog('mind-map')}\n                loading={generatingMindMap}\n                disabled={selectedSourcesCount === 0}\n              />\n            </div>\n\n            {selectedSourcesCount === 0 && (\n              <p className=\"text-xs text-[var(--text-tertiary)] text-center\">\n                Select sources to generate study materials\n              </p>\n            )}\n\n            {/* Generated Materials */}\n            {studyMaterials.length > 0 && (\n              <div className=\"pt-3 border-t border-[rgba(255,255,255,0.1)]\">\n                <p className=\"text-xs font-medium text-[var(--text-tertiary)] mb-2\">Generated Materials</p>\n                <div className=\"space-y-2\">\n                  {studyMaterials.map((material) => {\n                    const isStale = isMaterialStale(material)\n                    const iconMap: Record<string, { icon: React.ReactNode; color: string; label: string }> = {\n                      flashcards: { icon: <BookOpen className=\"h-4 w-4\" />, color: 'text-blue-500', label: `${material.itemCount || 0} Flashcards` },\n                      quiz: { icon: <ListChecks className=\"h-4 w-4\" />, color: 'text-purple-500', label: `${material.itemCount || 0} Quiz Questions` },\n                      study_guide: { icon: <FileText className=\"h-4 w-4\" />, color: 'text-orange-500', label: 'Study Guide' },\n                      faq: { icon: <ChatCircleText className=\"h-4 w-4\" weight=\"duotone\" />, color: 'text-teal-500', label: `${material.itemCount || 0} FAQ Items` },\n                      mind_map: { icon: <TreeStructure className=\"h-4 w-4\" weight=\"duotone\" />, color: 'text-cyan-500', label: 'Mind Map' },\n                    }\n                    const info = iconMap[material.type] || { icon: <FileText className=\"h-4 w-4\" />, color: 'text-gray-500', label: material.type }\n\n                    return (\n                      <div\n                        key={material.id}\n                        className={`rounded-lg border ${isStale ? 'border-amber-500/30 bg-amber-500/5' : 'border-[rgba(255,255,255,0.1)]'} overflow-hidden`}\n                      >\n                        <button\n                          onClick={() => onOpenStudyMaterial?.(material.type)}\n                          className=\"w-full flex items-center gap-2 px-3 py-2 text-sm hover:bg-[var(--bg-tertiary)] transition-colors\"\n                        >\n                          <span className={info.color}>{info.icon}</span>\n                          <span className=\"text-[var(--text-primary)] flex-1 text-left\">{info.label}</span>\n                          {isStale && (\n                            <Tooltip>\n                              <TooltipTrigger asChild>\n                                <WarningCircle className=\"h-3.5 w-3.5 text-amber-500\" weight=\"fill\" />\n                              </TooltipTrigger>\n                              <TooltipContent>\n                                <p>Sources changed - regenerate for updated content</p>\n                              </TooltipContent>\n                            </Tooltip>\n                          )}\n                          <CaretRight className=\"h-4 w-4 text-[var(--text-tertiary)]\" weight=\"bold\" />\n                        </button>\n                        <div className=\"px-3 py-1.5 bg-[var(--bg-tertiary)]/50 border-t border-[rgba(255,255,255,0.05)] flex items-center gap-3 text-[10px] text-[var(--text-tertiary)]\">\n                          <span className=\"flex items-center gap-1\">\n                            <Clock className=\"h-3 w-3\" />\n                            {formatTimeAgo(material.createdAt)}\n                          </span>\n                          <span>•</span>\n                          <span className=\"truncate\">\n                            {material.sourceNames.length === 1\n                              ? material.sourceNames[0]\n                              : `${material.sourceNames.length} sources`}\n                          </span>\n                        </div>\n                      </div>\n                    )\n                  })}\n                </div>\n              </div>\n            )}\n          </div>\n        </StudioSection>\n\n        {/* Creative Outputs Section */}\n        <StudioSection\n          id=\"creative\"\n          title=\"Creative Outputs\"\n          subtitle=\"Tables, reports, slides, infographics\"\n          icon={<Palette className=\"h-5 w-5\" />}\n          iconGradient=\"from-pink-500/20 to-rose-500/20\"\n          iconColor=\"text-pink-500\"\n          expanded={expandedSection === 'creative'}\n          onToggle={() => toggleSection('creative')}\n        >\n          <div className=\"space-y-4\">\n            {/* Creative Tools Grid */}\n            <div className=\"grid grid-cols-2 gap-2\">\n              <StudyToolButton\n                icon={<Table className=\"h-5 w-5\" />}\n                label=\"Data Table\"\n                color=\"text-emerald-500\"\n                onClick={() => openConfigDialog('data_table')}\n                loading={generatingDataTable}\n                disabled={selectedSourcesCount === 0}\n              />\n              <StudyToolButton\n                icon={<Palette className=\"h-5 w-5\" weight=\"duotone\" />}\n                label=\"Report\"\n                color=\"text-blue-500\"\n                onClick={() => openConfigDialog('report')}\n                loading={generatingReport}\n                disabled={selectedSourcesCount === 0}\n              />\n              <StudyToolButton\n                icon={<PresentationChart className=\"h-5 w-5\" />}\n                label=\"Slide Deck\"\n                color=\"text-violet-500\"\n                onClick={() => openConfigDialog('slide_deck')}\n                loading={generatingSlideDeck}\n                disabled={selectedSourcesCount === 0}\n              />\n              <StudyToolButton\n                icon={<Image className=\"h-5 w-5\" />}\n                label=\"Infographic\"\n                color=\"text-rose-500\"\n                onClick={() => openConfigDialog('infographic')}\n                loading={generatingInfographic}\n                disabled={selectedSourcesCount === 0}\n              />\n            </div>\n\n            {selectedSourcesCount === 0 && (\n              <p className=\"text-xs text-[var(--text-tertiary)] text-center\">\n                Select sources to generate creative outputs\n              </p>\n            )}\n\n            {/* Generated Outputs */}\n            {creativeOutputs.length > 0 && (\n              <div className=\"mt-4 pt-4 border-t border-[rgba(255,255,255,0.1)]\">\n                <p className=\"text-xs font-medium text-[var(--text-tertiary)] mb-3\">Generated Outputs</p>\n                <div className=\"space-y-2\">\n                  {creativeOutputs.map((output) => {\n                    const typeConfig: Record<string, { icon: React.ReactNode; label: string; color: string }> = {\n                      data_table: { icon: <Table className=\"h-4 w-4\" />, label: 'Data Table', color: 'text-emerald-500' },\n                      report: { icon: <ChartBar className=\"h-4 w-4\" weight=\"duotone\" />, label: 'Report', color: 'text-blue-500' },\n                      slide_deck: { icon: <PresentationChart className=\"h-4 w-4\" />, label: 'Slide Deck', color: 'text-violet-500' },\n                      infographic: { icon: <Image className=\"h-4 w-4\" />, label: 'Infographic', color: 'text-rose-500' },\n                    }\n                    const config = typeConfig[output.type] || { icon: <FileText className=\"h-4 w-4\" />, label: output.type, color: 'text-gray-500' }\n                    const timeAgo = getTimeAgo(output.createdAt)\n\n                    return (\n                      <button\n                        key={output.id}\n                        onClick={() => onOpenCreativeOutput?.(output.type)}\n                        className=\"w-full flex items-center gap-3 p-3 rounded-xl bg-[var(--bg-tertiary)] hover:bg-[var(--bg-tertiary)]/80 transition-colors text-left\"\n                      >\n                        <div className={`${config.color}`}>{config.icon}</div>\n                        <div className=\"flex-1 min-w-0\">\n                          <p className=\"text-sm font-medium text-[var(--text-primary)] truncate\">{config.label}</p>\n                          <p className=\"text-xs text-[var(--text-tertiary)]\">{timeAgo}</p>\n                        </div>\n                        <CaretRight className=\"h-4 w-4 text-[var(--text-tertiary)]\" weight=\"bold\" />\n                      </button>\n                    )\n                  })}\n                </div>\n              </div>\n            )}\n          </div>\n        </StudioSection>\n\n        {/* Notes Section */}\n        <StudioSection\n          id=\"notes\"\n          title=\"Notes\"\n          subtitle={`${notesCount} saved`}\n          icon={<Note className=\"h-5 w-5\" weight=\"duotone\" />}\n          iconGradient=\"from-amber-500/20 to-yellow-500/20\"\n          iconColor=\"text-amber-500\"\n          expanded={expandedSection === 'notes'}\n          onToggle={() => toggleSection('notes')}\n          action={\n            <Button\n              size=\"sm\"\n              variant=\"ghost\"\n              className=\"h-7 w-7 p-0\"\n              onClick={(e) => {\n                e.stopPropagation()\n                onAddNote?.()\n              }}\n            >\n              <Plus className=\"h-3.5 w-3.5\" />\n            </Button>\n          }\n        >\n          <div className=\"space-y-3\">\n            {notesCount === 0 ? (\n              <div className=\"text-center py-6\">\n                <Note className=\"h-8 w-8 mx-auto mb-2 text-[var(--text-tertiary)]/50\" weight=\"duotone\" />\n                <p className=\"text-sm text-[var(--text-tertiary)]\">No notes yet</p>\n                <p className=\"text-xs text-[var(--text-tertiary)] mt-1\">Create notes or save chat responses</p>\n              </div>\n            ) : (\n              <Button\n                variant=\"outline\"\n                className=\"w-full justify-start rounded-lg border-[rgba(255,255,255,0.1)] text-[var(--text-primary)] hover:bg-[var(--bg-tertiary)]\"\n                onClick={onOpenNotes}\n              >\n                <Note className=\"h-4 w-4 mr-2 text-amber-500\" weight=\"duotone\" />\n                View All Notes ({notesCount})\n                <CaretRight className=\"h-4 w-4 ml-auto text-[var(--text-tertiary)]\" weight=\"bold\" />\n              </Button>\n            )}\n          </div>\n        </StudioSection>\n      </div>\n\n      {/* Generation Config Dialog */}\n      <GenerationConfigDialog\n        open={configDialogOpen}\n        onOpenChange={setConfigDialogOpen}\n        type={configDialogType}\n        sources={sources}\n        onGenerate={handleGenerate}\n        isGenerating={isGenerating(configDialogType)}\n      />\n    </ScrollArea>\n  )\n}\n\n// Studio Section Component\nfunction StudioSection({\n  id,\n  title,\n  subtitle,\n  icon,\n  iconGradient,\n  iconColor,\n  expanded,\n  onToggle,\n  action,\n  children,\n}: {\n  id: string\n  title: string\n  subtitle: string\n  icon: React.ReactNode\n  iconGradient: string\n  iconColor: string\n  expanded: boolean\n  onToggle: () => void\n  action?: React.ReactNode\n  children: React.ReactNode\n}) {\n  return (\n    <div className=\"glass-card rounded-2xl overflow-hidden\">\n      <div className=\"flex items-center justify-between p-4 hover:bg-white/[0.02] transition-all duration-200 group\">\n        <button\n          onClick={onToggle}\n          className=\"flex items-center gap-3 flex-1\"\n        >\n          <div className={`relative w-10 h-10 rounded-xl bg-gradient-to-br ${iconGradient} flex items-center justify-center shadow-lg`}>\n            <div className=\"absolute inset-0 rounded-xl bg-gradient-to-br from-white/10 to-transparent\" />\n            <span className={`relative z-10 ${iconColor}`}>{icon}</span>\n          </div>\n          <div className=\"text-left\">\n            <p className=\"font-medium text-sm text-[var(--text-primary)] group-hover:text-white transition-colors\">{title}</p>\n            <p className=\"text-xs text-[var(--text-tertiary)]\">{subtitle}</p>\n          </div>\n        </button>\n        <div className=\"flex items-center gap-2\">\n          {action}\n          <button onClick={onToggle} className=\"p-1.5 rounded-lg hover:bg-white/5 transition-colors\">\n            <CaretDown weight=\"bold\" className={`h-4 w-4 text-[var(--text-tertiary)] transition-transform duration-200 ${expanded ? 'rotate-180' : ''}`} />\n          </button>\n        </div>\n      </div>\n\n      <AnimatePresence>\n        {expanded && (\n          <motion.div\n            initial={{ height: 0, opacity: 0 }}\n            animate={{ height: 'auto', opacity: 1 }}\n            exit={{ height: 0, opacity: 0 }}\n            transition={{ duration: 0.2 }}\n            className=\"overflow-hidden\"\n          >\n            <div className=\"px-4 pb-4 pt-2 border-t border-[rgba(255,255,255,0.1)] bg-[var(--bg-tertiary)]/30\">\n              {children}\n            </div>\n          </motion.div>\n        )}\n      </AnimatePresence>\n    </div>\n  )\n}\n\n// Study Tool Button\nfunction StudyToolButton({\n  icon,\n  label,\n  color,\n  onClick,\n  loading,\n  disabled,\n}: {\n  icon: React.ReactNode\n  label: string\n  color: string\n  onClick: () => void\n  loading: boolean\n  disabled: boolean\n}) {\n  return (\n    <button\n      onClick={onClick}\n      disabled={disabled || loading}\n      className=\"flex flex-col items-center gap-2 p-4 rounded-xl border border-[rgba(255,255,255,0.1)] bg-[var(--bg-secondary)] hover:bg-[var(--bg-tertiary)]/50 transition-colors disabled:opacity-50 disabled:cursor-not-allowed\"\n    >\n      {loading ? (\n        <SpinnerGap className=\"h-5 w-5 animate-spin text-[var(--text-tertiary)]\" weight=\"bold\" />\n      ) : (\n        <span className={color}>{icon}</span>\n      )}\n      <span className=\"text-xs font-medium text-[var(--text-primary)]\">{label}</span>\n    </button>\n  )\n}\n\n// Material Button\nfunction MaterialButton({\n  icon,\n  label,\n  onClick,\n}: {\n  icon: React.ReactNode\n  label: string\n  onClick?: () => void\n}) {\n  return (\n    <button\n      onClick={onClick}\n      className=\"w-full flex items-center gap-2 px-3 py-2 text-sm rounded-lg hover:bg-[var(--bg-tertiary)] transition-colors\"\n    >\n      {icon}\n      <span className=\"text-[var(--text-primary)]\">{label}</span>\n      <CaretRight className=\"h-4 w-4 ml-auto text-[var(--text-tertiary)]\" weight=\"bold\" />\n    </button>\n  )\n}\n","structuredPatch":[{"oldStart":137,"oldLines":8,"newStart":137,"newLines":19,"lines":["   onOpenAudio?: () => void","   onOpenVideo?: () => void","   onOpenResearch?: () => void","+  // Export","+  onExportNotebook?: (format: 'zip' | 'pdf' | 'json', options: ExportOptionsState) => void","+  exportingNotebook?: boolean"," }"," ","+// Export options state type","+export interface ExportOptionsState {","+  includeSources: boolean","+  includeChats: boolean","+  includeNotes: boolean","+  includeGenerated: boolean","+}","+"," export function StudioPanel({","   notebookId,","   selectedSourcesCount,"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"9abe061e-a1b7-4d85-9cac-9fe219f676df"}
{"parentUuid":"555da522-83a0-4567-a9c1-9b1cf6b056b0","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","message":{"model":"claude-opus-4-5-20251101","id":"msg_01PYxivxy8k7ZvagQjCT118P","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Now I need to add the export props to the destructured props in the function signature and add the Export section to the UI.","signature":"EqUCCkYICxgCKkAAPYb9xduYe3suqAsCyI1dkiTT5GFHoF+jzwsKT05DRkIf59wIUQy3EyIa1i5uC5Yjtc6F6HiAqjNyfBTI+kicEgx1MWteqbj9y8yzzIEaDD6lOL+rCtaiw7bZxSIwCBgYvMFceULea3Ihaue73l1pQ7GEUfAiv3alIOTwpavxm4grL0qbq38yFduZ6czXKowBEY6SF7u0xast8NPoQ9IueOyL/grGBT6LzVD1znNRRUbMsHAl3Fl7x0TGC/728VBVPqMT4P4262lSLu3xK4fCSix+1K3FOTlss/63ncMHTLR6GRhWndJjAX1kW/jJ0E0T0mc5xhIOV1EdKJCyNhRVGZBnKJZVMG3jIQgcIHhGa6b0mUWztTvaf2L5dlUYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":752,"cache_read_input_tokens":92881,"cache_creation":{"ephemeral_5m_input_tokens":752,"ephemeral_1h_input_tokens":0},"output_tokens":8,"service_tier":"standard"}},"requestId":"req_011CWz6V8ipEj8F4NMSwRU9P","type":"assistant","uuid":"cd6d161b-c289-454d-837d-d6ed910c2461","timestamp":"2026-01-10T17:31:07.420Z"}
{"parentUuid":"cd6d161b-c289-454d-837d-d6ed910c2461","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","message":{"model":"claude-opus-4-5-20251101","id":"msg_01PYxivxy8k7ZvagQjCT118P","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Siios7EShzZwa6WeVW96yr","name":"Edit","input":{"replace_all":false,"file_path":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend/src/components/studio/studio-panel.tsx","old_string":"  hasGeneratedAudio = false,\n  hasGeneratedVideo = false,\n  hasGeneratedResearch = false,\n  onOpenAudio,\n  onOpenVideo,\n  onOpenResearch,\n}: StudioPanelProps) {","new_string":"  hasGeneratedAudio = false,\n  hasGeneratedVideo = false,\n  hasGeneratedResearch = false,\n  onOpenAudio,\n  onOpenVideo,\n  onOpenResearch,\n  onExportNotebook,\n  exportingNotebook = false,\n}: StudioPanelProps) {"}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":752,"cache_read_input_tokens":92881,"cache_creation":{"ephemeral_5m_input_tokens":752,"ephemeral_1h_input_tokens":0},"output_tokens":311,"service_tier":"standard"}},"requestId":"req_011CWz6V8ipEj8F4NMSwRU9P","type":"assistant","uuid":"7fe945b0-3e88-4a6d-9d8d-e142cbb7ebdc","timestamp":"2026-01-10T17:31:09.306Z"}
{"parentUuid":"7fe945b0-3e88-4a6d-9d8d-e142cbb7ebdc","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Siios7EShzZwa6WeVW96yr","type":"tool_result","content":"The file /Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend/src/components/studio/studio-panel.tsx has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n   188→  onOpenStudyMaterial,\n   189→  notesCount = 0,\n   190→  onAddNote,\n   191→  onOpenNotes,\n   192→  hasGeneratedAudio = false,\n   193→  hasGeneratedVideo = false,\n   194→  hasGeneratedResearch = false,\n   195→  onOpenAudio,\n   196→  onOpenVideo,\n   197→  onOpenResearch,\n   198→  onExportNotebook,\n   199→  exportingNotebook = false,\n   200→}: StudioPanelProps) {\n   201→  const [expandedSection, setExpandedSection] = useState<string | null>('audio')\n   202→  const [configDialogOpen, setConfigDialogOpen] = useState(false)\n   203→  const [configDialogType, setConfigDialogType] = useState<GenerationType>('flashcards')\n   204→"}]},"uuid":"a0b3e46a-c9c4-419c-bb0f-fdf0a3b3e29a","timestamp":"2026-01-10T17:31:09.349Z","toolUseResult":{"filePath":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend/src/components/studio/studio-panel.tsx","oldString":"  hasGeneratedAudio = false,\n  hasGeneratedVideo = false,\n  hasGeneratedResearch = false,\n  onOpenAudio,\n  onOpenVideo,\n  onOpenResearch,\n}: StudioPanelProps) {","newString":"  hasGeneratedAudio = false,\n  hasGeneratedVideo = false,\n  hasGeneratedResearch = false,\n  onOpenAudio,\n  onOpenVideo,\n  onOpenResearch,\n  onExportNotebook,\n  exportingNotebook = false,\n}: StudioPanelProps) {","originalFile":"'use client'\n\nimport { useState } from 'react'\nimport { motion, AnimatePresence } from 'framer-motion'\nimport {\n  Microphone,\n  VideoCamera,\n  MagnifyingGlass,\n  GraduationCap,\n  CaretDown,\n  CaretRight,\n  Play,\n  SpinnerGap,\n  BookOpen,\n  ListChecks,\n  FileText,\n  Question,\n  Note,\n  Plus,\n  ShareNetwork,\n  ArrowsClockwise,\n  Clock,\n  WarningCircle,\n  Table,\n  ChartBar,\n  PresentationChart,\n  Image,\n  Palette,\n  Cards,\n  TreeStructure,\n  ChatCircleText,\n  Sparkle,\n  Export,\n  FilePdf,\n  FileZip,\n  FileJs,\n  CheckSquare\n} from '@phosphor-icons/react'\nimport { Button } from '@/components/ui/button'\nimport { Input } from '@/components/ui/input'\nimport { Textarea } from '@/components/ui/textarea'\nimport { Badge } from '@/components/ui/badge'\nimport { ScrollArea } from '@/components/ui/scroll-area'\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select'\nimport { Tooltip, TooltipContent, TooltipTrigger } from '@/components/ui/tooltip'\nimport { GenerationConfigDialog, GenerationType, GenerationConfig } from './generation-config-dialog'\n\n// Metadata for a generated study material\nexport interface StudyMaterialMeta {\n  id: string\n  type: string\n  sourceIds: string[]\n  sourceNames: string[]\n  createdAt: string\n  itemCount?: number\n}\n\n// Helper to format relative time\nfunction getTimeAgo(dateString: string): string {\n  const date = new Date(dateString)\n  const now = new Date()\n  const diffMs = now.getTime() - date.getTime()\n  const diffMins = Math.floor(diffMs / 60000)\n  const diffHours = Math.floor(diffMs / 3600000)\n  const diffDays = Math.floor(diffMs / 86400000)\n\n  if (diffMins < 1) return 'Just now'\n  if (diffMins < 60) return `${diffMins}m ago`\n  if (diffHours < 24) return `${diffHours}h ago`\n  if (diffDays < 7) return `${diffDays}d ago`\n  return date.toLocaleDateString()\n}\n\n// Source type for selection\nexport interface SourceInfo {\n  id: string\n  name: string\n}\n\ninterface StudioPanelProps {\n  notebookId: string\n  selectedSourcesCount: number\n  selectedSourceIds: string[]\n  sources?: SourceInfo[]\n  // Audio\n  audioFormat: string\n  onAudioFormatChange: (format: string) => void\n  audioInstructions: string\n  onAudioInstructionsChange: (instructions: string) => void\n  onGenerateAudio: () => void\n  generatingAudio: boolean\n  // Video\n  videoStyle: string\n  onVideoStyleChange: (style: string) => void\n  onGenerateVideo: () => void\n  generatingVideo: boolean\n  // Research\n  researchQuery: string\n  onResearchQueryChange: (query: string) => void\n  researchMode: string\n  onResearchModeChange: (mode: string) => void\n  onRunResearch: () => void\n  researching: boolean\n  // Study - now accepts config\n  onGenerateStudyMaterial: (config: GenerationConfig) => void\n  generatingFlashcards: boolean\n  generatingQuiz: boolean\n  generatingStudyGuide: boolean\n  generatingFaq: boolean\n  generatingMindMap: boolean\n  // Creative Outputs - now accepts config\n  onGenerateCreativeOutput?: (config: GenerationConfig) => void\n  generatingDataTable?: boolean\n  generatingReport?: boolean\n  generatingSlideDeck?: boolean\n  generatingInfographic?: boolean\n  // Creative outputs results\n  creativeOutputs?: Array<{\n    id: string\n    type: string\n    title: string\n    status: string\n    createdAt: string\n  }>\n  onOpenCreativeOutput?: (type: string) => void\n  // Results - now with metadata\n  studyMaterials?: StudyMaterialMeta[]\n  onOpenStudyMaterial?: (type: string) => void\n  // Notes\n  notesCount?: number\n  onAddNote?: () => void\n  onOpenNotes?: () => void\n  // Generated content\n  hasGeneratedAudio?: boolean\n  hasGeneratedVideo?: boolean\n  hasGeneratedResearch?: boolean\n  onOpenAudio?: () => void\n  onOpenVideo?: () => void\n  onOpenResearch?: () => void\n  // Export\n  onExportNotebook?: (format: 'zip' | 'pdf' | 'json', options: ExportOptionsState) => void\n  exportingNotebook?: boolean\n}\n\n// Export options state type\nexport interface ExportOptionsState {\n  includeSources: boolean\n  includeChats: boolean\n  includeNotes: boolean\n  includeGenerated: boolean\n}\n\nexport function StudioPanel({\n  notebookId,\n  selectedSourcesCount,\n  selectedSourceIds,\n  sources = [],\n  audioFormat,\n  onAudioFormatChange,\n  audioInstructions,\n  onAudioInstructionsChange,\n  onGenerateAudio,\n  generatingAudio,\n  videoStyle,\n  onVideoStyleChange,\n  onGenerateVideo,\n  generatingVideo,\n  researchQuery,\n  onResearchQueryChange,\n  researchMode,\n  onResearchModeChange,\n  onRunResearch,\n  researching,\n  onGenerateStudyMaterial,\n  generatingFlashcards,\n  generatingQuiz,\n  generatingStudyGuide,\n  generatingFaq,\n  generatingMindMap,\n  onGenerateCreativeOutput,\n  generatingDataTable = false,\n  generatingReport = false,\n  generatingSlideDeck = false,\n  generatingInfographic = false,\n  creativeOutputs = [],\n  onOpenCreativeOutput,\n  studyMaterials = [],\n  onOpenStudyMaterial,\n  notesCount = 0,\n  onAddNote,\n  onOpenNotes,\n  hasGeneratedAudio = false,\n  hasGeneratedVideo = false,\n  hasGeneratedResearch = false,\n  onOpenAudio,\n  onOpenVideo,\n  onOpenResearch,\n}: StudioPanelProps) {\n  const [expandedSection, setExpandedSection] = useState<string | null>('audio')\n  const [configDialogOpen, setConfigDialogOpen] = useState(false)\n  const [configDialogType, setConfigDialogType] = useState<GenerationType>('flashcards')\n\n  // Open config dialog for a specific type\n  const openConfigDialog = (type: GenerationType) => {\n    setConfigDialogType(type)\n    setConfigDialogOpen(true)\n  }\n\n  // Handle generation from config dialog\n  const handleGenerate = (config: GenerationConfig) => {\n    setConfigDialogOpen(false)\n\n    // Route to appropriate handler based on type\n    const studyTypes = ['flashcards', 'quiz', 'study-guide', 'faq', 'mind-map']\n    if (studyTypes.includes(config.type)) {\n      onGenerateStudyMaterial(config)\n    } else {\n      onGenerateCreativeOutput?.(config)\n    }\n  }\n\n  // Check if currently generating for a type\n  const isGenerating = (type: GenerationType): boolean => {\n    switch (type) {\n      case 'flashcards': return generatingFlashcards\n      case 'quiz': return generatingQuiz\n      case 'study-guide': return generatingStudyGuide\n      case 'faq': return generatingFaq\n      case 'mind-map': return generatingMindMap\n      case 'data_table': return generatingDataTable\n      case 'report': return generatingReport\n      case 'slide_deck': return generatingSlideDeck\n      case 'infographic': return generatingInfographic\n      default: return false\n    }\n  }\n\n  const toggleSection = (section: string) => {\n    setExpandedSection(expandedSection === section ? null : section)\n  }\n\n  // Check if a material's sources match current selection\n  const isMaterialStale = (material: StudyMaterialMeta) => {\n    const sortedMaterialIds = [...material.sourceIds].sort()\n    const sortedSelectedIds = [...selectedSourceIds].sort()\n    if (sortedMaterialIds.length !== sortedSelectedIds.length) return true\n    return !sortedMaterialIds.every((id, idx) => id === sortedSelectedIds[idx])\n  }\n\n  // Format relative time\n  const formatTimeAgo = (dateStr: string) => {\n    const date = new Date(dateStr)\n    const now = new Date()\n    const diffMs = now.getTime() - date.getTime()\n    const diffMins = Math.floor(diffMs / 60000)\n    const diffHours = Math.floor(diffMins / 60)\n    const diffDays = Math.floor(diffHours / 24)\n\n    if (diffMins < 1) return 'Just now'\n    if (diffMins < 60) return `${diffMins}m ago`\n    if (diffHours < 24) return `${diffHours}h ago`\n    if (diffDays < 7) return `${diffDays}d ago`\n    return date.toLocaleDateString()\n  }\n\n  // Get material by type\n  const getMaterial = (type: string) => studyMaterials.find(m => m.type === type)\n\n  return (\n    <ScrollArea className=\"h-full\">\n      <div className=\"p-4 space-y-3\">\n        {/* Audio Overview Section */}\n        <StudioSection\n          id=\"audio\"\n          title=\"Audio Overview\"\n          subtitle=\"Podcast-style discussion\"\n          icon={<Microphone className=\"h-5 w-5\" weight=\"duotone\" />}\n          iconGradient=\"from-orange-500/20 to-red-500/20\"\n          iconColor=\"text-orange-500\"\n          expanded={expandedSection === 'audio'}\n          onToggle={() => toggleSection('audio')}\n        >\n          <div className=\"space-y-3\">\n            <div className=\"space-y-1.5\">\n              <label className=\"text-xs font-medium text-[var(--text-primary)]\">Format</label>\n              <Select value={audioFormat} onValueChange={onAudioFormatChange}>\n                <SelectTrigger className=\"h-9 text-sm bg-[var(--bg-tertiary)] border-[rgba(255,255,255,0.1)] rounded-lg\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent className=\"bg-[var(--bg-secondary)] border-[rgba(255,255,255,0.1)]\">\n                  <SelectItem value=\"deep_dive\">Deep Dive (10-15 min)</SelectItem>\n                  <SelectItem value=\"brief\">Brief Summary (2-3 min)</SelectItem>\n                  <SelectItem value=\"critique\">Analytical (5-10 min)</SelectItem>\n                  <SelectItem value=\"debate\">Debate (8-15 min)</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n            <div className=\"space-y-1.5\">\n              <label className=\"text-xs font-medium text-[var(--text-primary)]\">Custom Instructions</label>\n              <Textarea\n                placeholder=\"Optional instructions for hosts...\"\n                value={audioInstructions}\n                onChange={(e) => onAudioInstructionsChange(e.target.value)}\n                rows={2}\n                className=\"text-sm resize-none bg-[var(--bg-tertiary)] border-[rgba(255,255,255,0.1)] text-[var(--text-primary)] placeholder:text-[var(--text-tertiary)] focus:border-[var(--accent-primary)] rounded-lg\"\n              />\n            </div>\n            <div className=\"flex gap-2\">\n              <Button\n                className=\"flex-1 rounded-lg bg-orange-500 hover:bg-orange-500/90 text-white\"\n                onClick={onGenerateAudio}\n                disabled={generatingAudio || selectedSourcesCount === 0}\n              >\n                {generatingAudio ? (\n                  <SpinnerGap className=\"h-4 w-4 mr-2 animate-spin\" weight=\"bold\" />\n                ) : (\n                  <Play className=\"h-4 w-4 mr-2\" />\n                )}\n                Generate\n              </Button>\n              {hasGeneratedAudio && onOpenAudio && (\n                <Button\n                  variant=\"outline\"\n                  className=\"rounded-lg border-orange-500/30 text-orange-500 hover:bg-orange-500/10\"\n                  onClick={onOpenAudio}\n                >\n                  View\n                  <CaretRight className=\"h-4 w-4 ml-1\" weight=\"bold\" />\n                </Button>\n              )}\n            </div>\n            {selectedSourcesCount === 0 && (\n              <p className=\"text-xs text-[var(--text-tertiary)] text-center\">\n                Select sources to generate\n              </p>\n            )}\n          </div>\n        </StudioSection>\n\n        {/* Video Overview Section */}\n        <StudioSection\n          id=\"video\"\n          title=\"Video Overview\"\n          subtitle=\"AI-generated video clip\"\n          icon={<VideoCamera className=\"h-5 w-5\" weight=\"duotone\" />}\n          iconGradient=\"from-purple-500/20 to-pink-500/20\"\n          iconColor=\"text-purple-500\"\n          expanded={expandedSection === 'video'}\n          onToggle={() => toggleSection('video')}\n        >\n          <div className=\"space-y-3\">\n            <div className=\"space-y-1.5\">\n              <label className=\"text-xs font-medium text-[var(--text-primary)]\">Style</label>\n              <Select value={videoStyle} onValueChange={onVideoStyleChange}>\n                <SelectTrigger className=\"h-9 text-sm bg-[var(--bg-tertiary)] border-[rgba(255,255,255,0.1)] rounded-lg\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent className=\"bg-[var(--bg-secondary)] border-[rgba(255,255,255,0.1)]\">\n                  <SelectItem value=\"explainer\">Explainer (5s)</SelectItem>\n                  <SelectItem value=\"documentary\">Documentary (10s)</SelectItem>\n                  <SelectItem value=\"presentation\">Presentation (5s)</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n            <p className=\"text-xs text-[var(--text-tertiary)]\">\n              Generates an AI video clip using Wan 2.5. Estimated cost: ~$0.10-0.20\n            </p>\n            <div className=\"flex gap-2\">\n              <Button\n                className=\"flex-1 rounded-lg bg-purple-500 hover:bg-purple-500/90 text-white\"\n                onClick={onGenerateVideo}\n                disabled={generatingVideo || selectedSourcesCount === 0}\n              >\n                {generatingVideo ? (\n                  <SpinnerGap className=\"h-4 w-4 mr-2 animate-spin\" weight=\"bold\" />\n                ) : (\n                  <VideoCamera className=\"h-4 w-4 mr-2\" weight=\"duotone\" />\n                )}\n                {generatingVideo ? 'Generating...' : 'Generate Video'}\n              </Button>\n              {hasGeneratedVideo && onOpenVideo && (\n                <Button\n                  variant=\"outline\"\n                  className=\"rounded-lg border-purple-500/30 text-purple-500 hover:bg-purple-500/10\"\n                  onClick={onOpenVideo}\n                >\n                  View\n                  <CaretRight className=\"h-4 w-4 ml-1\" weight=\"bold\" />\n                </Button>\n              )}\n            </div>\n            {selectedSourcesCount === 0 && (\n              <p className=\"text-xs text-[var(--text-tertiary)] text-center\">\n                Select sources to generate\n              </p>\n            )}\n          </div>\n        </StudioSection>\n\n        {/* Deep Research Section */}\n        <StudioSection\n          id=\"research\"\n          title=\"Deep Research\"\n          subtitle=\"Autonomous web research\"\n          icon={<MagnifyingGlass className=\"h-5 w-5\" weight=\"duotone\" />}\n          iconGradient=\"from-blue-500/20 to-cyan-500/20\"\n          iconColor=\"text-blue-500\"\n          expanded={expandedSection === 'research'}\n          onToggle={() => toggleSection('research')}\n        >\n          <div className=\"space-y-3\">\n            <div className=\"space-y-1.5\">\n              <label className=\"text-xs font-medium text-[var(--text-primary)]\">Research Query</label>\n              <Input\n                placeholder=\"What would you like to research?\"\n                value={researchQuery}\n                onChange={(e) => onResearchQueryChange(e.target.value)}\n                className=\"h-9 text-sm bg-[var(--bg-tertiary)] border-[rgba(255,255,255,0.1)] text-[var(--text-primary)] placeholder:text-[var(--text-tertiary)] focus:border-[var(--accent-primary)] rounded-lg\"\n              />\n            </div>\n            <div className=\"space-y-1.5\">\n              <label className=\"text-xs font-medium text-[var(--text-primary)]\">Mode</label>\n              <Select value={researchMode} onValueChange={onResearchModeChange}>\n                <SelectTrigger className=\"h-9 text-sm bg-[var(--bg-tertiary)] border-[rgba(255,255,255,0.1)] rounded-lg\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent className=\"bg-[var(--bg-secondary)] border-[rgba(255,255,255,0.1)]\">\n                  <SelectItem value=\"fast\">Fast (3-5 min)</SelectItem>\n                  <SelectItem value=\"deep\">Deep (10-15 min)</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n            <div className=\"flex gap-2\">\n              <Button\n                className=\"flex-1 rounded-lg bg-blue-500 hover:bg-blue-500/90 text-white\"\n                onClick={onRunResearch}\n                disabled={researching || !researchQuery.trim()}\n              >\n                {researching ? (\n                  <SpinnerGap className=\"h-4 w-4 mr-2 animate-spin\" weight=\"bold\" />\n                ) : (\n                  <MagnifyingGlass className=\"h-4 w-4 mr-2\" weight=\"duotone\" />\n                )}\n                Research\n              </Button>\n              {hasGeneratedResearch && onOpenResearch && (\n                <Button\n                  variant=\"outline\"\n                  className=\"rounded-lg border-blue-500/30 text-blue-500 hover:bg-blue-500/10\"\n                  onClick={onOpenResearch}\n                >\n                  View\n                  <CaretRight className=\"h-4 w-4 ml-1\" weight=\"bold\" />\n                </Button>\n              )}\n            </div>\n          </div>\n        </StudioSection>\n\n        {/* Study Materials Section */}\n        <StudioSection\n          id=\"study\"\n          title=\"Study Materials\"\n          subtitle=\"Flashcards, quizzes, and more\"\n          icon={<GraduationCap className=\"h-5 w-5\" />}\n          iconGradient=\"from-emerald-500/20 to-teal-500/20\"\n          iconColor=\"text-emerald-500\"\n          expanded={expandedSection === 'study'}\n          onToggle={() => toggleSection('study')}\n        >\n          <div className=\"space-y-4\">\n            {/* Study Tools Grid */}\n            <div className=\"grid grid-cols-2 gap-2\">\n              <StudyToolButton\n                icon={<BookOpen className=\"h-5 w-5\" />}\n                label=\"Flashcards\"\n                color=\"text-blue-500\"\n                onClick={() => openConfigDialog('flashcards')}\n                loading={generatingFlashcards}\n                disabled={selectedSourcesCount === 0}\n              />\n              <StudyToolButton\n                icon={<ListChecks className=\"h-5 w-5\" />}\n                label=\"Quiz\"\n                color=\"text-purple-500\"\n                onClick={() => openConfigDialog('quiz')}\n                loading={generatingQuiz}\n                disabled={selectedSourcesCount === 0}\n              />\n              <StudyToolButton\n                icon={<FileText className=\"h-5 w-5\" />}\n                label=\"Study Guide\"\n                color=\"text-orange-500\"\n                onClick={() => openConfigDialog('study-guide')}\n                loading={generatingStudyGuide}\n                disabled={selectedSourcesCount === 0}\n              />\n              <StudyToolButton\n                icon={<Question className=\"h-5 w-5\" weight=\"duotone\" />}\n                label=\"FAQ\"\n                color=\"text-teal-500\"\n                onClick={() => openConfigDialog('faq')}\n                loading={generatingFaq}\n                disabled={selectedSourcesCount === 0}\n              />\n              <StudyToolButton\n                icon={<TreeStructure className=\"h-5 w-5\" weight=\"duotone\" />}\n                label=\"Mind Map\"\n                color=\"text-cyan-500\"\n                onClick={() => openConfigDialog('mind-map')}\n                loading={generatingMindMap}\n                disabled={selectedSourcesCount === 0}\n              />\n            </div>\n\n            {selectedSourcesCount === 0 && (\n              <p className=\"text-xs text-[var(--text-tertiary)] text-center\">\n                Select sources to generate study materials\n              </p>\n            )}\n\n            {/* Generated Materials */}\n            {studyMaterials.length > 0 && (\n              <div className=\"pt-3 border-t border-[rgba(255,255,255,0.1)]\">\n                <p className=\"text-xs font-medium text-[var(--text-tertiary)] mb-2\">Generated Materials</p>\n                <div className=\"space-y-2\">\n                  {studyMaterials.map((material) => {\n                    const isStale = isMaterialStale(material)\n                    const iconMap: Record<string, { icon: React.ReactNode; color: string; label: string }> = {\n                      flashcards: { icon: <BookOpen className=\"h-4 w-4\" />, color: 'text-blue-500', label: `${material.itemCount || 0} Flashcards` },\n                      quiz: { icon: <ListChecks className=\"h-4 w-4\" />, color: 'text-purple-500', label: `${material.itemCount || 0} Quiz Questions` },\n                      study_guide: { icon: <FileText className=\"h-4 w-4\" />, color: 'text-orange-500', label: 'Study Guide' },\n                      faq: { icon: <ChatCircleText className=\"h-4 w-4\" weight=\"duotone\" />, color: 'text-teal-500', label: `${material.itemCount || 0} FAQ Items` },\n                      mind_map: { icon: <TreeStructure className=\"h-4 w-4\" weight=\"duotone\" />, color: 'text-cyan-500', label: 'Mind Map' },\n                    }\n                    const info = iconMap[material.type] || { icon: <FileText className=\"h-4 w-4\" />, color: 'text-gray-500', label: material.type }\n\n                    return (\n                      <div\n                        key={material.id}\n                        className={`rounded-lg border ${isStale ? 'border-amber-500/30 bg-amber-500/5' : 'border-[rgba(255,255,255,0.1)]'} overflow-hidden`}\n                      >\n                        <button\n                          onClick={() => onOpenStudyMaterial?.(material.type)}\n                          className=\"w-full flex items-center gap-2 px-3 py-2 text-sm hover:bg-[var(--bg-tertiary)] transition-colors\"\n                        >\n                          <span className={info.color}>{info.icon}</span>\n                          <span className=\"text-[var(--text-primary)] flex-1 text-left\">{info.label}</span>\n                          {isStale && (\n                            <Tooltip>\n                              <TooltipTrigger asChild>\n                                <WarningCircle className=\"h-3.5 w-3.5 text-amber-500\" weight=\"fill\" />\n                              </TooltipTrigger>\n                              <TooltipContent>\n                                <p>Sources changed - regenerate for updated content</p>\n                              </TooltipContent>\n                            </Tooltip>\n                          )}\n                          <CaretRight className=\"h-4 w-4 text-[var(--text-tertiary)]\" weight=\"bold\" />\n                        </button>\n                        <div className=\"px-3 py-1.5 bg-[var(--bg-tertiary)]/50 border-t border-[rgba(255,255,255,0.05)] flex items-center gap-3 text-[10px] text-[var(--text-tertiary)]\">\n                          <span className=\"flex items-center gap-1\">\n                            <Clock className=\"h-3 w-3\" />\n                            {formatTimeAgo(material.createdAt)}\n                          </span>\n                          <span>•</span>\n                          <span className=\"truncate\">\n                            {material.sourceNames.length === 1\n                              ? material.sourceNames[0]\n                              : `${material.sourceNames.length} sources`}\n                          </span>\n                        </div>\n                      </div>\n                    )\n                  })}\n                </div>\n              </div>\n            )}\n          </div>\n        </StudioSection>\n\n        {/* Creative Outputs Section */}\n        <StudioSection\n          id=\"creative\"\n          title=\"Creative Outputs\"\n          subtitle=\"Tables, reports, slides, infographics\"\n          icon={<Palette className=\"h-5 w-5\" />}\n          iconGradient=\"from-pink-500/20 to-rose-500/20\"\n          iconColor=\"text-pink-500\"\n          expanded={expandedSection === 'creative'}\n          onToggle={() => toggleSection('creative')}\n        >\n          <div className=\"space-y-4\">\n            {/* Creative Tools Grid */}\n            <div className=\"grid grid-cols-2 gap-2\">\n              <StudyToolButton\n                icon={<Table className=\"h-5 w-5\" />}\n                label=\"Data Table\"\n                color=\"text-emerald-500\"\n                onClick={() => openConfigDialog('data_table')}\n                loading={generatingDataTable}\n                disabled={selectedSourcesCount === 0}\n              />\n              <StudyToolButton\n                icon={<Palette className=\"h-5 w-5\" weight=\"duotone\" />}\n                label=\"Report\"\n                color=\"text-blue-500\"\n                onClick={() => openConfigDialog('report')}\n                loading={generatingReport}\n                disabled={selectedSourcesCount === 0}\n              />\n              <StudyToolButton\n                icon={<PresentationChart className=\"h-5 w-5\" />}\n                label=\"Slide Deck\"\n                color=\"text-violet-500\"\n                onClick={() => openConfigDialog('slide_deck')}\n                loading={generatingSlideDeck}\n                disabled={selectedSourcesCount === 0}\n              />\n              <StudyToolButton\n                icon={<Image className=\"h-5 w-5\" />}\n                label=\"Infographic\"\n                color=\"text-rose-500\"\n                onClick={() => openConfigDialog('infographic')}\n                loading={generatingInfographic}\n                disabled={selectedSourcesCount === 0}\n              />\n            </div>\n\n            {selectedSourcesCount === 0 && (\n              <p className=\"text-xs text-[var(--text-tertiary)] text-center\">\n                Select sources to generate creative outputs\n              </p>\n            )}\n\n            {/* Generated Outputs */}\n            {creativeOutputs.length > 0 && (\n              <div className=\"mt-4 pt-4 border-t border-[rgba(255,255,255,0.1)]\">\n                <p className=\"text-xs font-medium text-[var(--text-tertiary)] mb-3\">Generated Outputs</p>\n                <div className=\"space-y-2\">\n                  {creativeOutputs.map((output) => {\n                    const typeConfig: Record<string, { icon: React.ReactNode; label: string; color: string }> = {\n                      data_table: { icon: <Table className=\"h-4 w-4\" />, label: 'Data Table', color: 'text-emerald-500' },\n                      report: { icon: <ChartBar className=\"h-4 w-4\" weight=\"duotone\" />, label: 'Report', color: 'text-blue-500' },\n                      slide_deck: { icon: <PresentationChart className=\"h-4 w-4\" />, label: 'Slide Deck', color: 'text-violet-500' },\n                      infographic: { icon: <Image className=\"h-4 w-4\" />, label: 'Infographic', color: 'text-rose-500' },\n                    }\n                    const config = typeConfig[output.type] || { icon: <FileText className=\"h-4 w-4\" />, label: output.type, color: 'text-gray-500' }\n                    const timeAgo = getTimeAgo(output.createdAt)\n\n                    return (\n                      <button\n                        key={output.id}\n                        onClick={() => onOpenCreativeOutput?.(output.type)}\n                        className=\"w-full flex items-center gap-3 p-3 rounded-xl bg-[var(--bg-tertiary)] hover:bg-[var(--bg-tertiary)]/80 transition-colors text-left\"\n                      >\n                        <div className={`${config.color}`}>{config.icon}</div>\n                        <div className=\"flex-1 min-w-0\">\n                          <p className=\"text-sm font-medium text-[var(--text-primary)] truncate\">{config.label}</p>\n                          <p className=\"text-xs text-[var(--text-tertiary)]\">{timeAgo}</p>\n                        </div>\n                        <CaretRight className=\"h-4 w-4 text-[var(--text-tertiary)]\" weight=\"bold\" />\n                      </button>\n                    )\n                  })}\n                </div>\n              </div>\n            )}\n          </div>\n        </StudioSection>\n\n        {/* Notes Section */}\n        <StudioSection\n          id=\"notes\"\n          title=\"Notes\"\n          subtitle={`${notesCount} saved`}\n          icon={<Note className=\"h-5 w-5\" weight=\"duotone\" />}\n          iconGradient=\"from-amber-500/20 to-yellow-500/20\"\n          iconColor=\"text-amber-500\"\n          expanded={expandedSection === 'notes'}\n          onToggle={() => toggleSection('notes')}\n          action={\n            <Button\n              size=\"sm\"\n              variant=\"ghost\"\n              className=\"h-7 w-7 p-0\"\n              onClick={(e) => {\n                e.stopPropagation()\n                onAddNote?.()\n              }}\n            >\n              <Plus className=\"h-3.5 w-3.5\" />\n            </Button>\n          }\n        >\n          <div className=\"space-y-3\">\n            {notesCount === 0 ? (\n              <div className=\"text-center py-6\">\n                <Note className=\"h-8 w-8 mx-auto mb-2 text-[var(--text-tertiary)]/50\" weight=\"duotone\" />\n                <p className=\"text-sm text-[var(--text-tertiary)]\">No notes yet</p>\n                <p className=\"text-xs text-[var(--text-tertiary)] mt-1\">Create notes or save chat responses</p>\n              </div>\n            ) : (\n              <Button\n                variant=\"outline\"\n                className=\"w-full justify-start rounded-lg border-[rgba(255,255,255,0.1)] text-[var(--text-primary)] hover:bg-[var(--bg-tertiary)]\"\n                onClick={onOpenNotes}\n              >\n                <Note className=\"h-4 w-4 mr-2 text-amber-500\" weight=\"duotone\" />\n                View All Notes ({notesCount})\n                <CaretRight className=\"h-4 w-4 ml-auto text-[var(--text-tertiary)]\" weight=\"bold\" />\n              </Button>\n            )}\n          </div>\n        </StudioSection>\n      </div>\n\n      {/* Generation Config Dialog */}\n      <GenerationConfigDialog\n        open={configDialogOpen}\n        onOpenChange={setConfigDialogOpen}\n        type={configDialogType}\n        sources={sources}\n        onGenerate={handleGenerate}\n        isGenerating={isGenerating(configDialogType)}\n      />\n    </ScrollArea>\n  )\n}\n\n// Studio Section Component\nfunction StudioSection({\n  id,\n  title,\n  subtitle,\n  icon,\n  iconGradient,\n  iconColor,\n  expanded,\n  onToggle,\n  action,\n  children,\n}: {\n  id: string\n  title: string\n  subtitle: string\n  icon: React.ReactNode\n  iconGradient: string\n  iconColor: string\n  expanded: boolean\n  onToggle: () => void\n  action?: React.ReactNode\n  children: React.ReactNode\n}) {\n  return (\n    <div className=\"glass-card rounded-2xl overflow-hidden\">\n      <div className=\"flex items-center justify-between p-4 hover:bg-white/[0.02] transition-all duration-200 group\">\n        <button\n          onClick={onToggle}\n          className=\"flex items-center gap-3 flex-1\"\n        >\n          <div className={`relative w-10 h-10 rounded-xl bg-gradient-to-br ${iconGradient} flex items-center justify-center shadow-lg`}>\n            <div className=\"absolute inset-0 rounded-xl bg-gradient-to-br from-white/10 to-transparent\" />\n            <span className={`relative z-10 ${iconColor}`}>{icon}</span>\n          </div>\n          <div className=\"text-left\">\n            <p className=\"font-medium text-sm text-[var(--text-primary)] group-hover:text-white transition-colors\">{title}</p>\n            <p className=\"text-xs text-[var(--text-tertiary)]\">{subtitle}</p>\n          </div>\n        </button>\n        <div className=\"flex items-center gap-2\">\n          {action}\n          <button onClick={onToggle} className=\"p-1.5 rounded-lg hover:bg-white/5 transition-colors\">\n            <CaretDown weight=\"bold\" className={`h-4 w-4 text-[var(--text-tertiary)] transition-transform duration-200 ${expanded ? 'rotate-180' : ''}`} />\n          </button>\n        </div>\n      </div>\n\n      <AnimatePresence>\n        {expanded && (\n          <motion.div\n            initial={{ height: 0, opacity: 0 }}\n            animate={{ height: 'auto', opacity: 1 }}\n            exit={{ height: 0, opacity: 0 }}\n            transition={{ duration: 0.2 }}\n            className=\"overflow-hidden\"\n          >\n            <div className=\"px-4 pb-4 pt-2 border-t border-[rgba(255,255,255,0.1)] bg-[var(--bg-tertiary)]/30\">\n              {children}\n            </div>\n          </motion.div>\n        )}\n      </AnimatePresence>\n    </div>\n  )\n}\n\n// Study Tool Button\nfunction StudyToolButton({\n  icon,\n  label,\n  color,\n  onClick,\n  loading,\n  disabled,\n}: {\n  icon: React.ReactNode\n  label: string\n  color: string\n  onClick: () => void\n  loading: boolean\n  disabled: boolean\n}) {\n  return (\n    <button\n      onClick={onClick}\n      disabled={disabled || loading}\n      className=\"flex flex-col items-center gap-2 p-4 rounded-xl border border-[rgba(255,255,255,0.1)] bg-[var(--bg-secondary)] hover:bg-[var(--bg-tertiary)]/50 transition-colors disabled:opacity-50 disabled:cursor-not-allowed\"\n    >\n      {loading ? (\n        <SpinnerGap className=\"h-5 w-5 animate-spin text-[var(--text-tertiary)]\" weight=\"bold\" />\n      ) : (\n        <span className={color}>{icon}</span>\n      )}\n      <span className=\"text-xs font-medium text-[var(--text-primary)]\">{label}</span>\n    </button>\n  )\n}\n\n// Material Button\nfunction MaterialButton({\n  icon,\n  label,\n  onClick,\n}: {\n  icon: React.ReactNode\n  label: string\n  onClick?: () => void\n}) {\n  return (\n    <button\n      onClick={onClick}\n      className=\"w-full flex items-center gap-2 px-3 py-2 text-sm rounded-lg hover:bg-[var(--bg-tertiary)] transition-colors\"\n    >\n      {icon}\n      <span className=\"text-[var(--text-primary)]\">{label}</span>\n      <CaretRight className=\"h-4 w-4 ml-auto text-[var(--text-tertiary)]\" weight=\"bold\" />\n    </button>\n  )\n}\n","structuredPatch":[{"oldStart":195,"oldLines":6,"newStart":195,"newLines":8,"lines":["   onOpenAudio,","   onOpenVideo,","   onOpenResearch,","+  onExportNotebook,","+  exportingNotebook = false,"," }: StudioPanelProps) {","   const [expandedSection, setExpandedSection] = useState<string | null>('audio')","   const [configDialogOpen, setConfigDialogOpen] = useState(false)"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"7fe945b0-3e88-4a6d-9d8d-e142cbb7ebdc"}
{"parentUuid":"a0b3e46a-c9c4-419c-bb0f-fdf0a3b3e29a","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","message":{"model":"claude-opus-4-5-20251101","id":"msg_01BtJuL3Xj2Av8TZExXpkcfg","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Now I need to add state for the export options and add the Export section after the Notes section in the UI.","signature":"EpQCCkYICxgCKkCwkNtJCwwXvLTCzr57WkkCrqVMRDhnpBvN9lVythGmZm2yPP7V9YAC75UsHl5XKrJZbAYcsDhDDIROiFTkQsiPEgwCC0bqTv9q1lTpEegaDBjbGvBkKAQ67NbmYSIwmAgzahCz1r/uVzIGhmvlx1JSboTRlYGaqRqRF4XKz+djZZCIiBZjwBUAxtXodVLYKnznuYCb5RdscMuavRsWuRynboZnfwspMbjUsYzGWwCQ+x78A8J9t1QfiPGFPAOBUIgsKjofqvnByAOfedwsBb0ynqblp3YoTqMI4FnuWkyE4XUpa7acDE+usO0Bzs0iL5C/niTmDilvG3k5XD2B4bP82dcYWRqBpwCT9kbpGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":620,"cache_read_input_tokens":93633,"cache_creation":{"ephemeral_5m_input_tokens":620,"ephemeral_1h_input_tokens":0},"output_tokens":6,"service_tier":"standard"}},"requestId":"req_011CWz6VhRpjPTcAJfjE2cGD","type":"assistant","uuid":"fab8aef1-05b4-4866-ad7d-e92c18e27380","timestamp":"2026-01-10T17:31:15.615Z"}
{"parentUuid":"fab8aef1-05b4-4866-ad7d-e92c18e27380","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","message":{"model":"claude-opus-4-5-20251101","id":"msg_01BtJuL3Xj2Av8TZExXpkcfg","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01XX9vV6Y89ss6dRK8pyMuxJ","name":"Edit","input":{"replace_all":false,"file_path":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend/src/components/studio/studio-panel.tsx","old_string":"  const [expandedSection, setExpandedSection] = useState<string | null>('audio')\n  const [configDialogOpen, setConfigDialogOpen] = useState(false)\n  const [configDialogType, setConfigDialogType] = useState<GenerationType>('flashcards')","new_string":"  const [expandedSection, setExpandedSection] = useState<string | null>('audio')\n  const [configDialogOpen, setConfigDialogOpen] = useState(false)\n  const [configDialogType, setConfigDialogType] = useState<GenerationType>('flashcards')\n  const [exportOptions, setExportOptions] = useState<ExportOptionsState>({\n    includeSources: true,\n    includeChats: true,\n    includeNotes: true,\n    includeGenerated: true,\n  })"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":620,"cache_read_input_tokens":93633,"cache_creation":{"ephemeral_5m_input_tokens":620,"ephemeral_1h_input_tokens":0},"output_tokens":370,"service_tier":"standard"}},"requestId":"req_011CWz6VhRpjPTcAJfjE2cGD","type":"assistant","uuid":"78a61065-fcad-4389-8c6b-4ab3cf9e49a7","timestamp":"2026-01-10T17:31:17.708Z"}
{"parentUuid":"78a61065-fcad-4389-8c6b-4ab3cf9e49a7","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01XX9vV6Y89ss6dRK8pyMuxJ","type":"tool_result","content":"The file /Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend/src/components/studio/studio-panel.tsx has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n   197→  onOpenResearch,\n   198→  onExportNotebook,\n   199→  exportingNotebook = false,\n   200→}: StudioPanelProps) {\n   201→  const [expandedSection, setExpandedSection] = useState<string | null>('audio')\n   202→  const [configDialogOpen, setConfigDialogOpen] = useState(false)\n   203→  const [configDialogType, setConfigDialogType] = useState<GenerationType>('flashcards')\n   204→  const [exportOptions, setExportOptions] = useState<ExportOptionsState>({\n   205→    includeSources: true,\n   206→    includeChats: true,\n   207→    includeNotes: true,\n   208→    includeGenerated: true,\n   209→  })\n   210→\n   211→  // Open config dialog for a specific type\n   212→  const openConfigDialog = (type: GenerationType) => {\n   213→    setConfigDialogType(type)"}]},"uuid":"b0cceaf8-ccf9-47dc-b057-92cfa43f9012","timestamp":"2026-01-10T17:31:17.753Z","toolUseResult":{"filePath":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend/src/components/studio/studio-panel.tsx","oldString":"  const [expandedSection, setExpandedSection] = useState<string | null>('audio')\n  const [configDialogOpen, setConfigDialogOpen] = useState(false)\n  const [configDialogType, setConfigDialogType] = useState<GenerationType>('flashcards')","newString":"  const [expandedSection, setExpandedSection] = useState<string | null>('audio')\n  const [configDialogOpen, setConfigDialogOpen] = useState(false)\n  const [configDialogType, setConfigDialogType] = useState<GenerationType>('flashcards')\n  const [exportOptions, setExportOptions] = useState<ExportOptionsState>({\n    includeSources: true,\n    includeChats: true,\n    includeNotes: true,\n    includeGenerated: true,\n  })","originalFile":"'use client'\n\nimport { useState } from 'react'\nimport { motion, AnimatePresence } from 'framer-motion'\nimport {\n  Microphone,\n  VideoCamera,\n  MagnifyingGlass,\n  GraduationCap,\n  CaretDown,\n  CaretRight,\n  Play,\n  SpinnerGap,\n  BookOpen,\n  ListChecks,\n  FileText,\n  Question,\n  Note,\n  Plus,\n  ShareNetwork,\n  ArrowsClockwise,\n  Clock,\n  WarningCircle,\n  Table,\n  ChartBar,\n  PresentationChart,\n  Image,\n  Palette,\n  Cards,\n  TreeStructure,\n  ChatCircleText,\n  Sparkle,\n  Export,\n  FilePdf,\n  FileZip,\n  FileJs,\n  CheckSquare\n} from '@phosphor-icons/react'\nimport { Button } from '@/components/ui/button'\nimport { Input } from '@/components/ui/input'\nimport { Textarea } from '@/components/ui/textarea'\nimport { Badge } from '@/components/ui/badge'\nimport { ScrollArea } from '@/components/ui/scroll-area'\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select'\nimport { Tooltip, TooltipContent, TooltipTrigger } from '@/components/ui/tooltip'\nimport { GenerationConfigDialog, GenerationType, GenerationConfig } from './generation-config-dialog'\n\n// Metadata for a generated study material\nexport interface StudyMaterialMeta {\n  id: string\n  type: string\n  sourceIds: string[]\n  sourceNames: string[]\n  createdAt: string\n  itemCount?: number\n}\n\n// Helper to format relative time\nfunction getTimeAgo(dateString: string): string {\n  const date = new Date(dateString)\n  const now = new Date()\n  const diffMs = now.getTime() - date.getTime()\n  const diffMins = Math.floor(diffMs / 60000)\n  const diffHours = Math.floor(diffMs / 3600000)\n  const diffDays = Math.floor(diffMs / 86400000)\n\n  if (diffMins < 1) return 'Just now'\n  if (diffMins < 60) return `${diffMins}m ago`\n  if (diffHours < 24) return `${diffHours}h ago`\n  if (diffDays < 7) return `${diffDays}d ago`\n  return date.toLocaleDateString()\n}\n\n// Source type for selection\nexport interface SourceInfo {\n  id: string\n  name: string\n}\n\ninterface StudioPanelProps {\n  notebookId: string\n  selectedSourcesCount: number\n  selectedSourceIds: string[]\n  sources?: SourceInfo[]\n  // Audio\n  audioFormat: string\n  onAudioFormatChange: (format: string) => void\n  audioInstructions: string\n  onAudioInstructionsChange: (instructions: string) => void\n  onGenerateAudio: () => void\n  generatingAudio: boolean\n  // Video\n  videoStyle: string\n  onVideoStyleChange: (style: string) => void\n  onGenerateVideo: () => void\n  generatingVideo: boolean\n  // Research\n  researchQuery: string\n  onResearchQueryChange: (query: string) => void\n  researchMode: string\n  onResearchModeChange: (mode: string) => void\n  onRunResearch: () => void\n  researching: boolean\n  // Study - now accepts config\n  onGenerateStudyMaterial: (config: GenerationConfig) => void\n  generatingFlashcards: boolean\n  generatingQuiz: boolean\n  generatingStudyGuide: boolean\n  generatingFaq: boolean\n  generatingMindMap: boolean\n  // Creative Outputs - now accepts config\n  onGenerateCreativeOutput?: (config: GenerationConfig) => void\n  generatingDataTable?: boolean\n  generatingReport?: boolean\n  generatingSlideDeck?: boolean\n  generatingInfographic?: boolean\n  // Creative outputs results\n  creativeOutputs?: Array<{\n    id: string\n    type: string\n    title: string\n    status: string\n    createdAt: string\n  }>\n  onOpenCreativeOutput?: (type: string) => void\n  // Results - now with metadata\n  studyMaterials?: StudyMaterialMeta[]\n  onOpenStudyMaterial?: (type: string) => void\n  // Notes\n  notesCount?: number\n  onAddNote?: () => void\n  onOpenNotes?: () => void\n  // Generated content\n  hasGeneratedAudio?: boolean\n  hasGeneratedVideo?: boolean\n  hasGeneratedResearch?: boolean\n  onOpenAudio?: () => void\n  onOpenVideo?: () => void\n  onOpenResearch?: () => void\n  // Export\n  onExportNotebook?: (format: 'zip' | 'pdf' | 'json', options: ExportOptionsState) => void\n  exportingNotebook?: boolean\n}\n\n// Export options state type\nexport interface ExportOptionsState {\n  includeSources: boolean\n  includeChats: boolean\n  includeNotes: boolean\n  includeGenerated: boolean\n}\n\nexport function StudioPanel({\n  notebookId,\n  selectedSourcesCount,\n  selectedSourceIds,\n  sources = [],\n  audioFormat,\n  onAudioFormatChange,\n  audioInstructions,\n  onAudioInstructionsChange,\n  onGenerateAudio,\n  generatingAudio,\n  videoStyle,\n  onVideoStyleChange,\n  onGenerateVideo,\n  generatingVideo,\n  researchQuery,\n  onResearchQueryChange,\n  researchMode,\n  onResearchModeChange,\n  onRunResearch,\n  researching,\n  onGenerateStudyMaterial,\n  generatingFlashcards,\n  generatingQuiz,\n  generatingStudyGuide,\n  generatingFaq,\n  generatingMindMap,\n  onGenerateCreativeOutput,\n  generatingDataTable = false,\n  generatingReport = false,\n  generatingSlideDeck = false,\n  generatingInfographic = false,\n  creativeOutputs = [],\n  onOpenCreativeOutput,\n  studyMaterials = [],\n  onOpenStudyMaterial,\n  notesCount = 0,\n  onAddNote,\n  onOpenNotes,\n  hasGeneratedAudio = false,\n  hasGeneratedVideo = false,\n  hasGeneratedResearch = false,\n  onOpenAudio,\n  onOpenVideo,\n  onOpenResearch,\n  onExportNotebook,\n  exportingNotebook = false,\n}: StudioPanelProps) {\n  const [expandedSection, setExpandedSection] = useState<string | null>('audio')\n  const [configDialogOpen, setConfigDialogOpen] = useState(false)\n  const [configDialogType, setConfigDialogType] = useState<GenerationType>('flashcards')\n\n  // Open config dialog for a specific type\n  const openConfigDialog = (type: GenerationType) => {\n    setConfigDialogType(type)\n    setConfigDialogOpen(true)\n  }\n\n  // Handle generation from config dialog\n  const handleGenerate = (config: GenerationConfig) => {\n    setConfigDialogOpen(false)\n\n    // Route to appropriate handler based on type\n    const studyTypes = ['flashcards', 'quiz', 'study-guide', 'faq', 'mind-map']\n    if (studyTypes.includes(config.type)) {\n      onGenerateStudyMaterial(config)\n    } else {\n      onGenerateCreativeOutput?.(config)\n    }\n  }\n\n  // Check if currently generating for a type\n  const isGenerating = (type: GenerationType): boolean => {\n    switch (type) {\n      case 'flashcards': return generatingFlashcards\n      case 'quiz': return generatingQuiz\n      case 'study-guide': return generatingStudyGuide\n      case 'faq': return generatingFaq\n      case 'mind-map': return generatingMindMap\n      case 'data_table': return generatingDataTable\n      case 'report': return generatingReport\n      case 'slide_deck': return generatingSlideDeck\n      case 'infographic': return generatingInfographic\n      default: return false\n    }\n  }\n\n  const toggleSection = (section: string) => {\n    setExpandedSection(expandedSection === section ? null : section)\n  }\n\n  // Check if a material's sources match current selection\n  const isMaterialStale = (material: StudyMaterialMeta) => {\n    const sortedMaterialIds = [...material.sourceIds].sort()\n    const sortedSelectedIds = [...selectedSourceIds].sort()\n    if (sortedMaterialIds.length !== sortedSelectedIds.length) return true\n    return !sortedMaterialIds.every((id, idx) => id === sortedSelectedIds[idx])\n  }\n\n  // Format relative time\n  const formatTimeAgo = (dateStr: string) => {\n    const date = new Date(dateStr)\n    const now = new Date()\n    const diffMs = now.getTime() - date.getTime()\n    const diffMins = Math.floor(diffMs / 60000)\n    const diffHours = Math.floor(diffMins / 60)\n    const diffDays = Math.floor(diffHours / 24)\n\n    if (diffMins < 1) return 'Just now'\n    if (diffMins < 60) return `${diffMins}m ago`\n    if (diffHours < 24) return `${diffHours}h ago`\n    if (diffDays < 7) return `${diffDays}d ago`\n    return date.toLocaleDateString()\n  }\n\n  // Get material by type\n  const getMaterial = (type: string) => studyMaterials.find(m => m.type === type)\n\n  return (\n    <ScrollArea className=\"h-full\">\n      <div className=\"p-4 space-y-3\">\n        {/* Audio Overview Section */}\n        <StudioSection\n          id=\"audio\"\n          title=\"Audio Overview\"\n          subtitle=\"Podcast-style discussion\"\n          icon={<Microphone className=\"h-5 w-5\" weight=\"duotone\" />}\n          iconGradient=\"from-orange-500/20 to-red-500/20\"\n          iconColor=\"text-orange-500\"\n          expanded={expandedSection === 'audio'}\n          onToggle={() => toggleSection('audio')}\n        >\n          <div className=\"space-y-3\">\n            <div className=\"space-y-1.5\">\n              <label className=\"text-xs font-medium text-[var(--text-primary)]\">Format</label>\n              <Select value={audioFormat} onValueChange={onAudioFormatChange}>\n                <SelectTrigger className=\"h-9 text-sm bg-[var(--bg-tertiary)] border-[rgba(255,255,255,0.1)] rounded-lg\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent className=\"bg-[var(--bg-secondary)] border-[rgba(255,255,255,0.1)]\">\n                  <SelectItem value=\"deep_dive\">Deep Dive (10-15 min)</SelectItem>\n                  <SelectItem value=\"brief\">Brief Summary (2-3 min)</SelectItem>\n                  <SelectItem value=\"critique\">Analytical (5-10 min)</SelectItem>\n                  <SelectItem value=\"debate\">Debate (8-15 min)</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n            <div className=\"space-y-1.5\">\n              <label className=\"text-xs font-medium text-[var(--text-primary)]\">Custom Instructions</label>\n              <Textarea\n                placeholder=\"Optional instructions for hosts...\"\n                value={audioInstructions}\n                onChange={(e) => onAudioInstructionsChange(e.target.value)}\n                rows={2}\n                className=\"text-sm resize-none bg-[var(--bg-tertiary)] border-[rgba(255,255,255,0.1)] text-[var(--text-primary)] placeholder:text-[var(--text-tertiary)] focus:border-[var(--accent-primary)] rounded-lg\"\n              />\n            </div>\n            <div className=\"flex gap-2\">\n              <Button\n                className=\"flex-1 rounded-lg bg-orange-500 hover:bg-orange-500/90 text-white\"\n                onClick={onGenerateAudio}\n                disabled={generatingAudio || selectedSourcesCount === 0}\n              >\n                {generatingAudio ? (\n                  <SpinnerGap className=\"h-4 w-4 mr-2 animate-spin\" weight=\"bold\" />\n                ) : (\n                  <Play className=\"h-4 w-4 mr-2\" />\n                )}\n                Generate\n              </Button>\n              {hasGeneratedAudio && onOpenAudio && (\n                <Button\n                  variant=\"outline\"\n                  className=\"rounded-lg border-orange-500/30 text-orange-500 hover:bg-orange-500/10\"\n                  onClick={onOpenAudio}\n                >\n                  View\n                  <CaretRight className=\"h-4 w-4 ml-1\" weight=\"bold\" />\n                </Button>\n              )}\n            </div>\n            {selectedSourcesCount === 0 && (\n              <p className=\"text-xs text-[var(--text-tertiary)] text-center\">\n                Select sources to generate\n              </p>\n            )}\n          </div>\n        </StudioSection>\n\n        {/* Video Overview Section */}\n        <StudioSection\n          id=\"video\"\n          title=\"Video Overview\"\n          subtitle=\"AI-generated video clip\"\n          icon={<VideoCamera className=\"h-5 w-5\" weight=\"duotone\" />}\n          iconGradient=\"from-purple-500/20 to-pink-500/20\"\n          iconColor=\"text-purple-500\"\n          expanded={expandedSection === 'video'}\n          onToggle={() => toggleSection('video')}\n        >\n          <div className=\"space-y-3\">\n            <div className=\"space-y-1.5\">\n              <label className=\"text-xs font-medium text-[var(--text-primary)]\">Style</label>\n              <Select value={videoStyle} onValueChange={onVideoStyleChange}>\n                <SelectTrigger className=\"h-9 text-sm bg-[var(--bg-tertiary)] border-[rgba(255,255,255,0.1)] rounded-lg\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent className=\"bg-[var(--bg-secondary)] border-[rgba(255,255,255,0.1)]\">\n                  <SelectItem value=\"explainer\">Explainer (5s)</SelectItem>\n                  <SelectItem value=\"documentary\">Documentary (10s)</SelectItem>\n                  <SelectItem value=\"presentation\">Presentation (5s)</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n            <p className=\"text-xs text-[var(--text-tertiary)]\">\n              Generates an AI video clip using Wan 2.5. Estimated cost: ~$0.10-0.20\n            </p>\n            <div className=\"flex gap-2\">\n              <Button\n                className=\"flex-1 rounded-lg bg-purple-500 hover:bg-purple-500/90 text-white\"\n                onClick={onGenerateVideo}\n                disabled={generatingVideo || selectedSourcesCount === 0}\n              >\n                {generatingVideo ? (\n                  <SpinnerGap className=\"h-4 w-4 mr-2 animate-spin\" weight=\"bold\" />\n                ) : (\n                  <VideoCamera className=\"h-4 w-4 mr-2\" weight=\"duotone\" />\n                )}\n                {generatingVideo ? 'Generating...' : 'Generate Video'}\n              </Button>\n              {hasGeneratedVideo && onOpenVideo && (\n                <Button\n                  variant=\"outline\"\n                  className=\"rounded-lg border-purple-500/30 text-purple-500 hover:bg-purple-500/10\"\n                  onClick={onOpenVideo}\n                >\n                  View\n                  <CaretRight className=\"h-4 w-4 ml-1\" weight=\"bold\" />\n                </Button>\n              )}\n            </div>\n            {selectedSourcesCount === 0 && (\n              <p className=\"text-xs text-[var(--text-tertiary)] text-center\">\n                Select sources to generate\n              </p>\n            )}\n          </div>\n        </StudioSection>\n\n        {/* Deep Research Section */}\n        <StudioSection\n          id=\"research\"\n          title=\"Deep Research\"\n          subtitle=\"Autonomous web research\"\n          icon={<MagnifyingGlass className=\"h-5 w-5\" weight=\"duotone\" />}\n          iconGradient=\"from-blue-500/20 to-cyan-500/20\"\n          iconColor=\"text-blue-500\"\n          expanded={expandedSection === 'research'}\n          onToggle={() => toggleSection('research')}\n        >\n          <div className=\"space-y-3\">\n            <div className=\"space-y-1.5\">\n              <label className=\"text-xs font-medium text-[var(--text-primary)]\">Research Query</label>\n              <Input\n                placeholder=\"What would you like to research?\"\n                value={researchQuery}\n                onChange={(e) => onResearchQueryChange(e.target.value)}\n                className=\"h-9 text-sm bg-[var(--bg-tertiary)] border-[rgba(255,255,255,0.1)] text-[var(--text-primary)] placeholder:text-[var(--text-tertiary)] focus:border-[var(--accent-primary)] rounded-lg\"\n              />\n            </div>\n            <div className=\"space-y-1.5\">\n              <label className=\"text-xs font-medium text-[var(--text-primary)]\">Mode</label>\n              <Select value={researchMode} onValueChange={onResearchModeChange}>\n                <SelectTrigger className=\"h-9 text-sm bg-[var(--bg-tertiary)] border-[rgba(255,255,255,0.1)] rounded-lg\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent className=\"bg-[var(--bg-secondary)] border-[rgba(255,255,255,0.1)]\">\n                  <SelectItem value=\"fast\">Fast (3-5 min)</SelectItem>\n                  <SelectItem value=\"deep\">Deep (10-15 min)</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n            <div className=\"flex gap-2\">\n              <Button\n                className=\"flex-1 rounded-lg bg-blue-500 hover:bg-blue-500/90 text-white\"\n                onClick={onRunResearch}\n                disabled={researching || !researchQuery.trim()}\n              >\n                {researching ? (\n                  <SpinnerGap className=\"h-4 w-4 mr-2 animate-spin\" weight=\"bold\" />\n                ) : (\n                  <MagnifyingGlass className=\"h-4 w-4 mr-2\" weight=\"duotone\" />\n                )}\n                Research\n              </Button>\n              {hasGeneratedResearch && onOpenResearch && (\n                <Button\n                  variant=\"outline\"\n                  className=\"rounded-lg border-blue-500/30 text-blue-500 hover:bg-blue-500/10\"\n                  onClick={onOpenResearch}\n                >\n                  View\n                  <CaretRight className=\"h-4 w-4 ml-1\" weight=\"bold\" />\n                </Button>\n              )}\n            </div>\n          </div>\n        </StudioSection>\n\n        {/* Study Materials Section */}\n        <StudioSection\n          id=\"study\"\n          title=\"Study Materials\"\n          subtitle=\"Flashcards, quizzes, and more\"\n          icon={<GraduationCap className=\"h-5 w-5\" />}\n          iconGradient=\"from-emerald-500/20 to-teal-500/20\"\n          iconColor=\"text-emerald-500\"\n          expanded={expandedSection === 'study'}\n          onToggle={() => toggleSection('study')}\n        >\n          <div className=\"space-y-4\">\n            {/* Study Tools Grid */}\n            <div className=\"grid grid-cols-2 gap-2\">\n              <StudyToolButton\n                icon={<BookOpen className=\"h-5 w-5\" />}\n                label=\"Flashcards\"\n                color=\"text-blue-500\"\n                onClick={() => openConfigDialog('flashcards')}\n                loading={generatingFlashcards}\n                disabled={selectedSourcesCount === 0}\n              />\n              <StudyToolButton\n                icon={<ListChecks className=\"h-5 w-5\" />}\n                label=\"Quiz\"\n                color=\"text-purple-500\"\n                onClick={() => openConfigDialog('quiz')}\n                loading={generatingQuiz}\n                disabled={selectedSourcesCount === 0}\n              />\n              <StudyToolButton\n                icon={<FileText className=\"h-5 w-5\" />}\n                label=\"Study Guide\"\n                color=\"text-orange-500\"\n                onClick={() => openConfigDialog('study-guide')}\n                loading={generatingStudyGuide}\n                disabled={selectedSourcesCount === 0}\n              />\n              <StudyToolButton\n                icon={<Question className=\"h-5 w-5\" weight=\"duotone\" />}\n                label=\"FAQ\"\n                color=\"text-teal-500\"\n                onClick={() => openConfigDialog('faq')}\n                loading={generatingFaq}\n                disabled={selectedSourcesCount === 0}\n              />\n              <StudyToolButton\n                icon={<TreeStructure className=\"h-5 w-5\" weight=\"duotone\" />}\n                label=\"Mind Map\"\n                color=\"text-cyan-500\"\n                onClick={() => openConfigDialog('mind-map')}\n                loading={generatingMindMap}\n                disabled={selectedSourcesCount === 0}\n              />\n            </div>\n\n            {selectedSourcesCount === 0 && (\n              <p className=\"text-xs text-[var(--text-tertiary)] text-center\">\n                Select sources to generate study materials\n              </p>\n            )}\n\n            {/* Generated Materials */}\n            {studyMaterials.length > 0 && (\n              <div className=\"pt-3 border-t border-[rgba(255,255,255,0.1)]\">\n                <p className=\"text-xs font-medium text-[var(--text-tertiary)] mb-2\">Generated Materials</p>\n                <div className=\"space-y-2\">\n                  {studyMaterials.map((material) => {\n                    const isStale = isMaterialStale(material)\n                    const iconMap: Record<string, { icon: React.ReactNode; color: string; label: string }> = {\n                      flashcards: { icon: <BookOpen className=\"h-4 w-4\" />, color: 'text-blue-500', label: `${material.itemCount || 0} Flashcards` },\n                      quiz: { icon: <ListChecks className=\"h-4 w-4\" />, color: 'text-purple-500', label: `${material.itemCount || 0} Quiz Questions` },\n                      study_guide: { icon: <FileText className=\"h-4 w-4\" />, color: 'text-orange-500', label: 'Study Guide' },\n                      faq: { icon: <ChatCircleText className=\"h-4 w-4\" weight=\"duotone\" />, color: 'text-teal-500', label: `${material.itemCount || 0} FAQ Items` },\n                      mind_map: { icon: <TreeStructure className=\"h-4 w-4\" weight=\"duotone\" />, color: 'text-cyan-500', label: 'Mind Map' },\n                    }\n                    const info = iconMap[material.type] || { icon: <FileText className=\"h-4 w-4\" />, color: 'text-gray-500', label: material.type }\n\n                    return (\n                      <div\n                        key={material.id}\n                        className={`rounded-lg border ${isStale ? 'border-amber-500/30 bg-amber-500/5' : 'border-[rgba(255,255,255,0.1)]'} overflow-hidden`}\n                      >\n                        <button\n                          onClick={() => onOpenStudyMaterial?.(material.type)}\n                          className=\"w-full flex items-center gap-2 px-3 py-2 text-sm hover:bg-[var(--bg-tertiary)] transition-colors\"\n                        >\n                          <span className={info.color}>{info.icon}</span>\n                          <span className=\"text-[var(--text-primary)] flex-1 text-left\">{info.label}</span>\n                          {isStale && (\n                            <Tooltip>\n                              <TooltipTrigger asChild>\n                                <WarningCircle className=\"h-3.5 w-3.5 text-amber-500\" weight=\"fill\" />\n                              </TooltipTrigger>\n                              <TooltipContent>\n                                <p>Sources changed - regenerate for updated content</p>\n                              </TooltipContent>\n                            </Tooltip>\n                          )}\n                          <CaretRight className=\"h-4 w-4 text-[var(--text-tertiary)]\" weight=\"bold\" />\n                        </button>\n                        <div className=\"px-3 py-1.5 bg-[var(--bg-tertiary)]/50 border-t border-[rgba(255,255,255,0.05)] flex items-center gap-3 text-[10px] text-[var(--text-tertiary)]\">\n                          <span className=\"flex items-center gap-1\">\n                            <Clock className=\"h-3 w-3\" />\n                            {formatTimeAgo(material.createdAt)}\n                          </span>\n                          <span>•</span>\n                          <span className=\"truncate\">\n                            {material.sourceNames.length === 1\n                              ? material.sourceNames[0]\n                              : `${material.sourceNames.length} sources`}\n                          </span>\n                        </div>\n                      </div>\n                    )\n                  })}\n                </div>\n              </div>\n            )}\n          </div>\n        </StudioSection>\n\n        {/* Creative Outputs Section */}\n        <StudioSection\n          id=\"creative\"\n          title=\"Creative Outputs\"\n          subtitle=\"Tables, reports, slides, infographics\"\n          icon={<Palette className=\"h-5 w-5\" />}\n          iconGradient=\"from-pink-500/20 to-rose-500/20\"\n          iconColor=\"text-pink-500\"\n          expanded={expandedSection === 'creative'}\n          onToggle={() => toggleSection('creative')}\n        >\n          <div className=\"space-y-4\">\n            {/* Creative Tools Grid */}\n            <div className=\"grid grid-cols-2 gap-2\">\n              <StudyToolButton\n                icon={<Table className=\"h-5 w-5\" />}\n                label=\"Data Table\"\n                color=\"text-emerald-500\"\n                onClick={() => openConfigDialog('data_table')}\n                loading={generatingDataTable}\n                disabled={selectedSourcesCount === 0}\n              />\n              <StudyToolButton\n                icon={<Palette className=\"h-5 w-5\" weight=\"duotone\" />}\n                label=\"Report\"\n                color=\"text-blue-500\"\n                onClick={() => openConfigDialog('report')}\n                loading={generatingReport}\n                disabled={selectedSourcesCount === 0}\n              />\n              <StudyToolButton\n                icon={<PresentationChart className=\"h-5 w-5\" />}\n                label=\"Slide Deck\"\n                color=\"text-violet-500\"\n                onClick={() => openConfigDialog('slide_deck')}\n                loading={generatingSlideDeck}\n                disabled={selectedSourcesCount === 0}\n              />\n              <StudyToolButton\n                icon={<Image className=\"h-5 w-5\" />}\n                label=\"Infographic\"\n                color=\"text-rose-500\"\n                onClick={() => openConfigDialog('infographic')}\n                loading={generatingInfographic}\n                disabled={selectedSourcesCount === 0}\n              />\n            </div>\n\n            {selectedSourcesCount === 0 && (\n              <p className=\"text-xs text-[var(--text-tertiary)] text-center\">\n                Select sources to generate creative outputs\n              </p>\n            )}\n\n            {/* Generated Outputs */}\n            {creativeOutputs.length > 0 && (\n              <div className=\"mt-4 pt-4 border-t border-[rgba(255,255,255,0.1)]\">\n                <p className=\"text-xs font-medium text-[var(--text-tertiary)] mb-3\">Generated Outputs</p>\n                <div className=\"space-y-2\">\n                  {creativeOutputs.map((output) => {\n                    const typeConfig: Record<string, { icon: React.ReactNode; label: string; color: string }> = {\n                      data_table: { icon: <Table className=\"h-4 w-4\" />, label: 'Data Table', color: 'text-emerald-500' },\n                      report: { icon: <ChartBar className=\"h-4 w-4\" weight=\"duotone\" />, label: 'Report', color: 'text-blue-500' },\n                      slide_deck: { icon: <PresentationChart className=\"h-4 w-4\" />, label: 'Slide Deck', color: 'text-violet-500' },\n                      infographic: { icon: <Image className=\"h-4 w-4\" />, label: 'Infographic', color: 'text-rose-500' },\n                    }\n                    const config = typeConfig[output.type] || { icon: <FileText className=\"h-4 w-4\" />, label: output.type, color: 'text-gray-500' }\n                    const timeAgo = getTimeAgo(output.createdAt)\n\n                    return (\n                      <button\n                        key={output.id}\n                        onClick={() => onOpenCreativeOutput?.(output.type)}\n                        className=\"w-full flex items-center gap-3 p-3 rounded-xl bg-[var(--bg-tertiary)] hover:bg-[var(--bg-tertiary)]/80 transition-colors text-left\"\n                      >\n                        <div className={`${config.color}`}>{config.icon}</div>\n                        <div className=\"flex-1 min-w-0\">\n                          <p className=\"text-sm font-medium text-[var(--text-primary)] truncate\">{config.label}</p>\n                          <p className=\"text-xs text-[var(--text-tertiary)]\">{timeAgo}</p>\n                        </div>\n                        <CaretRight className=\"h-4 w-4 text-[var(--text-tertiary)]\" weight=\"bold\" />\n                      </button>\n                    )\n                  })}\n                </div>\n              </div>\n            )}\n          </div>\n        </StudioSection>\n\n        {/* Notes Section */}\n        <StudioSection\n          id=\"notes\"\n          title=\"Notes\"\n          subtitle={`${notesCount} saved`}\n          icon={<Note className=\"h-5 w-5\" weight=\"duotone\" />}\n          iconGradient=\"from-amber-500/20 to-yellow-500/20\"\n          iconColor=\"text-amber-500\"\n          expanded={expandedSection === 'notes'}\n          onToggle={() => toggleSection('notes')}\n          action={\n            <Button\n              size=\"sm\"\n              variant=\"ghost\"\n              className=\"h-7 w-7 p-0\"\n              onClick={(e) => {\n                e.stopPropagation()\n                onAddNote?.()\n              }}\n            >\n              <Plus className=\"h-3.5 w-3.5\" />\n            </Button>\n          }\n        >\n          <div className=\"space-y-3\">\n            {notesCount === 0 ? (\n              <div className=\"text-center py-6\">\n                <Note className=\"h-8 w-8 mx-auto mb-2 text-[var(--text-tertiary)]/50\" weight=\"duotone\" />\n                <p className=\"text-sm text-[var(--text-tertiary)]\">No notes yet</p>\n                <p className=\"text-xs text-[var(--text-tertiary)] mt-1\">Create notes or save chat responses</p>\n              </div>\n            ) : (\n              <Button\n                variant=\"outline\"\n                className=\"w-full justify-start rounded-lg border-[rgba(255,255,255,0.1)] text-[var(--text-primary)] hover:bg-[var(--bg-tertiary)]\"\n                onClick={onOpenNotes}\n              >\n                <Note className=\"h-4 w-4 mr-2 text-amber-500\" weight=\"duotone\" />\n                View All Notes ({notesCount})\n                <CaretRight className=\"h-4 w-4 ml-auto text-[var(--text-tertiary)]\" weight=\"bold\" />\n              </Button>\n            )}\n          </div>\n        </StudioSection>\n      </div>\n\n      {/* Generation Config Dialog */}\n      <GenerationConfigDialog\n        open={configDialogOpen}\n        onOpenChange={setConfigDialogOpen}\n        type={configDialogType}\n        sources={sources}\n        onGenerate={handleGenerate}\n        isGenerating={isGenerating(configDialogType)}\n      />\n    </ScrollArea>\n  )\n}\n\n// Studio Section Component\nfunction StudioSection({\n  id,\n  title,\n  subtitle,\n  icon,\n  iconGradient,\n  iconColor,\n  expanded,\n  onToggle,\n  action,\n  children,\n}: {\n  id: string\n  title: string\n  subtitle: string\n  icon: React.ReactNode\n  iconGradient: string\n  iconColor: string\n  expanded: boolean\n  onToggle: () => void\n  action?: React.ReactNode\n  children: React.ReactNode\n}) {\n  return (\n    <div className=\"glass-card rounded-2xl overflow-hidden\">\n      <div className=\"flex items-center justify-between p-4 hover:bg-white/[0.02] transition-all duration-200 group\">\n        <button\n          onClick={onToggle}\n          className=\"flex items-center gap-3 flex-1\"\n        >\n          <div className={`relative w-10 h-10 rounded-xl bg-gradient-to-br ${iconGradient} flex items-center justify-center shadow-lg`}>\n            <div className=\"absolute inset-0 rounded-xl bg-gradient-to-br from-white/10 to-transparent\" />\n            <span className={`relative z-10 ${iconColor}`}>{icon}</span>\n          </div>\n          <div className=\"text-left\">\n            <p className=\"font-medium text-sm text-[var(--text-primary)] group-hover:text-white transition-colors\">{title}</p>\n            <p className=\"text-xs text-[var(--text-tertiary)]\">{subtitle}</p>\n          </div>\n        </button>\n        <div className=\"flex items-center gap-2\">\n          {action}\n          <button onClick={onToggle} className=\"p-1.5 rounded-lg hover:bg-white/5 transition-colors\">\n            <CaretDown weight=\"bold\" className={`h-4 w-4 text-[var(--text-tertiary)] transition-transform duration-200 ${expanded ? 'rotate-180' : ''}`} />\n          </button>\n        </div>\n      </div>\n\n      <AnimatePresence>\n        {expanded && (\n          <motion.div\n            initial={{ height: 0, opacity: 0 }}\n            animate={{ height: 'auto', opacity: 1 }}\n            exit={{ height: 0, opacity: 0 }}\n            transition={{ duration: 0.2 }}\n            className=\"overflow-hidden\"\n          >\n            <div className=\"px-4 pb-4 pt-2 border-t border-[rgba(255,255,255,0.1)] bg-[var(--bg-tertiary)]/30\">\n              {children}\n            </div>\n          </motion.div>\n        )}\n      </AnimatePresence>\n    </div>\n  )\n}\n\n// Study Tool Button\nfunction StudyToolButton({\n  icon,\n  label,\n  color,\n  onClick,\n  loading,\n  disabled,\n}: {\n  icon: React.ReactNode\n  label: string\n  color: string\n  onClick: () => void\n  loading: boolean\n  disabled: boolean\n}) {\n  return (\n    <button\n      onClick={onClick}\n      disabled={disabled || loading}\n      className=\"flex flex-col items-center gap-2 p-4 rounded-xl border border-[rgba(255,255,255,0.1)] bg-[var(--bg-secondary)] hover:bg-[var(--bg-tertiary)]/50 transition-colors disabled:opacity-50 disabled:cursor-not-allowed\"\n    >\n      {loading ? (\n        <SpinnerGap className=\"h-5 w-5 animate-spin text-[var(--text-tertiary)]\" weight=\"bold\" />\n      ) : (\n        <span className={color}>{icon}</span>\n      )}\n      <span className=\"text-xs font-medium text-[var(--text-primary)]\">{label}</span>\n    </button>\n  )\n}\n\n// Material Button\nfunction MaterialButton({\n  icon,\n  label,\n  onClick,\n}: {\n  icon: React.ReactNode\n  label: string\n  onClick?: () => void\n}) {\n  return (\n    <button\n      onClick={onClick}\n      className=\"w-full flex items-center gap-2 px-3 py-2 text-sm rounded-lg hover:bg-[var(--bg-tertiary)] transition-colors\"\n    >\n      {icon}\n      <span className=\"text-[var(--text-primary)]\">{label}</span>\n      <CaretRight className=\"h-4 w-4 ml-auto text-[var(--text-tertiary)]\" weight=\"bold\" />\n    </button>\n  )\n}\n","structuredPatch":[{"oldStart":201,"oldLines":6,"newStart":201,"newLines":12,"lines":["   const [expandedSection, setExpandedSection] = useState<string | null>('audio')","   const [configDialogOpen, setConfigDialogOpen] = useState(false)","   const [configDialogType, setConfigDialogType] = useState<GenerationType>('flashcards')","+  const [exportOptions, setExportOptions] = useState<ExportOptionsState>({","+    includeSources: true,","+    includeChats: true,","+    includeNotes: true,","+    includeGenerated: true,","+  })"," ","   // Open config dialog for a specific type","   const openConfigDialog = (type: GenerationType) => {"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"78a61065-fcad-4389-8c6b-4ab3cf9e49a7"}
{"parentUuid":"b0cceaf8-ccf9-47dc-b057-92cfa43f9012","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","message":{"model":"claude-opus-4-5-20251101","id":"msg_012wzjG5GCvDQAxboZqqEtCo","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Now I need to add the Export section after the Notes section. Let me find the Notes section and add the Export section after it.","signature":"EqkCCkYICxgCKkA7SOOasiV92/k8Znmibf2ii04f76She5v7aRWcLO8pa7cuNlJVt0MOMn9RSZs5FbLKiDn+xbQUwMx1GOJw3OdbEgyxlfvY+RsPx2Gspk4aDE5771GrC24r81/vPSIwL/zNCqXm0FwSTMi4qDi/P4UvBeA2D90F8fNYT/46YHp6CMLwtB4kAc3XrtRwHVrcKpABzcaDeItqGtRoEiMq88C2v8Ir7ZL5obb/nv+yIIhi6k1ATqBPjc/OAuDx1sTkzsYvDU3PUdzPD8Ybl2bHMWJ4hTvW5+dlWES5hbiJvCRK6ZR6P1s7zIx2xFXCwEtmWj03axOhQ/yH5a/Htpyl5CmejommKlKPMqCagJmVFZ7JWT4pD2Wtzo2NMXs2cG/qKn4qGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":699,"cache_read_input_tokens":94253,"cache_creation":{"ephemeral_5m_input_tokens":699,"ephemeral_1h_input_tokens":0},"output_tokens":8,"service_tier":"standard"}},"requestId":"req_011CWz6WFLxMuiqH232rhKTq","type":"assistant","uuid":"293d52ae-96ec-47b6-95ce-56127d5e8984","timestamp":"2026-01-10T17:31:22.611Z"}
{"parentUuid":"293d52ae-96ec-47b6-95ce-56127d5e8984","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","message":{"model":"claude-opus-4-5-20251101","id":"msg_012wzjG5GCvDQAxboZqqEtCo","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01KfqLri9cESN9V4yXh7a3wx","name":"Edit","input":{"replace_all":false,"file_path":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend/src/components/studio/studio-panel.tsx","old_string":"        {/* Notes Section */}\n        <StudioSection\n          id=\"notes\"\n          title=\"Notes\"\n          subtitle={`${notesCount} saved`}\n          icon={<Note className=\"h-5 w-5\" weight=\"duotone\" />}\n          iconGradient=\"from-amber-500/20 to-yellow-500/20\"\n          iconColor=\"text-amber-500\"\n          expanded={expandedSection === 'notes'}\n          onToggle={() => toggleSection('notes')}\n          action={\n            <Button\n              size=\"sm\"\n              variant=\"ghost\"\n              className=\"h-7 w-7 p-0\"\n              onClick={(e) => {\n                e.stopPropagation()\n                onAddNote?.()\n              }}\n            >\n              <Plus className=\"h-3.5 w-3.5\" />\n            </Button>\n          }\n        >\n          <div className=\"space-y-3\">\n            {notesCount === 0 ? (\n              <div className=\"text-center py-6\">\n                <Note className=\"h-8 w-8 mx-auto mb-2 text-[var(--text-tertiary)]/50\" weight=\"duotone\" />\n                <p className=\"text-sm text-[var(--text-tertiary)]\">No notes yet</p>\n                <p className=\"text-xs text-[var(--text-tertiary)] mt-1\">Create notes or save chat responses</p>\n              </div>\n            ) : (\n              <Button\n                variant=\"outline\"\n                className=\"w-full justify-start rounded-lg border-[rgba(255,255,255,0.1)] text-[var(--text-primary)] hover:bg-[var(--bg-tertiary)]\"\n                onClick={onOpenNotes}\n              >\n                <Note className=\"h-4 w-4 mr-2 text-amber-500\" weight=\"duotone\" />\n                View All Notes ({notesCount})\n                <CaretRight className=\"h-4 w-4 ml-auto text-[var(--text-tertiary)]\" weight=\"bold\" />\n              </Button>\n            )}\n          </div>\n        </StudioSection>\n      </div>","new_string":"        {/* Notes Section */}\n        <StudioSection\n          id=\"notes\"\n          title=\"Notes\"\n          subtitle={`${notesCount} saved`}\n          icon={<Note className=\"h-5 w-5\" weight=\"duotone\" />}\n          iconGradient=\"from-amber-500/20 to-yellow-500/20\"\n          iconColor=\"text-amber-500\"\n          expanded={expandedSection === 'notes'}\n          onToggle={() => toggleSection('notes')}\n          action={\n            <Button\n              size=\"sm\"\n              variant=\"ghost\"\n              className=\"h-7 w-7 p-0\"\n              onClick={(e) => {\n                e.stopPropagation()\n                onAddNote?.()\n              }}\n            >\n              <Plus className=\"h-3.5 w-3.5\" />\n            </Button>\n          }\n        >\n          <div className=\"space-y-3\">\n            {notesCount === 0 ? (\n              <div className=\"text-center py-6\">\n                <Note className=\"h-8 w-8 mx-auto mb-2 text-[var(--text-tertiary)]/50\" weight=\"duotone\" />\n                <p className=\"text-sm text-[var(--text-tertiary)]\">No notes yet</p>\n                <p className=\"text-xs text-[var(--text-tertiary)] mt-1\">Create notes or save chat responses</p>\n              </div>\n            ) : (\n              <Button\n                variant=\"outline\"\n                className=\"w-full justify-start rounded-lg border-[rgba(255,255,255,0.1)] text-[var(--text-primary)] hover:bg-[var(--bg-tertiary)]\"\n                onClick={onOpenNotes}\n              >\n                <Note className=\"h-4 w-4 mr-2 text-amber-500\" weight=\"duotone\" />\n                View All Notes ({notesCount})\n                <CaretRight className=\"h-4 w-4 ml-auto text-[var(--text-tertiary)]\" weight=\"bold\" />\n              </Button>\n            )}\n          </div>\n        </StudioSection>\n\n        {/* Export Section */}\n        <StudioSection\n          id=\"export\"\n          title=\"Export Notebook\"\n          subtitle=\"Download all content\"\n          icon={<Export className=\"h-5 w-5\" weight=\"duotone\" />}\n          iconGradient=\"from-sky-500/20 to-indigo-500/20\"\n          iconColor=\"text-sky-500\"\n          expanded={expandedSection === 'export'}\n          onToggle={() => toggleSection('export')}\n        >\n          <div className=\"space-y-4\">\n            {/* Export Options */}\n            <div className=\"space-y-2\">\n              <p className=\"text-xs font-medium text-[var(--text-tertiary)]\">Include in export:</p>\n              <div className=\"grid grid-cols-2 gap-2\">\n                <ExportOptionToggle\n                  label=\"Sources\"\n                  checked={exportOptions.includeSources}\n                  onChange={(checked) => setExportOptions(prev => ({ ...prev, includeSources: checked }))}\n                />\n                <ExportOptionToggle\n                  label=\"Chats\"\n                  checked={exportOptions.includeChats}\n                  onChange={(checked) => setExportOptions(prev => ({ ...prev, includeChats: checked }))}\n                />\n                <ExportOptionToggle\n                  label=\"Notes\"\n                  checked={exportOptions.includeNotes}\n                  onChange={(checked) => setExportOptions(prev => ({ ...prev, includeNotes: checked }))}\n                />\n                <ExportOptionToggle\n                  label=\"Generated\"\n                  checked={exportOptions.includeGenerated}\n                  onChange={(checked) => setExportOptions(prev => ({ ...prev, includeGenerated: checked }))}\n                />\n              </div>\n            </div>\n\n            {/* Export Format Buttons */}\n            <div className=\"space-y-2\">\n              <p className=\"text-xs font-medium text-[var(--text-tertiary)]\">Export as:</p>\n              <div className=\"grid grid-cols-3 gap-2\">\n                <Button\n                  variant=\"outline\"\n                  className=\"flex flex-col items-center gap-1.5 h-auto py-3 rounded-xl border-[rgba(255,255,255,0.1)] hover:bg-[var(--bg-tertiary)] hover:border-sky-500/50\"\n                  onClick={() => onExportNotebook?.('zip', exportOptions)}\n                  disabled={exportingNotebook}\n                >\n                  {exportingNotebook ? (\n                    <SpinnerGap className=\"h-5 w-5 animate-spin text-[var(--text-tertiary)]\" weight=\"bold\" />\n                  ) : (\n                    <FileZip className=\"h-5 w-5 text-sky-500\" weight=\"duotone\" />\n                  )}\n                  <span className=\"text-xs font-medium text-[var(--text-primary)]\">ZIP</span>\n                </Button>\n                <Button\n                  variant=\"outline\"\n                  className=\"flex flex-col items-center gap-1.5 h-auto py-3 rounded-xl border-[rgba(255,255,255,0.1)] hover:bg-[var(--bg-tertiary)] hover:border-red-500/50\"\n                  onClick={() => onExportNotebook?.('pdf', exportOptions)}\n                  disabled={exportingNotebook}\n                >\n                  {exportingNotebook ? (\n                    <SpinnerGap className=\"h-5 w-5 animate-spin text-[var(--text-tertiary)]\" weight=\"bold\" />\n                  ) : (\n                    <FilePdf className=\"h-5 w-5 text-red-500\" weight=\"duotone\" />\n                  )}\n                  <span className=\"text-xs font-medium text-[var(--text-primary)]\">PDF</span>\n                </Button>\n                <Button\n                  variant=\"outline\"\n                  className=\"flex flex-col items-center gap-1.5 h-auto py-3 rounded-xl border-[rgba(255,255,255,0.1)] hover:bg-[var(--bg-tertiary)] hover:border-yellow-500/50\"\n                  onClick={() => onExportNotebook?.('json', exportOptions)}\n                  disabled={exportingNotebook}\n                >\n                  {exportingNotebook ? (\n                    <SpinnerGap className=\"h-5 w-5 animate-spin text-[var(--text-tertiary)]\" weight=\"bold\" />\n                  ) : (\n                    <FileJs className=\"h-5 w-5 text-yellow-500\" weight=\"duotone\" />\n                  )}\n                  <span className=\"text-xs font-medium text-[var(--text-primary)]\">JSON</span>\n                </Button>\n              </div>\n            </div>\n\n            <p className=\"text-xs text-[var(--text-tertiary)] text-center\">\n              ZIP includes all files. PDF is a summary document.\n            </p>\n          </div>\n        </StudioSection>\n      </div>"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":699,"cache_read_input_tokens":94253,"cache_creation":{"ephemeral_5m_input_tokens":699,"ephemeral_1h_input_tokens":0},"output_tokens":2528,"service_tier":"standard"}},"requestId":"req_011CWz6WFLxMuiqH232rhKTq","type":"assistant","uuid":"9836e460-95de-4337-ac78-c3c13c1aa79a","timestamp":"2026-01-10T17:31:44.391Z"}
{"parentUuid":"9836e460-95de-4337-ac78-c3c13c1aa79a","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01KfqLri9cESN9V4yXh7a3wx","type":"tool_result","content":"The file /Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend/src/components/studio/studio-panel.tsx has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n   676→            )}\n   677→          </div>\n   678→        </StudioSection>\n   679→\n   680→        {/* Notes Section */}\n   681→        <StudioSection\n   682→          id=\"notes\"\n   683→          title=\"Notes\"\n   684→          subtitle={`${notesCount} saved`}\n   685→          icon={<Note className=\"h-5 w-5\" weight=\"duotone\" />}\n   686→          iconGradient=\"from-amber-500/20 to-yellow-500/20\"\n   687→          iconColor=\"text-amber-500\"\n   688→          expanded={expandedSection === 'notes'}\n   689→          onToggle={() => toggleSection('notes')}\n   690→          action={\n   691→            <Button\n   692→              size=\"sm\"\n   693→              variant=\"ghost\"\n   694→              className=\"h-7 w-7 p-0\"\n   695→              onClick={(e) => {\n   696→                e.stopPropagation()\n   697→                onAddNote?.()\n   698→              }}\n   699→            >\n   700→              <Plus className=\"h-3.5 w-3.5\" />\n   701→            </Button>\n   702→          }\n   703→        >\n   704→          <div className=\"space-y-3\">\n   705→            {notesCount === 0 ? (\n   706→              <div className=\"text-center py-6\">\n   707→                <Note className=\"h-8 w-8 mx-auto mb-2 text-[var(--text-tertiary)]/50\" weight=\"duotone\" />\n   708→                <p className=\"text-sm text-[var(--text-tertiary)]\">No notes yet</p>\n   709→                <p className=\"text-xs text-[var(--text-tertiary)] mt-1\">Create notes or save chat responses</p>\n   710→              </div>\n   711→            ) : (\n   712→              <Button\n   713→                variant=\"outline\"\n   714→                className=\"w-full justify-start rounded-lg border-[rgba(255,255,255,0.1)] text-[var(--text-primary)] hover:bg-[var(--bg-tertiary)]\"\n   715→                onClick={onOpenNotes}\n   716→              >\n   717→                <Note className=\"h-4 w-4 mr-2 text-amber-500\" weight=\"duotone\" />\n   718→                View All Notes ({notesCount})\n   719→                <CaretRight className=\"h-4 w-4 ml-auto text-[var(--text-tertiary)]\" weight=\"bold\" />\n   720→              </Button>\n   721→            )}\n   722→          </div>\n   723→        </StudioSection>\n   724→\n   725→        {/* Export Section */}\n   726→        <StudioSection\n   727→          id=\"export\"\n   728→          title=\"Export Notebook\"\n   729→          subtitle=\"Download all content\"\n   730→          icon={<Export className=\"h-5 w-5\" weight=\"duotone\" />}\n   731→          iconGradient=\"from-sky-500/20 to-indigo-500/20\"\n   732→          iconColor=\"text-sky-500\"\n   733→          expanded={expandedSection === 'export'}\n   734→          onToggle={() => toggleSection('export')}\n   735→        >\n   736→          <div className=\"space-y-4\">\n   737→            {/* Export Options */}\n   738→            <div className=\"space-y-2\">\n   739→              <p className=\"text-xs font-medium text-[var(--text-tertiary)]\">Include in export:</p>\n   740→              <div className=\"grid grid-cols-2 gap-2\">\n   741→                <ExportOptionToggle\n   742→                  label=\"Sources\"\n   743→                  checked={exportOptions.includeSources}\n   744→                  onChange={(checked) => setExportOptions(prev => ({ ...prev, includeSources: checked }))}\n   745→                />\n   746→                <ExportOptionToggle\n   747→                  label=\"Chats\"\n   748→                  checked={exportOptions.includeChats}\n   749→                  onChange={(checked) => setExportOptions(prev => ({ ...prev, includeChats: checked }))}\n   750→                />\n   751→                <ExportOptionToggle\n   752→                  label=\"Notes\"\n   753→                  checked={exportOptions.includeNotes}\n   754→                  onChange={(checked) => setExportOptions(prev => ({ ...prev, includeNotes: checked }))}\n   755→                />\n   756→                <ExportOptionToggle\n   757→                  label=\"Generated\"\n   758→                  checked={exportOptions.includeGenerated}\n   759→                  onChange={(checked) => setExportOptions(prev => ({ ...prev, includeGenerated: checked }))}\n   760→                />\n   761→              </div>\n   762→            </div>\n   763→\n   764→            {/* Export Format Buttons */}\n   765→            <div className=\"space-y-2\">\n   766→              <p className=\"text-xs font-medium text-[var(--text-tertiary)]\">Export as:</p>\n   767→              <div className=\"grid grid-cols-3 gap-2\">\n   768→                <Button\n   769→                  variant=\"outline\"\n   770→                  className=\"flex flex-col items-center gap-1.5 h-auto py-3 rounded-xl border-[rgba(255,255,255,0.1)] hover:bg-[var(--bg-tertiary)] hover:border-sky-500/50\"\n   771→                  onClick={() => onExportNotebook?.('zip', exportOptions)}\n   772→                  disabled={exportingNotebook}\n   773→                >\n   774→                  {exportingNotebook ? (\n   775→                    <SpinnerGap className=\"h-5 w-5 animate-spin text-[var(--text-tertiary)]\" weight=\"bold\" />\n   776→                  ) : (\n   777→                    <FileZip className=\"h-5 w-5 text-sky-500\" weight=\"duotone\" />\n   778→                  )}\n   779→                  <span className=\"text-xs font-medium text-[var(--text-primary)]\">ZIP</span>\n   780→                </Button>\n   781→                <Button\n   782→                  variant=\"outline\"\n   783→                  className=\"flex flex-col items-center gap-1.5 h-auto py-3 rounded-xl border-[rgba(255,255,255,0.1)] hover:bg-[var(--bg-tertiary)] hover:border-red-500/50\"\n   784→                  onClick={() => onExportNotebook?.('pdf', exportOptions)}\n   785→                  disabled={exportingNotebook}\n   786→                >\n   787→                  {exportingNotebook ? (\n   788→                    <SpinnerGap className=\"h-5 w-5 animate-spin text-[var(--text-tertiary)]\" weight=\"bold\" />\n   789→                  ) : (\n   790→                    <FilePdf className=\"h-5 w-5 text-red-500\" weight=\"duotone\" />\n   791→                  )}\n   792→                  <span className=\"text-xs font-medium text-[var(--text-primary)]\">PDF</span>\n   793→                </Button>\n   794→                <Button\n   795→                  variant=\"outline\"\n   796→                  className=\"flex flex-col items-center gap-1.5 h-auto py-3 rounded-xl border-[rgba(255,255,255,0.1)] hover:bg-[var(--bg-tertiary)] hover:border-yellow-500/50\"\n   797→                  onClick={() => onExportNotebook?.('json', exportOptions)}\n   798→                  disabled={exportingNotebook}\n   799→                >\n   800→                  {exportingNotebook ? (\n   801→                    <SpinnerGap className=\"h-5 w-5 animate-spin text-[var(--text-tertiary)]\" weight=\"bold\" />\n   802→                  ) : (\n   803→                    <FileJs className=\"h-5 w-5 text-yellow-500\" weight=\"duotone\" />\n   804→                  )}\n   805→                  <span className=\"text-xs font-medium text-[var(--text-primary)]\">JSON</span>\n   806→                </Button>\n   807→              </div>\n   808→            </div>\n   809→\n   810→            <p className=\"text-xs text-[var(--text-tertiary)] text-center\">\n   811→              ZIP includes all files. PDF is a summary document.\n   812→            </p>\n   813→          </div>\n   814→        </StudioSection>\n   815→      </div>\n   816→\n   817→      {/* Generation Config Dialog */}\n   818→      <GenerationConfigDialog\n   819→        open={configDialogOpen}"}]},"uuid":"deed3170-19dc-4d6e-8668-c28b6dee05b2","timestamp":"2026-01-10T17:31:44.441Z","toolUseResult":{"filePath":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend/src/components/studio/studio-panel.tsx","oldString":"        {/* Notes Section */}\n        <StudioSection\n          id=\"notes\"\n          title=\"Notes\"\n          subtitle={`${notesCount} saved`}\n          icon={<Note className=\"h-5 w-5\" weight=\"duotone\" />}\n          iconGradient=\"from-amber-500/20 to-yellow-500/20\"\n          iconColor=\"text-amber-500\"\n          expanded={expandedSection === 'notes'}\n          onToggle={() => toggleSection('notes')}\n          action={\n            <Button\n              size=\"sm\"\n              variant=\"ghost\"\n              className=\"h-7 w-7 p-0\"\n              onClick={(e) => {\n                e.stopPropagation()\n                onAddNote?.()\n              }}\n            >\n              <Plus className=\"h-3.5 w-3.5\" />\n            </Button>\n          }\n        >\n          <div className=\"space-y-3\">\n            {notesCount === 0 ? (\n              <div className=\"text-center py-6\">\n                <Note className=\"h-8 w-8 mx-auto mb-2 text-[var(--text-tertiary)]/50\" weight=\"duotone\" />\n                <p className=\"text-sm text-[var(--text-tertiary)]\">No notes yet</p>\n                <p className=\"text-xs text-[var(--text-tertiary)] mt-1\">Create notes or save chat responses</p>\n              </div>\n            ) : (\n              <Button\n                variant=\"outline\"\n                className=\"w-full justify-start rounded-lg border-[rgba(255,255,255,0.1)] text-[var(--text-primary)] hover:bg-[var(--bg-tertiary)]\"\n                onClick={onOpenNotes}\n              >\n                <Note className=\"h-4 w-4 mr-2 text-amber-500\" weight=\"duotone\" />\n                View All Notes ({notesCount})\n                <CaretRight className=\"h-4 w-4 ml-auto text-[var(--text-tertiary)]\" weight=\"bold\" />\n              </Button>\n            )}\n          </div>\n        </StudioSection>\n      </div>","newString":"        {/* Notes Section */}\n        <StudioSection\n          id=\"notes\"\n          title=\"Notes\"\n          subtitle={`${notesCount} saved`}\n          icon={<Note className=\"h-5 w-5\" weight=\"duotone\" />}\n          iconGradient=\"from-amber-500/20 to-yellow-500/20\"\n          iconColor=\"text-amber-500\"\n          expanded={expandedSection === 'notes'}\n          onToggle={() => toggleSection('notes')}\n          action={\n            <Button\n              size=\"sm\"\n              variant=\"ghost\"\n              className=\"h-7 w-7 p-0\"\n              onClick={(e) => {\n                e.stopPropagation()\n                onAddNote?.()\n              }}\n            >\n              <Plus className=\"h-3.5 w-3.5\" />\n            </Button>\n          }\n        >\n          <div className=\"space-y-3\">\n            {notesCount === 0 ? (\n              <div className=\"text-center py-6\">\n                <Note className=\"h-8 w-8 mx-auto mb-2 text-[var(--text-tertiary)]/50\" weight=\"duotone\" />\n                <p className=\"text-sm text-[var(--text-tertiary)]\">No notes yet</p>\n                <p className=\"text-xs text-[var(--text-tertiary)] mt-1\">Create notes or save chat responses</p>\n              </div>\n            ) : (\n              <Button\n                variant=\"outline\"\n                className=\"w-full justify-start rounded-lg border-[rgba(255,255,255,0.1)] text-[var(--text-primary)] hover:bg-[var(--bg-tertiary)]\"\n                onClick={onOpenNotes}\n              >\n                <Note className=\"h-4 w-4 mr-2 text-amber-500\" weight=\"duotone\" />\n                View All Notes ({notesCount})\n                <CaretRight className=\"h-4 w-4 ml-auto text-[var(--text-tertiary)]\" weight=\"bold\" />\n              </Button>\n            )}\n          </div>\n        </StudioSection>\n\n        {/* Export Section */}\n        <StudioSection\n          id=\"export\"\n          title=\"Export Notebook\"\n          subtitle=\"Download all content\"\n          icon={<Export className=\"h-5 w-5\" weight=\"duotone\" />}\n          iconGradient=\"from-sky-500/20 to-indigo-500/20\"\n          iconColor=\"text-sky-500\"\n          expanded={expandedSection === 'export'}\n          onToggle={() => toggleSection('export')}\n        >\n          <div className=\"space-y-4\">\n            {/* Export Options */}\n            <div className=\"space-y-2\">\n              <p className=\"text-xs font-medium text-[var(--text-tertiary)]\">Include in export:</p>\n              <div className=\"grid grid-cols-2 gap-2\">\n                <ExportOptionToggle\n                  label=\"Sources\"\n                  checked={exportOptions.includeSources}\n                  onChange={(checked) => setExportOptions(prev => ({ ...prev, includeSources: checked }))}\n                />\n                <ExportOptionToggle\n                  label=\"Chats\"\n                  checked={exportOptions.includeChats}\n                  onChange={(checked) => setExportOptions(prev => ({ ...prev, includeChats: checked }))}\n                />\n                <ExportOptionToggle\n                  label=\"Notes\"\n                  checked={exportOptions.includeNotes}\n                  onChange={(checked) => setExportOptions(prev => ({ ...prev, includeNotes: checked }))}\n                />\n                <ExportOptionToggle\n                  label=\"Generated\"\n                  checked={exportOptions.includeGenerated}\n                  onChange={(checked) => setExportOptions(prev => ({ ...prev, includeGenerated: checked }))}\n                />\n              </div>\n            </div>\n\n            {/* Export Format Buttons */}\n            <div className=\"space-y-2\">\n              <p className=\"text-xs font-medium text-[var(--text-tertiary)]\">Export as:</p>\n              <div className=\"grid grid-cols-3 gap-2\">\n                <Button\n                  variant=\"outline\"\n                  className=\"flex flex-col items-center gap-1.5 h-auto py-3 rounded-xl border-[rgba(255,255,255,0.1)] hover:bg-[var(--bg-tertiary)] hover:border-sky-500/50\"\n                  onClick={() => onExportNotebook?.('zip', exportOptions)}\n                  disabled={exportingNotebook}\n                >\n                  {exportingNotebook ? (\n                    <SpinnerGap className=\"h-5 w-5 animate-spin text-[var(--text-tertiary)]\" weight=\"bold\" />\n                  ) : (\n                    <FileZip className=\"h-5 w-5 text-sky-500\" weight=\"duotone\" />\n                  )}\n                  <span className=\"text-xs font-medium text-[var(--text-primary)]\">ZIP</span>\n                </Button>\n                <Button\n                  variant=\"outline\"\n                  className=\"flex flex-col items-center gap-1.5 h-auto py-3 rounded-xl border-[rgba(255,255,255,0.1)] hover:bg-[var(--bg-tertiary)] hover:border-red-500/50\"\n                  onClick={() => onExportNotebook?.('pdf', exportOptions)}\n                  disabled={exportingNotebook}\n                >\n                  {exportingNotebook ? (\n                    <SpinnerGap className=\"h-5 w-5 animate-spin text-[var(--text-tertiary)]\" weight=\"bold\" />\n                  ) : (\n                    <FilePdf className=\"h-5 w-5 text-red-500\" weight=\"duotone\" />\n                  )}\n                  <span className=\"text-xs font-medium text-[var(--text-primary)]\">PDF</span>\n                </Button>\n                <Button\n                  variant=\"outline\"\n                  className=\"flex flex-col items-center gap-1.5 h-auto py-3 rounded-xl border-[rgba(255,255,255,0.1)] hover:bg-[var(--bg-tertiary)] hover:border-yellow-500/50\"\n                  onClick={() => onExportNotebook?.('json', exportOptions)}\n                  disabled={exportingNotebook}\n                >\n                  {exportingNotebook ? (\n                    <SpinnerGap className=\"h-5 w-5 animate-spin text-[var(--text-tertiary)]\" weight=\"bold\" />\n                  ) : (\n                    <FileJs className=\"h-5 w-5 text-yellow-500\" weight=\"duotone\" />\n                  )}\n                  <span className=\"text-xs font-medium text-[var(--text-primary)]\">JSON</span>\n                </Button>\n              </div>\n            </div>\n\n            <p className=\"text-xs text-[var(--text-tertiary)] text-center\">\n              ZIP includes all files. PDF is a summary document.\n            </p>\n          </div>\n        </StudioSection>\n      </div>","originalFile":"'use client'\n\nimport { useState } from 'react'\nimport { motion, AnimatePresence } from 'framer-motion'\nimport {\n  Microphone,\n  VideoCamera,\n  MagnifyingGlass,\n  GraduationCap,\n  CaretDown,\n  CaretRight,\n  Play,\n  SpinnerGap,\n  BookOpen,\n  ListChecks,\n  FileText,\n  Question,\n  Note,\n  Plus,\n  ShareNetwork,\n  ArrowsClockwise,\n  Clock,\n  WarningCircle,\n  Table,\n  ChartBar,\n  PresentationChart,\n  Image,\n  Palette,\n  Cards,\n  TreeStructure,\n  ChatCircleText,\n  Sparkle,\n  Export,\n  FilePdf,\n  FileZip,\n  FileJs,\n  CheckSquare\n} from '@phosphor-icons/react'\nimport { Button } from '@/components/ui/button'\nimport { Input } from '@/components/ui/input'\nimport { Textarea } from '@/components/ui/textarea'\nimport { Badge } from '@/components/ui/badge'\nimport { ScrollArea } from '@/components/ui/scroll-area'\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select'\nimport { Tooltip, TooltipContent, TooltipTrigger } from '@/components/ui/tooltip'\nimport { GenerationConfigDialog, GenerationType, GenerationConfig } from './generation-config-dialog'\n\n// Metadata for a generated study material\nexport interface StudyMaterialMeta {\n  id: string\n  type: string\n  sourceIds: string[]\n  sourceNames: string[]\n  createdAt: string\n  itemCount?: number\n}\n\n// Helper to format relative time\nfunction getTimeAgo(dateString: string): string {\n  const date = new Date(dateString)\n  const now = new Date()\n  const diffMs = now.getTime() - date.getTime()\n  const diffMins = Math.floor(diffMs / 60000)\n  const diffHours = Math.floor(diffMs / 3600000)\n  const diffDays = Math.floor(diffMs / 86400000)\n\n  if (diffMins < 1) return 'Just now'\n  if (diffMins < 60) return `${diffMins}m ago`\n  if (diffHours < 24) return `${diffHours}h ago`\n  if (diffDays < 7) return `${diffDays}d ago`\n  return date.toLocaleDateString()\n}\n\n// Source type for selection\nexport interface SourceInfo {\n  id: string\n  name: string\n}\n\ninterface StudioPanelProps {\n  notebookId: string\n  selectedSourcesCount: number\n  selectedSourceIds: string[]\n  sources?: SourceInfo[]\n  // Audio\n  audioFormat: string\n  onAudioFormatChange: (format: string) => void\n  audioInstructions: string\n  onAudioInstructionsChange: (instructions: string) => void\n  onGenerateAudio: () => void\n  generatingAudio: boolean\n  // Video\n  videoStyle: string\n  onVideoStyleChange: (style: string) => void\n  onGenerateVideo: () => void\n  generatingVideo: boolean\n  // Research\n  researchQuery: string\n  onResearchQueryChange: (query: string) => void\n  researchMode: string\n  onResearchModeChange: (mode: string) => void\n  onRunResearch: () => void\n  researching: boolean\n  // Study - now accepts config\n  onGenerateStudyMaterial: (config: GenerationConfig) => void\n  generatingFlashcards: boolean\n  generatingQuiz: boolean\n  generatingStudyGuide: boolean\n  generatingFaq: boolean\n  generatingMindMap: boolean\n  // Creative Outputs - now accepts config\n  onGenerateCreativeOutput?: (config: GenerationConfig) => void\n  generatingDataTable?: boolean\n  generatingReport?: boolean\n  generatingSlideDeck?: boolean\n  generatingInfographic?: boolean\n  // Creative outputs results\n  creativeOutputs?: Array<{\n    id: string\n    type: string\n    title: string\n    status: string\n    createdAt: string\n  }>\n  onOpenCreativeOutput?: (type: string) => void\n  // Results - now with metadata\n  studyMaterials?: StudyMaterialMeta[]\n  onOpenStudyMaterial?: (type: string) => void\n  // Notes\n  notesCount?: number\n  onAddNote?: () => void\n  onOpenNotes?: () => void\n  // Generated content\n  hasGeneratedAudio?: boolean\n  hasGeneratedVideo?: boolean\n  hasGeneratedResearch?: boolean\n  onOpenAudio?: () => void\n  onOpenVideo?: () => void\n  onOpenResearch?: () => void\n  // Export\n  onExportNotebook?: (format: 'zip' | 'pdf' | 'json', options: ExportOptionsState) => void\n  exportingNotebook?: boolean\n}\n\n// Export options state type\nexport interface ExportOptionsState {\n  includeSources: boolean\n  includeChats: boolean\n  includeNotes: boolean\n  includeGenerated: boolean\n}\n\nexport function StudioPanel({\n  notebookId,\n  selectedSourcesCount,\n  selectedSourceIds,\n  sources = [],\n  audioFormat,\n  onAudioFormatChange,\n  audioInstructions,\n  onAudioInstructionsChange,\n  onGenerateAudio,\n  generatingAudio,\n  videoStyle,\n  onVideoStyleChange,\n  onGenerateVideo,\n  generatingVideo,\n  researchQuery,\n  onResearchQueryChange,\n  researchMode,\n  onResearchModeChange,\n  onRunResearch,\n  researching,\n  onGenerateStudyMaterial,\n  generatingFlashcards,\n  generatingQuiz,\n  generatingStudyGuide,\n  generatingFaq,\n  generatingMindMap,\n  onGenerateCreativeOutput,\n  generatingDataTable = false,\n  generatingReport = false,\n  generatingSlideDeck = false,\n  generatingInfographic = false,\n  creativeOutputs = [],\n  onOpenCreativeOutput,\n  studyMaterials = [],\n  onOpenStudyMaterial,\n  notesCount = 0,\n  onAddNote,\n  onOpenNotes,\n  hasGeneratedAudio = false,\n  hasGeneratedVideo = false,\n  hasGeneratedResearch = false,\n  onOpenAudio,\n  onOpenVideo,\n  onOpenResearch,\n  onExportNotebook,\n  exportingNotebook = false,\n}: StudioPanelProps) {\n  const [expandedSection, setExpandedSection] = useState<string | null>('audio')\n  const [configDialogOpen, setConfigDialogOpen] = useState(false)\n  const [configDialogType, setConfigDialogType] = useState<GenerationType>('flashcards')\n  const [exportOptions, setExportOptions] = useState<ExportOptionsState>({\n    includeSources: true,\n    includeChats: true,\n    includeNotes: true,\n    includeGenerated: true,\n  })\n\n  // Open config dialog for a specific type\n  const openConfigDialog = (type: GenerationType) => {\n    setConfigDialogType(type)\n    setConfigDialogOpen(true)\n  }\n\n  // Handle generation from config dialog\n  const handleGenerate = (config: GenerationConfig) => {\n    setConfigDialogOpen(false)\n\n    // Route to appropriate handler based on type\n    const studyTypes = ['flashcards', 'quiz', 'study-guide', 'faq', 'mind-map']\n    if (studyTypes.includes(config.type)) {\n      onGenerateStudyMaterial(config)\n    } else {\n      onGenerateCreativeOutput?.(config)\n    }\n  }\n\n  // Check if currently generating for a type\n  const isGenerating = (type: GenerationType): boolean => {\n    switch (type) {\n      case 'flashcards': return generatingFlashcards\n      case 'quiz': return generatingQuiz\n      case 'study-guide': return generatingStudyGuide\n      case 'faq': return generatingFaq\n      case 'mind-map': return generatingMindMap\n      case 'data_table': return generatingDataTable\n      case 'report': return generatingReport\n      case 'slide_deck': return generatingSlideDeck\n      case 'infographic': return generatingInfographic\n      default: return false\n    }\n  }\n\n  const toggleSection = (section: string) => {\n    setExpandedSection(expandedSection === section ? null : section)\n  }\n\n  // Check if a material's sources match current selection\n  const isMaterialStale = (material: StudyMaterialMeta) => {\n    const sortedMaterialIds = [...material.sourceIds].sort()\n    const sortedSelectedIds = [...selectedSourceIds].sort()\n    if (sortedMaterialIds.length !== sortedSelectedIds.length) return true\n    return !sortedMaterialIds.every((id, idx) => id === sortedSelectedIds[idx])\n  }\n\n  // Format relative time\n  const formatTimeAgo = (dateStr: string) => {\n    const date = new Date(dateStr)\n    const now = new Date()\n    const diffMs = now.getTime() - date.getTime()\n    const diffMins = Math.floor(diffMs / 60000)\n    const diffHours = Math.floor(diffMins / 60)\n    const diffDays = Math.floor(diffHours / 24)\n\n    if (diffMins < 1) return 'Just now'\n    if (diffMins < 60) return `${diffMins}m ago`\n    if (diffHours < 24) return `${diffHours}h ago`\n    if (diffDays < 7) return `${diffDays}d ago`\n    return date.toLocaleDateString()\n  }\n\n  // Get material by type\n  const getMaterial = (type: string) => studyMaterials.find(m => m.type === type)\n\n  return (\n    <ScrollArea className=\"h-full\">\n      <div className=\"p-4 space-y-3\">\n        {/* Audio Overview Section */}\n        <StudioSection\n          id=\"audio\"\n          title=\"Audio Overview\"\n          subtitle=\"Podcast-style discussion\"\n          icon={<Microphone className=\"h-5 w-5\" weight=\"duotone\" />}\n          iconGradient=\"from-orange-500/20 to-red-500/20\"\n          iconColor=\"text-orange-500\"\n          expanded={expandedSection === 'audio'}\n          onToggle={() => toggleSection('audio')}\n        >\n          <div className=\"space-y-3\">\n            <div className=\"space-y-1.5\">\n              <label className=\"text-xs font-medium text-[var(--text-primary)]\">Format</label>\n              <Select value={audioFormat} onValueChange={onAudioFormatChange}>\n                <SelectTrigger className=\"h-9 text-sm bg-[var(--bg-tertiary)] border-[rgba(255,255,255,0.1)] rounded-lg\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent className=\"bg-[var(--bg-secondary)] border-[rgba(255,255,255,0.1)]\">\n                  <SelectItem value=\"deep_dive\">Deep Dive (10-15 min)</SelectItem>\n                  <SelectItem value=\"brief\">Brief Summary (2-3 min)</SelectItem>\n                  <SelectItem value=\"critique\">Analytical (5-10 min)</SelectItem>\n                  <SelectItem value=\"debate\">Debate (8-15 min)</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n            <div className=\"space-y-1.5\">\n              <label className=\"text-xs font-medium text-[var(--text-primary)]\">Custom Instructions</label>\n              <Textarea\n                placeholder=\"Optional instructions for hosts...\"\n                value={audioInstructions}\n                onChange={(e) => onAudioInstructionsChange(e.target.value)}\n                rows={2}\n                className=\"text-sm resize-none bg-[var(--bg-tertiary)] border-[rgba(255,255,255,0.1)] text-[var(--text-primary)] placeholder:text-[var(--text-tertiary)] focus:border-[var(--accent-primary)] rounded-lg\"\n              />\n            </div>\n            <div className=\"flex gap-2\">\n              <Button\n                className=\"flex-1 rounded-lg bg-orange-500 hover:bg-orange-500/90 text-white\"\n                onClick={onGenerateAudio}\n                disabled={generatingAudio || selectedSourcesCount === 0}\n              >\n                {generatingAudio ? (\n                  <SpinnerGap className=\"h-4 w-4 mr-2 animate-spin\" weight=\"bold\" />\n                ) : (\n                  <Play className=\"h-4 w-4 mr-2\" />\n                )}\n                Generate\n              </Button>\n              {hasGeneratedAudio && onOpenAudio && (\n                <Button\n                  variant=\"outline\"\n                  className=\"rounded-lg border-orange-500/30 text-orange-500 hover:bg-orange-500/10\"\n                  onClick={onOpenAudio}\n                >\n                  View\n                  <CaretRight className=\"h-4 w-4 ml-1\" weight=\"bold\" />\n                </Button>\n              )}\n            </div>\n            {selectedSourcesCount === 0 && (\n              <p className=\"text-xs text-[var(--text-tertiary)] text-center\">\n                Select sources to generate\n              </p>\n            )}\n          </div>\n        </StudioSection>\n\n        {/* Video Overview Section */}\n        <StudioSection\n          id=\"video\"\n          title=\"Video Overview\"\n          subtitle=\"AI-generated video clip\"\n          icon={<VideoCamera className=\"h-5 w-5\" weight=\"duotone\" />}\n          iconGradient=\"from-purple-500/20 to-pink-500/20\"\n          iconColor=\"text-purple-500\"\n          expanded={expandedSection === 'video'}\n          onToggle={() => toggleSection('video')}\n        >\n          <div className=\"space-y-3\">\n            <div className=\"space-y-1.5\">\n              <label className=\"text-xs font-medium text-[var(--text-primary)]\">Style</label>\n              <Select value={videoStyle} onValueChange={onVideoStyleChange}>\n                <SelectTrigger className=\"h-9 text-sm bg-[var(--bg-tertiary)] border-[rgba(255,255,255,0.1)] rounded-lg\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent className=\"bg-[var(--bg-secondary)] border-[rgba(255,255,255,0.1)]\">\n                  <SelectItem value=\"explainer\">Explainer (5s)</SelectItem>\n                  <SelectItem value=\"documentary\">Documentary (10s)</SelectItem>\n                  <SelectItem value=\"presentation\">Presentation (5s)</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n            <p className=\"text-xs text-[var(--text-tertiary)]\">\n              Generates an AI video clip using Wan 2.5. Estimated cost: ~$0.10-0.20\n            </p>\n            <div className=\"flex gap-2\">\n              <Button\n                className=\"flex-1 rounded-lg bg-purple-500 hover:bg-purple-500/90 text-white\"\n                onClick={onGenerateVideo}\n                disabled={generatingVideo || selectedSourcesCount === 0}\n              >\n                {generatingVideo ? (\n                  <SpinnerGap className=\"h-4 w-4 mr-2 animate-spin\" weight=\"bold\" />\n                ) : (\n                  <VideoCamera className=\"h-4 w-4 mr-2\" weight=\"duotone\" />\n                )}\n                {generatingVideo ? 'Generating...' : 'Generate Video'}\n              </Button>\n              {hasGeneratedVideo && onOpenVideo && (\n                <Button\n                  variant=\"outline\"\n                  className=\"rounded-lg border-purple-500/30 text-purple-500 hover:bg-purple-500/10\"\n                  onClick={onOpenVideo}\n                >\n                  View\n                  <CaretRight className=\"h-4 w-4 ml-1\" weight=\"bold\" />\n                </Button>\n              )}\n            </div>\n            {selectedSourcesCount === 0 && (\n              <p className=\"text-xs text-[var(--text-tertiary)] text-center\">\n                Select sources to generate\n              </p>\n            )}\n          </div>\n        </StudioSection>\n\n        {/* Deep Research Section */}\n        <StudioSection\n          id=\"research\"\n          title=\"Deep Research\"\n          subtitle=\"Autonomous web research\"\n          icon={<MagnifyingGlass className=\"h-5 w-5\" weight=\"duotone\" />}\n          iconGradient=\"from-blue-500/20 to-cyan-500/20\"\n          iconColor=\"text-blue-500\"\n          expanded={expandedSection === 'research'}\n          onToggle={() => toggleSection('research')}\n        >\n          <div className=\"space-y-3\">\n            <div className=\"space-y-1.5\">\n              <label className=\"text-xs font-medium text-[var(--text-primary)]\">Research Query</label>\n              <Input\n                placeholder=\"What would you like to research?\"\n                value={researchQuery}\n                onChange={(e) => onResearchQueryChange(e.target.value)}\n                className=\"h-9 text-sm bg-[var(--bg-tertiary)] border-[rgba(255,255,255,0.1)] text-[var(--text-primary)] placeholder:text-[var(--text-tertiary)] focus:border-[var(--accent-primary)] rounded-lg\"\n              />\n            </div>\n            <div className=\"space-y-1.5\">\n              <label className=\"text-xs font-medium text-[var(--text-primary)]\">Mode</label>\n              <Select value={researchMode} onValueChange={onResearchModeChange}>\n                <SelectTrigger className=\"h-9 text-sm bg-[var(--bg-tertiary)] border-[rgba(255,255,255,0.1)] rounded-lg\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent className=\"bg-[var(--bg-secondary)] border-[rgba(255,255,255,0.1)]\">\n                  <SelectItem value=\"fast\">Fast (3-5 min)</SelectItem>\n                  <SelectItem value=\"deep\">Deep (10-15 min)</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n            <div className=\"flex gap-2\">\n              <Button\n                className=\"flex-1 rounded-lg bg-blue-500 hover:bg-blue-500/90 text-white\"\n                onClick={onRunResearch}\n                disabled={researching || !researchQuery.trim()}\n              >\n                {researching ? (\n                  <SpinnerGap className=\"h-4 w-4 mr-2 animate-spin\" weight=\"bold\" />\n                ) : (\n                  <MagnifyingGlass className=\"h-4 w-4 mr-2\" weight=\"duotone\" />\n                )}\n                Research\n              </Button>\n              {hasGeneratedResearch && onOpenResearch && (\n                <Button\n                  variant=\"outline\"\n                  className=\"rounded-lg border-blue-500/30 text-blue-500 hover:bg-blue-500/10\"\n                  onClick={onOpenResearch}\n                >\n                  View\n                  <CaretRight className=\"h-4 w-4 ml-1\" weight=\"bold\" />\n                </Button>\n              )}\n            </div>\n          </div>\n        </StudioSection>\n\n        {/* Study Materials Section */}\n        <StudioSection\n          id=\"study\"\n          title=\"Study Materials\"\n          subtitle=\"Flashcards, quizzes, and more\"\n          icon={<GraduationCap className=\"h-5 w-5\" />}\n          iconGradient=\"from-emerald-500/20 to-teal-500/20\"\n          iconColor=\"text-emerald-500\"\n          expanded={expandedSection === 'study'}\n          onToggle={() => toggleSection('study')}\n        >\n          <div className=\"space-y-4\">\n            {/* Study Tools Grid */}\n            <div className=\"grid grid-cols-2 gap-2\">\n              <StudyToolButton\n                icon={<BookOpen className=\"h-5 w-5\" />}\n                label=\"Flashcards\"\n                color=\"text-blue-500\"\n                onClick={() => openConfigDialog('flashcards')}\n                loading={generatingFlashcards}\n                disabled={selectedSourcesCount === 0}\n              />\n              <StudyToolButton\n                icon={<ListChecks className=\"h-5 w-5\" />}\n                label=\"Quiz\"\n                color=\"text-purple-500\"\n                onClick={() => openConfigDialog('quiz')}\n                loading={generatingQuiz}\n                disabled={selectedSourcesCount === 0}\n              />\n              <StudyToolButton\n                icon={<FileText className=\"h-5 w-5\" />}\n                label=\"Study Guide\"\n                color=\"text-orange-500\"\n                onClick={() => openConfigDialog('study-guide')}\n                loading={generatingStudyGuide}\n                disabled={selectedSourcesCount === 0}\n              />\n              <StudyToolButton\n                icon={<Question className=\"h-5 w-5\" weight=\"duotone\" />}\n                label=\"FAQ\"\n                color=\"text-teal-500\"\n                onClick={() => openConfigDialog('faq')}\n                loading={generatingFaq}\n                disabled={selectedSourcesCount === 0}\n              />\n              <StudyToolButton\n                icon={<TreeStructure className=\"h-5 w-5\" weight=\"duotone\" />}\n                label=\"Mind Map\"\n                color=\"text-cyan-500\"\n                onClick={() => openConfigDialog('mind-map')}\n                loading={generatingMindMap}\n                disabled={selectedSourcesCount === 0}\n              />\n            </div>\n\n            {selectedSourcesCount === 0 && (\n              <p className=\"text-xs text-[var(--text-tertiary)] text-center\">\n                Select sources to generate study materials\n              </p>\n            )}\n\n            {/* Generated Materials */}\n            {studyMaterials.length > 0 && (\n              <div className=\"pt-3 border-t border-[rgba(255,255,255,0.1)]\">\n                <p className=\"text-xs font-medium text-[var(--text-tertiary)] mb-2\">Generated Materials</p>\n                <div className=\"space-y-2\">\n                  {studyMaterials.map((material) => {\n                    const isStale = isMaterialStale(material)\n                    const iconMap: Record<string, { icon: React.ReactNode; color: string; label: string }> = {\n                      flashcards: { icon: <BookOpen className=\"h-4 w-4\" />, color: 'text-blue-500', label: `${material.itemCount || 0} Flashcards` },\n                      quiz: { icon: <ListChecks className=\"h-4 w-4\" />, color: 'text-purple-500', label: `${material.itemCount || 0} Quiz Questions` },\n                      study_guide: { icon: <FileText className=\"h-4 w-4\" />, color: 'text-orange-500', label: 'Study Guide' },\n                      faq: { icon: <ChatCircleText className=\"h-4 w-4\" weight=\"duotone\" />, color: 'text-teal-500', label: `${material.itemCount || 0} FAQ Items` },\n                      mind_map: { icon: <TreeStructure className=\"h-4 w-4\" weight=\"duotone\" />, color: 'text-cyan-500', label: 'Mind Map' },\n                    }\n                    const info = iconMap[material.type] || { icon: <FileText className=\"h-4 w-4\" />, color: 'text-gray-500', label: material.type }\n\n                    return (\n                      <div\n                        key={material.id}\n                        className={`rounded-lg border ${isStale ? 'border-amber-500/30 bg-amber-500/5' : 'border-[rgba(255,255,255,0.1)]'} overflow-hidden`}\n                      >\n                        <button\n                          onClick={() => onOpenStudyMaterial?.(material.type)}\n                          className=\"w-full flex items-center gap-2 px-3 py-2 text-sm hover:bg-[var(--bg-tertiary)] transition-colors\"\n                        >\n                          <span className={info.color}>{info.icon}</span>\n                          <span className=\"text-[var(--text-primary)] flex-1 text-left\">{info.label}</span>\n                          {isStale && (\n                            <Tooltip>\n                              <TooltipTrigger asChild>\n                                <WarningCircle className=\"h-3.5 w-3.5 text-amber-500\" weight=\"fill\" />\n                              </TooltipTrigger>\n                              <TooltipContent>\n                                <p>Sources changed - regenerate for updated content</p>\n                              </TooltipContent>\n                            </Tooltip>\n                          )}\n                          <CaretRight className=\"h-4 w-4 text-[var(--text-tertiary)]\" weight=\"bold\" />\n                        </button>\n                        <div className=\"px-3 py-1.5 bg-[var(--bg-tertiary)]/50 border-t border-[rgba(255,255,255,0.05)] flex items-center gap-3 text-[10px] text-[var(--text-tertiary)]\">\n                          <span className=\"flex items-center gap-1\">\n                            <Clock className=\"h-3 w-3\" />\n                            {formatTimeAgo(material.createdAt)}\n                          </span>\n                          <span>•</span>\n                          <span className=\"truncate\">\n                            {material.sourceNames.length === 1\n                              ? material.sourceNames[0]\n                              : `${material.sourceNames.length} sources`}\n                          </span>\n                        </div>\n                      </div>\n                    )\n                  })}\n                </div>\n              </div>\n            )}\n          </div>\n        </StudioSection>\n\n        {/* Creative Outputs Section */}\n        <StudioSection\n          id=\"creative\"\n          title=\"Creative Outputs\"\n          subtitle=\"Tables, reports, slides, infographics\"\n          icon={<Palette className=\"h-5 w-5\" />}\n          iconGradient=\"from-pink-500/20 to-rose-500/20\"\n          iconColor=\"text-pink-500\"\n          expanded={expandedSection === 'creative'}\n          onToggle={() => toggleSection('creative')}\n        >\n          <div className=\"space-y-4\">\n            {/* Creative Tools Grid */}\n            <div className=\"grid grid-cols-2 gap-2\">\n              <StudyToolButton\n                icon={<Table className=\"h-5 w-5\" />}\n                label=\"Data Table\"\n                color=\"text-emerald-500\"\n                onClick={() => openConfigDialog('data_table')}\n                loading={generatingDataTable}\n                disabled={selectedSourcesCount === 0}\n              />\n              <StudyToolButton\n                icon={<Palette className=\"h-5 w-5\" weight=\"duotone\" />}\n                label=\"Report\"\n                color=\"text-blue-500\"\n                onClick={() => openConfigDialog('report')}\n                loading={generatingReport}\n                disabled={selectedSourcesCount === 0}\n              />\n              <StudyToolButton\n                icon={<PresentationChart className=\"h-5 w-5\" />}\n                label=\"Slide Deck\"\n                color=\"text-violet-500\"\n                onClick={() => openConfigDialog('slide_deck')}\n                loading={generatingSlideDeck}\n                disabled={selectedSourcesCount === 0}\n              />\n              <StudyToolButton\n                icon={<Image className=\"h-5 w-5\" />}\n                label=\"Infographic\"\n                color=\"text-rose-500\"\n                onClick={() => openConfigDialog('infographic')}\n                loading={generatingInfographic}\n                disabled={selectedSourcesCount === 0}\n              />\n            </div>\n\n            {selectedSourcesCount === 0 && (\n              <p className=\"text-xs text-[var(--text-tertiary)] text-center\">\n                Select sources to generate creative outputs\n              </p>\n            )}\n\n            {/* Generated Outputs */}\n            {creativeOutputs.length > 0 && (\n              <div className=\"mt-4 pt-4 border-t border-[rgba(255,255,255,0.1)]\">\n                <p className=\"text-xs font-medium text-[var(--text-tertiary)] mb-3\">Generated Outputs</p>\n                <div className=\"space-y-2\">\n                  {creativeOutputs.map((output) => {\n                    const typeConfig: Record<string, { icon: React.ReactNode; label: string; color: string }> = {\n                      data_table: { icon: <Table className=\"h-4 w-4\" />, label: 'Data Table', color: 'text-emerald-500' },\n                      report: { icon: <ChartBar className=\"h-4 w-4\" weight=\"duotone\" />, label: 'Report', color: 'text-blue-500' },\n                      slide_deck: { icon: <PresentationChart className=\"h-4 w-4\" />, label: 'Slide Deck', color: 'text-violet-500' },\n                      infographic: { icon: <Image className=\"h-4 w-4\" />, label: 'Infographic', color: 'text-rose-500' },\n                    }\n                    const config = typeConfig[output.type] || { icon: <FileText className=\"h-4 w-4\" />, label: output.type, color: 'text-gray-500' }\n                    const timeAgo = getTimeAgo(output.createdAt)\n\n                    return (\n                      <button\n                        key={output.id}\n                        onClick={() => onOpenCreativeOutput?.(output.type)}\n                        className=\"w-full flex items-center gap-3 p-3 rounded-xl bg-[var(--bg-tertiary)] hover:bg-[var(--bg-tertiary)]/80 transition-colors text-left\"\n                      >\n                        <div className={`${config.color}`}>{config.icon}</div>\n                        <div className=\"flex-1 min-w-0\">\n                          <p className=\"text-sm font-medium text-[var(--text-primary)] truncate\">{config.label}</p>\n                          <p className=\"text-xs text-[var(--text-tertiary)]\">{timeAgo}</p>\n                        </div>\n                        <CaretRight className=\"h-4 w-4 text-[var(--text-tertiary)]\" weight=\"bold\" />\n                      </button>\n                    )\n                  })}\n                </div>\n              </div>\n            )}\n          </div>\n        </StudioSection>\n\n        {/* Notes Section */}\n        <StudioSection\n          id=\"notes\"\n          title=\"Notes\"\n          subtitle={`${notesCount} saved`}\n          icon={<Note className=\"h-5 w-5\" weight=\"duotone\" />}\n          iconGradient=\"from-amber-500/20 to-yellow-500/20\"\n          iconColor=\"text-amber-500\"\n          expanded={expandedSection === 'notes'}\n          onToggle={() => toggleSection('notes')}\n          action={\n            <Button\n              size=\"sm\"\n              variant=\"ghost\"\n              className=\"h-7 w-7 p-0\"\n              onClick={(e) => {\n                e.stopPropagation()\n                onAddNote?.()\n              }}\n            >\n              <Plus className=\"h-3.5 w-3.5\" />\n            </Button>\n          }\n        >\n          <div className=\"space-y-3\">\n            {notesCount === 0 ? (\n              <div className=\"text-center py-6\">\n                <Note className=\"h-8 w-8 mx-auto mb-2 text-[var(--text-tertiary)]/50\" weight=\"duotone\" />\n                <p className=\"text-sm text-[var(--text-tertiary)]\">No notes yet</p>\n                <p className=\"text-xs text-[var(--text-tertiary)] mt-1\">Create notes or save chat responses</p>\n              </div>\n            ) : (\n              <Button\n                variant=\"outline\"\n                className=\"w-full justify-start rounded-lg border-[rgba(255,255,255,0.1)] text-[var(--text-primary)] hover:bg-[var(--bg-tertiary)]\"\n                onClick={onOpenNotes}\n              >\n                <Note className=\"h-4 w-4 mr-2 text-amber-500\" weight=\"duotone\" />\n                View All Notes ({notesCount})\n                <CaretRight className=\"h-4 w-4 ml-auto text-[var(--text-tertiary)]\" weight=\"bold\" />\n              </Button>\n            )}\n          </div>\n        </StudioSection>\n      </div>\n\n      {/* Generation Config Dialog */}\n      <GenerationConfigDialog\n        open={configDialogOpen}\n        onOpenChange={setConfigDialogOpen}\n        type={configDialogType}\n        sources={sources}\n        onGenerate={handleGenerate}\n        isGenerating={isGenerating(configDialogType)}\n      />\n    </ScrollArea>\n  )\n}\n\n// Studio Section Component\nfunction StudioSection({\n  id,\n  title,\n  subtitle,\n  icon,\n  iconGradient,\n  iconColor,\n  expanded,\n  onToggle,\n  action,\n  children,\n}: {\n  id: string\n  title: string\n  subtitle: string\n  icon: React.ReactNode\n  iconGradient: string\n  iconColor: string\n  expanded: boolean\n  onToggle: () => void\n  action?: React.ReactNode\n  children: React.ReactNode\n}) {\n  return (\n    <div className=\"glass-card rounded-2xl overflow-hidden\">\n      <div className=\"flex items-center justify-between p-4 hover:bg-white/[0.02] transition-all duration-200 group\">\n        <button\n          onClick={onToggle}\n          className=\"flex items-center gap-3 flex-1\"\n        >\n          <div className={`relative w-10 h-10 rounded-xl bg-gradient-to-br ${iconGradient} flex items-center justify-center shadow-lg`}>\n            <div className=\"absolute inset-0 rounded-xl bg-gradient-to-br from-white/10 to-transparent\" />\n            <span className={`relative z-10 ${iconColor}`}>{icon}</span>\n          </div>\n          <div className=\"text-left\">\n            <p className=\"font-medium text-sm text-[var(--text-primary)] group-hover:text-white transition-colors\">{title}</p>\n            <p className=\"text-xs text-[var(--text-tertiary)]\">{subtitle}</p>\n          </div>\n        </button>\n        <div className=\"flex items-center gap-2\">\n          {action}\n          <button onClick={onToggle} className=\"p-1.5 rounded-lg hover:bg-white/5 transition-colors\">\n            <CaretDown weight=\"bold\" className={`h-4 w-4 text-[var(--text-tertiary)] transition-transform duration-200 ${expanded ? 'rotate-180' : ''}`} />\n          </button>\n        </div>\n      </div>\n\n      <AnimatePresence>\n        {expanded && (\n          <motion.div\n            initial={{ height: 0, opacity: 0 }}\n            animate={{ height: 'auto', opacity: 1 }}\n            exit={{ height: 0, opacity: 0 }}\n            transition={{ duration: 0.2 }}\n            className=\"overflow-hidden\"\n          >\n            <div className=\"px-4 pb-4 pt-2 border-t border-[rgba(255,255,255,0.1)] bg-[var(--bg-tertiary)]/30\">\n              {children}\n            </div>\n          </motion.div>\n        )}\n      </AnimatePresence>\n    </div>\n  )\n}\n\n// Study Tool Button\nfunction StudyToolButton({\n  icon,\n  label,\n  color,\n  onClick,\n  loading,\n  disabled,\n}: {\n  icon: React.ReactNode\n  label: string\n  color: string\n  onClick: () => void\n  loading: boolean\n  disabled: boolean\n}) {\n  return (\n    <button\n      onClick={onClick}\n      disabled={disabled || loading}\n      className=\"flex flex-col items-center gap-2 p-4 rounded-xl border border-[rgba(255,255,255,0.1)] bg-[var(--bg-secondary)] hover:bg-[var(--bg-tertiary)]/50 transition-colors disabled:opacity-50 disabled:cursor-not-allowed\"\n    >\n      {loading ? (\n        <SpinnerGap className=\"h-5 w-5 animate-spin text-[var(--text-tertiary)]\" weight=\"bold\" />\n      ) : (\n        <span className={color}>{icon}</span>\n      )}\n      <span className=\"text-xs font-medium text-[var(--text-primary)]\">{label}</span>\n    </button>\n  )\n}\n\n// Material Button\nfunction MaterialButton({\n  icon,\n  label,\n  onClick,\n}: {\n  icon: React.ReactNode\n  label: string\n  onClick?: () => void\n}) {\n  return (\n    <button\n      onClick={onClick}\n      className=\"w-full flex items-center gap-2 px-3 py-2 text-sm rounded-lg hover:bg-[var(--bg-tertiary)] transition-colors\"\n    >\n      {icon}\n      <span className=\"text-[var(--text-primary)]\">{label}</span>\n      <CaretRight className=\"h-4 w-4 ml-auto text-[var(--text-tertiary)]\" weight=\"bold\" />\n    </button>\n  )\n}\n","structuredPatch":[{"oldStart":721,"oldLines":6,"newStart":721,"newLines":97,"lines":["             )}","           </div>","         </StudioSection>","+","+        {/* Export Section */}","+        <StudioSection","+          id=\"export\"","+          title=\"Export Notebook\"","+          subtitle=\"Download all content\"","+          icon={<Export className=\"h-5 w-5\" weight=\"duotone\" />}","+          iconGradient=\"from-sky-500/20 to-indigo-500/20\"","+          iconColor=\"text-sky-500\"","+          expanded={expandedSection === 'export'}","+          onToggle={() => toggleSection('export')}","+        >","+          <div className=\"space-y-4\">","+            {/* Export Options */}","+            <div className=\"space-y-2\">","+              <p className=\"text-xs font-medium text-[var(--text-tertiary)]\">Include in export:</p>","+              <div className=\"grid grid-cols-2 gap-2\">","+                <ExportOptionToggle","+                  label=\"Sources\"","+                  checked={exportOptions.includeSources}","+                  onChange={(checked) => setExportOptions(prev => ({ ...prev, includeSources: checked }))}","+                />","+                <ExportOptionToggle","+                  label=\"Chats\"","+                  checked={exportOptions.includeChats}","+                  onChange={(checked) => setExportOptions(prev => ({ ...prev, includeChats: checked }))}","+                />","+                <ExportOptionToggle","+                  label=\"Notes\"","+                  checked={exportOptions.includeNotes}","+                  onChange={(checked) => setExportOptions(prev => ({ ...prev, includeNotes: checked }))}","+                />","+                <ExportOptionToggle","+                  label=\"Generated\"","+                  checked={exportOptions.includeGenerated}","+                  onChange={(checked) => setExportOptions(prev => ({ ...prev, includeGenerated: checked }))}","+                />","+              </div>","+            </div>","+","+            {/* Export Format Buttons */}","+            <div className=\"space-y-2\">","+              <p className=\"text-xs font-medium text-[var(--text-tertiary)]\">Export as:</p>","+              <div className=\"grid grid-cols-3 gap-2\">","+                <Button","+                  variant=\"outline\"","+                  className=\"flex flex-col items-center gap-1.5 h-auto py-3 rounded-xl border-[rgba(255,255,255,0.1)] hover:bg-[var(--bg-tertiary)] hover:border-sky-500/50\"","+                  onClick={() => onExportNotebook?.('zip', exportOptions)}","+                  disabled={exportingNotebook}","+                >","+                  {exportingNotebook ? (","+                    <SpinnerGap className=\"h-5 w-5 animate-spin text-[var(--text-tertiary)]\" weight=\"bold\" />","+                  ) : (","+                    <FileZip className=\"h-5 w-5 text-sky-500\" weight=\"duotone\" />","+                  )}","+                  <span className=\"text-xs font-medium text-[var(--text-primary)]\">ZIP</span>","+                </Button>","+                <Button","+                  variant=\"outline\"","+                  className=\"flex flex-col items-center gap-1.5 h-auto py-3 rounded-xl border-[rgba(255,255,255,0.1)] hover:bg-[var(--bg-tertiary)] hover:border-red-500/50\"","+                  onClick={() => onExportNotebook?.('pdf', exportOptions)}","+                  disabled={exportingNotebook}","+                >","+                  {exportingNotebook ? (","+                    <SpinnerGap className=\"h-5 w-5 animate-spin text-[var(--text-tertiary)]\" weight=\"bold\" />","+                  ) : (","+                    <FilePdf className=\"h-5 w-5 text-red-500\" weight=\"duotone\" />","+                  )}","+                  <span className=\"text-xs font-medium text-[var(--text-primary)]\">PDF</span>","+                </Button>","+                <Button","+                  variant=\"outline\"","+                  className=\"flex flex-col items-center gap-1.5 h-auto py-3 rounded-xl border-[rgba(255,255,255,0.1)] hover:bg-[var(--bg-tertiary)] hover:border-yellow-500/50\"","+                  onClick={() => onExportNotebook?.('json', exportOptions)}","+                  disabled={exportingNotebook}","+                >","+                  {exportingNotebook ? (","+                    <SpinnerGap className=\"h-5 w-5 animate-spin text-[var(--text-tertiary)]\" weight=\"bold\" />","+                  ) : (","+                    <FileJs className=\"h-5 w-5 text-yellow-500\" weight=\"duotone\" />","+                  )}","+                  <span className=\"text-xs font-medium text-[var(--text-primary)]\">JSON</span>","+                </Button>","+              </div>","+            </div>","+","+            <p className=\"text-xs text-[var(--text-tertiary)] text-center\">","+              ZIP includes all files. PDF is a summary document.","+            </p>","+          </div>","+        </StudioSection>","       </div>"," ","       {/* Generation Config Dialog */}"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"9836e460-95de-4337-ac78-c3c13c1aa79a"}
{"parentUuid":"deed3170-19dc-4d6e-8668-c28b6dee05b2","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","message":{"model":"claude-opus-4-5-20251101","id":"msg_016rrw24JNZmhAyTWSRTS1EU","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Now I need to add the ExportOptionToggle component at the end of the file. Let me add it after the MaterialButton component.","signature":"EqUCCkYICxgCKkApw40fM49cP/P1VR0iS+oWlX7FKUxMgi8p1Uypl5s0ErZs9lAnPZHZytK2hpSGDeCwtv5EcLJCyvOEwKbFrpnBEgwhgQ42/DiZYgHf3uoaDOLaXDA+k8Xs17nZ2SIwfP8gbcmqzdEsvT0hg4vDh0d6HZP05C7zJojUAquz74ovbmum10W4Yi0W5+iybdmFKowBFaaLX4GAOmQD0219VKI+IGCYkQyxxbXTWuvfyN0rX2MbMGpSM1mB9HPTGwETfrqivaDQdLfIjW7LqpgIKdxL+IRheGHy1oXOMy1yXRoNOJaAcNFZezvmT6qcQSNgr5XnlMrkblyjpNPZiQZ+zxlQeobStCanl+iQoiBx2FYCS1tG9omjdTLON223Q3AYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":4894,"cache_read_input_tokens":94952,"cache_creation":{"ephemeral_5m_input_tokens":4894,"ephemeral_1h_input_tokens":0},"output_tokens":5,"service_tier":"standard"}},"requestId":"req_011CWz6YNV8QjXGib6cZwWkB","type":"assistant","uuid":"5b81d287-5133-4ae1-8a59-cff1cfe8ee0c","timestamp":"2026-01-10T17:31:51.836Z"}
{"parentUuid":"5b81d287-5133-4ae1-8a59-cff1cfe8ee0c","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","message":{"model":"claude-opus-4-5-20251101","id":"msg_016rrw24JNZmhAyTWSRTS1EU","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Y2tggBovu1BPeA4mq11e6H","name":"Edit","input":{"replace_all":false,"file_path":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend/src/components/studio/studio-panel.tsx","old_string":"// Material Button\nfunction MaterialButton({\n  icon,\n  label,\n  onClick,\n}: {\n  icon: React.ReactNode\n  label: string\n  onClick?: () => void\n}) {\n  return (\n    <button\n      onClick={onClick}\n      className=\"w-full flex items-center gap-2 px-3 py-2 text-sm rounded-lg hover:bg-[var(--bg-tertiary)] transition-colors\"\n    >\n      {icon}\n      <span className=\"text-[var(--text-primary)]\">{label}</span>\n      <CaretRight className=\"h-4 w-4 ml-auto text-[var(--text-tertiary)]\" weight=\"bold\" />\n    </button>\n  )\n}","new_string":"// Material Button\nfunction MaterialButton({\n  icon,\n  label,\n  onClick,\n}: {\n  icon: React.ReactNode\n  label: string\n  onClick?: () => void\n}) {\n  return (\n    <button\n      onClick={onClick}\n      className=\"w-full flex items-center gap-2 px-3 py-2 text-sm rounded-lg hover:bg-[var(--bg-tertiary)] transition-colors\"\n    >\n      {icon}\n      <span className=\"text-[var(--text-primary)]\">{label}</span>\n      <CaretRight className=\"h-4 w-4 ml-auto text-[var(--text-tertiary)]\" weight=\"bold\" />\n    </button>\n  )\n}\n\n// Export Option Toggle\nfunction ExportOptionToggle({\n  label,\n  checked,\n  onChange,\n}: {\n  label: string\n  checked: boolean\n  onChange: (checked: boolean) => void\n}) {\n  return (\n    <button\n      onClick={() => onChange(!checked)}\n      className={`flex items-center gap-2 px-3 py-2 rounded-lg border transition-colors ${\n        checked\n          ? 'border-sky-500/50 bg-sky-500/10 text-[var(--text-primary)]'\n          : 'border-[rgba(255,255,255,0.1)] text-[var(--text-tertiary)] hover:bg-[var(--bg-tertiary)]'\n      }`}\n    >\n      <CheckSquare\n        className={`h-4 w-4 ${checked ? 'text-sky-500' : 'text-[var(--text-tertiary)]'}`}\n        weight={checked ? 'fill' : 'regular'}\n      />\n      <span className=\"text-xs font-medium\">{label}</span>\n    </button>\n  )\n}"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":4894,"cache_read_input_tokens":94952,"cache_creation":{"ephemeral_5m_input_tokens":4894,"ephemeral_1h_input_tokens":0},"output_tokens":822,"service_tier":"standard"}},"requestId":"req_011CWz6YNV8QjXGib6cZwWkB","type":"assistant","uuid":"eb73a445-9d7a-451a-9f43-fcbf50b414e1","timestamp":"2026-01-10T17:31:58.508Z"}
{"parentUuid":"eb73a445-9d7a-451a-9f43-fcbf50b414e1","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Y2tggBovu1BPeA4mq11e6H","type":"tool_result","content":"The file /Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend/src/components/studio/studio-panel.tsx has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n   925→    </button>\n   926→  )\n   927→}\n   928→\n   929→// Material Button\n   930→function MaterialButton({\n   931→  icon,\n   932→  label,\n   933→  onClick,\n   934→}: {\n   935→  icon: React.ReactNode\n   936→  label: string\n   937→  onClick?: () => void\n   938→}) {\n   939→  return (\n   940→    <button\n   941→      onClick={onClick}\n   942→      className=\"w-full flex items-center gap-2 px-3 py-2 text-sm rounded-lg hover:bg-[var(--bg-tertiary)] transition-colors\"\n   943→    >\n   944→      {icon}\n   945→      <span className=\"text-[var(--text-primary)]\">{label}</span>\n   946→      <CaretRight className=\"h-4 w-4 ml-auto text-[var(--text-tertiary)]\" weight=\"bold\" />\n   947→    </button>\n   948→  )\n   949→}\n   950→\n   951→// Export Option Toggle\n   952→function ExportOptionToggle({\n   953→  label,\n   954→  checked,\n   955→  onChange,\n   956→}: {\n   957→  label: string\n   958→  checked: boolean\n   959→  onChange: (checked: boolean) => void\n   960→}) {\n   961→  return (\n   962→    <button\n   963→      onClick={() => onChange(!checked)}\n   964→      className={`flex items-center gap-2 px-3 py-2 rounded-lg border transition-colors ${\n   965→        checked\n   966→          ? 'border-sky-500/50 bg-sky-500/10 text-[var(--text-primary)]'\n   967→          : 'border-[rgba(255,255,255,0.1)] text-[var(--text-tertiary)] hover:bg-[var(--bg-tertiary)]'\n   968→      }`}\n   969→    >\n   970→      <CheckSquare\n   971→        className={`h-4 w-4 ${checked ? 'text-sky-500' : 'text-[var(--text-tertiary)]'}`}\n   972→        weight={checked ? 'fill' : 'regular'}\n   973→      />\n   974→      <span className=\"text-xs font-medium\">{label}</span>\n   975→    </button>\n   976→  )\n   977→}\n   978→"}]},"uuid":"8dd78c50-1fac-4915-bf94-c2f1710538b2","timestamp":"2026-01-10T17:31:58.543Z","toolUseResult":{"filePath":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend/src/components/studio/studio-panel.tsx","oldString":"// Material Button\nfunction MaterialButton({\n  icon,\n  label,\n  onClick,\n}: {\n  icon: React.ReactNode\n  label: string\n  onClick?: () => void\n}) {\n  return (\n    <button\n      onClick={onClick}\n      className=\"w-full flex items-center gap-2 px-3 py-2 text-sm rounded-lg hover:bg-[var(--bg-tertiary)] transition-colors\"\n    >\n      {icon}\n      <span className=\"text-[var(--text-primary)]\">{label}</span>\n      <CaretRight className=\"h-4 w-4 ml-auto text-[var(--text-tertiary)]\" weight=\"bold\" />\n    </button>\n  )\n}","newString":"// Material Button\nfunction MaterialButton({\n  icon,\n  label,\n  onClick,\n}: {\n  icon: React.ReactNode\n  label: string\n  onClick?: () => void\n}) {\n  return (\n    <button\n      onClick={onClick}\n      className=\"w-full flex items-center gap-2 px-3 py-2 text-sm rounded-lg hover:bg-[var(--bg-tertiary)] transition-colors\"\n    >\n      {icon}\n      <span className=\"text-[var(--text-primary)]\">{label}</span>\n      <CaretRight className=\"h-4 w-4 ml-auto text-[var(--text-tertiary)]\" weight=\"bold\" />\n    </button>\n  )\n}\n\n// Export Option Toggle\nfunction ExportOptionToggle({\n  label,\n  checked,\n  onChange,\n}: {\n  label: string\n  checked: boolean\n  onChange: (checked: boolean) => void\n}) {\n  return (\n    <button\n      onClick={() => onChange(!checked)}\n      className={`flex items-center gap-2 px-3 py-2 rounded-lg border transition-colors ${\n        checked\n          ? 'border-sky-500/50 bg-sky-500/10 text-[var(--text-primary)]'\n          : 'border-[rgba(255,255,255,0.1)] text-[var(--text-tertiary)] hover:bg-[var(--bg-tertiary)]'\n      }`}\n    >\n      <CheckSquare\n        className={`h-4 w-4 ${checked ? 'text-sky-500' : 'text-[var(--text-tertiary)]'}`}\n        weight={checked ? 'fill' : 'regular'}\n      />\n      <span className=\"text-xs font-medium\">{label}</span>\n    </button>\n  )\n}","originalFile":"'use client'\n\nimport { useState } from 'react'\nimport { motion, AnimatePresence } from 'framer-motion'\nimport {\n  Microphone,\n  VideoCamera,\n  MagnifyingGlass,\n  GraduationCap,\n  CaretDown,\n  CaretRight,\n  Play,\n  SpinnerGap,\n  BookOpen,\n  ListChecks,\n  FileText,\n  Question,\n  Note,\n  Plus,\n  ShareNetwork,\n  ArrowsClockwise,\n  Clock,\n  WarningCircle,\n  Table,\n  ChartBar,\n  PresentationChart,\n  Image,\n  Palette,\n  Cards,\n  TreeStructure,\n  ChatCircleText,\n  Sparkle,\n  Export,\n  FilePdf,\n  FileZip,\n  FileJs,\n  CheckSquare\n} from '@phosphor-icons/react'\nimport { Button } from '@/components/ui/button'\nimport { Input } from '@/components/ui/input'\nimport { Textarea } from '@/components/ui/textarea'\nimport { Badge } from '@/components/ui/badge'\nimport { ScrollArea } from '@/components/ui/scroll-area'\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select'\nimport { Tooltip, TooltipContent, TooltipTrigger } from '@/components/ui/tooltip'\nimport { GenerationConfigDialog, GenerationType, GenerationConfig } from './generation-config-dialog'\n\n// Metadata for a generated study material\nexport interface StudyMaterialMeta {\n  id: string\n  type: string\n  sourceIds: string[]\n  sourceNames: string[]\n  createdAt: string\n  itemCount?: number\n}\n\n// Helper to format relative time\nfunction getTimeAgo(dateString: string): string {\n  const date = new Date(dateString)\n  const now = new Date()\n  const diffMs = now.getTime() - date.getTime()\n  const diffMins = Math.floor(diffMs / 60000)\n  const diffHours = Math.floor(diffMs / 3600000)\n  const diffDays = Math.floor(diffMs / 86400000)\n\n  if (diffMins < 1) return 'Just now'\n  if (diffMins < 60) return `${diffMins}m ago`\n  if (diffHours < 24) return `${diffHours}h ago`\n  if (diffDays < 7) return `${diffDays}d ago`\n  return date.toLocaleDateString()\n}\n\n// Source type for selection\nexport interface SourceInfo {\n  id: string\n  name: string\n}\n\ninterface StudioPanelProps {\n  notebookId: string\n  selectedSourcesCount: number\n  selectedSourceIds: string[]\n  sources?: SourceInfo[]\n  // Audio\n  audioFormat: string\n  onAudioFormatChange: (format: string) => void\n  audioInstructions: string\n  onAudioInstructionsChange: (instructions: string) => void\n  onGenerateAudio: () => void\n  generatingAudio: boolean\n  // Video\n  videoStyle: string\n  onVideoStyleChange: (style: string) => void\n  onGenerateVideo: () => void\n  generatingVideo: boolean\n  // Research\n  researchQuery: string\n  onResearchQueryChange: (query: string) => void\n  researchMode: string\n  onResearchModeChange: (mode: string) => void\n  onRunResearch: () => void\n  researching: boolean\n  // Study - now accepts config\n  onGenerateStudyMaterial: (config: GenerationConfig) => void\n  generatingFlashcards: boolean\n  generatingQuiz: boolean\n  generatingStudyGuide: boolean\n  generatingFaq: boolean\n  generatingMindMap: boolean\n  // Creative Outputs - now accepts config\n  onGenerateCreativeOutput?: (config: GenerationConfig) => void\n  generatingDataTable?: boolean\n  generatingReport?: boolean\n  generatingSlideDeck?: boolean\n  generatingInfographic?: boolean\n  // Creative outputs results\n  creativeOutputs?: Array<{\n    id: string\n    type: string\n    title: string\n    status: string\n    createdAt: string\n  }>\n  onOpenCreativeOutput?: (type: string) => void\n  // Results - now with metadata\n  studyMaterials?: StudyMaterialMeta[]\n  onOpenStudyMaterial?: (type: string) => void\n  // Notes\n  notesCount?: number\n  onAddNote?: () => void\n  onOpenNotes?: () => void\n  // Generated content\n  hasGeneratedAudio?: boolean\n  hasGeneratedVideo?: boolean\n  hasGeneratedResearch?: boolean\n  onOpenAudio?: () => void\n  onOpenVideo?: () => void\n  onOpenResearch?: () => void\n  // Export\n  onExportNotebook?: (format: 'zip' | 'pdf' | 'json', options: ExportOptionsState) => void\n  exportingNotebook?: boolean\n}\n\n// Export options state type\nexport interface ExportOptionsState {\n  includeSources: boolean\n  includeChats: boolean\n  includeNotes: boolean\n  includeGenerated: boolean\n}\n\nexport function StudioPanel({\n  notebookId,\n  selectedSourcesCount,\n  selectedSourceIds,\n  sources = [],\n  audioFormat,\n  onAudioFormatChange,\n  audioInstructions,\n  onAudioInstructionsChange,\n  onGenerateAudio,\n  generatingAudio,\n  videoStyle,\n  onVideoStyleChange,\n  onGenerateVideo,\n  generatingVideo,\n  researchQuery,\n  onResearchQueryChange,\n  researchMode,\n  onResearchModeChange,\n  onRunResearch,\n  researching,\n  onGenerateStudyMaterial,\n  generatingFlashcards,\n  generatingQuiz,\n  generatingStudyGuide,\n  generatingFaq,\n  generatingMindMap,\n  onGenerateCreativeOutput,\n  generatingDataTable = false,\n  generatingReport = false,\n  generatingSlideDeck = false,\n  generatingInfographic = false,\n  creativeOutputs = [],\n  onOpenCreativeOutput,\n  studyMaterials = [],\n  onOpenStudyMaterial,\n  notesCount = 0,\n  onAddNote,\n  onOpenNotes,\n  hasGeneratedAudio = false,\n  hasGeneratedVideo = false,\n  hasGeneratedResearch = false,\n  onOpenAudio,\n  onOpenVideo,\n  onOpenResearch,\n  onExportNotebook,\n  exportingNotebook = false,\n}: StudioPanelProps) {\n  const [expandedSection, setExpandedSection] = useState<string | null>('audio')\n  const [configDialogOpen, setConfigDialogOpen] = useState(false)\n  const [configDialogType, setConfigDialogType] = useState<GenerationType>('flashcards')\n  const [exportOptions, setExportOptions] = useState<ExportOptionsState>({\n    includeSources: true,\n    includeChats: true,\n    includeNotes: true,\n    includeGenerated: true,\n  })\n\n  // Open config dialog for a specific type\n  const openConfigDialog = (type: GenerationType) => {\n    setConfigDialogType(type)\n    setConfigDialogOpen(true)\n  }\n\n  // Handle generation from config dialog\n  const handleGenerate = (config: GenerationConfig) => {\n    setConfigDialogOpen(false)\n\n    // Route to appropriate handler based on type\n    const studyTypes = ['flashcards', 'quiz', 'study-guide', 'faq', 'mind-map']\n    if (studyTypes.includes(config.type)) {\n      onGenerateStudyMaterial(config)\n    } else {\n      onGenerateCreativeOutput?.(config)\n    }\n  }\n\n  // Check if currently generating for a type\n  const isGenerating = (type: GenerationType): boolean => {\n    switch (type) {\n      case 'flashcards': return generatingFlashcards\n      case 'quiz': return generatingQuiz\n      case 'study-guide': return generatingStudyGuide\n      case 'faq': return generatingFaq\n      case 'mind-map': return generatingMindMap\n      case 'data_table': return generatingDataTable\n      case 'report': return generatingReport\n      case 'slide_deck': return generatingSlideDeck\n      case 'infographic': return generatingInfographic\n      default: return false\n    }\n  }\n\n  const toggleSection = (section: string) => {\n    setExpandedSection(expandedSection === section ? null : section)\n  }\n\n  // Check if a material's sources match current selection\n  const isMaterialStale = (material: StudyMaterialMeta) => {\n    const sortedMaterialIds = [...material.sourceIds].sort()\n    const sortedSelectedIds = [...selectedSourceIds].sort()\n    if (sortedMaterialIds.length !== sortedSelectedIds.length) return true\n    return !sortedMaterialIds.every((id, idx) => id === sortedSelectedIds[idx])\n  }\n\n  // Format relative time\n  const formatTimeAgo = (dateStr: string) => {\n    const date = new Date(dateStr)\n    const now = new Date()\n    const diffMs = now.getTime() - date.getTime()\n    const diffMins = Math.floor(diffMs / 60000)\n    const diffHours = Math.floor(diffMins / 60)\n    const diffDays = Math.floor(diffHours / 24)\n\n    if (diffMins < 1) return 'Just now'\n    if (diffMins < 60) return `${diffMins}m ago`\n    if (diffHours < 24) return `${diffHours}h ago`\n    if (diffDays < 7) return `${diffDays}d ago`\n    return date.toLocaleDateString()\n  }\n\n  // Get material by type\n  const getMaterial = (type: string) => studyMaterials.find(m => m.type === type)\n\n  return (\n    <ScrollArea className=\"h-full\">\n      <div className=\"p-4 space-y-3\">\n        {/* Audio Overview Section */}\n        <StudioSection\n          id=\"audio\"\n          title=\"Audio Overview\"\n          subtitle=\"Podcast-style discussion\"\n          icon={<Microphone className=\"h-5 w-5\" weight=\"duotone\" />}\n          iconGradient=\"from-orange-500/20 to-red-500/20\"\n          iconColor=\"text-orange-500\"\n          expanded={expandedSection === 'audio'}\n          onToggle={() => toggleSection('audio')}\n        >\n          <div className=\"space-y-3\">\n            <div className=\"space-y-1.5\">\n              <label className=\"text-xs font-medium text-[var(--text-primary)]\">Format</label>\n              <Select value={audioFormat} onValueChange={onAudioFormatChange}>\n                <SelectTrigger className=\"h-9 text-sm bg-[var(--bg-tertiary)] border-[rgba(255,255,255,0.1)] rounded-lg\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent className=\"bg-[var(--bg-secondary)] border-[rgba(255,255,255,0.1)]\">\n                  <SelectItem value=\"deep_dive\">Deep Dive (10-15 min)</SelectItem>\n                  <SelectItem value=\"brief\">Brief Summary (2-3 min)</SelectItem>\n                  <SelectItem value=\"critique\">Analytical (5-10 min)</SelectItem>\n                  <SelectItem value=\"debate\">Debate (8-15 min)</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n            <div className=\"space-y-1.5\">\n              <label className=\"text-xs font-medium text-[var(--text-primary)]\">Custom Instructions</label>\n              <Textarea\n                placeholder=\"Optional instructions for hosts...\"\n                value={audioInstructions}\n                onChange={(e) => onAudioInstructionsChange(e.target.value)}\n                rows={2}\n                className=\"text-sm resize-none bg-[var(--bg-tertiary)] border-[rgba(255,255,255,0.1)] text-[var(--text-primary)] placeholder:text-[var(--text-tertiary)] focus:border-[var(--accent-primary)] rounded-lg\"\n              />\n            </div>\n            <div className=\"flex gap-2\">\n              <Button\n                className=\"flex-1 rounded-lg bg-orange-500 hover:bg-orange-500/90 text-white\"\n                onClick={onGenerateAudio}\n                disabled={generatingAudio || selectedSourcesCount === 0}\n              >\n                {generatingAudio ? (\n                  <SpinnerGap className=\"h-4 w-4 mr-2 animate-spin\" weight=\"bold\" />\n                ) : (\n                  <Play className=\"h-4 w-4 mr-2\" />\n                )}\n                Generate\n              </Button>\n              {hasGeneratedAudio && onOpenAudio && (\n                <Button\n                  variant=\"outline\"\n                  className=\"rounded-lg border-orange-500/30 text-orange-500 hover:bg-orange-500/10\"\n                  onClick={onOpenAudio}\n                >\n                  View\n                  <CaretRight className=\"h-4 w-4 ml-1\" weight=\"bold\" />\n                </Button>\n              )}\n            </div>\n            {selectedSourcesCount === 0 && (\n              <p className=\"text-xs text-[var(--text-tertiary)] text-center\">\n                Select sources to generate\n              </p>\n            )}\n          </div>\n        </StudioSection>\n\n        {/* Video Overview Section */}\n        <StudioSection\n          id=\"video\"\n          title=\"Video Overview\"\n          subtitle=\"AI-generated video clip\"\n          icon={<VideoCamera className=\"h-5 w-5\" weight=\"duotone\" />}\n          iconGradient=\"from-purple-500/20 to-pink-500/20\"\n          iconColor=\"text-purple-500\"\n          expanded={expandedSection === 'video'}\n          onToggle={() => toggleSection('video')}\n        >\n          <div className=\"space-y-3\">\n            <div className=\"space-y-1.5\">\n              <label className=\"text-xs font-medium text-[var(--text-primary)]\">Style</label>\n              <Select value={videoStyle} onValueChange={onVideoStyleChange}>\n                <SelectTrigger className=\"h-9 text-sm bg-[var(--bg-tertiary)] border-[rgba(255,255,255,0.1)] rounded-lg\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent className=\"bg-[var(--bg-secondary)] border-[rgba(255,255,255,0.1)]\">\n                  <SelectItem value=\"explainer\">Explainer (5s)</SelectItem>\n                  <SelectItem value=\"documentary\">Documentary (10s)</SelectItem>\n                  <SelectItem value=\"presentation\">Presentation (5s)</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n            <p className=\"text-xs text-[var(--text-tertiary)]\">\n              Generates an AI video clip using Wan 2.5. Estimated cost: ~$0.10-0.20\n            </p>\n            <div className=\"flex gap-2\">\n              <Button\n                className=\"flex-1 rounded-lg bg-purple-500 hover:bg-purple-500/90 text-white\"\n                onClick={onGenerateVideo}\n                disabled={generatingVideo || selectedSourcesCount === 0}\n              >\n                {generatingVideo ? (\n                  <SpinnerGap className=\"h-4 w-4 mr-2 animate-spin\" weight=\"bold\" />\n                ) : (\n                  <VideoCamera className=\"h-4 w-4 mr-2\" weight=\"duotone\" />\n                )}\n                {generatingVideo ? 'Generating...' : 'Generate Video'}\n              </Button>\n              {hasGeneratedVideo && onOpenVideo && (\n                <Button\n                  variant=\"outline\"\n                  className=\"rounded-lg border-purple-500/30 text-purple-500 hover:bg-purple-500/10\"\n                  onClick={onOpenVideo}\n                >\n                  View\n                  <CaretRight className=\"h-4 w-4 ml-1\" weight=\"bold\" />\n                </Button>\n              )}\n            </div>\n            {selectedSourcesCount === 0 && (\n              <p className=\"text-xs text-[var(--text-tertiary)] text-center\">\n                Select sources to generate\n              </p>\n            )}\n          </div>\n        </StudioSection>\n\n        {/* Deep Research Section */}\n        <StudioSection\n          id=\"research\"\n          title=\"Deep Research\"\n          subtitle=\"Autonomous web research\"\n          icon={<MagnifyingGlass className=\"h-5 w-5\" weight=\"duotone\" />}\n          iconGradient=\"from-blue-500/20 to-cyan-500/20\"\n          iconColor=\"text-blue-500\"\n          expanded={expandedSection === 'research'}\n          onToggle={() => toggleSection('research')}\n        >\n          <div className=\"space-y-3\">\n            <div className=\"space-y-1.5\">\n              <label className=\"text-xs font-medium text-[var(--text-primary)]\">Research Query</label>\n              <Input\n                placeholder=\"What would you like to research?\"\n                value={researchQuery}\n                onChange={(e) => onResearchQueryChange(e.target.value)}\n                className=\"h-9 text-sm bg-[var(--bg-tertiary)] border-[rgba(255,255,255,0.1)] text-[var(--text-primary)] placeholder:text-[var(--text-tertiary)] focus:border-[var(--accent-primary)] rounded-lg\"\n              />\n            </div>\n            <div className=\"space-y-1.5\">\n              <label className=\"text-xs font-medium text-[var(--text-primary)]\">Mode</label>\n              <Select value={researchMode} onValueChange={onResearchModeChange}>\n                <SelectTrigger className=\"h-9 text-sm bg-[var(--bg-tertiary)] border-[rgba(255,255,255,0.1)] rounded-lg\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent className=\"bg-[var(--bg-secondary)] border-[rgba(255,255,255,0.1)]\">\n                  <SelectItem value=\"fast\">Fast (3-5 min)</SelectItem>\n                  <SelectItem value=\"deep\">Deep (10-15 min)</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n            <div className=\"flex gap-2\">\n              <Button\n                className=\"flex-1 rounded-lg bg-blue-500 hover:bg-blue-500/90 text-white\"\n                onClick={onRunResearch}\n                disabled={researching || !researchQuery.trim()}\n              >\n                {researching ? (\n                  <SpinnerGap className=\"h-4 w-4 mr-2 animate-spin\" weight=\"bold\" />\n                ) : (\n                  <MagnifyingGlass className=\"h-4 w-4 mr-2\" weight=\"duotone\" />\n                )}\n                Research\n              </Button>\n              {hasGeneratedResearch && onOpenResearch && (\n                <Button\n                  variant=\"outline\"\n                  className=\"rounded-lg border-blue-500/30 text-blue-500 hover:bg-blue-500/10\"\n                  onClick={onOpenResearch}\n                >\n                  View\n                  <CaretRight className=\"h-4 w-4 ml-1\" weight=\"bold\" />\n                </Button>\n              )}\n            </div>\n          </div>\n        </StudioSection>\n\n        {/* Study Materials Section */}\n        <StudioSection\n          id=\"study\"\n          title=\"Study Materials\"\n          subtitle=\"Flashcards, quizzes, and more\"\n          icon={<GraduationCap className=\"h-5 w-5\" />}\n          iconGradient=\"from-emerald-500/20 to-teal-500/20\"\n          iconColor=\"text-emerald-500\"\n          expanded={expandedSection === 'study'}\n          onToggle={() => toggleSection('study')}\n        >\n          <div className=\"space-y-4\">\n            {/* Study Tools Grid */}\n            <div className=\"grid grid-cols-2 gap-2\">\n              <StudyToolButton\n                icon={<BookOpen className=\"h-5 w-5\" />}\n                label=\"Flashcards\"\n                color=\"text-blue-500\"\n                onClick={() => openConfigDialog('flashcards')}\n                loading={generatingFlashcards}\n                disabled={selectedSourcesCount === 0}\n              />\n              <StudyToolButton\n                icon={<ListChecks className=\"h-5 w-5\" />}\n                label=\"Quiz\"\n                color=\"text-purple-500\"\n                onClick={() => openConfigDialog('quiz')}\n                loading={generatingQuiz}\n                disabled={selectedSourcesCount === 0}\n              />\n              <StudyToolButton\n                icon={<FileText className=\"h-5 w-5\" />}\n                label=\"Study Guide\"\n                color=\"text-orange-500\"\n                onClick={() => openConfigDialog('study-guide')}\n                loading={generatingStudyGuide}\n                disabled={selectedSourcesCount === 0}\n              />\n              <StudyToolButton\n                icon={<Question className=\"h-5 w-5\" weight=\"duotone\" />}\n                label=\"FAQ\"\n                color=\"text-teal-500\"\n                onClick={() => openConfigDialog('faq')}\n                loading={generatingFaq}\n                disabled={selectedSourcesCount === 0}\n              />\n              <StudyToolButton\n                icon={<TreeStructure className=\"h-5 w-5\" weight=\"duotone\" />}\n                label=\"Mind Map\"\n                color=\"text-cyan-500\"\n                onClick={() => openConfigDialog('mind-map')}\n                loading={generatingMindMap}\n                disabled={selectedSourcesCount === 0}\n              />\n            </div>\n\n            {selectedSourcesCount === 0 && (\n              <p className=\"text-xs text-[var(--text-tertiary)] text-center\">\n                Select sources to generate study materials\n              </p>\n            )}\n\n            {/* Generated Materials */}\n            {studyMaterials.length > 0 && (\n              <div className=\"pt-3 border-t border-[rgba(255,255,255,0.1)]\">\n                <p className=\"text-xs font-medium text-[var(--text-tertiary)] mb-2\">Generated Materials</p>\n                <div className=\"space-y-2\">\n                  {studyMaterials.map((material) => {\n                    const isStale = isMaterialStale(material)\n                    const iconMap: Record<string, { icon: React.ReactNode; color: string; label: string }> = {\n                      flashcards: { icon: <BookOpen className=\"h-4 w-4\" />, color: 'text-blue-500', label: `${material.itemCount || 0} Flashcards` },\n                      quiz: { icon: <ListChecks className=\"h-4 w-4\" />, color: 'text-purple-500', label: `${material.itemCount || 0} Quiz Questions` },\n                      study_guide: { icon: <FileText className=\"h-4 w-4\" />, color: 'text-orange-500', label: 'Study Guide' },\n                      faq: { icon: <ChatCircleText className=\"h-4 w-4\" weight=\"duotone\" />, color: 'text-teal-500', label: `${material.itemCount || 0} FAQ Items` },\n                      mind_map: { icon: <TreeStructure className=\"h-4 w-4\" weight=\"duotone\" />, color: 'text-cyan-500', label: 'Mind Map' },\n                    }\n                    const info = iconMap[material.type] || { icon: <FileText className=\"h-4 w-4\" />, color: 'text-gray-500', label: material.type }\n\n                    return (\n                      <div\n                        key={material.id}\n                        className={`rounded-lg border ${isStale ? 'border-amber-500/30 bg-amber-500/5' : 'border-[rgba(255,255,255,0.1)]'} overflow-hidden`}\n                      >\n                        <button\n                          onClick={() => onOpenStudyMaterial?.(material.type)}\n                          className=\"w-full flex items-center gap-2 px-3 py-2 text-sm hover:bg-[var(--bg-tertiary)] transition-colors\"\n                        >\n                          <span className={info.color}>{info.icon}</span>\n                          <span className=\"text-[var(--text-primary)] flex-1 text-left\">{info.label}</span>\n                          {isStale && (\n                            <Tooltip>\n                              <TooltipTrigger asChild>\n                                <WarningCircle className=\"h-3.5 w-3.5 text-amber-500\" weight=\"fill\" />\n                              </TooltipTrigger>\n                              <TooltipContent>\n                                <p>Sources changed - regenerate for updated content</p>\n                              </TooltipContent>\n                            </Tooltip>\n                          )}\n                          <CaretRight className=\"h-4 w-4 text-[var(--text-tertiary)]\" weight=\"bold\" />\n                        </button>\n                        <div className=\"px-3 py-1.5 bg-[var(--bg-tertiary)]/50 border-t border-[rgba(255,255,255,0.05)] flex items-center gap-3 text-[10px] text-[var(--text-tertiary)]\">\n                          <span className=\"flex items-center gap-1\">\n                            <Clock className=\"h-3 w-3\" />\n                            {formatTimeAgo(material.createdAt)}\n                          </span>\n                          <span>•</span>\n                          <span className=\"truncate\">\n                            {material.sourceNames.length === 1\n                              ? material.sourceNames[0]\n                              : `${material.sourceNames.length} sources`}\n                          </span>\n                        </div>\n                      </div>\n                    )\n                  })}\n                </div>\n              </div>\n            )}\n          </div>\n        </StudioSection>\n\n        {/* Creative Outputs Section */}\n        <StudioSection\n          id=\"creative\"\n          title=\"Creative Outputs\"\n          subtitle=\"Tables, reports, slides, infographics\"\n          icon={<Palette className=\"h-5 w-5\" />}\n          iconGradient=\"from-pink-500/20 to-rose-500/20\"\n          iconColor=\"text-pink-500\"\n          expanded={expandedSection === 'creative'}\n          onToggle={() => toggleSection('creative')}\n        >\n          <div className=\"space-y-4\">\n            {/* Creative Tools Grid */}\n            <div className=\"grid grid-cols-2 gap-2\">\n              <StudyToolButton\n                icon={<Table className=\"h-5 w-5\" />}\n                label=\"Data Table\"\n                color=\"text-emerald-500\"\n                onClick={() => openConfigDialog('data_table')}\n                loading={generatingDataTable}\n                disabled={selectedSourcesCount === 0}\n              />\n              <StudyToolButton\n                icon={<Palette className=\"h-5 w-5\" weight=\"duotone\" />}\n                label=\"Report\"\n                color=\"text-blue-500\"\n                onClick={() => openConfigDialog('report')}\n                loading={generatingReport}\n                disabled={selectedSourcesCount === 0}\n              />\n              <StudyToolButton\n                icon={<PresentationChart className=\"h-5 w-5\" />}\n                label=\"Slide Deck\"\n                color=\"text-violet-500\"\n                onClick={() => openConfigDialog('slide_deck')}\n                loading={generatingSlideDeck}\n                disabled={selectedSourcesCount === 0}\n              />\n              <StudyToolButton\n                icon={<Image className=\"h-5 w-5\" />}\n                label=\"Infographic\"\n                color=\"text-rose-500\"\n                onClick={() => openConfigDialog('infographic')}\n                loading={generatingInfographic}\n                disabled={selectedSourcesCount === 0}\n              />\n            </div>\n\n            {selectedSourcesCount === 0 && (\n              <p className=\"text-xs text-[var(--text-tertiary)] text-center\">\n                Select sources to generate creative outputs\n              </p>\n            )}\n\n            {/* Generated Outputs */}\n            {creativeOutputs.length > 0 && (\n              <div className=\"mt-4 pt-4 border-t border-[rgba(255,255,255,0.1)]\">\n                <p className=\"text-xs font-medium text-[var(--text-tertiary)] mb-3\">Generated Outputs</p>\n                <div className=\"space-y-2\">\n                  {creativeOutputs.map((output) => {\n                    const typeConfig: Record<string, { icon: React.ReactNode; label: string; color: string }> = {\n                      data_table: { icon: <Table className=\"h-4 w-4\" />, label: 'Data Table', color: 'text-emerald-500' },\n                      report: { icon: <ChartBar className=\"h-4 w-4\" weight=\"duotone\" />, label: 'Report', color: 'text-blue-500' },\n                      slide_deck: { icon: <PresentationChart className=\"h-4 w-4\" />, label: 'Slide Deck', color: 'text-violet-500' },\n                      infographic: { icon: <Image className=\"h-4 w-4\" />, label: 'Infographic', color: 'text-rose-500' },\n                    }\n                    const config = typeConfig[output.type] || { icon: <FileText className=\"h-4 w-4\" />, label: output.type, color: 'text-gray-500' }\n                    const timeAgo = getTimeAgo(output.createdAt)\n\n                    return (\n                      <button\n                        key={output.id}\n                        onClick={() => onOpenCreativeOutput?.(output.type)}\n                        className=\"w-full flex items-center gap-3 p-3 rounded-xl bg-[var(--bg-tertiary)] hover:bg-[var(--bg-tertiary)]/80 transition-colors text-left\"\n                      >\n                        <div className={`${config.color}`}>{config.icon}</div>\n                        <div className=\"flex-1 min-w-0\">\n                          <p className=\"text-sm font-medium text-[var(--text-primary)] truncate\">{config.label}</p>\n                          <p className=\"text-xs text-[var(--text-tertiary)]\">{timeAgo}</p>\n                        </div>\n                        <CaretRight className=\"h-4 w-4 text-[var(--text-tertiary)]\" weight=\"bold\" />\n                      </button>\n                    )\n                  })}\n                </div>\n              </div>\n            )}\n          </div>\n        </StudioSection>\n\n        {/* Notes Section */}\n        <StudioSection\n          id=\"notes\"\n          title=\"Notes\"\n          subtitle={`${notesCount} saved`}\n          icon={<Note className=\"h-5 w-5\" weight=\"duotone\" />}\n          iconGradient=\"from-amber-500/20 to-yellow-500/20\"\n          iconColor=\"text-amber-500\"\n          expanded={expandedSection === 'notes'}\n          onToggle={() => toggleSection('notes')}\n          action={\n            <Button\n              size=\"sm\"\n              variant=\"ghost\"\n              className=\"h-7 w-7 p-0\"\n              onClick={(e) => {\n                e.stopPropagation()\n                onAddNote?.()\n              }}\n            >\n              <Plus className=\"h-3.5 w-3.5\" />\n            </Button>\n          }\n        >\n          <div className=\"space-y-3\">\n            {notesCount === 0 ? (\n              <div className=\"text-center py-6\">\n                <Note className=\"h-8 w-8 mx-auto mb-2 text-[var(--text-tertiary)]/50\" weight=\"duotone\" />\n                <p className=\"text-sm text-[var(--text-tertiary)]\">No notes yet</p>\n                <p className=\"text-xs text-[var(--text-tertiary)] mt-1\">Create notes or save chat responses</p>\n              </div>\n            ) : (\n              <Button\n                variant=\"outline\"\n                className=\"w-full justify-start rounded-lg border-[rgba(255,255,255,0.1)] text-[var(--text-primary)] hover:bg-[var(--bg-tertiary)]\"\n                onClick={onOpenNotes}\n              >\n                <Note className=\"h-4 w-4 mr-2 text-amber-500\" weight=\"duotone\" />\n                View All Notes ({notesCount})\n                <CaretRight className=\"h-4 w-4 ml-auto text-[var(--text-tertiary)]\" weight=\"bold\" />\n              </Button>\n            )}\n          </div>\n        </StudioSection>\n\n        {/* Export Section */}\n        <StudioSection\n          id=\"export\"\n          title=\"Export Notebook\"\n          subtitle=\"Download all content\"\n          icon={<Export className=\"h-5 w-5\" weight=\"duotone\" />}\n          iconGradient=\"from-sky-500/20 to-indigo-500/20\"\n          iconColor=\"text-sky-500\"\n          expanded={expandedSection === 'export'}\n          onToggle={() => toggleSection('export')}\n        >\n          <div className=\"space-y-4\">\n            {/* Export Options */}\n            <div className=\"space-y-2\">\n              <p className=\"text-xs font-medium text-[var(--text-tertiary)]\">Include in export:</p>\n              <div className=\"grid grid-cols-2 gap-2\">\n                <ExportOptionToggle\n                  label=\"Sources\"\n                  checked={exportOptions.includeSources}\n                  onChange={(checked) => setExportOptions(prev => ({ ...prev, includeSources: checked }))}\n                />\n                <ExportOptionToggle\n                  label=\"Chats\"\n                  checked={exportOptions.includeChats}\n                  onChange={(checked) => setExportOptions(prev => ({ ...prev, includeChats: checked }))}\n                />\n                <ExportOptionToggle\n                  label=\"Notes\"\n                  checked={exportOptions.includeNotes}\n                  onChange={(checked) => setExportOptions(prev => ({ ...prev, includeNotes: checked }))}\n                />\n                <ExportOptionToggle\n                  label=\"Generated\"\n                  checked={exportOptions.includeGenerated}\n                  onChange={(checked) => setExportOptions(prev => ({ ...prev, includeGenerated: checked }))}\n                />\n              </div>\n            </div>\n\n            {/* Export Format Buttons */}\n            <div className=\"space-y-2\">\n              <p className=\"text-xs font-medium text-[var(--text-tertiary)]\">Export as:</p>\n              <div className=\"grid grid-cols-3 gap-2\">\n                <Button\n                  variant=\"outline\"\n                  className=\"flex flex-col items-center gap-1.5 h-auto py-3 rounded-xl border-[rgba(255,255,255,0.1)] hover:bg-[var(--bg-tertiary)] hover:border-sky-500/50\"\n                  onClick={() => onExportNotebook?.('zip', exportOptions)}\n                  disabled={exportingNotebook}\n                >\n                  {exportingNotebook ? (\n                    <SpinnerGap className=\"h-5 w-5 animate-spin text-[var(--text-tertiary)]\" weight=\"bold\" />\n                  ) : (\n                    <FileZip className=\"h-5 w-5 text-sky-500\" weight=\"duotone\" />\n                  )}\n                  <span className=\"text-xs font-medium text-[var(--text-primary)]\">ZIP</span>\n                </Button>\n                <Button\n                  variant=\"outline\"\n                  className=\"flex flex-col items-center gap-1.5 h-auto py-3 rounded-xl border-[rgba(255,255,255,0.1)] hover:bg-[var(--bg-tertiary)] hover:border-red-500/50\"\n                  onClick={() => onExportNotebook?.('pdf', exportOptions)}\n                  disabled={exportingNotebook}\n                >\n                  {exportingNotebook ? (\n                    <SpinnerGap className=\"h-5 w-5 animate-spin text-[var(--text-tertiary)]\" weight=\"bold\" />\n                  ) : (\n                    <FilePdf className=\"h-5 w-5 text-red-500\" weight=\"duotone\" />\n                  )}\n                  <span className=\"text-xs font-medium text-[var(--text-primary)]\">PDF</span>\n                </Button>\n                <Button\n                  variant=\"outline\"\n                  className=\"flex flex-col items-center gap-1.5 h-auto py-3 rounded-xl border-[rgba(255,255,255,0.1)] hover:bg-[var(--bg-tertiary)] hover:border-yellow-500/50\"\n                  onClick={() => onExportNotebook?.('json', exportOptions)}\n                  disabled={exportingNotebook}\n                >\n                  {exportingNotebook ? (\n                    <SpinnerGap className=\"h-5 w-5 animate-spin text-[var(--text-tertiary)]\" weight=\"bold\" />\n                  ) : (\n                    <FileJs className=\"h-5 w-5 text-yellow-500\" weight=\"duotone\" />\n                  )}\n                  <span className=\"text-xs font-medium text-[var(--text-primary)]\">JSON</span>\n                </Button>\n              </div>\n            </div>\n\n            <p className=\"text-xs text-[var(--text-tertiary)] text-center\">\n              ZIP includes all files. PDF is a summary document.\n            </p>\n          </div>\n        </StudioSection>\n      </div>\n\n      {/* Generation Config Dialog */}\n      <GenerationConfigDialog\n        open={configDialogOpen}\n        onOpenChange={setConfigDialogOpen}\n        type={configDialogType}\n        sources={sources}\n        onGenerate={handleGenerate}\n        isGenerating={isGenerating(configDialogType)}\n      />\n    </ScrollArea>\n  )\n}\n\n// Studio Section Component\nfunction StudioSection({\n  id,\n  title,\n  subtitle,\n  icon,\n  iconGradient,\n  iconColor,\n  expanded,\n  onToggle,\n  action,\n  children,\n}: {\n  id: string\n  title: string\n  subtitle: string\n  icon: React.ReactNode\n  iconGradient: string\n  iconColor: string\n  expanded: boolean\n  onToggle: () => void\n  action?: React.ReactNode\n  children: React.ReactNode\n}) {\n  return (\n    <div className=\"glass-card rounded-2xl overflow-hidden\">\n      <div className=\"flex items-center justify-between p-4 hover:bg-white/[0.02] transition-all duration-200 group\">\n        <button\n          onClick={onToggle}\n          className=\"flex items-center gap-3 flex-1\"\n        >\n          <div className={`relative w-10 h-10 rounded-xl bg-gradient-to-br ${iconGradient} flex items-center justify-center shadow-lg`}>\n            <div className=\"absolute inset-0 rounded-xl bg-gradient-to-br from-white/10 to-transparent\" />\n            <span className={`relative z-10 ${iconColor}`}>{icon}</span>\n          </div>\n          <div className=\"text-left\">\n            <p className=\"font-medium text-sm text-[var(--text-primary)] group-hover:text-white transition-colors\">{title}</p>\n            <p className=\"text-xs text-[var(--text-tertiary)]\">{subtitle}</p>\n          </div>\n        </button>\n        <div className=\"flex items-center gap-2\">\n          {action}\n          <button onClick={onToggle} className=\"p-1.5 rounded-lg hover:bg-white/5 transition-colors\">\n            <CaretDown weight=\"bold\" className={`h-4 w-4 text-[var(--text-tertiary)] transition-transform duration-200 ${expanded ? 'rotate-180' : ''}`} />\n          </button>\n        </div>\n      </div>\n\n      <AnimatePresence>\n        {expanded && (\n          <motion.div\n            initial={{ height: 0, opacity: 0 }}\n            animate={{ height: 'auto', opacity: 1 }}\n            exit={{ height: 0, opacity: 0 }}\n            transition={{ duration: 0.2 }}\n            className=\"overflow-hidden\"\n          >\n            <div className=\"px-4 pb-4 pt-2 border-t border-[rgba(255,255,255,0.1)] bg-[var(--bg-tertiary)]/30\">\n              {children}\n            </div>\n          </motion.div>\n        )}\n      </AnimatePresence>\n    </div>\n  )\n}\n\n// Study Tool Button\nfunction StudyToolButton({\n  icon,\n  label,\n  color,\n  onClick,\n  loading,\n  disabled,\n}: {\n  icon: React.ReactNode\n  label: string\n  color: string\n  onClick: () => void\n  loading: boolean\n  disabled: boolean\n}) {\n  return (\n    <button\n      onClick={onClick}\n      disabled={disabled || loading}\n      className=\"flex flex-col items-center gap-2 p-4 rounded-xl border border-[rgba(255,255,255,0.1)] bg-[var(--bg-secondary)] hover:bg-[var(--bg-tertiary)]/50 transition-colors disabled:opacity-50 disabled:cursor-not-allowed\"\n    >\n      {loading ? (\n        <SpinnerGap className=\"h-5 w-5 animate-spin text-[var(--text-tertiary)]\" weight=\"bold\" />\n      ) : (\n        <span className={color}>{icon}</span>\n      )}\n      <span className=\"text-xs font-medium text-[var(--text-primary)]\">{label}</span>\n    </button>\n  )\n}\n\n// Material Button\nfunction MaterialButton({\n  icon,\n  label,\n  onClick,\n}: {\n  icon: React.ReactNode\n  label: string\n  onClick?: () => void\n}) {\n  return (\n    <button\n      onClick={onClick}\n      className=\"w-full flex items-center gap-2 px-3 py-2 text-sm rounded-lg hover:bg-[var(--bg-tertiary)] transition-colors\"\n    >\n      {icon}\n      <span className=\"text-[var(--text-primary)]\">{label}</span>\n      <CaretRight className=\"h-4 w-4 ml-auto text-[var(--text-tertiary)]\" weight=\"bold\" />\n    </button>\n  )\n}\n","structuredPatch":[{"oldStart":947,"oldLines":3,"newStart":947,"newLines":31,"lines":["     </button>","   )"," }","+","+// Export Option Toggle","+function ExportOptionToggle({","+  label,","+  checked,","+  onChange,","+}: {","+  label: string","+  checked: boolean","+  onChange: (checked: boolean) => void","+}) {","+  return (","+    <button","+      onClick={() => onChange(!checked)}","+      className={`flex items-center gap-2 px-3 py-2 rounded-lg border transition-colors ${","+        checked","+          ? 'border-sky-500/50 bg-sky-500/10 text-[var(--text-primary)]'","+          : 'border-[rgba(255,255,255,0.1)] text-[var(--text-tertiary)] hover:bg-[var(--bg-tertiary)]'","+      }`}","+    >","+      <CheckSquare","+        className={`h-4 w-4 ${checked ? 'text-sky-500' : 'text-[var(--text-tertiary)]'}`}","+        weight={checked ? 'fill' : 'regular'}","+      />","+      <span className=\"text-xs font-medium\">{label}</span>","+    </button>","+  )","+}"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"eb73a445-9d7a-451a-9f43-fcbf50b414e1"}
{"parentUuid":"8dd78c50-1fac-4915-bf94-c2f1710538b2","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","message":{"model":"claude-opus-4-5-20251101","id":"msg_01FM4bhQVyDKGYAzZAjnoPtb","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Now I need to add the export handler to the notebook page component. Let me read the page.tsx file to see how it integrates with the StudioPanel.","signature":"EroCCkYICxgCKkDaPn4P+X1Qth+42Z/TqkFWXXypKEBcDfN3r0/Hr8sqUntRDLhqKE+cWOHbWvcVznCBw5LopEI+7+M7b0Talk0eEgyPYVKHpdyvWVSF8s4aDDzVhvnTsF3MjjhQ1iIwrdV0LICVnWvEnpCvK6fvZVruvSDbAlNALX35fwsvfEqleOI+J/tAfuxTyAZjFY27KqEBpu2knDojT8M6Vdt05ssWdigXtDQWujZB4rlj2bOHJ9bhQrA6n8uBrKBN6bqDf0ux15gcQrf5ay9LUZ+tmCCXWJAuYGYwk6y7NUwDUaSrmKu0wHSfZrZQQ5vfIHMF5KyNRuMnNNoLNQ9/P7jYFJTB8klc5JJ13ZH4sgfkTM0/re4bgUmOummXuNsqRWrOBjTP/gWHjrOb5XFErnswLvHFztAYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":1540,"cache_read_input_tokens":99846,"cache_creation":{"ephemeral_5m_input_tokens":1540,"ephemeral_1h_input_tokens":0},"output_tokens":7,"service_tier":"standard"}},"requestId":"req_011CWz6ZKRMQverahAHXpAgc","type":"assistant","uuid":"1234a4df-706a-4d43-a5ce-400a1e73ae8d","timestamp":"2026-01-10T17:32:04.689Z"}
{"parentUuid":"1234a4df-706a-4d43-a5ce-400a1e73ae8d","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","message":{"model":"claude-opus-4-5-20251101","id":"msg_01FM4bhQVyDKGYAzZAjnoPtb","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01MdzaVipEieJKiYUmQNPeM6","name":"Read","input":{"file_path":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend/src/app/notebooks/[id]/page.tsx"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":1540,"cache_read_input_tokens":99846,"cache_creation":{"ephemeral_5m_input_tokens":1540,"ephemeral_1h_input_tokens":0},"output_tokens":132,"service_tier":"standard"}},"requestId":"req_011CWz6ZKRMQverahAHXpAgc","type":"assistant","uuid":"bf0ccf9a-d8bb-4e83-a216-0f4abe628f43","timestamp":"2026-01-10T17:32:05.309Z"}
{"parentUuid":"bf0ccf9a-d8bb-4e83-a216-0f4abe628f43","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01MdzaVipEieJKiYUmQNPeM6","type":"tool_result","content":"     1→'use client'\n     2→\n     3→import { useEffect, useState, useRef } from 'react'\n     4→import { useParams, useRouter, useSearchParams } from 'next/navigation'\n     5→import { motion, AnimatePresence } from 'framer-motion'\n     6→import { createClient, Notebook, Source, ChatMessage } from '@/lib/supabase'\n     7→import { chatApi } from '@/lib/api'\n     8→import { Button } from '@/components/ui/button'\n     9→import { Input } from '@/components/ui/input'\n    10→import { Textarea } from '@/components/ui/textarea'\n    11→import { Badge } from '@/components/ui/badge'\n    12→import {\n    13→  Dialog,\n    14→  DialogContent,\n    15→  DialogDescription,\n    16→  DialogFooter,\n    17→  DialogHeader,\n    18→  DialogTitle,\n    19→} from '@/components/ui/dialog'\n    20→import {\n    21→  Sheet,\n    22→  SheetContent,\n    23→  SheetDescription,\n    24→  SheetHeader,\n    25→  SheetTitle,\n    26→} from '@/components/ui/sheet'\n    27→import {\n    28→  ArrowLeft, Loader2, Sparkles, X, RotateCcw,\n    29→  BookOpen, ListChecks, FileText, HelpCircle, Mic, Video, Search, Share2,\n    30→  Maximize2, Minimize2, Table, FileSpreadsheet, Presentation, Image as ImageIcon,\n    31→  History, Settings\n    32→} from 'lucide-react'\n    33→// Toast notifications removed per user request\n    34→// import { toast } from 'sonner'\n    35→import { User } from '@supabase/supabase-js'\n    36→\n    37→import { ThreePanelLayout } from '@/components/panels/three-panel-layout'\n    38→import { SourcesPanel } from '@/components/sources/sources-panel'\n    39→import { ChatPanel } from '@/components/chat/chat-panel'\n    40→import { StudioPanel } from '@/components/studio/studio-panel'\n    41→import type { GenerationConfig } from '@/components/studio/generation-config-dialog'\n    42→import {\n    43→  useNotebook,\n    44→  useSources,\n    45→  useNotes,\n    46→  useChatSessions,\n    47→  useGeneratedAudio,\n    48→  useGeneratedVideo,\n    49→  useGeneratedResearch,\n    50→  useStudyMaterials,\n    51→  useCreativeOutputs,\n    52→  useInvalidateNotebook,\n    53→} from '@/lib/hooks/use-notebook-queries'\n    54→\n    55→// Study viewers\n    56→import { FlashcardViewer } from '@/components/study/flashcard-viewer'\n    57→import { QuizViewer } from '@/components/study/quiz-viewer'\n    58→import { StudyGuideViewer } from '@/components/study/study-guide-viewer'\n    59→import { FAQViewer } from '@/components/study/faq-viewer'\n    60→import { MindMapViewer } from '@/components/study/mind-map-viewer'\n    61→\n    62→// Studio viewers\n    63→import { AudioPlayer } from '@/components/studio/audio-player'\n    64→import { VideoPlayer } from '@/components/studio/video-player'\n    65→import { ResearchReport } from '@/components/studio/research-report'\n    66→import { InfographicViewer } from '@/components/studio/infographic-viewer'\n    67→\n    68→// Notebook settings\n    69→import { NotebookSettingsDialog, NotebookSettings } from '@/components/notebook/notebook-settings'\n    70→\n    71→interface LocalNote {\n    72→  id: string\n    73→  notebook_id: string\n    74→  type: 'written' | 'saved_response'\n    75→  title: string | null\n    76→  content: string | null\n    77→  tags: string[]\n    78→  is_pinned: boolean\n    79→  created_at: string\n    80→  updated_at: string\n    81→}\n    82→\n    83→export default function NotebookPage() {\n    84→  const params = useParams()\n    85→  const router = useRouter()\n    86→  const searchParams = useSearchParams()\n    87→  const notebookId = params.id as string\n    88→  const supabase = createClient()\n    89→\n    90→  // Core state - React Query for cached data\n    91→  const [user, setUser] = useState<User | null>(null)\n    92→  const [authChecked, setAuthChecked] = useState(false)\n    93→  const [messages, setMessages] = useState<ChatMessage[]>([])\n    94→\n    95→  // React Query hooks for cached data\n    96→  const { data: notebook, isLoading: notebookLoading } = useNotebook(notebookId)\n    97→  const { data: sources = [], isLoading: sourcesLoading } = useSources(notebookId)\n    98→  const { data: notes = [], isLoading: notesLoading } = useNotes(notebookId)\n    99→  const { data: chatSessions = [], isLoading: loadingSessions } = useChatSessions(notebookId)\n   100→  const { data: generatedAudio } = useGeneratedAudio(notebookId)\n   101→  const { data: generatedVideo } = useGeneratedVideo(notebookId)\n   102→  const { data: generatedResearch } = useGeneratedResearch(notebookId)\n   103→  const { data: studyMaterialsData } = useStudyMaterials(notebookId, sources.map(s => ({ id: s.id, name: s.name })))\n   104→  const { data: creativeOutputsData } = useCreativeOutputs(notebookId)\n   105→  const invalidate = useInvalidateNotebook()\n   106→\n   107→  // Derived loading state\n   108→  const loading = !authChecked || notebookLoading || sourcesLoading || notesLoading\n   109→\n   110→  // Chat state\n   111→  const [sending, setSending] = useState(false)\n   112→  const [message, setMessage] = useState('')\n   113→  const [selectedSources, setSelectedSources] = useState<Set<string>>(new Set())\n   114→  const [sessionId, setSessionId] = useState<string | null>(null)\n   115→\n   116→  // Source state\n   117→  const [viewingSource, setViewingSource] = useState<Source | null>(null)\n   118→  const [uploading, setUploading] = useState(false)\n   119→\n   120→  // Notes state\n   121→  const [addNoteOpen, setAddNoteOpen] = useState(false)\n   122→  const [noteTitle, setNoteTitle] = useState('')\n   123→  const [noteContent, setNoteContent] = useState('')\n   124→  const [savingNote, setSavingNote] = useState(false)\n   125→\n   126→  // Settings state\n   127→  const [settingsOpen, setSettingsOpen] = useState(false)\n   128→  const [notebookSettings, setNotebookSettings] = useState<NotebookSettings | null>(null)\n   129→\n   130→  // Audio state\n   131→  const [audioFormat, setAudioFormat] = useState('deep_dive')\n   132→  const [audioInstructions, setAudioInstructions] = useState('')\n   133→  const [generatingAudio, setGeneratingAudio] = useState(false)\n   134→\n   135→  // Video state\n   136→  const [videoStyle, setVideoStyle] = useState('explainer')\n   137→  const [generatingVideo, setGeneratingVideo] = useState(false)\n   138→\n   139→  // Research state\n   140→  const [researchQuery, setResearchQuery] = useState('')\n   141→  const [researchMode, setResearchMode] = useState('fast')\n   142→  const [researching, setResearching] = useState(false)\n   143→\n   144→  // Consolidated generating states - single object to reduce re-renders\n   145→  const [generating, setGenerating] = useState({\n   146→    flashcards: false,\n   147→    quiz: false,\n   148→    studyGuide: false,\n   149→    faq: false,\n   150→    mindMap: false,\n   151→    dataTable: false,\n   152→    report: false,\n   153→    slideDeck: false,\n   154→    infographic: false,\n   155→  })\n   156→\n   157→  // Helper to update single generating state\n   158→  const setGeneratingState = (key: keyof typeof generating, value: boolean) => {\n   159→    setGenerating(prev => ({ ...prev, [key]: value }))\n   160→  }\n   161→\n   162→  // Study results\n   163→  const [flashcards, setFlashcards] = useState<Array<{ id: string; front: string; back: string }>>([])\n   164→  const [quizQuestions, setQuizQuestions] = useState<Array<{ id: string; question: string; options: string[]; correct_index: number; explanation: string }>>([])\n   165→  const [studyGuide, setStudyGuide] = useState<{ title: string; sections: Array<{ heading: string; content: string }> } | null>(null)\n   166→  const [faqItems, setFaqItems] = useState<Array<{ question: string; answer: string }>>([])\n   167→  const [mindMap, setMindMap] = useState<{ title: string; nodes: Array<{ id: string; label: string; description?: string; children?: Array<{ id: string; label: string; description?: string; children?: Array<{ id: string; label: string; description?: string }> }> }> } | null>(null)\n   168→\n   169→  // Creative outputs data\n   170→  const [dataTableData, setDataTableData] = useState<{\n   171→    title: string\n   172→    description: string\n   173→    columns: Array<{ header: string; key: string; type: string }>\n   174→    rows: Array<Record<string, string | number | boolean>>\n   175→  } | null>(null)\n   176→  const [reportData, setReportData] = useState<{\n   177→    title: string\n   178→    executive_summary: string\n   179→    sections: Array<{ heading: string; content: string }>\n   180→    key_takeaways: string[]\n   181→  } | null>(null)\n   182→  const [slideDeckData, setSlideDeckData] = useState<{\n   183→    title: string\n   184→    subtitle?: string\n   185→    slides: Array<{ slide_number: number; title: string; content_type: string; main_content: string; bullet_points?: string[]; speaker_notes?: string }>\n   186→    theme_suggestion: string\n   187→  } | null>(null)\n   188→  // Infographic data - supports new image-based format\n   189→  const [infographicData, setInfographicData] = useState<{\n   190→    // New image-based format\n   191→    images?: Array<{ title: string; prompt: string; imageData: string; mimeType: string }>\n   192→    concepts?: string[]\n   193→    // Legacy format (for backward compatibility)\n   194→    title?: string\n   195→    subtitle?: string\n   196→    color_scheme?: string[]\n   197→    sections?: Array<{ section_type: string; title?: string; content: Record<string, unknown> }>\n   198→    style_suggestion?: string\n   199→  } | null>(null)\n   200→\n   201→  // Study materials metadata (for UI display)\n   202→  const [studyMaterialsMeta, setStudyMaterialsMeta] = useState<Array<{\n   203→    id: string\n   204→    type: string\n   205→    sourceIds: string[]\n   206→    sourceNames: string[]\n   207→    createdAt: string\n   208→    itemCount?: number\n   209→  }>>([])\n   210→\n   211→  // Creative outputs metadata (for UI display)\n   212→  const [creativeOutputsMeta, setCreativeOutputsMeta] = useState<Array<{\n   213→    id: string\n   214→    type: string\n   215→    title: string\n   216→    status: string\n   217→    createdAt: string\n   218→    content?: Record<string, unknown>\n   219→  }>>([])\n   220→\n   221→  const [currentFlashcard, setCurrentFlashcard] = useState(0)\n   222→  const [showFlashcardBack, setShowFlashcardBack] = useState(false)\n   223→  const [currentQuizQuestion, setCurrentQuizQuestion] = useState(0)\n   224→  const [selectedAnswer, setSelectedAnswer] = useState<number | null>(null)\n   225→  const [showQuizAnswer, setShowQuizAnswer] = useState(false)\n   226→\n   227→  // Study materials sheet\n   228→  const [studySheetOpen, setStudySheetOpen] = useState(false)\n   229→  const [sheetWidth, setSheetWidth] = useState(576) // Default width in pixels\n   230→  const [isResizing, setIsResizing] = useState(false)\n   231→  const [activeStudyType, setActiveStudyType] = useState<'flashcards' | 'quiz' | 'guide' | 'faq' | 'mindmap' | 'audio' | 'video' | 'research' | 'datatable' | 'report' | 'slides' | 'infographic' | null>(null)\n   232→\n   233→  // Local state for newly generated content (overrides cached until next fetch)\n   234→  const [localGeneratedAudio, setLocalGeneratedAudio] = useState<typeof generatedAudio | null>(null)\n   235→  const [localGeneratedVideo, setLocalGeneratedVideo] = useState<typeof generatedVideo | null>(null)\n   236→  const [localGeneratedResearch, setLocalGeneratedResearch] = useState<{\n   237→    id: string\n   238→    query: string\n   239→    mode: string\n   240→    status: string\n   241→    progress_message?: string\n   242→    sources_found_count?: number\n   243→    sources_analyzed_count?: number\n   244→    report_content?: string\n   245→    report_citations?: { title: string; url: string }[]\n   246→    created_at: string\n   247→    completed_at?: string\n   248→  } | null>(null)\n   249→\n   250→  // Use local state if set, otherwise use cached data\n   251→  const activeGeneratedAudio = localGeneratedAudio ?? generatedAudio\n   252→  const activeGeneratedVideo = localGeneratedVideo ?? generatedVideo\n   253→  const activeGeneratedResearch = localGeneratedResearch ?? generatedResearch\n   254→\n   255→  // File input ref\n   256→  const fileInputRef = useRef<HTMLInputElement>(null)\n   257→\n   258→  // Initialize - just check auth, React Query handles data fetching\n   259→  useEffect(() => {\n   260→    const init = async () => {\n   261→      const { data: { user } } = await supabase.auth.getUser()\n   262→      if (!user) {\n   263→        router.push('/auth/login')\n   264→        return\n   265→      }\n   266→      setUser(user)\n   267→      setAuthChecked(true)\n   268→    }\n   269→    init()\n   270→  }, [notebookId])\n   271→\n   272→\n   273→  // Load a chat session\n   274→  const loadChatSession = async (loadSessionId: string) => {\n   275→    try {\n   276→      const { data: { session } } = await supabase.auth.getSession()\n   277→      const response = await fetch(`/api/notebooks/${notebookId}/chat/sessions/${loadSessionId}`, {\n   278→        headers: {\n   279→          'Authorization': `Bearer ${session?.access_token}`,\n   280→        },\n   281→      })\n   282→      const result = await response.json()\n   283→      if (result.data) {\n   284→        setSessionId(loadSessionId)\n   285→        setMessages(result.data.messages || [])\n   286→      }\n   287→    } catch (error) {\n   288→      console.error('Failed to load chat session:', error)\n   289→      \n   290→    }\n   291→  }\n   292→\n   293→  // Start a new chat\n   294→  const startNewChat = () => {\n   295→    setSessionId(null)\n   296→    setMessages([])\n   297→    setMessage('')\n   298→  }\n   299→\n   300→  // Delete a chat session\n   301→  const deleteChatSession = async (deleteSessionId: string) => {\n   302→    try {\n   303→      const { data: { session } } = await supabase.auth.getSession()\n   304→      const response = await fetch(`/api/notebooks/${notebookId}/chat/sessions/${deleteSessionId}`, {\n   305→        method: 'DELETE',\n   306→        headers: {\n   307→          'Authorization': `Bearer ${session?.access_token}`,\n   308→        },\n   309→      })\n   310→      if (response.ok) {\n   311→        // Invalidate cache to refresh the list\n   312→        invalidate.invalidateChatSessions(notebookId)\n   313→\n   314→        // If we deleted the current session, start a new chat\n   315→        if (deleteSessionId === sessionId) {\n   316→          startNewChat()\n   317→        }\n   318→      }\n   319→    } catch (error) {\n   320→      console.error('Failed to delete chat session:', error)\n   321→\n   322→    }\n   323→  }\n   324→\n   325→  // Rename a chat session\n   326→  const renameChatSession = async (renameSessionId: string, newTitle: string) => {\n   327→    try {\n   328→      const { data: { session } } = await supabase.auth.getSession()\n   329→      const response = await fetch(`/api/notebooks/${notebookId}/chat/sessions/${renameSessionId}`, {\n   330→        method: 'PATCH',\n   331→        headers: {\n   332→          'Content-Type': 'application/json',\n   333→          'Authorization': `Bearer ${session?.access_token}`,\n   334→        },\n   335→        body: JSON.stringify({ title: newTitle }),\n   336→      })\n   337→      if (response.ok) {\n   338→        // Invalidate cache to refresh the list\n   339→        invalidate.invalidateChatSessions(notebookId)\n   340→      }\n   341→    } catch (error) {\n   342→      console.error('Failed to rename chat session:', error)\n   343→    }\n   344→  }\n   345→\n   346→  // Load selected sources from localStorage after sources are loaded\n   347→  useEffect(() => {\n   348→    if (sources.length > 0 && !loading) {\n   349→      const savedSelection = localStorage.getItem(`notebook-${notebookId}-selected-sources`)\n   350→      if (savedSelection) {\n   351→        try {\n   352→          const savedIds = JSON.parse(savedSelection) as string[]\n   353→          // Only select sources that still exist\n   354→          const validIds = savedIds.filter(id => sources.some(s => s.id === id))\n   355→          if (validIds.length > 0) {\n   356→            setSelectedSources(new Set(validIds))\n   357→          }\n   358→        } catch {\n   359→          // Invalid JSON, ignore\n   360→        }\n   361→      }\n   362→    }\n   363→  }, [sources, loading, notebookId])\n   364→\n   365→  // Save selected sources to localStorage whenever they change\n   366→  useEffect(() => {\n   367→    if (!loading && sources.length > 0) {\n   368→      const selectedArray = Array.from(selectedSources)\n   369→      localStorage.setItem(`notebook-${notebookId}-selected-sources`, JSON.stringify(selectedArray))\n   370→    }\n   371→  }, [selectedSources, notebookId, loading, sources.length])\n   372→\n   373→  // Handle view and itemId query params from history page navigation\n   374→  useEffect(() => {\n   375→    const view = searchParams.get('view')\n   376→    const itemId = searchParams.get('itemId')\n   377→\n   378→    if (view && !loading) {\n   379→      // Map view param to activeStudyType\n   380→      const typeMap: Record<string, typeof activeStudyType> = {\n   381→        audio: 'audio',\n   382→        video: 'video',\n   383→        research: 'research',\n   384→        datatable: 'datatable',\n   385→        report: 'report',\n   386→        slides: 'slides',\n   387→        infographic: 'infographic',\n   388→        flashcards: 'flashcards',\n   389→        quiz: 'quiz',\n   390→        guide: 'guide',\n   391→        faq: 'faq',\n   392→        mindmap: 'mindmap',\n   393→      }\n   394→      const studyType = typeMap[view]\n   395→      if (studyType) {\n   396→        setActiveStudyType(studyType)\n   397→        setStudySheetOpen(true)\n   398→\n   399→        // Clear the query params after handling\n   400→        router.replace(`/notebooks/${notebookId}`, { scroll: false })\n   401→      }\n   402→    }\n   403→  }, [searchParams, loading, notebookId, router])\n   404→\n   405→\n   406→  // Fetch existing creative outputs (data tables, reports, slides, infographics)\n   407→  const fetchCreativeOutputs = async () => {\n   408→    try {\n   409→      const { data: { session } } = await supabase.auth.getSession()\n   410→      const response = await fetch(`/api/notebooks/${notebookId}/studio`, {\n   411→        headers: {\n   412→          'Authorization': `Bearer ${session?.access_token}`,\n   413→        },\n   414→      })\n   415→      const result = await response.json()\n   416→\n   417→      if (result.data && Array.isArray(result.data)) {\n   418→        // Group by type and get the latest of each\n   419→        const outputsByType: Record<string, typeof result.data[0]> = {}\n   420→        for (const output of result.data) {\n   421→          if (output.status === 'completed' && !outputsByType[output.type]) {\n   422→            outputsByType[output.type] = output\n   423→          }\n   424→        }\n   425→\n   426→        // Build metadata array\n   427→        const metaArray = Object.values(outputsByType).map((output) => ({\n   428→          id: output.id,\n   429→          type: output.type,\n   430→          title: output.title || output.type.replace('_', ' '),\n   431→          status: output.status,\n   432→          createdAt: output.created_at,\n   433→          content: output.content,\n   434→        }))\n   435→        setCreativeOutputsMeta(metaArray)\n   436→\n   437→        // Populate state with the latest content of each type\n   438→        for (const output of Object.values(outputsByType)) {\n   439→          if (output.type === 'data_table' && output.content) {\n   440→            setDataTableData(output.content as typeof dataTableData)\n   441→          } else if (output.type === 'report' && output.content) {\n   442→            setReportData(output.content as typeof reportData)\n   443→          } else if (output.type === 'slide_deck' && output.content) {\n   444→            setSlideDeckData(output.content as typeof slideDeckData)\n   445→          } else if (output.type === 'infographic' && output.content) {\n   446→            setInfographicData(output.content as typeof infographicData)\n   447→          }\n   448→        }\n   449→      }\n   450→    } catch (error) {\n   451→      console.error('Failed to fetch creative outputs:', error)\n   452→    }\n   453→  }\n   454→\n   455→  // Fetch existing study materials from Supabase\n   456→  const fetchStudyMaterials = async (sourcesData?: Source[]) => {\n   457→    try {\n   458→      const { data: { session } } = await supabase.auth.getSession()\n   459→      const response = await fetch(`/api/notebooks/${notebookId}/study`, {\n   460→        headers: {\n   461→          'Authorization': `Bearer ${session?.access_token}`,\n   462→        },\n   463→      })\n   464→      const result = await response.json()\n   465→\n   466→      if (result.data && Array.isArray(result.data)) {\n   467→        // Group materials by type and get the latest of each\n   468→        const materialsByType: Record<string, typeof result.data[0]> = {}\n   469→        for (const material of result.data) {\n   470→          if (!materialsByType[material.type]) {\n   471→            materialsByType[material.type] = material\n   472→          }\n   473→        }\n   474→\n   475→        // Build metadata array for UI\n   476→        const currentSources = sourcesData || sources\n   477→        const metaArray = Object.values(materialsByType).map((material) => {\n   478→          const sourceIds = material.source_ids || []\n   479→          const sourceNames = sourceIds.map((id: string) => {\n   480→            const source = currentSources.find(s => s.id === id)\n   481→            return source?.name || 'Unknown source'\n   482→          })\n   483→\n   484→          // Calculate item count based on type\n   485→          let itemCount = 0\n   486→          if (material.type === 'flashcards') itemCount = material.data?.flashcards?.length || 0\n   487→          else if (material.type === 'quiz') itemCount = material.data?.questions?.length || 0\n   488→          else if (material.type === 'faq') itemCount = material.data?.faq?.length || 0\n   489→\n   490→          return {\n   491→            id: material.id,\n   492→            type: material.type,\n   493→            sourceIds,\n   494→            sourceNames,\n   495→            createdAt: material.created_at,\n   496→            itemCount,\n   497→          }\n   498→        })\n   499→        setStudyMaterialsMeta(metaArray)\n   500→\n   501→        // Populate state with cached data\n   502→        if (materialsByType.flashcards?.data?.flashcards) {\n   503→          setFlashcards(materialsByType.flashcards.data.flashcards)\n   504→        }\n   505→        if (materialsByType.quiz?.data?.questions) {\n   506→          setQuizQuestions(materialsByType.quiz.data.questions)\n   507→        }\n   508→        if (materialsByType.study_guide?.data) {\n   509→          setStudyGuide(materialsByType.study_guide.data)\n   510→        }\n   511→        if (materialsByType.faq?.data?.faq) {\n   512→          setFaqItems(materialsByType.faq.data.faq)\n   513→        }\n   514→        if (materialsByType.mind_map?.data) {\n   515→          setMindMap(materialsByType.mind_map.data)\n   516→        }\n   517→      }\n   518→    } catch (error) {\n   519→      console.error('Failed to fetch study materials:', error)\n   520→    }\n   521→  }\n   522→\n   523→  // Redirect if notebook doesn't exist\n   524→  useEffect(() => {\n   525→    if (!notebookLoading && !notebook) {\n   526→      router.push('/')\n   527→    }\n   528→  }, [notebook, notebookLoading, router])\n   529→\n   530→  // Load notebook settings when notebook data is available\n   531→  useEffect(() => {\n   532→    if (notebook?.settings) {\n   533→      setNotebookSettings(notebook.settings as unknown as NotebookSettings)\n   534→    }\n   535→  }, [notebook])\n   536→\n   537→  // Save notebook settings\n   538→  const saveNotebookSettings = async (newSettings: NotebookSettings) => {\n   539→    try {\n   540→      const { data: { session } } = await supabase.auth.getSession()\n   541→      const response = await fetch(`/api/notebooks/${notebookId}`, {\n   542→        method: 'PATCH',\n   543→        headers: {\n   544→          'Content-Type': 'application/json',\n   545→          'Authorization': `Bearer ${session?.access_token}`,\n   546→        },\n   547→        body: JSON.stringify({ settings: newSettings }),\n   548→      })\n   549→\n   550→      if (!response.ok) {\n   551→        throw new Error('Failed to save settings')\n   552→      }\n   553→\n   554→      setNotebookSettings(newSettings)\n   555→      invalidate.invalidateNotebook(notebookId)\n   556→    } catch (error) {\n   557→      console.error('Failed to save notebook settings:', error)\n   558→      throw error\n   559→    }\n   560→  }\n   561→\n   562→  // Source handlers\n   563→  const handleAddSource = async (type: string, data: { input: string; name?: string; file?: File }) => {\n   564→    setUploading(true)\n   565→\n   566→    if (type === 'file') {\n   567→      // Handle file upload - file is passed from the sources panel\n   568→      const file = data.file\n   569→      if (file) {\n   570→        const fileExt = file.name.split('.').pop()?.toLowerCase()\n   571→        const filePath = `${user?.id}/${notebookId}/${Date.now()}.${fileExt}`\n   572→\n   573→        const { error: uploadError } = await supabase.storage\n   574→          .from('sources')\n   575→          .upload(filePath, file)\n   576→\n   577→        if (uploadError) {\n   578→          console.error('Upload error:', uploadError)\n   579→          \n   580→          setUploading(false)\n   581→          return\n   582→        }\n   583→\n   584→        const { data: sourceData, error } = await supabase\n   585→          .from('sources')\n   586→          .insert({\n   587→            notebook_id: notebookId,\n   588→            type: fileExt === 'pdf' ? 'pdf' : fileExt === 'docx' ? 'docx' : 'txt',\n   589→            name: file.name,\n   590→            status: 'ready',\n   591→            file_path: filePath,\n   592→            original_filename: file.name,\n   593→            mime_type: file.type,\n   594→            file_size_bytes: file.size,\n   595→          })\n   596→          .select()\n   597→          .single()\n   598→\n   599→        if (error) {\n   600→          console.error('Source creation error:', error)\n   601→        } else {\n   602→          invalidate.invalidateSources(notebookId)\n   603→        }\n   604→      }\n   605→    } else {\n   606→      let sourceData: Partial<Source> = {\n   607→        notebook_id: notebookId,\n   608→        status: 'ready',\n   609→      }\n   610→\n   611→      if (type === 'youtube') {\n   612→        sourceData = {\n   613→          ...sourceData,\n   614→          type: 'youtube',\n   615→          name: data.name || `YouTube: ${data.input}`,\n   616→          metadata: { url: data.input },\n   617→        }\n   618→      } else if (type === 'url') {\n   619→        sourceData = {\n   620→          ...sourceData,\n   621→          type: 'url',\n   622→          name: data.name || data.input,\n   623→          metadata: { url: data.input },\n   624→        }\n   625→      } else if (type === 'text') {\n   626→        sourceData = {\n   627→          ...sourceData,\n   628→          type: 'text',\n   629→          name: data.name || 'Pasted Text',\n   630→          metadata: { content: data.input },\n   631→        }\n   632→      }\n   633→\n   634→      const { error } = await supabase\n   635→        .from('sources')\n   636→        .insert(sourceData)\n   637→        .select()\n   638→        .single()\n   639→\n   640→      if (error) {\n   641→        console.error('Source creation error:', error)\n   642→      } else {\n   643→        invalidate.invalidateSources(notebookId)\n   644→      }\n   645→    }\n   646→\n   647→    setUploading(false)\n   648→  }\n   649→\n   650→  const handleDeleteSource = async (sourceId: string) => {\n   651→    const { error } = await supabase\n   652→      .from('sources')\n   653→      .delete()\n   654→      .eq('id', sourceId)\n   655→\n   656→    if (error) {\n   657→      console.error('Delete source error:', error)\n   658→    } else {\n   659→      invalidate.invalidateSources(notebookId)\n   660→      selectedSources.delete(sourceId)\n   661→      setSelectedSources(new Set(selectedSources))\n   662→    }\n   663→  }\n   664→\n   665→  const toggleSource = (sourceId: string) => {\n   666→    const newSelected = new Set(selectedSources)\n   667→    if (newSelected.has(sourceId)) {\n   668→      newSelected.delete(sourceId)\n   669→    } else {\n   670→      newSelected.add(sourceId)\n   671→    }\n   672→    setSelectedSources(newSelected)\n   673→  }\n   674→\n   675→  const selectAllSources = () => {\n   676→    if (selectedSources.size === sources.length) {\n   677→      setSelectedSources(new Set())\n   678→    } else {\n   679→      setSelectedSources(new Set(sources.map(s => s.id)))\n   680→    }\n   681→  }\n   682→\n   683→  // Chat handlers\n   684→  const sendMessage = async (overrideMessage?: string) => {\n   685→    const messageToSend = overrideMessage || message\n   686→    if (!messageToSend.trim() || sending) return\n   687→\n   688→    setSending(true)\n   689→    const userMessage: ChatMessage = {\n   690→      id: crypto.randomUUID(),\n   691→      session_id: sessionId || '',\n   692→      role: 'user',\n   693→      content: messageToSend,\n   694→      citations: [],\n   695→      source_ids_used: Array.from(selectedSources),\n   696→      model_used: null,\n   697→      input_tokens: null,\n   698→      output_tokens: null,\n   699→      cost_usd: null,\n   700→      created_at: new Date().toISOString(),\n   701→    }\n   702→    setMessages(prev => [...prev, userMessage])\n   703→    setMessage('')\n   704→\n   705→    try {\n   706→      const response = await chatApi.sendMessage(notebookId, {\n   707→        message: userMessage.content,\n   708→        source_ids: Array.from(selectedSources),\n   709→        session_id: sessionId || undefined,\n   710→      })\n   711→\n   712→      const isNewSession = !sessionId\n   713→      if (response.data.session_id) {\n   714→        setSessionId(response.data.session_id)\n   715→      }\n   716→\n   717→      const aiMessage: ChatMessage = {\n   718→        id: response.data.message_id,\n   719→        session_id: response.data.session_id,\n   720→        role: 'assistant',\n   721→        content: response.data.content,\n   722→        citations: response.data.citations,\n   723→        source_ids_used: Array.from(selectedSources),\n   724→        model_used: response.usage?.model_used || 'gemini-2.0-flash',\n   725→        input_tokens: response.usage?.input_tokens || 0,\n   726→        output_tokens: response.usage?.output_tokens || 0,\n   727→        cost_usd: response.usage?.cost_usd || 0,\n   728→        created_at: new Date().toISOString(),\n   729→      }\n   730→      setMessages(prev => [...prev, aiMessage])\n   731→\n   732→      // Refresh chat sessions if this was a new session\n   733→      if (isNewSession) {\n   734→        invalidate.invalidateChatSessions(notebookId)\n   735→      }\n   736→    } catch {\n   737→      setMessages(prev => prev.filter(m => m.id !== userMessage.id))\n   738→    }\n   739→    setSending(false)\n   740→  }\n   741→\n   742→  const saveResponseAsNote = async (msg: ChatMessage) => {\n   743→    const { error } = await supabase\n   744→      .from('notes')\n   745→      .insert({\n   746→        notebook_id: notebookId,\n   747→        type: 'saved_response',\n   748→        title: `Saved Response - ${new Date().toLocaleDateString()}`,\n   749→        content: msg.content,\n   750→        tags: [],\n   751→      })\n   752→      .select()\n   753→      .single()\n   754→\n   755→    if (error) {\n   756→      console.error('Save note error:', error)\n   757→    } else {\n   758→      invalidate.invalidateNotes(notebookId)\n   759→    }\n   760→  }\n   761→\n   762→  // Notes handlers\n   763→  const createNote = async () => {\n   764→    if (!noteTitle.trim() && !noteContent.trim()) return\n   765→\n   766→    setSavingNote(true)\n   767→    const { error } = await supabase\n   768→      .from('notes')\n   769→      .insert({\n   770→        notebook_id: notebookId,\n   771→        type: 'written',\n   772→        title: noteTitle || 'Untitled Note',\n   773→        content: noteContent,\n   774→        tags: [],\n   775→      })\n   776→      .select()\n   777→      .single()\n   778→\n   779→    if (error) {\n   780→      console.error('Create note error:', error)\n   781→    } else {\n   782→      invalidate.invalidateNotes(notebookId)\n   783→      setNoteTitle('')\n   784→      setNoteContent('')\n   785→      setAddNoteOpen(false)\n   786→    }\n   787→    setSavingNote(false)\n   788→  }\n   789→\n   790→  // Audio generation\n   791→  const generateAudio = async () => {\n   792→    if (selectedSources.size === 0) {\n   793→      \n   794→      return\n   795→    }\n   796→\n   797→    setGeneratingAudio(true)\n   798→    setActiveStudyType('audio')\n   799→    setStudySheetOpen(true)\n   800→\n   801→    try {\n   802→      const { data: { session } } = await supabase.auth.getSession()\n   803→      const response = await fetch(`/api/notebooks/${notebookId}/audio`, {\n   804→        method: 'POST',\n   805→        headers: {\n   806→          'Content-Type': 'application/json',\n   807→          'Authorization': `Bearer ${session?.access_token}`,\n   808→        },\n   809→        body: JSON.stringify({\n   810→          format: audioFormat,\n   811→          source_ids: Array.from(selectedSources),\n   812→          custom_instructions: audioInstructions || undefined,\n   813→        }),\n   814→      })\n   815→      const result = await response.json()\n   816→      if (result.error) {\n   817→        console.error('Audio generation error:', result.error)\n   818→      } else if (result.data) {\n   819→        setLocalGeneratedAudio(result.data)\n   820→        invalidate.invalidateAudio(notebookId)\n   821→      }\n   822→    } catch (error) {\n   823→      console.error('Audio generation error:', error)\n   824→    }\n   825→    setGeneratingAudio(false)\n   826→  }\n   827→\n   828→  // Video generation\n   829→  const generateVideo = async () => {\n   830→    if (selectedSources.size === 0) {\n   831→      return\n   832→    }\n   833→\n   834→    setGeneratingVideo(true)\n   835→    setActiveStudyType('video')\n   836→    setStudySheetOpen(true)\n   837→\n   838→    try {\n   839→      const { data: { session } } = await supabase.auth.getSession()\n   840→      const response = await fetch(`/api/notebooks/${notebookId}/video`, {\n   841→        method: 'POST',\n   842→        headers: {\n   843→          'Content-Type': 'application/json',\n   844→          'Authorization': `Bearer ${session?.access_token}`,\n   845→        },\n   846→        body: JSON.stringify({\n   847→          style: videoStyle,\n   848→          source_ids: Array.from(selectedSources),\n   849→        }),\n   850→      })\n   851→      const result = await response.json()\n   852→      if (result.error) {\n   853→        console.error('Video generation error:', result.error)\n   854→      } else if (result.data) {\n   855→        // Map video_file_path to video_url for frontend components\n   856→        setLocalGeneratedVideo({\n   857→          ...result.data,\n   858→          video_url: result.data.video_file_path || result.data.video_url,\n   859→        })\n   860→        invalidate.invalidateVideo(notebookId)\n   861→      }\n   862→    } catch (error) {\n   863→      console.error('Video generation error:', error)\n   864→    }\n   865→    setGeneratingVideo(false)\n   866→  }\n   867→\n   868→  // Research generation\n   869→  const runResearch = async () => {\n   870→    if (!researchQuery.trim()) {\n   871→      return\n   872→    }\n   873→\n   874→    // Clear old research to prevent showing cached results\n   875→    setLocalGeneratedResearch(null)\n   876→    setResearching(true)\n   877→    setActiveStudyType('research')\n   878→    setStudySheetOpen(true)\n   879→\n   880→    try {\n   881→      const { data: { session } } = await supabase.auth.getSession()\n   882→      const response = await fetch(`/api/notebooks/${notebookId}/research`, {\n   883→        method: 'POST',\n   884→        headers: {\n   885→          'Content-Type': 'application/json',\n   886→          'Authorization': `Bearer ${session?.access_token}`,\n   887→        },\n   888→        body: JSON.stringify({\n   889→          query: researchQuery,\n   890→          mode: researchMode,\n   891→        }),\n   892→      })\n   893→      const result = await response.json()\n   894→      if (result.error) {\n   895→        console.error('Research failed:', result.error)\n   896→        alert(`Research failed: ${result.error}`)\n   897→      } else if (result.data) {\n   898→        setLocalGeneratedResearch(result.data)\n   899→        invalidate.invalidateResearch(notebookId)\n   900→        setResearchQuery('')\n   901→      }\n   902→    } catch (error) {\n   903→      console.error('Research error:', error)\n   904→      alert('Research failed. Please try again.')\n   905→    }\n   906→    setResearching(false)\n   907→  }\n   908→\n   909→  // Study material generation handlers\n   910→  const handleGenerateFlashcards = async () => {\n   911→    setGeneratingState('flashcards', true)\n   912→    try {\n   913→      const { data: { session } } = await supabase.auth.getSession()\n   914→      const response = await fetch(`/api/notebooks/${notebookId}/study`, {\n   915→        method: 'POST',\n   916→        headers: {\n   917→          'Content-Type': 'application/json',\n   918→          'Authorization': `Bearer ${session?.access_token}`,\n   919→        },\n   920→        body: JSON.stringify({\n   921→          type: 'flashcards',\n   922→          source_ids: Array.from(selectedSources),\n   923→          count: 5,\n   924→        }),\n   925→      })\n   926→      const result = await response.json()\n   927→      if (result.error) {\n   928→        \n   929→      } else if (result.data?.flashcards) {\n   930→        setFlashcards(result.data.flashcards)\n   931→        setCurrentFlashcard(0)\n   932→        setShowFlashcardBack(false)\n   933→        setActiveStudyType('flashcards')\n   934→        setStudySheetOpen(true)\n   935→        fetchStudyMaterials()\n   936→        \n   937→      }\n   938→    } catch {\n   939→      \n   940→    } finally {\n   941→      setGeneratingState('flashcards', false)\n   942→    }\n   943→  }\n   944→\n   945→  const handleGenerateQuiz = async () => {\n   946→    setGeneratingState('quiz', true)\n   947→    try {\n   948→      const { data: { session } } = await supabase.auth.getSession()\n   949→      const response = await fetch(`/api/notebooks/${notebookId}/study`, {\n   950→        method: 'POST',\n   951→        headers: {\n   952→          'Content-Type': 'application/json',\n   953→          'Authorization': `Bearer ${session?.access_token}`,\n   954→        },\n   955→        body: JSON.stringify({\n   956→          type: 'quiz',\n   957→          source_ids: Array.from(selectedSources),\n   958→          count: 5,\n   959→        }),\n   960→      })\n   961→      const result = await response.json()\n   962→      if (result.error) {\n   963→        \n   964→      } else if (result.data?.questions) {\n   965→        setQuizQuestions(result.data.questions)\n   966→        setCurrentQuizQuestion(0)\n   967→        setSelectedAnswer(null)\n   968→        setShowQuizAnswer(false)\n   969→        setActiveStudyType('quiz')\n   970→        setStudySheetOpen(true)\n   971→        fetchStudyMaterials()\n   972→        \n   973→      }\n   974→    } catch {\n   975→      \n   976→    } finally {\n   977→      setGeneratingState('quiz', false)\n   978→    }\n   979→  }\n   980→\n   981→  const handleGenerateStudyGuide = async () => {\n   982→    setGeneratingState('studyGuide', true)\n   983→    try {\n   984→      const { data: { session } } = await supabase.auth.getSession()\n   985→      const response = await fetch(`/api/notebooks/${notebookId}/study`, {\n   986→        method: 'POST',\n   987→        headers: {\n   988→          'Content-Type': 'application/json',\n   989→          'Authorization': `Bearer ${session?.access_token}`,\n   990→        },\n   991→        body: JSON.stringify({\n   992→          type: 'study-guide',\n   993→          source_ids: Array.from(selectedSources),\n   994→        }),\n   995→      })\n   996→      const result = await response.json()\n   997→      if (result.error) {\n   998→        \n   999→      } else if (result.data?.sections) {\n  1000→        setStudyGuide(result.data)\n  1001→        setActiveStudyType('guide')\n  1002→        setStudySheetOpen(true)\n  1003→        fetchStudyMaterials()\n  1004→        \n  1005→      }\n  1006→    } catch {\n  1007→      \n  1008→    } finally {\n  1009→      setGeneratingState('studyGuide', false)\n  1010→    }\n  1011→  }\n  1012→\n  1013→  const handleGenerateFaq = async () => {\n  1014→    setGeneratingState('faq', true)\n  1015→    try {\n  1016→      const { data: { session } } = await supabase.auth.getSession()\n  1017→      const response = await fetch(`/api/notebooks/${notebookId}/study`, {\n  1018→        method: 'POST',\n  1019→        headers: {\n  1020→          'Content-Type': 'application/json',\n  1021→          'Authorization': `Bearer ${session?.access_token}`,\n  1022→        },\n  1023→        body: JSON.stringify({\n  1024→          type: 'faq',\n  1025→          source_ids: Array.from(selectedSources),\n  1026→        }),\n  1027→      })\n  1028→      const result = await response.json()\n  1029→      if (result.error) {\n  1030→        \n  1031→      } else if (result.data?.faq) {\n  1032→        setFaqItems(result.data.faq)\n  1033→        setActiveStudyType('faq')\n  1034→        setStudySheetOpen(true)\n  1035→        fetchStudyMaterials()\n  1036→        \n  1037→      }\n  1038→    } catch {\n  1039→      \n  1040→    } finally {\n  1041→      setGeneratingState('faq', false)\n  1042→    }\n  1043→  }\n  1044→\n  1045→  const handleGenerateMindMap = async () => {\n  1046→    setGeneratingState('mindMap', true)\n  1047→    try {\n  1048→      const { data: { session } } = await supabase.auth.getSession()\n  1049→      const response = await fetch(`/api/notebooks/${notebookId}/study`, {\n  1050→        method: 'POST',\n  1051→        headers: {\n  1052→          'Content-Type': 'application/json',\n  1053→          'Authorization': `Bearer ${session?.access_token}`,\n  1054→        },\n  1055→        body: JSON.stringify({\n  1056→          type: 'mind-map',\n  1057→          source_ids: Array.from(selectedSources),\n  1058→        }),\n  1059→      })\n  1060→      const result = await response.json()\n  1061→      if (result.error) {\n  1062→\n  1063→      } else if (result.data?.nodes) {\n  1064→        setMindMap(result.data)\n  1065→        setActiveStudyType('mindmap')\n  1066→        setStudySheetOpen(true)\n  1067→        // Refresh metadata to show updated material\n  1068→        fetchStudyMaterials()\n  1069→\n  1070→      }\n  1071→    } catch {\n  1072→\n  1073→    } finally {\n  1074→      setGeneratingState('mindMap', false)\n  1075→    }\n  1076→  }\n  1077→\n  1078→  // Unified study material handler with config\n  1079→  const handleGenerateStudyMaterial = async (config: GenerationConfig) => {\n  1080→    const sourceIds = config.sourceIds && config.sourceIds.length > 0\n  1081→      ? config.sourceIds\n  1082→      : Array.from(selectedSources)\n  1083→\n  1084→    if (sourceIds.length === 0) return\n  1085→\n  1086→    // Set loading state based on type\n  1087→    const typeToStateKey: Record<string, keyof typeof generating> = {\n  1088→      'flashcards': 'flashcards',\n  1089→      'quiz': 'quiz',\n  1090→      'study-guide': 'studyGuide',\n  1091→      'faq': 'faq',\n  1092→      'mind-map': 'mindMap',\n  1093→    }\n  1094→    const stateKey = typeToStateKey[config.type]\n  1095→    if (stateKey) setGeneratingState(stateKey, true)\n  1096→\n  1097→    try {\n  1098→      const { data: { session } } = await supabase.auth.getSession()\n  1099→\n  1100→      // Build request body with all config options\n  1101→      const requestBody: Record<string, unknown> = {\n  1102→        type: config.type,\n  1103→        source_ids: sourceIds,\n  1104→      }\n  1105→\n  1106→      // Add optional config fields\n  1107→      if (config.count) requestBody.count = config.count\n  1108→      if (config.difficulty) requestBody.difficulty = config.difficulty\n  1109→      if (config.focusArea) requestBody.focus_area = config.focusArea\n  1110→      if (config.customInstructions) requestBody.custom_instructions = config.customInstructions\n  1111→      if (config.questionTypes) requestBody.question_types = config.questionTypes\n  1112→\n  1113→      const response = await fetch(`/api/notebooks/${notebookId}/study`, {\n  1114→        method: 'POST',\n  1115→        headers: {\n  1116→          'Content-Type': 'application/json',\n  1117→          'Authorization': `Bearer ${session?.access_token}`,\n  1118→        },\n  1119→        body: JSON.stringify(requestBody),\n  1120→      })\n  1121→      const result = await response.json()\n  1122→\n  1123→      if (result.error) {\n  1124→        console.error('Generation error:', result.error)\n  1125→      } else if (result.data) {\n  1126→        // Handle each type's response\n  1127→        switch (config.type) {\n  1128→          case 'flashcards':\n  1129→            if (result.data.flashcards) {\n  1130→              setFlashcards(result.data.flashcards)\n  1131→              setCurrentFlashcard(0)\n  1132→              setShowFlashcardBack(false)\n  1133→              setActiveStudyType('flashcards')\n  1134→              setStudySheetOpen(true)\n  1135→            }\n  1136→            break\n  1137→          case 'quiz':\n  1138→            if (result.data.questions) {\n  1139→              setQuizQuestions(result.data.questions)\n  1140→              setCurrentQuizQuestion(0)\n  1141→              setSelectedAnswer(null)\n  1142→              setShowQuizAnswer(false)\n  1143→              setActiveStudyType('quiz')\n  1144→              setStudySheetOpen(true)\n  1145→            }\n  1146→            break\n  1147→          case 'study-guide':\n  1148→            if (result.data.sections) {\n  1149→              setStudyGuide(result.data)\n  1150→              setActiveStudyType('guide')\n  1151→              setStudySheetOpen(true)\n  1152→            }\n  1153→            break\n  1154→          case 'faq':\n  1155→            if (result.data.faq) {\n  1156→              setFaqItems(result.data.faq)\n  1157→              setActiveStudyType('faq')\n  1158→              setStudySheetOpen(true)\n  1159→            }\n  1160→            break\n  1161→          case 'mind-map':\n  1162→            if (result.data.nodes) {\n  1163→              setMindMap(result.data)\n  1164→              setActiveStudyType('mindmap')\n  1165→              setStudySheetOpen(true)\n  1166→            }\n  1167→            break\n  1168→        }\n  1169→        fetchStudyMaterials()\n  1170→      }\n  1171→    } catch (error) {\n  1172→      console.error('Study material generation failed:', error)\n  1173→    } finally {\n  1174→      if (stateKey) setGeneratingState(stateKey, false)\n  1175→    }\n  1176→  }\n  1177→\n  1178→  // Unified creative output handler with config\n  1179→  const handleGenerateCreativeOutput = async (config: GenerationConfig) => {\n  1180→    const sourceIds = config.sourceIds && config.sourceIds.length > 0\n  1181→      ? config.sourceIds\n  1182→      : Array.from(selectedSources)\n  1183→\n  1184→    if (sourceIds.length === 0) return\n  1185→\n  1186→    // Set loading state based on type\n  1187→    const typeToStateKey2: Record<string, keyof typeof generating> = {\n  1188→      'data_table': 'dataTable',\n  1189→      'report': 'report',\n  1190→      'slide_deck': 'slideDeck',\n  1191→      'infographic': 'infographic',\n  1192→    }\n  1193→    const stateKey2 = typeToStateKey2[config.type]\n  1194→    if (stateKey2) setGeneratingState(stateKey2, true)\n  1195→\n  1196→    try {\n  1197→      const { data: { session } } = await supabase.auth.getSession()\n  1198→\n  1199→      // Build request body with all config options\n  1200→      const requestBody: Record<string, unknown> = {\n  1201→        type: config.type,\n  1202→        source_ids: sourceIds,\n  1203→      }\n  1204→\n  1205→      // Add optional config fields\n  1206→      if (config.customInstructions) requestBody.custom_instructions = config.customInstructions\n  1207→      if (config.focusArea) requestBody.focus_area = config.focusArea\n  1208→      if (config.reportType) requestBody.report_type = config.reportType\n  1209→      if (config.tone) requestBody.tone = config.tone\n  1210→      if (config.slideCount) requestBody.slide_count = config.slideCount\n  1211→      if (config.style) requestBody.style = config.style\n  1212→      // Infographic-specific options\n  1213→      if (config.imageCount) requestBody.image_count = config.imageCount\n  1214→      if (config.imageStyle) requestBody.image_style = config.imageStyle\n  1215→\n  1216→      const response = await fetch(`/api/notebooks/${notebookId}/studio`, {\n  1217→        method: 'POST',\n  1218→        headers: {\n  1219→          'Content-Type': 'application/json',\n  1220→          'Authorization': `Bearer ${session?.access_token}`,\n  1221→        },\n  1222→        body: JSON.stringify(requestBody),\n  1223→      })\n  1224→      const result = await response.json()\n  1225→\n  1226→      if (result.error) {\n  1227→        console.error('Generation error:', result.error)\n  1228→      } else if (result.data) {\n  1229→        // Handle each type's response\n  1230→        switch (config.type) {\n  1231→          case 'data_table':\n  1232→            setDataTableData(result.data)\n  1233→            setActiveStudyType('datatable')\n  1234→            setStudySheetOpen(true)\n  1235→            break\n  1236→          case 'report':\n  1237→            setReportData(result.data)\n  1238→            setActiveStudyType('report')\n  1239→            setStudySheetOpen(true)\n  1240→            break\n  1241→          case 'slide_deck':\n  1242→            setSlideDeckData(result.data)\n  1243→            setActiveStudyType('slides')\n  1244→            setStudySheetOpen(true)\n  1245→            break\n  1246→          case 'infographic':\n  1247→            setInfographicData(result.data)\n  1248→            setActiveStudyType('infographic')\n  1249→            setStudySheetOpen(true)\n  1250→            break\n  1251→        }\n  1252→        fetchCreativeOutputs()\n  1253→      }\n  1254→    } catch (error) {\n  1255→      console.error('Creative output generation failed:', error)\n  1256→    } finally {\n  1257→      if (stateKey2) setGeneratingState(stateKey2, false)\n  1258→    }\n  1259→  }\n  1260→\n  1261→  // Creative output generation handlers (legacy - kept for compatibility)\n  1262→  const handleGenerateDataTable = async () => {\n  1263→    if (selectedSources.size === 0) {\n  1264→\n  1265→      return\n  1266→    }\n  1267→    setGeneratingState('dataTable', true)\n  1268→    try {\n  1269→      const { data: { session } } = await supabase.auth.getSession()\n  1270→      const response = await fetch(`/api/notebooks/${notebookId}/studio`, {\n  1271→        method: 'POST',\n  1272→        headers: {\n  1273→          'Content-Type': 'application/json',\n  1274→          'Authorization': `Bearer ${session?.access_token}`,\n  1275→        },\n  1276→        body: JSON.stringify({\n  1277→          type: 'data_table',\n  1278→          source_ids: Array.from(selectedSources),\n  1279→        }),\n  1280→      })\n  1281→      const result = await response.json()\n  1282→      if (result.error) {\n  1283→        \n  1284→      } else if (result.data) {\n  1285→        setDataTableData(result.data)\n  1286→        setActiveStudyType('datatable' as typeof activeStudyType)\n  1287→        setStudySheetOpen(true)\n  1288→        fetchCreativeOutputs()\n  1289→      }\n  1290→    } catch {\n  1291→      // Error handled silently\n  1292→    } finally {\n  1293→      setGeneratingState('dataTable', false)\n  1294→    }\n  1295→  }\n  1296→\n  1297→  const handleGenerateReport = async (reportType: string) => {\n  1298→    if (selectedSources.size === 0) {\n  1299→\n  1300→      return\n  1301→    }\n  1302→    setGeneratingState('report', true)\n  1303→    try {\n  1304→      const { data: { session } } = await supabase.auth.getSession()\n  1305→      const response = await fetch(`/api/notebooks/${notebookId}/studio`, {\n  1306→        method: 'POST',\n  1307→        headers: {\n  1308→          'Content-Type': 'application/json',\n  1309→          'Authorization': `Bearer ${session?.access_token}`,\n  1310→        },\n  1311→        body: JSON.stringify({\n  1312→          type: 'report',\n  1313→          source_ids: Array.from(selectedSources),\n  1314→          report_type: reportType,\n  1315→        }),\n  1316→      })\n  1317→      const result = await response.json()\n  1318→      if (result.error) {\n  1319→        \n  1320→      } else if (result.data) {\n  1321→        setReportData(result.data)\n  1322→        setActiveStudyType('report' as typeof activeStudyType)\n  1323→        setStudySheetOpen(true)\n  1324→        fetchCreativeOutputs()\n  1325→      }\n  1326→    } catch {\n  1327→      // Error handled silently\n  1328→    } finally {\n  1329→      setGeneratingState('report', false)\n  1330→    }\n  1331→  }\n  1332→\n  1333→  const handleGenerateSlideDeck = async () => {\n  1334→    if (selectedSources.size === 0) {\n  1335→\n  1336→      return\n  1337→    }\n  1338→    setGeneratingState('slideDeck', true)\n  1339→    try {\n  1340→      const { data: { session } } = await supabase.auth.getSession()\n  1341→      const response = await fetch(`/api/notebooks/${notebookId}/studio`, {\n  1342→        method: 'POST',\n  1343→        headers: {\n  1344→          'Content-Type': 'application/json',\n  1345→          'Authorization': `Bearer ${session?.access_token}`,\n  1346→        },\n  1347→        body: JSON.stringify({\n  1348→          type: 'slide_deck',\n  1349→          source_ids: Array.from(selectedSources),\n  1350→        }),\n  1351→      })\n  1352→      const result = await response.json()\n  1353→      if (result.error) {\n  1354→        \n  1355→      } else if (result.data) {\n  1356→        setSlideDeckData(result.data)\n  1357→        setActiveStudyType('slides' as typeof activeStudyType)\n  1358→        setStudySheetOpen(true)\n  1359→        fetchCreativeOutputs()\n  1360→      }\n  1361→    } catch {\n  1362→      // Error handled silently\n  1363→    } finally {\n  1364→      setGeneratingState('slideDeck', false)\n  1365→    }\n  1366→  }\n  1367→\n  1368→  const handleGenerateInfographic = async () => {\n  1369→    if (selectedSources.size === 0) {\n  1370→\n  1371→      return\n  1372→    }\n  1373→    setGeneratingState('infographic', true)\n  1374→    try {\n  1375→      const { data: { session } } = await supabase.auth.getSession()\n  1376→      const response = await fetch(`/api/notebooks/${notebookId}/studio`, {\n  1377→        method: 'POST',\n  1378→        headers: {\n  1379→          'Content-Type': 'application/json',\n  1380→          'Authorization': `Bearer ${session?.access_token}`,\n  1381→        },\n  1382→        body: JSON.stringify({\n  1383→          type: 'infographic',\n  1384→          source_ids: Array.from(selectedSources),\n  1385→        }),\n  1386→      })\n  1387→      const result = await response.json()\n  1388→      if (result.error) {\n  1389→        \n  1390→      } else if (result.data) {\n  1391→        setInfographicData(result.data)\n  1392→        setActiveStudyType('infographic' as typeof activeStudyType)\n  1393→        setStudySheetOpen(true)\n  1394→        fetchCreativeOutputs()\n  1395→      }\n  1396→    } catch {\n  1397→      // Error handled silently\n  1398→    } finally {\n  1399→      setGeneratingState('infographic', false)\n  1400→    }\n  1401→  }\n  1402→\n  1403→  // Sheet resize handlers\n  1404→  const handleResizeStart = (e: React.MouseEvent) => {\n  1405→    e.preventDefault()\n  1406→    setIsResizing(true)\n  1407→\n  1408→    const startX = e.clientX\n  1409→    const startWidth = sheetWidth\n  1410→\n  1411→    const handleMouseMove = (e: MouseEvent) => {\n  1412→      const diff = startX - e.clientX\n  1413→      const newWidth = Math.min(Math.max(startWidth + diff, 400), window.innerWidth - 50)\n  1414→      setSheetWidth(newWidth)\n  1415→    }\n  1416→\n  1417→    const handleMouseUp = () => {\n  1418→      setIsResizing(false)\n  1419→      document.removeEventListener('mousemove', handleMouseMove)\n  1420→      document.removeEventListener('mouseup', handleMouseUp)\n  1421→    }\n  1422→\n  1423→    document.addEventListener('mousemove', handleMouseMove)\n  1424→    document.addEventListener('mouseup', handleMouseUp)\n  1425→  }\n  1426→\n  1427→  if (loading) {\n  1428→    return (\n  1429→      <div className=\"h-screen flex items-center justify-center bg-[var(--bg-primary)]\">\n  1430→        <Loader2 className=\"h-8 w-8 animate-spin text-[var(--accent-primary)]\" />\n  1431→      </div>\n  1432→    )\n  1433→  }\n  1434→\n  1435→  return (\n  1436→    <div className=\"h-screen flex flex-col bg-[var(--bg-primary)]\">\n  1437→      {/* Header */}\n  1438→      <motion.header\n  1439→        initial={{ opacity: 0, y: -10 }}\n  1440→        animate={{ opacity: 1, y: 0 }}\n  1441→        className=\"h-14 bg-[var(--bg-secondary)] border-b border-[rgba(255,255,255,0.1)] px-4 flex items-center gap-4 shrink-0 sticky top-0 z-50\"\n  1442→      >\n  1443→        <Button\n  1444→          variant=\"ghost\"\n  1445→          size=\"icon\"\n  1446→          onClick={() => router.push('/')}\n  1447→          className=\"h-9 w-9 rounded-lg text-[var(--text-secondary)] hover:text-[var(--text-primary)] hover:bg-[var(--bg-tertiary)]\"\n  1448→        >\n  1449→          <ArrowLeft className=\"h-4 w-4\" />\n  1450→        </Button>\n  1451→\n  1452→        <div className=\"flex items-center gap-3\">\n  1453→          <div className=\"w-10 h-10 rounded-xl bg-[var(--bg-tertiary)] flex items-center justify-center text-xl\">\n  1454→            {notebook?.emoji}\n  1455→          </div>\n  1456→          <div>\n  1457→            <h1 className=\"font-semibold text-[var(--text-primary)]\">{notebook?.name}</h1>\n  1458→            {notebook?.description && (\n  1459→              <p className=\"text-xs text-[var(--text-tertiary)] line-clamp-1 max-w-[300px]\">\n  1460→                {notebook.description}\n  1461→              </p>\n  1462→            )}\n  1463→          </div>\n  1464→        </div>\n  1465→\n  1466→        <div className=\"flex items-center gap-2 ml-auto\">\n  1467→          <Badge className=\"bg-[var(--bg-tertiary)] text-[var(--text-secondary)] border-0 text-xs\">\n  1468→            {sources.length} source{sources.length !== 1 ? 's' : ''}\n  1469→          </Badge>\n  1470→          {selectedSources.size > 0 && (\n  1471→            <Badge className=\"bg-[var(--accent-primary)]/20 text-[var(--accent-primary)] border-0 text-xs\">\n  1472→              {selectedSources.size} selected\n  1473→            </Badge>\n  1474→          )}\n  1475→          {notebookSettings?.persona?.enabled && (\n  1476→            <Badge className=\"bg-purple-500/20 text-purple-400 border-0 text-xs\">\n  1477→              {notebookSettings.persona.name || 'Custom Persona'}\n  1478→            </Badge>\n  1479→          )}\n  1480→          <Button\n  1481→            variant=\"ghost\"\n  1482→            size=\"sm\"\n  1483→            onClick={() => setSettingsOpen(true)}\n  1484→            className=\"h-9 px-3 rounded-lg text-[var(--text-secondary)] hover:text-[var(--text-primary)] hover:bg-[var(--bg-tertiary)] gap-2\"\n  1485→          >\n  1486→            <Settings className=\"h-4 w-4\" />\n  1487→            <span className=\"hidden sm:inline\">Settings</span>\n  1488→          </Button>\n  1489→          <Button\n  1490→            variant=\"ghost\"\n  1491→            size=\"sm\"\n  1492→            onClick={() => router.push(`/notebooks/${notebookId}/history`)}\n  1493→            className=\"h-9 px-3 rounded-lg text-[var(--text-secondary)] hover:text-[var(--text-primary)] hover:bg-[var(--bg-tertiary)] gap-2\"\n  1494→          >\n  1495→            <History className=\"h-4 w-4\" />\n  1496→            <span className=\"hidden sm:inline\">History</span>\n  1497→          </Button>\n  1498→        </div>\n  1499→      </motion.header>\n  1500→\n  1501→      {/* Three Panel Layout */}\n  1502→      <div className=\"flex-1 overflow-hidden\">\n  1503→        <ThreePanelLayout\n  1504→          leftPanelTitle=\"Sources\"\n  1505→          rightPanelTitle=\"Studio\"\n  1506→          leftPanel={\n  1507→            <SourcesPanel\n  1508→              sources={sources}\n  1509→              selectedSources={selectedSources}\n  1510→              onToggleSource={toggleSource}\n  1511→              onSelectAll={selectAllSources}\n  1512→              onAddSource={handleAddSource}\n  1513→              onDeleteSource={handleDeleteSource}\n  1514→              onViewSource={setViewingSource}\n  1515→              uploading={uploading}\n  1516→            />\n  1517→          }\n  1518→          centerPanel={\n  1519→            <ChatPanel\n  1520→              messages={messages}\n  1521→              message={message}\n  1522→              onMessageChange={setMessage}\n  1523→              onSendMessage={sendMessage}\n  1524→              sending={sending}\n  1525→              selectedSourcesCount={selectedSources.size}\n  1526→              totalSourcesCount={sources.length}\n  1527→              onSaveResponse={saveResponseAsNote}\n  1528→              sessions={chatSessions}\n  1529→              currentSessionId={sessionId}\n  1530→              onLoadSession={loadChatSession}\n  1531→              onNewChat={startNewChat}\n  1532→              onDeleteSession={deleteChatSession}\n  1533→              onRenameSession={renameChatSession}\n  1534→              loadingSessions={loadingSessions}\n  1535→              notebookId={notebookId}\n  1536→            />\n  1537→          }\n  1538→          rightPanel={\n  1539→            <StudioPanel\n  1540→              notebookId={notebookId}\n  1541→              selectedSourcesCount={selectedSources.size}\n  1542→              selectedSourceIds={Array.from(selectedSources)}\n  1543→              sources={sources.map(s => ({ id: s.id, name: s.name }))}\n  1544→              audioFormat={audioFormat}\n  1545→              onAudioFormatChange={setAudioFormat}\n  1546→              audioInstructions={audioInstructions}\n  1547→              onAudioInstructionsChange={setAudioInstructions}\n  1548→              onGenerateAudio={generateAudio}\n  1549→              generatingAudio={generatingAudio}\n  1550→              videoStyle={videoStyle}\n  1551→              onVideoStyleChange={setVideoStyle}\n  1552→              onGenerateVideo={generateVideo}\n  1553→              generatingVideo={generatingVideo}\n  1554→              researchQuery={researchQuery}\n  1555→              onResearchQueryChange={setResearchQuery}\n  1556→              researchMode={researchMode}\n  1557→              onResearchModeChange={setResearchMode}\n  1558→              onRunResearch={runResearch}\n  1559→              researching={researching}\n  1560→              onGenerateStudyMaterial={handleGenerateStudyMaterial}\n  1561→              generatingFlashcards={generating.flashcards}\n  1562→              generatingQuiz={generating.quiz}\n  1563→              generatingStudyGuide={generating.studyGuide}\n  1564→              generatingFaq={generating.faq}\n  1565→              generatingMindMap={generating.mindMap}\n  1566→              onGenerateCreativeOutput={handleGenerateCreativeOutput}\n  1567→              generatingDataTable={generating.dataTable}\n  1568→              generatingReport={generating.report}\n  1569→              generatingSlideDeck={generating.slideDeck}\n  1570→              generatingInfographic={generating.infographic}\n  1571→              creativeOutputs={creativeOutputsMeta}\n  1572→              onOpenCreativeOutput={(type) => {\n  1573→                const typeMap: Record<string, typeof activeStudyType> = {\n  1574→                  data_table: 'datatable',\n  1575→                  report: 'report',\n  1576→                  slide_deck: 'slides',\n  1577→                  infographic: 'infographic',\n  1578→                }\n  1579→                setActiveStudyType(typeMap[type] || null)\n  1580→                setStudySheetOpen(true)\n  1581→              }}\n  1582→              studyMaterials={studyMaterialsMeta}\n  1583→              onOpenStudyMaterial={(type) => {\n  1584→                const typeMap: Record<string, typeof activeStudyType> = {\n  1585→                  flashcards: 'flashcards',\n  1586→                  quiz: 'quiz',\n  1587→                  study_guide: 'guide',\n  1588→                  faq: 'faq',\n  1589→                  mind_map: 'mindmap',\n  1590→                }\n  1591→                setActiveStudyType(typeMap[type] || null)\n  1592→                setStudySheetOpen(true)\n  1593→              }}\n  1594→              notesCount={notes.length}\n  1595→              onAddNote={() => setAddNoteOpen(true)}\n  1596→              hasGeneratedAudio={!!activeGeneratedAudio}\n  1597→              hasGeneratedVideo={!!activeGeneratedVideo}\n  1598→              hasGeneratedResearch={!!activeGeneratedResearch}\n  1599→              onOpenAudio={() => { setActiveStudyType('audio'); setStudySheetOpen(true) }}\n  1600→              onOpenVideo={() => { setActiveStudyType('video'); setStudySheetOpen(true) }}\n  1601→              onOpenResearch={() => { setActiveStudyType('research'); setStudySheetOpen(true) }}\n  1602→            />\n  1603→          }\n  1604→        />\n  1605→      </div>\n  1606→\n  1607→      {/* Source Preview Dialog */}\n  1608→      <Dialog open={!!viewingSource} onOpenChange={(open) => !open && setViewingSource(null)}>\n  1609→        <DialogContent className=\"sm:max-w-lg bg-[var(--bg-secondary)] border-[rgba(255,255,255,0.1)]\">\n  1610→          <DialogHeader>\n  1611→            <DialogTitle className=\"flex items-center gap-3 text-[var(--text-primary)]\">\n  1612→              <div className=\"w-10 h-10 rounded-lg bg-[var(--bg-tertiary)] flex items-center justify-center\">\n  1613→                <FileText className=\"h-5 w-5\" />\n  1614→              </div>\n  1615→              {viewingSource?.name}\n  1616→            </DialogTitle>\n  1617→            <DialogDescription className=\"text-[var(--text-secondary)]\">\n  1618→              {viewingSource?.type} source\n  1619→            </DialogDescription>\n  1620→          </DialogHeader>\n  1621→\n  1622→          {viewingSource?.metadata && (() => {\n  1623→            const meta = viewingSource.metadata as Record<string, unknown>\n  1624→            if (viewingSource.type === 'text' && meta.content) {\n  1625→              return (\n  1626→                <div className=\"p-4 rounded-xl bg-[var(--bg-tertiary)] text-sm max-h-64 overflow-y-auto\">\n  1627→                  <p className=\"whitespace-pre-wrap text-[var(--text-secondary)]\">\n  1628→                    {String(meta.content)}\n  1629→                  </p>\n  1630→                </div>\n  1631→              )\n  1632→            }\n  1633→            if ((viewingSource.type === 'youtube' || viewingSource.type === 'url') && meta.url) {\n  1634→              return (\n  1635→                <div className=\"p-4 rounded-xl bg-[var(--bg-tertiary)] text-sm max-h-64 overflow-y-auto\">\n  1636→                  <a\n  1637→                    href={String(meta.url)}\n  1638→                    target=\"_blank\"\n  1639→                    rel=\"noopener noreferrer\"\n  1640→                    className=\"text-[var(--accent-primary)] hover:underline break-all\"\n  1641→                  >\n  1642→                    {String(meta.url)}\n  1643→                  </a>\n  1644→                </div>\n  1645→              )\n  1646→            }\n  1647→            return null\n  1648→          })()}\n  1649→        </DialogContent>\n  1650→      </Dialog>\n  1651→\n  1652→      {/* Add Note Dialog */}\n  1653→      <Dialog open={addNoteOpen} onOpenChange={setAddNoteOpen}>\n  1654→        <DialogContent className=\"sm:max-w-md bg-[var(--bg-secondary)] border-[rgba(255,255,255,0.1)]\">\n  1655→          <DialogHeader>\n  1656→            <DialogTitle className=\"text-[var(--text-primary)]\">Create Note</DialogTitle>\n  1657→            <DialogDescription className=\"text-[var(--text-secondary)]\">\n  1658→              Write a new note to save your thoughts.\n  1659→            </DialogDescription>\n  1660→          </DialogHeader>\n  1661→          <div className=\"space-y-4 mt-2\">\n  1662→            <div className=\"space-y-2\">\n  1663→              <label className=\"text-sm font-medium text-[var(--text-primary)]\">Title</label>\n  1664→              <Input\n  1665→                placeholder=\"Note title...\"\n  1666→                value={noteTitle}\n  1667→                onChange={(e) => setNoteTitle(e.target.value)}\n  1668→                className=\"h-10 bg-[var(--bg-tertiary)] border-[rgba(255,255,255,0.1)] text-[var(--text-primary)] placeholder:text-[var(--text-tertiary)] focus:border-[var(--accent-primary)] rounded-lg\"\n  1669→              />\n  1670→            </div>\n  1671→            <div className=\"space-y-2\">\n  1672→              <label className=\"text-sm font-medium text-[var(--text-primary)]\">Content</label>\n  1673→              <Textarea\n  1674→                placeholder=\"Write your note...\"\n  1675→                value={noteContent}\n  1676→                onChange={(e) => setNoteContent(e.target.value)}\n  1677→                rows={6}\n  1678→                className=\"bg-[var(--bg-tertiary)] border-[rgba(255,255,255,0.1)] text-[var(--text-primary)] placeholder:text-[var(--text-tertiary)] focus:border-[var(--accent-primary)] rounded-lg resize-none\"\n  1679→              />\n  1680→            </div>\n  1681→          </div>\n  1682→          <DialogFooter className=\"mt-4\">\n  1683→            <Button\n  1684→              onClick={createNote}\n  1685→              disabled={savingNote}\n  1686→              className=\"rounded-lg bg-[var(--accent-primary)] hover:bg-[var(--accent-primary)]/90 text-white\"\n  1687→            >\n  1688→              {savingNote && <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />}\n  1689→              Create Note\n  1690→            </Button>\n  1691→          </DialogFooter>\n  1692→        </DialogContent>\n  1693→      </Dialog>\n  1694→\n  1695→      {/* Study Materials Sheet */}\n  1696→      <Sheet open={studySheetOpen} onOpenChange={(open) => {\n  1697→        setStudySheetOpen(open)\n  1698→        if (!open) setSheetWidth(576)\n  1699→      }}>\n  1700→        <SheetContent\n  1701→          className=\"overflow-y-auto bg-[var(--bg-secondary)] border-[rgba(255,255,255,0.1)] p-0\"\n  1702→          style={{ width: sheetWidth, maxWidth: '100vw' }}\n  1703→        >\n  1704→          {/* Resize Handle */}\n  1705→          <div\n  1706→            className={`absolute left-0 top-0 bottom-0 w-1.5 cursor-ew-resize hover:bg-[var(--accent-primary)]/50 transition-colors z-50 ${isResizing ? 'bg-[var(--accent-primary)]/50' : ''}`}\n  1707→            onMouseDown={handleResizeStart}\n  1708→          />\n  1709→          <div className=\"p-6\">\n  1710→          <SheetHeader>\n  1711→            <div className=\"flex items-center gap-2 pr-8\">\n  1712→              <SheetTitle className=\"flex items-center gap-2 text-[var(--text-primary)] flex-1\">\n  1713→                {activeStudyType === 'flashcards' && <><BookOpen className=\"h-5 w-5 text-blue-500\" /> Flashcards</>}\n  1714→                {activeStudyType === 'quiz' && <><ListChecks className=\"h-5 w-5 text-purple-500\" /> Quiz</>}\n  1715→                {activeStudyType === 'guide' && <><FileText className=\"h-5 w-5 text-orange-500\" /> Study Guide</>}\n  1716→                {activeStudyType === 'faq' && <><HelpCircle className=\"h-5 w-5 text-teal-500\" /> FAQ</>}\n  1717→                {activeStudyType === 'mindmap' && <><Share2 className=\"h-5 w-5 text-cyan-500\" /> Mind Map</>}\n  1718→                {activeStudyType === 'datatable' && <><Table className=\"h-5 w-5 text-emerald-500\" /> Data Table</>}\n  1719→                {activeStudyType === 'report' && <><FileSpreadsheet className=\"h-5 w-5 text-blue-500\" /> Report</>}\n  1720→                {activeStudyType === 'slides' && <><Presentation className=\"h-5 w-5 text-violet-500\" /> Slide Deck</>}\n  1721→                {activeStudyType === 'infographic' && <><ImageIcon className=\"h-5 w-5 text-rose-500\" /> Infographic</>}\n  1722→                {activeStudyType === 'audio' && <><Mic className=\"h-5 w-5 text-orange-500\" /> Audio Overview</>}\n  1723→                {activeStudyType === 'video' && <><Video className=\"h-5 w-5 text-purple-500\" /> Video Overview</>}\n  1724→                {activeStudyType === 'research' && <><Search className=\"h-5 w-5 text-blue-500\" /> Research Report</>}\n  1725→              </SheetTitle>\n  1726→              <Button\n  1727→                variant=\"ghost\"\n  1728→                size=\"icon\"\n  1729→                className=\"h-8 w-8 shrink-0\"\n  1730→                onClick={() => {\n  1731→                  if (sheetWidth < 800) {\n  1732→                    setSheetWidth(900) // Wide\n  1733→                  } else if (sheetWidth < window.innerWidth - 100) {\n  1734→                    setSheetWidth(window.innerWidth - 50) // Full\n  1735→                  } else {\n  1736→                    setSheetWidth(576) // Normal\n  1737→                  }\n  1738→                }}\n  1739→                title={sheetWidth >= window.innerWidth - 100 ? 'Minimize' : 'Expand'}\n  1740→              >\n  1741→                {sheetWidth >= window.innerWidth - 100 ? (\n  1742→                  <Minimize2 className=\"h-4 w-4\" />\n  1743→                ) : (\n  1744→                  <Maximize2 className=\"h-4 w-4\" />\n  1745→                )}\n  1746→              </Button>\n  1747→            </div>\n  1748→            <SheetDescription className=\"text-[var(--text-secondary)]\">\n  1749→              {activeStudyType === 'flashcards' && `${flashcards.length} cards generated from your sources`}\n  1750→              {activeStudyType === 'quiz' && `${quizQuestions.length} questions to test your knowledge`}\n  1751→              {activeStudyType === 'guide' && 'Comprehensive study guide from your sources'}\n  1752→              {activeStudyType === 'faq' && `${faqItems.length} frequently asked questions`}\n  1753→              {activeStudyType === 'mindmap' && 'Interactive visualization of key concepts'}\n  1754→              {activeStudyType === 'datatable' && 'Structured data extracted from your sources'}\n  1755→              {activeStudyType === 'report' && 'Professional document from your sources'}\n  1756→              {activeStudyType === 'slides' && 'Presentation slides from your sources'}\n  1757→              {activeStudyType === 'infographic' && 'AI-generated images visualizing key concepts'}\n  1758→              {activeStudyType === 'audio' && 'Podcast-style audio discussion'}\n  1759→              {activeStudyType === 'video' && 'Visual explainer video'}\n  1760→              {activeStudyType === 'research' && 'Deep web research findings'}\n  1761→            </SheetDescription>\n  1762→          </SheetHeader>\n  1763→\n  1764→          <div className=\"mt-6 relative\">\n  1765→            {/* Flashcards View */}\n  1766→            {activeStudyType === 'flashcards' && (\n  1767→              <FlashcardViewer\n  1768→                flashcards={flashcards}\n  1769→                onClose={() => setStudySheetOpen(false)}\n  1770→              />\n  1771→            )}\n  1772→\n  1773→            {/* Quiz View */}\n  1774→            {activeStudyType === 'quiz' && (\n  1775→              <QuizViewer\n  1776→                questions={quizQuestions}\n  1777→                onClose={() => setStudySheetOpen(false)}\n  1778→              />\n  1779→            )}\n  1780→\n  1781→            {/* Study Guide View */}\n  1782→            {activeStudyType === 'guide' && studyGuide && (\n  1783→              <StudyGuideViewer\n  1784→                guide={studyGuide}\n  1785→                onClose={() => setStudySheetOpen(false)}\n  1786→              />\n  1787→            )}\n  1788→\n  1789→            {/* FAQ View */}\n  1790→            {activeStudyType === 'faq' && (\n  1791→              <FAQViewer\n  1792→                items={faqItems}\n  1793→                onClose={() => setStudySheetOpen(false)}\n  1794→              />\n  1795→            )}\n  1796→\n  1797→            {/* Mind Map View */}\n  1798→            {activeStudyType === 'mindmap' && mindMap && (\n  1799→              <MindMapViewer\n  1800→                title={mindMap.title}\n  1801→                nodes={mindMap.nodes}\n  1802→                onClose={() => setStudySheetOpen(false)}\n  1803→              />\n  1804→            )}\n  1805→\n  1806→            {/* Audio View */}\n  1807→            {activeStudyType === 'audio' && (\n  1808→              <AudioPlayer\n  1809→                audio={activeGeneratedAudio ?? null}\n  1810→                isGenerating={generatingAudio}\n  1811→                onClose={() => setStudySheetOpen(false)}\n  1812→              />\n  1813→            )}\n  1814→\n  1815→            {/* Video View */}\n  1816→            {activeStudyType === 'video' && (\n  1817→              <VideoPlayer\n  1818→                video={activeGeneratedVideo ?? null}\n  1819→                isGenerating={generatingVideo}\n  1820→                onClose={() => setStudySheetOpen(false)}\n  1821→              />\n  1822→            )}\n  1823→\n  1824→            {/* Research View */}\n  1825→            {activeStudyType === 'research' && (\n  1826→              <ResearchReport\n  1827→                research={activeGeneratedResearch ?? null}\n  1828→                isResearching={researching}\n  1829→                onClose={() => setStudySheetOpen(false)}\n  1830→              />\n  1831→            )}\n  1832→\n  1833→            {/* Data Table View */}\n  1834→            {activeStudyType === 'datatable' && dataTableData && (\n  1835→              <div className=\"space-y-4\">\n  1836→                <div className=\"p-4 rounded-xl bg-[var(--bg-tertiary)]\">\n  1837→                  <h3 className=\"text-lg font-semibold text-[var(--text-primary)] mb-2\">{dataTableData.title}</h3>\n  1838→                  <p className=\"text-sm text-[var(--text-secondary)] mb-4\">{dataTableData.description}</p>\n  1839→                  <div className=\"overflow-x-auto\">\n  1840→                    <table className=\"w-full text-sm\">\n  1841→                      <thead>\n  1842→                        <tr className=\"border-b border-[rgba(255,255,255,0.1)]\">\n  1843→                          {dataTableData.columns.map((col) => (\n  1844→                            <th key={col.key} className=\"text-left p-3 font-medium text-[var(--text-primary)]\">\n  1845→                              {col.header}\n  1846→                            </th>\n  1847→                          ))}\n  1848→                        </tr>\n  1849→                      </thead>\n  1850→                      <tbody>\n  1851→                        {dataTableData.rows.map((row, idx) => (\n  1852→                          <tr key={idx} className=\"border-b border-[rgba(255,255,255,0.05)] hover:bg-[var(--bg-secondary)]\">\n  1853→                            {dataTableData.columns.map((col) => (\n  1854→                              <td key={col.key} className=\"p-3 text-[var(--text-secondary)]\">\n  1855→                                {String(row[col.key] ?? '')}\n  1856→                              </td>\n  1857→                            ))}\n  1858→                          </tr>\n  1859→                        ))}\n  1860→                      </tbody>\n  1861→                    </table>\n  1862→                  </div>\n  1863→                </div>\n  1864→              </div>\n  1865→            )}\n  1866→\n  1867→            {/* Report View */}\n  1868→            {activeStudyType === 'report' && reportData && (\n  1869→              <div className=\"space-y-6\">\n  1870→                <div className=\"p-4 rounded-xl bg-[var(--bg-tertiary)]\">\n  1871→                  <h2 className=\"text-xl font-bold text-[var(--text-primary)] mb-4\">{reportData.title}</h2>\n  1872→                  <div className=\"p-4 rounded-lg bg-[var(--accent-primary)]/10 border border-[var(--accent-primary)]/20 mb-6\">\n  1873→                    <h3 className=\"text-sm font-semibold text-[var(--accent-primary)] mb-2\">Executive Summary</h3>\n  1874→                    <p className=\"text-sm text-[var(--text-secondary)]\">{reportData.executive_summary}</p>\n  1875→                  </div>\n  1876→                  {reportData.sections.map((section, idx) => (\n  1877→                    <div key={idx} className=\"mb-6\">\n  1878→                      <h3 className=\"text-lg font-semibold text-[var(--text-primary)] mb-2\">{section.heading}</h3>\n  1879→                      <p className=\"text-sm text-[var(--text-secondary)] whitespace-pre-wrap\">{section.content}</p>\n  1880→                    </div>\n  1881→                  ))}\n  1882→                  <div className=\"mt-6 p-4 rounded-lg bg-[var(--bg-secondary)]\">\n  1883→                    <h3 className=\"text-sm font-semibold text-[var(--text-primary)] mb-2\">Key Takeaways</h3>\n  1884→                    <ul className=\"list-disc list-inside space-y-1\">\n  1885→                      {reportData.key_takeaways.map((takeaway, idx) => (\n  1886→                        <li key={idx} className=\"text-sm text-[var(--text-secondary)]\">{takeaway}</li>\n  1887→                      ))}\n  1888→                    </ul>\n  1889→                  </div>\n  1890→                </div>\n  1891→              </div>\n  1892→            )}\n  1893→\n  1894→            {/* Slide Deck View */}\n  1895→            {activeStudyType === 'slides' && slideDeckData && (\n  1896→              <div className=\"space-y-4\">\n  1897→                <div className=\"text-center mb-6\">\n  1898→                  <h2 className=\"text-xl font-bold text-[var(--text-primary)]\">{slideDeckData.title}</h2>\n  1899→                  {slideDeckData.subtitle && (\n  1900→                    <p className=\"text-sm text-[var(--text-secondary)] mt-1\">{slideDeckData.subtitle}</p>\n  1901→                  )}\n  1902→                  <Badge className=\"mt-2 bg-[var(--bg-tertiary)] text-[var(--text-secondary)]\">\n  1903→                    {slideDeckData.slides.length} slides\n  1904→                  </Badge>\n  1905→                </div>\n  1906→                <div className=\"space-y-4\">\n  1907→                  {slideDeckData.slides.map((slide) => (\n  1908→                    <div key={slide.slide_number} className=\"p-4 rounded-xl bg-[var(--bg-tertiary)] border border-[rgba(255,255,255,0.1)]\">\n  1909→                      <div className=\"flex items-center gap-2 mb-3\">\n  1910→                        <Badge className=\"bg-[var(--accent-primary)]/20 text-[var(--accent-primary)]\">\n  1911→                          {slide.slide_number}\n  1912→                        </Badge>\n  1913→                        <span className=\"text-xs text-[var(--text-tertiary)] uppercase\">{slide.content_type}</span>\n  1914→                      </div>\n  1915→                      <h3 className=\"text-lg font-semibold text-[var(--text-primary)] mb-2\">{slide.title}</h3>\n  1916→                      <p className=\"text-sm text-[var(--text-secondary)] mb-3\">{slide.main_content}</p>\n  1917→                      {slide.bullet_points && slide.bullet_points.length > 0 && (\n  1918→                        <ul className=\"list-disc list-inside space-y-1 mb-3\">\n  1919→                          {slide.bullet_points.map((point, idx) => (\n  1920→                            <li key={idx} className=\"text-sm text-[var(--text-secondary)]\">{point}</li>\n  1921→                          ))}\n  1922→                        </ul>\n  1923→                      )}\n  1924→                      {slide.speaker_notes && (\n  1925→                        <div className=\"mt-3 p-3 rounded-lg bg-[var(--bg-secondary)] text-xs text-[var(--text-tertiary)]\">\n  1926→                          <span className=\"font-medium\">Speaker notes:</span> {slide.speaker_notes}\n  1927→                        </div>\n  1928→                      )}\n  1929→                    </div>\n  1930→                  ))}\n  1931→                </div>\n  1932→              </div>\n  1933→            )}\n  1934→\n  1935→            {/* Infographic View */}\n  1936→            {activeStudyType === 'infographic' && infographicData && (\n  1937→              // Check if it's the new image-based format\n  1938→              infographicData.images && infographicData.images.length > 0 ? (\n  1939→                <InfographicViewer\n  1940→                  data={{\n  1941→                    images: infographicData.images,\n  1942→                    concepts: infographicData.concepts || []\n  1943→                  }}\n  1944→                  onClose={() => setStudySheetOpen(false)}\n  1945→                />\n  1946→              ) : infographicData.color_scheme && infographicData.sections ? (\n  1947→                // Legacy format (backward compatibility)\n  1948→                <div className=\"space-y-6\">\n  1949→                  {/* Header Section */}\n  1950→                  <div\n  1951→                    className=\"p-8 rounded-2xl text-center\"\n  1952→                    style={{\n  1953→                      background: `linear-gradient(135deg, ${infographicData.color_scheme[0]}20 0%, ${infographicData.color_scheme[1]}20 100%)`,\n  1954→                      borderLeft: `4px solid ${infographicData.color_scheme[0]}`\n  1955→                    }}\n  1956→                  >\n  1957→                    <h2 className=\"text-2xl font-bold text-[var(--text-primary)]\">{infographicData.title}</h2>\n  1958→                    {infographicData.subtitle && (\n  1959→                      <p className=\"text-base text-[var(--text-secondary)] mt-2\">{infographicData.subtitle}</p>\n  1960→                    )}\n  1961→                  </div>\n  1962→\n  1963→                  {/* Render each section based on type */}\n  1964→                  {infographicData.sections.map((section, idx) => {\n  1965→                    const sectionColor = infographicData.color_scheme![idx % infographicData.color_scheme!.length]\n  1966→                    const content = section.content as Record<string, unknown>\n  1967→\n  1968→                    // Stats Section\n  1969→                    if (section.section_type === 'stats' && content.items) {\n  1970→                      const items = content.items as Array<{ value: string; label: string; icon?: string }>\n  1971→                      return (\n  1972→                        <div key={idx} className=\"p-6 rounded-xl bg-[var(--bg-tertiary)]\">\n  1973→                          {section.title && <h3 className=\"text-lg font-semibold text-[var(--text-primary)] mb-4\">{section.title}</h3>}\n  1974→                          <div className=\"grid grid-cols-3 gap-4\">\n  1975→                            {items.map((item, i) => (\n  1976→                              <div key={i} className=\"text-center p-4 rounded-lg\" style={{ backgroundColor: `${sectionColor}15` }}>\n  1977→                                <div className=\"text-2xl font-bold\" style={{ color: sectionColor }}>{item.value}</div>\n  1978→                                <div className=\"text-sm text-[var(--text-secondary)] mt-1\">{item.label}</div>\n  1979→                              </div>\n  1980→                            ))}\n  1981→                          </div>\n  1982→                        </div>\n  1983→                      )\n  1984→                    }\n  1985→\n  1986→                    // Timeline Section\n  1987→                    if (section.section_type === 'timeline' && content.events) {\n  1988→                      const events = content.events as Array<{ date: string; title: string; description?: string }>\n  1989→                      return (\n  1990→                        <div key={idx} className=\"p-6 rounded-xl bg-[var(--bg-tertiary)]\">\n  1991→                          {section.title && <h3 className=\"text-lg font-semibold text-[var(--text-primary)] mb-4\">{section.title}</h3>}\n  1992→                          <div className=\"space-y-4\">\n  1993→                            {events.map((event, i) => (\n  1994→                              <div key={i} className=\"flex gap-4\">\n  1995→                                <div className=\"flex flex-col items-center\">\n  1996→                                  <div className=\"w-3 h-3 rounded-full\" style={{ backgroundColor: sectionColor }} />\n  1997→                                  {i < events.length - 1 && <div className=\"w-0.5 flex-1 mt-1\" style={{ backgroundColor: `${sectionColor}40` }} />}\n  1998→                                </div>\n  1999→                                <div className=\"flex-1 pb-4\">\n  2000→                                  <div className=\"font-semibold\" style={{ color: sectionColor }}>{event.date}</div>\n  2001→                                  <div className=\"font-medium text-[var(--text-primary)]\">{event.title}</div>\n  2002→                                  {event.description && <div className=\"text-sm text-[var(--text-secondary)] mt-1\">{event.description}</div>}\n  2003→                                </div>\n  2004→                              </div>\n  2005→                            ))}\n  2006→                          </div>\n  2007→                        </div>\n  2008→                      )\n  2009→                    }\n  2010→\n  2011→                    // Process/Steps Section\n  2012→                    if (section.section_type === 'process' && content.steps) {\n  2013→                      const steps = content.steps as Array<{ step: number; title: string; description?: string }>\n  2014→                      return (\n  2015→                        <div key={idx} className=\"p-6 rounded-xl bg-[var(--bg-tertiary)]\">\n  2016→                          {section.title && <h3 className=\"text-lg font-semibold text-[var(--text-primary)] mb-4\">{section.title}</h3>}\n  2017→                          <div className=\"space-y-3\">\n  2018→                            {steps.map((step, i) => (\n  2019→                              <div key={i} className=\"flex gap-4 items-start\">\n  2020→                                <div\n  2021→                                  className=\"w-8 h-8 rounded-full flex items-center justify-center text-white font-bold text-sm shrink-0\"\n  2022→                                  style={{ backgroundColor: sectionColor }}\n  2023→                                >\n  2024→                                  {step.step}\n  2025→                                </div>\n  2026→                                <div>\n  2027→                                  <div className=\"font-medium text-[var(--text-primary)]\">{step.title}</div>\n  2028→                                  {step.description && <div className=\"text-sm text-[var(--text-secondary)] mt-1\">{step.description}</div>}\n  2029→                                </div>\n  2030→                              </div>\n  2031→                            ))}\n  2032→                          </div>\n  2033→                        </div>\n  2034→                      )\n  2035→                    }\n  2036→\n  2037→                    // Comparison Section\n  2038→                    if (section.section_type === 'comparison' && content.left && content.right) {\n  2039→                      const left = content.left as { label: string; points: string[] }\n  2040→                      const right = content.right as { label: string; points: string[] }\n  2041→                      return (\n  2042→                        <div key={idx} className=\"p-6 rounded-xl bg-[var(--bg-tertiary)]\">\n  2043→                          {section.title && <h3 className=\"text-lg font-semibold text-[var(--text-primary)] mb-4\">{section.title}</h3>}\n  2044→                          <div className=\"grid grid-cols-2 gap-4\">\n  2045→                            <div className=\"p-4 rounded-lg\" style={{ backgroundColor: `${infographicData.color_scheme![0]}15` }}>\n  2046→                              <div className=\"font-semibold mb-3\" style={{ color: infographicData.color_scheme![0] }}>{left.label}</div>\n  2047→                              <ul className=\"space-y-2\">\n  2048→                                {left.points.map((point, i) => (\n  2049→                                  <li key={i} className=\"text-sm text-[var(--text-secondary)] flex items-start gap-2\">\n  2050→                                    <span style={{ color: infographicData.color_scheme![0] }}>•</span>\n  2051→                                    {point}\n  2052→                                  </li>\n  2053→                                ))}\n  2054→                              </ul>\n  2055→                            </div>\n  2056→                            <div className=\"p-4 rounded-lg\" style={{ backgroundColor: `${infographicData.color_scheme![1]}15` }}>\n  2057→                              <div className=\"font-semibold mb-3\" style={{ color: infographicData.color_scheme![1] }}>{right.label}</div>\n  2058→                              <ul className=\"space-y-2\">\n  2059→                                {right.points.map((point, i) => (\n  2060→                                  <li key={i} className=\"text-sm text-[var(--text-secondary)] flex items-start gap-2\">\n  2061→                                    <span style={{ color: infographicData.color_scheme![1] }}>•</span>\n  2062→                                    {point}\n  2063→                                  </li>\n  2064→                                ))}\n  2065→                              </ul>\n  2066→                            </div>\n  2067→                          </div>\n  2068→                        </div>\n  2069→                      )\n  2070→                    }\n  2071→\n  2072→                    // List Section\n  2073→                    if (section.section_type === 'list' && content.items) {\n  2074→                      const items = content.items as string[]\n  2075→                      return (\n  2076→                        <div key={idx} className=\"p-6 rounded-xl bg-[var(--bg-tertiary)]\">\n  2077→                          {section.title && <h3 className=\"text-lg font-semibold text-[var(--text-primary)] mb-4\">{section.title}</h3>}\n  2078→                          <ul className=\"space-y-3\">\n  2079→                            {items.map((item, i) => (\n  2080→                              <li key={i} className=\"flex items-start gap-3\">\n  2081→                                <div\n  2082→                                  className=\"w-2 h-2 rounded-full mt-2 shrink-0\"\n  2083→                                  style={{ backgroundColor: sectionColor }}\n  2084→                                />\n  2085→                                <span className=\"text-[var(--text-secondary)]\">{item}</span>\n  2086→                              </li>\n  2087→                            ))}\n  2088→                          </ul>\n  2089→                        </div>\n  2090→                      )\n  2091→                    }\n  2092→\n  2093→                    // Quote Section\n  2094→                    if (section.section_type === 'quote') {\n  2095→                      const quote = content.quote as string\n  2096→                      const author = content.author as string | undefined\n  2097→                      return (\n  2098→                        <div\n  2099→                          key={idx}\n  2100→                          className=\"p-6 rounded-xl\"\n  2101→                          style={{\n  2102→                            backgroundColor: `${sectionColor}10`,\n  2103→                            borderLeft: `4px solid ${sectionColor}`\n  2104→                          }}\n  2105→                        >\n  2106→                          {section.title && <h3 className=\"text-lg font-semibold text-[var(--text-primary)] mb-3\">{section.title}</h3>}\n  2107→                          <blockquote className=\"text-lg italic text-[var(--text-primary)]\">\"{quote}\"</blockquote>\n  2108→                          {author && <div className=\"mt-2 text-sm text-[var(--text-secondary)]\">— {author}</div>}\n  2109→                        </div>\n  2110→                      )\n  2111→                    }\n  2112→\n  2113→                    // Default/Header/Footer - simple display\n  2114→                    return (\n  2115→                      <div key={idx} className=\"p-6 rounded-xl bg-[var(--bg-tertiary)]\">\n  2116→                        {section.title && <h3 className=\"text-lg font-semibold text-[var(--text-primary)] mb-2\">{section.title}</h3>}\n  2117→                        {typeof content.subtitle === 'string' && <p className=\"text-[var(--text-secondary)]\">{content.subtitle}</p>}\n  2118→                        {typeof content.text === 'string' && <p className=\"text-sm text-[var(--text-tertiary)]\">{content.text}</p>}\n  2119→                      </div>\n  2120→                    )\n  2121→                  })}\n  2122→\n  2123→                  {/* Style suggestion footer */}\n  2124→                  <p className=\"text-xs text-[var(--text-tertiary)] text-center italic pt-4 border-t border-[rgba(255,255,255,0.1)]\">\n  2125→                    Design suggestion: {infographicData.style_suggestion}\n  2126→                  </p>\n  2127→                </div>\n  2128→              ) : (\n  2129→                <div className=\"text-center py-12 text-[var(--text-tertiary)]\">\n  2130→                  <ImageIcon className=\"h-12 w-12 mx-auto mb-4 opacity-50\" />\n  2131→                  <p>No infographic data available</p>\n  2132→                </div>\n  2133→              )\n  2134→            )}\n  2135→          </div>\n  2136→          </div>\n  2137→        </SheetContent>\n  2138→      </Sheet>\n  2139→\n  2140→      {/* Hidden file input */}\n  2141→      <input\n  2142→        ref={fileInputRef}\n  2143→        type=\"file\"\n  2144→        accept=\".pdf,.docx,.txt,.md\"\n  2145→        className=\"hidden\"\n  2146→      />\n  2147→\n  2148→      {/* Notebook Settings Dialog */}\n  2149→      <NotebookSettingsDialog\n  2150→        open={settingsOpen}\n  2151→        onOpenChange={setSettingsOpen}\n  2152→        settings={notebookSettings}\n  2153→        onSave={saveNotebookSettings}\n  2154→        notebookName={notebook?.name || 'Notebook'}\n  2155→      />\n  2156→    </div>\n  2157→  )\n  2158→}\n  2159→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"68cf2095-ca34-4943-9e73-cbb972757e3a","timestamp":"2026-01-10T17:32:06.229Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend/src/app/notebooks/[id]/page.tsx","content":"'use client'\n\nimport { useEffect, useState, useRef } from 'react'\nimport { useParams, useRouter, useSearchParams } from 'next/navigation'\nimport { motion, AnimatePresence } from 'framer-motion'\nimport { createClient, Notebook, Source, ChatMessage } from '@/lib/supabase'\nimport { chatApi } from '@/lib/api'\nimport { Button } from '@/components/ui/button'\nimport { Input } from '@/components/ui/input'\nimport { Textarea } from '@/components/ui/textarea'\nimport { Badge } from '@/components/ui/badge'\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n} from '@/components/ui/dialog'\nimport {\n  Sheet,\n  SheetContent,\n  SheetDescription,\n  SheetHeader,\n  SheetTitle,\n} from '@/components/ui/sheet'\nimport {\n  ArrowLeft, Loader2, Sparkles, X, RotateCcw,\n  BookOpen, ListChecks, FileText, HelpCircle, Mic, Video, Search, Share2,\n  Maximize2, Minimize2, Table, FileSpreadsheet, Presentation, Image as ImageIcon,\n  History, Settings\n} from 'lucide-react'\n// Toast notifications removed per user request\n// import { toast } from 'sonner'\nimport { User } from '@supabase/supabase-js'\n\nimport { ThreePanelLayout } from '@/components/panels/three-panel-layout'\nimport { SourcesPanel } from '@/components/sources/sources-panel'\nimport { ChatPanel } from '@/components/chat/chat-panel'\nimport { StudioPanel } from '@/components/studio/studio-panel'\nimport type { GenerationConfig } from '@/components/studio/generation-config-dialog'\nimport {\n  useNotebook,\n  useSources,\n  useNotes,\n  useChatSessions,\n  useGeneratedAudio,\n  useGeneratedVideo,\n  useGeneratedResearch,\n  useStudyMaterials,\n  useCreativeOutputs,\n  useInvalidateNotebook,\n} from '@/lib/hooks/use-notebook-queries'\n\n// Study viewers\nimport { FlashcardViewer } from '@/components/study/flashcard-viewer'\nimport { QuizViewer } from '@/components/study/quiz-viewer'\nimport { StudyGuideViewer } from '@/components/study/study-guide-viewer'\nimport { FAQViewer } from '@/components/study/faq-viewer'\nimport { MindMapViewer } from '@/components/study/mind-map-viewer'\n\n// Studio viewers\nimport { AudioPlayer } from '@/components/studio/audio-player'\nimport { VideoPlayer } from '@/components/studio/video-player'\nimport { ResearchReport } from '@/components/studio/research-report'\nimport { InfographicViewer } from '@/components/studio/infographic-viewer'\n\n// Notebook settings\nimport { NotebookSettingsDialog, NotebookSettings } from '@/components/notebook/notebook-settings'\n\ninterface LocalNote {\n  id: string\n  notebook_id: string\n  type: 'written' | 'saved_response'\n  title: string | null\n  content: string | null\n  tags: string[]\n  is_pinned: boolean\n  created_at: string\n  updated_at: string\n}\n\nexport default function NotebookPage() {\n  const params = useParams()\n  const router = useRouter()\n  const searchParams = useSearchParams()\n  const notebookId = params.id as string\n  const supabase = createClient()\n\n  // Core state - React Query for cached data\n  const [user, setUser] = useState<User | null>(null)\n  const [authChecked, setAuthChecked] = useState(false)\n  const [messages, setMessages] = useState<ChatMessage[]>([])\n\n  // React Query hooks for cached data\n  const { data: notebook, isLoading: notebookLoading } = useNotebook(notebookId)\n  const { data: sources = [], isLoading: sourcesLoading } = useSources(notebookId)\n  const { data: notes = [], isLoading: notesLoading } = useNotes(notebookId)\n  const { data: chatSessions = [], isLoading: loadingSessions } = useChatSessions(notebookId)\n  const { data: generatedAudio } = useGeneratedAudio(notebookId)\n  const { data: generatedVideo } = useGeneratedVideo(notebookId)\n  const { data: generatedResearch } = useGeneratedResearch(notebookId)\n  const { data: studyMaterialsData } = useStudyMaterials(notebookId, sources.map(s => ({ id: s.id, name: s.name })))\n  const { data: creativeOutputsData } = useCreativeOutputs(notebookId)\n  const invalidate = useInvalidateNotebook()\n\n  // Derived loading state\n  const loading = !authChecked || notebookLoading || sourcesLoading || notesLoading\n\n  // Chat state\n  const [sending, setSending] = useState(false)\n  const [message, setMessage] = useState('')\n  const [selectedSources, setSelectedSources] = useState<Set<string>>(new Set())\n  const [sessionId, setSessionId] = useState<string | null>(null)\n\n  // Source state\n  const [viewingSource, setViewingSource] = useState<Source | null>(null)\n  const [uploading, setUploading] = useState(false)\n\n  // Notes state\n  const [addNoteOpen, setAddNoteOpen] = useState(false)\n  const [noteTitle, setNoteTitle] = useState('')\n  const [noteContent, setNoteContent] = useState('')\n  const [savingNote, setSavingNote] = useState(false)\n\n  // Settings state\n  const [settingsOpen, setSettingsOpen] = useState(false)\n  const [notebookSettings, setNotebookSettings] = useState<NotebookSettings | null>(null)\n\n  // Audio state\n  const [audioFormat, setAudioFormat] = useState('deep_dive')\n  const [audioInstructions, setAudioInstructions] = useState('')\n  const [generatingAudio, setGeneratingAudio] = useState(false)\n\n  // Video state\n  const [videoStyle, setVideoStyle] = useState('explainer')\n  const [generatingVideo, setGeneratingVideo] = useState(false)\n\n  // Research state\n  const [researchQuery, setResearchQuery] = useState('')\n  const [researchMode, setResearchMode] = useState('fast')\n  const [researching, setResearching] = useState(false)\n\n  // Consolidated generating states - single object to reduce re-renders\n  const [generating, setGenerating] = useState({\n    flashcards: false,\n    quiz: false,\n    studyGuide: false,\n    faq: false,\n    mindMap: false,\n    dataTable: false,\n    report: false,\n    slideDeck: false,\n    infographic: false,\n  })\n\n  // Helper to update single generating state\n  const setGeneratingState = (key: keyof typeof generating, value: boolean) => {\n    setGenerating(prev => ({ ...prev, [key]: value }))\n  }\n\n  // Study results\n  const [flashcards, setFlashcards] = useState<Array<{ id: string; front: string; back: string }>>([])\n  const [quizQuestions, setQuizQuestions] = useState<Array<{ id: string; question: string; options: string[]; correct_index: number; explanation: string }>>([])\n  const [studyGuide, setStudyGuide] = useState<{ title: string; sections: Array<{ heading: string; content: string }> } | null>(null)\n  const [faqItems, setFaqItems] = useState<Array<{ question: string; answer: string }>>([])\n  const [mindMap, setMindMap] = useState<{ title: string; nodes: Array<{ id: string; label: string; description?: string; children?: Array<{ id: string; label: string; description?: string; children?: Array<{ id: string; label: string; description?: string }> }> }> } | null>(null)\n\n  // Creative outputs data\n  const [dataTableData, setDataTableData] = useState<{\n    title: string\n    description: string\n    columns: Array<{ header: string; key: string; type: string }>\n    rows: Array<Record<string, string | number | boolean>>\n  } | null>(null)\n  const [reportData, setReportData] = useState<{\n    title: string\n    executive_summary: string\n    sections: Array<{ heading: string; content: string }>\n    key_takeaways: string[]\n  } | null>(null)\n  const [slideDeckData, setSlideDeckData] = useState<{\n    title: string\n    subtitle?: string\n    slides: Array<{ slide_number: number; title: string; content_type: string; main_content: string; bullet_points?: string[]; speaker_notes?: string }>\n    theme_suggestion: string\n  } | null>(null)\n  // Infographic data - supports new image-based format\n  const [infographicData, setInfographicData] = useState<{\n    // New image-based format\n    images?: Array<{ title: string; prompt: string; imageData: string; mimeType: string }>\n    concepts?: string[]\n    // Legacy format (for backward compatibility)\n    title?: string\n    subtitle?: string\n    color_scheme?: string[]\n    sections?: Array<{ section_type: string; title?: string; content: Record<string, unknown> }>\n    style_suggestion?: string\n  } | null>(null)\n\n  // Study materials metadata (for UI display)\n  const [studyMaterialsMeta, setStudyMaterialsMeta] = useState<Array<{\n    id: string\n    type: string\n    sourceIds: string[]\n    sourceNames: string[]\n    createdAt: string\n    itemCount?: number\n  }>>([])\n\n  // Creative outputs metadata (for UI display)\n  const [creativeOutputsMeta, setCreativeOutputsMeta] = useState<Array<{\n    id: string\n    type: string\n    title: string\n    status: string\n    createdAt: string\n    content?: Record<string, unknown>\n  }>>([])\n\n  const [currentFlashcard, setCurrentFlashcard] = useState(0)\n  const [showFlashcardBack, setShowFlashcardBack] = useState(false)\n  const [currentQuizQuestion, setCurrentQuizQuestion] = useState(0)\n  const [selectedAnswer, setSelectedAnswer] = useState<number | null>(null)\n  const [showQuizAnswer, setShowQuizAnswer] = useState(false)\n\n  // Study materials sheet\n  const [studySheetOpen, setStudySheetOpen] = useState(false)\n  const [sheetWidth, setSheetWidth] = useState(576) // Default width in pixels\n  const [isResizing, setIsResizing] = useState(false)\n  const [activeStudyType, setActiveStudyType] = useState<'flashcards' | 'quiz' | 'guide' | 'faq' | 'mindmap' | 'audio' | 'video' | 'research' | 'datatable' | 'report' | 'slides' | 'infographic' | null>(null)\n\n  // Local state for newly generated content (overrides cached until next fetch)\n  const [localGeneratedAudio, setLocalGeneratedAudio] = useState<typeof generatedAudio | null>(null)\n  const [localGeneratedVideo, setLocalGeneratedVideo] = useState<typeof generatedVideo | null>(null)\n  const [localGeneratedResearch, setLocalGeneratedResearch] = useState<{\n    id: string\n    query: string\n    mode: string\n    status: string\n    progress_message?: string\n    sources_found_count?: number\n    sources_analyzed_count?: number\n    report_content?: string\n    report_citations?: { title: string; url: string }[]\n    created_at: string\n    completed_at?: string\n  } | null>(null)\n\n  // Use local state if set, otherwise use cached data\n  const activeGeneratedAudio = localGeneratedAudio ?? generatedAudio\n  const activeGeneratedVideo = localGeneratedVideo ?? generatedVideo\n  const activeGeneratedResearch = localGeneratedResearch ?? generatedResearch\n\n  // File input ref\n  const fileInputRef = useRef<HTMLInputElement>(null)\n\n  // Initialize - just check auth, React Query handles data fetching\n  useEffect(() => {\n    const init = async () => {\n      const { data: { user } } = await supabase.auth.getUser()\n      if (!user) {\n        router.push('/auth/login')\n        return\n      }\n      setUser(user)\n      setAuthChecked(true)\n    }\n    init()\n  }, [notebookId])\n\n\n  // Load a chat session\n  const loadChatSession = async (loadSessionId: string) => {\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n      const response = await fetch(`/api/notebooks/${notebookId}/chat/sessions/${loadSessionId}`, {\n        headers: {\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n      })\n      const result = await response.json()\n      if (result.data) {\n        setSessionId(loadSessionId)\n        setMessages(result.data.messages || [])\n      }\n    } catch (error) {\n      console.error('Failed to load chat session:', error)\n      \n    }\n  }\n\n  // Start a new chat\n  const startNewChat = () => {\n    setSessionId(null)\n    setMessages([])\n    setMessage('')\n  }\n\n  // Delete a chat session\n  const deleteChatSession = async (deleteSessionId: string) => {\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n      const response = await fetch(`/api/notebooks/${notebookId}/chat/sessions/${deleteSessionId}`, {\n        method: 'DELETE',\n        headers: {\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n      })\n      if (response.ok) {\n        // Invalidate cache to refresh the list\n        invalidate.invalidateChatSessions(notebookId)\n\n        // If we deleted the current session, start a new chat\n        if (deleteSessionId === sessionId) {\n          startNewChat()\n        }\n      }\n    } catch (error) {\n      console.error('Failed to delete chat session:', error)\n\n    }\n  }\n\n  // Rename a chat session\n  const renameChatSession = async (renameSessionId: string, newTitle: string) => {\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n      const response = await fetch(`/api/notebooks/${notebookId}/chat/sessions/${renameSessionId}`, {\n        method: 'PATCH',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n        body: JSON.stringify({ title: newTitle }),\n      })\n      if (response.ok) {\n        // Invalidate cache to refresh the list\n        invalidate.invalidateChatSessions(notebookId)\n      }\n    } catch (error) {\n      console.error('Failed to rename chat session:', error)\n    }\n  }\n\n  // Load selected sources from localStorage after sources are loaded\n  useEffect(() => {\n    if (sources.length > 0 && !loading) {\n      const savedSelection = localStorage.getItem(`notebook-${notebookId}-selected-sources`)\n      if (savedSelection) {\n        try {\n          const savedIds = JSON.parse(savedSelection) as string[]\n          // Only select sources that still exist\n          const validIds = savedIds.filter(id => sources.some(s => s.id === id))\n          if (validIds.length > 0) {\n            setSelectedSources(new Set(validIds))\n          }\n        } catch {\n          // Invalid JSON, ignore\n        }\n      }\n    }\n  }, [sources, loading, notebookId])\n\n  // Save selected sources to localStorage whenever they change\n  useEffect(() => {\n    if (!loading && sources.length > 0) {\n      const selectedArray = Array.from(selectedSources)\n      localStorage.setItem(`notebook-${notebookId}-selected-sources`, JSON.stringify(selectedArray))\n    }\n  }, [selectedSources, notebookId, loading, sources.length])\n\n  // Handle view and itemId query params from history page navigation\n  useEffect(() => {\n    const view = searchParams.get('view')\n    const itemId = searchParams.get('itemId')\n\n    if (view && !loading) {\n      // Map view param to activeStudyType\n      const typeMap: Record<string, typeof activeStudyType> = {\n        audio: 'audio',\n        video: 'video',\n        research: 'research',\n        datatable: 'datatable',\n        report: 'report',\n        slides: 'slides',\n        infographic: 'infographic',\n        flashcards: 'flashcards',\n        quiz: 'quiz',\n        guide: 'guide',\n        faq: 'faq',\n        mindmap: 'mindmap',\n      }\n      const studyType = typeMap[view]\n      if (studyType) {\n        setActiveStudyType(studyType)\n        setStudySheetOpen(true)\n\n        // Clear the query params after handling\n        router.replace(`/notebooks/${notebookId}`, { scroll: false })\n      }\n    }\n  }, [searchParams, loading, notebookId, router])\n\n\n  // Fetch existing creative outputs (data tables, reports, slides, infographics)\n  const fetchCreativeOutputs = async () => {\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n      const response = await fetch(`/api/notebooks/${notebookId}/studio`, {\n        headers: {\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n      })\n      const result = await response.json()\n\n      if (result.data && Array.isArray(result.data)) {\n        // Group by type and get the latest of each\n        const outputsByType: Record<string, typeof result.data[0]> = {}\n        for (const output of result.data) {\n          if (output.status === 'completed' && !outputsByType[output.type]) {\n            outputsByType[output.type] = output\n          }\n        }\n\n        // Build metadata array\n        const metaArray = Object.values(outputsByType).map((output) => ({\n          id: output.id,\n          type: output.type,\n          title: output.title || output.type.replace('_', ' '),\n          status: output.status,\n          createdAt: output.created_at,\n          content: output.content,\n        }))\n        setCreativeOutputsMeta(metaArray)\n\n        // Populate state with the latest content of each type\n        for (const output of Object.values(outputsByType)) {\n          if (output.type === 'data_table' && output.content) {\n            setDataTableData(output.content as typeof dataTableData)\n          } else if (output.type === 'report' && output.content) {\n            setReportData(output.content as typeof reportData)\n          } else if (output.type === 'slide_deck' && output.content) {\n            setSlideDeckData(output.content as typeof slideDeckData)\n          } else if (output.type === 'infographic' && output.content) {\n            setInfographicData(output.content as typeof infographicData)\n          }\n        }\n      }\n    } catch (error) {\n      console.error('Failed to fetch creative outputs:', error)\n    }\n  }\n\n  // Fetch existing study materials from Supabase\n  const fetchStudyMaterials = async (sourcesData?: Source[]) => {\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n      const response = await fetch(`/api/notebooks/${notebookId}/study`, {\n        headers: {\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n      })\n      const result = await response.json()\n\n      if (result.data && Array.isArray(result.data)) {\n        // Group materials by type and get the latest of each\n        const materialsByType: Record<string, typeof result.data[0]> = {}\n        for (const material of result.data) {\n          if (!materialsByType[material.type]) {\n            materialsByType[material.type] = material\n          }\n        }\n\n        // Build metadata array for UI\n        const currentSources = sourcesData || sources\n        const metaArray = Object.values(materialsByType).map((material) => {\n          const sourceIds = material.source_ids || []\n          const sourceNames = sourceIds.map((id: string) => {\n            const source = currentSources.find(s => s.id === id)\n            return source?.name || 'Unknown source'\n          })\n\n          // Calculate item count based on type\n          let itemCount = 0\n          if (material.type === 'flashcards') itemCount = material.data?.flashcards?.length || 0\n          else if (material.type === 'quiz') itemCount = material.data?.questions?.length || 0\n          else if (material.type === 'faq') itemCount = material.data?.faq?.length || 0\n\n          return {\n            id: material.id,\n            type: material.type,\n            sourceIds,\n            sourceNames,\n            createdAt: material.created_at,\n            itemCount,\n          }\n        })\n        setStudyMaterialsMeta(metaArray)\n\n        // Populate state with cached data\n        if (materialsByType.flashcards?.data?.flashcards) {\n          setFlashcards(materialsByType.flashcards.data.flashcards)\n        }\n        if (materialsByType.quiz?.data?.questions) {\n          setQuizQuestions(materialsByType.quiz.data.questions)\n        }\n        if (materialsByType.study_guide?.data) {\n          setStudyGuide(materialsByType.study_guide.data)\n        }\n        if (materialsByType.faq?.data?.faq) {\n          setFaqItems(materialsByType.faq.data.faq)\n        }\n        if (materialsByType.mind_map?.data) {\n          setMindMap(materialsByType.mind_map.data)\n        }\n      }\n    } catch (error) {\n      console.error('Failed to fetch study materials:', error)\n    }\n  }\n\n  // Redirect if notebook doesn't exist\n  useEffect(() => {\n    if (!notebookLoading && !notebook) {\n      router.push('/')\n    }\n  }, [notebook, notebookLoading, router])\n\n  // Load notebook settings when notebook data is available\n  useEffect(() => {\n    if (notebook?.settings) {\n      setNotebookSettings(notebook.settings as unknown as NotebookSettings)\n    }\n  }, [notebook])\n\n  // Save notebook settings\n  const saveNotebookSettings = async (newSettings: NotebookSettings) => {\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n      const response = await fetch(`/api/notebooks/${notebookId}`, {\n        method: 'PATCH',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n        body: JSON.stringify({ settings: newSettings }),\n      })\n\n      if (!response.ok) {\n        throw new Error('Failed to save settings')\n      }\n\n      setNotebookSettings(newSettings)\n      invalidate.invalidateNotebook(notebookId)\n    } catch (error) {\n      console.error('Failed to save notebook settings:', error)\n      throw error\n    }\n  }\n\n  // Source handlers\n  const handleAddSource = async (type: string, data: { input: string; name?: string; file?: File }) => {\n    setUploading(true)\n\n    if (type === 'file') {\n      // Handle file upload - file is passed from the sources panel\n      const file = data.file\n      if (file) {\n        const fileExt = file.name.split('.').pop()?.toLowerCase()\n        const filePath = `${user?.id}/${notebookId}/${Date.now()}.${fileExt}`\n\n        const { error: uploadError } = await supabase.storage\n          .from('sources')\n          .upload(filePath, file)\n\n        if (uploadError) {\n          console.error('Upload error:', uploadError)\n          \n          setUploading(false)\n          return\n        }\n\n        const { data: sourceData, error } = await supabase\n          .from('sources')\n          .insert({\n            notebook_id: notebookId,\n            type: fileExt === 'pdf' ? 'pdf' : fileExt === 'docx' ? 'docx' : 'txt',\n            name: file.name,\n            status: 'ready',\n            file_path: filePath,\n            original_filename: file.name,\n            mime_type: file.type,\n            file_size_bytes: file.size,\n          })\n          .select()\n          .single()\n\n        if (error) {\n          console.error('Source creation error:', error)\n        } else {\n          invalidate.invalidateSources(notebookId)\n        }\n      }\n    } else {\n      let sourceData: Partial<Source> = {\n        notebook_id: notebookId,\n        status: 'ready',\n      }\n\n      if (type === 'youtube') {\n        sourceData = {\n          ...sourceData,\n          type: 'youtube',\n          name: data.name || `YouTube: ${data.input}`,\n          metadata: { url: data.input },\n        }\n      } else if (type === 'url') {\n        sourceData = {\n          ...sourceData,\n          type: 'url',\n          name: data.name || data.input,\n          metadata: { url: data.input },\n        }\n      } else if (type === 'text') {\n        sourceData = {\n          ...sourceData,\n          type: 'text',\n          name: data.name || 'Pasted Text',\n          metadata: { content: data.input },\n        }\n      }\n\n      const { error } = await supabase\n        .from('sources')\n        .insert(sourceData)\n        .select()\n        .single()\n\n      if (error) {\n        console.error('Source creation error:', error)\n      } else {\n        invalidate.invalidateSources(notebookId)\n      }\n    }\n\n    setUploading(false)\n  }\n\n  const handleDeleteSource = async (sourceId: string) => {\n    const { error } = await supabase\n      .from('sources')\n      .delete()\n      .eq('id', sourceId)\n\n    if (error) {\n      console.error('Delete source error:', error)\n    } else {\n      invalidate.invalidateSources(notebookId)\n      selectedSources.delete(sourceId)\n      setSelectedSources(new Set(selectedSources))\n    }\n  }\n\n  const toggleSource = (sourceId: string) => {\n    const newSelected = new Set(selectedSources)\n    if (newSelected.has(sourceId)) {\n      newSelected.delete(sourceId)\n    } else {\n      newSelected.add(sourceId)\n    }\n    setSelectedSources(newSelected)\n  }\n\n  const selectAllSources = () => {\n    if (selectedSources.size === sources.length) {\n      setSelectedSources(new Set())\n    } else {\n      setSelectedSources(new Set(sources.map(s => s.id)))\n    }\n  }\n\n  // Chat handlers\n  const sendMessage = async (overrideMessage?: string) => {\n    const messageToSend = overrideMessage || message\n    if (!messageToSend.trim() || sending) return\n\n    setSending(true)\n    const userMessage: ChatMessage = {\n      id: crypto.randomUUID(),\n      session_id: sessionId || '',\n      role: 'user',\n      content: messageToSend,\n      citations: [],\n      source_ids_used: Array.from(selectedSources),\n      model_used: null,\n      input_tokens: null,\n      output_tokens: null,\n      cost_usd: null,\n      created_at: new Date().toISOString(),\n    }\n    setMessages(prev => [...prev, userMessage])\n    setMessage('')\n\n    try {\n      const response = await chatApi.sendMessage(notebookId, {\n        message: userMessage.content,\n        source_ids: Array.from(selectedSources),\n        session_id: sessionId || undefined,\n      })\n\n      const isNewSession = !sessionId\n      if (response.data.session_id) {\n        setSessionId(response.data.session_id)\n      }\n\n      const aiMessage: ChatMessage = {\n        id: response.data.message_id,\n        session_id: response.data.session_id,\n        role: 'assistant',\n        content: response.data.content,\n        citations: response.data.citations,\n        source_ids_used: Array.from(selectedSources),\n        model_used: response.usage?.model_used || 'gemini-2.0-flash',\n        input_tokens: response.usage?.input_tokens || 0,\n        output_tokens: response.usage?.output_tokens || 0,\n        cost_usd: response.usage?.cost_usd || 0,\n        created_at: new Date().toISOString(),\n      }\n      setMessages(prev => [...prev, aiMessage])\n\n      // Refresh chat sessions if this was a new session\n      if (isNewSession) {\n        invalidate.invalidateChatSessions(notebookId)\n      }\n    } catch {\n      setMessages(prev => prev.filter(m => m.id !== userMessage.id))\n    }\n    setSending(false)\n  }\n\n  const saveResponseAsNote = async (msg: ChatMessage) => {\n    const { error } = await supabase\n      .from('notes')\n      .insert({\n        notebook_id: notebookId,\n        type: 'saved_response',\n        title: `Saved Response - ${new Date().toLocaleDateString()}`,\n        content: msg.content,\n        tags: [],\n      })\n      .select()\n      .single()\n\n    if (error) {\n      console.error('Save note error:', error)\n    } else {\n      invalidate.invalidateNotes(notebookId)\n    }\n  }\n\n  // Notes handlers\n  const createNote = async () => {\n    if (!noteTitle.trim() && !noteContent.trim()) return\n\n    setSavingNote(true)\n    const { error } = await supabase\n      .from('notes')\n      .insert({\n        notebook_id: notebookId,\n        type: 'written',\n        title: noteTitle || 'Untitled Note',\n        content: noteContent,\n        tags: [],\n      })\n      .select()\n      .single()\n\n    if (error) {\n      console.error('Create note error:', error)\n    } else {\n      invalidate.invalidateNotes(notebookId)\n      setNoteTitle('')\n      setNoteContent('')\n      setAddNoteOpen(false)\n    }\n    setSavingNote(false)\n  }\n\n  // Audio generation\n  const generateAudio = async () => {\n    if (selectedSources.size === 0) {\n      \n      return\n    }\n\n    setGeneratingAudio(true)\n    setActiveStudyType('audio')\n    setStudySheetOpen(true)\n\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n      const response = await fetch(`/api/notebooks/${notebookId}/audio`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n        body: JSON.stringify({\n          format: audioFormat,\n          source_ids: Array.from(selectedSources),\n          custom_instructions: audioInstructions || undefined,\n        }),\n      })\n      const result = await response.json()\n      if (result.error) {\n        console.error('Audio generation error:', result.error)\n      } else if (result.data) {\n        setLocalGeneratedAudio(result.data)\n        invalidate.invalidateAudio(notebookId)\n      }\n    } catch (error) {\n      console.error('Audio generation error:', error)\n    }\n    setGeneratingAudio(false)\n  }\n\n  // Video generation\n  const generateVideo = async () => {\n    if (selectedSources.size === 0) {\n      return\n    }\n\n    setGeneratingVideo(true)\n    setActiveStudyType('video')\n    setStudySheetOpen(true)\n\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n      const response = await fetch(`/api/notebooks/${notebookId}/video`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n        body: JSON.stringify({\n          style: videoStyle,\n          source_ids: Array.from(selectedSources),\n        }),\n      })\n      const result = await response.json()\n      if (result.error) {\n        console.error('Video generation error:', result.error)\n      } else if (result.data) {\n        // Map video_file_path to video_url for frontend components\n        setLocalGeneratedVideo({\n          ...result.data,\n          video_url: result.data.video_file_path || result.data.video_url,\n        })\n        invalidate.invalidateVideo(notebookId)\n      }\n    } catch (error) {\n      console.error('Video generation error:', error)\n    }\n    setGeneratingVideo(false)\n  }\n\n  // Research generation\n  const runResearch = async () => {\n    if (!researchQuery.trim()) {\n      return\n    }\n\n    // Clear old research to prevent showing cached results\n    setLocalGeneratedResearch(null)\n    setResearching(true)\n    setActiveStudyType('research')\n    setStudySheetOpen(true)\n\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n      const response = await fetch(`/api/notebooks/${notebookId}/research`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n        body: JSON.stringify({\n          query: researchQuery,\n          mode: researchMode,\n        }),\n      })\n      const result = await response.json()\n      if (result.error) {\n        console.error('Research failed:', result.error)\n        alert(`Research failed: ${result.error}`)\n      } else if (result.data) {\n        setLocalGeneratedResearch(result.data)\n        invalidate.invalidateResearch(notebookId)\n        setResearchQuery('')\n      }\n    } catch (error) {\n      console.error('Research error:', error)\n      alert('Research failed. Please try again.')\n    }\n    setResearching(false)\n  }\n\n  // Study material generation handlers\n  const handleGenerateFlashcards = async () => {\n    setGeneratingState('flashcards', true)\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n      const response = await fetch(`/api/notebooks/${notebookId}/study`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n        body: JSON.stringify({\n          type: 'flashcards',\n          source_ids: Array.from(selectedSources),\n          count: 5,\n        }),\n      })\n      const result = await response.json()\n      if (result.error) {\n        \n      } else if (result.data?.flashcards) {\n        setFlashcards(result.data.flashcards)\n        setCurrentFlashcard(0)\n        setShowFlashcardBack(false)\n        setActiveStudyType('flashcards')\n        setStudySheetOpen(true)\n        fetchStudyMaterials()\n        \n      }\n    } catch {\n      \n    } finally {\n      setGeneratingState('flashcards', false)\n    }\n  }\n\n  const handleGenerateQuiz = async () => {\n    setGeneratingState('quiz', true)\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n      const response = await fetch(`/api/notebooks/${notebookId}/study`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n        body: JSON.stringify({\n          type: 'quiz',\n          source_ids: Array.from(selectedSources),\n          count: 5,\n        }),\n      })\n      const result = await response.json()\n      if (result.error) {\n        \n      } else if (result.data?.questions) {\n        setQuizQuestions(result.data.questions)\n        setCurrentQuizQuestion(0)\n        setSelectedAnswer(null)\n        setShowQuizAnswer(false)\n        setActiveStudyType('quiz')\n        setStudySheetOpen(true)\n        fetchStudyMaterials()\n        \n      }\n    } catch {\n      \n    } finally {\n      setGeneratingState('quiz', false)\n    }\n  }\n\n  const handleGenerateStudyGuide = async () => {\n    setGeneratingState('studyGuide', true)\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n      const response = await fetch(`/api/notebooks/${notebookId}/study`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n        body: JSON.stringify({\n          type: 'study-guide',\n          source_ids: Array.from(selectedSources),\n        }),\n      })\n      const result = await response.json()\n      if (result.error) {\n        \n      } else if (result.data?.sections) {\n        setStudyGuide(result.data)\n        setActiveStudyType('guide')\n        setStudySheetOpen(true)\n        fetchStudyMaterials()\n        \n      }\n    } catch {\n      \n    } finally {\n      setGeneratingState('studyGuide', false)\n    }\n  }\n\n  const handleGenerateFaq = async () => {\n    setGeneratingState('faq', true)\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n      const response = await fetch(`/api/notebooks/${notebookId}/study`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n        body: JSON.stringify({\n          type: 'faq',\n          source_ids: Array.from(selectedSources),\n        }),\n      })\n      const result = await response.json()\n      if (result.error) {\n        \n      } else if (result.data?.faq) {\n        setFaqItems(result.data.faq)\n        setActiveStudyType('faq')\n        setStudySheetOpen(true)\n        fetchStudyMaterials()\n        \n      }\n    } catch {\n      \n    } finally {\n      setGeneratingState('faq', false)\n    }\n  }\n\n  const handleGenerateMindMap = async () => {\n    setGeneratingState('mindMap', true)\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n      const response = await fetch(`/api/notebooks/${notebookId}/study`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n        body: JSON.stringify({\n          type: 'mind-map',\n          source_ids: Array.from(selectedSources),\n        }),\n      })\n      const result = await response.json()\n      if (result.error) {\n\n      } else if (result.data?.nodes) {\n        setMindMap(result.data)\n        setActiveStudyType('mindmap')\n        setStudySheetOpen(true)\n        // Refresh metadata to show updated material\n        fetchStudyMaterials()\n\n      }\n    } catch {\n\n    } finally {\n      setGeneratingState('mindMap', false)\n    }\n  }\n\n  // Unified study material handler with config\n  const handleGenerateStudyMaterial = async (config: GenerationConfig) => {\n    const sourceIds = config.sourceIds && config.sourceIds.length > 0\n      ? config.sourceIds\n      : Array.from(selectedSources)\n\n    if (sourceIds.length === 0) return\n\n    // Set loading state based on type\n    const typeToStateKey: Record<string, keyof typeof generating> = {\n      'flashcards': 'flashcards',\n      'quiz': 'quiz',\n      'study-guide': 'studyGuide',\n      'faq': 'faq',\n      'mind-map': 'mindMap',\n    }\n    const stateKey = typeToStateKey[config.type]\n    if (stateKey) setGeneratingState(stateKey, true)\n\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n\n      // Build request body with all config options\n      const requestBody: Record<string, unknown> = {\n        type: config.type,\n        source_ids: sourceIds,\n      }\n\n      // Add optional config fields\n      if (config.count) requestBody.count = config.count\n      if (config.difficulty) requestBody.difficulty = config.difficulty\n      if (config.focusArea) requestBody.focus_area = config.focusArea\n      if (config.customInstructions) requestBody.custom_instructions = config.customInstructions\n      if (config.questionTypes) requestBody.question_types = config.questionTypes\n\n      const response = await fetch(`/api/notebooks/${notebookId}/study`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n        body: JSON.stringify(requestBody),\n      })\n      const result = await response.json()\n\n      if (result.error) {\n        console.error('Generation error:', result.error)\n      } else if (result.data) {\n        // Handle each type's response\n        switch (config.type) {\n          case 'flashcards':\n            if (result.data.flashcards) {\n              setFlashcards(result.data.flashcards)\n              setCurrentFlashcard(0)\n              setShowFlashcardBack(false)\n              setActiveStudyType('flashcards')\n              setStudySheetOpen(true)\n            }\n            break\n          case 'quiz':\n            if (result.data.questions) {\n              setQuizQuestions(result.data.questions)\n              setCurrentQuizQuestion(0)\n              setSelectedAnswer(null)\n              setShowQuizAnswer(false)\n              setActiveStudyType('quiz')\n              setStudySheetOpen(true)\n            }\n            break\n          case 'study-guide':\n            if (result.data.sections) {\n              setStudyGuide(result.data)\n              setActiveStudyType('guide')\n              setStudySheetOpen(true)\n            }\n            break\n          case 'faq':\n            if (result.data.faq) {\n              setFaqItems(result.data.faq)\n              setActiveStudyType('faq')\n              setStudySheetOpen(true)\n            }\n            break\n          case 'mind-map':\n            if (result.data.nodes) {\n              setMindMap(result.data)\n              setActiveStudyType('mindmap')\n              setStudySheetOpen(true)\n            }\n            break\n        }\n        fetchStudyMaterials()\n      }\n    } catch (error) {\n      console.error('Study material generation failed:', error)\n    } finally {\n      if (stateKey) setGeneratingState(stateKey, false)\n    }\n  }\n\n  // Unified creative output handler with config\n  const handleGenerateCreativeOutput = async (config: GenerationConfig) => {\n    const sourceIds = config.sourceIds && config.sourceIds.length > 0\n      ? config.sourceIds\n      : Array.from(selectedSources)\n\n    if (sourceIds.length === 0) return\n\n    // Set loading state based on type\n    const typeToStateKey2: Record<string, keyof typeof generating> = {\n      'data_table': 'dataTable',\n      'report': 'report',\n      'slide_deck': 'slideDeck',\n      'infographic': 'infographic',\n    }\n    const stateKey2 = typeToStateKey2[config.type]\n    if (stateKey2) setGeneratingState(stateKey2, true)\n\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n\n      // Build request body with all config options\n      const requestBody: Record<string, unknown> = {\n        type: config.type,\n        source_ids: sourceIds,\n      }\n\n      // Add optional config fields\n      if (config.customInstructions) requestBody.custom_instructions = config.customInstructions\n      if (config.focusArea) requestBody.focus_area = config.focusArea\n      if (config.reportType) requestBody.report_type = config.reportType\n      if (config.tone) requestBody.tone = config.tone\n      if (config.slideCount) requestBody.slide_count = config.slideCount\n      if (config.style) requestBody.style = config.style\n      // Infographic-specific options\n      if (config.imageCount) requestBody.image_count = config.imageCount\n      if (config.imageStyle) requestBody.image_style = config.imageStyle\n\n      const response = await fetch(`/api/notebooks/${notebookId}/studio`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n        body: JSON.stringify(requestBody),\n      })\n      const result = await response.json()\n\n      if (result.error) {\n        console.error('Generation error:', result.error)\n      } else if (result.data) {\n        // Handle each type's response\n        switch (config.type) {\n          case 'data_table':\n            setDataTableData(result.data)\n            setActiveStudyType('datatable')\n            setStudySheetOpen(true)\n            break\n          case 'report':\n            setReportData(result.data)\n            setActiveStudyType('report')\n            setStudySheetOpen(true)\n            break\n          case 'slide_deck':\n            setSlideDeckData(result.data)\n            setActiveStudyType('slides')\n            setStudySheetOpen(true)\n            break\n          case 'infographic':\n            setInfographicData(result.data)\n            setActiveStudyType('infographic')\n            setStudySheetOpen(true)\n            break\n        }\n        fetchCreativeOutputs()\n      }\n    } catch (error) {\n      console.error('Creative output generation failed:', error)\n    } finally {\n      if (stateKey2) setGeneratingState(stateKey2, false)\n    }\n  }\n\n  // Creative output generation handlers (legacy - kept for compatibility)\n  const handleGenerateDataTable = async () => {\n    if (selectedSources.size === 0) {\n\n      return\n    }\n    setGeneratingState('dataTable', true)\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n      const response = await fetch(`/api/notebooks/${notebookId}/studio`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n        body: JSON.stringify({\n          type: 'data_table',\n          source_ids: Array.from(selectedSources),\n        }),\n      })\n      const result = await response.json()\n      if (result.error) {\n        \n      } else if (result.data) {\n        setDataTableData(result.data)\n        setActiveStudyType('datatable' as typeof activeStudyType)\n        setStudySheetOpen(true)\n        fetchCreativeOutputs()\n      }\n    } catch {\n      // Error handled silently\n    } finally {\n      setGeneratingState('dataTable', false)\n    }\n  }\n\n  const handleGenerateReport = async (reportType: string) => {\n    if (selectedSources.size === 0) {\n\n      return\n    }\n    setGeneratingState('report', true)\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n      const response = await fetch(`/api/notebooks/${notebookId}/studio`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n        body: JSON.stringify({\n          type: 'report',\n          source_ids: Array.from(selectedSources),\n          report_type: reportType,\n        }),\n      })\n      const result = await response.json()\n      if (result.error) {\n        \n      } else if (result.data) {\n        setReportData(result.data)\n        setActiveStudyType('report' as typeof activeStudyType)\n        setStudySheetOpen(true)\n        fetchCreativeOutputs()\n      }\n    } catch {\n      // Error handled silently\n    } finally {\n      setGeneratingState('report', false)\n    }\n  }\n\n  const handleGenerateSlideDeck = async () => {\n    if (selectedSources.size === 0) {\n\n      return\n    }\n    setGeneratingState('slideDeck', true)\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n      const response = await fetch(`/api/notebooks/${notebookId}/studio`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n        body: JSON.stringify({\n          type: 'slide_deck',\n          source_ids: Array.from(selectedSources),\n        }),\n      })\n      const result = await response.json()\n      if (result.error) {\n        \n      } else if (result.data) {\n        setSlideDeckData(result.data)\n        setActiveStudyType('slides' as typeof activeStudyType)\n        setStudySheetOpen(true)\n        fetchCreativeOutputs()\n      }\n    } catch {\n      // Error handled silently\n    } finally {\n      setGeneratingState('slideDeck', false)\n    }\n  }\n\n  const handleGenerateInfographic = async () => {\n    if (selectedSources.size === 0) {\n\n      return\n    }\n    setGeneratingState('infographic', true)\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n      const response = await fetch(`/api/notebooks/${notebookId}/studio`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n        body: JSON.stringify({\n          type: 'infographic',\n          source_ids: Array.from(selectedSources),\n        }),\n      })\n      const result = await response.json()\n      if (result.error) {\n        \n      } else if (result.data) {\n        setInfographicData(result.data)\n        setActiveStudyType('infographic' as typeof activeStudyType)\n        setStudySheetOpen(true)\n        fetchCreativeOutputs()\n      }\n    } catch {\n      // Error handled silently\n    } finally {\n      setGeneratingState('infographic', false)\n    }\n  }\n\n  // Sheet resize handlers\n  const handleResizeStart = (e: React.MouseEvent) => {\n    e.preventDefault()\n    setIsResizing(true)\n\n    const startX = e.clientX\n    const startWidth = sheetWidth\n\n    const handleMouseMove = (e: MouseEvent) => {\n      const diff = startX - e.clientX\n      const newWidth = Math.min(Math.max(startWidth + diff, 400), window.innerWidth - 50)\n      setSheetWidth(newWidth)\n    }\n\n    const handleMouseUp = () => {\n      setIsResizing(false)\n      document.removeEventListener('mousemove', handleMouseMove)\n      document.removeEventListener('mouseup', handleMouseUp)\n    }\n\n    document.addEventListener('mousemove', handleMouseMove)\n    document.addEventListener('mouseup', handleMouseUp)\n  }\n\n  if (loading) {\n    return (\n      <div className=\"h-screen flex items-center justify-center bg-[var(--bg-primary)]\">\n        <Loader2 className=\"h-8 w-8 animate-spin text-[var(--accent-primary)]\" />\n      </div>\n    )\n  }\n\n  return (\n    <div className=\"h-screen flex flex-col bg-[var(--bg-primary)]\">\n      {/* Header */}\n      <motion.header\n        initial={{ opacity: 0, y: -10 }}\n        animate={{ opacity: 1, y: 0 }}\n        className=\"h-14 bg-[var(--bg-secondary)] border-b border-[rgba(255,255,255,0.1)] px-4 flex items-center gap-4 shrink-0 sticky top-0 z-50\"\n      >\n        <Button\n          variant=\"ghost\"\n          size=\"icon\"\n          onClick={() => router.push('/')}\n          className=\"h-9 w-9 rounded-lg text-[var(--text-secondary)] hover:text-[var(--text-primary)] hover:bg-[var(--bg-tertiary)]\"\n        >\n          <ArrowLeft className=\"h-4 w-4\" />\n        </Button>\n\n        <div className=\"flex items-center gap-3\">\n          <div className=\"w-10 h-10 rounded-xl bg-[var(--bg-tertiary)] flex items-center justify-center text-xl\">\n            {notebook?.emoji}\n          </div>\n          <div>\n            <h1 className=\"font-semibold text-[var(--text-primary)]\">{notebook?.name}</h1>\n            {notebook?.description && (\n              <p className=\"text-xs text-[var(--text-tertiary)] line-clamp-1 max-w-[300px]\">\n                {notebook.description}\n              </p>\n            )}\n          </div>\n        </div>\n\n        <div className=\"flex items-center gap-2 ml-auto\">\n          <Badge className=\"bg-[var(--bg-tertiary)] text-[var(--text-secondary)] border-0 text-xs\">\n            {sources.length} source{sources.length !== 1 ? 's' : ''}\n          </Badge>\n          {selectedSources.size > 0 && (\n            <Badge className=\"bg-[var(--accent-primary)]/20 text-[var(--accent-primary)] border-0 text-xs\">\n              {selectedSources.size} selected\n            </Badge>\n          )}\n          {notebookSettings?.persona?.enabled && (\n            <Badge className=\"bg-purple-500/20 text-purple-400 border-0 text-xs\">\n              {notebookSettings.persona.name || 'Custom Persona'}\n            </Badge>\n          )}\n          <Button\n            variant=\"ghost\"\n            size=\"sm\"\n            onClick={() => setSettingsOpen(true)}\n            className=\"h-9 px-3 rounded-lg text-[var(--text-secondary)] hover:text-[var(--text-primary)] hover:bg-[var(--bg-tertiary)] gap-2\"\n          >\n            <Settings className=\"h-4 w-4\" />\n            <span className=\"hidden sm:inline\">Settings</span>\n          </Button>\n          <Button\n            variant=\"ghost\"\n            size=\"sm\"\n            onClick={() => router.push(`/notebooks/${notebookId}/history`)}\n            className=\"h-9 px-3 rounded-lg text-[var(--text-secondary)] hover:text-[var(--text-primary)] hover:bg-[var(--bg-tertiary)] gap-2\"\n          >\n            <History className=\"h-4 w-4\" />\n            <span className=\"hidden sm:inline\">History</span>\n          </Button>\n        </div>\n      </motion.header>\n\n      {/* Three Panel Layout */}\n      <div className=\"flex-1 overflow-hidden\">\n        <ThreePanelLayout\n          leftPanelTitle=\"Sources\"\n          rightPanelTitle=\"Studio\"\n          leftPanel={\n            <SourcesPanel\n              sources={sources}\n              selectedSources={selectedSources}\n              onToggleSource={toggleSource}\n              onSelectAll={selectAllSources}\n              onAddSource={handleAddSource}\n              onDeleteSource={handleDeleteSource}\n              onViewSource={setViewingSource}\n              uploading={uploading}\n            />\n          }\n          centerPanel={\n            <ChatPanel\n              messages={messages}\n              message={message}\n              onMessageChange={setMessage}\n              onSendMessage={sendMessage}\n              sending={sending}\n              selectedSourcesCount={selectedSources.size}\n              totalSourcesCount={sources.length}\n              onSaveResponse={saveResponseAsNote}\n              sessions={chatSessions}\n              currentSessionId={sessionId}\n              onLoadSession={loadChatSession}\n              onNewChat={startNewChat}\n              onDeleteSession={deleteChatSession}\n              onRenameSession={renameChatSession}\n              loadingSessions={loadingSessions}\n              notebookId={notebookId}\n            />\n          }\n          rightPanel={\n            <StudioPanel\n              notebookId={notebookId}\n              selectedSourcesCount={selectedSources.size}\n              selectedSourceIds={Array.from(selectedSources)}\n              sources={sources.map(s => ({ id: s.id, name: s.name }))}\n              audioFormat={audioFormat}\n              onAudioFormatChange={setAudioFormat}\n              audioInstructions={audioInstructions}\n              onAudioInstructionsChange={setAudioInstructions}\n              onGenerateAudio={generateAudio}\n              generatingAudio={generatingAudio}\n              videoStyle={videoStyle}\n              onVideoStyleChange={setVideoStyle}\n              onGenerateVideo={generateVideo}\n              generatingVideo={generatingVideo}\n              researchQuery={researchQuery}\n              onResearchQueryChange={setResearchQuery}\n              researchMode={researchMode}\n              onResearchModeChange={setResearchMode}\n              onRunResearch={runResearch}\n              researching={researching}\n              onGenerateStudyMaterial={handleGenerateStudyMaterial}\n              generatingFlashcards={generating.flashcards}\n              generatingQuiz={generating.quiz}\n              generatingStudyGuide={generating.studyGuide}\n              generatingFaq={generating.faq}\n              generatingMindMap={generating.mindMap}\n              onGenerateCreativeOutput={handleGenerateCreativeOutput}\n              generatingDataTable={generating.dataTable}\n              generatingReport={generating.report}\n              generatingSlideDeck={generating.slideDeck}\n              generatingInfographic={generating.infographic}\n              creativeOutputs={creativeOutputsMeta}\n              onOpenCreativeOutput={(type) => {\n                const typeMap: Record<string, typeof activeStudyType> = {\n                  data_table: 'datatable',\n                  report: 'report',\n                  slide_deck: 'slides',\n                  infographic: 'infographic',\n                }\n                setActiveStudyType(typeMap[type] || null)\n                setStudySheetOpen(true)\n              }}\n              studyMaterials={studyMaterialsMeta}\n              onOpenStudyMaterial={(type) => {\n                const typeMap: Record<string, typeof activeStudyType> = {\n                  flashcards: 'flashcards',\n                  quiz: 'quiz',\n                  study_guide: 'guide',\n                  faq: 'faq',\n                  mind_map: 'mindmap',\n                }\n                setActiveStudyType(typeMap[type] || null)\n                setStudySheetOpen(true)\n              }}\n              notesCount={notes.length}\n              onAddNote={() => setAddNoteOpen(true)}\n              hasGeneratedAudio={!!activeGeneratedAudio}\n              hasGeneratedVideo={!!activeGeneratedVideo}\n              hasGeneratedResearch={!!activeGeneratedResearch}\n              onOpenAudio={() => { setActiveStudyType('audio'); setStudySheetOpen(true) }}\n              onOpenVideo={() => { setActiveStudyType('video'); setStudySheetOpen(true) }}\n              onOpenResearch={() => { setActiveStudyType('research'); setStudySheetOpen(true) }}\n            />\n          }\n        />\n      </div>\n\n      {/* Source Preview Dialog */}\n      <Dialog open={!!viewingSource} onOpenChange={(open) => !open && setViewingSource(null)}>\n        <DialogContent className=\"sm:max-w-lg bg-[var(--bg-secondary)] border-[rgba(255,255,255,0.1)]\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-3 text-[var(--text-primary)]\">\n              <div className=\"w-10 h-10 rounded-lg bg-[var(--bg-tertiary)] flex items-center justify-center\">\n                <FileText className=\"h-5 w-5\" />\n              </div>\n              {viewingSource?.name}\n            </DialogTitle>\n            <DialogDescription className=\"text-[var(--text-secondary)]\">\n              {viewingSource?.type} source\n            </DialogDescription>\n          </DialogHeader>\n\n          {viewingSource?.metadata && (() => {\n            const meta = viewingSource.metadata as Record<string, unknown>\n            if (viewingSource.type === 'text' && meta.content) {\n              return (\n                <div className=\"p-4 rounded-xl bg-[var(--bg-tertiary)] text-sm max-h-64 overflow-y-auto\">\n                  <p className=\"whitespace-pre-wrap text-[var(--text-secondary)]\">\n                    {String(meta.content)}\n                  </p>\n                </div>\n              )\n            }\n            if ((viewingSource.type === 'youtube' || viewingSource.type === 'url') && meta.url) {\n              return (\n                <div className=\"p-4 rounded-xl bg-[var(--bg-tertiary)] text-sm max-h-64 overflow-y-auto\">\n                  <a\n                    href={String(meta.url)}\n                    target=\"_blank\"\n                    rel=\"noopener noreferrer\"\n                    className=\"text-[var(--accent-primary)] hover:underline break-all\"\n                  >\n                    {String(meta.url)}\n                  </a>\n                </div>\n              )\n            }\n            return null\n          })()}\n        </DialogContent>\n      </Dialog>\n\n      {/* Add Note Dialog */}\n      <Dialog open={addNoteOpen} onOpenChange={setAddNoteOpen}>\n        <DialogContent className=\"sm:max-w-md bg-[var(--bg-secondary)] border-[rgba(255,255,255,0.1)]\">\n          <DialogHeader>\n            <DialogTitle className=\"text-[var(--text-primary)]\">Create Note</DialogTitle>\n            <DialogDescription className=\"text-[var(--text-secondary)]\">\n              Write a new note to save your thoughts.\n            </DialogDescription>\n          </DialogHeader>\n          <div className=\"space-y-4 mt-2\">\n            <div className=\"space-y-2\">\n              <label className=\"text-sm font-medium text-[var(--text-primary)]\">Title</label>\n              <Input\n                placeholder=\"Note title...\"\n                value={noteTitle}\n                onChange={(e) => setNoteTitle(e.target.value)}\n                className=\"h-10 bg-[var(--bg-tertiary)] border-[rgba(255,255,255,0.1)] text-[var(--text-primary)] placeholder:text-[var(--text-tertiary)] focus:border-[var(--accent-primary)] rounded-lg\"\n              />\n            </div>\n            <div className=\"space-y-2\">\n              <label className=\"text-sm font-medium text-[var(--text-primary)]\">Content</label>\n              <Textarea\n                placeholder=\"Write your note...\"\n                value={noteContent}\n                onChange={(e) => setNoteContent(e.target.value)}\n                rows={6}\n                className=\"bg-[var(--bg-tertiary)] border-[rgba(255,255,255,0.1)] text-[var(--text-primary)] placeholder:text-[var(--text-tertiary)] focus:border-[var(--accent-primary)] rounded-lg resize-none\"\n              />\n            </div>\n          </div>\n          <DialogFooter className=\"mt-4\">\n            <Button\n              onClick={createNote}\n              disabled={savingNote}\n              className=\"rounded-lg bg-[var(--accent-primary)] hover:bg-[var(--accent-primary)]/90 text-white\"\n            >\n              {savingNote && <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />}\n              Create Note\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      {/* Study Materials Sheet */}\n      <Sheet open={studySheetOpen} onOpenChange={(open) => {\n        setStudySheetOpen(open)\n        if (!open) setSheetWidth(576)\n      }}>\n        <SheetContent\n          className=\"overflow-y-auto bg-[var(--bg-secondary)] border-[rgba(255,255,255,0.1)] p-0\"\n          style={{ width: sheetWidth, maxWidth: '100vw' }}\n        >\n          {/* Resize Handle */}\n          <div\n            className={`absolute left-0 top-0 bottom-0 w-1.5 cursor-ew-resize hover:bg-[var(--accent-primary)]/50 transition-colors z-50 ${isResizing ? 'bg-[var(--accent-primary)]/50' : ''}`}\n            onMouseDown={handleResizeStart}\n          />\n          <div className=\"p-6\">\n          <SheetHeader>\n            <div className=\"flex items-center gap-2 pr-8\">\n              <SheetTitle className=\"flex items-center gap-2 text-[var(--text-primary)] flex-1\">\n                {activeStudyType === 'flashcards' && <><BookOpen className=\"h-5 w-5 text-blue-500\" /> Flashcards</>}\n                {activeStudyType === 'quiz' && <><ListChecks className=\"h-5 w-5 text-purple-500\" /> Quiz</>}\n                {activeStudyType === 'guide' && <><FileText className=\"h-5 w-5 text-orange-500\" /> Study Guide</>}\n                {activeStudyType === 'faq' && <><HelpCircle className=\"h-5 w-5 text-teal-500\" /> FAQ</>}\n                {activeStudyType === 'mindmap' && <><Share2 className=\"h-5 w-5 text-cyan-500\" /> Mind Map</>}\n                {activeStudyType === 'datatable' && <><Table className=\"h-5 w-5 text-emerald-500\" /> Data Table</>}\n                {activeStudyType === 'report' && <><FileSpreadsheet className=\"h-5 w-5 text-blue-500\" /> Report</>}\n                {activeStudyType === 'slides' && <><Presentation className=\"h-5 w-5 text-violet-500\" /> Slide Deck</>}\n                {activeStudyType === 'infographic' && <><ImageIcon className=\"h-5 w-5 text-rose-500\" /> Infographic</>}\n                {activeStudyType === 'audio' && <><Mic className=\"h-5 w-5 text-orange-500\" /> Audio Overview</>}\n                {activeStudyType === 'video' && <><Video className=\"h-5 w-5 text-purple-500\" /> Video Overview</>}\n                {activeStudyType === 'research' && <><Search className=\"h-5 w-5 text-blue-500\" /> Research Report</>}\n              </SheetTitle>\n              <Button\n                variant=\"ghost\"\n                size=\"icon\"\n                className=\"h-8 w-8 shrink-0\"\n                onClick={() => {\n                  if (sheetWidth < 800) {\n                    setSheetWidth(900) // Wide\n                  } else if (sheetWidth < window.innerWidth - 100) {\n                    setSheetWidth(window.innerWidth - 50) // Full\n                  } else {\n                    setSheetWidth(576) // Normal\n                  }\n                }}\n                title={sheetWidth >= window.innerWidth - 100 ? 'Minimize' : 'Expand'}\n              >\n                {sheetWidth >= window.innerWidth - 100 ? (\n                  <Minimize2 className=\"h-4 w-4\" />\n                ) : (\n                  <Maximize2 className=\"h-4 w-4\" />\n                )}\n              </Button>\n            </div>\n            <SheetDescription className=\"text-[var(--text-secondary)]\">\n              {activeStudyType === 'flashcards' && `${flashcards.length} cards generated from your sources`}\n              {activeStudyType === 'quiz' && `${quizQuestions.length} questions to test your knowledge`}\n              {activeStudyType === 'guide' && 'Comprehensive study guide from your sources'}\n              {activeStudyType === 'faq' && `${faqItems.length} frequently asked questions`}\n              {activeStudyType === 'mindmap' && 'Interactive visualization of key concepts'}\n              {activeStudyType === 'datatable' && 'Structured data extracted from your sources'}\n              {activeStudyType === 'report' && 'Professional document from your sources'}\n              {activeStudyType === 'slides' && 'Presentation slides from your sources'}\n              {activeStudyType === 'infographic' && 'AI-generated images visualizing key concepts'}\n              {activeStudyType === 'audio' && 'Podcast-style audio discussion'}\n              {activeStudyType === 'video' && 'Visual explainer video'}\n              {activeStudyType === 'research' && 'Deep web research findings'}\n            </SheetDescription>\n          </SheetHeader>\n\n          <div className=\"mt-6 relative\">\n            {/* Flashcards View */}\n            {activeStudyType === 'flashcards' && (\n              <FlashcardViewer\n                flashcards={flashcards}\n                onClose={() => setStudySheetOpen(false)}\n              />\n            )}\n\n            {/* Quiz View */}\n            {activeStudyType === 'quiz' && (\n              <QuizViewer\n                questions={quizQuestions}\n                onClose={() => setStudySheetOpen(false)}\n              />\n            )}\n\n            {/* Study Guide View */}\n            {activeStudyType === 'guide' && studyGuide && (\n              <StudyGuideViewer\n                guide={studyGuide}\n                onClose={() => setStudySheetOpen(false)}\n              />\n            )}\n\n            {/* FAQ View */}\n            {activeStudyType === 'faq' && (\n              <FAQViewer\n                items={faqItems}\n                onClose={() => setStudySheetOpen(false)}\n              />\n            )}\n\n            {/* Mind Map View */}\n            {activeStudyType === 'mindmap' && mindMap && (\n              <MindMapViewer\n                title={mindMap.title}\n                nodes={mindMap.nodes}\n                onClose={() => setStudySheetOpen(false)}\n              />\n            )}\n\n            {/* Audio View */}\n            {activeStudyType === 'audio' && (\n              <AudioPlayer\n                audio={activeGeneratedAudio ?? null}\n                isGenerating={generatingAudio}\n                onClose={() => setStudySheetOpen(false)}\n              />\n            )}\n\n            {/* Video View */}\n            {activeStudyType === 'video' && (\n              <VideoPlayer\n                video={activeGeneratedVideo ?? null}\n                isGenerating={generatingVideo}\n                onClose={() => setStudySheetOpen(false)}\n              />\n            )}\n\n            {/* Research View */}\n            {activeStudyType === 'research' && (\n              <ResearchReport\n                research={activeGeneratedResearch ?? null}\n                isResearching={researching}\n                onClose={() => setStudySheetOpen(false)}\n              />\n            )}\n\n            {/* Data Table View */}\n            {activeStudyType === 'datatable' && dataTableData && (\n              <div className=\"space-y-4\">\n                <div className=\"p-4 rounded-xl bg-[var(--bg-tertiary)]\">\n                  <h3 className=\"text-lg font-semibold text-[var(--text-primary)] mb-2\">{dataTableData.title}</h3>\n                  <p className=\"text-sm text-[var(--text-secondary)] mb-4\">{dataTableData.description}</p>\n                  <div className=\"overflow-x-auto\">\n                    <table className=\"w-full text-sm\">\n                      <thead>\n                        <tr className=\"border-b border-[rgba(255,255,255,0.1)]\">\n                          {dataTableData.columns.map((col) => (\n                            <th key={col.key} className=\"text-left p-3 font-medium text-[var(--text-primary)]\">\n                              {col.header}\n                            </th>\n                          ))}\n                        </tr>\n                      </thead>\n                      <tbody>\n                        {dataTableData.rows.map((row, idx) => (\n                          <tr key={idx} className=\"border-b border-[rgba(255,255,255,0.05)] hover:bg-[var(--bg-secondary)]\">\n                            {dataTableData.columns.map((col) => (\n                              <td key={col.key} className=\"p-3 text-[var(--text-secondary)]\">\n                                {String(row[col.key] ?? '')}\n                              </td>\n                            ))}\n                          </tr>\n                        ))}\n                      </tbody>\n                    </table>\n                  </div>\n                </div>\n              </div>\n            )}\n\n            {/* Report View */}\n            {activeStudyType === 'report' && reportData && (\n              <div className=\"space-y-6\">\n                <div className=\"p-4 rounded-xl bg-[var(--bg-tertiary)]\">\n                  <h2 className=\"text-xl font-bold text-[var(--text-primary)] mb-4\">{reportData.title}</h2>\n                  <div className=\"p-4 rounded-lg bg-[var(--accent-primary)]/10 border border-[var(--accent-primary)]/20 mb-6\">\n                    <h3 className=\"text-sm font-semibold text-[var(--accent-primary)] mb-2\">Executive Summary</h3>\n                    <p className=\"text-sm text-[var(--text-secondary)]\">{reportData.executive_summary}</p>\n                  </div>\n                  {reportData.sections.map((section, idx) => (\n                    <div key={idx} className=\"mb-6\">\n                      <h3 className=\"text-lg font-semibold text-[var(--text-primary)] mb-2\">{section.heading}</h3>\n                      <p className=\"text-sm text-[var(--text-secondary)] whitespace-pre-wrap\">{section.content}</p>\n                    </div>\n                  ))}\n                  <div className=\"mt-6 p-4 rounded-lg bg-[var(--bg-secondary)]\">\n                    <h3 className=\"text-sm font-semibold text-[var(--text-primary)] mb-2\">Key Takeaways</h3>\n                    <ul className=\"list-disc list-inside space-y-1\">\n                      {reportData.key_takeaways.map((takeaway, idx) => (\n                        <li key={idx} className=\"text-sm text-[var(--text-secondary)]\">{takeaway}</li>\n                      ))}\n                    </ul>\n                  </div>\n                </div>\n              </div>\n            )}\n\n            {/* Slide Deck View */}\n            {activeStudyType === 'slides' && slideDeckData && (\n              <div className=\"space-y-4\">\n                <div className=\"text-center mb-6\">\n                  <h2 className=\"text-xl font-bold text-[var(--text-primary)]\">{slideDeckData.title}</h2>\n                  {slideDeckData.subtitle && (\n                    <p className=\"text-sm text-[var(--text-secondary)] mt-1\">{slideDeckData.subtitle}</p>\n                  )}\n                  <Badge className=\"mt-2 bg-[var(--bg-tertiary)] text-[var(--text-secondary)]\">\n                    {slideDeckData.slides.length} slides\n                  </Badge>\n                </div>\n                <div className=\"space-y-4\">\n                  {slideDeckData.slides.map((slide) => (\n                    <div key={slide.slide_number} className=\"p-4 rounded-xl bg-[var(--bg-tertiary)] border border-[rgba(255,255,255,0.1)]\">\n                      <div className=\"flex items-center gap-2 mb-3\">\n                        <Badge className=\"bg-[var(--accent-primary)]/20 text-[var(--accent-primary)]\">\n                          {slide.slide_number}\n                        </Badge>\n                        <span className=\"text-xs text-[var(--text-tertiary)] uppercase\">{slide.content_type}</span>\n                      </div>\n                      <h3 className=\"text-lg font-semibold text-[var(--text-primary)] mb-2\">{slide.title}</h3>\n                      <p className=\"text-sm text-[var(--text-secondary)] mb-3\">{slide.main_content}</p>\n                      {slide.bullet_points && slide.bullet_points.length > 0 && (\n                        <ul className=\"list-disc list-inside space-y-1 mb-3\">\n                          {slide.bullet_points.map((point, idx) => (\n                            <li key={idx} className=\"text-sm text-[var(--text-secondary)]\">{point}</li>\n                          ))}\n                        </ul>\n                      )}\n                      {slide.speaker_notes && (\n                        <div className=\"mt-3 p-3 rounded-lg bg-[var(--bg-secondary)] text-xs text-[var(--text-tertiary)]\">\n                          <span className=\"font-medium\">Speaker notes:</span> {slide.speaker_notes}\n                        </div>\n                      )}\n                    </div>\n                  ))}\n                </div>\n              </div>\n            )}\n\n            {/* Infographic View */}\n            {activeStudyType === 'infographic' && infographicData && (\n              // Check if it's the new image-based format\n              infographicData.images && infographicData.images.length > 0 ? (\n                <InfographicViewer\n                  data={{\n                    images: infographicData.images,\n                    concepts: infographicData.concepts || []\n                  }}\n                  onClose={() => setStudySheetOpen(false)}\n                />\n              ) : infographicData.color_scheme && infographicData.sections ? (\n                // Legacy format (backward compatibility)\n                <div className=\"space-y-6\">\n                  {/* Header Section */}\n                  <div\n                    className=\"p-8 rounded-2xl text-center\"\n                    style={{\n                      background: `linear-gradient(135deg, ${infographicData.color_scheme[0]}20 0%, ${infographicData.color_scheme[1]}20 100%)`,\n                      borderLeft: `4px solid ${infographicData.color_scheme[0]}`\n                    }}\n                  >\n                    <h2 className=\"text-2xl font-bold text-[var(--text-primary)]\">{infographicData.title}</h2>\n                    {infographicData.subtitle && (\n                      <p className=\"text-base text-[var(--text-secondary)] mt-2\">{infographicData.subtitle}</p>\n                    )}\n                  </div>\n\n                  {/* Render each section based on type */}\n                  {infographicData.sections.map((section, idx) => {\n                    const sectionColor = infographicData.color_scheme![idx % infographicData.color_scheme!.length]\n                    const content = section.content as Record<string, unknown>\n\n                    // Stats Section\n                    if (section.section_type === 'stats' && content.items) {\n                      const items = content.items as Array<{ value: string; label: string; icon?: string }>\n                      return (\n                        <div key={idx} className=\"p-6 rounded-xl bg-[var(--bg-tertiary)]\">\n                          {section.title && <h3 className=\"text-lg font-semibold text-[var(--text-primary)] mb-4\">{section.title}</h3>}\n                          <div className=\"grid grid-cols-3 gap-4\">\n                            {items.map((item, i) => (\n                              <div key={i} className=\"text-center p-4 rounded-lg\" style={{ backgroundColor: `${sectionColor}15` }}>\n                                <div className=\"text-2xl font-bold\" style={{ color: sectionColor }}>{item.value}</div>\n                                <div className=\"text-sm text-[var(--text-secondary)] mt-1\">{item.label}</div>\n                              </div>\n                            ))}\n                          </div>\n                        </div>\n                      )\n                    }\n\n                    // Timeline Section\n                    if (section.section_type === 'timeline' && content.events) {\n                      const events = content.events as Array<{ date: string; title: string; description?: string }>\n                      return (\n                        <div key={idx} className=\"p-6 rounded-xl bg-[var(--bg-tertiary)]\">\n                          {section.title && <h3 className=\"text-lg font-semibold text-[var(--text-primary)] mb-4\">{section.title}</h3>}\n                          <div className=\"space-y-4\">\n                            {events.map((event, i) => (\n                              <div key={i} className=\"flex gap-4\">\n                                <div className=\"flex flex-col items-center\">\n                                  <div className=\"w-3 h-3 rounded-full\" style={{ backgroundColor: sectionColor }} />\n                                  {i < events.length - 1 && <div className=\"w-0.5 flex-1 mt-1\" style={{ backgroundColor: `${sectionColor}40` }} />}\n                                </div>\n                                <div className=\"flex-1 pb-4\">\n                                  <div className=\"font-semibold\" style={{ color: sectionColor }}>{event.date}</div>\n                                  <div className=\"font-medium text-[var(--text-primary)]\">{event.title}</div>\n                                  {event.description && <div className=\"text-sm text-[var(--text-secondary)] mt-1\">{event.description}</div>}\n                                </div>\n                              </div>\n                            ))}\n                          </div>\n                        </div>\n                      )\n                    }\n\n                    // Process/Steps Section\n                    if (section.section_type === 'process' && content.steps) {\n                      const steps = content.steps as Array<{ step: number; title: string; description?: string }>\n                      return (\n                        <div key={idx} className=\"p-6 rounded-xl bg-[var(--bg-tertiary)]\">\n                          {section.title && <h3 className=\"text-lg font-semibold text-[var(--text-primary)] mb-4\">{section.title}</h3>}\n                          <div className=\"space-y-3\">\n                            {steps.map((step, i) => (\n                              <div key={i} className=\"flex gap-4 items-start\">\n                                <div\n                                  className=\"w-8 h-8 rounded-full flex items-center justify-center text-white font-bold text-sm shrink-0\"\n                                  style={{ backgroundColor: sectionColor }}\n                                >\n                                  {step.step}\n                                </div>\n                                <div>\n                                  <div className=\"font-medium text-[var(--text-primary)]\">{step.title}</div>\n                                  {step.description && <div className=\"text-sm text-[var(--text-secondary)] mt-1\">{step.description}</div>}\n                                </div>\n                              </div>\n                            ))}\n                          </div>\n                        </div>\n                      )\n                    }\n\n                    // Comparison Section\n                    if (section.section_type === 'comparison' && content.left && content.right) {\n                      const left = content.left as { label: string; points: string[] }\n                      const right = content.right as { label: string; points: string[] }\n                      return (\n                        <div key={idx} className=\"p-6 rounded-xl bg-[var(--bg-tertiary)]\">\n                          {section.title && <h3 className=\"text-lg font-semibold text-[var(--text-primary)] mb-4\">{section.title}</h3>}\n                          <div className=\"grid grid-cols-2 gap-4\">\n                            <div className=\"p-4 rounded-lg\" style={{ backgroundColor: `${infographicData.color_scheme![0]}15` }}>\n                              <div className=\"font-semibold mb-3\" style={{ color: infographicData.color_scheme![0] }}>{left.label}</div>\n                              <ul className=\"space-y-2\">\n                                {left.points.map((point, i) => (\n                                  <li key={i} className=\"text-sm text-[var(--text-secondary)] flex items-start gap-2\">\n                                    <span style={{ color: infographicData.color_scheme![0] }}>•</span>\n                                    {point}\n                                  </li>\n                                ))}\n                              </ul>\n                            </div>\n                            <div className=\"p-4 rounded-lg\" style={{ backgroundColor: `${infographicData.color_scheme![1]}15` }}>\n                              <div className=\"font-semibold mb-3\" style={{ color: infographicData.color_scheme![1] }}>{right.label}</div>\n                              <ul className=\"space-y-2\">\n                                {right.points.map((point, i) => (\n                                  <li key={i} className=\"text-sm text-[var(--text-secondary)] flex items-start gap-2\">\n                                    <span style={{ color: infographicData.color_scheme![1] }}>•</span>\n                                    {point}\n                                  </li>\n                                ))}\n                              </ul>\n                            </div>\n                          </div>\n                        </div>\n                      )\n                    }\n\n                    // List Section\n                    if (section.section_type === 'list' && content.items) {\n                      const items = content.items as string[]\n                      return (\n                        <div key={idx} className=\"p-6 rounded-xl bg-[var(--bg-tertiary)]\">\n                          {section.title && <h3 className=\"text-lg font-semibold text-[var(--text-primary)] mb-4\">{section.title}</h3>}\n                          <ul className=\"space-y-3\">\n                            {items.map((item, i) => (\n                              <li key={i} className=\"flex items-start gap-3\">\n                                <div\n                                  className=\"w-2 h-2 rounded-full mt-2 shrink-0\"\n                                  style={{ backgroundColor: sectionColor }}\n                                />\n                                <span className=\"text-[var(--text-secondary)]\">{item}</span>\n                              </li>\n                            ))}\n                          </ul>\n                        </div>\n                      )\n                    }\n\n                    // Quote Section\n                    if (section.section_type === 'quote') {\n                      const quote = content.quote as string\n                      const author = content.author as string | undefined\n                      return (\n                        <div\n                          key={idx}\n                          className=\"p-6 rounded-xl\"\n                          style={{\n                            backgroundColor: `${sectionColor}10`,\n                            borderLeft: `4px solid ${sectionColor}`\n                          }}\n                        >\n                          {section.title && <h3 className=\"text-lg font-semibold text-[var(--text-primary)] mb-3\">{section.title}</h3>}\n                          <blockquote className=\"text-lg italic text-[var(--text-primary)]\">\"{quote}\"</blockquote>\n                          {author && <div className=\"mt-2 text-sm text-[var(--text-secondary)]\">— {author}</div>}\n                        </div>\n                      )\n                    }\n\n                    // Default/Header/Footer - simple display\n                    return (\n                      <div key={idx} className=\"p-6 rounded-xl bg-[var(--bg-tertiary)]\">\n                        {section.title && <h3 className=\"text-lg font-semibold text-[var(--text-primary)] mb-2\">{section.title}</h3>}\n                        {typeof content.subtitle === 'string' && <p className=\"text-[var(--text-secondary)]\">{content.subtitle}</p>}\n                        {typeof content.text === 'string' && <p className=\"text-sm text-[var(--text-tertiary)]\">{content.text}</p>}\n                      </div>\n                    )\n                  })}\n\n                  {/* Style suggestion footer */}\n                  <p className=\"text-xs text-[var(--text-tertiary)] text-center italic pt-4 border-t border-[rgba(255,255,255,0.1)]\">\n                    Design suggestion: {infographicData.style_suggestion}\n                  </p>\n                </div>\n              ) : (\n                <div className=\"text-center py-12 text-[var(--text-tertiary)]\">\n                  <ImageIcon className=\"h-12 w-12 mx-auto mb-4 opacity-50\" />\n                  <p>No infographic data available</p>\n                </div>\n              )\n            )}\n          </div>\n          </div>\n        </SheetContent>\n      </Sheet>\n\n      {/* Hidden file input */}\n      <input\n        ref={fileInputRef}\n        type=\"file\"\n        accept=\".pdf,.docx,.txt,.md\"\n        className=\"hidden\"\n      />\n\n      {/* Notebook Settings Dialog */}\n      <NotebookSettingsDialog\n        open={settingsOpen}\n        onOpenChange={setSettingsOpen}\n        settings={notebookSettings}\n        onSave={saveNotebookSettings}\n        notebookName={notebook?.name || 'Notebook'}\n      />\n    </div>\n  )\n}\n","numLines":2159,"startLine":1,"totalLines":2159}},"sourceToolAssistantUUID":"bf0ccf9a-d8bb-4e83-a216-0f4abe628f43"}
{"parentUuid":"68cf2095-ca34-4943-9e73-cbb972757e3a","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","message":{"model":"claude-opus-4-5-20251101","id":"msg_01D7fR6FQ3wBi126dMEYrh7x","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"The file is quite long. I need to add the export handler to the page component. Let me add:\n\n1. Import the exportNotebook function from export-utils.ts\n2. Add the exportingNotebook state\n3. Add the handleExportNotebook handler function\n4. Pass the export props to the StudioPanel\n\nLet me make these changes.","signature":"EtcDCkYICxgCKkDkxCzZVh4gTILWRvmWgSj32wjyIFegYwGMB7QvT9Y9dgcrcZtJJX/Y1mXo1Thch0c7L7DJtf36qumEkvAKNVfCEgwa40fiq2kqhVZlL04aDMubcbgGa/hqGqAL7SIwpR3DXsJm9WrXF2Ow8n52IS4olzWF4VnLZjvpG7v98YlF6pEoDvR8eEE8ACIkBfqBKr4CyajkQVw3jyMkDOZIEb0cmbA4A3q71fK4VoDaf5pFc474uwKTvEtd+yuvqFEvyDpOpJ9a4alvIPft60yfbk/a8Undmig+a5JCtf3LwRg8bX/dAQWN+OeCvYeBW3Et0rvYedOQ8YPKggjbCSRloyo7KyVp6SukGnMf5TO6kXXZNZAncRMm+qMcugGJ8IfcRf/uogSoGqifhyV3mUHEzvbNal8RjLgCug/Y2x72zhHNYgahgTxsSW2X7eFF1HdiLLjjsMjQ/x99EuHsl0L/F0TPWjUVBgi5wSQb32iTeMJ2YPUe/qq5Tij0dnRt8YldWBvjsxIeYc3C5PVfAO+afU0ooNS4i1RsyOBaOCNk51FpQYAbXb/AGuXmDpfiGA0Vhj83CaZITNR5EH8XTjpudlsRSLpDwm9qkFIJQ1ALH+vLGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":31476,"cache_read_input_tokens":101386,"cache_creation":{"ephemeral_5m_input_tokens":31476,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CWz6ZoQMB7pGw1GaWowth","type":"assistant","uuid":"25ce1ed9-42f7-4b09-afdf-32704c3f80ca","timestamp":"2026-01-10T17:32:14.141Z"}
{"parentUuid":"25ce1ed9-42f7-4b09-afdf-32704c3f80ca","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","message":{"model":"claude-opus-4-5-20251101","id":"msg_01D7fR6FQ3wBi126dMEYrh7x","type":"message","role":"assistant","content":[{"type":"text","text":"I need to add the export handler to the notebook page. Let me make the necessary changes."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":31476,"cache_read_input_tokens":101386,"cache_creation":{"ephemeral_5m_input_tokens":31476,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CWz6ZoQMB7pGw1GaWowth","type":"assistant","uuid":"080d1029-219a-4465-8575-33d755a62c2f","timestamp":"2026-01-10T17:32:14.481Z"}
{"parentUuid":"080d1029-219a-4465-8575-33d755a62c2f","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","message":{"model":"claude-opus-4-5-20251101","id":"msg_01D7fR6FQ3wBi126dMEYrh7x","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01JHV6Nermc4sy3pLHSB3ch5","name":"Edit","input":{"replace_all":false,"file_path":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend/src/app/notebooks/[id]/page.tsx","old_string":"import { ThreePanelLayout } from '@/components/panels/three-panel-layout'\nimport { SourcesPanel } from '@/components/sources/sources-panel'\nimport { ChatPanel } from '@/components/chat/chat-panel'\nimport { StudioPanel } from '@/components/studio/studio-panel'\nimport type { GenerationConfig } from '@/components/studio/generation-config-dialog'","new_string":"import { ThreePanelLayout } from '@/components/panels/three-panel-layout'\nimport { SourcesPanel } from '@/components/sources/sources-panel'\nimport { ChatPanel } from '@/components/chat/chat-panel'\nimport { StudioPanel, ExportOptionsState } from '@/components/studio/studio-panel'\nimport type { GenerationConfig } from '@/components/studio/generation-config-dialog'\nimport { exportNotebook } from '@/lib/export-utils'"}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":31476,"cache_read_input_tokens":101386,"cache_creation":{"ephemeral_5m_input_tokens":31476,"ephemeral_1h_input_tokens":0},"output_tokens":466,"service_tier":"standard"}},"requestId":"req_011CWz6ZoQMB7pGw1GaWowth","type":"assistant","uuid":"5b7d372e-40f4-4869-bee1-e725bcf5b005","timestamp":"2026-01-10T17:32:18.616Z"}
{"type":"file-history-snapshot","messageId":"5b7d372e-40f4-4869-bee1-e725bcf5b005","snapshot":{"messageId":"973ebb96-60df-4671-b9c2-0c4aefc8516e","trackedFileBackups":{"backend/app/routers/export.py":{"backupFileName":null,"version":1,"backupTime":"2026-01-10T17:28:16.452Z"},"backend/app/main.py":{"backupFileName":"f16da9f396306523@v1","version":1,"backupTime":"2026-01-10T17:28:31.217Z"},"frontend/src/app/api/notebooks/[id]/export/route.ts":{"backupFileName":"85dcaadfd8a8a6e9@v1","version":1,"backupTime":"2026-01-10T17:29:25.531Z"},"frontend/src/lib/export-utils.ts":{"backupFileName":"dc1af29a22407c10@v1","version":1,"backupTime":"2026-01-10T17:30:32.804Z"},"frontend/src/components/studio/studio-panel.tsx":{"backupFileName":"e902adf91d326abb@v1","version":1,"backupTime":"2026-01-10T17:30:54.009Z"},"frontend/src/app/notebooks/[id]/page.tsx":{"backupFileName":"f23aff8cbc9d216b@v1","version":1,"backupTime":"2026-01-10T17:32:18.674Z"}},"timestamp":"2026-01-10T17:26:46.087Z"},"isSnapshotUpdate":true}
{"parentUuid":"5b7d372e-40f4-4869-bee1-e725bcf5b005","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01JHV6Nermc4sy3pLHSB3ch5","type":"tool_result","content":"The file /Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend/src/app/notebooks/[id]/page.tsx has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n    33→// Toast notifications removed per user request\n    34→// import { toast } from 'sonner'\n    35→import { User } from '@supabase/supabase-js'\n    36→\n    37→import { ThreePanelLayout } from '@/components/panels/three-panel-layout'\n    38→import { SourcesPanel } from '@/components/sources/sources-panel'\n    39→import { ChatPanel } from '@/components/chat/chat-panel'\n    40→import { StudioPanel, ExportOptionsState } from '@/components/studio/studio-panel'\n    41→import type { GenerationConfig } from '@/components/studio/generation-config-dialog'\n    42→import { exportNotebook } from '@/lib/export-utils'\n    43→import {\n    44→  useNotebook,\n    45→  useSources,\n    46→  useNotes,"}]},"uuid":"395f89b6-bec4-4ee2-a22d-0ec64ccce118","timestamp":"2026-01-10T17:32:18.665Z","toolUseResult":{"filePath":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend/src/app/notebooks/[id]/page.tsx","oldString":"import { ThreePanelLayout } from '@/components/panels/three-panel-layout'\nimport { SourcesPanel } from '@/components/sources/sources-panel'\nimport { ChatPanel } from '@/components/chat/chat-panel'\nimport { StudioPanel } from '@/components/studio/studio-panel'\nimport type { GenerationConfig } from '@/components/studio/generation-config-dialog'","newString":"import { ThreePanelLayout } from '@/components/panels/three-panel-layout'\nimport { SourcesPanel } from '@/components/sources/sources-panel'\nimport { ChatPanel } from '@/components/chat/chat-panel'\nimport { StudioPanel, ExportOptionsState } from '@/components/studio/studio-panel'\nimport type { GenerationConfig } from '@/components/studio/generation-config-dialog'\nimport { exportNotebook } from '@/lib/export-utils'","originalFile":"'use client'\n\nimport { useEffect, useState, useRef } from 'react'\nimport { useParams, useRouter, useSearchParams } from 'next/navigation'\nimport { motion, AnimatePresence } from 'framer-motion'\nimport { createClient, Notebook, Source, ChatMessage } from '@/lib/supabase'\nimport { chatApi } from '@/lib/api'\nimport { Button } from '@/components/ui/button'\nimport { Input } from '@/components/ui/input'\nimport { Textarea } from '@/components/ui/textarea'\nimport { Badge } from '@/components/ui/badge'\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n} from '@/components/ui/dialog'\nimport {\n  Sheet,\n  SheetContent,\n  SheetDescription,\n  SheetHeader,\n  SheetTitle,\n} from '@/components/ui/sheet'\nimport {\n  ArrowLeft, Loader2, Sparkles, X, RotateCcw,\n  BookOpen, ListChecks, FileText, HelpCircle, Mic, Video, Search, Share2,\n  Maximize2, Minimize2, Table, FileSpreadsheet, Presentation, Image as ImageIcon,\n  History, Settings\n} from 'lucide-react'\n// Toast notifications removed per user request\n// import { toast } from 'sonner'\nimport { User } from '@supabase/supabase-js'\n\nimport { ThreePanelLayout } from '@/components/panels/three-panel-layout'\nimport { SourcesPanel } from '@/components/sources/sources-panel'\nimport { ChatPanel } from '@/components/chat/chat-panel'\nimport { StudioPanel } from '@/components/studio/studio-panel'\nimport type { GenerationConfig } from '@/components/studio/generation-config-dialog'\nimport {\n  useNotebook,\n  useSources,\n  useNotes,\n  useChatSessions,\n  useGeneratedAudio,\n  useGeneratedVideo,\n  useGeneratedResearch,\n  useStudyMaterials,\n  useCreativeOutputs,\n  useInvalidateNotebook,\n} from '@/lib/hooks/use-notebook-queries'\n\n// Study viewers\nimport { FlashcardViewer } from '@/components/study/flashcard-viewer'\nimport { QuizViewer } from '@/components/study/quiz-viewer'\nimport { StudyGuideViewer } from '@/components/study/study-guide-viewer'\nimport { FAQViewer } from '@/components/study/faq-viewer'\nimport { MindMapViewer } from '@/components/study/mind-map-viewer'\n\n// Studio viewers\nimport { AudioPlayer } from '@/components/studio/audio-player'\nimport { VideoPlayer } from '@/components/studio/video-player'\nimport { ResearchReport } from '@/components/studio/research-report'\nimport { InfographicViewer } from '@/components/studio/infographic-viewer'\n\n// Notebook settings\nimport { NotebookSettingsDialog, NotebookSettings } from '@/components/notebook/notebook-settings'\n\ninterface LocalNote {\n  id: string\n  notebook_id: string\n  type: 'written' | 'saved_response'\n  title: string | null\n  content: string | null\n  tags: string[]\n  is_pinned: boolean\n  created_at: string\n  updated_at: string\n}\n\nexport default function NotebookPage() {\n  const params = useParams()\n  const router = useRouter()\n  const searchParams = useSearchParams()\n  const notebookId = params.id as string\n  const supabase = createClient()\n\n  // Core state - React Query for cached data\n  const [user, setUser] = useState<User | null>(null)\n  const [authChecked, setAuthChecked] = useState(false)\n  const [messages, setMessages] = useState<ChatMessage[]>([])\n\n  // React Query hooks for cached data\n  const { data: notebook, isLoading: notebookLoading } = useNotebook(notebookId)\n  const { data: sources = [], isLoading: sourcesLoading } = useSources(notebookId)\n  const { data: notes = [], isLoading: notesLoading } = useNotes(notebookId)\n  const { data: chatSessions = [], isLoading: loadingSessions } = useChatSessions(notebookId)\n  const { data: generatedAudio } = useGeneratedAudio(notebookId)\n  const { data: generatedVideo } = useGeneratedVideo(notebookId)\n  const { data: generatedResearch } = useGeneratedResearch(notebookId)\n  const { data: studyMaterialsData } = useStudyMaterials(notebookId, sources.map(s => ({ id: s.id, name: s.name })))\n  const { data: creativeOutputsData } = useCreativeOutputs(notebookId)\n  const invalidate = useInvalidateNotebook()\n\n  // Derived loading state\n  const loading = !authChecked || notebookLoading || sourcesLoading || notesLoading\n\n  // Chat state\n  const [sending, setSending] = useState(false)\n  const [message, setMessage] = useState('')\n  const [selectedSources, setSelectedSources] = useState<Set<string>>(new Set())\n  const [sessionId, setSessionId] = useState<string | null>(null)\n\n  // Source state\n  const [viewingSource, setViewingSource] = useState<Source | null>(null)\n  const [uploading, setUploading] = useState(false)\n\n  // Notes state\n  const [addNoteOpen, setAddNoteOpen] = useState(false)\n  const [noteTitle, setNoteTitle] = useState('')\n  const [noteContent, setNoteContent] = useState('')\n  const [savingNote, setSavingNote] = useState(false)\n\n  // Settings state\n  const [settingsOpen, setSettingsOpen] = useState(false)\n  const [notebookSettings, setNotebookSettings] = useState<NotebookSettings | null>(null)\n\n  // Audio state\n  const [audioFormat, setAudioFormat] = useState('deep_dive')\n  const [audioInstructions, setAudioInstructions] = useState('')\n  const [generatingAudio, setGeneratingAudio] = useState(false)\n\n  // Video state\n  const [videoStyle, setVideoStyle] = useState('explainer')\n  const [generatingVideo, setGeneratingVideo] = useState(false)\n\n  // Research state\n  const [researchQuery, setResearchQuery] = useState('')\n  const [researchMode, setResearchMode] = useState('fast')\n  const [researching, setResearching] = useState(false)\n\n  // Consolidated generating states - single object to reduce re-renders\n  const [generating, setGenerating] = useState({\n    flashcards: false,\n    quiz: false,\n    studyGuide: false,\n    faq: false,\n    mindMap: false,\n    dataTable: false,\n    report: false,\n    slideDeck: false,\n    infographic: false,\n  })\n\n  // Helper to update single generating state\n  const setGeneratingState = (key: keyof typeof generating, value: boolean) => {\n    setGenerating(prev => ({ ...prev, [key]: value }))\n  }\n\n  // Study results\n  const [flashcards, setFlashcards] = useState<Array<{ id: string; front: string; back: string }>>([])\n  const [quizQuestions, setQuizQuestions] = useState<Array<{ id: string; question: string; options: string[]; correct_index: number; explanation: string }>>([])\n  const [studyGuide, setStudyGuide] = useState<{ title: string; sections: Array<{ heading: string; content: string }> } | null>(null)\n  const [faqItems, setFaqItems] = useState<Array<{ question: string; answer: string }>>([])\n  const [mindMap, setMindMap] = useState<{ title: string; nodes: Array<{ id: string; label: string; description?: string; children?: Array<{ id: string; label: string; description?: string; children?: Array<{ id: string; label: string; description?: string }> }> }> } | null>(null)\n\n  // Creative outputs data\n  const [dataTableData, setDataTableData] = useState<{\n    title: string\n    description: string\n    columns: Array<{ header: string; key: string; type: string }>\n    rows: Array<Record<string, string | number | boolean>>\n  } | null>(null)\n  const [reportData, setReportData] = useState<{\n    title: string\n    executive_summary: string\n    sections: Array<{ heading: string; content: string }>\n    key_takeaways: string[]\n  } | null>(null)\n  const [slideDeckData, setSlideDeckData] = useState<{\n    title: string\n    subtitle?: string\n    slides: Array<{ slide_number: number; title: string; content_type: string; main_content: string; bullet_points?: string[]; speaker_notes?: string }>\n    theme_suggestion: string\n  } | null>(null)\n  // Infographic data - supports new image-based format\n  const [infographicData, setInfographicData] = useState<{\n    // New image-based format\n    images?: Array<{ title: string; prompt: string; imageData: string; mimeType: string }>\n    concepts?: string[]\n    // Legacy format (for backward compatibility)\n    title?: string\n    subtitle?: string\n    color_scheme?: string[]\n    sections?: Array<{ section_type: string; title?: string; content: Record<string, unknown> }>\n    style_suggestion?: string\n  } | null>(null)\n\n  // Study materials metadata (for UI display)\n  const [studyMaterialsMeta, setStudyMaterialsMeta] = useState<Array<{\n    id: string\n    type: string\n    sourceIds: string[]\n    sourceNames: string[]\n    createdAt: string\n    itemCount?: number\n  }>>([])\n\n  // Creative outputs metadata (for UI display)\n  const [creativeOutputsMeta, setCreativeOutputsMeta] = useState<Array<{\n    id: string\n    type: string\n    title: string\n    status: string\n    createdAt: string\n    content?: Record<string, unknown>\n  }>>([])\n\n  const [currentFlashcard, setCurrentFlashcard] = useState(0)\n  const [showFlashcardBack, setShowFlashcardBack] = useState(false)\n  const [currentQuizQuestion, setCurrentQuizQuestion] = useState(0)\n  const [selectedAnswer, setSelectedAnswer] = useState<number | null>(null)\n  const [showQuizAnswer, setShowQuizAnswer] = useState(false)\n\n  // Study materials sheet\n  const [studySheetOpen, setStudySheetOpen] = useState(false)\n  const [sheetWidth, setSheetWidth] = useState(576) // Default width in pixels\n  const [isResizing, setIsResizing] = useState(false)\n  const [activeStudyType, setActiveStudyType] = useState<'flashcards' | 'quiz' | 'guide' | 'faq' | 'mindmap' | 'audio' | 'video' | 'research' | 'datatable' | 'report' | 'slides' | 'infographic' | null>(null)\n\n  // Local state for newly generated content (overrides cached until next fetch)\n  const [localGeneratedAudio, setLocalGeneratedAudio] = useState<typeof generatedAudio | null>(null)\n  const [localGeneratedVideo, setLocalGeneratedVideo] = useState<typeof generatedVideo | null>(null)\n  const [localGeneratedResearch, setLocalGeneratedResearch] = useState<{\n    id: string\n    query: string\n    mode: string\n    status: string\n    progress_message?: string\n    sources_found_count?: number\n    sources_analyzed_count?: number\n    report_content?: string\n    report_citations?: { title: string; url: string }[]\n    created_at: string\n    completed_at?: string\n  } | null>(null)\n\n  // Use local state if set, otherwise use cached data\n  const activeGeneratedAudio = localGeneratedAudio ?? generatedAudio\n  const activeGeneratedVideo = localGeneratedVideo ?? generatedVideo\n  const activeGeneratedResearch = localGeneratedResearch ?? generatedResearch\n\n  // File input ref\n  const fileInputRef = useRef<HTMLInputElement>(null)\n\n  // Initialize - just check auth, React Query handles data fetching\n  useEffect(() => {\n    const init = async () => {\n      const { data: { user } } = await supabase.auth.getUser()\n      if (!user) {\n        router.push('/auth/login')\n        return\n      }\n      setUser(user)\n      setAuthChecked(true)\n    }\n    init()\n  }, [notebookId])\n\n\n  // Load a chat session\n  const loadChatSession = async (loadSessionId: string) => {\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n      const response = await fetch(`/api/notebooks/${notebookId}/chat/sessions/${loadSessionId}`, {\n        headers: {\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n      })\n      const result = await response.json()\n      if (result.data) {\n        setSessionId(loadSessionId)\n        setMessages(result.data.messages || [])\n      }\n    } catch (error) {\n      console.error('Failed to load chat session:', error)\n      \n    }\n  }\n\n  // Start a new chat\n  const startNewChat = () => {\n    setSessionId(null)\n    setMessages([])\n    setMessage('')\n  }\n\n  // Delete a chat session\n  const deleteChatSession = async (deleteSessionId: string) => {\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n      const response = await fetch(`/api/notebooks/${notebookId}/chat/sessions/${deleteSessionId}`, {\n        method: 'DELETE',\n        headers: {\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n      })\n      if (response.ok) {\n        // Invalidate cache to refresh the list\n        invalidate.invalidateChatSessions(notebookId)\n\n        // If we deleted the current session, start a new chat\n        if (deleteSessionId === sessionId) {\n          startNewChat()\n        }\n      }\n    } catch (error) {\n      console.error('Failed to delete chat session:', error)\n\n    }\n  }\n\n  // Rename a chat session\n  const renameChatSession = async (renameSessionId: string, newTitle: string) => {\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n      const response = await fetch(`/api/notebooks/${notebookId}/chat/sessions/${renameSessionId}`, {\n        method: 'PATCH',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n        body: JSON.stringify({ title: newTitle }),\n      })\n      if (response.ok) {\n        // Invalidate cache to refresh the list\n        invalidate.invalidateChatSessions(notebookId)\n      }\n    } catch (error) {\n      console.error('Failed to rename chat session:', error)\n    }\n  }\n\n  // Load selected sources from localStorage after sources are loaded\n  useEffect(() => {\n    if (sources.length > 0 && !loading) {\n      const savedSelection = localStorage.getItem(`notebook-${notebookId}-selected-sources`)\n      if (savedSelection) {\n        try {\n          const savedIds = JSON.parse(savedSelection) as string[]\n          // Only select sources that still exist\n          const validIds = savedIds.filter(id => sources.some(s => s.id === id))\n          if (validIds.length > 0) {\n            setSelectedSources(new Set(validIds))\n          }\n        } catch {\n          // Invalid JSON, ignore\n        }\n      }\n    }\n  }, [sources, loading, notebookId])\n\n  // Save selected sources to localStorage whenever they change\n  useEffect(() => {\n    if (!loading && sources.length > 0) {\n      const selectedArray = Array.from(selectedSources)\n      localStorage.setItem(`notebook-${notebookId}-selected-sources`, JSON.stringify(selectedArray))\n    }\n  }, [selectedSources, notebookId, loading, sources.length])\n\n  // Handle view and itemId query params from history page navigation\n  useEffect(() => {\n    const view = searchParams.get('view')\n    const itemId = searchParams.get('itemId')\n\n    if (view && !loading) {\n      // Map view param to activeStudyType\n      const typeMap: Record<string, typeof activeStudyType> = {\n        audio: 'audio',\n        video: 'video',\n        research: 'research',\n        datatable: 'datatable',\n        report: 'report',\n        slides: 'slides',\n        infographic: 'infographic',\n        flashcards: 'flashcards',\n        quiz: 'quiz',\n        guide: 'guide',\n        faq: 'faq',\n        mindmap: 'mindmap',\n      }\n      const studyType = typeMap[view]\n      if (studyType) {\n        setActiveStudyType(studyType)\n        setStudySheetOpen(true)\n\n        // Clear the query params after handling\n        router.replace(`/notebooks/${notebookId}`, { scroll: false })\n      }\n    }\n  }, [searchParams, loading, notebookId, router])\n\n\n  // Fetch existing creative outputs (data tables, reports, slides, infographics)\n  const fetchCreativeOutputs = async () => {\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n      const response = await fetch(`/api/notebooks/${notebookId}/studio`, {\n        headers: {\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n      })\n      const result = await response.json()\n\n      if (result.data && Array.isArray(result.data)) {\n        // Group by type and get the latest of each\n        const outputsByType: Record<string, typeof result.data[0]> = {}\n        for (const output of result.data) {\n          if (output.status === 'completed' && !outputsByType[output.type]) {\n            outputsByType[output.type] = output\n          }\n        }\n\n        // Build metadata array\n        const metaArray = Object.values(outputsByType).map((output) => ({\n          id: output.id,\n          type: output.type,\n          title: output.title || output.type.replace('_', ' '),\n          status: output.status,\n          createdAt: output.created_at,\n          content: output.content,\n        }))\n        setCreativeOutputsMeta(metaArray)\n\n        // Populate state with the latest content of each type\n        for (const output of Object.values(outputsByType)) {\n          if (output.type === 'data_table' && output.content) {\n            setDataTableData(output.content as typeof dataTableData)\n          } else if (output.type === 'report' && output.content) {\n            setReportData(output.content as typeof reportData)\n          } else if (output.type === 'slide_deck' && output.content) {\n            setSlideDeckData(output.content as typeof slideDeckData)\n          } else if (output.type === 'infographic' && output.content) {\n            setInfographicData(output.content as typeof infographicData)\n          }\n        }\n      }\n    } catch (error) {\n      console.error('Failed to fetch creative outputs:', error)\n    }\n  }\n\n  // Fetch existing study materials from Supabase\n  const fetchStudyMaterials = async (sourcesData?: Source[]) => {\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n      const response = await fetch(`/api/notebooks/${notebookId}/study`, {\n        headers: {\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n      })\n      const result = await response.json()\n\n      if (result.data && Array.isArray(result.data)) {\n        // Group materials by type and get the latest of each\n        const materialsByType: Record<string, typeof result.data[0]> = {}\n        for (const material of result.data) {\n          if (!materialsByType[material.type]) {\n            materialsByType[material.type] = material\n          }\n        }\n\n        // Build metadata array for UI\n        const currentSources = sourcesData || sources\n        const metaArray = Object.values(materialsByType).map((material) => {\n          const sourceIds = material.source_ids || []\n          const sourceNames = sourceIds.map((id: string) => {\n            const source = currentSources.find(s => s.id === id)\n            return source?.name || 'Unknown source'\n          })\n\n          // Calculate item count based on type\n          let itemCount = 0\n          if (material.type === 'flashcards') itemCount = material.data?.flashcards?.length || 0\n          else if (material.type === 'quiz') itemCount = material.data?.questions?.length || 0\n          else if (material.type === 'faq') itemCount = material.data?.faq?.length || 0\n\n          return {\n            id: material.id,\n            type: material.type,\n            sourceIds,\n            sourceNames,\n            createdAt: material.created_at,\n            itemCount,\n          }\n        })\n        setStudyMaterialsMeta(metaArray)\n\n        // Populate state with cached data\n        if (materialsByType.flashcards?.data?.flashcards) {\n          setFlashcards(materialsByType.flashcards.data.flashcards)\n        }\n        if (materialsByType.quiz?.data?.questions) {\n          setQuizQuestions(materialsByType.quiz.data.questions)\n        }\n        if (materialsByType.study_guide?.data) {\n          setStudyGuide(materialsByType.study_guide.data)\n        }\n        if (materialsByType.faq?.data?.faq) {\n          setFaqItems(materialsByType.faq.data.faq)\n        }\n        if (materialsByType.mind_map?.data) {\n          setMindMap(materialsByType.mind_map.data)\n        }\n      }\n    } catch (error) {\n      console.error('Failed to fetch study materials:', error)\n    }\n  }\n\n  // Redirect if notebook doesn't exist\n  useEffect(() => {\n    if (!notebookLoading && !notebook) {\n      router.push('/')\n    }\n  }, [notebook, notebookLoading, router])\n\n  // Load notebook settings when notebook data is available\n  useEffect(() => {\n    if (notebook?.settings) {\n      setNotebookSettings(notebook.settings as unknown as NotebookSettings)\n    }\n  }, [notebook])\n\n  // Save notebook settings\n  const saveNotebookSettings = async (newSettings: NotebookSettings) => {\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n      const response = await fetch(`/api/notebooks/${notebookId}`, {\n        method: 'PATCH',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n        body: JSON.stringify({ settings: newSettings }),\n      })\n\n      if (!response.ok) {\n        throw new Error('Failed to save settings')\n      }\n\n      setNotebookSettings(newSettings)\n      invalidate.invalidateNotebook(notebookId)\n    } catch (error) {\n      console.error('Failed to save notebook settings:', error)\n      throw error\n    }\n  }\n\n  // Source handlers\n  const handleAddSource = async (type: string, data: { input: string; name?: string; file?: File }) => {\n    setUploading(true)\n\n    if (type === 'file') {\n      // Handle file upload - file is passed from the sources panel\n      const file = data.file\n      if (file) {\n        const fileExt = file.name.split('.').pop()?.toLowerCase()\n        const filePath = `${user?.id}/${notebookId}/${Date.now()}.${fileExt}`\n\n        const { error: uploadError } = await supabase.storage\n          .from('sources')\n          .upload(filePath, file)\n\n        if (uploadError) {\n          console.error('Upload error:', uploadError)\n          \n          setUploading(false)\n          return\n        }\n\n        const { data: sourceData, error } = await supabase\n          .from('sources')\n          .insert({\n            notebook_id: notebookId,\n            type: fileExt === 'pdf' ? 'pdf' : fileExt === 'docx' ? 'docx' : 'txt',\n            name: file.name,\n            status: 'ready',\n            file_path: filePath,\n            original_filename: file.name,\n            mime_type: file.type,\n            file_size_bytes: file.size,\n          })\n          .select()\n          .single()\n\n        if (error) {\n          console.error('Source creation error:', error)\n        } else {\n          invalidate.invalidateSources(notebookId)\n        }\n      }\n    } else {\n      let sourceData: Partial<Source> = {\n        notebook_id: notebookId,\n        status: 'ready',\n      }\n\n      if (type === 'youtube') {\n        sourceData = {\n          ...sourceData,\n          type: 'youtube',\n          name: data.name || `YouTube: ${data.input}`,\n          metadata: { url: data.input },\n        }\n      } else if (type === 'url') {\n        sourceData = {\n          ...sourceData,\n          type: 'url',\n          name: data.name || data.input,\n          metadata: { url: data.input },\n        }\n      } else if (type === 'text') {\n        sourceData = {\n          ...sourceData,\n          type: 'text',\n          name: data.name || 'Pasted Text',\n          metadata: { content: data.input },\n        }\n      }\n\n      const { error } = await supabase\n        .from('sources')\n        .insert(sourceData)\n        .select()\n        .single()\n\n      if (error) {\n        console.error('Source creation error:', error)\n      } else {\n        invalidate.invalidateSources(notebookId)\n      }\n    }\n\n    setUploading(false)\n  }\n\n  const handleDeleteSource = async (sourceId: string) => {\n    const { error } = await supabase\n      .from('sources')\n      .delete()\n      .eq('id', sourceId)\n\n    if (error) {\n      console.error('Delete source error:', error)\n    } else {\n      invalidate.invalidateSources(notebookId)\n      selectedSources.delete(sourceId)\n      setSelectedSources(new Set(selectedSources))\n    }\n  }\n\n  const toggleSource = (sourceId: string) => {\n    const newSelected = new Set(selectedSources)\n    if (newSelected.has(sourceId)) {\n      newSelected.delete(sourceId)\n    } else {\n      newSelected.add(sourceId)\n    }\n    setSelectedSources(newSelected)\n  }\n\n  const selectAllSources = () => {\n    if (selectedSources.size === sources.length) {\n      setSelectedSources(new Set())\n    } else {\n      setSelectedSources(new Set(sources.map(s => s.id)))\n    }\n  }\n\n  // Chat handlers\n  const sendMessage = async (overrideMessage?: string) => {\n    const messageToSend = overrideMessage || message\n    if (!messageToSend.trim() || sending) return\n\n    setSending(true)\n    const userMessage: ChatMessage = {\n      id: crypto.randomUUID(),\n      session_id: sessionId || '',\n      role: 'user',\n      content: messageToSend,\n      citations: [],\n      source_ids_used: Array.from(selectedSources),\n      model_used: null,\n      input_tokens: null,\n      output_tokens: null,\n      cost_usd: null,\n      created_at: new Date().toISOString(),\n    }\n    setMessages(prev => [...prev, userMessage])\n    setMessage('')\n\n    try {\n      const response = await chatApi.sendMessage(notebookId, {\n        message: userMessage.content,\n        source_ids: Array.from(selectedSources),\n        session_id: sessionId || undefined,\n      })\n\n      const isNewSession = !sessionId\n      if (response.data.session_id) {\n        setSessionId(response.data.session_id)\n      }\n\n      const aiMessage: ChatMessage = {\n        id: response.data.message_id,\n        session_id: response.data.session_id,\n        role: 'assistant',\n        content: response.data.content,\n        citations: response.data.citations,\n        source_ids_used: Array.from(selectedSources),\n        model_used: response.usage?.model_used || 'gemini-2.0-flash',\n        input_tokens: response.usage?.input_tokens || 0,\n        output_tokens: response.usage?.output_tokens || 0,\n        cost_usd: response.usage?.cost_usd || 0,\n        created_at: new Date().toISOString(),\n      }\n      setMessages(prev => [...prev, aiMessage])\n\n      // Refresh chat sessions if this was a new session\n      if (isNewSession) {\n        invalidate.invalidateChatSessions(notebookId)\n      }\n    } catch {\n      setMessages(prev => prev.filter(m => m.id !== userMessage.id))\n    }\n    setSending(false)\n  }\n\n  const saveResponseAsNote = async (msg: ChatMessage) => {\n    const { error } = await supabase\n      .from('notes')\n      .insert({\n        notebook_id: notebookId,\n        type: 'saved_response',\n        title: `Saved Response - ${new Date().toLocaleDateString()}`,\n        content: msg.content,\n        tags: [],\n      })\n      .select()\n      .single()\n\n    if (error) {\n      console.error('Save note error:', error)\n    } else {\n      invalidate.invalidateNotes(notebookId)\n    }\n  }\n\n  // Notes handlers\n  const createNote = async () => {\n    if (!noteTitle.trim() && !noteContent.trim()) return\n\n    setSavingNote(true)\n    const { error } = await supabase\n      .from('notes')\n      .insert({\n        notebook_id: notebookId,\n        type: 'written',\n        title: noteTitle || 'Untitled Note',\n        content: noteContent,\n        tags: [],\n      })\n      .select()\n      .single()\n\n    if (error) {\n      console.error('Create note error:', error)\n    } else {\n      invalidate.invalidateNotes(notebookId)\n      setNoteTitle('')\n      setNoteContent('')\n      setAddNoteOpen(false)\n    }\n    setSavingNote(false)\n  }\n\n  // Audio generation\n  const generateAudio = async () => {\n    if (selectedSources.size === 0) {\n      \n      return\n    }\n\n    setGeneratingAudio(true)\n    setActiveStudyType('audio')\n    setStudySheetOpen(true)\n\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n      const response = await fetch(`/api/notebooks/${notebookId}/audio`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n        body: JSON.stringify({\n          format: audioFormat,\n          source_ids: Array.from(selectedSources),\n          custom_instructions: audioInstructions || undefined,\n        }),\n      })\n      const result = await response.json()\n      if (result.error) {\n        console.error('Audio generation error:', result.error)\n      } else if (result.data) {\n        setLocalGeneratedAudio(result.data)\n        invalidate.invalidateAudio(notebookId)\n      }\n    } catch (error) {\n      console.error('Audio generation error:', error)\n    }\n    setGeneratingAudio(false)\n  }\n\n  // Video generation\n  const generateVideo = async () => {\n    if (selectedSources.size === 0) {\n      return\n    }\n\n    setGeneratingVideo(true)\n    setActiveStudyType('video')\n    setStudySheetOpen(true)\n\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n      const response = await fetch(`/api/notebooks/${notebookId}/video`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n        body: JSON.stringify({\n          style: videoStyle,\n          source_ids: Array.from(selectedSources),\n        }),\n      })\n      const result = await response.json()\n      if (result.error) {\n        console.error('Video generation error:', result.error)\n      } else if (result.data) {\n        // Map video_file_path to video_url for frontend components\n        setLocalGeneratedVideo({\n          ...result.data,\n          video_url: result.data.video_file_path || result.data.video_url,\n        })\n        invalidate.invalidateVideo(notebookId)\n      }\n    } catch (error) {\n      console.error('Video generation error:', error)\n    }\n    setGeneratingVideo(false)\n  }\n\n  // Research generation\n  const runResearch = async () => {\n    if (!researchQuery.trim()) {\n      return\n    }\n\n    // Clear old research to prevent showing cached results\n    setLocalGeneratedResearch(null)\n    setResearching(true)\n    setActiveStudyType('research')\n    setStudySheetOpen(true)\n\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n      const response = await fetch(`/api/notebooks/${notebookId}/research`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n        body: JSON.stringify({\n          query: researchQuery,\n          mode: researchMode,\n        }),\n      })\n      const result = await response.json()\n      if (result.error) {\n        console.error('Research failed:', result.error)\n        alert(`Research failed: ${result.error}`)\n      } else if (result.data) {\n        setLocalGeneratedResearch(result.data)\n        invalidate.invalidateResearch(notebookId)\n        setResearchQuery('')\n      }\n    } catch (error) {\n      console.error('Research error:', error)\n      alert('Research failed. Please try again.')\n    }\n    setResearching(false)\n  }\n\n  // Study material generation handlers\n  const handleGenerateFlashcards = async () => {\n    setGeneratingState('flashcards', true)\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n      const response = await fetch(`/api/notebooks/${notebookId}/study`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n        body: JSON.stringify({\n          type: 'flashcards',\n          source_ids: Array.from(selectedSources),\n          count: 5,\n        }),\n      })\n      const result = await response.json()\n      if (result.error) {\n        \n      } else if (result.data?.flashcards) {\n        setFlashcards(result.data.flashcards)\n        setCurrentFlashcard(0)\n        setShowFlashcardBack(false)\n        setActiveStudyType('flashcards')\n        setStudySheetOpen(true)\n        fetchStudyMaterials()\n        \n      }\n    } catch {\n      \n    } finally {\n      setGeneratingState('flashcards', false)\n    }\n  }\n\n  const handleGenerateQuiz = async () => {\n    setGeneratingState('quiz', true)\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n      const response = await fetch(`/api/notebooks/${notebookId}/study`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n        body: JSON.stringify({\n          type: 'quiz',\n          source_ids: Array.from(selectedSources),\n          count: 5,\n        }),\n      })\n      const result = await response.json()\n      if (result.error) {\n        \n      } else if (result.data?.questions) {\n        setQuizQuestions(result.data.questions)\n        setCurrentQuizQuestion(0)\n        setSelectedAnswer(null)\n        setShowQuizAnswer(false)\n        setActiveStudyType('quiz')\n        setStudySheetOpen(true)\n        fetchStudyMaterials()\n        \n      }\n    } catch {\n      \n    } finally {\n      setGeneratingState('quiz', false)\n    }\n  }\n\n  const handleGenerateStudyGuide = async () => {\n    setGeneratingState('studyGuide', true)\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n      const response = await fetch(`/api/notebooks/${notebookId}/study`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n        body: JSON.stringify({\n          type: 'study-guide',\n          source_ids: Array.from(selectedSources),\n        }),\n      })\n      const result = await response.json()\n      if (result.error) {\n        \n      } else if (result.data?.sections) {\n        setStudyGuide(result.data)\n        setActiveStudyType('guide')\n        setStudySheetOpen(true)\n        fetchStudyMaterials()\n        \n      }\n    } catch {\n      \n    } finally {\n      setGeneratingState('studyGuide', false)\n    }\n  }\n\n  const handleGenerateFaq = async () => {\n    setGeneratingState('faq', true)\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n      const response = await fetch(`/api/notebooks/${notebookId}/study`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n        body: JSON.stringify({\n          type: 'faq',\n          source_ids: Array.from(selectedSources),\n        }),\n      })\n      const result = await response.json()\n      if (result.error) {\n        \n      } else if (result.data?.faq) {\n        setFaqItems(result.data.faq)\n        setActiveStudyType('faq')\n        setStudySheetOpen(true)\n        fetchStudyMaterials()\n        \n      }\n    } catch {\n      \n    } finally {\n      setGeneratingState('faq', false)\n    }\n  }\n\n  const handleGenerateMindMap = async () => {\n    setGeneratingState('mindMap', true)\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n      const response = await fetch(`/api/notebooks/${notebookId}/study`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n        body: JSON.stringify({\n          type: 'mind-map',\n          source_ids: Array.from(selectedSources),\n        }),\n      })\n      const result = await response.json()\n      if (result.error) {\n\n      } else if (result.data?.nodes) {\n        setMindMap(result.data)\n        setActiveStudyType('mindmap')\n        setStudySheetOpen(true)\n        // Refresh metadata to show updated material\n        fetchStudyMaterials()\n\n      }\n    } catch {\n\n    } finally {\n      setGeneratingState('mindMap', false)\n    }\n  }\n\n  // Unified study material handler with config\n  const handleGenerateStudyMaterial = async (config: GenerationConfig) => {\n    const sourceIds = config.sourceIds && config.sourceIds.length > 0\n      ? config.sourceIds\n      : Array.from(selectedSources)\n\n    if (sourceIds.length === 0) return\n\n    // Set loading state based on type\n    const typeToStateKey: Record<string, keyof typeof generating> = {\n      'flashcards': 'flashcards',\n      'quiz': 'quiz',\n      'study-guide': 'studyGuide',\n      'faq': 'faq',\n      'mind-map': 'mindMap',\n    }\n    const stateKey = typeToStateKey[config.type]\n    if (stateKey) setGeneratingState(stateKey, true)\n\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n\n      // Build request body with all config options\n      const requestBody: Record<string, unknown> = {\n        type: config.type,\n        source_ids: sourceIds,\n      }\n\n      // Add optional config fields\n      if (config.count) requestBody.count = config.count\n      if (config.difficulty) requestBody.difficulty = config.difficulty\n      if (config.focusArea) requestBody.focus_area = config.focusArea\n      if (config.customInstructions) requestBody.custom_instructions = config.customInstructions\n      if (config.questionTypes) requestBody.question_types = config.questionTypes\n\n      const response = await fetch(`/api/notebooks/${notebookId}/study`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n        body: JSON.stringify(requestBody),\n      })\n      const result = await response.json()\n\n      if (result.error) {\n        console.error('Generation error:', result.error)\n      } else if (result.data) {\n        // Handle each type's response\n        switch (config.type) {\n          case 'flashcards':\n            if (result.data.flashcards) {\n              setFlashcards(result.data.flashcards)\n              setCurrentFlashcard(0)\n              setShowFlashcardBack(false)\n              setActiveStudyType('flashcards')\n              setStudySheetOpen(true)\n            }\n            break\n          case 'quiz':\n            if (result.data.questions) {\n              setQuizQuestions(result.data.questions)\n              setCurrentQuizQuestion(0)\n              setSelectedAnswer(null)\n              setShowQuizAnswer(false)\n              setActiveStudyType('quiz')\n              setStudySheetOpen(true)\n            }\n            break\n          case 'study-guide':\n            if (result.data.sections) {\n              setStudyGuide(result.data)\n              setActiveStudyType('guide')\n              setStudySheetOpen(true)\n            }\n            break\n          case 'faq':\n            if (result.data.faq) {\n              setFaqItems(result.data.faq)\n              setActiveStudyType('faq')\n              setStudySheetOpen(true)\n            }\n            break\n          case 'mind-map':\n            if (result.data.nodes) {\n              setMindMap(result.data)\n              setActiveStudyType('mindmap')\n              setStudySheetOpen(true)\n            }\n            break\n        }\n        fetchStudyMaterials()\n      }\n    } catch (error) {\n      console.error('Study material generation failed:', error)\n    } finally {\n      if (stateKey) setGeneratingState(stateKey, false)\n    }\n  }\n\n  // Unified creative output handler with config\n  const handleGenerateCreativeOutput = async (config: GenerationConfig) => {\n    const sourceIds = config.sourceIds && config.sourceIds.length > 0\n      ? config.sourceIds\n      : Array.from(selectedSources)\n\n    if (sourceIds.length === 0) return\n\n    // Set loading state based on type\n    const typeToStateKey2: Record<string, keyof typeof generating> = {\n      'data_table': 'dataTable',\n      'report': 'report',\n      'slide_deck': 'slideDeck',\n      'infographic': 'infographic',\n    }\n    const stateKey2 = typeToStateKey2[config.type]\n    if (stateKey2) setGeneratingState(stateKey2, true)\n\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n\n      // Build request body with all config options\n      const requestBody: Record<string, unknown> = {\n        type: config.type,\n        source_ids: sourceIds,\n      }\n\n      // Add optional config fields\n      if (config.customInstructions) requestBody.custom_instructions = config.customInstructions\n      if (config.focusArea) requestBody.focus_area = config.focusArea\n      if (config.reportType) requestBody.report_type = config.reportType\n      if (config.tone) requestBody.tone = config.tone\n      if (config.slideCount) requestBody.slide_count = config.slideCount\n      if (config.style) requestBody.style = config.style\n      // Infographic-specific options\n      if (config.imageCount) requestBody.image_count = config.imageCount\n      if (config.imageStyle) requestBody.image_style = config.imageStyle\n\n      const response = await fetch(`/api/notebooks/${notebookId}/studio`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n        body: JSON.stringify(requestBody),\n      })\n      const result = await response.json()\n\n      if (result.error) {\n        console.error('Generation error:', result.error)\n      } else if (result.data) {\n        // Handle each type's response\n        switch (config.type) {\n          case 'data_table':\n            setDataTableData(result.data)\n            setActiveStudyType('datatable')\n            setStudySheetOpen(true)\n            break\n          case 'report':\n            setReportData(result.data)\n            setActiveStudyType('report')\n            setStudySheetOpen(true)\n            break\n          case 'slide_deck':\n            setSlideDeckData(result.data)\n            setActiveStudyType('slides')\n            setStudySheetOpen(true)\n            break\n          case 'infographic':\n            setInfographicData(result.data)\n            setActiveStudyType('infographic')\n            setStudySheetOpen(true)\n            break\n        }\n        fetchCreativeOutputs()\n      }\n    } catch (error) {\n      console.error('Creative output generation failed:', error)\n    } finally {\n      if (stateKey2) setGeneratingState(stateKey2, false)\n    }\n  }\n\n  // Creative output generation handlers (legacy - kept for compatibility)\n  const handleGenerateDataTable = async () => {\n    if (selectedSources.size === 0) {\n\n      return\n    }\n    setGeneratingState('dataTable', true)\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n      const response = await fetch(`/api/notebooks/${notebookId}/studio`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n        body: JSON.stringify({\n          type: 'data_table',\n          source_ids: Array.from(selectedSources),\n        }),\n      })\n      const result = await response.json()\n      if (result.error) {\n        \n      } else if (result.data) {\n        setDataTableData(result.data)\n        setActiveStudyType('datatable' as typeof activeStudyType)\n        setStudySheetOpen(true)\n        fetchCreativeOutputs()\n      }\n    } catch {\n      // Error handled silently\n    } finally {\n      setGeneratingState('dataTable', false)\n    }\n  }\n\n  const handleGenerateReport = async (reportType: string) => {\n    if (selectedSources.size === 0) {\n\n      return\n    }\n    setGeneratingState('report', true)\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n      const response = await fetch(`/api/notebooks/${notebookId}/studio`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n        body: JSON.stringify({\n          type: 'report',\n          source_ids: Array.from(selectedSources),\n          report_type: reportType,\n        }),\n      })\n      const result = await response.json()\n      if (result.error) {\n        \n      } else if (result.data) {\n        setReportData(result.data)\n        setActiveStudyType('report' as typeof activeStudyType)\n        setStudySheetOpen(true)\n        fetchCreativeOutputs()\n      }\n    } catch {\n      // Error handled silently\n    } finally {\n      setGeneratingState('report', false)\n    }\n  }\n\n  const handleGenerateSlideDeck = async () => {\n    if (selectedSources.size === 0) {\n\n      return\n    }\n    setGeneratingState('slideDeck', true)\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n      const response = await fetch(`/api/notebooks/${notebookId}/studio`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n        body: JSON.stringify({\n          type: 'slide_deck',\n          source_ids: Array.from(selectedSources),\n        }),\n      })\n      const result = await response.json()\n      if (result.error) {\n        \n      } else if (result.data) {\n        setSlideDeckData(result.data)\n        setActiveStudyType('slides' as typeof activeStudyType)\n        setStudySheetOpen(true)\n        fetchCreativeOutputs()\n      }\n    } catch {\n      // Error handled silently\n    } finally {\n      setGeneratingState('slideDeck', false)\n    }\n  }\n\n  const handleGenerateInfographic = async () => {\n    if (selectedSources.size === 0) {\n\n      return\n    }\n    setGeneratingState('infographic', true)\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n      const response = await fetch(`/api/notebooks/${notebookId}/studio`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n        body: JSON.stringify({\n          type: 'infographic',\n          source_ids: Array.from(selectedSources),\n        }),\n      })\n      const result = await response.json()\n      if (result.error) {\n        \n      } else if (result.data) {\n        setInfographicData(result.data)\n        setActiveStudyType('infographic' as typeof activeStudyType)\n        setStudySheetOpen(true)\n        fetchCreativeOutputs()\n      }\n    } catch {\n      // Error handled silently\n    } finally {\n      setGeneratingState('infographic', false)\n    }\n  }\n\n  // Sheet resize handlers\n  const handleResizeStart = (e: React.MouseEvent) => {\n    e.preventDefault()\n    setIsResizing(true)\n\n    const startX = e.clientX\n    const startWidth = sheetWidth\n\n    const handleMouseMove = (e: MouseEvent) => {\n      const diff = startX - e.clientX\n      const newWidth = Math.min(Math.max(startWidth + diff, 400), window.innerWidth - 50)\n      setSheetWidth(newWidth)\n    }\n\n    const handleMouseUp = () => {\n      setIsResizing(false)\n      document.removeEventListener('mousemove', handleMouseMove)\n      document.removeEventListener('mouseup', handleMouseUp)\n    }\n\n    document.addEventListener('mousemove', handleMouseMove)\n    document.addEventListener('mouseup', handleMouseUp)\n  }\n\n  if (loading) {\n    return (\n      <div className=\"h-screen flex items-center justify-center bg-[var(--bg-primary)]\">\n        <Loader2 className=\"h-8 w-8 animate-spin text-[var(--accent-primary)]\" />\n      </div>\n    )\n  }\n\n  return (\n    <div className=\"h-screen flex flex-col bg-[var(--bg-primary)]\">\n      {/* Header */}\n      <motion.header\n        initial={{ opacity: 0, y: -10 }}\n        animate={{ opacity: 1, y: 0 }}\n        className=\"h-14 bg-[var(--bg-secondary)] border-b border-[rgba(255,255,255,0.1)] px-4 flex items-center gap-4 shrink-0 sticky top-0 z-50\"\n      >\n        <Button\n          variant=\"ghost\"\n          size=\"icon\"\n          onClick={() => router.push('/')}\n          className=\"h-9 w-9 rounded-lg text-[var(--text-secondary)] hover:text-[var(--text-primary)] hover:bg-[var(--bg-tertiary)]\"\n        >\n          <ArrowLeft className=\"h-4 w-4\" />\n        </Button>\n\n        <div className=\"flex items-center gap-3\">\n          <div className=\"w-10 h-10 rounded-xl bg-[var(--bg-tertiary)] flex items-center justify-center text-xl\">\n            {notebook?.emoji}\n          </div>\n          <div>\n            <h1 className=\"font-semibold text-[var(--text-primary)]\">{notebook?.name}</h1>\n            {notebook?.description && (\n              <p className=\"text-xs text-[var(--text-tertiary)] line-clamp-1 max-w-[300px]\">\n                {notebook.description}\n              </p>\n            )}\n          </div>\n        </div>\n\n        <div className=\"flex items-center gap-2 ml-auto\">\n          <Badge className=\"bg-[var(--bg-tertiary)] text-[var(--text-secondary)] border-0 text-xs\">\n            {sources.length} source{sources.length !== 1 ? 's' : ''}\n          </Badge>\n          {selectedSources.size > 0 && (\n            <Badge className=\"bg-[var(--accent-primary)]/20 text-[var(--accent-primary)] border-0 text-xs\">\n              {selectedSources.size} selected\n            </Badge>\n          )}\n          {notebookSettings?.persona?.enabled && (\n            <Badge className=\"bg-purple-500/20 text-purple-400 border-0 text-xs\">\n              {notebookSettings.persona.name || 'Custom Persona'}\n            </Badge>\n          )}\n          <Button\n            variant=\"ghost\"\n            size=\"sm\"\n            onClick={() => setSettingsOpen(true)}\n            className=\"h-9 px-3 rounded-lg text-[var(--text-secondary)] hover:text-[var(--text-primary)] hover:bg-[var(--bg-tertiary)] gap-2\"\n          >\n            <Settings className=\"h-4 w-4\" />\n            <span className=\"hidden sm:inline\">Settings</span>\n          </Button>\n          <Button\n            variant=\"ghost\"\n            size=\"sm\"\n            onClick={() => router.push(`/notebooks/${notebookId}/history`)}\n            className=\"h-9 px-3 rounded-lg text-[var(--text-secondary)] hover:text-[var(--text-primary)] hover:bg-[var(--bg-tertiary)] gap-2\"\n          >\n            <History className=\"h-4 w-4\" />\n            <span className=\"hidden sm:inline\">History</span>\n          </Button>\n        </div>\n      </motion.header>\n\n      {/* Three Panel Layout */}\n      <div className=\"flex-1 overflow-hidden\">\n        <ThreePanelLayout\n          leftPanelTitle=\"Sources\"\n          rightPanelTitle=\"Studio\"\n          leftPanel={\n            <SourcesPanel\n              sources={sources}\n              selectedSources={selectedSources}\n              onToggleSource={toggleSource}\n              onSelectAll={selectAllSources}\n              onAddSource={handleAddSource}\n              onDeleteSource={handleDeleteSource}\n              onViewSource={setViewingSource}\n              uploading={uploading}\n            />\n          }\n          centerPanel={\n            <ChatPanel\n              messages={messages}\n              message={message}\n              onMessageChange={setMessage}\n              onSendMessage={sendMessage}\n              sending={sending}\n              selectedSourcesCount={selectedSources.size}\n              totalSourcesCount={sources.length}\n              onSaveResponse={saveResponseAsNote}\n              sessions={chatSessions}\n              currentSessionId={sessionId}\n              onLoadSession={loadChatSession}\n              onNewChat={startNewChat}\n              onDeleteSession={deleteChatSession}\n              onRenameSession={renameChatSession}\n              loadingSessions={loadingSessions}\n              notebookId={notebookId}\n            />\n          }\n          rightPanel={\n            <StudioPanel\n              notebookId={notebookId}\n              selectedSourcesCount={selectedSources.size}\n              selectedSourceIds={Array.from(selectedSources)}\n              sources={sources.map(s => ({ id: s.id, name: s.name }))}\n              audioFormat={audioFormat}\n              onAudioFormatChange={setAudioFormat}\n              audioInstructions={audioInstructions}\n              onAudioInstructionsChange={setAudioInstructions}\n              onGenerateAudio={generateAudio}\n              generatingAudio={generatingAudio}\n              videoStyle={videoStyle}\n              onVideoStyleChange={setVideoStyle}\n              onGenerateVideo={generateVideo}\n              generatingVideo={generatingVideo}\n              researchQuery={researchQuery}\n              onResearchQueryChange={setResearchQuery}\n              researchMode={researchMode}\n              onResearchModeChange={setResearchMode}\n              onRunResearch={runResearch}\n              researching={researching}\n              onGenerateStudyMaterial={handleGenerateStudyMaterial}\n              generatingFlashcards={generating.flashcards}\n              generatingQuiz={generating.quiz}\n              generatingStudyGuide={generating.studyGuide}\n              generatingFaq={generating.faq}\n              generatingMindMap={generating.mindMap}\n              onGenerateCreativeOutput={handleGenerateCreativeOutput}\n              generatingDataTable={generating.dataTable}\n              generatingReport={generating.report}\n              generatingSlideDeck={generating.slideDeck}\n              generatingInfographic={generating.infographic}\n              creativeOutputs={creativeOutputsMeta}\n              onOpenCreativeOutput={(type) => {\n                const typeMap: Record<string, typeof activeStudyType> = {\n                  data_table: 'datatable',\n                  report: 'report',\n                  slide_deck: 'slides',\n                  infographic: 'infographic',\n                }\n                setActiveStudyType(typeMap[type] || null)\n                setStudySheetOpen(true)\n              }}\n              studyMaterials={studyMaterialsMeta}\n              onOpenStudyMaterial={(type) => {\n                const typeMap: Record<string, typeof activeStudyType> = {\n                  flashcards: 'flashcards',\n                  quiz: 'quiz',\n                  study_guide: 'guide',\n                  faq: 'faq',\n                  mind_map: 'mindmap',\n                }\n                setActiveStudyType(typeMap[type] || null)\n                setStudySheetOpen(true)\n              }}\n              notesCount={notes.length}\n              onAddNote={() => setAddNoteOpen(true)}\n              hasGeneratedAudio={!!activeGeneratedAudio}\n              hasGeneratedVideo={!!activeGeneratedVideo}\n              hasGeneratedResearch={!!activeGeneratedResearch}\n              onOpenAudio={() => { setActiveStudyType('audio'); setStudySheetOpen(true) }}\n              onOpenVideo={() => { setActiveStudyType('video'); setStudySheetOpen(true) }}\n              onOpenResearch={() => { setActiveStudyType('research'); setStudySheetOpen(true) }}\n            />\n          }\n        />\n      </div>\n\n      {/* Source Preview Dialog */}\n      <Dialog open={!!viewingSource} onOpenChange={(open) => !open && setViewingSource(null)}>\n        <DialogContent className=\"sm:max-w-lg bg-[var(--bg-secondary)] border-[rgba(255,255,255,0.1)]\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-3 text-[var(--text-primary)]\">\n              <div className=\"w-10 h-10 rounded-lg bg-[var(--bg-tertiary)] flex items-center justify-center\">\n                <FileText className=\"h-5 w-5\" />\n              </div>\n              {viewingSource?.name}\n            </DialogTitle>\n            <DialogDescription className=\"text-[var(--text-secondary)]\">\n              {viewingSource?.type} source\n            </DialogDescription>\n          </DialogHeader>\n\n          {viewingSource?.metadata && (() => {\n            const meta = viewingSource.metadata as Record<string, unknown>\n            if (viewingSource.type === 'text' && meta.content) {\n              return (\n                <div className=\"p-4 rounded-xl bg-[var(--bg-tertiary)] text-sm max-h-64 overflow-y-auto\">\n                  <p className=\"whitespace-pre-wrap text-[var(--text-secondary)]\">\n                    {String(meta.content)}\n                  </p>\n                </div>\n              )\n            }\n            if ((viewingSource.type === 'youtube' || viewingSource.type === 'url') && meta.url) {\n              return (\n                <div className=\"p-4 rounded-xl bg-[var(--bg-tertiary)] text-sm max-h-64 overflow-y-auto\">\n                  <a\n                    href={String(meta.url)}\n                    target=\"_blank\"\n                    rel=\"noopener noreferrer\"\n                    className=\"text-[var(--accent-primary)] hover:underline break-all\"\n                  >\n                    {String(meta.url)}\n                  </a>\n                </div>\n              )\n            }\n            return null\n          })()}\n        </DialogContent>\n      </Dialog>\n\n      {/* Add Note Dialog */}\n      <Dialog open={addNoteOpen} onOpenChange={setAddNoteOpen}>\n        <DialogContent className=\"sm:max-w-md bg-[var(--bg-secondary)] border-[rgba(255,255,255,0.1)]\">\n          <DialogHeader>\n            <DialogTitle className=\"text-[var(--text-primary)]\">Create Note</DialogTitle>\n            <DialogDescription className=\"text-[var(--text-secondary)]\">\n              Write a new note to save your thoughts.\n            </DialogDescription>\n          </DialogHeader>\n          <div className=\"space-y-4 mt-2\">\n            <div className=\"space-y-2\">\n              <label className=\"text-sm font-medium text-[var(--text-primary)]\">Title</label>\n              <Input\n                placeholder=\"Note title...\"\n                value={noteTitle}\n                onChange={(e) => setNoteTitle(e.target.value)}\n                className=\"h-10 bg-[var(--bg-tertiary)] border-[rgba(255,255,255,0.1)] text-[var(--text-primary)] placeholder:text-[var(--text-tertiary)] focus:border-[var(--accent-primary)] rounded-lg\"\n              />\n            </div>\n            <div className=\"space-y-2\">\n              <label className=\"text-sm font-medium text-[var(--text-primary)]\">Content</label>\n              <Textarea\n                placeholder=\"Write your note...\"\n                value={noteContent}\n                onChange={(e) => setNoteContent(e.target.value)}\n                rows={6}\n                className=\"bg-[var(--bg-tertiary)] border-[rgba(255,255,255,0.1)] text-[var(--text-primary)] placeholder:text-[var(--text-tertiary)] focus:border-[var(--accent-primary)] rounded-lg resize-none\"\n              />\n            </div>\n          </div>\n          <DialogFooter className=\"mt-4\">\n            <Button\n              onClick={createNote}\n              disabled={savingNote}\n              className=\"rounded-lg bg-[var(--accent-primary)] hover:bg-[var(--accent-primary)]/90 text-white\"\n            >\n              {savingNote && <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />}\n              Create Note\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      {/* Study Materials Sheet */}\n      <Sheet open={studySheetOpen} onOpenChange={(open) => {\n        setStudySheetOpen(open)\n        if (!open) setSheetWidth(576)\n      }}>\n        <SheetContent\n          className=\"overflow-y-auto bg-[var(--bg-secondary)] border-[rgba(255,255,255,0.1)] p-0\"\n          style={{ width: sheetWidth, maxWidth: '100vw' }}\n        >\n          {/* Resize Handle */}\n          <div\n            className={`absolute left-0 top-0 bottom-0 w-1.5 cursor-ew-resize hover:bg-[var(--accent-primary)]/50 transition-colors z-50 ${isResizing ? 'bg-[var(--accent-primary)]/50' : ''}`}\n            onMouseDown={handleResizeStart}\n          />\n          <div className=\"p-6\">\n          <SheetHeader>\n            <div className=\"flex items-center gap-2 pr-8\">\n              <SheetTitle className=\"flex items-center gap-2 text-[var(--text-primary)] flex-1\">\n                {activeStudyType === 'flashcards' && <><BookOpen className=\"h-5 w-5 text-blue-500\" /> Flashcards</>}\n                {activeStudyType === 'quiz' && <><ListChecks className=\"h-5 w-5 text-purple-500\" /> Quiz</>}\n                {activeStudyType === 'guide' && <><FileText className=\"h-5 w-5 text-orange-500\" /> Study Guide</>}\n                {activeStudyType === 'faq' && <><HelpCircle className=\"h-5 w-5 text-teal-500\" /> FAQ</>}\n                {activeStudyType === 'mindmap' && <><Share2 className=\"h-5 w-5 text-cyan-500\" /> Mind Map</>}\n                {activeStudyType === 'datatable' && <><Table className=\"h-5 w-5 text-emerald-500\" /> Data Table</>}\n                {activeStudyType === 'report' && <><FileSpreadsheet className=\"h-5 w-5 text-blue-500\" /> Report</>}\n                {activeStudyType === 'slides' && <><Presentation className=\"h-5 w-5 text-violet-500\" /> Slide Deck</>}\n                {activeStudyType === 'infographic' && <><ImageIcon className=\"h-5 w-5 text-rose-500\" /> Infographic</>}\n                {activeStudyType === 'audio' && <><Mic className=\"h-5 w-5 text-orange-500\" /> Audio Overview</>}\n                {activeStudyType === 'video' && <><Video className=\"h-5 w-5 text-purple-500\" /> Video Overview</>}\n                {activeStudyType === 'research' && <><Search className=\"h-5 w-5 text-blue-500\" /> Research Report</>}\n              </SheetTitle>\n              <Button\n                variant=\"ghost\"\n                size=\"icon\"\n                className=\"h-8 w-8 shrink-0\"\n                onClick={() => {\n                  if (sheetWidth < 800) {\n                    setSheetWidth(900) // Wide\n                  } else if (sheetWidth < window.innerWidth - 100) {\n                    setSheetWidth(window.innerWidth - 50) // Full\n                  } else {\n                    setSheetWidth(576) // Normal\n                  }\n                }}\n                title={sheetWidth >= window.innerWidth - 100 ? 'Minimize' : 'Expand'}\n              >\n                {sheetWidth >= window.innerWidth - 100 ? (\n                  <Minimize2 className=\"h-4 w-4\" />\n                ) : (\n                  <Maximize2 className=\"h-4 w-4\" />\n                )}\n              </Button>\n            </div>\n            <SheetDescription className=\"text-[var(--text-secondary)]\">\n              {activeStudyType === 'flashcards' && `${flashcards.length} cards generated from your sources`}\n              {activeStudyType === 'quiz' && `${quizQuestions.length} questions to test your knowledge`}\n              {activeStudyType === 'guide' && 'Comprehensive study guide from your sources'}\n              {activeStudyType === 'faq' && `${faqItems.length} frequently asked questions`}\n              {activeStudyType === 'mindmap' && 'Interactive visualization of key concepts'}\n              {activeStudyType === 'datatable' && 'Structured data extracted from your sources'}\n              {activeStudyType === 'report' && 'Professional document from your sources'}\n              {activeStudyType === 'slides' && 'Presentation slides from your sources'}\n              {activeStudyType === 'infographic' && 'AI-generated images visualizing key concepts'}\n              {activeStudyType === 'audio' && 'Podcast-style audio discussion'}\n              {activeStudyType === 'video' && 'Visual explainer video'}\n              {activeStudyType === 'research' && 'Deep web research findings'}\n            </SheetDescription>\n          </SheetHeader>\n\n          <div className=\"mt-6 relative\">\n            {/* Flashcards View */}\n            {activeStudyType === 'flashcards' && (\n              <FlashcardViewer\n                flashcards={flashcards}\n                onClose={() => setStudySheetOpen(false)}\n              />\n            )}\n\n            {/* Quiz View */}\n            {activeStudyType === 'quiz' && (\n              <QuizViewer\n                questions={quizQuestions}\n                onClose={() => setStudySheetOpen(false)}\n              />\n            )}\n\n            {/* Study Guide View */}\n            {activeStudyType === 'guide' && studyGuide && (\n              <StudyGuideViewer\n                guide={studyGuide}\n                onClose={() => setStudySheetOpen(false)}\n              />\n            )}\n\n            {/* FAQ View */}\n            {activeStudyType === 'faq' && (\n              <FAQViewer\n                items={faqItems}\n                onClose={() => setStudySheetOpen(false)}\n              />\n            )}\n\n            {/* Mind Map View */}\n            {activeStudyType === 'mindmap' && mindMap && (\n              <MindMapViewer\n                title={mindMap.title}\n                nodes={mindMap.nodes}\n                onClose={() => setStudySheetOpen(false)}\n              />\n            )}\n\n            {/* Audio View */}\n            {activeStudyType === 'audio' && (\n              <AudioPlayer\n                audio={activeGeneratedAudio ?? null}\n                isGenerating={generatingAudio}\n                onClose={() => setStudySheetOpen(false)}\n              />\n            )}\n\n            {/* Video View */}\n            {activeStudyType === 'video' && (\n              <VideoPlayer\n                video={activeGeneratedVideo ?? null}\n                isGenerating={generatingVideo}\n                onClose={() => setStudySheetOpen(false)}\n              />\n            )}\n\n            {/* Research View */}\n            {activeStudyType === 'research' && (\n              <ResearchReport\n                research={activeGeneratedResearch ?? null}\n                isResearching={researching}\n                onClose={() => setStudySheetOpen(false)}\n              />\n            )}\n\n            {/* Data Table View */}\n            {activeStudyType === 'datatable' && dataTableData && (\n              <div className=\"space-y-4\">\n                <div className=\"p-4 rounded-xl bg-[var(--bg-tertiary)]\">\n                  <h3 className=\"text-lg font-semibold text-[var(--text-primary)] mb-2\">{dataTableData.title}</h3>\n                  <p className=\"text-sm text-[var(--text-secondary)] mb-4\">{dataTableData.description}</p>\n                  <div className=\"overflow-x-auto\">\n                    <table className=\"w-full text-sm\">\n                      <thead>\n                        <tr className=\"border-b border-[rgba(255,255,255,0.1)]\">\n                          {dataTableData.columns.map((col) => (\n                            <th key={col.key} className=\"text-left p-3 font-medium text-[var(--text-primary)]\">\n                              {col.header}\n                            </th>\n                          ))}\n                        </tr>\n                      </thead>\n                      <tbody>\n                        {dataTableData.rows.map((row, idx) => (\n                          <tr key={idx} className=\"border-b border-[rgba(255,255,255,0.05)] hover:bg-[var(--bg-secondary)]\">\n                            {dataTableData.columns.map((col) => (\n                              <td key={col.key} className=\"p-3 text-[var(--text-secondary)]\">\n                                {String(row[col.key] ?? '')}\n                              </td>\n                            ))}\n                          </tr>\n                        ))}\n                      </tbody>\n                    </table>\n                  </div>\n                </div>\n              </div>\n            )}\n\n            {/* Report View */}\n            {activeStudyType === 'report' && reportData && (\n              <div className=\"space-y-6\">\n                <div className=\"p-4 rounded-xl bg-[var(--bg-tertiary)]\">\n                  <h2 className=\"text-xl font-bold text-[var(--text-primary)] mb-4\">{reportData.title}</h2>\n                  <div className=\"p-4 rounded-lg bg-[var(--accent-primary)]/10 border border-[var(--accent-primary)]/20 mb-6\">\n                    <h3 className=\"text-sm font-semibold text-[var(--accent-primary)] mb-2\">Executive Summary</h3>\n                    <p className=\"text-sm text-[var(--text-secondary)]\">{reportData.executive_summary}</p>\n                  </div>\n                  {reportData.sections.map((section, idx) => (\n                    <div key={idx} className=\"mb-6\">\n                      <h3 className=\"text-lg font-semibold text-[var(--text-primary)] mb-2\">{section.heading}</h3>\n                      <p className=\"text-sm text-[var(--text-secondary)] whitespace-pre-wrap\">{section.content}</p>\n                    </div>\n                  ))}\n                  <div className=\"mt-6 p-4 rounded-lg bg-[var(--bg-secondary)]\">\n                    <h3 className=\"text-sm font-semibold text-[var(--text-primary)] mb-2\">Key Takeaways</h3>\n                    <ul className=\"list-disc list-inside space-y-1\">\n                      {reportData.key_takeaways.map((takeaway, idx) => (\n                        <li key={idx} className=\"text-sm text-[var(--text-secondary)]\">{takeaway}</li>\n                      ))}\n                    </ul>\n                  </div>\n                </div>\n              </div>\n            )}\n\n            {/* Slide Deck View */}\n            {activeStudyType === 'slides' && slideDeckData && (\n              <div className=\"space-y-4\">\n                <div className=\"text-center mb-6\">\n                  <h2 className=\"text-xl font-bold text-[var(--text-primary)]\">{slideDeckData.title}</h2>\n                  {slideDeckData.subtitle && (\n                    <p className=\"text-sm text-[var(--text-secondary)] mt-1\">{slideDeckData.subtitle}</p>\n                  )}\n                  <Badge className=\"mt-2 bg-[var(--bg-tertiary)] text-[var(--text-secondary)]\">\n                    {slideDeckData.slides.length} slides\n                  </Badge>\n                </div>\n                <div className=\"space-y-4\">\n                  {slideDeckData.slides.map((slide) => (\n                    <div key={slide.slide_number} className=\"p-4 rounded-xl bg-[var(--bg-tertiary)] border border-[rgba(255,255,255,0.1)]\">\n                      <div className=\"flex items-center gap-2 mb-3\">\n                        <Badge className=\"bg-[var(--accent-primary)]/20 text-[var(--accent-primary)]\">\n                          {slide.slide_number}\n                        </Badge>\n                        <span className=\"text-xs text-[var(--text-tertiary)] uppercase\">{slide.content_type}</span>\n                      </div>\n                      <h3 className=\"text-lg font-semibold text-[var(--text-primary)] mb-2\">{slide.title}</h3>\n                      <p className=\"text-sm text-[var(--text-secondary)] mb-3\">{slide.main_content}</p>\n                      {slide.bullet_points && slide.bullet_points.length > 0 && (\n                        <ul className=\"list-disc list-inside space-y-1 mb-3\">\n                          {slide.bullet_points.map((point, idx) => (\n                            <li key={idx} className=\"text-sm text-[var(--text-secondary)]\">{point}</li>\n                          ))}\n                        </ul>\n                      )}\n                      {slide.speaker_notes && (\n                        <div className=\"mt-3 p-3 rounded-lg bg-[var(--bg-secondary)] text-xs text-[var(--text-tertiary)]\">\n                          <span className=\"font-medium\">Speaker notes:</span> {slide.speaker_notes}\n                        </div>\n                      )}\n                    </div>\n                  ))}\n                </div>\n              </div>\n            )}\n\n            {/* Infographic View */}\n            {activeStudyType === 'infographic' && infographicData && (\n              // Check if it's the new image-based format\n              infographicData.images && infographicData.images.length > 0 ? (\n                <InfographicViewer\n                  data={{\n                    images: infographicData.images,\n                    concepts: infographicData.concepts || []\n                  }}\n                  onClose={() => setStudySheetOpen(false)}\n                />\n              ) : infographicData.color_scheme && infographicData.sections ? (\n                // Legacy format (backward compatibility)\n                <div className=\"space-y-6\">\n                  {/* Header Section */}\n                  <div\n                    className=\"p-8 rounded-2xl text-center\"\n                    style={{\n                      background: `linear-gradient(135deg, ${infographicData.color_scheme[0]}20 0%, ${infographicData.color_scheme[1]}20 100%)`,\n                      borderLeft: `4px solid ${infographicData.color_scheme[0]}`\n                    }}\n                  >\n                    <h2 className=\"text-2xl font-bold text-[var(--text-primary)]\">{infographicData.title}</h2>\n                    {infographicData.subtitle && (\n                      <p className=\"text-base text-[var(--text-secondary)] mt-2\">{infographicData.subtitle}</p>\n                    )}\n                  </div>\n\n                  {/* Render each section based on type */}\n                  {infographicData.sections.map((section, idx) => {\n                    const sectionColor = infographicData.color_scheme![idx % infographicData.color_scheme!.length]\n                    const content = section.content as Record<string, unknown>\n\n                    // Stats Section\n                    if (section.section_type === 'stats' && content.items) {\n                      const items = content.items as Array<{ value: string; label: string; icon?: string }>\n                      return (\n                        <div key={idx} className=\"p-6 rounded-xl bg-[var(--bg-tertiary)]\">\n                          {section.title && <h3 className=\"text-lg font-semibold text-[var(--text-primary)] mb-4\">{section.title}</h3>}\n                          <div className=\"grid grid-cols-3 gap-4\">\n                            {items.map((item, i) => (\n                              <div key={i} className=\"text-center p-4 rounded-lg\" style={{ backgroundColor: `${sectionColor}15` }}>\n                                <div className=\"text-2xl font-bold\" style={{ color: sectionColor }}>{item.value}</div>\n                                <div className=\"text-sm text-[var(--text-secondary)] mt-1\">{item.label}</div>\n                              </div>\n                            ))}\n                          </div>\n                        </div>\n                      )\n                    }\n\n                    // Timeline Section\n                    if (section.section_type === 'timeline' && content.events) {\n                      const events = content.events as Array<{ date: string; title: string; description?: string }>\n                      return (\n                        <div key={idx} className=\"p-6 rounded-xl bg-[var(--bg-tertiary)]\">\n                          {section.title && <h3 className=\"text-lg font-semibold text-[var(--text-primary)] mb-4\">{section.title}</h3>}\n                          <div className=\"space-y-4\">\n                            {events.map((event, i) => (\n                              <div key={i} className=\"flex gap-4\">\n                                <div className=\"flex flex-col items-center\">\n                                  <div className=\"w-3 h-3 rounded-full\" style={{ backgroundColor: sectionColor }} />\n                                  {i < events.length - 1 && <div className=\"w-0.5 flex-1 mt-1\" style={{ backgroundColor: `${sectionColor}40` }} />}\n                                </div>\n                                <div className=\"flex-1 pb-4\">\n                                  <div className=\"font-semibold\" style={{ color: sectionColor }}>{event.date}</div>\n                                  <div className=\"font-medium text-[var(--text-primary)]\">{event.title}</div>\n                                  {event.description && <div className=\"text-sm text-[var(--text-secondary)] mt-1\">{event.description}</div>}\n                                </div>\n                              </div>\n                            ))}\n                          </div>\n                        </div>\n                      )\n                    }\n\n                    // Process/Steps Section\n                    if (section.section_type === 'process' && content.steps) {\n                      const steps = content.steps as Array<{ step: number; title: string; description?: string }>\n                      return (\n                        <div key={idx} className=\"p-6 rounded-xl bg-[var(--bg-tertiary)]\">\n                          {section.title && <h3 className=\"text-lg font-semibold text-[var(--text-primary)] mb-4\">{section.title}</h3>}\n                          <div className=\"space-y-3\">\n                            {steps.map((step, i) => (\n                              <div key={i} className=\"flex gap-4 items-start\">\n                                <div\n                                  className=\"w-8 h-8 rounded-full flex items-center justify-center text-white font-bold text-sm shrink-0\"\n                                  style={{ backgroundColor: sectionColor }}\n                                >\n                                  {step.step}\n                                </div>\n                                <div>\n                                  <div className=\"font-medium text-[var(--text-primary)]\">{step.title}</div>\n                                  {step.description && <div className=\"text-sm text-[var(--text-secondary)] mt-1\">{step.description}</div>}\n                                </div>\n                              </div>\n                            ))}\n                          </div>\n                        </div>\n                      )\n                    }\n\n                    // Comparison Section\n                    if (section.section_type === 'comparison' && content.left && content.right) {\n                      const left = content.left as { label: string; points: string[] }\n                      const right = content.right as { label: string; points: string[] }\n                      return (\n                        <div key={idx} className=\"p-6 rounded-xl bg-[var(--bg-tertiary)]\">\n                          {section.title && <h3 className=\"text-lg font-semibold text-[var(--text-primary)] mb-4\">{section.title}</h3>}\n                          <div className=\"grid grid-cols-2 gap-4\">\n                            <div className=\"p-4 rounded-lg\" style={{ backgroundColor: `${infographicData.color_scheme![0]}15` }}>\n                              <div className=\"font-semibold mb-3\" style={{ color: infographicData.color_scheme![0] }}>{left.label}</div>\n                              <ul className=\"space-y-2\">\n                                {left.points.map((point, i) => (\n                                  <li key={i} className=\"text-sm text-[var(--text-secondary)] flex items-start gap-2\">\n                                    <span style={{ color: infographicData.color_scheme![0] }}>•</span>\n                                    {point}\n                                  </li>\n                                ))}\n                              </ul>\n                            </div>\n                            <div className=\"p-4 rounded-lg\" style={{ backgroundColor: `${infographicData.color_scheme![1]}15` }}>\n                              <div className=\"font-semibold mb-3\" style={{ color: infographicData.color_scheme![1] }}>{right.label}</div>\n                              <ul className=\"space-y-2\">\n                                {right.points.map((point, i) => (\n                                  <li key={i} className=\"text-sm text-[var(--text-secondary)] flex items-start gap-2\">\n                                    <span style={{ color: infographicData.color_scheme![1] }}>•</span>\n                                    {point}\n                                  </li>\n                                ))}\n                              </ul>\n                            </div>\n                          </div>\n                        </div>\n                      )\n                    }\n\n                    // List Section\n                    if (section.section_type === 'list' && content.items) {\n                      const items = content.items as string[]\n                      return (\n                        <div key={idx} className=\"p-6 rounded-xl bg-[var(--bg-tertiary)]\">\n                          {section.title && <h3 className=\"text-lg font-semibold text-[var(--text-primary)] mb-4\">{section.title}</h3>}\n                          <ul className=\"space-y-3\">\n                            {items.map((item, i) => (\n                              <li key={i} className=\"flex items-start gap-3\">\n                                <div\n                                  className=\"w-2 h-2 rounded-full mt-2 shrink-0\"\n                                  style={{ backgroundColor: sectionColor }}\n                                />\n                                <span className=\"text-[var(--text-secondary)]\">{item}</span>\n                              </li>\n                            ))}\n                          </ul>\n                        </div>\n                      )\n                    }\n\n                    // Quote Section\n                    if (section.section_type === 'quote') {\n                      const quote = content.quote as string\n                      const author = content.author as string | undefined\n                      return (\n                        <div\n                          key={idx}\n                          className=\"p-6 rounded-xl\"\n                          style={{\n                            backgroundColor: `${sectionColor}10`,\n                            borderLeft: `4px solid ${sectionColor}`\n                          }}\n                        >\n                          {section.title && <h3 className=\"text-lg font-semibold text-[var(--text-primary)] mb-3\">{section.title}</h3>}\n                          <blockquote className=\"text-lg italic text-[var(--text-primary)]\">\"{quote}\"</blockquote>\n                          {author && <div className=\"mt-2 text-sm text-[var(--text-secondary)]\">— {author}</div>}\n                        </div>\n                      )\n                    }\n\n                    // Default/Header/Footer - simple display\n                    return (\n                      <div key={idx} className=\"p-6 rounded-xl bg-[var(--bg-tertiary)]\">\n                        {section.title && <h3 className=\"text-lg font-semibold text-[var(--text-primary)] mb-2\">{section.title}</h3>}\n                        {typeof content.subtitle === 'string' && <p className=\"text-[var(--text-secondary)]\">{content.subtitle}</p>}\n                        {typeof content.text === 'string' && <p className=\"text-sm text-[var(--text-tertiary)]\">{content.text}</p>}\n                      </div>\n                    )\n                  })}\n\n                  {/* Style suggestion footer */}\n                  <p className=\"text-xs text-[var(--text-tertiary)] text-center italic pt-4 border-t border-[rgba(255,255,255,0.1)]\">\n                    Design suggestion: {infographicData.style_suggestion}\n                  </p>\n                </div>\n              ) : (\n                <div className=\"text-center py-12 text-[var(--text-tertiary)]\">\n                  <ImageIcon className=\"h-12 w-12 mx-auto mb-4 opacity-50\" />\n                  <p>No infographic data available</p>\n                </div>\n              )\n            )}\n          </div>\n          </div>\n        </SheetContent>\n      </Sheet>\n\n      {/* Hidden file input */}\n      <input\n        ref={fileInputRef}\n        type=\"file\"\n        accept=\".pdf,.docx,.txt,.md\"\n        className=\"hidden\"\n      />\n\n      {/* Notebook Settings Dialog */}\n      <NotebookSettingsDialog\n        open={settingsOpen}\n        onOpenChange={setSettingsOpen}\n        settings={notebookSettings}\n        onSave={saveNotebookSettings}\n        notebookName={notebook?.name || 'Notebook'}\n      />\n    </div>\n  )\n}\n","structuredPatch":[{"oldStart":37,"oldLines":8,"newStart":37,"newLines":9,"lines":[" import { ThreePanelLayout } from '@/components/panels/three-panel-layout'"," import { SourcesPanel } from '@/components/sources/sources-panel'"," import { ChatPanel } from '@/components/chat/chat-panel'","-import { StudioPanel } from '@/components/studio/studio-panel'","+import { StudioPanel, ExportOptionsState } from '@/components/studio/studio-panel'"," import type { GenerationConfig } from '@/components/studio/generation-config-dialog'","+import { exportNotebook } from '@/lib/export-utils'"," import {","   useNotebook,","   useSources,"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"5b7d372e-40f4-4869-bee1-e725bcf5b005"}
{"parentUuid":"395f89b6-bec4-4ee2-a22d-0ec64ccce118","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Hz3F1X4VyQ2PS4dKM1cfpY","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Now I need to add the exportingNotebook state and the handler function. Let me find a good place to add the state.","signature":"EpsCCkYICxgCKkCLTv/XvArQa1F8Eo6Dc4FnI87U584f0eTo8wM+jVY2Zu8+37I/P3p5MVOzL/r60/1RDa9O1u8CMpaPg73uaNpsEgz7dopzHUYoS9nHbL8aDKvk+DYnh5dKzCJlpyIwDKcHRp/X39NsbvF/C73s36Qg3CaZQkNb/LZrk1vaMdRI5Idw2MGt31hWCtqZ1e02KoIBpLCec4ZxlbVg1fYLN180IP5WkeT4pOe7ICliQmUpzJEfmCErUUcdFeniuFz4sCP/hX91xFYWGZW10hjjZ8SIPunQDOcuLUrjdbOk9wfbvjlyJjZOnnOPrJzURANHEpzTmPG+7SfKBDnWV4qi01CPcOcJhJdZ9pwTuYFL9+X9UctvhRgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":768,"cache_read_input_tokens":132862,"cache_creation":{"ephemeral_5m_input_tokens":768,"ephemeral_1h_input_tokens":0},"output_tokens":7,"service_tier":"standard"}},"requestId":"req_011CWz6aiZvV9vfoqb1e9zTH","type":"assistant","uuid":"dcbd9e19-3233-4a4d-addb-f246ef112818","timestamp":"2026-01-10T17:32:23.839Z"}
{"parentUuid":"dcbd9e19-3233-4a4d-addb-f246ef112818","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Hz3F1X4VyQ2PS4dKM1cfpY","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_015WvpVx43JAS2XHRGKnS3zA","name":"Edit","input":{"replace_all":false,"file_path":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend/src/app/notebooks/[id]/page.tsx","old_string":"  // Research state\n  const [researchQuery, setResearchQuery] = useState('')\n  const [researchMode, setResearchMode] = useState('fast')\n  const [researching, setResearching] = useState(false)","new_string":"  // Research state\n  const [researchQuery, setResearchQuery] = useState('')\n  const [researchMode, setResearchMode] = useState('fast')\n  const [researching, setResearching] = useState(false)\n\n  // Export state\n  const [exportingNotebook, setExportingNotebook] = useState(false)"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":768,"cache_read_input_tokens":132862,"cache_creation":{"ephemeral_5m_input_tokens":768,"ephemeral_1h_input_tokens":0},"output_tokens":314,"service_tier":"standard"}},"requestId":"req_011CWz6aiZvV9vfoqb1e9zTH","type":"assistant","uuid":"06b756de-8215-476b-9c91-7c9c27dc2e51","timestamp":"2026-01-10T17:32:25.968Z"}
{"parentUuid":"06b756de-8215-476b-9c91-7c9c27dc2e51","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_015WvpVx43JAS2XHRGKnS3zA","type":"tool_result","content":"The file /Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend/src/app/notebooks/[id]/page.tsx has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n   136→  // Video state\n   137→  const [videoStyle, setVideoStyle] = useState('explainer')\n   138→  const [generatingVideo, setGeneratingVideo] = useState(false)\n   139→\n   140→  // Research state\n   141→  const [researchQuery, setResearchQuery] = useState('')\n   142→  const [researchMode, setResearchMode] = useState('fast')\n   143→  const [researching, setResearching] = useState(false)\n   144→\n   145→  // Export state\n   146→  const [exportingNotebook, setExportingNotebook] = useState(false)\n   147→\n   148→  // Consolidated generating states - single object to reduce re-renders\n   149→  const [generating, setGenerating] = useState({\n   150→    flashcards: false,"}]},"uuid":"72420fa8-68f9-440c-ac6f-45c6f3af5b5d","timestamp":"2026-01-10T17:32:26.008Z","toolUseResult":{"filePath":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend/src/app/notebooks/[id]/page.tsx","oldString":"  // Research state\n  const [researchQuery, setResearchQuery] = useState('')\n  const [researchMode, setResearchMode] = useState('fast')\n  const [researching, setResearching] = useState(false)","newString":"  // Research state\n  const [researchQuery, setResearchQuery] = useState('')\n  const [researchMode, setResearchMode] = useState('fast')\n  const [researching, setResearching] = useState(false)\n\n  // Export state\n  const [exportingNotebook, setExportingNotebook] = useState(false)","originalFile":"'use client'\n\nimport { useEffect, useState, useRef } from 'react'\nimport { useParams, useRouter, useSearchParams } from 'next/navigation'\nimport { motion, AnimatePresence } from 'framer-motion'\nimport { createClient, Notebook, Source, ChatMessage } from '@/lib/supabase'\nimport { chatApi } from '@/lib/api'\nimport { Button } from '@/components/ui/button'\nimport { Input } from '@/components/ui/input'\nimport { Textarea } from '@/components/ui/textarea'\nimport { Badge } from '@/components/ui/badge'\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n} from '@/components/ui/dialog'\nimport {\n  Sheet,\n  SheetContent,\n  SheetDescription,\n  SheetHeader,\n  SheetTitle,\n} from '@/components/ui/sheet'\nimport {\n  ArrowLeft, Loader2, Sparkles, X, RotateCcw,\n  BookOpen, ListChecks, FileText, HelpCircle, Mic, Video, Search, Share2,\n  Maximize2, Minimize2, Table, FileSpreadsheet, Presentation, Image as ImageIcon,\n  History, Settings\n} from 'lucide-react'\n// Toast notifications removed per user request\n// import { toast } from 'sonner'\nimport { User } from '@supabase/supabase-js'\n\nimport { ThreePanelLayout } from '@/components/panels/three-panel-layout'\nimport { SourcesPanel } from '@/components/sources/sources-panel'\nimport { ChatPanel } from '@/components/chat/chat-panel'\nimport { StudioPanel, ExportOptionsState } from '@/components/studio/studio-panel'\nimport type { GenerationConfig } from '@/components/studio/generation-config-dialog'\nimport { exportNotebook } from '@/lib/export-utils'\nimport {\n  useNotebook,\n  useSources,\n  useNotes,\n  useChatSessions,\n  useGeneratedAudio,\n  useGeneratedVideo,\n  useGeneratedResearch,\n  useStudyMaterials,\n  useCreativeOutputs,\n  useInvalidateNotebook,\n} from '@/lib/hooks/use-notebook-queries'\n\n// Study viewers\nimport { FlashcardViewer } from '@/components/study/flashcard-viewer'\nimport { QuizViewer } from '@/components/study/quiz-viewer'\nimport { StudyGuideViewer } from '@/components/study/study-guide-viewer'\nimport { FAQViewer } from '@/components/study/faq-viewer'\nimport { MindMapViewer } from '@/components/study/mind-map-viewer'\n\n// Studio viewers\nimport { AudioPlayer } from '@/components/studio/audio-player'\nimport { VideoPlayer } from '@/components/studio/video-player'\nimport { ResearchReport } from '@/components/studio/research-report'\nimport { InfographicViewer } from '@/components/studio/infographic-viewer'\n\n// Notebook settings\nimport { NotebookSettingsDialog, NotebookSettings } from '@/components/notebook/notebook-settings'\n\ninterface LocalNote {\n  id: string\n  notebook_id: string\n  type: 'written' | 'saved_response'\n  title: string | null\n  content: string | null\n  tags: string[]\n  is_pinned: boolean\n  created_at: string\n  updated_at: string\n}\n\nexport default function NotebookPage() {\n  const params = useParams()\n  const router = useRouter()\n  const searchParams = useSearchParams()\n  const notebookId = params.id as string\n  const supabase = createClient()\n\n  // Core state - React Query for cached data\n  const [user, setUser] = useState<User | null>(null)\n  const [authChecked, setAuthChecked] = useState(false)\n  const [messages, setMessages] = useState<ChatMessage[]>([])\n\n  // React Query hooks for cached data\n  const { data: notebook, isLoading: notebookLoading } = useNotebook(notebookId)\n  const { data: sources = [], isLoading: sourcesLoading } = useSources(notebookId)\n  const { data: notes = [], isLoading: notesLoading } = useNotes(notebookId)\n  const { data: chatSessions = [], isLoading: loadingSessions } = useChatSessions(notebookId)\n  const { data: generatedAudio } = useGeneratedAudio(notebookId)\n  const { data: generatedVideo } = useGeneratedVideo(notebookId)\n  const { data: generatedResearch } = useGeneratedResearch(notebookId)\n  const { data: studyMaterialsData } = useStudyMaterials(notebookId, sources.map(s => ({ id: s.id, name: s.name })))\n  const { data: creativeOutputsData } = useCreativeOutputs(notebookId)\n  const invalidate = useInvalidateNotebook()\n\n  // Derived loading state\n  const loading = !authChecked || notebookLoading || sourcesLoading || notesLoading\n\n  // Chat state\n  const [sending, setSending] = useState(false)\n  const [message, setMessage] = useState('')\n  const [selectedSources, setSelectedSources] = useState<Set<string>>(new Set())\n  const [sessionId, setSessionId] = useState<string | null>(null)\n\n  // Source state\n  const [viewingSource, setViewingSource] = useState<Source | null>(null)\n  const [uploading, setUploading] = useState(false)\n\n  // Notes state\n  const [addNoteOpen, setAddNoteOpen] = useState(false)\n  const [noteTitle, setNoteTitle] = useState('')\n  const [noteContent, setNoteContent] = useState('')\n  const [savingNote, setSavingNote] = useState(false)\n\n  // Settings state\n  const [settingsOpen, setSettingsOpen] = useState(false)\n  const [notebookSettings, setNotebookSettings] = useState<NotebookSettings | null>(null)\n\n  // Audio state\n  const [audioFormat, setAudioFormat] = useState('deep_dive')\n  const [audioInstructions, setAudioInstructions] = useState('')\n  const [generatingAudio, setGeneratingAudio] = useState(false)\n\n  // Video state\n  const [videoStyle, setVideoStyle] = useState('explainer')\n  const [generatingVideo, setGeneratingVideo] = useState(false)\n\n  // Research state\n  const [researchQuery, setResearchQuery] = useState('')\n  const [researchMode, setResearchMode] = useState('fast')\n  const [researching, setResearching] = useState(false)\n\n  // Consolidated generating states - single object to reduce re-renders\n  const [generating, setGenerating] = useState({\n    flashcards: false,\n    quiz: false,\n    studyGuide: false,\n    faq: false,\n    mindMap: false,\n    dataTable: false,\n    report: false,\n    slideDeck: false,\n    infographic: false,\n  })\n\n  // Helper to update single generating state\n  const setGeneratingState = (key: keyof typeof generating, value: boolean) => {\n    setGenerating(prev => ({ ...prev, [key]: value }))\n  }\n\n  // Study results\n  const [flashcards, setFlashcards] = useState<Array<{ id: string; front: string; back: string }>>([])\n  const [quizQuestions, setQuizQuestions] = useState<Array<{ id: string; question: string; options: string[]; correct_index: number; explanation: string }>>([])\n  const [studyGuide, setStudyGuide] = useState<{ title: string; sections: Array<{ heading: string; content: string }> } | null>(null)\n  const [faqItems, setFaqItems] = useState<Array<{ question: string; answer: string }>>([])\n  const [mindMap, setMindMap] = useState<{ title: string; nodes: Array<{ id: string; label: string; description?: string; children?: Array<{ id: string; label: string; description?: string; children?: Array<{ id: string; label: string; description?: string }> }> }> } | null>(null)\n\n  // Creative outputs data\n  const [dataTableData, setDataTableData] = useState<{\n    title: string\n    description: string\n    columns: Array<{ header: string; key: string; type: string }>\n    rows: Array<Record<string, string | number | boolean>>\n  } | null>(null)\n  const [reportData, setReportData] = useState<{\n    title: string\n    executive_summary: string\n    sections: Array<{ heading: string; content: string }>\n    key_takeaways: string[]\n  } | null>(null)\n  const [slideDeckData, setSlideDeckData] = useState<{\n    title: string\n    subtitle?: string\n    slides: Array<{ slide_number: number; title: string; content_type: string; main_content: string; bullet_points?: string[]; speaker_notes?: string }>\n    theme_suggestion: string\n  } | null>(null)\n  // Infographic data - supports new image-based format\n  const [infographicData, setInfographicData] = useState<{\n    // New image-based format\n    images?: Array<{ title: string; prompt: string; imageData: string; mimeType: string }>\n    concepts?: string[]\n    // Legacy format (for backward compatibility)\n    title?: string\n    subtitle?: string\n    color_scheme?: string[]\n    sections?: Array<{ section_type: string; title?: string; content: Record<string, unknown> }>\n    style_suggestion?: string\n  } | null>(null)\n\n  // Study materials metadata (for UI display)\n  const [studyMaterialsMeta, setStudyMaterialsMeta] = useState<Array<{\n    id: string\n    type: string\n    sourceIds: string[]\n    sourceNames: string[]\n    createdAt: string\n    itemCount?: number\n  }>>([])\n\n  // Creative outputs metadata (for UI display)\n  const [creativeOutputsMeta, setCreativeOutputsMeta] = useState<Array<{\n    id: string\n    type: string\n    title: string\n    status: string\n    createdAt: string\n    content?: Record<string, unknown>\n  }>>([])\n\n  const [currentFlashcard, setCurrentFlashcard] = useState(0)\n  const [showFlashcardBack, setShowFlashcardBack] = useState(false)\n  const [currentQuizQuestion, setCurrentQuizQuestion] = useState(0)\n  const [selectedAnswer, setSelectedAnswer] = useState<number | null>(null)\n  const [showQuizAnswer, setShowQuizAnswer] = useState(false)\n\n  // Study materials sheet\n  const [studySheetOpen, setStudySheetOpen] = useState(false)\n  const [sheetWidth, setSheetWidth] = useState(576) // Default width in pixels\n  const [isResizing, setIsResizing] = useState(false)\n  const [activeStudyType, setActiveStudyType] = useState<'flashcards' | 'quiz' | 'guide' | 'faq' | 'mindmap' | 'audio' | 'video' | 'research' | 'datatable' | 'report' | 'slides' | 'infographic' | null>(null)\n\n  // Local state for newly generated content (overrides cached until next fetch)\n  const [localGeneratedAudio, setLocalGeneratedAudio] = useState<typeof generatedAudio | null>(null)\n  const [localGeneratedVideo, setLocalGeneratedVideo] = useState<typeof generatedVideo | null>(null)\n  const [localGeneratedResearch, setLocalGeneratedResearch] = useState<{\n    id: string\n    query: string\n    mode: string\n    status: string\n    progress_message?: string\n    sources_found_count?: number\n    sources_analyzed_count?: number\n    report_content?: string\n    report_citations?: { title: string; url: string }[]\n    created_at: string\n    completed_at?: string\n  } | null>(null)\n\n  // Use local state if set, otherwise use cached data\n  const activeGeneratedAudio = localGeneratedAudio ?? generatedAudio\n  const activeGeneratedVideo = localGeneratedVideo ?? generatedVideo\n  const activeGeneratedResearch = localGeneratedResearch ?? generatedResearch\n\n  // File input ref\n  const fileInputRef = useRef<HTMLInputElement>(null)\n\n  // Initialize - just check auth, React Query handles data fetching\n  useEffect(() => {\n    const init = async () => {\n      const { data: { user } } = await supabase.auth.getUser()\n      if (!user) {\n        router.push('/auth/login')\n        return\n      }\n      setUser(user)\n      setAuthChecked(true)\n    }\n    init()\n  }, [notebookId])\n\n\n  // Load a chat session\n  const loadChatSession = async (loadSessionId: string) => {\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n      const response = await fetch(`/api/notebooks/${notebookId}/chat/sessions/${loadSessionId}`, {\n        headers: {\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n      })\n      const result = await response.json()\n      if (result.data) {\n        setSessionId(loadSessionId)\n        setMessages(result.data.messages || [])\n      }\n    } catch (error) {\n      console.error('Failed to load chat session:', error)\n      \n    }\n  }\n\n  // Start a new chat\n  const startNewChat = () => {\n    setSessionId(null)\n    setMessages([])\n    setMessage('')\n  }\n\n  // Delete a chat session\n  const deleteChatSession = async (deleteSessionId: string) => {\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n      const response = await fetch(`/api/notebooks/${notebookId}/chat/sessions/${deleteSessionId}`, {\n        method: 'DELETE',\n        headers: {\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n      })\n      if (response.ok) {\n        // Invalidate cache to refresh the list\n        invalidate.invalidateChatSessions(notebookId)\n\n        // If we deleted the current session, start a new chat\n        if (deleteSessionId === sessionId) {\n          startNewChat()\n        }\n      }\n    } catch (error) {\n      console.error('Failed to delete chat session:', error)\n\n    }\n  }\n\n  // Rename a chat session\n  const renameChatSession = async (renameSessionId: string, newTitle: string) => {\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n      const response = await fetch(`/api/notebooks/${notebookId}/chat/sessions/${renameSessionId}`, {\n        method: 'PATCH',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n        body: JSON.stringify({ title: newTitle }),\n      })\n      if (response.ok) {\n        // Invalidate cache to refresh the list\n        invalidate.invalidateChatSessions(notebookId)\n      }\n    } catch (error) {\n      console.error('Failed to rename chat session:', error)\n    }\n  }\n\n  // Load selected sources from localStorage after sources are loaded\n  useEffect(() => {\n    if (sources.length > 0 && !loading) {\n      const savedSelection = localStorage.getItem(`notebook-${notebookId}-selected-sources`)\n      if (savedSelection) {\n        try {\n          const savedIds = JSON.parse(savedSelection) as string[]\n          // Only select sources that still exist\n          const validIds = savedIds.filter(id => sources.some(s => s.id === id))\n          if (validIds.length > 0) {\n            setSelectedSources(new Set(validIds))\n          }\n        } catch {\n          // Invalid JSON, ignore\n        }\n      }\n    }\n  }, [sources, loading, notebookId])\n\n  // Save selected sources to localStorage whenever they change\n  useEffect(() => {\n    if (!loading && sources.length > 0) {\n      const selectedArray = Array.from(selectedSources)\n      localStorage.setItem(`notebook-${notebookId}-selected-sources`, JSON.stringify(selectedArray))\n    }\n  }, [selectedSources, notebookId, loading, sources.length])\n\n  // Handle view and itemId query params from history page navigation\n  useEffect(() => {\n    const view = searchParams.get('view')\n    const itemId = searchParams.get('itemId')\n\n    if (view && !loading) {\n      // Map view param to activeStudyType\n      const typeMap: Record<string, typeof activeStudyType> = {\n        audio: 'audio',\n        video: 'video',\n        research: 'research',\n        datatable: 'datatable',\n        report: 'report',\n        slides: 'slides',\n        infographic: 'infographic',\n        flashcards: 'flashcards',\n        quiz: 'quiz',\n        guide: 'guide',\n        faq: 'faq',\n        mindmap: 'mindmap',\n      }\n      const studyType = typeMap[view]\n      if (studyType) {\n        setActiveStudyType(studyType)\n        setStudySheetOpen(true)\n\n        // Clear the query params after handling\n        router.replace(`/notebooks/${notebookId}`, { scroll: false })\n      }\n    }\n  }, [searchParams, loading, notebookId, router])\n\n\n  // Fetch existing creative outputs (data tables, reports, slides, infographics)\n  const fetchCreativeOutputs = async () => {\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n      const response = await fetch(`/api/notebooks/${notebookId}/studio`, {\n        headers: {\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n      })\n      const result = await response.json()\n\n      if (result.data && Array.isArray(result.data)) {\n        // Group by type and get the latest of each\n        const outputsByType: Record<string, typeof result.data[0]> = {}\n        for (const output of result.data) {\n          if (output.status === 'completed' && !outputsByType[output.type]) {\n            outputsByType[output.type] = output\n          }\n        }\n\n        // Build metadata array\n        const metaArray = Object.values(outputsByType).map((output) => ({\n          id: output.id,\n          type: output.type,\n          title: output.title || output.type.replace('_', ' '),\n          status: output.status,\n          createdAt: output.created_at,\n          content: output.content,\n        }))\n        setCreativeOutputsMeta(metaArray)\n\n        // Populate state with the latest content of each type\n        for (const output of Object.values(outputsByType)) {\n          if (output.type === 'data_table' && output.content) {\n            setDataTableData(output.content as typeof dataTableData)\n          } else if (output.type === 'report' && output.content) {\n            setReportData(output.content as typeof reportData)\n          } else if (output.type === 'slide_deck' && output.content) {\n            setSlideDeckData(output.content as typeof slideDeckData)\n          } else if (output.type === 'infographic' && output.content) {\n            setInfographicData(output.content as typeof infographicData)\n          }\n        }\n      }\n    } catch (error) {\n      console.error('Failed to fetch creative outputs:', error)\n    }\n  }\n\n  // Fetch existing study materials from Supabase\n  const fetchStudyMaterials = async (sourcesData?: Source[]) => {\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n      const response = await fetch(`/api/notebooks/${notebookId}/study`, {\n        headers: {\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n      })\n      const result = await response.json()\n\n      if (result.data && Array.isArray(result.data)) {\n        // Group materials by type and get the latest of each\n        const materialsByType: Record<string, typeof result.data[0]> = {}\n        for (const material of result.data) {\n          if (!materialsByType[material.type]) {\n            materialsByType[material.type] = material\n          }\n        }\n\n        // Build metadata array for UI\n        const currentSources = sourcesData || sources\n        const metaArray = Object.values(materialsByType).map((material) => {\n          const sourceIds = material.source_ids || []\n          const sourceNames = sourceIds.map((id: string) => {\n            const source = currentSources.find(s => s.id === id)\n            return source?.name || 'Unknown source'\n          })\n\n          // Calculate item count based on type\n          let itemCount = 0\n          if (material.type === 'flashcards') itemCount = material.data?.flashcards?.length || 0\n          else if (material.type === 'quiz') itemCount = material.data?.questions?.length || 0\n          else if (material.type === 'faq') itemCount = material.data?.faq?.length || 0\n\n          return {\n            id: material.id,\n            type: material.type,\n            sourceIds,\n            sourceNames,\n            createdAt: material.created_at,\n            itemCount,\n          }\n        })\n        setStudyMaterialsMeta(metaArray)\n\n        // Populate state with cached data\n        if (materialsByType.flashcards?.data?.flashcards) {\n          setFlashcards(materialsByType.flashcards.data.flashcards)\n        }\n        if (materialsByType.quiz?.data?.questions) {\n          setQuizQuestions(materialsByType.quiz.data.questions)\n        }\n        if (materialsByType.study_guide?.data) {\n          setStudyGuide(materialsByType.study_guide.data)\n        }\n        if (materialsByType.faq?.data?.faq) {\n          setFaqItems(materialsByType.faq.data.faq)\n        }\n        if (materialsByType.mind_map?.data) {\n          setMindMap(materialsByType.mind_map.data)\n        }\n      }\n    } catch (error) {\n      console.error('Failed to fetch study materials:', error)\n    }\n  }\n\n  // Redirect if notebook doesn't exist\n  useEffect(() => {\n    if (!notebookLoading && !notebook) {\n      router.push('/')\n    }\n  }, [notebook, notebookLoading, router])\n\n  // Load notebook settings when notebook data is available\n  useEffect(() => {\n    if (notebook?.settings) {\n      setNotebookSettings(notebook.settings as unknown as NotebookSettings)\n    }\n  }, [notebook])\n\n  // Save notebook settings\n  const saveNotebookSettings = async (newSettings: NotebookSettings) => {\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n      const response = await fetch(`/api/notebooks/${notebookId}`, {\n        method: 'PATCH',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n        body: JSON.stringify({ settings: newSettings }),\n      })\n\n      if (!response.ok) {\n        throw new Error('Failed to save settings')\n      }\n\n      setNotebookSettings(newSettings)\n      invalidate.invalidateNotebook(notebookId)\n    } catch (error) {\n      console.error('Failed to save notebook settings:', error)\n      throw error\n    }\n  }\n\n  // Source handlers\n  const handleAddSource = async (type: string, data: { input: string; name?: string; file?: File }) => {\n    setUploading(true)\n\n    if (type === 'file') {\n      // Handle file upload - file is passed from the sources panel\n      const file = data.file\n      if (file) {\n        const fileExt = file.name.split('.').pop()?.toLowerCase()\n        const filePath = `${user?.id}/${notebookId}/${Date.now()}.${fileExt}`\n\n        const { error: uploadError } = await supabase.storage\n          .from('sources')\n          .upload(filePath, file)\n\n        if (uploadError) {\n          console.error('Upload error:', uploadError)\n          \n          setUploading(false)\n          return\n        }\n\n        const { data: sourceData, error } = await supabase\n          .from('sources')\n          .insert({\n            notebook_id: notebookId,\n            type: fileExt === 'pdf' ? 'pdf' : fileExt === 'docx' ? 'docx' : 'txt',\n            name: file.name,\n            status: 'ready',\n            file_path: filePath,\n            original_filename: file.name,\n            mime_type: file.type,\n            file_size_bytes: file.size,\n          })\n          .select()\n          .single()\n\n        if (error) {\n          console.error('Source creation error:', error)\n        } else {\n          invalidate.invalidateSources(notebookId)\n        }\n      }\n    } else {\n      let sourceData: Partial<Source> = {\n        notebook_id: notebookId,\n        status: 'ready',\n      }\n\n      if (type === 'youtube') {\n        sourceData = {\n          ...sourceData,\n          type: 'youtube',\n          name: data.name || `YouTube: ${data.input}`,\n          metadata: { url: data.input },\n        }\n      } else if (type === 'url') {\n        sourceData = {\n          ...sourceData,\n          type: 'url',\n          name: data.name || data.input,\n          metadata: { url: data.input },\n        }\n      } else if (type === 'text') {\n        sourceData = {\n          ...sourceData,\n          type: 'text',\n          name: data.name || 'Pasted Text',\n          metadata: { content: data.input },\n        }\n      }\n\n      const { error } = await supabase\n        .from('sources')\n        .insert(sourceData)\n        .select()\n        .single()\n\n      if (error) {\n        console.error('Source creation error:', error)\n      } else {\n        invalidate.invalidateSources(notebookId)\n      }\n    }\n\n    setUploading(false)\n  }\n\n  const handleDeleteSource = async (sourceId: string) => {\n    const { error } = await supabase\n      .from('sources')\n      .delete()\n      .eq('id', sourceId)\n\n    if (error) {\n      console.error('Delete source error:', error)\n    } else {\n      invalidate.invalidateSources(notebookId)\n      selectedSources.delete(sourceId)\n      setSelectedSources(new Set(selectedSources))\n    }\n  }\n\n  const toggleSource = (sourceId: string) => {\n    const newSelected = new Set(selectedSources)\n    if (newSelected.has(sourceId)) {\n      newSelected.delete(sourceId)\n    } else {\n      newSelected.add(sourceId)\n    }\n    setSelectedSources(newSelected)\n  }\n\n  const selectAllSources = () => {\n    if (selectedSources.size === sources.length) {\n      setSelectedSources(new Set())\n    } else {\n      setSelectedSources(new Set(sources.map(s => s.id)))\n    }\n  }\n\n  // Chat handlers\n  const sendMessage = async (overrideMessage?: string) => {\n    const messageToSend = overrideMessage || message\n    if (!messageToSend.trim() || sending) return\n\n    setSending(true)\n    const userMessage: ChatMessage = {\n      id: crypto.randomUUID(),\n      session_id: sessionId || '',\n      role: 'user',\n      content: messageToSend,\n      citations: [],\n      source_ids_used: Array.from(selectedSources),\n      model_used: null,\n      input_tokens: null,\n      output_tokens: null,\n      cost_usd: null,\n      created_at: new Date().toISOString(),\n    }\n    setMessages(prev => [...prev, userMessage])\n    setMessage('')\n\n    try {\n      const response = await chatApi.sendMessage(notebookId, {\n        message: userMessage.content,\n        source_ids: Array.from(selectedSources),\n        session_id: sessionId || undefined,\n      })\n\n      const isNewSession = !sessionId\n      if (response.data.session_id) {\n        setSessionId(response.data.session_id)\n      }\n\n      const aiMessage: ChatMessage = {\n        id: response.data.message_id,\n        session_id: response.data.session_id,\n        role: 'assistant',\n        content: response.data.content,\n        citations: response.data.citations,\n        source_ids_used: Array.from(selectedSources),\n        model_used: response.usage?.model_used || 'gemini-2.0-flash',\n        input_tokens: response.usage?.input_tokens || 0,\n        output_tokens: response.usage?.output_tokens || 0,\n        cost_usd: response.usage?.cost_usd || 0,\n        created_at: new Date().toISOString(),\n      }\n      setMessages(prev => [...prev, aiMessage])\n\n      // Refresh chat sessions if this was a new session\n      if (isNewSession) {\n        invalidate.invalidateChatSessions(notebookId)\n      }\n    } catch {\n      setMessages(prev => prev.filter(m => m.id !== userMessage.id))\n    }\n    setSending(false)\n  }\n\n  const saveResponseAsNote = async (msg: ChatMessage) => {\n    const { error } = await supabase\n      .from('notes')\n      .insert({\n        notebook_id: notebookId,\n        type: 'saved_response',\n        title: `Saved Response - ${new Date().toLocaleDateString()}`,\n        content: msg.content,\n        tags: [],\n      })\n      .select()\n      .single()\n\n    if (error) {\n      console.error('Save note error:', error)\n    } else {\n      invalidate.invalidateNotes(notebookId)\n    }\n  }\n\n  // Notes handlers\n  const createNote = async () => {\n    if (!noteTitle.trim() && !noteContent.trim()) return\n\n    setSavingNote(true)\n    const { error } = await supabase\n      .from('notes')\n      .insert({\n        notebook_id: notebookId,\n        type: 'written',\n        title: noteTitle || 'Untitled Note',\n        content: noteContent,\n        tags: [],\n      })\n      .select()\n      .single()\n\n    if (error) {\n      console.error('Create note error:', error)\n    } else {\n      invalidate.invalidateNotes(notebookId)\n      setNoteTitle('')\n      setNoteContent('')\n      setAddNoteOpen(false)\n    }\n    setSavingNote(false)\n  }\n\n  // Audio generation\n  const generateAudio = async () => {\n    if (selectedSources.size === 0) {\n      \n      return\n    }\n\n    setGeneratingAudio(true)\n    setActiveStudyType('audio')\n    setStudySheetOpen(true)\n\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n      const response = await fetch(`/api/notebooks/${notebookId}/audio`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n        body: JSON.stringify({\n          format: audioFormat,\n          source_ids: Array.from(selectedSources),\n          custom_instructions: audioInstructions || undefined,\n        }),\n      })\n      const result = await response.json()\n      if (result.error) {\n        console.error('Audio generation error:', result.error)\n      } else if (result.data) {\n        setLocalGeneratedAudio(result.data)\n        invalidate.invalidateAudio(notebookId)\n      }\n    } catch (error) {\n      console.error('Audio generation error:', error)\n    }\n    setGeneratingAudio(false)\n  }\n\n  // Video generation\n  const generateVideo = async () => {\n    if (selectedSources.size === 0) {\n      return\n    }\n\n    setGeneratingVideo(true)\n    setActiveStudyType('video')\n    setStudySheetOpen(true)\n\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n      const response = await fetch(`/api/notebooks/${notebookId}/video`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n        body: JSON.stringify({\n          style: videoStyle,\n          source_ids: Array.from(selectedSources),\n        }),\n      })\n      const result = await response.json()\n      if (result.error) {\n        console.error('Video generation error:', result.error)\n      } else if (result.data) {\n        // Map video_file_path to video_url for frontend components\n        setLocalGeneratedVideo({\n          ...result.data,\n          video_url: result.data.video_file_path || result.data.video_url,\n        })\n        invalidate.invalidateVideo(notebookId)\n      }\n    } catch (error) {\n      console.error('Video generation error:', error)\n    }\n    setGeneratingVideo(false)\n  }\n\n  // Research generation\n  const runResearch = async () => {\n    if (!researchQuery.trim()) {\n      return\n    }\n\n    // Clear old research to prevent showing cached results\n    setLocalGeneratedResearch(null)\n    setResearching(true)\n    setActiveStudyType('research')\n    setStudySheetOpen(true)\n\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n      const response = await fetch(`/api/notebooks/${notebookId}/research`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n        body: JSON.stringify({\n          query: researchQuery,\n          mode: researchMode,\n        }),\n      })\n      const result = await response.json()\n      if (result.error) {\n        console.error('Research failed:', result.error)\n        alert(`Research failed: ${result.error}`)\n      } else if (result.data) {\n        setLocalGeneratedResearch(result.data)\n        invalidate.invalidateResearch(notebookId)\n        setResearchQuery('')\n      }\n    } catch (error) {\n      console.error('Research error:', error)\n      alert('Research failed. Please try again.')\n    }\n    setResearching(false)\n  }\n\n  // Study material generation handlers\n  const handleGenerateFlashcards = async () => {\n    setGeneratingState('flashcards', true)\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n      const response = await fetch(`/api/notebooks/${notebookId}/study`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n        body: JSON.stringify({\n          type: 'flashcards',\n          source_ids: Array.from(selectedSources),\n          count: 5,\n        }),\n      })\n      const result = await response.json()\n      if (result.error) {\n        \n      } else if (result.data?.flashcards) {\n        setFlashcards(result.data.flashcards)\n        setCurrentFlashcard(0)\n        setShowFlashcardBack(false)\n        setActiveStudyType('flashcards')\n        setStudySheetOpen(true)\n        fetchStudyMaterials()\n        \n      }\n    } catch {\n      \n    } finally {\n      setGeneratingState('flashcards', false)\n    }\n  }\n\n  const handleGenerateQuiz = async () => {\n    setGeneratingState('quiz', true)\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n      const response = await fetch(`/api/notebooks/${notebookId}/study`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n        body: JSON.stringify({\n          type: 'quiz',\n          source_ids: Array.from(selectedSources),\n          count: 5,\n        }),\n      })\n      const result = await response.json()\n      if (result.error) {\n        \n      } else if (result.data?.questions) {\n        setQuizQuestions(result.data.questions)\n        setCurrentQuizQuestion(0)\n        setSelectedAnswer(null)\n        setShowQuizAnswer(false)\n        setActiveStudyType('quiz')\n        setStudySheetOpen(true)\n        fetchStudyMaterials()\n        \n      }\n    } catch {\n      \n    } finally {\n      setGeneratingState('quiz', false)\n    }\n  }\n\n  const handleGenerateStudyGuide = async () => {\n    setGeneratingState('studyGuide', true)\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n      const response = await fetch(`/api/notebooks/${notebookId}/study`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n        body: JSON.stringify({\n          type: 'study-guide',\n          source_ids: Array.from(selectedSources),\n        }),\n      })\n      const result = await response.json()\n      if (result.error) {\n        \n      } else if (result.data?.sections) {\n        setStudyGuide(result.data)\n        setActiveStudyType('guide')\n        setStudySheetOpen(true)\n        fetchStudyMaterials()\n        \n      }\n    } catch {\n      \n    } finally {\n      setGeneratingState('studyGuide', false)\n    }\n  }\n\n  const handleGenerateFaq = async () => {\n    setGeneratingState('faq', true)\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n      const response = await fetch(`/api/notebooks/${notebookId}/study`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n        body: JSON.stringify({\n          type: 'faq',\n          source_ids: Array.from(selectedSources),\n        }),\n      })\n      const result = await response.json()\n      if (result.error) {\n        \n      } else if (result.data?.faq) {\n        setFaqItems(result.data.faq)\n        setActiveStudyType('faq')\n        setStudySheetOpen(true)\n        fetchStudyMaterials()\n        \n      }\n    } catch {\n      \n    } finally {\n      setGeneratingState('faq', false)\n    }\n  }\n\n  const handleGenerateMindMap = async () => {\n    setGeneratingState('mindMap', true)\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n      const response = await fetch(`/api/notebooks/${notebookId}/study`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n        body: JSON.stringify({\n          type: 'mind-map',\n          source_ids: Array.from(selectedSources),\n        }),\n      })\n      const result = await response.json()\n      if (result.error) {\n\n      } else if (result.data?.nodes) {\n        setMindMap(result.data)\n        setActiveStudyType('mindmap')\n        setStudySheetOpen(true)\n        // Refresh metadata to show updated material\n        fetchStudyMaterials()\n\n      }\n    } catch {\n\n    } finally {\n      setGeneratingState('mindMap', false)\n    }\n  }\n\n  // Unified study material handler with config\n  const handleGenerateStudyMaterial = async (config: GenerationConfig) => {\n    const sourceIds = config.sourceIds && config.sourceIds.length > 0\n      ? config.sourceIds\n      : Array.from(selectedSources)\n\n    if (sourceIds.length === 0) return\n\n    // Set loading state based on type\n    const typeToStateKey: Record<string, keyof typeof generating> = {\n      'flashcards': 'flashcards',\n      'quiz': 'quiz',\n      'study-guide': 'studyGuide',\n      'faq': 'faq',\n      'mind-map': 'mindMap',\n    }\n    const stateKey = typeToStateKey[config.type]\n    if (stateKey) setGeneratingState(stateKey, true)\n\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n\n      // Build request body with all config options\n      const requestBody: Record<string, unknown> = {\n        type: config.type,\n        source_ids: sourceIds,\n      }\n\n      // Add optional config fields\n      if (config.count) requestBody.count = config.count\n      if (config.difficulty) requestBody.difficulty = config.difficulty\n      if (config.focusArea) requestBody.focus_area = config.focusArea\n      if (config.customInstructions) requestBody.custom_instructions = config.customInstructions\n      if (config.questionTypes) requestBody.question_types = config.questionTypes\n\n      const response = await fetch(`/api/notebooks/${notebookId}/study`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n        body: JSON.stringify(requestBody),\n      })\n      const result = await response.json()\n\n      if (result.error) {\n        console.error('Generation error:', result.error)\n      } else if (result.data) {\n        // Handle each type's response\n        switch (config.type) {\n          case 'flashcards':\n            if (result.data.flashcards) {\n              setFlashcards(result.data.flashcards)\n              setCurrentFlashcard(0)\n              setShowFlashcardBack(false)\n              setActiveStudyType('flashcards')\n              setStudySheetOpen(true)\n            }\n            break\n          case 'quiz':\n            if (result.data.questions) {\n              setQuizQuestions(result.data.questions)\n              setCurrentQuizQuestion(0)\n              setSelectedAnswer(null)\n              setShowQuizAnswer(false)\n              setActiveStudyType('quiz')\n              setStudySheetOpen(true)\n            }\n            break\n          case 'study-guide':\n            if (result.data.sections) {\n              setStudyGuide(result.data)\n              setActiveStudyType('guide')\n              setStudySheetOpen(true)\n            }\n            break\n          case 'faq':\n            if (result.data.faq) {\n              setFaqItems(result.data.faq)\n              setActiveStudyType('faq')\n              setStudySheetOpen(true)\n            }\n            break\n          case 'mind-map':\n            if (result.data.nodes) {\n              setMindMap(result.data)\n              setActiveStudyType('mindmap')\n              setStudySheetOpen(true)\n            }\n            break\n        }\n        fetchStudyMaterials()\n      }\n    } catch (error) {\n      console.error('Study material generation failed:', error)\n    } finally {\n      if (stateKey) setGeneratingState(stateKey, false)\n    }\n  }\n\n  // Unified creative output handler with config\n  const handleGenerateCreativeOutput = async (config: GenerationConfig) => {\n    const sourceIds = config.sourceIds && config.sourceIds.length > 0\n      ? config.sourceIds\n      : Array.from(selectedSources)\n\n    if (sourceIds.length === 0) return\n\n    // Set loading state based on type\n    const typeToStateKey2: Record<string, keyof typeof generating> = {\n      'data_table': 'dataTable',\n      'report': 'report',\n      'slide_deck': 'slideDeck',\n      'infographic': 'infographic',\n    }\n    const stateKey2 = typeToStateKey2[config.type]\n    if (stateKey2) setGeneratingState(stateKey2, true)\n\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n\n      // Build request body with all config options\n      const requestBody: Record<string, unknown> = {\n        type: config.type,\n        source_ids: sourceIds,\n      }\n\n      // Add optional config fields\n      if (config.customInstructions) requestBody.custom_instructions = config.customInstructions\n      if (config.focusArea) requestBody.focus_area = config.focusArea\n      if (config.reportType) requestBody.report_type = config.reportType\n      if (config.tone) requestBody.tone = config.tone\n      if (config.slideCount) requestBody.slide_count = config.slideCount\n      if (config.style) requestBody.style = config.style\n      // Infographic-specific options\n      if (config.imageCount) requestBody.image_count = config.imageCount\n      if (config.imageStyle) requestBody.image_style = config.imageStyle\n\n      const response = await fetch(`/api/notebooks/${notebookId}/studio`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n        body: JSON.stringify(requestBody),\n      })\n      const result = await response.json()\n\n      if (result.error) {\n        console.error('Generation error:', result.error)\n      } else if (result.data) {\n        // Handle each type's response\n        switch (config.type) {\n          case 'data_table':\n            setDataTableData(result.data)\n            setActiveStudyType('datatable')\n            setStudySheetOpen(true)\n            break\n          case 'report':\n            setReportData(result.data)\n            setActiveStudyType('report')\n            setStudySheetOpen(true)\n            break\n          case 'slide_deck':\n            setSlideDeckData(result.data)\n            setActiveStudyType('slides')\n            setStudySheetOpen(true)\n            break\n          case 'infographic':\n            setInfographicData(result.data)\n            setActiveStudyType('infographic')\n            setStudySheetOpen(true)\n            break\n        }\n        fetchCreativeOutputs()\n      }\n    } catch (error) {\n      console.error('Creative output generation failed:', error)\n    } finally {\n      if (stateKey2) setGeneratingState(stateKey2, false)\n    }\n  }\n\n  // Creative output generation handlers (legacy - kept for compatibility)\n  const handleGenerateDataTable = async () => {\n    if (selectedSources.size === 0) {\n\n      return\n    }\n    setGeneratingState('dataTable', true)\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n      const response = await fetch(`/api/notebooks/${notebookId}/studio`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n        body: JSON.stringify({\n          type: 'data_table',\n          source_ids: Array.from(selectedSources),\n        }),\n      })\n      const result = await response.json()\n      if (result.error) {\n        \n      } else if (result.data) {\n        setDataTableData(result.data)\n        setActiveStudyType('datatable' as typeof activeStudyType)\n        setStudySheetOpen(true)\n        fetchCreativeOutputs()\n      }\n    } catch {\n      // Error handled silently\n    } finally {\n      setGeneratingState('dataTable', false)\n    }\n  }\n\n  const handleGenerateReport = async (reportType: string) => {\n    if (selectedSources.size === 0) {\n\n      return\n    }\n    setGeneratingState('report', true)\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n      const response = await fetch(`/api/notebooks/${notebookId}/studio`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n        body: JSON.stringify({\n          type: 'report',\n          source_ids: Array.from(selectedSources),\n          report_type: reportType,\n        }),\n      })\n      const result = await response.json()\n      if (result.error) {\n        \n      } else if (result.data) {\n        setReportData(result.data)\n        setActiveStudyType('report' as typeof activeStudyType)\n        setStudySheetOpen(true)\n        fetchCreativeOutputs()\n      }\n    } catch {\n      // Error handled silently\n    } finally {\n      setGeneratingState('report', false)\n    }\n  }\n\n  const handleGenerateSlideDeck = async () => {\n    if (selectedSources.size === 0) {\n\n      return\n    }\n    setGeneratingState('slideDeck', true)\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n      const response = await fetch(`/api/notebooks/${notebookId}/studio`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n        body: JSON.stringify({\n          type: 'slide_deck',\n          source_ids: Array.from(selectedSources),\n        }),\n      })\n      const result = await response.json()\n      if (result.error) {\n        \n      } else if (result.data) {\n        setSlideDeckData(result.data)\n        setActiveStudyType('slides' as typeof activeStudyType)\n        setStudySheetOpen(true)\n        fetchCreativeOutputs()\n      }\n    } catch {\n      // Error handled silently\n    } finally {\n      setGeneratingState('slideDeck', false)\n    }\n  }\n\n  const handleGenerateInfographic = async () => {\n    if (selectedSources.size === 0) {\n\n      return\n    }\n    setGeneratingState('infographic', true)\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n      const response = await fetch(`/api/notebooks/${notebookId}/studio`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n        body: JSON.stringify({\n          type: 'infographic',\n          source_ids: Array.from(selectedSources),\n        }),\n      })\n      const result = await response.json()\n      if (result.error) {\n        \n      } else if (result.data) {\n        setInfographicData(result.data)\n        setActiveStudyType('infographic' as typeof activeStudyType)\n        setStudySheetOpen(true)\n        fetchCreativeOutputs()\n      }\n    } catch {\n      // Error handled silently\n    } finally {\n      setGeneratingState('infographic', false)\n    }\n  }\n\n  // Sheet resize handlers\n  const handleResizeStart = (e: React.MouseEvent) => {\n    e.preventDefault()\n    setIsResizing(true)\n\n    const startX = e.clientX\n    const startWidth = sheetWidth\n\n    const handleMouseMove = (e: MouseEvent) => {\n      const diff = startX - e.clientX\n      const newWidth = Math.min(Math.max(startWidth + diff, 400), window.innerWidth - 50)\n      setSheetWidth(newWidth)\n    }\n\n    const handleMouseUp = () => {\n      setIsResizing(false)\n      document.removeEventListener('mousemove', handleMouseMove)\n      document.removeEventListener('mouseup', handleMouseUp)\n    }\n\n    document.addEventListener('mousemove', handleMouseMove)\n    document.addEventListener('mouseup', handleMouseUp)\n  }\n\n  if (loading) {\n    return (\n      <div className=\"h-screen flex items-center justify-center bg-[var(--bg-primary)]\">\n        <Loader2 className=\"h-8 w-8 animate-spin text-[var(--accent-primary)]\" />\n      </div>\n    )\n  }\n\n  return (\n    <div className=\"h-screen flex flex-col bg-[var(--bg-primary)]\">\n      {/* Header */}\n      <motion.header\n        initial={{ opacity: 0, y: -10 }}\n        animate={{ opacity: 1, y: 0 }}\n        className=\"h-14 bg-[var(--bg-secondary)] border-b border-[rgba(255,255,255,0.1)] px-4 flex items-center gap-4 shrink-0 sticky top-0 z-50\"\n      >\n        <Button\n          variant=\"ghost\"\n          size=\"icon\"\n          onClick={() => router.push('/')}\n          className=\"h-9 w-9 rounded-lg text-[var(--text-secondary)] hover:text-[var(--text-primary)] hover:bg-[var(--bg-tertiary)]\"\n        >\n          <ArrowLeft className=\"h-4 w-4\" />\n        </Button>\n\n        <div className=\"flex items-center gap-3\">\n          <div className=\"w-10 h-10 rounded-xl bg-[var(--bg-tertiary)] flex items-center justify-center text-xl\">\n            {notebook?.emoji}\n          </div>\n          <div>\n            <h1 className=\"font-semibold text-[var(--text-primary)]\">{notebook?.name}</h1>\n            {notebook?.description && (\n              <p className=\"text-xs text-[var(--text-tertiary)] line-clamp-1 max-w-[300px]\">\n                {notebook.description}\n              </p>\n            )}\n          </div>\n        </div>\n\n        <div className=\"flex items-center gap-2 ml-auto\">\n          <Badge className=\"bg-[var(--bg-tertiary)] text-[var(--text-secondary)] border-0 text-xs\">\n            {sources.length} source{sources.length !== 1 ? 's' : ''}\n          </Badge>\n          {selectedSources.size > 0 && (\n            <Badge className=\"bg-[var(--accent-primary)]/20 text-[var(--accent-primary)] border-0 text-xs\">\n              {selectedSources.size} selected\n            </Badge>\n          )}\n          {notebookSettings?.persona?.enabled && (\n            <Badge className=\"bg-purple-500/20 text-purple-400 border-0 text-xs\">\n              {notebookSettings.persona.name || 'Custom Persona'}\n            </Badge>\n          )}\n          <Button\n            variant=\"ghost\"\n            size=\"sm\"\n            onClick={() => setSettingsOpen(true)}\n            className=\"h-9 px-3 rounded-lg text-[var(--text-secondary)] hover:text-[var(--text-primary)] hover:bg-[var(--bg-tertiary)] gap-2\"\n          >\n            <Settings className=\"h-4 w-4\" />\n            <span className=\"hidden sm:inline\">Settings</span>\n          </Button>\n          <Button\n            variant=\"ghost\"\n            size=\"sm\"\n            onClick={() => router.push(`/notebooks/${notebookId}/history`)}\n            className=\"h-9 px-3 rounded-lg text-[var(--text-secondary)] hover:text-[var(--text-primary)] hover:bg-[var(--bg-tertiary)] gap-2\"\n          >\n            <History className=\"h-4 w-4\" />\n            <span className=\"hidden sm:inline\">History</span>\n          </Button>\n        </div>\n      </motion.header>\n\n      {/* Three Panel Layout */}\n      <div className=\"flex-1 overflow-hidden\">\n        <ThreePanelLayout\n          leftPanelTitle=\"Sources\"\n          rightPanelTitle=\"Studio\"\n          leftPanel={\n            <SourcesPanel\n              sources={sources}\n              selectedSources={selectedSources}\n              onToggleSource={toggleSource}\n              onSelectAll={selectAllSources}\n              onAddSource={handleAddSource}\n              onDeleteSource={handleDeleteSource}\n              onViewSource={setViewingSource}\n              uploading={uploading}\n            />\n          }\n          centerPanel={\n            <ChatPanel\n              messages={messages}\n              message={message}\n              onMessageChange={setMessage}\n              onSendMessage={sendMessage}\n              sending={sending}\n              selectedSourcesCount={selectedSources.size}\n              totalSourcesCount={sources.length}\n              onSaveResponse={saveResponseAsNote}\n              sessions={chatSessions}\n              currentSessionId={sessionId}\n              onLoadSession={loadChatSession}\n              onNewChat={startNewChat}\n              onDeleteSession={deleteChatSession}\n              onRenameSession={renameChatSession}\n              loadingSessions={loadingSessions}\n              notebookId={notebookId}\n            />\n          }\n          rightPanel={\n            <StudioPanel\n              notebookId={notebookId}\n              selectedSourcesCount={selectedSources.size}\n              selectedSourceIds={Array.from(selectedSources)}\n              sources={sources.map(s => ({ id: s.id, name: s.name }))}\n              audioFormat={audioFormat}\n              onAudioFormatChange={setAudioFormat}\n              audioInstructions={audioInstructions}\n              onAudioInstructionsChange={setAudioInstructions}\n              onGenerateAudio={generateAudio}\n              generatingAudio={generatingAudio}\n              videoStyle={videoStyle}\n              onVideoStyleChange={setVideoStyle}\n              onGenerateVideo={generateVideo}\n              generatingVideo={generatingVideo}\n              researchQuery={researchQuery}\n              onResearchQueryChange={setResearchQuery}\n              researchMode={researchMode}\n              onResearchModeChange={setResearchMode}\n              onRunResearch={runResearch}\n              researching={researching}\n              onGenerateStudyMaterial={handleGenerateStudyMaterial}\n              generatingFlashcards={generating.flashcards}\n              generatingQuiz={generating.quiz}\n              generatingStudyGuide={generating.studyGuide}\n              generatingFaq={generating.faq}\n              generatingMindMap={generating.mindMap}\n              onGenerateCreativeOutput={handleGenerateCreativeOutput}\n              generatingDataTable={generating.dataTable}\n              generatingReport={generating.report}\n              generatingSlideDeck={generating.slideDeck}\n              generatingInfographic={generating.infographic}\n              creativeOutputs={creativeOutputsMeta}\n              onOpenCreativeOutput={(type) => {\n                const typeMap: Record<string, typeof activeStudyType> = {\n                  data_table: 'datatable',\n                  report: 'report',\n                  slide_deck: 'slides',\n                  infographic: 'infographic',\n                }\n                setActiveStudyType(typeMap[type] || null)\n                setStudySheetOpen(true)\n              }}\n              studyMaterials={studyMaterialsMeta}\n              onOpenStudyMaterial={(type) => {\n                const typeMap: Record<string, typeof activeStudyType> = {\n                  flashcards: 'flashcards',\n                  quiz: 'quiz',\n                  study_guide: 'guide',\n                  faq: 'faq',\n                  mind_map: 'mindmap',\n                }\n                setActiveStudyType(typeMap[type] || null)\n                setStudySheetOpen(true)\n              }}\n              notesCount={notes.length}\n              onAddNote={() => setAddNoteOpen(true)}\n              hasGeneratedAudio={!!activeGeneratedAudio}\n              hasGeneratedVideo={!!activeGeneratedVideo}\n              hasGeneratedResearch={!!activeGeneratedResearch}\n              onOpenAudio={() => { setActiveStudyType('audio'); setStudySheetOpen(true) }}\n              onOpenVideo={() => { setActiveStudyType('video'); setStudySheetOpen(true) }}\n              onOpenResearch={() => { setActiveStudyType('research'); setStudySheetOpen(true) }}\n            />\n          }\n        />\n      </div>\n\n      {/* Source Preview Dialog */}\n      <Dialog open={!!viewingSource} onOpenChange={(open) => !open && setViewingSource(null)}>\n        <DialogContent className=\"sm:max-w-lg bg-[var(--bg-secondary)] border-[rgba(255,255,255,0.1)]\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-3 text-[var(--text-primary)]\">\n              <div className=\"w-10 h-10 rounded-lg bg-[var(--bg-tertiary)] flex items-center justify-center\">\n                <FileText className=\"h-5 w-5\" />\n              </div>\n              {viewingSource?.name}\n            </DialogTitle>\n            <DialogDescription className=\"text-[var(--text-secondary)]\">\n              {viewingSource?.type} source\n            </DialogDescription>\n          </DialogHeader>\n\n          {viewingSource?.metadata && (() => {\n            const meta = viewingSource.metadata as Record<string, unknown>\n            if (viewingSource.type === 'text' && meta.content) {\n              return (\n                <div className=\"p-4 rounded-xl bg-[var(--bg-tertiary)] text-sm max-h-64 overflow-y-auto\">\n                  <p className=\"whitespace-pre-wrap text-[var(--text-secondary)]\">\n                    {String(meta.content)}\n                  </p>\n                </div>\n              )\n            }\n            if ((viewingSource.type === 'youtube' || viewingSource.type === 'url') && meta.url) {\n              return (\n                <div className=\"p-4 rounded-xl bg-[var(--bg-tertiary)] text-sm max-h-64 overflow-y-auto\">\n                  <a\n                    href={String(meta.url)}\n                    target=\"_blank\"\n                    rel=\"noopener noreferrer\"\n                    className=\"text-[var(--accent-primary)] hover:underline break-all\"\n                  >\n                    {String(meta.url)}\n                  </a>\n                </div>\n              )\n            }\n            return null\n          })()}\n        </DialogContent>\n      </Dialog>\n\n      {/* Add Note Dialog */}\n      <Dialog open={addNoteOpen} onOpenChange={setAddNoteOpen}>\n        <DialogContent className=\"sm:max-w-md bg-[var(--bg-secondary)] border-[rgba(255,255,255,0.1)]\">\n          <DialogHeader>\n            <DialogTitle className=\"text-[var(--text-primary)]\">Create Note</DialogTitle>\n            <DialogDescription className=\"text-[var(--text-secondary)]\">\n              Write a new note to save your thoughts.\n            </DialogDescription>\n          </DialogHeader>\n          <div className=\"space-y-4 mt-2\">\n            <div className=\"space-y-2\">\n              <label className=\"text-sm font-medium text-[var(--text-primary)]\">Title</label>\n              <Input\n                placeholder=\"Note title...\"\n                value={noteTitle}\n                onChange={(e) => setNoteTitle(e.target.value)}\n                className=\"h-10 bg-[var(--bg-tertiary)] border-[rgba(255,255,255,0.1)] text-[var(--text-primary)] placeholder:text-[var(--text-tertiary)] focus:border-[var(--accent-primary)] rounded-lg\"\n              />\n            </div>\n            <div className=\"space-y-2\">\n              <label className=\"text-sm font-medium text-[var(--text-primary)]\">Content</label>\n              <Textarea\n                placeholder=\"Write your note...\"\n                value={noteContent}\n                onChange={(e) => setNoteContent(e.target.value)}\n                rows={6}\n                className=\"bg-[var(--bg-tertiary)] border-[rgba(255,255,255,0.1)] text-[var(--text-primary)] placeholder:text-[var(--text-tertiary)] focus:border-[var(--accent-primary)] rounded-lg resize-none\"\n              />\n            </div>\n          </div>\n          <DialogFooter className=\"mt-4\">\n            <Button\n              onClick={createNote}\n              disabled={savingNote}\n              className=\"rounded-lg bg-[var(--accent-primary)] hover:bg-[var(--accent-primary)]/90 text-white\"\n            >\n              {savingNote && <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />}\n              Create Note\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      {/* Study Materials Sheet */}\n      <Sheet open={studySheetOpen} onOpenChange={(open) => {\n        setStudySheetOpen(open)\n        if (!open) setSheetWidth(576)\n      }}>\n        <SheetContent\n          className=\"overflow-y-auto bg-[var(--bg-secondary)] border-[rgba(255,255,255,0.1)] p-0\"\n          style={{ width: sheetWidth, maxWidth: '100vw' }}\n        >\n          {/* Resize Handle */}\n          <div\n            className={`absolute left-0 top-0 bottom-0 w-1.5 cursor-ew-resize hover:bg-[var(--accent-primary)]/50 transition-colors z-50 ${isResizing ? 'bg-[var(--accent-primary)]/50' : ''}`}\n            onMouseDown={handleResizeStart}\n          />\n          <div className=\"p-6\">\n          <SheetHeader>\n            <div className=\"flex items-center gap-2 pr-8\">\n              <SheetTitle className=\"flex items-center gap-2 text-[var(--text-primary)] flex-1\">\n                {activeStudyType === 'flashcards' && <><BookOpen className=\"h-5 w-5 text-blue-500\" /> Flashcards</>}\n                {activeStudyType === 'quiz' && <><ListChecks className=\"h-5 w-5 text-purple-500\" /> Quiz</>}\n                {activeStudyType === 'guide' && <><FileText className=\"h-5 w-5 text-orange-500\" /> Study Guide</>}\n                {activeStudyType === 'faq' && <><HelpCircle className=\"h-5 w-5 text-teal-500\" /> FAQ</>}\n                {activeStudyType === 'mindmap' && <><Share2 className=\"h-5 w-5 text-cyan-500\" /> Mind Map</>}\n                {activeStudyType === 'datatable' && <><Table className=\"h-5 w-5 text-emerald-500\" /> Data Table</>}\n                {activeStudyType === 'report' && <><FileSpreadsheet className=\"h-5 w-5 text-blue-500\" /> Report</>}\n                {activeStudyType === 'slides' && <><Presentation className=\"h-5 w-5 text-violet-500\" /> Slide Deck</>}\n                {activeStudyType === 'infographic' && <><ImageIcon className=\"h-5 w-5 text-rose-500\" /> Infographic</>}\n                {activeStudyType === 'audio' && <><Mic className=\"h-5 w-5 text-orange-500\" /> Audio Overview</>}\n                {activeStudyType === 'video' && <><Video className=\"h-5 w-5 text-purple-500\" /> Video Overview</>}\n                {activeStudyType === 'research' && <><Search className=\"h-5 w-5 text-blue-500\" /> Research Report</>}\n              </SheetTitle>\n              <Button\n                variant=\"ghost\"\n                size=\"icon\"\n                className=\"h-8 w-8 shrink-0\"\n                onClick={() => {\n                  if (sheetWidth < 800) {\n                    setSheetWidth(900) // Wide\n                  } else if (sheetWidth < window.innerWidth - 100) {\n                    setSheetWidth(window.innerWidth - 50) // Full\n                  } else {\n                    setSheetWidth(576) // Normal\n                  }\n                }}\n                title={sheetWidth >= window.innerWidth - 100 ? 'Minimize' : 'Expand'}\n              >\n                {sheetWidth >= window.innerWidth - 100 ? (\n                  <Minimize2 className=\"h-4 w-4\" />\n                ) : (\n                  <Maximize2 className=\"h-4 w-4\" />\n                )}\n              </Button>\n            </div>\n            <SheetDescription className=\"text-[var(--text-secondary)]\">\n              {activeStudyType === 'flashcards' && `${flashcards.length} cards generated from your sources`}\n              {activeStudyType === 'quiz' && `${quizQuestions.length} questions to test your knowledge`}\n              {activeStudyType === 'guide' && 'Comprehensive study guide from your sources'}\n              {activeStudyType === 'faq' && `${faqItems.length} frequently asked questions`}\n              {activeStudyType === 'mindmap' && 'Interactive visualization of key concepts'}\n              {activeStudyType === 'datatable' && 'Structured data extracted from your sources'}\n              {activeStudyType === 'report' && 'Professional document from your sources'}\n              {activeStudyType === 'slides' && 'Presentation slides from your sources'}\n              {activeStudyType === 'infographic' && 'AI-generated images visualizing key concepts'}\n              {activeStudyType === 'audio' && 'Podcast-style audio discussion'}\n              {activeStudyType === 'video' && 'Visual explainer video'}\n              {activeStudyType === 'research' && 'Deep web research findings'}\n            </SheetDescription>\n          </SheetHeader>\n\n          <div className=\"mt-6 relative\">\n            {/* Flashcards View */}\n            {activeStudyType === 'flashcards' && (\n              <FlashcardViewer\n                flashcards={flashcards}\n                onClose={() => setStudySheetOpen(false)}\n              />\n            )}\n\n            {/* Quiz View */}\n            {activeStudyType === 'quiz' && (\n              <QuizViewer\n                questions={quizQuestions}\n                onClose={() => setStudySheetOpen(false)}\n              />\n            )}\n\n            {/* Study Guide View */}\n            {activeStudyType === 'guide' && studyGuide && (\n              <StudyGuideViewer\n                guide={studyGuide}\n                onClose={() => setStudySheetOpen(false)}\n              />\n            )}\n\n            {/* FAQ View */}\n            {activeStudyType === 'faq' && (\n              <FAQViewer\n                items={faqItems}\n                onClose={() => setStudySheetOpen(false)}\n              />\n            )}\n\n            {/* Mind Map View */}\n            {activeStudyType === 'mindmap' && mindMap && (\n              <MindMapViewer\n                title={mindMap.title}\n                nodes={mindMap.nodes}\n                onClose={() => setStudySheetOpen(false)}\n              />\n            )}\n\n            {/* Audio View */}\n            {activeStudyType === 'audio' && (\n              <AudioPlayer\n                audio={activeGeneratedAudio ?? null}\n                isGenerating={generatingAudio}\n                onClose={() => setStudySheetOpen(false)}\n              />\n            )}\n\n            {/* Video View */}\n            {activeStudyType === 'video' && (\n              <VideoPlayer\n                video={activeGeneratedVideo ?? null}\n                isGenerating={generatingVideo}\n                onClose={() => setStudySheetOpen(false)}\n              />\n            )}\n\n            {/* Research View */}\n            {activeStudyType === 'research' && (\n              <ResearchReport\n                research={activeGeneratedResearch ?? null}\n                isResearching={researching}\n                onClose={() => setStudySheetOpen(false)}\n              />\n            )}\n\n            {/* Data Table View */}\n            {activeStudyType === 'datatable' && dataTableData && (\n              <div className=\"space-y-4\">\n                <div className=\"p-4 rounded-xl bg-[var(--bg-tertiary)]\">\n                  <h3 className=\"text-lg font-semibold text-[var(--text-primary)] mb-2\">{dataTableData.title}</h3>\n                  <p className=\"text-sm text-[var(--text-secondary)] mb-4\">{dataTableData.description}</p>\n                  <div className=\"overflow-x-auto\">\n                    <table className=\"w-full text-sm\">\n                      <thead>\n                        <tr className=\"border-b border-[rgba(255,255,255,0.1)]\">\n                          {dataTableData.columns.map((col) => (\n                            <th key={col.key} className=\"text-left p-3 font-medium text-[var(--text-primary)]\">\n                              {col.header}\n                            </th>\n                          ))}\n                        </tr>\n                      </thead>\n                      <tbody>\n                        {dataTableData.rows.map((row, idx) => (\n                          <tr key={idx} className=\"border-b border-[rgba(255,255,255,0.05)] hover:bg-[var(--bg-secondary)]\">\n                            {dataTableData.columns.map((col) => (\n                              <td key={col.key} className=\"p-3 text-[var(--text-secondary)]\">\n                                {String(row[col.key] ?? '')}\n                              </td>\n                            ))}\n                          </tr>\n                        ))}\n                      </tbody>\n                    </table>\n                  </div>\n                </div>\n              </div>\n            )}\n\n            {/* Report View */}\n            {activeStudyType === 'report' && reportData && (\n              <div className=\"space-y-6\">\n                <div className=\"p-4 rounded-xl bg-[var(--bg-tertiary)]\">\n                  <h2 className=\"text-xl font-bold text-[var(--text-primary)] mb-4\">{reportData.title}</h2>\n                  <div className=\"p-4 rounded-lg bg-[var(--accent-primary)]/10 border border-[var(--accent-primary)]/20 mb-6\">\n                    <h3 className=\"text-sm font-semibold text-[var(--accent-primary)] mb-2\">Executive Summary</h3>\n                    <p className=\"text-sm text-[var(--text-secondary)]\">{reportData.executive_summary}</p>\n                  </div>\n                  {reportData.sections.map((section, idx) => (\n                    <div key={idx} className=\"mb-6\">\n                      <h3 className=\"text-lg font-semibold text-[var(--text-primary)] mb-2\">{section.heading}</h3>\n                      <p className=\"text-sm text-[var(--text-secondary)] whitespace-pre-wrap\">{section.content}</p>\n                    </div>\n                  ))}\n                  <div className=\"mt-6 p-4 rounded-lg bg-[var(--bg-secondary)]\">\n                    <h3 className=\"text-sm font-semibold text-[var(--text-primary)] mb-2\">Key Takeaways</h3>\n                    <ul className=\"list-disc list-inside space-y-1\">\n                      {reportData.key_takeaways.map((takeaway, idx) => (\n                        <li key={idx} className=\"text-sm text-[var(--text-secondary)]\">{takeaway}</li>\n                      ))}\n                    </ul>\n                  </div>\n                </div>\n              </div>\n            )}\n\n            {/* Slide Deck View */}\n            {activeStudyType === 'slides' && slideDeckData && (\n              <div className=\"space-y-4\">\n                <div className=\"text-center mb-6\">\n                  <h2 className=\"text-xl font-bold text-[var(--text-primary)]\">{slideDeckData.title}</h2>\n                  {slideDeckData.subtitle && (\n                    <p className=\"text-sm text-[var(--text-secondary)] mt-1\">{slideDeckData.subtitle}</p>\n                  )}\n                  <Badge className=\"mt-2 bg-[var(--bg-tertiary)] text-[var(--text-secondary)]\">\n                    {slideDeckData.slides.length} slides\n                  </Badge>\n                </div>\n                <div className=\"space-y-4\">\n                  {slideDeckData.slides.map((slide) => (\n                    <div key={slide.slide_number} className=\"p-4 rounded-xl bg-[var(--bg-tertiary)] border border-[rgba(255,255,255,0.1)]\">\n                      <div className=\"flex items-center gap-2 mb-3\">\n                        <Badge className=\"bg-[var(--accent-primary)]/20 text-[var(--accent-primary)]\">\n                          {slide.slide_number}\n                        </Badge>\n                        <span className=\"text-xs text-[var(--text-tertiary)] uppercase\">{slide.content_type}</span>\n                      </div>\n                      <h3 className=\"text-lg font-semibold text-[var(--text-primary)] mb-2\">{slide.title}</h3>\n                      <p className=\"text-sm text-[var(--text-secondary)] mb-3\">{slide.main_content}</p>\n                      {slide.bullet_points && slide.bullet_points.length > 0 && (\n                        <ul className=\"list-disc list-inside space-y-1 mb-3\">\n                          {slide.bullet_points.map((point, idx) => (\n                            <li key={idx} className=\"text-sm text-[var(--text-secondary)]\">{point}</li>\n                          ))}\n                        </ul>\n                      )}\n                      {slide.speaker_notes && (\n                        <div className=\"mt-3 p-3 rounded-lg bg-[var(--bg-secondary)] text-xs text-[var(--text-tertiary)]\">\n                          <span className=\"font-medium\">Speaker notes:</span> {slide.speaker_notes}\n                        </div>\n                      )}\n                    </div>\n                  ))}\n                </div>\n              </div>\n            )}\n\n            {/* Infographic View */}\n            {activeStudyType === 'infographic' && infographicData && (\n              // Check if it's the new image-based format\n              infographicData.images && infographicData.images.length > 0 ? (\n                <InfographicViewer\n                  data={{\n                    images: infographicData.images,\n                    concepts: infographicData.concepts || []\n                  }}\n                  onClose={() => setStudySheetOpen(false)}\n                />\n              ) : infographicData.color_scheme && infographicData.sections ? (\n                // Legacy format (backward compatibility)\n                <div className=\"space-y-6\">\n                  {/* Header Section */}\n                  <div\n                    className=\"p-8 rounded-2xl text-center\"\n                    style={{\n                      background: `linear-gradient(135deg, ${infographicData.color_scheme[0]}20 0%, ${infographicData.color_scheme[1]}20 100%)`,\n                      borderLeft: `4px solid ${infographicData.color_scheme[0]}`\n                    }}\n                  >\n                    <h2 className=\"text-2xl font-bold text-[var(--text-primary)]\">{infographicData.title}</h2>\n                    {infographicData.subtitle && (\n                      <p className=\"text-base text-[var(--text-secondary)] mt-2\">{infographicData.subtitle}</p>\n                    )}\n                  </div>\n\n                  {/* Render each section based on type */}\n                  {infographicData.sections.map((section, idx) => {\n                    const sectionColor = infographicData.color_scheme![idx % infographicData.color_scheme!.length]\n                    const content = section.content as Record<string, unknown>\n\n                    // Stats Section\n                    if (section.section_type === 'stats' && content.items) {\n                      const items = content.items as Array<{ value: string; label: string; icon?: string }>\n                      return (\n                        <div key={idx} className=\"p-6 rounded-xl bg-[var(--bg-tertiary)]\">\n                          {section.title && <h3 className=\"text-lg font-semibold text-[var(--text-primary)] mb-4\">{section.title}</h3>}\n                          <div className=\"grid grid-cols-3 gap-4\">\n                            {items.map((item, i) => (\n                              <div key={i} className=\"text-center p-4 rounded-lg\" style={{ backgroundColor: `${sectionColor}15` }}>\n                                <div className=\"text-2xl font-bold\" style={{ color: sectionColor }}>{item.value}</div>\n                                <div className=\"text-sm text-[var(--text-secondary)] mt-1\">{item.label}</div>\n                              </div>\n                            ))}\n                          </div>\n                        </div>\n                      )\n                    }\n\n                    // Timeline Section\n                    if (section.section_type === 'timeline' && content.events) {\n                      const events = content.events as Array<{ date: string; title: string; description?: string }>\n                      return (\n                        <div key={idx} className=\"p-6 rounded-xl bg-[var(--bg-tertiary)]\">\n                          {section.title && <h3 className=\"text-lg font-semibold text-[var(--text-primary)] mb-4\">{section.title}</h3>}\n                          <div className=\"space-y-4\">\n                            {events.map((event, i) => (\n                              <div key={i} className=\"flex gap-4\">\n                                <div className=\"flex flex-col items-center\">\n                                  <div className=\"w-3 h-3 rounded-full\" style={{ backgroundColor: sectionColor }} />\n                                  {i < events.length - 1 && <div className=\"w-0.5 flex-1 mt-1\" style={{ backgroundColor: `${sectionColor}40` }} />}\n                                </div>\n                                <div className=\"flex-1 pb-4\">\n                                  <div className=\"font-semibold\" style={{ color: sectionColor }}>{event.date}</div>\n                                  <div className=\"font-medium text-[var(--text-primary)]\">{event.title}</div>\n                                  {event.description && <div className=\"text-sm text-[var(--text-secondary)] mt-1\">{event.description}</div>}\n                                </div>\n                              </div>\n                            ))}\n                          </div>\n                        </div>\n                      )\n                    }\n\n                    // Process/Steps Section\n                    if (section.section_type === 'process' && content.steps) {\n                      const steps = content.steps as Array<{ step: number; title: string; description?: string }>\n                      return (\n                        <div key={idx} className=\"p-6 rounded-xl bg-[var(--bg-tertiary)]\">\n                          {section.title && <h3 className=\"text-lg font-semibold text-[var(--text-primary)] mb-4\">{section.title}</h3>}\n                          <div className=\"space-y-3\">\n                            {steps.map((step, i) => (\n                              <div key={i} className=\"flex gap-4 items-start\">\n                                <div\n                                  className=\"w-8 h-8 rounded-full flex items-center justify-center text-white font-bold text-sm shrink-0\"\n                                  style={{ backgroundColor: sectionColor }}\n                                >\n                                  {step.step}\n                                </div>\n                                <div>\n                                  <div className=\"font-medium text-[var(--text-primary)]\">{step.title}</div>\n                                  {step.description && <div className=\"text-sm text-[var(--text-secondary)] mt-1\">{step.description}</div>}\n                                </div>\n                              </div>\n                            ))}\n                          </div>\n                        </div>\n                      )\n                    }\n\n                    // Comparison Section\n                    if (section.section_type === 'comparison' && content.left && content.right) {\n                      const left = content.left as { label: string; points: string[] }\n                      const right = content.right as { label: string; points: string[] }\n                      return (\n                        <div key={idx} className=\"p-6 rounded-xl bg-[var(--bg-tertiary)]\">\n                          {section.title && <h3 className=\"text-lg font-semibold text-[var(--text-primary)] mb-4\">{section.title}</h3>}\n                          <div className=\"grid grid-cols-2 gap-4\">\n                            <div className=\"p-4 rounded-lg\" style={{ backgroundColor: `${infographicData.color_scheme![0]}15` }}>\n                              <div className=\"font-semibold mb-3\" style={{ color: infographicData.color_scheme![0] }}>{left.label}</div>\n                              <ul className=\"space-y-2\">\n                                {left.points.map((point, i) => (\n                                  <li key={i} className=\"text-sm text-[var(--text-secondary)] flex items-start gap-2\">\n                                    <span style={{ color: infographicData.color_scheme![0] }}>•</span>\n                                    {point}\n                                  </li>\n                                ))}\n                              </ul>\n                            </div>\n                            <div className=\"p-4 rounded-lg\" style={{ backgroundColor: `${infographicData.color_scheme![1]}15` }}>\n                              <div className=\"font-semibold mb-3\" style={{ color: infographicData.color_scheme![1] }}>{right.label}</div>\n                              <ul className=\"space-y-2\">\n                                {right.points.map((point, i) => (\n                                  <li key={i} className=\"text-sm text-[var(--text-secondary)] flex items-start gap-2\">\n                                    <span style={{ color: infographicData.color_scheme![1] }}>•</span>\n                                    {point}\n                                  </li>\n                                ))}\n                              </ul>\n                            </div>\n                          </div>\n                        </div>\n                      )\n                    }\n\n                    // List Section\n                    if (section.section_type === 'list' && content.items) {\n                      const items = content.items as string[]\n                      return (\n                        <div key={idx} className=\"p-6 rounded-xl bg-[var(--bg-tertiary)]\">\n                          {section.title && <h3 className=\"text-lg font-semibold text-[var(--text-primary)] mb-4\">{section.title}</h3>}\n                          <ul className=\"space-y-3\">\n                            {items.map((item, i) => (\n                              <li key={i} className=\"flex items-start gap-3\">\n                                <div\n                                  className=\"w-2 h-2 rounded-full mt-2 shrink-0\"\n                                  style={{ backgroundColor: sectionColor }}\n                                />\n                                <span className=\"text-[var(--text-secondary)]\">{item}</span>\n                              </li>\n                            ))}\n                          </ul>\n                        </div>\n                      )\n                    }\n\n                    // Quote Section\n                    if (section.section_type === 'quote') {\n                      const quote = content.quote as string\n                      const author = content.author as string | undefined\n                      return (\n                        <div\n                          key={idx}\n                          className=\"p-6 rounded-xl\"\n                          style={{\n                            backgroundColor: `${sectionColor}10`,\n                            borderLeft: `4px solid ${sectionColor}`\n                          }}\n                        >\n                          {section.title && <h3 className=\"text-lg font-semibold text-[var(--text-primary)] mb-3\">{section.title}</h3>}\n                          <blockquote className=\"text-lg italic text-[var(--text-primary)]\">\"{quote}\"</blockquote>\n                          {author && <div className=\"mt-2 text-sm text-[var(--text-secondary)]\">— {author}</div>}\n                        </div>\n                      )\n                    }\n\n                    // Default/Header/Footer - simple display\n                    return (\n                      <div key={idx} className=\"p-6 rounded-xl bg-[var(--bg-tertiary)]\">\n                        {section.title && <h3 className=\"text-lg font-semibold text-[var(--text-primary)] mb-2\">{section.title}</h3>}\n                        {typeof content.subtitle === 'string' && <p className=\"text-[var(--text-secondary)]\">{content.subtitle}</p>}\n                        {typeof content.text === 'string' && <p className=\"text-sm text-[var(--text-tertiary)]\">{content.text}</p>}\n                      </div>\n                    )\n                  })}\n\n                  {/* Style suggestion footer */}\n                  <p className=\"text-xs text-[var(--text-tertiary)] text-center italic pt-4 border-t border-[rgba(255,255,255,0.1)]\">\n                    Design suggestion: {infographicData.style_suggestion}\n                  </p>\n                </div>\n              ) : (\n                <div className=\"text-center py-12 text-[var(--text-tertiary)]\">\n                  <ImageIcon className=\"h-12 w-12 mx-auto mb-4 opacity-50\" />\n                  <p>No infographic data available</p>\n                </div>\n              )\n            )}\n          </div>\n          </div>\n        </SheetContent>\n      </Sheet>\n\n      {/* Hidden file input */}\n      <input\n        ref={fileInputRef}\n        type=\"file\"\n        accept=\".pdf,.docx,.txt,.md\"\n        className=\"hidden\"\n      />\n\n      {/* Notebook Settings Dialog */}\n      <NotebookSettingsDialog\n        open={settingsOpen}\n        onOpenChange={setSettingsOpen}\n        settings={notebookSettings}\n        onSave={saveNotebookSettings}\n        notebookName={notebook?.name || 'Notebook'}\n      />\n    </div>\n  )\n}\n","structuredPatch":[{"oldStart":142,"oldLines":6,"newStart":142,"newLines":9,"lines":["   const [researchMode, setResearchMode] = useState('fast')","   const [researching, setResearching] = useState(false)"," ","+  // Export state","+  const [exportingNotebook, setExportingNotebook] = useState(false)","+","   // Consolidated generating states - single object to reduce re-renders","   const [generating, setGenerating] = useState({","     flashcards: false,"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"06b756de-8215-476b-9c91-7c9c27dc2e51"}
{"parentUuid":"72420fa8-68f9-440c-ac6f-45c6f3af5b5d","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","message":{"model":"claude-opus-4-5-20251101","id":"msg_01TGzbW4LJz4FSdWHnzXR3Rf","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Now I need to add the export handler function. Let me add it after the research generation function.","signature":"EowCCkYICxgCKkBMf0Vcs30TZ+1CSbY1TT0KYVA79asPnKEqUqJ7tz1UozCg0f10BUtgT3a3un8mI0BFnYASA8C/4w2uKH26fXZpEgyzojZxmGEz/ZX07NsaDOFUNK4qHlFD449xIyIwmX9br+/Dxe9JLBmLLN06i4J0A892djrU111Zrpc9ux2BJ3ydUbbT8E9HGZNVTF6MKnQW2cftBFYGG5xkGRBxdZar3FomjKt06Dq3w5kqgUzS8LqJHal5MyItkc4F27bKPoyHFKti1j5JMom74cpWnjMqIjVZz1QyQRA+7HdZpX1U2QP5yWFnjbhzZ32tRnmprf+2vlL+8Oq/hVmm0xLp90C34PoLCBgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":802,"cache_read_input_tokens":133630,"cache_creation":{"ephemeral_5m_input_tokens":802,"ephemeral_1h_input_tokens":0},"output_tokens":8,"service_tier":"standard"}},"requestId":"req_011CWz6bFhfuviK6i5oUHZWx","type":"assistant","uuid":"d16fcce2-4c4a-4476-9bf1-f2574164c368","timestamp":"2026-01-10T17:32:30.646Z"}
{"parentUuid":"d16fcce2-4c4a-4476-9bf1-f2574164c368","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","message":{"model":"claude-opus-4-5-20251101","id":"msg_01TGzbW4LJz4FSdWHnzXR3Rf","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01E4gajn1sfB4K9ajbEHRMa1","name":"Edit","input":{"replace_all":false,"file_path":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend/src/app/notebooks/[id]/page.tsx","old_string":"    setResearching(false)\n  }\n\n  // Study material generation handlers","new_string":"    setResearching(false)\n  }\n\n  // Export notebook handler\n  const handleExportNotebook = async (format: 'zip' | 'pdf' | 'json', options: ExportOptionsState) => {\n    setExportingNotebook(true)\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n      if (!session?.access_token) {\n        throw new Error('Not authenticated')\n      }\n\n      await exportNotebook(notebookId, {\n        format,\n        includeSources: options.includeSources,\n        includeChats: options.includeChats,\n        includeNotes: options.includeNotes,\n        includeGenerated: options.includeGenerated,\n      }, session.access_token)\n    } catch (error) {\n      console.error('Export failed:', error)\n      alert('Export failed. Please try again.')\n    } finally {\n      setExportingNotebook(false)\n    }\n  }\n\n  // Study material generation handlers"}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":802,"cache_read_input_tokens":133630,"cache_creation":{"ephemeral_5m_input_tokens":802,"ephemeral_1h_input_tokens":0},"output_tokens":442,"service_tier":"standard"}},"requestId":"req_011CWz6bFhfuviK6i5oUHZWx","type":"assistant","uuid":"5d5b4352-1fd6-4110-ab88-1b546ef4e7f0","timestamp":"2026-01-10T17:32:34.533Z"}
{"parentUuid":"5d5b4352-1fd6-4110-ab88-1b546ef4e7f0","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01E4gajn1sfB4K9ajbEHRMa1","type":"tool_result","content":"The file /Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend/src/app/notebooks/[id]/page.tsx has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n   906→    } catch (error) {\n   907→      console.error('Research error:', error)\n   908→      alert('Research failed. Please try again.')\n   909→    }\n   910→    setResearching(false)\n   911→  }\n   912→\n   913→  // Export notebook handler\n   914→  const handleExportNotebook = async (format: 'zip' | 'pdf' | 'json', options: ExportOptionsState) => {\n   915→    setExportingNotebook(true)\n   916→    try {\n   917→      const { data: { session } } = await supabase.auth.getSession()\n   918→      if (!session?.access_token) {\n   919→        throw new Error('Not authenticated')\n   920→      }\n   921→\n   922→      await exportNotebook(notebookId, {\n   923→        format,\n   924→        includeSources: options.includeSources,\n   925→        includeChats: options.includeChats,\n   926→        includeNotes: options.includeNotes,\n   927→        includeGenerated: options.includeGenerated,\n   928→      }, session.access_token)\n   929→    } catch (error) {\n   930→      console.error('Export failed:', error)\n   931→      alert('Export failed. Please try again.')\n   932→    } finally {\n   933→      setExportingNotebook(false)\n   934→    }\n   935→  }\n   936→\n   937→  // Study material generation handlers\n   938→  const handleGenerateFlashcards = async () => {\n   939→    setGeneratingState('flashcards', true)\n   940→    try {\n   941→      const { data: { session } } = await supabase.auth.getSession()"}]},"uuid":"79279ae6-ada0-48c3-bce4-01546cc0310d","timestamp":"2026-01-10T17:32:34.571Z","toolUseResult":{"filePath":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend/src/app/notebooks/[id]/page.tsx","oldString":"    setResearching(false)\n  }\n\n  // Study material generation handlers","newString":"    setResearching(false)\n  }\n\n  // Export notebook handler\n  const handleExportNotebook = async (format: 'zip' | 'pdf' | 'json', options: ExportOptionsState) => {\n    setExportingNotebook(true)\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n      if (!session?.access_token) {\n        throw new Error('Not authenticated')\n      }\n\n      await exportNotebook(notebookId, {\n        format,\n        includeSources: options.includeSources,\n        includeChats: options.includeChats,\n        includeNotes: options.includeNotes,\n        includeGenerated: options.includeGenerated,\n      }, session.access_token)\n    } catch (error) {\n      console.error('Export failed:', error)\n      alert('Export failed. Please try again.')\n    } finally {\n      setExportingNotebook(false)\n    }\n  }\n\n  // Study material generation handlers","originalFile":"'use client'\n\nimport { useEffect, useState, useRef } from 'react'\nimport { useParams, useRouter, useSearchParams } from 'next/navigation'\nimport { motion, AnimatePresence } from 'framer-motion'\nimport { createClient, Notebook, Source, ChatMessage } from '@/lib/supabase'\nimport { chatApi } from '@/lib/api'\nimport { Button } from '@/components/ui/button'\nimport { Input } from '@/components/ui/input'\nimport { Textarea } from '@/components/ui/textarea'\nimport { Badge } from '@/components/ui/badge'\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n} from '@/components/ui/dialog'\nimport {\n  Sheet,\n  SheetContent,\n  SheetDescription,\n  SheetHeader,\n  SheetTitle,\n} from '@/components/ui/sheet'\nimport {\n  ArrowLeft, Loader2, Sparkles, X, RotateCcw,\n  BookOpen, ListChecks, FileText, HelpCircle, Mic, Video, Search, Share2,\n  Maximize2, Minimize2, Table, FileSpreadsheet, Presentation, Image as ImageIcon,\n  History, Settings\n} from 'lucide-react'\n// Toast notifications removed per user request\n// import { toast } from 'sonner'\nimport { User } from '@supabase/supabase-js'\n\nimport { ThreePanelLayout } from '@/components/panels/three-panel-layout'\nimport { SourcesPanel } from '@/components/sources/sources-panel'\nimport { ChatPanel } from '@/components/chat/chat-panel'\nimport { StudioPanel, ExportOptionsState } from '@/components/studio/studio-panel'\nimport type { GenerationConfig } from '@/components/studio/generation-config-dialog'\nimport { exportNotebook } from '@/lib/export-utils'\nimport {\n  useNotebook,\n  useSources,\n  useNotes,\n  useChatSessions,\n  useGeneratedAudio,\n  useGeneratedVideo,\n  useGeneratedResearch,\n  useStudyMaterials,\n  useCreativeOutputs,\n  useInvalidateNotebook,\n} from '@/lib/hooks/use-notebook-queries'\n\n// Study viewers\nimport { FlashcardViewer } from '@/components/study/flashcard-viewer'\nimport { QuizViewer } from '@/components/study/quiz-viewer'\nimport { StudyGuideViewer } from '@/components/study/study-guide-viewer'\nimport { FAQViewer } from '@/components/study/faq-viewer'\nimport { MindMapViewer } from '@/components/study/mind-map-viewer'\n\n// Studio viewers\nimport { AudioPlayer } from '@/components/studio/audio-player'\nimport { VideoPlayer } from '@/components/studio/video-player'\nimport { ResearchReport } from '@/components/studio/research-report'\nimport { InfographicViewer } from '@/components/studio/infographic-viewer'\n\n// Notebook settings\nimport { NotebookSettingsDialog, NotebookSettings } from '@/components/notebook/notebook-settings'\n\ninterface LocalNote {\n  id: string\n  notebook_id: string\n  type: 'written' | 'saved_response'\n  title: string | null\n  content: string | null\n  tags: string[]\n  is_pinned: boolean\n  created_at: string\n  updated_at: string\n}\n\nexport default function NotebookPage() {\n  const params = useParams()\n  const router = useRouter()\n  const searchParams = useSearchParams()\n  const notebookId = params.id as string\n  const supabase = createClient()\n\n  // Core state - React Query for cached data\n  const [user, setUser] = useState<User | null>(null)\n  const [authChecked, setAuthChecked] = useState(false)\n  const [messages, setMessages] = useState<ChatMessage[]>([])\n\n  // React Query hooks for cached data\n  const { data: notebook, isLoading: notebookLoading } = useNotebook(notebookId)\n  const { data: sources = [], isLoading: sourcesLoading } = useSources(notebookId)\n  const { data: notes = [], isLoading: notesLoading } = useNotes(notebookId)\n  const { data: chatSessions = [], isLoading: loadingSessions } = useChatSessions(notebookId)\n  const { data: generatedAudio } = useGeneratedAudio(notebookId)\n  const { data: generatedVideo } = useGeneratedVideo(notebookId)\n  const { data: generatedResearch } = useGeneratedResearch(notebookId)\n  const { data: studyMaterialsData } = useStudyMaterials(notebookId, sources.map(s => ({ id: s.id, name: s.name })))\n  const { data: creativeOutputsData } = useCreativeOutputs(notebookId)\n  const invalidate = useInvalidateNotebook()\n\n  // Derived loading state\n  const loading = !authChecked || notebookLoading || sourcesLoading || notesLoading\n\n  // Chat state\n  const [sending, setSending] = useState(false)\n  const [message, setMessage] = useState('')\n  const [selectedSources, setSelectedSources] = useState<Set<string>>(new Set())\n  const [sessionId, setSessionId] = useState<string | null>(null)\n\n  // Source state\n  const [viewingSource, setViewingSource] = useState<Source | null>(null)\n  const [uploading, setUploading] = useState(false)\n\n  // Notes state\n  const [addNoteOpen, setAddNoteOpen] = useState(false)\n  const [noteTitle, setNoteTitle] = useState('')\n  const [noteContent, setNoteContent] = useState('')\n  const [savingNote, setSavingNote] = useState(false)\n\n  // Settings state\n  const [settingsOpen, setSettingsOpen] = useState(false)\n  const [notebookSettings, setNotebookSettings] = useState<NotebookSettings | null>(null)\n\n  // Audio state\n  const [audioFormat, setAudioFormat] = useState('deep_dive')\n  const [audioInstructions, setAudioInstructions] = useState('')\n  const [generatingAudio, setGeneratingAudio] = useState(false)\n\n  // Video state\n  const [videoStyle, setVideoStyle] = useState('explainer')\n  const [generatingVideo, setGeneratingVideo] = useState(false)\n\n  // Research state\n  const [researchQuery, setResearchQuery] = useState('')\n  const [researchMode, setResearchMode] = useState('fast')\n  const [researching, setResearching] = useState(false)\n\n  // Export state\n  const [exportingNotebook, setExportingNotebook] = useState(false)\n\n  // Consolidated generating states - single object to reduce re-renders\n  const [generating, setGenerating] = useState({\n    flashcards: false,\n    quiz: false,\n    studyGuide: false,\n    faq: false,\n    mindMap: false,\n    dataTable: false,\n    report: false,\n    slideDeck: false,\n    infographic: false,\n  })\n\n  // Helper to update single generating state\n  const setGeneratingState = (key: keyof typeof generating, value: boolean) => {\n    setGenerating(prev => ({ ...prev, [key]: value }))\n  }\n\n  // Study results\n  const [flashcards, setFlashcards] = useState<Array<{ id: string; front: string; back: string }>>([])\n  const [quizQuestions, setQuizQuestions] = useState<Array<{ id: string; question: string; options: string[]; correct_index: number; explanation: string }>>([])\n  const [studyGuide, setStudyGuide] = useState<{ title: string; sections: Array<{ heading: string; content: string }> } | null>(null)\n  const [faqItems, setFaqItems] = useState<Array<{ question: string; answer: string }>>([])\n  const [mindMap, setMindMap] = useState<{ title: string; nodes: Array<{ id: string; label: string; description?: string; children?: Array<{ id: string; label: string; description?: string; children?: Array<{ id: string; label: string; description?: string }> }> }> } | null>(null)\n\n  // Creative outputs data\n  const [dataTableData, setDataTableData] = useState<{\n    title: string\n    description: string\n    columns: Array<{ header: string; key: string; type: string }>\n    rows: Array<Record<string, string | number | boolean>>\n  } | null>(null)\n  const [reportData, setReportData] = useState<{\n    title: string\n    executive_summary: string\n    sections: Array<{ heading: string; content: string }>\n    key_takeaways: string[]\n  } | null>(null)\n  const [slideDeckData, setSlideDeckData] = useState<{\n    title: string\n    subtitle?: string\n    slides: Array<{ slide_number: number; title: string; content_type: string; main_content: string; bullet_points?: string[]; speaker_notes?: string }>\n    theme_suggestion: string\n  } | null>(null)\n  // Infographic data - supports new image-based format\n  const [infographicData, setInfographicData] = useState<{\n    // New image-based format\n    images?: Array<{ title: string; prompt: string; imageData: string; mimeType: string }>\n    concepts?: string[]\n    // Legacy format (for backward compatibility)\n    title?: string\n    subtitle?: string\n    color_scheme?: string[]\n    sections?: Array<{ section_type: string; title?: string; content: Record<string, unknown> }>\n    style_suggestion?: string\n  } | null>(null)\n\n  // Study materials metadata (for UI display)\n  const [studyMaterialsMeta, setStudyMaterialsMeta] = useState<Array<{\n    id: string\n    type: string\n    sourceIds: string[]\n    sourceNames: string[]\n    createdAt: string\n    itemCount?: number\n  }>>([])\n\n  // Creative outputs metadata (for UI display)\n  const [creativeOutputsMeta, setCreativeOutputsMeta] = useState<Array<{\n    id: string\n    type: string\n    title: string\n    status: string\n    createdAt: string\n    content?: Record<string, unknown>\n  }>>([])\n\n  const [currentFlashcard, setCurrentFlashcard] = useState(0)\n  const [showFlashcardBack, setShowFlashcardBack] = useState(false)\n  const [currentQuizQuestion, setCurrentQuizQuestion] = useState(0)\n  const [selectedAnswer, setSelectedAnswer] = useState<number | null>(null)\n  const [showQuizAnswer, setShowQuizAnswer] = useState(false)\n\n  // Study materials sheet\n  const [studySheetOpen, setStudySheetOpen] = useState(false)\n  const [sheetWidth, setSheetWidth] = useState(576) // Default width in pixels\n  const [isResizing, setIsResizing] = useState(false)\n  const [activeStudyType, setActiveStudyType] = useState<'flashcards' | 'quiz' | 'guide' | 'faq' | 'mindmap' | 'audio' | 'video' | 'research' | 'datatable' | 'report' | 'slides' | 'infographic' | null>(null)\n\n  // Local state for newly generated content (overrides cached until next fetch)\n  const [localGeneratedAudio, setLocalGeneratedAudio] = useState<typeof generatedAudio | null>(null)\n  const [localGeneratedVideo, setLocalGeneratedVideo] = useState<typeof generatedVideo | null>(null)\n  const [localGeneratedResearch, setLocalGeneratedResearch] = useState<{\n    id: string\n    query: string\n    mode: string\n    status: string\n    progress_message?: string\n    sources_found_count?: number\n    sources_analyzed_count?: number\n    report_content?: string\n    report_citations?: { title: string; url: string }[]\n    created_at: string\n    completed_at?: string\n  } | null>(null)\n\n  // Use local state if set, otherwise use cached data\n  const activeGeneratedAudio = localGeneratedAudio ?? generatedAudio\n  const activeGeneratedVideo = localGeneratedVideo ?? generatedVideo\n  const activeGeneratedResearch = localGeneratedResearch ?? generatedResearch\n\n  // File input ref\n  const fileInputRef = useRef<HTMLInputElement>(null)\n\n  // Initialize - just check auth, React Query handles data fetching\n  useEffect(() => {\n    const init = async () => {\n      const { data: { user } } = await supabase.auth.getUser()\n      if (!user) {\n        router.push('/auth/login')\n        return\n      }\n      setUser(user)\n      setAuthChecked(true)\n    }\n    init()\n  }, [notebookId])\n\n\n  // Load a chat session\n  const loadChatSession = async (loadSessionId: string) => {\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n      const response = await fetch(`/api/notebooks/${notebookId}/chat/sessions/${loadSessionId}`, {\n        headers: {\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n      })\n      const result = await response.json()\n      if (result.data) {\n        setSessionId(loadSessionId)\n        setMessages(result.data.messages || [])\n      }\n    } catch (error) {\n      console.error('Failed to load chat session:', error)\n      \n    }\n  }\n\n  // Start a new chat\n  const startNewChat = () => {\n    setSessionId(null)\n    setMessages([])\n    setMessage('')\n  }\n\n  // Delete a chat session\n  const deleteChatSession = async (deleteSessionId: string) => {\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n      const response = await fetch(`/api/notebooks/${notebookId}/chat/sessions/${deleteSessionId}`, {\n        method: 'DELETE',\n        headers: {\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n      })\n      if (response.ok) {\n        // Invalidate cache to refresh the list\n        invalidate.invalidateChatSessions(notebookId)\n\n        // If we deleted the current session, start a new chat\n        if (deleteSessionId === sessionId) {\n          startNewChat()\n        }\n      }\n    } catch (error) {\n      console.error('Failed to delete chat session:', error)\n\n    }\n  }\n\n  // Rename a chat session\n  const renameChatSession = async (renameSessionId: string, newTitle: string) => {\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n      const response = await fetch(`/api/notebooks/${notebookId}/chat/sessions/${renameSessionId}`, {\n        method: 'PATCH',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n        body: JSON.stringify({ title: newTitle }),\n      })\n      if (response.ok) {\n        // Invalidate cache to refresh the list\n        invalidate.invalidateChatSessions(notebookId)\n      }\n    } catch (error) {\n      console.error('Failed to rename chat session:', error)\n    }\n  }\n\n  // Load selected sources from localStorage after sources are loaded\n  useEffect(() => {\n    if (sources.length > 0 && !loading) {\n      const savedSelection = localStorage.getItem(`notebook-${notebookId}-selected-sources`)\n      if (savedSelection) {\n        try {\n          const savedIds = JSON.parse(savedSelection) as string[]\n          // Only select sources that still exist\n          const validIds = savedIds.filter(id => sources.some(s => s.id === id))\n          if (validIds.length > 0) {\n            setSelectedSources(new Set(validIds))\n          }\n        } catch {\n          // Invalid JSON, ignore\n        }\n      }\n    }\n  }, [sources, loading, notebookId])\n\n  // Save selected sources to localStorage whenever they change\n  useEffect(() => {\n    if (!loading && sources.length > 0) {\n      const selectedArray = Array.from(selectedSources)\n      localStorage.setItem(`notebook-${notebookId}-selected-sources`, JSON.stringify(selectedArray))\n    }\n  }, [selectedSources, notebookId, loading, sources.length])\n\n  // Handle view and itemId query params from history page navigation\n  useEffect(() => {\n    const view = searchParams.get('view')\n    const itemId = searchParams.get('itemId')\n\n    if (view && !loading) {\n      // Map view param to activeStudyType\n      const typeMap: Record<string, typeof activeStudyType> = {\n        audio: 'audio',\n        video: 'video',\n        research: 'research',\n        datatable: 'datatable',\n        report: 'report',\n        slides: 'slides',\n        infographic: 'infographic',\n        flashcards: 'flashcards',\n        quiz: 'quiz',\n        guide: 'guide',\n        faq: 'faq',\n        mindmap: 'mindmap',\n      }\n      const studyType = typeMap[view]\n      if (studyType) {\n        setActiveStudyType(studyType)\n        setStudySheetOpen(true)\n\n        // Clear the query params after handling\n        router.replace(`/notebooks/${notebookId}`, { scroll: false })\n      }\n    }\n  }, [searchParams, loading, notebookId, router])\n\n\n  // Fetch existing creative outputs (data tables, reports, slides, infographics)\n  const fetchCreativeOutputs = async () => {\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n      const response = await fetch(`/api/notebooks/${notebookId}/studio`, {\n        headers: {\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n      })\n      const result = await response.json()\n\n      if (result.data && Array.isArray(result.data)) {\n        // Group by type and get the latest of each\n        const outputsByType: Record<string, typeof result.data[0]> = {}\n        for (const output of result.data) {\n          if (output.status === 'completed' && !outputsByType[output.type]) {\n            outputsByType[output.type] = output\n          }\n        }\n\n        // Build metadata array\n        const metaArray = Object.values(outputsByType).map((output) => ({\n          id: output.id,\n          type: output.type,\n          title: output.title || output.type.replace('_', ' '),\n          status: output.status,\n          createdAt: output.created_at,\n          content: output.content,\n        }))\n        setCreativeOutputsMeta(metaArray)\n\n        // Populate state with the latest content of each type\n        for (const output of Object.values(outputsByType)) {\n          if (output.type === 'data_table' && output.content) {\n            setDataTableData(output.content as typeof dataTableData)\n          } else if (output.type === 'report' && output.content) {\n            setReportData(output.content as typeof reportData)\n          } else if (output.type === 'slide_deck' && output.content) {\n            setSlideDeckData(output.content as typeof slideDeckData)\n          } else if (output.type === 'infographic' && output.content) {\n            setInfographicData(output.content as typeof infographicData)\n          }\n        }\n      }\n    } catch (error) {\n      console.error('Failed to fetch creative outputs:', error)\n    }\n  }\n\n  // Fetch existing study materials from Supabase\n  const fetchStudyMaterials = async (sourcesData?: Source[]) => {\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n      const response = await fetch(`/api/notebooks/${notebookId}/study`, {\n        headers: {\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n      })\n      const result = await response.json()\n\n      if (result.data && Array.isArray(result.data)) {\n        // Group materials by type and get the latest of each\n        const materialsByType: Record<string, typeof result.data[0]> = {}\n        for (const material of result.data) {\n          if (!materialsByType[material.type]) {\n            materialsByType[material.type] = material\n          }\n        }\n\n        // Build metadata array for UI\n        const currentSources = sourcesData || sources\n        const metaArray = Object.values(materialsByType).map((material) => {\n          const sourceIds = material.source_ids || []\n          const sourceNames = sourceIds.map((id: string) => {\n            const source = currentSources.find(s => s.id === id)\n            return source?.name || 'Unknown source'\n          })\n\n          // Calculate item count based on type\n          let itemCount = 0\n          if (material.type === 'flashcards') itemCount = material.data?.flashcards?.length || 0\n          else if (material.type === 'quiz') itemCount = material.data?.questions?.length || 0\n          else if (material.type === 'faq') itemCount = material.data?.faq?.length || 0\n\n          return {\n            id: material.id,\n            type: material.type,\n            sourceIds,\n            sourceNames,\n            createdAt: material.created_at,\n            itemCount,\n          }\n        })\n        setStudyMaterialsMeta(metaArray)\n\n        // Populate state with cached data\n        if (materialsByType.flashcards?.data?.flashcards) {\n          setFlashcards(materialsByType.flashcards.data.flashcards)\n        }\n        if (materialsByType.quiz?.data?.questions) {\n          setQuizQuestions(materialsByType.quiz.data.questions)\n        }\n        if (materialsByType.study_guide?.data) {\n          setStudyGuide(materialsByType.study_guide.data)\n        }\n        if (materialsByType.faq?.data?.faq) {\n          setFaqItems(materialsByType.faq.data.faq)\n        }\n        if (materialsByType.mind_map?.data) {\n          setMindMap(materialsByType.mind_map.data)\n        }\n      }\n    } catch (error) {\n      console.error('Failed to fetch study materials:', error)\n    }\n  }\n\n  // Redirect if notebook doesn't exist\n  useEffect(() => {\n    if (!notebookLoading && !notebook) {\n      router.push('/')\n    }\n  }, [notebook, notebookLoading, router])\n\n  // Load notebook settings when notebook data is available\n  useEffect(() => {\n    if (notebook?.settings) {\n      setNotebookSettings(notebook.settings as unknown as NotebookSettings)\n    }\n  }, [notebook])\n\n  // Save notebook settings\n  const saveNotebookSettings = async (newSettings: NotebookSettings) => {\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n      const response = await fetch(`/api/notebooks/${notebookId}`, {\n        method: 'PATCH',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n        body: JSON.stringify({ settings: newSettings }),\n      })\n\n      if (!response.ok) {\n        throw new Error('Failed to save settings')\n      }\n\n      setNotebookSettings(newSettings)\n      invalidate.invalidateNotebook(notebookId)\n    } catch (error) {\n      console.error('Failed to save notebook settings:', error)\n      throw error\n    }\n  }\n\n  // Source handlers\n  const handleAddSource = async (type: string, data: { input: string; name?: string; file?: File }) => {\n    setUploading(true)\n\n    if (type === 'file') {\n      // Handle file upload - file is passed from the sources panel\n      const file = data.file\n      if (file) {\n        const fileExt = file.name.split('.').pop()?.toLowerCase()\n        const filePath = `${user?.id}/${notebookId}/${Date.now()}.${fileExt}`\n\n        const { error: uploadError } = await supabase.storage\n          .from('sources')\n          .upload(filePath, file)\n\n        if (uploadError) {\n          console.error('Upload error:', uploadError)\n          \n          setUploading(false)\n          return\n        }\n\n        const { data: sourceData, error } = await supabase\n          .from('sources')\n          .insert({\n            notebook_id: notebookId,\n            type: fileExt === 'pdf' ? 'pdf' : fileExt === 'docx' ? 'docx' : 'txt',\n            name: file.name,\n            status: 'ready',\n            file_path: filePath,\n            original_filename: file.name,\n            mime_type: file.type,\n            file_size_bytes: file.size,\n          })\n          .select()\n          .single()\n\n        if (error) {\n          console.error('Source creation error:', error)\n        } else {\n          invalidate.invalidateSources(notebookId)\n        }\n      }\n    } else {\n      let sourceData: Partial<Source> = {\n        notebook_id: notebookId,\n        status: 'ready',\n      }\n\n      if (type === 'youtube') {\n        sourceData = {\n          ...sourceData,\n          type: 'youtube',\n          name: data.name || `YouTube: ${data.input}`,\n          metadata: { url: data.input },\n        }\n      } else if (type === 'url') {\n        sourceData = {\n          ...sourceData,\n          type: 'url',\n          name: data.name || data.input,\n          metadata: { url: data.input },\n        }\n      } else if (type === 'text') {\n        sourceData = {\n          ...sourceData,\n          type: 'text',\n          name: data.name || 'Pasted Text',\n          metadata: { content: data.input },\n        }\n      }\n\n      const { error } = await supabase\n        .from('sources')\n        .insert(sourceData)\n        .select()\n        .single()\n\n      if (error) {\n        console.error('Source creation error:', error)\n      } else {\n        invalidate.invalidateSources(notebookId)\n      }\n    }\n\n    setUploading(false)\n  }\n\n  const handleDeleteSource = async (sourceId: string) => {\n    const { error } = await supabase\n      .from('sources')\n      .delete()\n      .eq('id', sourceId)\n\n    if (error) {\n      console.error('Delete source error:', error)\n    } else {\n      invalidate.invalidateSources(notebookId)\n      selectedSources.delete(sourceId)\n      setSelectedSources(new Set(selectedSources))\n    }\n  }\n\n  const toggleSource = (sourceId: string) => {\n    const newSelected = new Set(selectedSources)\n    if (newSelected.has(sourceId)) {\n      newSelected.delete(sourceId)\n    } else {\n      newSelected.add(sourceId)\n    }\n    setSelectedSources(newSelected)\n  }\n\n  const selectAllSources = () => {\n    if (selectedSources.size === sources.length) {\n      setSelectedSources(new Set())\n    } else {\n      setSelectedSources(new Set(sources.map(s => s.id)))\n    }\n  }\n\n  // Chat handlers\n  const sendMessage = async (overrideMessage?: string) => {\n    const messageToSend = overrideMessage || message\n    if (!messageToSend.trim() || sending) return\n\n    setSending(true)\n    const userMessage: ChatMessage = {\n      id: crypto.randomUUID(),\n      session_id: sessionId || '',\n      role: 'user',\n      content: messageToSend,\n      citations: [],\n      source_ids_used: Array.from(selectedSources),\n      model_used: null,\n      input_tokens: null,\n      output_tokens: null,\n      cost_usd: null,\n      created_at: new Date().toISOString(),\n    }\n    setMessages(prev => [...prev, userMessage])\n    setMessage('')\n\n    try {\n      const response = await chatApi.sendMessage(notebookId, {\n        message: userMessage.content,\n        source_ids: Array.from(selectedSources),\n        session_id: sessionId || undefined,\n      })\n\n      const isNewSession = !sessionId\n      if (response.data.session_id) {\n        setSessionId(response.data.session_id)\n      }\n\n      const aiMessage: ChatMessage = {\n        id: response.data.message_id,\n        session_id: response.data.session_id,\n        role: 'assistant',\n        content: response.data.content,\n        citations: response.data.citations,\n        source_ids_used: Array.from(selectedSources),\n        model_used: response.usage?.model_used || 'gemini-2.0-flash',\n        input_tokens: response.usage?.input_tokens || 0,\n        output_tokens: response.usage?.output_tokens || 0,\n        cost_usd: response.usage?.cost_usd || 0,\n        created_at: new Date().toISOString(),\n      }\n      setMessages(prev => [...prev, aiMessage])\n\n      // Refresh chat sessions if this was a new session\n      if (isNewSession) {\n        invalidate.invalidateChatSessions(notebookId)\n      }\n    } catch {\n      setMessages(prev => prev.filter(m => m.id !== userMessage.id))\n    }\n    setSending(false)\n  }\n\n  const saveResponseAsNote = async (msg: ChatMessage) => {\n    const { error } = await supabase\n      .from('notes')\n      .insert({\n        notebook_id: notebookId,\n        type: 'saved_response',\n        title: `Saved Response - ${new Date().toLocaleDateString()}`,\n        content: msg.content,\n        tags: [],\n      })\n      .select()\n      .single()\n\n    if (error) {\n      console.error('Save note error:', error)\n    } else {\n      invalidate.invalidateNotes(notebookId)\n    }\n  }\n\n  // Notes handlers\n  const createNote = async () => {\n    if (!noteTitle.trim() && !noteContent.trim()) return\n\n    setSavingNote(true)\n    const { error } = await supabase\n      .from('notes')\n      .insert({\n        notebook_id: notebookId,\n        type: 'written',\n        title: noteTitle || 'Untitled Note',\n        content: noteContent,\n        tags: [],\n      })\n      .select()\n      .single()\n\n    if (error) {\n      console.error('Create note error:', error)\n    } else {\n      invalidate.invalidateNotes(notebookId)\n      setNoteTitle('')\n      setNoteContent('')\n      setAddNoteOpen(false)\n    }\n    setSavingNote(false)\n  }\n\n  // Audio generation\n  const generateAudio = async () => {\n    if (selectedSources.size === 0) {\n      \n      return\n    }\n\n    setGeneratingAudio(true)\n    setActiveStudyType('audio')\n    setStudySheetOpen(true)\n\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n      const response = await fetch(`/api/notebooks/${notebookId}/audio`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n        body: JSON.stringify({\n          format: audioFormat,\n          source_ids: Array.from(selectedSources),\n          custom_instructions: audioInstructions || undefined,\n        }),\n      })\n      const result = await response.json()\n      if (result.error) {\n        console.error('Audio generation error:', result.error)\n      } else if (result.data) {\n        setLocalGeneratedAudio(result.data)\n        invalidate.invalidateAudio(notebookId)\n      }\n    } catch (error) {\n      console.error('Audio generation error:', error)\n    }\n    setGeneratingAudio(false)\n  }\n\n  // Video generation\n  const generateVideo = async () => {\n    if (selectedSources.size === 0) {\n      return\n    }\n\n    setGeneratingVideo(true)\n    setActiveStudyType('video')\n    setStudySheetOpen(true)\n\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n      const response = await fetch(`/api/notebooks/${notebookId}/video`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n        body: JSON.stringify({\n          style: videoStyle,\n          source_ids: Array.from(selectedSources),\n        }),\n      })\n      const result = await response.json()\n      if (result.error) {\n        console.error('Video generation error:', result.error)\n      } else if (result.data) {\n        // Map video_file_path to video_url for frontend components\n        setLocalGeneratedVideo({\n          ...result.data,\n          video_url: result.data.video_file_path || result.data.video_url,\n        })\n        invalidate.invalidateVideo(notebookId)\n      }\n    } catch (error) {\n      console.error('Video generation error:', error)\n    }\n    setGeneratingVideo(false)\n  }\n\n  // Research generation\n  const runResearch = async () => {\n    if (!researchQuery.trim()) {\n      return\n    }\n\n    // Clear old research to prevent showing cached results\n    setLocalGeneratedResearch(null)\n    setResearching(true)\n    setActiveStudyType('research')\n    setStudySheetOpen(true)\n\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n      const response = await fetch(`/api/notebooks/${notebookId}/research`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n        body: JSON.stringify({\n          query: researchQuery,\n          mode: researchMode,\n        }),\n      })\n      const result = await response.json()\n      if (result.error) {\n        console.error('Research failed:', result.error)\n        alert(`Research failed: ${result.error}`)\n      } else if (result.data) {\n        setLocalGeneratedResearch(result.data)\n        invalidate.invalidateResearch(notebookId)\n        setResearchQuery('')\n      }\n    } catch (error) {\n      console.error('Research error:', error)\n      alert('Research failed. Please try again.')\n    }\n    setResearching(false)\n  }\n\n  // Study material generation handlers\n  const handleGenerateFlashcards = async () => {\n    setGeneratingState('flashcards', true)\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n      const response = await fetch(`/api/notebooks/${notebookId}/study`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n        body: JSON.stringify({\n          type: 'flashcards',\n          source_ids: Array.from(selectedSources),\n          count: 5,\n        }),\n      })\n      const result = await response.json()\n      if (result.error) {\n        \n      } else if (result.data?.flashcards) {\n        setFlashcards(result.data.flashcards)\n        setCurrentFlashcard(0)\n        setShowFlashcardBack(false)\n        setActiveStudyType('flashcards')\n        setStudySheetOpen(true)\n        fetchStudyMaterials()\n        \n      }\n    } catch {\n      \n    } finally {\n      setGeneratingState('flashcards', false)\n    }\n  }\n\n  const handleGenerateQuiz = async () => {\n    setGeneratingState('quiz', true)\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n      const response = await fetch(`/api/notebooks/${notebookId}/study`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n        body: JSON.stringify({\n          type: 'quiz',\n          source_ids: Array.from(selectedSources),\n          count: 5,\n        }),\n      })\n      const result = await response.json()\n      if (result.error) {\n        \n      } else if (result.data?.questions) {\n        setQuizQuestions(result.data.questions)\n        setCurrentQuizQuestion(0)\n        setSelectedAnswer(null)\n        setShowQuizAnswer(false)\n        setActiveStudyType('quiz')\n        setStudySheetOpen(true)\n        fetchStudyMaterials()\n        \n      }\n    } catch {\n      \n    } finally {\n      setGeneratingState('quiz', false)\n    }\n  }\n\n  const handleGenerateStudyGuide = async () => {\n    setGeneratingState('studyGuide', true)\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n      const response = await fetch(`/api/notebooks/${notebookId}/study`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n        body: JSON.stringify({\n          type: 'study-guide',\n          source_ids: Array.from(selectedSources),\n        }),\n      })\n      const result = await response.json()\n      if (result.error) {\n        \n      } else if (result.data?.sections) {\n        setStudyGuide(result.data)\n        setActiveStudyType('guide')\n        setStudySheetOpen(true)\n        fetchStudyMaterials()\n        \n      }\n    } catch {\n      \n    } finally {\n      setGeneratingState('studyGuide', false)\n    }\n  }\n\n  const handleGenerateFaq = async () => {\n    setGeneratingState('faq', true)\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n      const response = await fetch(`/api/notebooks/${notebookId}/study`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n        body: JSON.stringify({\n          type: 'faq',\n          source_ids: Array.from(selectedSources),\n        }),\n      })\n      const result = await response.json()\n      if (result.error) {\n        \n      } else if (result.data?.faq) {\n        setFaqItems(result.data.faq)\n        setActiveStudyType('faq')\n        setStudySheetOpen(true)\n        fetchStudyMaterials()\n        \n      }\n    } catch {\n      \n    } finally {\n      setGeneratingState('faq', false)\n    }\n  }\n\n  const handleGenerateMindMap = async () => {\n    setGeneratingState('mindMap', true)\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n      const response = await fetch(`/api/notebooks/${notebookId}/study`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n        body: JSON.stringify({\n          type: 'mind-map',\n          source_ids: Array.from(selectedSources),\n        }),\n      })\n      const result = await response.json()\n      if (result.error) {\n\n      } else if (result.data?.nodes) {\n        setMindMap(result.data)\n        setActiveStudyType('mindmap')\n        setStudySheetOpen(true)\n        // Refresh metadata to show updated material\n        fetchStudyMaterials()\n\n      }\n    } catch {\n\n    } finally {\n      setGeneratingState('mindMap', false)\n    }\n  }\n\n  // Unified study material handler with config\n  const handleGenerateStudyMaterial = async (config: GenerationConfig) => {\n    const sourceIds = config.sourceIds && config.sourceIds.length > 0\n      ? config.sourceIds\n      : Array.from(selectedSources)\n\n    if (sourceIds.length === 0) return\n\n    // Set loading state based on type\n    const typeToStateKey: Record<string, keyof typeof generating> = {\n      'flashcards': 'flashcards',\n      'quiz': 'quiz',\n      'study-guide': 'studyGuide',\n      'faq': 'faq',\n      'mind-map': 'mindMap',\n    }\n    const stateKey = typeToStateKey[config.type]\n    if (stateKey) setGeneratingState(stateKey, true)\n\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n\n      // Build request body with all config options\n      const requestBody: Record<string, unknown> = {\n        type: config.type,\n        source_ids: sourceIds,\n      }\n\n      // Add optional config fields\n      if (config.count) requestBody.count = config.count\n      if (config.difficulty) requestBody.difficulty = config.difficulty\n      if (config.focusArea) requestBody.focus_area = config.focusArea\n      if (config.customInstructions) requestBody.custom_instructions = config.customInstructions\n      if (config.questionTypes) requestBody.question_types = config.questionTypes\n\n      const response = await fetch(`/api/notebooks/${notebookId}/study`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n        body: JSON.stringify(requestBody),\n      })\n      const result = await response.json()\n\n      if (result.error) {\n        console.error('Generation error:', result.error)\n      } else if (result.data) {\n        // Handle each type's response\n        switch (config.type) {\n          case 'flashcards':\n            if (result.data.flashcards) {\n              setFlashcards(result.data.flashcards)\n              setCurrentFlashcard(0)\n              setShowFlashcardBack(false)\n              setActiveStudyType('flashcards')\n              setStudySheetOpen(true)\n            }\n            break\n          case 'quiz':\n            if (result.data.questions) {\n              setQuizQuestions(result.data.questions)\n              setCurrentQuizQuestion(0)\n              setSelectedAnswer(null)\n              setShowQuizAnswer(false)\n              setActiveStudyType('quiz')\n              setStudySheetOpen(true)\n            }\n            break\n          case 'study-guide':\n            if (result.data.sections) {\n              setStudyGuide(result.data)\n              setActiveStudyType('guide')\n              setStudySheetOpen(true)\n            }\n            break\n          case 'faq':\n            if (result.data.faq) {\n              setFaqItems(result.data.faq)\n              setActiveStudyType('faq')\n              setStudySheetOpen(true)\n            }\n            break\n          case 'mind-map':\n            if (result.data.nodes) {\n              setMindMap(result.data)\n              setActiveStudyType('mindmap')\n              setStudySheetOpen(true)\n            }\n            break\n        }\n        fetchStudyMaterials()\n      }\n    } catch (error) {\n      console.error('Study material generation failed:', error)\n    } finally {\n      if (stateKey) setGeneratingState(stateKey, false)\n    }\n  }\n\n  // Unified creative output handler with config\n  const handleGenerateCreativeOutput = async (config: GenerationConfig) => {\n    const sourceIds = config.sourceIds && config.sourceIds.length > 0\n      ? config.sourceIds\n      : Array.from(selectedSources)\n\n    if (sourceIds.length === 0) return\n\n    // Set loading state based on type\n    const typeToStateKey2: Record<string, keyof typeof generating> = {\n      'data_table': 'dataTable',\n      'report': 'report',\n      'slide_deck': 'slideDeck',\n      'infographic': 'infographic',\n    }\n    const stateKey2 = typeToStateKey2[config.type]\n    if (stateKey2) setGeneratingState(stateKey2, true)\n\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n\n      // Build request body with all config options\n      const requestBody: Record<string, unknown> = {\n        type: config.type,\n        source_ids: sourceIds,\n      }\n\n      // Add optional config fields\n      if (config.customInstructions) requestBody.custom_instructions = config.customInstructions\n      if (config.focusArea) requestBody.focus_area = config.focusArea\n      if (config.reportType) requestBody.report_type = config.reportType\n      if (config.tone) requestBody.tone = config.tone\n      if (config.slideCount) requestBody.slide_count = config.slideCount\n      if (config.style) requestBody.style = config.style\n      // Infographic-specific options\n      if (config.imageCount) requestBody.image_count = config.imageCount\n      if (config.imageStyle) requestBody.image_style = config.imageStyle\n\n      const response = await fetch(`/api/notebooks/${notebookId}/studio`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n        body: JSON.stringify(requestBody),\n      })\n      const result = await response.json()\n\n      if (result.error) {\n        console.error('Generation error:', result.error)\n      } else if (result.data) {\n        // Handle each type's response\n        switch (config.type) {\n          case 'data_table':\n            setDataTableData(result.data)\n            setActiveStudyType('datatable')\n            setStudySheetOpen(true)\n            break\n          case 'report':\n            setReportData(result.data)\n            setActiveStudyType('report')\n            setStudySheetOpen(true)\n            break\n          case 'slide_deck':\n            setSlideDeckData(result.data)\n            setActiveStudyType('slides')\n            setStudySheetOpen(true)\n            break\n          case 'infographic':\n            setInfographicData(result.data)\n            setActiveStudyType('infographic')\n            setStudySheetOpen(true)\n            break\n        }\n        fetchCreativeOutputs()\n      }\n    } catch (error) {\n      console.error('Creative output generation failed:', error)\n    } finally {\n      if (stateKey2) setGeneratingState(stateKey2, false)\n    }\n  }\n\n  // Creative output generation handlers (legacy - kept for compatibility)\n  const handleGenerateDataTable = async () => {\n    if (selectedSources.size === 0) {\n\n      return\n    }\n    setGeneratingState('dataTable', true)\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n      const response = await fetch(`/api/notebooks/${notebookId}/studio`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n        body: JSON.stringify({\n          type: 'data_table',\n          source_ids: Array.from(selectedSources),\n        }),\n      })\n      const result = await response.json()\n      if (result.error) {\n        \n      } else if (result.data) {\n        setDataTableData(result.data)\n        setActiveStudyType('datatable' as typeof activeStudyType)\n        setStudySheetOpen(true)\n        fetchCreativeOutputs()\n      }\n    } catch {\n      // Error handled silently\n    } finally {\n      setGeneratingState('dataTable', false)\n    }\n  }\n\n  const handleGenerateReport = async (reportType: string) => {\n    if (selectedSources.size === 0) {\n\n      return\n    }\n    setGeneratingState('report', true)\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n      const response = await fetch(`/api/notebooks/${notebookId}/studio`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n        body: JSON.stringify({\n          type: 'report',\n          source_ids: Array.from(selectedSources),\n          report_type: reportType,\n        }),\n      })\n      const result = await response.json()\n      if (result.error) {\n        \n      } else if (result.data) {\n        setReportData(result.data)\n        setActiveStudyType('report' as typeof activeStudyType)\n        setStudySheetOpen(true)\n        fetchCreativeOutputs()\n      }\n    } catch {\n      // Error handled silently\n    } finally {\n      setGeneratingState('report', false)\n    }\n  }\n\n  const handleGenerateSlideDeck = async () => {\n    if (selectedSources.size === 0) {\n\n      return\n    }\n    setGeneratingState('slideDeck', true)\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n      const response = await fetch(`/api/notebooks/${notebookId}/studio`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n        body: JSON.stringify({\n          type: 'slide_deck',\n          source_ids: Array.from(selectedSources),\n        }),\n      })\n      const result = await response.json()\n      if (result.error) {\n        \n      } else if (result.data) {\n        setSlideDeckData(result.data)\n        setActiveStudyType('slides' as typeof activeStudyType)\n        setStudySheetOpen(true)\n        fetchCreativeOutputs()\n      }\n    } catch {\n      // Error handled silently\n    } finally {\n      setGeneratingState('slideDeck', false)\n    }\n  }\n\n  const handleGenerateInfographic = async () => {\n    if (selectedSources.size === 0) {\n\n      return\n    }\n    setGeneratingState('infographic', true)\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n      const response = await fetch(`/api/notebooks/${notebookId}/studio`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n        body: JSON.stringify({\n          type: 'infographic',\n          source_ids: Array.from(selectedSources),\n        }),\n      })\n      const result = await response.json()\n      if (result.error) {\n        \n      } else if (result.data) {\n        setInfographicData(result.data)\n        setActiveStudyType('infographic' as typeof activeStudyType)\n        setStudySheetOpen(true)\n        fetchCreativeOutputs()\n      }\n    } catch {\n      // Error handled silently\n    } finally {\n      setGeneratingState('infographic', false)\n    }\n  }\n\n  // Sheet resize handlers\n  const handleResizeStart = (e: React.MouseEvent) => {\n    e.preventDefault()\n    setIsResizing(true)\n\n    const startX = e.clientX\n    const startWidth = sheetWidth\n\n    const handleMouseMove = (e: MouseEvent) => {\n      const diff = startX - e.clientX\n      const newWidth = Math.min(Math.max(startWidth + diff, 400), window.innerWidth - 50)\n      setSheetWidth(newWidth)\n    }\n\n    const handleMouseUp = () => {\n      setIsResizing(false)\n      document.removeEventListener('mousemove', handleMouseMove)\n      document.removeEventListener('mouseup', handleMouseUp)\n    }\n\n    document.addEventListener('mousemove', handleMouseMove)\n    document.addEventListener('mouseup', handleMouseUp)\n  }\n\n  if (loading) {\n    return (\n      <div className=\"h-screen flex items-center justify-center bg-[var(--bg-primary)]\">\n        <Loader2 className=\"h-8 w-8 animate-spin text-[var(--accent-primary)]\" />\n      </div>\n    )\n  }\n\n  return (\n    <div className=\"h-screen flex flex-col bg-[var(--bg-primary)]\">\n      {/* Header */}\n      <motion.header\n        initial={{ opacity: 0, y: -10 }}\n        animate={{ opacity: 1, y: 0 }}\n        className=\"h-14 bg-[var(--bg-secondary)] border-b border-[rgba(255,255,255,0.1)] px-4 flex items-center gap-4 shrink-0 sticky top-0 z-50\"\n      >\n        <Button\n          variant=\"ghost\"\n          size=\"icon\"\n          onClick={() => router.push('/')}\n          className=\"h-9 w-9 rounded-lg text-[var(--text-secondary)] hover:text-[var(--text-primary)] hover:bg-[var(--bg-tertiary)]\"\n        >\n          <ArrowLeft className=\"h-4 w-4\" />\n        </Button>\n\n        <div className=\"flex items-center gap-3\">\n          <div className=\"w-10 h-10 rounded-xl bg-[var(--bg-tertiary)] flex items-center justify-center text-xl\">\n            {notebook?.emoji}\n          </div>\n          <div>\n            <h1 className=\"font-semibold text-[var(--text-primary)]\">{notebook?.name}</h1>\n            {notebook?.description && (\n              <p className=\"text-xs text-[var(--text-tertiary)] line-clamp-1 max-w-[300px]\">\n                {notebook.description}\n              </p>\n            )}\n          </div>\n        </div>\n\n        <div className=\"flex items-center gap-2 ml-auto\">\n          <Badge className=\"bg-[var(--bg-tertiary)] text-[var(--text-secondary)] border-0 text-xs\">\n            {sources.length} source{sources.length !== 1 ? 's' : ''}\n          </Badge>\n          {selectedSources.size > 0 && (\n            <Badge className=\"bg-[var(--accent-primary)]/20 text-[var(--accent-primary)] border-0 text-xs\">\n              {selectedSources.size} selected\n            </Badge>\n          )}\n          {notebookSettings?.persona?.enabled && (\n            <Badge className=\"bg-purple-500/20 text-purple-400 border-0 text-xs\">\n              {notebookSettings.persona.name || 'Custom Persona'}\n            </Badge>\n          )}\n          <Button\n            variant=\"ghost\"\n            size=\"sm\"\n            onClick={() => setSettingsOpen(true)}\n            className=\"h-9 px-3 rounded-lg text-[var(--text-secondary)] hover:text-[var(--text-primary)] hover:bg-[var(--bg-tertiary)] gap-2\"\n          >\n            <Settings className=\"h-4 w-4\" />\n            <span className=\"hidden sm:inline\">Settings</span>\n          </Button>\n          <Button\n            variant=\"ghost\"\n            size=\"sm\"\n            onClick={() => router.push(`/notebooks/${notebookId}/history`)}\n            className=\"h-9 px-3 rounded-lg text-[var(--text-secondary)] hover:text-[var(--text-primary)] hover:bg-[var(--bg-tertiary)] gap-2\"\n          >\n            <History className=\"h-4 w-4\" />\n            <span className=\"hidden sm:inline\">History</span>\n          </Button>\n        </div>\n      </motion.header>\n\n      {/* Three Panel Layout */}\n      <div className=\"flex-1 overflow-hidden\">\n        <ThreePanelLayout\n          leftPanelTitle=\"Sources\"\n          rightPanelTitle=\"Studio\"\n          leftPanel={\n            <SourcesPanel\n              sources={sources}\n              selectedSources={selectedSources}\n              onToggleSource={toggleSource}\n              onSelectAll={selectAllSources}\n              onAddSource={handleAddSource}\n              onDeleteSource={handleDeleteSource}\n              onViewSource={setViewingSource}\n              uploading={uploading}\n            />\n          }\n          centerPanel={\n            <ChatPanel\n              messages={messages}\n              message={message}\n              onMessageChange={setMessage}\n              onSendMessage={sendMessage}\n              sending={sending}\n              selectedSourcesCount={selectedSources.size}\n              totalSourcesCount={sources.length}\n              onSaveResponse={saveResponseAsNote}\n              sessions={chatSessions}\n              currentSessionId={sessionId}\n              onLoadSession={loadChatSession}\n              onNewChat={startNewChat}\n              onDeleteSession={deleteChatSession}\n              onRenameSession={renameChatSession}\n              loadingSessions={loadingSessions}\n              notebookId={notebookId}\n            />\n          }\n          rightPanel={\n            <StudioPanel\n              notebookId={notebookId}\n              selectedSourcesCount={selectedSources.size}\n              selectedSourceIds={Array.from(selectedSources)}\n              sources={sources.map(s => ({ id: s.id, name: s.name }))}\n              audioFormat={audioFormat}\n              onAudioFormatChange={setAudioFormat}\n              audioInstructions={audioInstructions}\n              onAudioInstructionsChange={setAudioInstructions}\n              onGenerateAudio={generateAudio}\n              generatingAudio={generatingAudio}\n              videoStyle={videoStyle}\n              onVideoStyleChange={setVideoStyle}\n              onGenerateVideo={generateVideo}\n              generatingVideo={generatingVideo}\n              researchQuery={researchQuery}\n              onResearchQueryChange={setResearchQuery}\n              researchMode={researchMode}\n              onResearchModeChange={setResearchMode}\n              onRunResearch={runResearch}\n              researching={researching}\n              onGenerateStudyMaterial={handleGenerateStudyMaterial}\n              generatingFlashcards={generating.flashcards}\n              generatingQuiz={generating.quiz}\n              generatingStudyGuide={generating.studyGuide}\n              generatingFaq={generating.faq}\n              generatingMindMap={generating.mindMap}\n              onGenerateCreativeOutput={handleGenerateCreativeOutput}\n              generatingDataTable={generating.dataTable}\n              generatingReport={generating.report}\n              generatingSlideDeck={generating.slideDeck}\n              generatingInfographic={generating.infographic}\n              creativeOutputs={creativeOutputsMeta}\n              onOpenCreativeOutput={(type) => {\n                const typeMap: Record<string, typeof activeStudyType> = {\n                  data_table: 'datatable',\n                  report: 'report',\n                  slide_deck: 'slides',\n                  infographic: 'infographic',\n                }\n                setActiveStudyType(typeMap[type] || null)\n                setStudySheetOpen(true)\n              }}\n              studyMaterials={studyMaterialsMeta}\n              onOpenStudyMaterial={(type) => {\n                const typeMap: Record<string, typeof activeStudyType> = {\n                  flashcards: 'flashcards',\n                  quiz: 'quiz',\n                  study_guide: 'guide',\n                  faq: 'faq',\n                  mind_map: 'mindmap',\n                }\n                setActiveStudyType(typeMap[type] || null)\n                setStudySheetOpen(true)\n              }}\n              notesCount={notes.length}\n              onAddNote={() => setAddNoteOpen(true)}\n              hasGeneratedAudio={!!activeGeneratedAudio}\n              hasGeneratedVideo={!!activeGeneratedVideo}\n              hasGeneratedResearch={!!activeGeneratedResearch}\n              onOpenAudio={() => { setActiveStudyType('audio'); setStudySheetOpen(true) }}\n              onOpenVideo={() => { setActiveStudyType('video'); setStudySheetOpen(true) }}\n              onOpenResearch={() => { setActiveStudyType('research'); setStudySheetOpen(true) }}\n            />\n          }\n        />\n      </div>\n\n      {/* Source Preview Dialog */}\n      <Dialog open={!!viewingSource} onOpenChange={(open) => !open && setViewingSource(null)}>\n        <DialogContent className=\"sm:max-w-lg bg-[var(--bg-secondary)] border-[rgba(255,255,255,0.1)]\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-3 text-[var(--text-primary)]\">\n              <div className=\"w-10 h-10 rounded-lg bg-[var(--bg-tertiary)] flex items-center justify-center\">\n                <FileText className=\"h-5 w-5\" />\n              </div>\n              {viewingSource?.name}\n            </DialogTitle>\n            <DialogDescription className=\"text-[var(--text-secondary)]\">\n              {viewingSource?.type} source\n            </DialogDescription>\n          </DialogHeader>\n\n          {viewingSource?.metadata && (() => {\n            const meta = viewingSource.metadata as Record<string, unknown>\n            if (viewingSource.type === 'text' && meta.content) {\n              return (\n                <div className=\"p-4 rounded-xl bg-[var(--bg-tertiary)] text-sm max-h-64 overflow-y-auto\">\n                  <p className=\"whitespace-pre-wrap text-[var(--text-secondary)]\">\n                    {String(meta.content)}\n                  </p>\n                </div>\n              )\n            }\n            if ((viewingSource.type === 'youtube' || viewingSource.type === 'url') && meta.url) {\n              return (\n                <div className=\"p-4 rounded-xl bg-[var(--bg-tertiary)] text-sm max-h-64 overflow-y-auto\">\n                  <a\n                    href={String(meta.url)}\n                    target=\"_blank\"\n                    rel=\"noopener noreferrer\"\n                    className=\"text-[var(--accent-primary)] hover:underline break-all\"\n                  >\n                    {String(meta.url)}\n                  </a>\n                </div>\n              )\n            }\n            return null\n          })()}\n        </DialogContent>\n      </Dialog>\n\n      {/* Add Note Dialog */}\n      <Dialog open={addNoteOpen} onOpenChange={setAddNoteOpen}>\n        <DialogContent className=\"sm:max-w-md bg-[var(--bg-secondary)] border-[rgba(255,255,255,0.1)]\">\n          <DialogHeader>\n            <DialogTitle className=\"text-[var(--text-primary)]\">Create Note</DialogTitle>\n            <DialogDescription className=\"text-[var(--text-secondary)]\">\n              Write a new note to save your thoughts.\n            </DialogDescription>\n          </DialogHeader>\n          <div className=\"space-y-4 mt-2\">\n            <div className=\"space-y-2\">\n              <label className=\"text-sm font-medium text-[var(--text-primary)]\">Title</label>\n              <Input\n                placeholder=\"Note title...\"\n                value={noteTitle}\n                onChange={(e) => setNoteTitle(e.target.value)}\n                className=\"h-10 bg-[var(--bg-tertiary)] border-[rgba(255,255,255,0.1)] text-[var(--text-primary)] placeholder:text-[var(--text-tertiary)] focus:border-[var(--accent-primary)] rounded-lg\"\n              />\n            </div>\n            <div className=\"space-y-2\">\n              <label className=\"text-sm font-medium text-[var(--text-primary)]\">Content</label>\n              <Textarea\n                placeholder=\"Write your note...\"\n                value={noteContent}\n                onChange={(e) => setNoteContent(e.target.value)}\n                rows={6}\n                className=\"bg-[var(--bg-tertiary)] border-[rgba(255,255,255,0.1)] text-[var(--text-primary)] placeholder:text-[var(--text-tertiary)] focus:border-[var(--accent-primary)] rounded-lg resize-none\"\n              />\n            </div>\n          </div>\n          <DialogFooter className=\"mt-4\">\n            <Button\n              onClick={createNote}\n              disabled={savingNote}\n              className=\"rounded-lg bg-[var(--accent-primary)] hover:bg-[var(--accent-primary)]/90 text-white\"\n            >\n              {savingNote && <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />}\n              Create Note\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      {/* Study Materials Sheet */}\n      <Sheet open={studySheetOpen} onOpenChange={(open) => {\n        setStudySheetOpen(open)\n        if (!open) setSheetWidth(576)\n      }}>\n        <SheetContent\n          className=\"overflow-y-auto bg-[var(--bg-secondary)] border-[rgba(255,255,255,0.1)] p-0\"\n          style={{ width: sheetWidth, maxWidth: '100vw' }}\n        >\n          {/* Resize Handle */}\n          <div\n            className={`absolute left-0 top-0 bottom-0 w-1.5 cursor-ew-resize hover:bg-[var(--accent-primary)]/50 transition-colors z-50 ${isResizing ? 'bg-[var(--accent-primary)]/50' : ''}`}\n            onMouseDown={handleResizeStart}\n          />\n          <div className=\"p-6\">\n          <SheetHeader>\n            <div className=\"flex items-center gap-2 pr-8\">\n              <SheetTitle className=\"flex items-center gap-2 text-[var(--text-primary)] flex-1\">\n                {activeStudyType === 'flashcards' && <><BookOpen className=\"h-5 w-5 text-blue-500\" /> Flashcards</>}\n                {activeStudyType === 'quiz' && <><ListChecks className=\"h-5 w-5 text-purple-500\" /> Quiz</>}\n                {activeStudyType === 'guide' && <><FileText className=\"h-5 w-5 text-orange-500\" /> Study Guide</>}\n                {activeStudyType === 'faq' && <><HelpCircle className=\"h-5 w-5 text-teal-500\" /> FAQ</>}\n                {activeStudyType === 'mindmap' && <><Share2 className=\"h-5 w-5 text-cyan-500\" /> Mind Map</>}\n                {activeStudyType === 'datatable' && <><Table className=\"h-5 w-5 text-emerald-500\" /> Data Table</>}\n                {activeStudyType === 'report' && <><FileSpreadsheet className=\"h-5 w-5 text-blue-500\" /> Report</>}\n                {activeStudyType === 'slides' && <><Presentation className=\"h-5 w-5 text-violet-500\" /> Slide Deck</>}\n                {activeStudyType === 'infographic' && <><ImageIcon className=\"h-5 w-5 text-rose-500\" /> Infographic</>}\n                {activeStudyType === 'audio' && <><Mic className=\"h-5 w-5 text-orange-500\" /> Audio Overview</>}\n                {activeStudyType === 'video' && <><Video className=\"h-5 w-5 text-purple-500\" /> Video Overview</>}\n                {activeStudyType === 'research' && <><Search className=\"h-5 w-5 text-blue-500\" /> Research Report</>}\n              </SheetTitle>\n              <Button\n                variant=\"ghost\"\n                size=\"icon\"\n                className=\"h-8 w-8 shrink-0\"\n                onClick={() => {\n                  if (sheetWidth < 800) {\n                    setSheetWidth(900) // Wide\n                  } else if (sheetWidth < window.innerWidth - 100) {\n                    setSheetWidth(window.innerWidth - 50) // Full\n                  } else {\n                    setSheetWidth(576) // Normal\n                  }\n                }}\n                title={sheetWidth >= window.innerWidth - 100 ? 'Minimize' : 'Expand'}\n              >\n                {sheetWidth >= window.innerWidth - 100 ? (\n                  <Minimize2 className=\"h-4 w-4\" />\n                ) : (\n                  <Maximize2 className=\"h-4 w-4\" />\n                )}\n              </Button>\n            </div>\n            <SheetDescription className=\"text-[var(--text-secondary)]\">\n              {activeStudyType === 'flashcards' && `${flashcards.length} cards generated from your sources`}\n              {activeStudyType === 'quiz' && `${quizQuestions.length} questions to test your knowledge`}\n              {activeStudyType === 'guide' && 'Comprehensive study guide from your sources'}\n              {activeStudyType === 'faq' && `${faqItems.length} frequently asked questions`}\n              {activeStudyType === 'mindmap' && 'Interactive visualization of key concepts'}\n              {activeStudyType === 'datatable' && 'Structured data extracted from your sources'}\n              {activeStudyType === 'report' && 'Professional document from your sources'}\n              {activeStudyType === 'slides' && 'Presentation slides from your sources'}\n              {activeStudyType === 'infographic' && 'AI-generated images visualizing key concepts'}\n              {activeStudyType === 'audio' && 'Podcast-style audio discussion'}\n              {activeStudyType === 'video' && 'Visual explainer video'}\n              {activeStudyType === 'research' && 'Deep web research findings'}\n            </SheetDescription>\n          </SheetHeader>\n\n          <div className=\"mt-6 relative\">\n            {/* Flashcards View */}\n            {activeStudyType === 'flashcards' && (\n              <FlashcardViewer\n                flashcards={flashcards}\n                onClose={() => setStudySheetOpen(false)}\n              />\n            )}\n\n            {/* Quiz View */}\n            {activeStudyType === 'quiz' && (\n              <QuizViewer\n                questions={quizQuestions}\n                onClose={() => setStudySheetOpen(false)}\n              />\n            )}\n\n            {/* Study Guide View */}\n            {activeStudyType === 'guide' && studyGuide && (\n              <StudyGuideViewer\n                guide={studyGuide}\n                onClose={() => setStudySheetOpen(false)}\n              />\n            )}\n\n            {/* FAQ View */}\n            {activeStudyType === 'faq' && (\n              <FAQViewer\n                items={faqItems}\n                onClose={() => setStudySheetOpen(false)}\n              />\n            )}\n\n            {/* Mind Map View */}\n            {activeStudyType === 'mindmap' && mindMap && (\n              <MindMapViewer\n                title={mindMap.title}\n                nodes={mindMap.nodes}\n                onClose={() => setStudySheetOpen(false)}\n              />\n            )}\n\n            {/* Audio View */}\n            {activeStudyType === 'audio' && (\n              <AudioPlayer\n                audio={activeGeneratedAudio ?? null}\n                isGenerating={generatingAudio}\n                onClose={() => setStudySheetOpen(false)}\n              />\n            )}\n\n            {/* Video View */}\n            {activeStudyType === 'video' && (\n              <VideoPlayer\n                video={activeGeneratedVideo ?? null}\n                isGenerating={generatingVideo}\n                onClose={() => setStudySheetOpen(false)}\n              />\n            )}\n\n            {/* Research View */}\n            {activeStudyType === 'research' && (\n              <ResearchReport\n                research={activeGeneratedResearch ?? null}\n                isResearching={researching}\n                onClose={() => setStudySheetOpen(false)}\n              />\n            )}\n\n            {/* Data Table View */}\n            {activeStudyType === 'datatable' && dataTableData && (\n              <div className=\"space-y-4\">\n                <div className=\"p-4 rounded-xl bg-[var(--bg-tertiary)]\">\n                  <h3 className=\"text-lg font-semibold text-[var(--text-primary)] mb-2\">{dataTableData.title}</h3>\n                  <p className=\"text-sm text-[var(--text-secondary)] mb-4\">{dataTableData.description}</p>\n                  <div className=\"overflow-x-auto\">\n                    <table className=\"w-full text-sm\">\n                      <thead>\n                        <tr className=\"border-b border-[rgba(255,255,255,0.1)]\">\n                          {dataTableData.columns.map((col) => (\n                            <th key={col.key} className=\"text-left p-3 font-medium text-[var(--text-primary)]\">\n                              {col.header}\n                            </th>\n                          ))}\n                        </tr>\n                      </thead>\n                      <tbody>\n                        {dataTableData.rows.map((row, idx) => (\n                          <tr key={idx} className=\"border-b border-[rgba(255,255,255,0.05)] hover:bg-[var(--bg-secondary)]\">\n                            {dataTableData.columns.map((col) => (\n                              <td key={col.key} className=\"p-3 text-[var(--text-secondary)]\">\n                                {String(row[col.key] ?? '')}\n                              </td>\n                            ))}\n                          </tr>\n                        ))}\n                      </tbody>\n                    </table>\n                  </div>\n                </div>\n              </div>\n            )}\n\n            {/* Report View */}\n            {activeStudyType === 'report' && reportData && (\n              <div className=\"space-y-6\">\n                <div className=\"p-4 rounded-xl bg-[var(--bg-tertiary)]\">\n                  <h2 className=\"text-xl font-bold text-[var(--text-primary)] mb-4\">{reportData.title}</h2>\n                  <div className=\"p-4 rounded-lg bg-[var(--accent-primary)]/10 border border-[var(--accent-primary)]/20 mb-6\">\n                    <h3 className=\"text-sm font-semibold text-[var(--accent-primary)] mb-2\">Executive Summary</h3>\n                    <p className=\"text-sm text-[var(--text-secondary)]\">{reportData.executive_summary}</p>\n                  </div>\n                  {reportData.sections.map((section, idx) => (\n                    <div key={idx} className=\"mb-6\">\n                      <h3 className=\"text-lg font-semibold text-[var(--text-primary)] mb-2\">{section.heading}</h3>\n                      <p className=\"text-sm text-[var(--text-secondary)] whitespace-pre-wrap\">{section.content}</p>\n                    </div>\n                  ))}\n                  <div className=\"mt-6 p-4 rounded-lg bg-[var(--bg-secondary)]\">\n                    <h3 className=\"text-sm font-semibold text-[var(--text-primary)] mb-2\">Key Takeaways</h3>\n                    <ul className=\"list-disc list-inside space-y-1\">\n                      {reportData.key_takeaways.map((takeaway, idx) => (\n                        <li key={idx} className=\"text-sm text-[var(--text-secondary)]\">{takeaway}</li>\n                      ))}\n                    </ul>\n                  </div>\n                </div>\n              </div>\n            )}\n\n            {/* Slide Deck View */}\n            {activeStudyType === 'slides' && slideDeckData && (\n              <div className=\"space-y-4\">\n                <div className=\"text-center mb-6\">\n                  <h2 className=\"text-xl font-bold text-[var(--text-primary)]\">{slideDeckData.title}</h2>\n                  {slideDeckData.subtitle && (\n                    <p className=\"text-sm text-[var(--text-secondary)] mt-1\">{slideDeckData.subtitle}</p>\n                  )}\n                  <Badge className=\"mt-2 bg-[var(--bg-tertiary)] text-[var(--text-secondary)]\">\n                    {slideDeckData.slides.length} slides\n                  </Badge>\n                </div>\n                <div className=\"space-y-4\">\n                  {slideDeckData.slides.map((slide) => (\n                    <div key={slide.slide_number} className=\"p-4 rounded-xl bg-[var(--bg-tertiary)] border border-[rgba(255,255,255,0.1)]\">\n                      <div className=\"flex items-center gap-2 mb-3\">\n                        <Badge className=\"bg-[var(--accent-primary)]/20 text-[var(--accent-primary)]\">\n                          {slide.slide_number}\n                        </Badge>\n                        <span className=\"text-xs text-[var(--text-tertiary)] uppercase\">{slide.content_type}</span>\n                      </div>\n                      <h3 className=\"text-lg font-semibold text-[var(--text-primary)] mb-2\">{slide.title}</h3>\n                      <p className=\"text-sm text-[var(--text-secondary)] mb-3\">{slide.main_content}</p>\n                      {slide.bullet_points && slide.bullet_points.length > 0 && (\n                        <ul className=\"list-disc list-inside space-y-1 mb-3\">\n                          {slide.bullet_points.map((point, idx) => (\n                            <li key={idx} className=\"text-sm text-[var(--text-secondary)]\">{point}</li>\n                          ))}\n                        </ul>\n                      )}\n                      {slide.speaker_notes && (\n                        <div className=\"mt-3 p-3 rounded-lg bg-[var(--bg-secondary)] text-xs text-[var(--text-tertiary)]\">\n                          <span className=\"font-medium\">Speaker notes:</span> {slide.speaker_notes}\n                        </div>\n                      )}\n                    </div>\n                  ))}\n                </div>\n              </div>\n            )}\n\n            {/* Infographic View */}\n            {activeStudyType === 'infographic' && infographicData && (\n              // Check if it's the new image-based format\n              infographicData.images && infographicData.images.length > 0 ? (\n                <InfographicViewer\n                  data={{\n                    images: infographicData.images,\n                    concepts: infographicData.concepts || []\n                  }}\n                  onClose={() => setStudySheetOpen(false)}\n                />\n              ) : infographicData.color_scheme && infographicData.sections ? (\n                // Legacy format (backward compatibility)\n                <div className=\"space-y-6\">\n                  {/* Header Section */}\n                  <div\n                    className=\"p-8 rounded-2xl text-center\"\n                    style={{\n                      background: `linear-gradient(135deg, ${infographicData.color_scheme[0]}20 0%, ${infographicData.color_scheme[1]}20 100%)`,\n                      borderLeft: `4px solid ${infographicData.color_scheme[0]}`\n                    }}\n                  >\n                    <h2 className=\"text-2xl font-bold text-[var(--text-primary)]\">{infographicData.title}</h2>\n                    {infographicData.subtitle && (\n                      <p className=\"text-base text-[var(--text-secondary)] mt-2\">{infographicData.subtitle}</p>\n                    )}\n                  </div>\n\n                  {/* Render each section based on type */}\n                  {infographicData.sections.map((section, idx) => {\n                    const sectionColor = infographicData.color_scheme![idx % infographicData.color_scheme!.length]\n                    const content = section.content as Record<string, unknown>\n\n                    // Stats Section\n                    if (section.section_type === 'stats' && content.items) {\n                      const items = content.items as Array<{ value: string; label: string; icon?: string }>\n                      return (\n                        <div key={idx} className=\"p-6 rounded-xl bg-[var(--bg-tertiary)]\">\n                          {section.title && <h3 className=\"text-lg font-semibold text-[var(--text-primary)] mb-4\">{section.title}</h3>}\n                          <div className=\"grid grid-cols-3 gap-4\">\n                            {items.map((item, i) => (\n                              <div key={i} className=\"text-center p-4 rounded-lg\" style={{ backgroundColor: `${sectionColor}15` }}>\n                                <div className=\"text-2xl font-bold\" style={{ color: sectionColor }}>{item.value}</div>\n                                <div className=\"text-sm text-[var(--text-secondary)] mt-1\">{item.label}</div>\n                              </div>\n                            ))}\n                          </div>\n                        </div>\n                      )\n                    }\n\n                    // Timeline Section\n                    if (section.section_type === 'timeline' && content.events) {\n                      const events = content.events as Array<{ date: string; title: string; description?: string }>\n                      return (\n                        <div key={idx} className=\"p-6 rounded-xl bg-[var(--bg-tertiary)]\">\n                          {section.title && <h3 className=\"text-lg font-semibold text-[var(--text-primary)] mb-4\">{section.title}</h3>}\n                          <div className=\"space-y-4\">\n                            {events.map((event, i) => (\n                              <div key={i} className=\"flex gap-4\">\n                                <div className=\"flex flex-col items-center\">\n                                  <div className=\"w-3 h-3 rounded-full\" style={{ backgroundColor: sectionColor }} />\n                                  {i < events.length - 1 && <div className=\"w-0.5 flex-1 mt-1\" style={{ backgroundColor: `${sectionColor}40` }} />}\n                                </div>\n                                <div className=\"flex-1 pb-4\">\n                                  <div className=\"font-semibold\" style={{ color: sectionColor }}>{event.date}</div>\n                                  <div className=\"font-medium text-[var(--text-primary)]\">{event.title}</div>\n                                  {event.description && <div className=\"text-sm text-[var(--text-secondary)] mt-1\">{event.description}</div>}\n                                </div>\n                              </div>\n                            ))}\n                          </div>\n                        </div>\n                      )\n                    }\n\n                    // Process/Steps Section\n                    if (section.section_type === 'process' && content.steps) {\n                      const steps = content.steps as Array<{ step: number; title: string; description?: string }>\n                      return (\n                        <div key={idx} className=\"p-6 rounded-xl bg-[var(--bg-tertiary)]\">\n                          {section.title && <h3 className=\"text-lg font-semibold text-[var(--text-primary)] mb-4\">{section.title}</h3>}\n                          <div className=\"space-y-3\">\n                            {steps.map((step, i) => (\n                              <div key={i} className=\"flex gap-4 items-start\">\n                                <div\n                                  className=\"w-8 h-8 rounded-full flex items-center justify-center text-white font-bold text-sm shrink-0\"\n                                  style={{ backgroundColor: sectionColor }}\n                                >\n                                  {step.step}\n                                </div>\n                                <div>\n                                  <div className=\"font-medium text-[var(--text-primary)]\">{step.title}</div>\n                                  {step.description && <div className=\"text-sm text-[var(--text-secondary)] mt-1\">{step.description}</div>}\n                                </div>\n                              </div>\n                            ))}\n                          </div>\n                        </div>\n                      )\n                    }\n\n                    // Comparison Section\n                    if (section.section_type === 'comparison' && content.left && content.right) {\n                      const left = content.left as { label: string; points: string[] }\n                      const right = content.right as { label: string; points: string[] }\n                      return (\n                        <div key={idx} className=\"p-6 rounded-xl bg-[var(--bg-tertiary)]\">\n                          {section.title && <h3 className=\"text-lg font-semibold text-[var(--text-primary)] mb-4\">{section.title}</h3>}\n                          <div className=\"grid grid-cols-2 gap-4\">\n                            <div className=\"p-4 rounded-lg\" style={{ backgroundColor: `${infographicData.color_scheme![0]}15` }}>\n                              <div className=\"font-semibold mb-3\" style={{ color: infographicData.color_scheme![0] }}>{left.label}</div>\n                              <ul className=\"space-y-2\">\n                                {left.points.map((point, i) => (\n                                  <li key={i} className=\"text-sm text-[var(--text-secondary)] flex items-start gap-2\">\n                                    <span style={{ color: infographicData.color_scheme![0] }}>•</span>\n                                    {point}\n                                  </li>\n                                ))}\n                              </ul>\n                            </div>\n                            <div className=\"p-4 rounded-lg\" style={{ backgroundColor: `${infographicData.color_scheme![1]}15` }}>\n                              <div className=\"font-semibold mb-3\" style={{ color: infographicData.color_scheme![1] }}>{right.label}</div>\n                              <ul className=\"space-y-2\">\n                                {right.points.map((point, i) => (\n                                  <li key={i} className=\"text-sm text-[var(--text-secondary)] flex items-start gap-2\">\n                                    <span style={{ color: infographicData.color_scheme![1] }}>•</span>\n                                    {point}\n                                  </li>\n                                ))}\n                              </ul>\n                            </div>\n                          </div>\n                        </div>\n                      )\n                    }\n\n                    // List Section\n                    if (section.section_type === 'list' && content.items) {\n                      const items = content.items as string[]\n                      return (\n                        <div key={idx} className=\"p-6 rounded-xl bg-[var(--bg-tertiary)]\">\n                          {section.title && <h3 className=\"text-lg font-semibold text-[var(--text-primary)] mb-4\">{section.title}</h3>}\n                          <ul className=\"space-y-3\">\n                            {items.map((item, i) => (\n                              <li key={i} className=\"flex items-start gap-3\">\n                                <div\n                                  className=\"w-2 h-2 rounded-full mt-2 shrink-0\"\n                                  style={{ backgroundColor: sectionColor }}\n                                />\n                                <span className=\"text-[var(--text-secondary)]\">{item}</span>\n                              </li>\n                            ))}\n                          </ul>\n                        </div>\n                      )\n                    }\n\n                    // Quote Section\n                    if (section.section_type === 'quote') {\n                      const quote = content.quote as string\n                      const author = content.author as string | undefined\n                      return (\n                        <div\n                          key={idx}\n                          className=\"p-6 rounded-xl\"\n                          style={{\n                            backgroundColor: `${sectionColor}10`,\n                            borderLeft: `4px solid ${sectionColor}`\n                          }}\n                        >\n                          {section.title && <h3 className=\"text-lg font-semibold text-[var(--text-primary)] mb-3\">{section.title}</h3>}\n                          <blockquote className=\"text-lg italic text-[var(--text-primary)]\">\"{quote}\"</blockquote>\n                          {author && <div className=\"mt-2 text-sm text-[var(--text-secondary)]\">— {author}</div>}\n                        </div>\n                      )\n                    }\n\n                    // Default/Header/Footer - simple display\n                    return (\n                      <div key={idx} className=\"p-6 rounded-xl bg-[var(--bg-tertiary)]\">\n                        {section.title && <h3 className=\"text-lg font-semibold text-[var(--text-primary)] mb-2\">{section.title}</h3>}\n                        {typeof content.subtitle === 'string' && <p className=\"text-[var(--text-secondary)]\">{content.subtitle}</p>}\n                        {typeof content.text === 'string' && <p className=\"text-sm text-[var(--text-tertiary)]\">{content.text}</p>}\n                      </div>\n                    )\n                  })}\n\n                  {/* Style suggestion footer */}\n                  <p className=\"text-xs text-[var(--text-tertiary)] text-center italic pt-4 border-t border-[rgba(255,255,255,0.1)]\">\n                    Design suggestion: {infographicData.style_suggestion}\n                  </p>\n                </div>\n              ) : (\n                <div className=\"text-center py-12 text-[var(--text-tertiary)]\">\n                  <ImageIcon className=\"h-12 w-12 mx-auto mb-4 opacity-50\" />\n                  <p>No infographic data available</p>\n                </div>\n              )\n            )}\n          </div>\n          </div>\n        </SheetContent>\n      </Sheet>\n\n      {/* Hidden file input */}\n      <input\n        ref={fileInputRef}\n        type=\"file\"\n        accept=\".pdf,.docx,.txt,.md\"\n        className=\"hidden\"\n      />\n\n      {/* Notebook Settings Dialog */}\n      <NotebookSettingsDialog\n        open={settingsOpen}\n        onOpenChange={setSettingsOpen}\n        settings={notebookSettings}\n        onSave={saveNotebookSettings}\n        notebookName={notebook?.name || 'Notebook'}\n      />\n    </div>\n  )\n}\n","structuredPatch":[{"oldStart":910,"oldLines":6,"newStart":910,"newLines":30,"lines":["     setResearching(false)","   }"," ","+  // Export notebook handler","+  const handleExportNotebook = async (format: 'zip' | 'pdf' | 'json', options: ExportOptionsState) => {","+    setExportingNotebook(true)","+    try {","+      const { data: { session } } = await supabase.auth.getSession()","+      if (!session?.access_token) {","+        throw new Error('Not authenticated')","+      }","+","+      await exportNotebook(notebookId, {","+        format,","+        includeSources: options.includeSources,","+        includeChats: options.includeChats,","+        includeNotes: options.includeNotes,","+        includeGenerated: options.includeGenerated,","+      }, session.access_token)","+    } catch (error) {","+      console.error('Export failed:', error)","+      alert('Export failed. Please try again.')","+    } finally {","+      setExportingNotebook(false)","+    }","+  }","+","   // Study material generation handlers","   const handleGenerateFlashcards = async () => {","     setGeneratingState('flashcards', true)"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"5d5b4352-1fd6-4110-ab88-1b546ef4e7f0"}
{"parentUuid":"79279ae6-ada0-48c3-bce4-01546cc0310d","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","message":{"model":"claude-opus-4-5-20251101","id":"msg_01RsqB78GVxHaNNETwXQvq8n","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Now I need to pass the export props to the StudioPanel component. Let me find where the StudioPanel is used and add the export props.","signature":"Eq4CCkYICxgCKkD0wogvJ4TIvVj8/K7Niao0vmuooB+6jfmWUoJhlF9LPqm/KJL+WscgvAJWYh1B/lKtAbFiTckVZrfIFvF6HaduEgx8mfH3qgIAElJXPZUaDIAiJgln9ytSc7PmKCIw0lyJoHwKG4pLuksxqT8n/0AIUvnBE2xzWRKPVBkDlUvpjxQRFLN3bNOOdVVXNA2XKpUBS82/8G+gh+m0Gld0OPvwBmG7sdhJzD8T3V2bGBXbFLamuhQo2fvzA/0ixjE3EdBaiBq+ifbDRj241AhOUQB62FbsZaasJeTDzwoxsBstOus4CmKneN1K5Fi0vJ7yWfs2q9MRhfWH3ACDl17v/l5siKrFwSSs1NCoDwEUd+JVFy8dFHrzov5JZInO8eEVawnCC9EcA+oYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":973,"cache_read_input_tokens":134432,"cache_creation":{"ephemeral_5m_input_tokens":973,"ephemeral_1h_input_tokens":0},"output_tokens":5,"service_tier":"standard"}},"requestId":"req_011CWz6c1i5WqS89k143UxWT","type":"assistant","uuid":"fa0acdcf-06a6-4ded-8e4d-3b31fbd8b8b8","timestamp":"2026-01-10T17:32:40.929Z"}
{"parentUuid":"fa0acdcf-06a6-4ded-8e4d-3b31fbd8b8b8","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","message":{"model":"claude-opus-4-5-20251101","id":"msg_01RsqB78GVxHaNNETwXQvq8n","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01J6ene5zxZ29BPj46E1nUrp","name":"Edit","input":{"replace_all":false,"file_path":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend/src/app/notebooks/[id]/page.tsx","old_string":"              onOpenAudio={() => { setActiveStudyType('audio'); setStudySheetOpen(true) }}\n              onOpenVideo={() => { setActiveStudyType('video'); setStudySheetOpen(true) }}\n              onOpenResearch={() => { setActiveStudyType('research'); setStudySheetOpen(true) }}\n            />","new_string":"              onOpenAudio={() => { setActiveStudyType('audio'); setStudySheetOpen(true) }}\n              onOpenVideo={() => { setActiveStudyType('video'); setStudySheetOpen(true) }}\n              onOpenResearch={() => { setActiveStudyType('research'); setStudySheetOpen(true) }}\n              onExportNotebook={handleExportNotebook}\n              exportingNotebook={exportingNotebook}\n            />"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":973,"cache_read_input_tokens":134432,"cache_creation":{"ephemeral_5m_input_tokens":973,"ephemeral_1h_input_tokens":0},"output_tokens":372,"service_tier":"standard"}},"requestId":"req_011CWz6c1i5WqS89k143UxWT","type":"assistant","uuid":"7a8b6efd-5b90-4cfc-9923-e798c87d7123","timestamp":"2026-01-10T17:32:43.696Z"}
{"parentUuid":"7a8b6efd-5b90-4cfc-9923-e798c87d7123","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","type":"user","message":{"role":"user","content":[{"type":"tool_result","content":"<tool_use_error>File has been modified since read, either by the user or by a linter. Read it again before attempting to write it.</tool_use_error>","is_error":true,"tool_use_id":"toolu_01J6ene5zxZ29BPj46E1nUrp"}]},"uuid":"5ed0668e-6054-4e9d-84d3-d7a52b193064","timestamp":"2026-01-10T17:32:43.709Z","toolUseResult":"Error: File has been modified since read, either by the user or by a linter. Read it again before attempting to write it.","sourceToolAssistantUUID":"7a8b6efd-5b90-4cfc-9923-e798c87d7123"}
{"parentUuid":"5ed0668e-6054-4e9d-84d3-d7a52b193064","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","message":{"model":"claude-opus-4-5-20251101","id":"msg_018PRXR5kijoKbXtQAFuWSuY","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"The file was modified (likely by a linter). Let me re-read the file and make the edit again.","signature":"EoQCCkYICxgCKkAV5L5dTMAYTgoO4u8sb0FQycIDseyOut/tokiSWgsZ5hgLvMEV4C5ghy5iJBzT/6t2IEqjaoXbvM6q2A7DtjwfEgzsuH/MfMUOMtD3vcUaDDkhtr0LKr1EouvaTyIwDM/h/JMTUAIbr5Ox/5xJ3Z9aJ0UcwUaXgdiW9Be1V3DFth152ksQ8SLNEgZti/xzKmzXOv6POEoeNQ2KqAVX/KOVv3AudiPg4KwZhCrrWwNkMcaIpp6UklO+6YQ+REg5b0ONUZRPDiHbjVEFfCb7fYW1+8NMomrFpOlB2HmSsJDCX3VR+qFljfmlrHdZ76pOx5C5V44dI+aWsoOsxDIYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":743,"cache_read_input_tokens":135405,"cache_creation":{"ephemeral_5m_input_tokens":743,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWz6camfj6ca1gJHvR9zL","type":"assistant","uuid":"1214ced5-63c2-452f-a3c7-04aa76cbf793","timestamp":"2026-01-10T17:32:49.256Z"}
{"parentUuid":"1214ced5-63c2-452f-a3c7-04aa76cbf793","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","message":{"model":"claude-opus-4-5-20251101","id":"msg_018PRXR5kijoKbXtQAFuWSuY","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01YSdTuZuuvhQ1rkE3q2Lf7y","name":"Grep","input":{"pattern":"onOpenResearch=\\{\\(\\) => \\{ setActiveStudyType\\('research'\\)","path":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend/src/app/notebooks/[id]/page.tsx","output_mode":"content"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":743,"cache_read_input_tokens":135405,"cache_creation":{"ephemeral_5m_input_tokens":743,"ephemeral_1h_input_tokens":0},"output_tokens":177,"service_tier":"standard"}},"requestId":"req_011CWz6camfj6ca1gJHvR9zL","type":"assistant","uuid":"d8c56a25-e361-41c1-88a9-06b3c9e8f9b6","timestamp":"2026-01-10T17:32:50.512Z"}
{"parentUuid":"d8c56a25-e361-41c1-88a9-06b3c9e8f9b6","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01YSdTuZuuvhQ1rkE3q2Lf7y","type":"tool_result","content":"1629:              onOpenResearch={() => { setActiveStudyType('research'); setStudySheetOpen(true) }}"}]},"uuid":"02173255-d43a-4cf1-8620-53897de92fe7","timestamp":"2026-01-10T17:32:50.572Z","toolUseResult":{"mode":"content","numFiles":0,"filenames":[],"content":"1629:              onOpenResearch={() => { setActiveStudyType('research'); setStudySheetOpen(true) }}","numLines":1},"sourceToolAssistantUUID":"d8c56a25-e361-41c1-88a9-06b3c9e8f9b6"}
{"parentUuid":"02173255-d43a-4cf1-8620-53897de92fe7","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","message":{"model":"claude-opus-4-5-20251101","id":"msg_01VymzfKqMs7PhfdX39Pzdpe","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Let me read the file around that line to make the edit.","signature":"Et8BCkYICxgCKkAwGZhrVK8QZwCnesBVREuLcnwXBZYyfAxyN6YZ3gn2zjjJcej/RCAZPwDMkJYSm+lTFg4ZW4Dp1TGISYDdEFWxEgy1FH0KAZANno0tSloaDHVs//lL49od6vQDGiIw9ZRhB+7xD8yn9u51sMU8mTO+Ihr0gLWq2bW1uO7U0OqAeh4+WXoUTonPbqRc9w2gKkciS41Hz1piI6pBZ0h6Cy7l5zIKTP7ChHSHBf8poTValCNLaR/DmwVe0voor3DVOxiTKmIqKqWrDha2lLa/ur995hxujeufuhgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":224,"cache_read_input_tokens":136148,"cache_creation":{"ephemeral_5m_input_tokens":224,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CWz6dCqLhM6fLdty3PVFu","type":"assistant","uuid":"aea5afb8-95bd-4bf7-b398-b8cceae9ed08","timestamp":"2026-01-10T17:32:57.664Z"}
{"parentUuid":"aea5afb8-95bd-4bf7-b398-b8cceae9ed08","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","message":{"model":"claude-opus-4-5-20251101","id":"msg_01VymzfKqMs7PhfdX39Pzdpe","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01YBCtkCcuZKW7w7KhSoSfNs","name":"Read","input":{"file_path":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend/src/app/notebooks/[id]/page.tsx","offset":1625,"limit":20}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":224,"cache_read_input_tokens":136148,"cache_creation":{"ephemeral_5m_input_tokens":224,"ephemeral_1h_input_tokens":0},"output_tokens":146,"service_tier":"standard"}},"requestId":"req_011CWz6dCqLhM6fLdty3PVFu","type":"assistant","uuid":"0af26758-97e3-4d2b-b61a-2ab01afd20e8","timestamp":"2026-01-10T17:32:58.406Z"}
{"parentUuid":"0af26758-97e3-4d2b-b61a-2ab01afd20e8","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01YBCtkCcuZKW7w7KhSoSfNs","type":"tool_result","content":"  1625→              hasGeneratedVideo={!!activeGeneratedVideo}\n  1626→              hasGeneratedResearch={!!activeGeneratedResearch}\n  1627→              onOpenAudio={() => { setActiveStudyType('audio'); setStudySheetOpen(true) }}\n  1628→              onOpenVideo={() => { setActiveStudyType('video'); setStudySheetOpen(true) }}\n  1629→              onOpenResearch={() => { setActiveStudyType('research'); setStudySheetOpen(true) }}\n  1630→            />\n  1631→          }\n  1632→        />\n  1633→      </div>\n  1634→\n  1635→      {/* Source Preview Dialog */}\n  1636→      <Dialog open={!!viewingSource} onOpenChange={(open) => !open && setViewingSource(null)}>\n  1637→        <DialogContent className=\"sm:max-w-lg bg-[var(--bg-secondary)] border-[rgba(255,255,255,0.1)]\">\n  1638→          <DialogHeader>\n  1639→            <DialogTitle className=\"flex items-center gap-3 text-[var(--text-primary)]\">\n  1640→              <div className=\"w-10 h-10 rounded-lg bg-[var(--bg-tertiary)] flex items-center justify-center\">\n  1641→                <FileText className=\"h-5 w-5\" />\n  1642→              </div>\n  1643→              {viewingSource?.name}\n  1644→            </DialogTitle>\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"56c1e705-6af5-4bad-a473-8181e2118bbe","timestamp":"2026-01-10T17:32:58.473Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend/src/app/notebooks/[id]/page.tsx","content":"              hasGeneratedVideo={!!activeGeneratedVideo}\n              hasGeneratedResearch={!!activeGeneratedResearch}\n              onOpenAudio={() => { setActiveStudyType('audio'); setStudySheetOpen(true) }}\n              onOpenVideo={() => { setActiveStudyType('video'); setStudySheetOpen(true) }}\n              onOpenResearch={() => { setActiveStudyType('research'); setStudySheetOpen(true) }}\n            />\n          }\n        />\n      </div>\n\n      {/* Source Preview Dialog */}\n      <Dialog open={!!viewingSource} onOpenChange={(open) => !open && setViewingSource(null)}>\n        <DialogContent className=\"sm:max-w-lg bg-[var(--bg-secondary)] border-[rgba(255,255,255,0.1)]\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-3 text-[var(--text-primary)]\">\n              <div className=\"w-10 h-10 rounded-lg bg-[var(--bg-tertiary)] flex items-center justify-center\">\n                <FileText className=\"h-5 w-5\" />\n              </div>\n              {viewingSource?.name}\n            </DialogTitle>","numLines":20,"startLine":1625,"totalLines":2187}},"sourceToolAssistantUUID":"0af26758-97e3-4d2b-b61a-2ab01afd20e8"}
{"parentUuid":"56c1e705-6af5-4bad-a473-8181e2118bbe","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","message":{"model":"claude-opus-4-5-20251101","id":"msg_013yb2MpacP3BUknZx2zgHDf","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Good, now I can make the edit.","signature":"EsYBCkYICxgCKkCw5LEZq6Xf2MXEloPAAhQIkB4Jt5Q6KgLFzPnPJXsB+nL3s/d7dSdfqiQfBTBHoOKlFyHqTet+2XU7OhCMpbDkEgy08q6R+0Fsgu9HebgaDJQPtFS7kjoTHupzCSIwPXs9vYpNsz9O1JUiIE79g+YqwqCp2cgn4uGF2pyFqWoAsLyzjdlhXMgrwcqr15BUKi48I+lHphb/m12xYqaIdlbAKU7D9oj94secBVLsWwNRX/AvEpWy4X0qyRp3XsZYGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":629,"cache_read_input_tokens":136372,"cache_creation":{"ephemeral_5m_input_tokens":629,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWz6djoRCQcxQDCGiXNa7","type":"assistant","uuid":"492d8ad4-c461-4e4e-82d0-cef2c36f0e1b","timestamp":"2026-01-10T17:33:04.725Z"}
{"parentUuid":"492d8ad4-c461-4e4e-82d0-cef2c36f0e1b","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","message":{"model":"claude-opus-4-5-20251101","id":"msg_013yb2MpacP3BUknZx2zgHDf","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01NTDsnqBYVx8rXubpkZSGRR","name":"Edit","input":{"replace_all":false,"file_path":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend/src/app/notebooks/[id]/page.tsx","old_string":"              onOpenAudio={() => { setActiveStudyType('audio'); setStudySheetOpen(true) }}\n              onOpenVideo={() => { setActiveStudyType('video'); setStudySheetOpen(true) }}\n              onOpenResearch={() => { setActiveStudyType('research'); setStudySheetOpen(true) }}\n            />\n          }\n        />","new_string":"              onOpenAudio={() => { setActiveStudyType('audio'); setStudySheetOpen(true) }}\n              onOpenVideo={() => { setActiveStudyType('video'); setStudySheetOpen(true) }}\n              onOpenResearch={() => { setActiveStudyType('research'); setStudySheetOpen(true) }}\n              onExportNotebook={handleExportNotebook}\n              exportingNotebook={exportingNotebook}\n            />\n          }\n        />"}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":629,"cache_read_input_tokens":136372,"cache_creation":{"ephemeral_5m_input_tokens":629,"ephemeral_1h_input_tokens":0},"output_tokens":362,"service_tier":"standard"}},"requestId":"req_011CWz6djoRCQcxQDCGiXNa7","type":"assistant","uuid":"bcd779cf-2eb2-4995-97da-7ea38a26ed51","timestamp":"2026-01-10T17:33:06.702Z"}
{"parentUuid":"bcd779cf-2eb2-4995-97da-7ea38a26ed51","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01NTDsnqBYVx8rXubpkZSGRR","type":"tool_result","content":"The file /Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend/src/app/notebooks/[id]/page.tsx has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n  1623→              onAddNote={() => setAddNoteOpen(true)}\n  1624→              hasGeneratedAudio={!!activeGeneratedAudio}\n  1625→              hasGeneratedVideo={!!activeGeneratedVideo}\n  1626→              hasGeneratedResearch={!!activeGeneratedResearch}\n  1627→              onOpenAudio={() => { setActiveStudyType('audio'); setStudySheetOpen(true) }}\n  1628→              onOpenVideo={() => { setActiveStudyType('video'); setStudySheetOpen(true) }}\n  1629→              onOpenResearch={() => { setActiveStudyType('research'); setStudySheetOpen(true) }}\n  1630→              onExportNotebook={handleExportNotebook}\n  1631→              exportingNotebook={exportingNotebook}\n  1632→            />\n  1633→          }\n  1634→        />\n  1635→      </div>\n  1636→\n  1637→      {/* Source Preview Dialog */}\n  1638→      <Dialog open={!!viewingSource} onOpenChange={(open) => !open && setViewingSource(null)}>"}]},"uuid":"7e0157c4-0dc1-4e24-9469-4f90f8f09fc5","timestamp":"2026-01-10T17:33:06.743Z","toolUseResult":{"filePath":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend/src/app/notebooks/[id]/page.tsx","oldString":"              onOpenAudio={() => { setActiveStudyType('audio'); setStudySheetOpen(true) }}\n              onOpenVideo={() => { setActiveStudyType('video'); setStudySheetOpen(true) }}\n              onOpenResearch={() => { setActiveStudyType('research'); setStudySheetOpen(true) }}\n            />\n          }\n        />","newString":"              onOpenAudio={() => { setActiveStudyType('audio'); setStudySheetOpen(true) }}\n              onOpenVideo={() => { setActiveStudyType('video'); setStudySheetOpen(true) }}\n              onOpenResearch={() => { setActiveStudyType('research'); setStudySheetOpen(true) }}\n              onExportNotebook={handleExportNotebook}\n              exportingNotebook={exportingNotebook}\n            />\n          }\n        />","originalFile":"'use client'\n\nimport { useEffect, useState, useRef } from 'react'\nimport { useParams, useRouter, useSearchParams } from 'next/navigation'\nimport { motion, AnimatePresence } from 'framer-motion'\nimport { createClient, Notebook, Source, ChatMessage } from '@/lib/supabase'\nimport { chatApi } from '@/lib/api'\nimport { Button } from '@/components/ui/button'\nimport { Input } from '@/components/ui/input'\nimport { Textarea } from '@/components/ui/textarea'\nimport { Badge } from '@/components/ui/badge'\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n} from '@/components/ui/dialog'\nimport {\n  Sheet,\n  SheetContent,\n  SheetDescription,\n  SheetHeader,\n  SheetTitle,\n} from '@/components/ui/sheet'\nimport {\n  ArrowLeft, Loader2, Sparkles, X, RotateCcw,\n  BookOpen, ListChecks, FileText, HelpCircle, Mic, Video, Search, Share2,\n  Maximize2, Minimize2, Table, FileSpreadsheet, Presentation, Image as ImageIcon,\n  History, Settings\n} from 'lucide-react'\n// Toast notifications removed per user request\n// import { toast } from 'sonner'\nimport { User } from '@supabase/supabase-js'\n\nimport { ThreePanelLayout } from '@/components/panels/three-panel-layout'\nimport { SourcesPanel } from '@/components/sources/sources-panel'\nimport { ChatPanel } from '@/components/chat/chat-panel'\nimport { StudioPanel, ExportOptionsState } from '@/components/studio/studio-panel'\nimport type { GenerationConfig } from '@/components/studio/generation-config-dialog'\nimport { exportNotebook } from '@/lib/export-utils'\nimport {\n  useNotebook,\n  useSources,\n  useNotes,\n  useChatSessions,\n  useGeneratedAudio,\n  useGeneratedVideo,\n  useGeneratedResearch,\n  useStudyMaterials,\n  useCreativeOutputs,\n  useInvalidateNotebook,\n} from '@/lib/hooks/use-notebook-queries'\n\n// Study viewers\nimport { FlashcardViewer } from '@/components/study/flashcard-viewer'\nimport { QuizViewer } from '@/components/study/quiz-viewer'\nimport { StudyGuideViewer } from '@/components/study/study-guide-viewer'\nimport { FAQViewer } from '@/components/study/faq-viewer'\nimport { MindMapViewer } from '@/components/study/mind-map-viewer'\n\n// Studio viewers\nimport { AudioPlayer } from '@/components/studio/audio-player'\nimport { VideoPlayer } from '@/components/studio/video-player'\nimport { ResearchReport } from '@/components/studio/research-report'\nimport { InfographicViewer } from '@/components/studio/infographic-viewer'\n\n// Notebook settings\nimport { NotebookSettingsDialog, NotebookSettings } from '@/components/notebook/notebook-settings'\n\ninterface LocalNote {\n  id: string\n  notebook_id: string\n  type: 'written' | 'saved_response'\n  title: string | null\n  content: string | null\n  tags: string[]\n  is_pinned: boolean\n  created_at: string\n  updated_at: string\n}\n\nexport default function NotebookPage() {\n  const params = useParams()\n  const router = useRouter()\n  const searchParams = useSearchParams()\n  const notebookId = params.id as string\n  const supabase = createClient()\n\n  // Core state - React Query for cached data\n  const [user, setUser] = useState<User | null>(null)\n  const [authChecked, setAuthChecked] = useState(false)\n  const [messages, setMessages] = useState<ChatMessage[]>([])\n\n  // React Query hooks for cached data\n  const { data: notebook, isLoading: notebookLoading } = useNotebook(notebookId)\n  const { data: sources = [], isLoading: sourcesLoading } = useSources(notebookId)\n  const { data: notes = [], isLoading: notesLoading } = useNotes(notebookId)\n  const { data: chatSessions = [], isLoading: loadingSessions } = useChatSessions(notebookId)\n  const { data: generatedAudio } = useGeneratedAudio(notebookId)\n  const { data: generatedVideo } = useGeneratedVideo(notebookId)\n  const { data: generatedResearch } = useGeneratedResearch(notebookId)\n  const { data: studyMaterialsData } = useStudyMaterials(notebookId, sources.map(s => ({ id: s.id, name: s.name })))\n  const { data: creativeOutputsData } = useCreativeOutputs(notebookId)\n  const invalidate = useInvalidateNotebook()\n\n  // Derived loading state\n  const loading = !authChecked || notebookLoading || sourcesLoading || notesLoading\n\n  // Chat state\n  const [sending, setSending] = useState(false)\n  const [message, setMessage] = useState('')\n  const [selectedSources, setSelectedSources] = useState<Set<string>>(new Set())\n  const [sessionId, setSessionId] = useState<string | null>(null)\n\n  // Source state\n  const [viewingSource, setViewingSource] = useState<Source | null>(null)\n  const [uploading, setUploading] = useState(false)\n\n  // Notes state\n  const [addNoteOpen, setAddNoteOpen] = useState(false)\n  const [noteTitle, setNoteTitle] = useState('')\n  const [noteContent, setNoteContent] = useState('')\n  const [savingNote, setSavingNote] = useState(false)\n\n  // Settings state\n  const [settingsOpen, setSettingsOpen] = useState(false)\n  const [notebookSettings, setNotebookSettings] = useState<NotebookSettings | null>(null)\n\n  // Audio state\n  const [audioFormat, setAudioFormat] = useState('deep_dive')\n  const [audioInstructions, setAudioInstructions] = useState('')\n  const [generatingAudio, setGeneratingAudio] = useState(false)\n\n  // Video state\n  const [videoStyle, setVideoStyle] = useState('explainer')\n  const [generatingVideo, setGeneratingVideo] = useState(false)\n\n  // Research state\n  const [researchQuery, setResearchQuery] = useState('')\n  const [researchMode, setResearchMode] = useState('fast')\n  const [researching, setResearching] = useState(false)\n\n  // Export state\n  const [exportingNotebook, setExportingNotebook] = useState(false)\n\n  // Consolidated generating states - single object to reduce re-renders\n  const [generating, setGenerating] = useState({\n    flashcards: false,\n    quiz: false,\n    studyGuide: false,\n    faq: false,\n    mindMap: false,\n    dataTable: false,\n    report: false,\n    slideDeck: false,\n    infographic: false,\n  })\n\n  // Helper to update single generating state\n  const setGeneratingState = (key: keyof typeof generating, value: boolean) => {\n    setGenerating(prev => ({ ...prev, [key]: value }))\n  }\n\n  // Study results\n  const [flashcards, setFlashcards] = useState<Array<{ id: string; front: string; back: string }>>([])\n  const [quizQuestions, setQuizQuestions] = useState<Array<{ id: string; question: string; options: string[]; correct_index: number; explanation: string }>>([])\n  const [studyGuide, setStudyGuide] = useState<{ title: string; sections: Array<{ heading: string; content: string }> } | null>(null)\n  const [faqItems, setFaqItems] = useState<Array<{ question: string; answer: string }>>([])\n  const [mindMap, setMindMap] = useState<{ title: string; nodes: Array<{ id: string; label: string; description?: string; children?: Array<{ id: string; label: string; description?: string; children?: Array<{ id: string; label: string; description?: string }> }> }> } | null>(null)\n\n  // Creative outputs data\n  const [dataTableData, setDataTableData] = useState<{\n    title: string\n    description: string\n    columns: Array<{ header: string; key: string; type: string }>\n    rows: Array<Record<string, string | number | boolean>>\n  } | null>(null)\n  const [reportData, setReportData] = useState<{\n    title: string\n    executive_summary: string\n    sections: Array<{ heading: string; content: string }>\n    key_takeaways: string[]\n  } | null>(null)\n  const [slideDeckData, setSlideDeckData] = useState<{\n    title: string\n    subtitle?: string\n    slides: Array<{ slide_number: number; title: string; content_type: string; main_content: string; bullet_points?: string[]; speaker_notes?: string }>\n    theme_suggestion: string\n  } | null>(null)\n  // Infographic data - supports new image-based format\n  const [infographicData, setInfographicData] = useState<{\n    // New image-based format\n    images?: Array<{ title: string; prompt: string; imageData: string; mimeType: string }>\n    concepts?: string[]\n    // Legacy format (for backward compatibility)\n    title?: string\n    subtitle?: string\n    color_scheme?: string[]\n    sections?: Array<{ section_type: string; title?: string; content: Record<string, unknown> }>\n    style_suggestion?: string\n  } | null>(null)\n\n  // Study materials metadata (for UI display)\n  const [studyMaterialsMeta, setStudyMaterialsMeta] = useState<Array<{\n    id: string\n    type: string\n    sourceIds: string[]\n    sourceNames: string[]\n    createdAt: string\n    itemCount?: number\n  }>>([])\n\n  // Creative outputs metadata (for UI display)\n  const [creativeOutputsMeta, setCreativeOutputsMeta] = useState<Array<{\n    id: string\n    type: string\n    title: string\n    status: string\n    createdAt: string\n    content?: Record<string, unknown>\n  }>>([])\n\n  const [currentFlashcard, setCurrentFlashcard] = useState(0)\n  const [showFlashcardBack, setShowFlashcardBack] = useState(false)\n  const [currentQuizQuestion, setCurrentQuizQuestion] = useState(0)\n  const [selectedAnswer, setSelectedAnswer] = useState<number | null>(null)\n  const [showQuizAnswer, setShowQuizAnswer] = useState(false)\n\n  // Study materials sheet\n  const [studySheetOpen, setStudySheetOpen] = useState(false)\n  const [sheetWidth, setSheetWidth] = useState(576) // Default width in pixels\n  const [isResizing, setIsResizing] = useState(false)\n  const [activeStudyType, setActiveStudyType] = useState<'flashcards' | 'quiz' | 'guide' | 'faq' | 'mindmap' | 'audio' | 'video' | 'research' | 'datatable' | 'report' | 'slides' | 'infographic' | null>(null)\n\n  // Local state for newly generated content (overrides cached until next fetch)\n  const [localGeneratedAudio, setLocalGeneratedAudio] = useState<typeof generatedAudio | null>(null)\n  const [localGeneratedVideo, setLocalGeneratedVideo] = useState<typeof generatedVideo | null>(null)\n  const [localGeneratedResearch, setLocalGeneratedResearch] = useState<{\n    id: string\n    query: string\n    mode: string\n    status: string\n    progress_message?: string\n    sources_found_count?: number\n    sources_analyzed_count?: number\n    report_content?: string\n    report_citations?: { title: string; url: string }[]\n    created_at: string\n    completed_at?: string\n  } | null>(null)\n\n  // Use local state if set, otherwise use cached data\n  const activeGeneratedAudio = localGeneratedAudio ?? generatedAudio\n  const activeGeneratedVideo = localGeneratedVideo ?? generatedVideo\n  const activeGeneratedResearch = localGeneratedResearch ?? generatedResearch\n\n  // File input ref\n  const fileInputRef = useRef<HTMLInputElement>(null)\n\n  // Initialize - just check auth, React Query handles data fetching\n  useEffect(() => {\n    const init = async () => {\n      const { data: { user } } = await supabase.auth.getUser()\n      if (!user) {\n        router.push('/auth/login')\n        return\n      }\n      setUser(user)\n      setAuthChecked(true)\n    }\n    init()\n  }, [notebookId])\n\n\n  // Load a chat session\n  const loadChatSession = async (loadSessionId: string) => {\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n      const response = await fetch(`/api/notebooks/${notebookId}/chat/sessions/${loadSessionId}`, {\n        headers: {\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n      })\n      const result = await response.json()\n      if (result.data) {\n        setSessionId(loadSessionId)\n        setMessages(result.data.messages || [])\n      }\n    } catch (error) {\n      console.error('Failed to load chat session:', error)\n      \n    }\n  }\n\n  // Start a new chat\n  const startNewChat = () => {\n    setSessionId(null)\n    setMessages([])\n    setMessage('')\n  }\n\n  // Delete a chat session\n  const deleteChatSession = async (deleteSessionId: string) => {\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n      const response = await fetch(`/api/notebooks/${notebookId}/chat/sessions/${deleteSessionId}`, {\n        method: 'DELETE',\n        headers: {\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n      })\n      if (response.ok) {\n        // Invalidate cache to refresh the list\n        invalidate.invalidateChatSessions(notebookId)\n\n        // If we deleted the current session, start a new chat\n        if (deleteSessionId === sessionId) {\n          startNewChat()\n        }\n      }\n    } catch (error) {\n      console.error('Failed to delete chat session:', error)\n\n    }\n  }\n\n  // Rename a chat session\n  const renameChatSession = async (renameSessionId: string, newTitle: string) => {\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n      const response = await fetch(`/api/notebooks/${notebookId}/chat/sessions/${renameSessionId}`, {\n        method: 'PATCH',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n        body: JSON.stringify({ title: newTitle }),\n      })\n      if (response.ok) {\n        // Invalidate cache to refresh the list\n        invalidate.invalidateChatSessions(notebookId)\n      }\n    } catch (error) {\n      console.error('Failed to rename chat session:', error)\n    }\n  }\n\n  // Load selected sources from localStorage after sources are loaded\n  useEffect(() => {\n    if (sources.length > 0 && !loading) {\n      const savedSelection = localStorage.getItem(`notebook-${notebookId}-selected-sources`)\n      if (savedSelection) {\n        try {\n          const savedIds = JSON.parse(savedSelection) as string[]\n          // Only select sources that still exist\n          const validIds = savedIds.filter(id => sources.some(s => s.id === id))\n          if (validIds.length > 0) {\n            setSelectedSources(new Set(validIds))\n          }\n        } catch {\n          // Invalid JSON, ignore\n        }\n      }\n    }\n  }, [sources, loading, notebookId])\n\n  // Save selected sources to localStorage whenever they change\n  useEffect(() => {\n    if (!loading && sources.length > 0) {\n      const selectedArray = Array.from(selectedSources)\n      localStorage.setItem(`notebook-${notebookId}-selected-sources`, JSON.stringify(selectedArray))\n    }\n  }, [selectedSources, notebookId, loading, sources.length])\n\n  // Handle view and itemId query params from history page navigation\n  useEffect(() => {\n    const view = searchParams.get('view')\n    const itemId = searchParams.get('itemId')\n\n    if (view && !loading) {\n      // Map view param to activeStudyType\n      const typeMap: Record<string, typeof activeStudyType> = {\n        audio: 'audio',\n        video: 'video',\n        research: 'research',\n        datatable: 'datatable',\n        report: 'report',\n        slides: 'slides',\n        infographic: 'infographic',\n        flashcards: 'flashcards',\n        quiz: 'quiz',\n        guide: 'guide',\n        faq: 'faq',\n        mindmap: 'mindmap',\n      }\n      const studyType = typeMap[view]\n      if (studyType) {\n        setActiveStudyType(studyType)\n        setStudySheetOpen(true)\n\n        // Clear the query params after handling\n        router.replace(`/notebooks/${notebookId}`, { scroll: false })\n      }\n    }\n  }, [searchParams, loading, notebookId, router])\n\n\n  // Fetch existing creative outputs (data tables, reports, slides, infographics)\n  const fetchCreativeOutputs = async () => {\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n      const response = await fetch(`/api/notebooks/${notebookId}/studio`, {\n        headers: {\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n      })\n      const result = await response.json()\n\n      if (result.data && Array.isArray(result.data)) {\n        // Group by type and get the latest of each\n        const outputsByType: Record<string, typeof result.data[0]> = {}\n        for (const output of result.data) {\n          if (output.status === 'completed' && !outputsByType[output.type]) {\n            outputsByType[output.type] = output\n          }\n        }\n\n        // Build metadata array\n        const metaArray = Object.values(outputsByType).map((output) => ({\n          id: output.id,\n          type: output.type,\n          title: output.title || output.type.replace('_', ' '),\n          status: output.status,\n          createdAt: output.created_at,\n          content: output.content,\n        }))\n        setCreativeOutputsMeta(metaArray)\n\n        // Populate state with the latest content of each type\n        for (const output of Object.values(outputsByType)) {\n          if (output.type === 'data_table' && output.content) {\n            setDataTableData(output.content as typeof dataTableData)\n          } else if (output.type === 'report' && output.content) {\n            setReportData(output.content as typeof reportData)\n          } else if (output.type === 'slide_deck' && output.content) {\n            setSlideDeckData(output.content as typeof slideDeckData)\n          } else if (output.type === 'infographic' && output.content) {\n            setInfographicData(output.content as typeof infographicData)\n          }\n        }\n      }\n    } catch (error) {\n      console.error('Failed to fetch creative outputs:', error)\n    }\n  }\n\n  // Fetch existing study materials from Supabase\n  const fetchStudyMaterials = async (sourcesData?: Source[]) => {\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n      const response = await fetch(`/api/notebooks/${notebookId}/study`, {\n        headers: {\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n      })\n      const result = await response.json()\n\n      if (result.data && Array.isArray(result.data)) {\n        // Group materials by type and get the latest of each\n        const materialsByType: Record<string, typeof result.data[0]> = {}\n        for (const material of result.data) {\n          if (!materialsByType[material.type]) {\n            materialsByType[material.type] = material\n          }\n        }\n\n        // Build metadata array for UI\n        const currentSources = sourcesData || sources\n        const metaArray = Object.values(materialsByType).map((material) => {\n          const sourceIds = material.source_ids || []\n          const sourceNames = sourceIds.map((id: string) => {\n            const source = currentSources.find(s => s.id === id)\n            return source?.name || 'Unknown source'\n          })\n\n          // Calculate item count based on type\n          let itemCount = 0\n          if (material.type === 'flashcards') itemCount = material.data?.flashcards?.length || 0\n          else if (material.type === 'quiz') itemCount = material.data?.questions?.length || 0\n          else if (material.type === 'faq') itemCount = material.data?.faq?.length || 0\n\n          return {\n            id: material.id,\n            type: material.type,\n            sourceIds,\n            sourceNames,\n            createdAt: material.created_at,\n            itemCount,\n          }\n        })\n        setStudyMaterialsMeta(metaArray)\n\n        // Populate state with cached data\n        if (materialsByType.flashcards?.data?.flashcards) {\n          setFlashcards(materialsByType.flashcards.data.flashcards)\n        }\n        if (materialsByType.quiz?.data?.questions) {\n          setQuizQuestions(materialsByType.quiz.data.questions)\n        }\n        if (materialsByType.study_guide?.data) {\n          setStudyGuide(materialsByType.study_guide.data)\n        }\n        if (materialsByType.faq?.data?.faq) {\n          setFaqItems(materialsByType.faq.data.faq)\n        }\n        if (materialsByType.mind_map?.data) {\n          setMindMap(materialsByType.mind_map.data)\n        }\n      }\n    } catch (error) {\n      console.error('Failed to fetch study materials:', error)\n    }\n  }\n\n  // Redirect if notebook doesn't exist\n  useEffect(() => {\n    if (!notebookLoading && !notebook) {\n      router.push('/')\n    }\n  }, [notebook, notebookLoading, router])\n\n  // Load notebook settings when notebook data is available\n  useEffect(() => {\n    if (notebook?.settings) {\n      setNotebookSettings(notebook.settings as unknown as NotebookSettings)\n    }\n  }, [notebook])\n\n  // Save notebook settings\n  const saveNotebookSettings = async (newSettings: NotebookSettings) => {\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n      const response = await fetch(`/api/notebooks/${notebookId}`, {\n        method: 'PATCH',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n        body: JSON.stringify({ settings: newSettings }),\n      })\n\n      if (!response.ok) {\n        throw new Error('Failed to save settings')\n      }\n\n      setNotebookSettings(newSettings)\n      invalidate.invalidateAll(notebookId)\n    } catch (error) {\n      console.error('Failed to save notebook settings:', error)\n      throw error\n    }\n  }\n\n  // Source handlers\n  const handleAddSource = async (type: string, data: { input: string; name?: string; file?: File }) => {\n    setUploading(true)\n\n    if (type === 'file') {\n      // Handle file upload - file is passed from the sources panel\n      const file = data.file\n      if (file) {\n        const fileExt = file.name.split('.').pop()?.toLowerCase()\n        const filePath = `${user?.id}/${notebookId}/${Date.now()}.${fileExt}`\n\n        const { error: uploadError } = await supabase.storage\n          .from('sources')\n          .upload(filePath, file)\n\n        if (uploadError) {\n          console.error('Upload error:', uploadError)\n          \n          setUploading(false)\n          return\n        }\n\n        const { data: sourceData, error } = await supabase\n          .from('sources')\n          .insert({\n            notebook_id: notebookId,\n            type: fileExt === 'pdf' ? 'pdf' : fileExt === 'docx' ? 'docx' : 'txt',\n            name: file.name,\n            status: 'ready',\n            file_path: filePath,\n            original_filename: file.name,\n            mime_type: file.type,\n            file_size_bytes: file.size,\n          })\n          .select()\n          .single()\n\n        if (error) {\n          console.error('Source creation error:', error)\n        } else {\n          invalidate.invalidateSources(notebookId)\n        }\n      }\n    } else {\n      let sourceData: Partial<Source> = {\n        notebook_id: notebookId,\n        status: 'ready',\n      }\n\n      if (type === 'youtube') {\n        sourceData = {\n          ...sourceData,\n          type: 'youtube',\n          name: data.name || `YouTube: ${data.input}`,\n          metadata: { url: data.input },\n        }\n      } else if (type === 'url') {\n        sourceData = {\n          ...sourceData,\n          type: 'url',\n          name: data.name || data.input,\n          metadata: { url: data.input },\n        }\n      } else if (type === 'text') {\n        sourceData = {\n          ...sourceData,\n          type: 'text',\n          name: data.name || 'Pasted Text',\n          metadata: { content: data.input },\n        }\n      }\n\n      const { error } = await supabase\n        .from('sources')\n        .insert(sourceData)\n        .select()\n        .single()\n\n      if (error) {\n        console.error('Source creation error:', error)\n      } else {\n        invalidate.invalidateSources(notebookId)\n      }\n    }\n\n    setUploading(false)\n  }\n\n  const handleDeleteSource = async (sourceId: string) => {\n    const { error } = await supabase\n      .from('sources')\n      .delete()\n      .eq('id', sourceId)\n\n    if (error) {\n      console.error('Delete source error:', error)\n    } else {\n      invalidate.invalidateSources(notebookId)\n      selectedSources.delete(sourceId)\n      setSelectedSources(new Set(selectedSources))\n    }\n  }\n\n  const toggleSource = (sourceId: string) => {\n    const newSelected = new Set(selectedSources)\n    if (newSelected.has(sourceId)) {\n      newSelected.delete(sourceId)\n    } else {\n      newSelected.add(sourceId)\n    }\n    setSelectedSources(newSelected)\n  }\n\n  const selectAllSources = () => {\n    if (selectedSources.size === sources.length) {\n      setSelectedSources(new Set())\n    } else {\n      setSelectedSources(new Set(sources.map(s => s.id)))\n    }\n  }\n\n  // Chat handlers\n  const sendMessage = async (overrideMessage?: string) => {\n    const messageToSend = overrideMessage || message\n    if (!messageToSend.trim() || sending) return\n\n    setSending(true)\n    const userMessage: ChatMessage = {\n      id: crypto.randomUUID(),\n      session_id: sessionId || '',\n      role: 'user',\n      content: messageToSend,\n      citations: [],\n      source_ids_used: Array.from(selectedSources),\n      model_used: null,\n      input_tokens: null,\n      output_tokens: null,\n      cost_usd: null,\n      created_at: new Date().toISOString(),\n    }\n    setMessages(prev => [...prev, userMessage])\n    setMessage('')\n\n    try {\n      const response = await chatApi.sendMessage(notebookId, {\n        message: userMessage.content,\n        source_ids: Array.from(selectedSources),\n        session_id: sessionId || undefined,\n      })\n\n      const isNewSession = !sessionId\n      if (response.data.session_id) {\n        setSessionId(response.data.session_id)\n      }\n\n      const aiMessage: ChatMessage = {\n        id: response.data.message_id,\n        session_id: response.data.session_id,\n        role: 'assistant',\n        content: response.data.content,\n        citations: response.data.citations,\n        source_ids_used: Array.from(selectedSources),\n        model_used: response.usage?.model_used || 'gemini-2.0-flash',\n        input_tokens: response.usage?.input_tokens || 0,\n        output_tokens: response.usage?.output_tokens || 0,\n        cost_usd: response.usage?.cost_usd || 0,\n        created_at: new Date().toISOString(),\n      }\n      setMessages(prev => [...prev, aiMessage])\n\n      // Refresh chat sessions if this was a new session\n      if (isNewSession) {\n        invalidate.invalidateChatSessions(notebookId)\n      }\n    } catch {\n      setMessages(prev => prev.filter(m => m.id !== userMessage.id))\n    }\n    setSending(false)\n  }\n\n  const saveResponseAsNote = async (msg: ChatMessage) => {\n    const { error } = await supabase\n      .from('notes')\n      .insert({\n        notebook_id: notebookId,\n        type: 'saved_response',\n        title: `Saved Response - ${new Date().toLocaleDateString()}`,\n        content: msg.content,\n        tags: [],\n      })\n      .select()\n      .single()\n\n    if (error) {\n      console.error('Save note error:', error)\n    } else {\n      invalidate.invalidateNotes(notebookId)\n    }\n  }\n\n  // Notes handlers\n  const createNote = async () => {\n    if (!noteTitle.trim() && !noteContent.trim()) return\n\n    setSavingNote(true)\n    const { error } = await supabase\n      .from('notes')\n      .insert({\n        notebook_id: notebookId,\n        type: 'written',\n        title: noteTitle || 'Untitled Note',\n        content: noteContent,\n        tags: [],\n      })\n      .select()\n      .single()\n\n    if (error) {\n      console.error('Create note error:', error)\n    } else {\n      invalidate.invalidateNotes(notebookId)\n      setNoteTitle('')\n      setNoteContent('')\n      setAddNoteOpen(false)\n    }\n    setSavingNote(false)\n  }\n\n  // Audio generation\n  const generateAudio = async () => {\n    if (selectedSources.size === 0) {\n      \n      return\n    }\n\n    setGeneratingAudio(true)\n    setActiveStudyType('audio')\n    setStudySheetOpen(true)\n\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n      const response = await fetch(`/api/notebooks/${notebookId}/audio`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n        body: JSON.stringify({\n          format: audioFormat,\n          source_ids: Array.from(selectedSources),\n          custom_instructions: audioInstructions || undefined,\n        }),\n      })\n      const result = await response.json()\n      if (result.error) {\n        console.error('Audio generation error:', result.error)\n      } else if (result.data) {\n        setLocalGeneratedAudio(result.data)\n        invalidate.invalidateAudio(notebookId)\n      }\n    } catch (error) {\n      console.error('Audio generation error:', error)\n    }\n    setGeneratingAudio(false)\n  }\n\n  // Video generation\n  const generateVideo = async () => {\n    if (selectedSources.size === 0) {\n      return\n    }\n\n    setGeneratingVideo(true)\n    setActiveStudyType('video')\n    setStudySheetOpen(true)\n\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n      const response = await fetch(`/api/notebooks/${notebookId}/video`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n        body: JSON.stringify({\n          style: videoStyle,\n          source_ids: Array.from(selectedSources),\n        }),\n      })\n      const result = await response.json()\n      if (result.error) {\n        console.error('Video generation error:', result.error)\n      } else if (result.data) {\n        // Map video_file_path to video_url for frontend components\n        setLocalGeneratedVideo({\n          ...result.data,\n          video_url: result.data.video_file_path || result.data.video_url,\n        })\n        invalidate.invalidateVideo(notebookId)\n      }\n    } catch (error) {\n      console.error('Video generation error:', error)\n    }\n    setGeneratingVideo(false)\n  }\n\n  // Research generation\n  const runResearch = async () => {\n    if (!researchQuery.trim()) {\n      return\n    }\n\n    // Clear old research to prevent showing cached results\n    setLocalGeneratedResearch(null)\n    setResearching(true)\n    setActiveStudyType('research')\n    setStudySheetOpen(true)\n\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n      const response = await fetch(`/api/notebooks/${notebookId}/research`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n        body: JSON.stringify({\n          query: researchQuery,\n          mode: researchMode,\n        }),\n      })\n      const result = await response.json()\n      if (result.error) {\n        console.error('Research failed:', result.error)\n        alert(`Research failed: ${result.error}`)\n      } else if (result.data) {\n        setLocalGeneratedResearch(result.data)\n        invalidate.invalidateResearch(notebookId)\n        setResearchQuery('')\n      }\n    } catch (error) {\n      console.error('Research error:', error)\n      alert('Research failed. Please try again.')\n    }\n    setResearching(false)\n  }\n\n  // Export notebook handler\n  const handleExportNotebook = async (format: 'zip' | 'pdf' | 'json', options: ExportOptionsState) => {\n    setExportingNotebook(true)\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n      if (!session?.access_token) {\n        throw new Error('Not authenticated')\n      }\n\n      await exportNotebook(notebookId, {\n        format,\n        includeSources: options.includeSources,\n        includeChats: options.includeChats,\n        includeNotes: options.includeNotes,\n        includeGenerated: options.includeGenerated,\n      }, session.access_token)\n    } catch (error) {\n      console.error('Export failed:', error)\n      alert('Export failed. Please try again.')\n    } finally {\n      setExportingNotebook(false)\n    }\n  }\n\n  // Study material generation handlers\n  const handleGenerateFlashcards = async () => {\n    setGeneratingState('flashcards', true)\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n      const response = await fetch(`/api/notebooks/${notebookId}/study`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n        body: JSON.stringify({\n          type: 'flashcards',\n          source_ids: Array.from(selectedSources),\n          count: 5,\n        }),\n      })\n      const result = await response.json()\n      if (result.error) {\n        \n      } else if (result.data?.flashcards) {\n        setFlashcards(result.data.flashcards)\n        setCurrentFlashcard(0)\n        setShowFlashcardBack(false)\n        setActiveStudyType('flashcards')\n        setStudySheetOpen(true)\n        fetchStudyMaterials()\n        \n      }\n    } catch {\n      \n    } finally {\n      setGeneratingState('flashcards', false)\n    }\n  }\n\n  const handleGenerateQuiz = async () => {\n    setGeneratingState('quiz', true)\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n      const response = await fetch(`/api/notebooks/${notebookId}/study`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n        body: JSON.stringify({\n          type: 'quiz',\n          source_ids: Array.from(selectedSources),\n          count: 5,\n        }),\n      })\n      const result = await response.json()\n      if (result.error) {\n        \n      } else if (result.data?.questions) {\n        setQuizQuestions(result.data.questions)\n        setCurrentQuizQuestion(0)\n        setSelectedAnswer(null)\n        setShowQuizAnswer(false)\n        setActiveStudyType('quiz')\n        setStudySheetOpen(true)\n        fetchStudyMaterials()\n        \n      }\n    } catch {\n      \n    } finally {\n      setGeneratingState('quiz', false)\n    }\n  }\n\n  const handleGenerateStudyGuide = async () => {\n    setGeneratingState('studyGuide', true)\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n      const response = await fetch(`/api/notebooks/${notebookId}/study`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n        body: JSON.stringify({\n          type: 'study-guide',\n          source_ids: Array.from(selectedSources),\n        }),\n      })\n      const result = await response.json()\n      if (result.error) {\n        \n      } else if (result.data?.sections) {\n        setStudyGuide(result.data)\n        setActiveStudyType('guide')\n        setStudySheetOpen(true)\n        fetchStudyMaterials()\n        \n      }\n    } catch {\n      \n    } finally {\n      setGeneratingState('studyGuide', false)\n    }\n  }\n\n  const handleGenerateFaq = async () => {\n    setGeneratingState('faq', true)\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n      const response = await fetch(`/api/notebooks/${notebookId}/study`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n        body: JSON.stringify({\n          type: 'faq',\n          source_ids: Array.from(selectedSources),\n        }),\n      })\n      const result = await response.json()\n      if (result.error) {\n        \n      } else if (result.data?.faq) {\n        setFaqItems(result.data.faq)\n        setActiveStudyType('faq')\n        setStudySheetOpen(true)\n        fetchStudyMaterials()\n        \n      }\n    } catch {\n      \n    } finally {\n      setGeneratingState('faq', false)\n    }\n  }\n\n  const handleGenerateMindMap = async () => {\n    setGeneratingState('mindMap', true)\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n      const response = await fetch(`/api/notebooks/${notebookId}/study`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n        body: JSON.stringify({\n          type: 'mind-map',\n          source_ids: Array.from(selectedSources),\n        }),\n      })\n      const result = await response.json()\n      if (result.error) {\n\n      } else if (result.data?.nodes) {\n        setMindMap(result.data)\n        setActiveStudyType('mindmap')\n        setStudySheetOpen(true)\n        // Refresh metadata to show updated material\n        fetchStudyMaterials()\n\n      }\n    } catch {\n\n    } finally {\n      setGeneratingState('mindMap', false)\n    }\n  }\n\n  // Unified study material handler with config\n  const handleGenerateStudyMaterial = async (config: GenerationConfig) => {\n    const sourceIds = config.sourceIds && config.sourceIds.length > 0\n      ? config.sourceIds\n      : Array.from(selectedSources)\n\n    if (sourceIds.length === 0) return\n\n    // Set loading state based on type\n    const typeToStateKey: Record<string, keyof typeof generating> = {\n      'flashcards': 'flashcards',\n      'quiz': 'quiz',\n      'study-guide': 'studyGuide',\n      'faq': 'faq',\n      'mind-map': 'mindMap',\n    }\n    const stateKey = typeToStateKey[config.type]\n    if (stateKey) setGeneratingState(stateKey, true)\n\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n\n      // Build request body with all config options\n      const requestBody: Record<string, unknown> = {\n        type: config.type,\n        source_ids: sourceIds,\n      }\n\n      // Add optional config fields\n      if (config.count) requestBody.count = config.count\n      if (config.difficulty) requestBody.difficulty = config.difficulty\n      if (config.focusArea) requestBody.focus_area = config.focusArea\n      if (config.customInstructions) requestBody.custom_instructions = config.customInstructions\n      if (config.questionTypes) requestBody.question_types = config.questionTypes\n\n      const response = await fetch(`/api/notebooks/${notebookId}/study`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n        body: JSON.stringify(requestBody),\n      })\n      const result = await response.json()\n\n      if (result.error) {\n        console.error('Generation error:', result.error)\n      } else if (result.data) {\n        // Handle each type's response\n        switch (config.type) {\n          case 'flashcards':\n            if (result.data.flashcards) {\n              setFlashcards(result.data.flashcards)\n              setCurrentFlashcard(0)\n              setShowFlashcardBack(false)\n              setActiveStudyType('flashcards')\n              setStudySheetOpen(true)\n            }\n            break\n          case 'quiz':\n            if (result.data.questions) {\n              setQuizQuestions(result.data.questions)\n              setCurrentQuizQuestion(0)\n              setSelectedAnswer(null)\n              setShowQuizAnswer(false)\n              setActiveStudyType('quiz')\n              setStudySheetOpen(true)\n            }\n            break\n          case 'study-guide':\n            if (result.data.sections) {\n              setStudyGuide(result.data)\n              setActiveStudyType('guide')\n              setStudySheetOpen(true)\n            }\n            break\n          case 'faq':\n            if (result.data.faq) {\n              setFaqItems(result.data.faq)\n              setActiveStudyType('faq')\n              setStudySheetOpen(true)\n            }\n            break\n          case 'mind-map':\n            if (result.data.nodes) {\n              setMindMap(result.data)\n              setActiveStudyType('mindmap')\n              setStudySheetOpen(true)\n            }\n            break\n        }\n        fetchStudyMaterials()\n      }\n    } catch (error) {\n      console.error('Study material generation failed:', error)\n    } finally {\n      if (stateKey) setGeneratingState(stateKey, false)\n    }\n  }\n\n  // Unified creative output handler with config\n  const handleGenerateCreativeOutput = async (config: GenerationConfig) => {\n    const sourceIds = config.sourceIds && config.sourceIds.length > 0\n      ? config.sourceIds\n      : Array.from(selectedSources)\n\n    if (sourceIds.length === 0) return\n\n    // Set loading state based on type\n    const typeToStateKey2: Record<string, keyof typeof generating> = {\n      'data_table': 'dataTable',\n      'report': 'report',\n      'slide_deck': 'slideDeck',\n      'infographic': 'infographic',\n    }\n    const stateKey2 = typeToStateKey2[config.type]\n    if (stateKey2) setGeneratingState(stateKey2, true)\n\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n\n      // Build request body with all config options\n      const requestBody: Record<string, unknown> = {\n        type: config.type,\n        source_ids: sourceIds,\n      }\n\n      // Add optional config fields\n      if (config.customInstructions) requestBody.custom_instructions = config.customInstructions\n      if (config.focusArea) requestBody.focus_area = config.focusArea\n      if (config.reportType) requestBody.report_type = config.reportType\n      if (config.tone) requestBody.tone = config.tone\n      if (config.slideCount) requestBody.slide_count = config.slideCount\n      if (config.style) requestBody.style = config.style\n      // Infographic-specific options\n      if (config.imageCount) requestBody.image_count = config.imageCount\n      if (config.imageStyle) requestBody.image_style = config.imageStyle\n\n      const response = await fetch(`/api/notebooks/${notebookId}/studio`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n        body: JSON.stringify(requestBody),\n      })\n      const result = await response.json()\n\n      if (result.error) {\n        console.error('Generation error:', result.error)\n      } else if (result.data) {\n        // Handle each type's response\n        switch (config.type) {\n          case 'data_table':\n            setDataTableData(result.data)\n            setActiveStudyType('datatable')\n            setStudySheetOpen(true)\n            break\n          case 'report':\n            setReportData(result.data)\n            setActiveStudyType('report')\n            setStudySheetOpen(true)\n            break\n          case 'slide_deck':\n            setSlideDeckData(result.data)\n            setActiveStudyType('slides')\n            setStudySheetOpen(true)\n            break\n          case 'infographic':\n            setInfographicData(result.data)\n            setActiveStudyType('infographic')\n            setStudySheetOpen(true)\n            break\n        }\n        fetchCreativeOutputs()\n      }\n    } catch (error) {\n      console.error('Creative output generation failed:', error)\n    } finally {\n      if (stateKey2) setGeneratingState(stateKey2, false)\n    }\n  }\n\n  // Creative output generation handlers (legacy - kept for compatibility)\n  const handleGenerateDataTable = async () => {\n    if (selectedSources.size === 0) {\n\n      return\n    }\n    setGeneratingState('dataTable', true)\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n      const response = await fetch(`/api/notebooks/${notebookId}/studio`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n        body: JSON.stringify({\n          type: 'data_table',\n          source_ids: Array.from(selectedSources),\n        }),\n      })\n      const result = await response.json()\n      if (result.error) {\n        \n      } else if (result.data) {\n        setDataTableData(result.data)\n        setActiveStudyType('datatable' as typeof activeStudyType)\n        setStudySheetOpen(true)\n        fetchCreativeOutputs()\n      }\n    } catch {\n      // Error handled silently\n    } finally {\n      setGeneratingState('dataTable', false)\n    }\n  }\n\n  const handleGenerateReport = async (reportType: string) => {\n    if (selectedSources.size === 0) {\n\n      return\n    }\n    setGeneratingState('report', true)\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n      const response = await fetch(`/api/notebooks/${notebookId}/studio`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n        body: JSON.stringify({\n          type: 'report',\n          source_ids: Array.from(selectedSources),\n          report_type: reportType,\n        }),\n      })\n      const result = await response.json()\n      if (result.error) {\n        \n      } else if (result.data) {\n        setReportData(result.data)\n        setActiveStudyType('report' as typeof activeStudyType)\n        setStudySheetOpen(true)\n        fetchCreativeOutputs()\n      }\n    } catch {\n      // Error handled silently\n    } finally {\n      setGeneratingState('report', false)\n    }\n  }\n\n  const handleGenerateSlideDeck = async () => {\n    if (selectedSources.size === 0) {\n\n      return\n    }\n    setGeneratingState('slideDeck', true)\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n      const response = await fetch(`/api/notebooks/${notebookId}/studio`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n        body: JSON.stringify({\n          type: 'slide_deck',\n          source_ids: Array.from(selectedSources),\n        }),\n      })\n      const result = await response.json()\n      if (result.error) {\n        \n      } else if (result.data) {\n        setSlideDeckData(result.data)\n        setActiveStudyType('slides' as typeof activeStudyType)\n        setStudySheetOpen(true)\n        fetchCreativeOutputs()\n      }\n    } catch {\n      // Error handled silently\n    } finally {\n      setGeneratingState('slideDeck', false)\n    }\n  }\n\n  const handleGenerateInfographic = async () => {\n    if (selectedSources.size === 0) {\n\n      return\n    }\n    setGeneratingState('infographic', true)\n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n      const response = await fetch(`/api/notebooks/${notebookId}/studio`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${session?.access_token}`,\n        },\n        body: JSON.stringify({\n          type: 'infographic',\n          source_ids: Array.from(selectedSources),\n        }),\n      })\n      const result = await response.json()\n      if (result.error) {\n        \n      } else if (result.data) {\n        setInfographicData(result.data)\n        setActiveStudyType('infographic' as typeof activeStudyType)\n        setStudySheetOpen(true)\n        fetchCreativeOutputs()\n      }\n    } catch {\n      // Error handled silently\n    } finally {\n      setGeneratingState('infographic', false)\n    }\n  }\n\n  // Sheet resize handlers\n  const handleResizeStart = (e: React.MouseEvent) => {\n    e.preventDefault()\n    setIsResizing(true)\n\n    const startX = e.clientX\n    const startWidth = sheetWidth\n\n    const handleMouseMove = (e: MouseEvent) => {\n      const diff = startX - e.clientX\n      const newWidth = Math.min(Math.max(startWidth + diff, 400), window.innerWidth - 50)\n      setSheetWidth(newWidth)\n    }\n\n    const handleMouseUp = () => {\n      setIsResizing(false)\n      document.removeEventListener('mousemove', handleMouseMove)\n      document.removeEventListener('mouseup', handleMouseUp)\n    }\n\n    document.addEventListener('mousemove', handleMouseMove)\n    document.addEventListener('mouseup', handleMouseUp)\n  }\n\n  if (loading) {\n    return (\n      <div className=\"h-screen flex items-center justify-center bg-[var(--bg-primary)]\">\n        <Loader2 className=\"h-8 w-8 animate-spin text-[var(--accent-primary)]\" />\n      </div>\n    )\n  }\n\n  return (\n    <div className=\"h-screen flex flex-col bg-[var(--bg-primary)]\">\n      {/* Header */}\n      <motion.header\n        initial={{ opacity: 0, y: -10 }}\n        animate={{ opacity: 1, y: 0 }}\n        className=\"h-14 bg-[var(--bg-secondary)] border-b border-[rgba(255,255,255,0.1)] px-4 flex items-center gap-4 shrink-0 sticky top-0 z-50\"\n      >\n        <Button\n          variant=\"ghost\"\n          size=\"icon\"\n          onClick={() => router.push('/')}\n          className=\"h-9 w-9 rounded-lg text-[var(--text-secondary)] hover:text-[var(--text-primary)] hover:bg-[var(--bg-tertiary)]\"\n        >\n          <ArrowLeft className=\"h-4 w-4\" />\n        </Button>\n\n        <div className=\"flex items-center gap-3\">\n          <div className=\"w-10 h-10 rounded-xl bg-[var(--bg-tertiary)] flex items-center justify-center text-xl\">\n            {notebook?.emoji}\n          </div>\n          <div>\n            <h1 className=\"font-semibold text-[var(--text-primary)]\">{notebook?.name}</h1>\n            {notebook?.description && (\n              <p className=\"text-xs text-[var(--text-tertiary)] line-clamp-1 max-w-[300px]\">\n                {notebook.description}\n              </p>\n            )}\n          </div>\n        </div>\n\n        <div className=\"flex items-center gap-2 ml-auto\">\n          <Badge className=\"bg-[var(--bg-tertiary)] text-[var(--text-secondary)] border-0 text-xs\">\n            {sources.length} source{sources.length !== 1 ? 's' : ''}\n          </Badge>\n          {selectedSources.size > 0 && (\n            <Badge className=\"bg-[var(--accent-primary)]/20 text-[var(--accent-primary)] border-0 text-xs\">\n              {selectedSources.size} selected\n            </Badge>\n          )}\n          {notebookSettings?.persona?.enabled && (\n            <Badge className=\"bg-purple-500/20 text-purple-400 border-0 text-xs\">\n              {notebookSettings.persona.name || 'Custom Persona'}\n            </Badge>\n          )}\n          <Button\n            variant=\"ghost\"\n            size=\"sm\"\n            onClick={() => setSettingsOpen(true)}\n            className=\"h-9 px-3 rounded-lg text-[var(--text-secondary)] hover:text-[var(--text-primary)] hover:bg-[var(--bg-tertiary)] gap-2\"\n          >\n            <Settings className=\"h-4 w-4\" />\n            <span className=\"hidden sm:inline\">Settings</span>\n          </Button>\n          <Button\n            variant=\"ghost\"\n            size=\"sm\"\n            onClick={() => router.push(`/notebooks/${notebookId}/history`)}\n            className=\"h-9 px-3 rounded-lg text-[var(--text-secondary)] hover:text-[var(--text-primary)] hover:bg-[var(--bg-tertiary)] gap-2\"\n          >\n            <History className=\"h-4 w-4\" />\n            <span className=\"hidden sm:inline\">History</span>\n          </Button>\n        </div>\n      </motion.header>\n\n      {/* Three Panel Layout */}\n      <div className=\"flex-1 overflow-hidden\">\n        <ThreePanelLayout\n          leftPanelTitle=\"Sources\"\n          rightPanelTitle=\"Studio\"\n          leftPanel={\n            <SourcesPanel\n              sources={sources}\n              selectedSources={selectedSources}\n              onToggleSource={toggleSource}\n              onSelectAll={selectAllSources}\n              onAddSource={handleAddSource}\n              onDeleteSource={handleDeleteSource}\n              onViewSource={setViewingSource}\n              uploading={uploading}\n            />\n          }\n          centerPanel={\n            <ChatPanel\n              messages={messages}\n              message={message}\n              onMessageChange={setMessage}\n              onSendMessage={sendMessage}\n              sending={sending}\n              selectedSourcesCount={selectedSources.size}\n              totalSourcesCount={sources.length}\n              onSaveResponse={saveResponseAsNote}\n              sessions={chatSessions}\n              currentSessionId={sessionId}\n              onLoadSession={loadChatSession}\n              onNewChat={startNewChat}\n              onDeleteSession={deleteChatSession}\n              onRenameSession={renameChatSession}\n              loadingSessions={loadingSessions}\n              notebookId={notebookId}\n            />\n          }\n          rightPanel={\n            <StudioPanel\n              notebookId={notebookId}\n              selectedSourcesCount={selectedSources.size}\n              selectedSourceIds={Array.from(selectedSources)}\n              sources={sources.map(s => ({ id: s.id, name: s.name }))}\n              audioFormat={audioFormat}\n              onAudioFormatChange={setAudioFormat}\n              audioInstructions={audioInstructions}\n              onAudioInstructionsChange={setAudioInstructions}\n              onGenerateAudio={generateAudio}\n              generatingAudio={generatingAudio}\n              videoStyle={videoStyle}\n              onVideoStyleChange={setVideoStyle}\n              onGenerateVideo={generateVideo}\n              generatingVideo={generatingVideo}\n              researchQuery={researchQuery}\n              onResearchQueryChange={setResearchQuery}\n              researchMode={researchMode}\n              onResearchModeChange={setResearchMode}\n              onRunResearch={runResearch}\n              researching={researching}\n              onGenerateStudyMaterial={handleGenerateStudyMaterial}\n              generatingFlashcards={generating.flashcards}\n              generatingQuiz={generating.quiz}\n              generatingStudyGuide={generating.studyGuide}\n              generatingFaq={generating.faq}\n              generatingMindMap={generating.mindMap}\n              onGenerateCreativeOutput={handleGenerateCreativeOutput}\n              generatingDataTable={generating.dataTable}\n              generatingReport={generating.report}\n              generatingSlideDeck={generating.slideDeck}\n              generatingInfographic={generating.infographic}\n              creativeOutputs={creativeOutputsMeta}\n              onOpenCreativeOutput={(type) => {\n                const typeMap: Record<string, typeof activeStudyType> = {\n                  data_table: 'datatable',\n                  report: 'report',\n                  slide_deck: 'slides',\n                  infographic: 'infographic',\n                }\n                setActiveStudyType(typeMap[type] || null)\n                setStudySheetOpen(true)\n              }}\n              studyMaterials={studyMaterialsMeta}\n              onOpenStudyMaterial={(type) => {\n                const typeMap: Record<string, typeof activeStudyType> = {\n                  flashcards: 'flashcards',\n                  quiz: 'quiz',\n                  study_guide: 'guide',\n                  faq: 'faq',\n                  mind_map: 'mindmap',\n                }\n                setActiveStudyType(typeMap[type] || null)\n                setStudySheetOpen(true)\n              }}\n              notesCount={notes.length}\n              onAddNote={() => setAddNoteOpen(true)}\n              hasGeneratedAudio={!!activeGeneratedAudio}\n              hasGeneratedVideo={!!activeGeneratedVideo}\n              hasGeneratedResearch={!!activeGeneratedResearch}\n              onOpenAudio={() => { setActiveStudyType('audio'); setStudySheetOpen(true) }}\n              onOpenVideo={() => { setActiveStudyType('video'); setStudySheetOpen(true) }}\n              onOpenResearch={() => { setActiveStudyType('research'); setStudySheetOpen(true) }}\n            />\n          }\n        />\n      </div>\n\n      {/* Source Preview Dialog */}\n      <Dialog open={!!viewingSource} onOpenChange={(open) => !open && setViewingSource(null)}>\n        <DialogContent className=\"sm:max-w-lg bg-[var(--bg-secondary)] border-[rgba(255,255,255,0.1)]\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-3 text-[var(--text-primary)]\">\n              <div className=\"w-10 h-10 rounded-lg bg-[var(--bg-tertiary)] flex items-center justify-center\">\n                <FileText className=\"h-5 w-5\" />\n              </div>\n              {viewingSource?.name}\n            </DialogTitle>\n            <DialogDescription className=\"text-[var(--text-secondary)]\">\n              {viewingSource?.type} source\n            </DialogDescription>\n          </DialogHeader>\n\n          {viewingSource?.metadata && (() => {\n            const meta = viewingSource.metadata as Record<string, unknown>\n            if (viewingSource.type === 'text' && meta.content) {\n              return (\n                <div className=\"p-4 rounded-xl bg-[var(--bg-tertiary)] text-sm max-h-64 overflow-y-auto\">\n                  <p className=\"whitespace-pre-wrap text-[var(--text-secondary)]\">\n                    {String(meta.content)}\n                  </p>\n                </div>\n              )\n            }\n            if ((viewingSource.type === 'youtube' || viewingSource.type === 'url') && meta.url) {\n              return (\n                <div className=\"p-4 rounded-xl bg-[var(--bg-tertiary)] text-sm max-h-64 overflow-y-auto\">\n                  <a\n                    href={String(meta.url)}\n                    target=\"_blank\"\n                    rel=\"noopener noreferrer\"\n                    className=\"text-[var(--accent-primary)] hover:underline break-all\"\n                  >\n                    {String(meta.url)}\n                  </a>\n                </div>\n              )\n            }\n            return null\n          })()}\n        </DialogContent>\n      </Dialog>\n\n      {/* Add Note Dialog */}\n      <Dialog open={addNoteOpen} onOpenChange={setAddNoteOpen}>\n        <DialogContent className=\"sm:max-w-md bg-[var(--bg-secondary)] border-[rgba(255,255,255,0.1)]\">\n          <DialogHeader>\n            <DialogTitle className=\"text-[var(--text-primary)]\">Create Note</DialogTitle>\n            <DialogDescription className=\"text-[var(--text-secondary)]\">\n              Write a new note to save your thoughts.\n            </DialogDescription>\n          </DialogHeader>\n          <div className=\"space-y-4 mt-2\">\n            <div className=\"space-y-2\">\n              <label className=\"text-sm font-medium text-[var(--text-primary)]\">Title</label>\n              <Input\n                placeholder=\"Note title...\"\n                value={noteTitle}\n                onChange={(e) => setNoteTitle(e.target.value)}\n                className=\"h-10 bg-[var(--bg-tertiary)] border-[rgba(255,255,255,0.1)] text-[var(--text-primary)] placeholder:text-[var(--text-tertiary)] focus:border-[var(--accent-primary)] rounded-lg\"\n              />\n            </div>\n            <div className=\"space-y-2\">\n              <label className=\"text-sm font-medium text-[var(--text-primary)]\">Content</label>\n              <Textarea\n                placeholder=\"Write your note...\"\n                value={noteContent}\n                onChange={(e) => setNoteContent(e.target.value)}\n                rows={6}\n                className=\"bg-[var(--bg-tertiary)] border-[rgba(255,255,255,0.1)] text-[var(--text-primary)] placeholder:text-[var(--text-tertiary)] focus:border-[var(--accent-primary)] rounded-lg resize-none\"\n              />\n            </div>\n          </div>\n          <DialogFooter className=\"mt-4\">\n            <Button\n              onClick={createNote}\n              disabled={savingNote}\n              className=\"rounded-lg bg-[var(--accent-primary)] hover:bg-[var(--accent-primary)]/90 text-white\"\n            >\n              {savingNote && <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />}\n              Create Note\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      {/* Study Materials Sheet */}\n      <Sheet open={studySheetOpen} onOpenChange={(open) => {\n        setStudySheetOpen(open)\n        if (!open) setSheetWidth(576)\n      }}>\n        <SheetContent\n          className=\"overflow-y-auto bg-[var(--bg-secondary)] border-[rgba(255,255,255,0.1)] p-0\"\n          style={{ width: sheetWidth, maxWidth: '100vw' }}\n        >\n          {/* Resize Handle */}\n          <div\n            className={`absolute left-0 top-0 bottom-0 w-1.5 cursor-ew-resize hover:bg-[var(--accent-primary)]/50 transition-colors z-50 ${isResizing ? 'bg-[var(--accent-primary)]/50' : ''}`}\n            onMouseDown={handleResizeStart}\n          />\n          <div className=\"p-6\">\n          <SheetHeader>\n            <div className=\"flex items-center gap-2 pr-8\">\n              <SheetTitle className=\"flex items-center gap-2 text-[var(--text-primary)] flex-1\">\n                {activeStudyType === 'flashcards' && <><BookOpen className=\"h-5 w-5 text-blue-500\" /> Flashcards</>}\n                {activeStudyType === 'quiz' && <><ListChecks className=\"h-5 w-5 text-purple-500\" /> Quiz</>}\n                {activeStudyType === 'guide' && <><FileText className=\"h-5 w-5 text-orange-500\" /> Study Guide</>}\n                {activeStudyType === 'faq' && <><HelpCircle className=\"h-5 w-5 text-teal-500\" /> FAQ</>}\n                {activeStudyType === 'mindmap' && <><Share2 className=\"h-5 w-5 text-cyan-500\" /> Mind Map</>}\n                {activeStudyType === 'datatable' && <><Table className=\"h-5 w-5 text-emerald-500\" /> Data Table</>}\n                {activeStudyType === 'report' && <><FileSpreadsheet className=\"h-5 w-5 text-blue-500\" /> Report</>}\n                {activeStudyType === 'slides' && <><Presentation className=\"h-5 w-5 text-violet-500\" /> Slide Deck</>}\n                {activeStudyType === 'infographic' && <><ImageIcon className=\"h-5 w-5 text-rose-500\" /> Infographic</>}\n                {activeStudyType === 'audio' && <><Mic className=\"h-5 w-5 text-orange-500\" /> Audio Overview</>}\n                {activeStudyType === 'video' && <><Video className=\"h-5 w-5 text-purple-500\" /> Video Overview</>}\n                {activeStudyType === 'research' && <><Search className=\"h-5 w-5 text-blue-500\" /> Research Report</>}\n              </SheetTitle>\n              <Button\n                variant=\"ghost\"\n                size=\"icon\"\n                className=\"h-8 w-8 shrink-0\"\n                onClick={() => {\n                  if (sheetWidth < 800) {\n                    setSheetWidth(900) // Wide\n                  } else if (sheetWidth < window.innerWidth - 100) {\n                    setSheetWidth(window.innerWidth - 50) // Full\n                  } else {\n                    setSheetWidth(576) // Normal\n                  }\n                }}\n                title={sheetWidth >= window.innerWidth - 100 ? 'Minimize' : 'Expand'}\n              >\n                {sheetWidth >= window.innerWidth - 100 ? (\n                  <Minimize2 className=\"h-4 w-4\" />\n                ) : (\n                  <Maximize2 className=\"h-4 w-4\" />\n                )}\n              </Button>\n            </div>\n            <SheetDescription className=\"text-[var(--text-secondary)]\">\n              {activeStudyType === 'flashcards' && `${flashcards.length} cards generated from your sources`}\n              {activeStudyType === 'quiz' && `${quizQuestions.length} questions to test your knowledge`}\n              {activeStudyType === 'guide' && 'Comprehensive study guide from your sources'}\n              {activeStudyType === 'faq' && `${faqItems.length} frequently asked questions`}\n              {activeStudyType === 'mindmap' && 'Interactive visualization of key concepts'}\n              {activeStudyType === 'datatable' && 'Structured data extracted from your sources'}\n              {activeStudyType === 'report' && 'Professional document from your sources'}\n              {activeStudyType === 'slides' && 'Presentation slides from your sources'}\n              {activeStudyType === 'infographic' && 'AI-generated images visualizing key concepts'}\n              {activeStudyType === 'audio' && 'Podcast-style audio discussion'}\n              {activeStudyType === 'video' && 'Visual explainer video'}\n              {activeStudyType === 'research' && 'Deep web research findings'}\n            </SheetDescription>\n          </SheetHeader>\n\n          <div className=\"mt-6 relative\">\n            {/* Flashcards View */}\n            {activeStudyType === 'flashcards' && (\n              <FlashcardViewer\n                flashcards={flashcards}\n                onClose={() => setStudySheetOpen(false)}\n              />\n            )}\n\n            {/* Quiz View */}\n            {activeStudyType === 'quiz' && (\n              <QuizViewer\n                questions={quizQuestions}\n                onClose={() => setStudySheetOpen(false)}\n              />\n            )}\n\n            {/* Study Guide View */}\n            {activeStudyType === 'guide' && studyGuide && (\n              <StudyGuideViewer\n                guide={studyGuide}\n                onClose={() => setStudySheetOpen(false)}\n              />\n            )}\n\n            {/* FAQ View */}\n            {activeStudyType === 'faq' && (\n              <FAQViewer\n                items={faqItems}\n                onClose={() => setStudySheetOpen(false)}\n              />\n            )}\n\n            {/* Mind Map View */}\n            {activeStudyType === 'mindmap' && mindMap && (\n              <MindMapViewer\n                title={mindMap.title}\n                nodes={mindMap.nodes}\n                onClose={() => setStudySheetOpen(false)}\n              />\n            )}\n\n            {/* Audio View */}\n            {activeStudyType === 'audio' && (\n              <AudioPlayer\n                audio={activeGeneratedAudio ?? null}\n                isGenerating={generatingAudio}\n                onClose={() => setStudySheetOpen(false)}\n              />\n            )}\n\n            {/* Video View */}\n            {activeStudyType === 'video' && (\n              <VideoPlayer\n                video={activeGeneratedVideo ?? null}\n                isGenerating={generatingVideo}\n                onClose={() => setStudySheetOpen(false)}\n              />\n            )}\n\n            {/* Research View */}\n            {activeStudyType === 'research' && (\n              <ResearchReport\n                research={activeGeneratedResearch ?? null}\n                isResearching={researching}\n                onClose={() => setStudySheetOpen(false)}\n              />\n            )}\n\n            {/* Data Table View */}\n            {activeStudyType === 'datatable' && dataTableData && (\n              <div className=\"space-y-4\">\n                <div className=\"p-4 rounded-xl bg-[var(--bg-tertiary)]\">\n                  <h3 className=\"text-lg font-semibold text-[var(--text-primary)] mb-2\">{dataTableData.title}</h3>\n                  <p className=\"text-sm text-[var(--text-secondary)] mb-4\">{dataTableData.description}</p>\n                  <div className=\"overflow-x-auto\">\n                    <table className=\"w-full text-sm\">\n                      <thead>\n                        <tr className=\"border-b border-[rgba(255,255,255,0.1)]\">\n                          {dataTableData.columns.map((col) => (\n                            <th key={col.key} className=\"text-left p-3 font-medium text-[var(--text-primary)]\">\n                              {col.header}\n                            </th>\n                          ))}\n                        </tr>\n                      </thead>\n                      <tbody>\n                        {dataTableData.rows.map((row, idx) => (\n                          <tr key={idx} className=\"border-b border-[rgba(255,255,255,0.05)] hover:bg-[var(--bg-secondary)]\">\n                            {dataTableData.columns.map((col) => (\n                              <td key={col.key} className=\"p-3 text-[var(--text-secondary)]\">\n                                {String(row[col.key] ?? '')}\n                              </td>\n                            ))}\n                          </tr>\n                        ))}\n                      </tbody>\n                    </table>\n                  </div>\n                </div>\n              </div>\n            )}\n\n            {/* Report View */}\n            {activeStudyType === 'report' && reportData && (\n              <div className=\"space-y-6\">\n                <div className=\"p-4 rounded-xl bg-[var(--bg-tertiary)]\">\n                  <h2 className=\"text-xl font-bold text-[var(--text-primary)] mb-4\">{reportData.title}</h2>\n                  <div className=\"p-4 rounded-lg bg-[var(--accent-primary)]/10 border border-[var(--accent-primary)]/20 mb-6\">\n                    <h3 className=\"text-sm font-semibold text-[var(--accent-primary)] mb-2\">Executive Summary</h3>\n                    <p className=\"text-sm text-[var(--text-secondary)]\">{reportData.executive_summary}</p>\n                  </div>\n                  {reportData.sections.map((section, idx) => (\n                    <div key={idx} className=\"mb-6\">\n                      <h3 className=\"text-lg font-semibold text-[var(--text-primary)] mb-2\">{section.heading}</h3>\n                      <p className=\"text-sm text-[var(--text-secondary)] whitespace-pre-wrap\">{section.content}</p>\n                    </div>\n                  ))}\n                  <div className=\"mt-6 p-4 rounded-lg bg-[var(--bg-secondary)]\">\n                    <h3 className=\"text-sm font-semibold text-[var(--text-primary)] mb-2\">Key Takeaways</h3>\n                    <ul className=\"list-disc list-inside space-y-1\">\n                      {reportData.key_takeaways.map((takeaway, idx) => (\n                        <li key={idx} className=\"text-sm text-[var(--text-secondary)]\">{takeaway}</li>\n                      ))}\n                    </ul>\n                  </div>\n                </div>\n              </div>\n            )}\n\n            {/* Slide Deck View */}\n            {activeStudyType === 'slides' && slideDeckData && (\n              <div className=\"space-y-4\">\n                <div className=\"text-center mb-6\">\n                  <h2 className=\"text-xl font-bold text-[var(--text-primary)]\">{slideDeckData.title}</h2>\n                  {slideDeckData.subtitle && (\n                    <p className=\"text-sm text-[var(--text-secondary)] mt-1\">{slideDeckData.subtitle}</p>\n                  )}\n                  <Badge className=\"mt-2 bg-[var(--bg-tertiary)] text-[var(--text-secondary)]\">\n                    {slideDeckData.slides.length} slides\n                  </Badge>\n                </div>\n                <div className=\"space-y-4\">\n                  {slideDeckData.slides.map((slide) => (\n                    <div key={slide.slide_number} className=\"p-4 rounded-xl bg-[var(--bg-tertiary)] border border-[rgba(255,255,255,0.1)]\">\n                      <div className=\"flex items-center gap-2 mb-3\">\n                        <Badge className=\"bg-[var(--accent-primary)]/20 text-[var(--accent-primary)]\">\n                          {slide.slide_number}\n                        </Badge>\n                        <span className=\"text-xs text-[var(--text-tertiary)] uppercase\">{slide.content_type}</span>\n                      </div>\n                      <h3 className=\"text-lg font-semibold text-[var(--text-primary)] mb-2\">{slide.title}</h3>\n                      <p className=\"text-sm text-[var(--text-secondary)] mb-3\">{slide.main_content}</p>\n                      {slide.bullet_points && slide.bullet_points.length > 0 && (\n                        <ul className=\"list-disc list-inside space-y-1 mb-3\">\n                          {slide.bullet_points.map((point, idx) => (\n                            <li key={idx} className=\"text-sm text-[var(--text-secondary)]\">{point}</li>\n                          ))}\n                        </ul>\n                      )}\n                      {slide.speaker_notes && (\n                        <div className=\"mt-3 p-3 rounded-lg bg-[var(--bg-secondary)] text-xs text-[var(--text-tertiary)]\">\n                          <span className=\"font-medium\">Speaker notes:</span> {slide.speaker_notes}\n                        </div>\n                      )}\n                    </div>\n                  ))}\n                </div>\n              </div>\n            )}\n\n            {/* Infographic View */}\n            {activeStudyType === 'infographic' && infographicData && (\n              // Check if it's the new image-based format\n              infographicData.images && infographicData.images.length > 0 ? (\n                <InfographicViewer\n                  data={{\n                    images: infographicData.images,\n                    concepts: infographicData.concepts || []\n                  }}\n                  onClose={() => setStudySheetOpen(false)}\n                />\n              ) : infographicData.color_scheme && infographicData.sections ? (\n                // Legacy format (backward compatibility)\n                <div className=\"space-y-6\">\n                  {/* Header Section */}\n                  <div\n                    className=\"p-8 rounded-2xl text-center\"\n                    style={{\n                      background: `linear-gradient(135deg, ${infographicData.color_scheme[0]}20 0%, ${infographicData.color_scheme[1]}20 100%)`,\n                      borderLeft: `4px solid ${infographicData.color_scheme[0]}`\n                    }}\n                  >\n                    <h2 className=\"text-2xl font-bold text-[var(--text-primary)]\">{infographicData.title}</h2>\n                    {infographicData.subtitle && (\n                      <p className=\"text-base text-[var(--text-secondary)] mt-2\">{infographicData.subtitle}</p>\n                    )}\n                  </div>\n\n                  {/* Render each section based on type */}\n                  {infographicData.sections.map((section, idx) => {\n                    const sectionColor = infographicData.color_scheme![idx % infographicData.color_scheme!.length]\n                    const content = section.content as Record<string, unknown>\n\n                    // Stats Section\n                    if (section.section_type === 'stats' && content.items) {\n                      const items = content.items as Array<{ value: string; label: string; icon?: string }>\n                      return (\n                        <div key={idx} className=\"p-6 rounded-xl bg-[var(--bg-tertiary)]\">\n                          {section.title && <h3 className=\"text-lg font-semibold text-[var(--text-primary)] mb-4\">{section.title}</h3>}\n                          <div className=\"grid grid-cols-3 gap-4\">\n                            {items.map((item, i) => (\n                              <div key={i} className=\"text-center p-4 rounded-lg\" style={{ backgroundColor: `${sectionColor}15` }}>\n                                <div className=\"text-2xl font-bold\" style={{ color: sectionColor }}>{item.value}</div>\n                                <div className=\"text-sm text-[var(--text-secondary)] mt-1\">{item.label}</div>\n                              </div>\n                            ))}\n                          </div>\n                        </div>\n                      )\n                    }\n\n                    // Timeline Section\n                    if (section.section_type === 'timeline' && content.events) {\n                      const events = content.events as Array<{ date: string; title: string; description?: string }>\n                      return (\n                        <div key={idx} className=\"p-6 rounded-xl bg-[var(--bg-tertiary)]\">\n                          {section.title && <h3 className=\"text-lg font-semibold text-[var(--text-primary)] mb-4\">{section.title}</h3>}\n                          <div className=\"space-y-4\">\n                            {events.map((event, i) => (\n                              <div key={i} className=\"flex gap-4\">\n                                <div className=\"flex flex-col items-center\">\n                                  <div className=\"w-3 h-3 rounded-full\" style={{ backgroundColor: sectionColor }} />\n                                  {i < events.length - 1 && <div className=\"w-0.5 flex-1 mt-1\" style={{ backgroundColor: `${sectionColor}40` }} />}\n                                </div>\n                                <div className=\"flex-1 pb-4\">\n                                  <div className=\"font-semibold\" style={{ color: sectionColor }}>{event.date}</div>\n                                  <div className=\"font-medium text-[var(--text-primary)]\">{event.title}</div>\n                                  {event.description && <div className=\"text-sm text-[var(--text-secondary)] mt-1\">{event.description}</div>}\n                                </div>\n                              </div>\n                            ))}\n                          </div>\n                        </div>\n                      )\n                    }\n\n                    // Process/Steps Section\n                    if (section.section_type === 'process' && content.steps) {\n                      const steps = content.steps as Array<{ step: number; title: string; description?: string }>\n                      return (\n                        <div key={idx} className=\"p-6 rounded-xl bg-[var(--bg-tertiary)]\">\n                          {section.title && <h3 className=\"text-lg font-semibold text-[var(--text-primary)] mb-4\">{section.title}</h3>}\n                          <div className=\"space-y-3\">\n                            {steps.map((step, i) => (\n                              <div key={i} className=\"flex gap-4 items-start\">\n                                <div\n                                  className=\"w-8 h-8 rounded-full flex items-center justify-center text-white font-bold text-sm shrink-0\"\n                                  style={{ backgroundColor: sectionColor }}\n                                >\n                                  {step.step}\n                                </div>\n                                <div>\n                                  <div className=\"font-medium text-[var(--text-primary)]\">{step.title}</div>\n                                  {step.description && <div className=\"text-sm text-[var(--text-secondary)] mt-1\">{step.description}</div>}\n                                </div>\n                              </div>\n                            ))}\n                          </div>\n                        </div>\n                      )\n                    }\n\n                    // Comparison Section\n                    if (section.section_type === 'comparison' && content.left && content.right) {\n                      const left = content.left as { label: string; points: string[] }\n                      const right = content.right as { label: string; points: string[] }\n                      return (\n                        <div key={idx} className=\"p-6 rounded-xl bg-[var(--bg-tertiary)]\">\n                          {section.title && <h3 className=\"text-lg font-semibold text-[var(--text-primary)] mb-4\">{section.title}</h3>}\n                          <div className=\"grid grid-cols-2 gap-4\">\n                            <div className=\"p-4 rounded-lg\" style={{ backgroundColor: `${infographicData.color_scheme![0]}15` }}>\n                              <div className=\"font-semibold mb-3\" style={{ color: infographicData.color_scheme![0] }}>{left.label}</div>\n                              <ul className=\"space-y-2\">\n                                {left.points.map((point, i) => (\n                                  <li key={i} className=\"text-sm text-[var(--text-secondary)] flex items-start gap-2\">\n                                    <span style={{ color: infographicData.color_scheme![0] }}>•</span>\n                                    {point}\n                                  </li>\n                                ))}\n                              </ul>\n                            </div>\n                            <div className=\"p-4 rounded-lg\" style={{ backgroundColor: `${infographicData.color_scheme![1]}15` }}>\n                              <div className=\"font-semibold mb-3\" style={{ color: infographicData.color_scheme![1] }}>{right.label}</div>\n                              <ul className=\"space-y-2\">\n                                {right.points.map((point, i) => (\n                                  <li key={i} className=\"text-sm text-[var(--text-secondary)] flex items-start gap-2\">\n                                    <span style={{ color: infographicData.color_scheme![1] }}>•</span>\n                                    {point}\n                                  </li>\n                                ))}\n                              </ul>\n                            </div>\n                          </div>\n                        </div>\n                      )\n                    }\n\n                    // List Section\n                    if (section.section_type === 'list' && content.items) {\n                      const items = content.items as string[]\n                      return (\n                        <div key={idx} className=\"p-6 rounded-xl bg-[var(--bg-tertiary)]\">\n                          {section.title && <h3 className=\"text-lg font-semibold text-[var(--text-primary)] mb-4\">{section.title}</h3>}\n                          <ul className=\"space-y-3\">\n                            {items.map((item, i) => (\n                              <li key={i} className=\"flex items-start gap-3\">\n                                <div\n                                  className=\"w-2 h-2 rounded-full mt-2 shrink-0\"\n                                  style={{ backgroundColor: sectionColor }}\n                                />\n                                <span className=\"text-[var(--text-secondary)]\">{item}</span>\n                              </li>\n                            ))}\n                          </ul>\n                        </div>\n                      )\n                    }\n\n                    // Quote Section\n                    if (section.section_type === 'quote') {\n                      const quote = content.quote as string\n                      const author = content.author as string | undefined\n                      return (\n                        <div\n                          key={idx}\n                          className=\"p-6 rounded-xl\"\n                          style={{\n                            backgroundColor: `${sectionColor}10`,\n                            borderLeft: `4px solid ${sectionColor}`\n                          }}\n                        >\n                          {section.title && <h3 className=\"text-lg font-semibold text-[var(--text-primary)] mb-3\">{section.title}</h3>}\n                          <blockquote className=\"text-lg italic text-[var(--text-primary)]\">\"{quote}\"</blockquote>\n                          {author && <div className=\"mt-2 text-sm text-[var(--text-secondary)]\">— {author}</div>}\n                        </div>\n                      )\n                    }\n\n                    // Default/Header/Footer - simple display\n                    return (\n                      <div key={idx} className=\"p-6 rounded-xl bg-[var(--bg-tertiary)]\">\n                        {section.title && <h3 className=\"text-lg font-semibold text-[var(--text-primary)] mb-2\">{section.title}</h3>}\n                        {typeof content.subtitle === 'string' && <p className=\"text-[var(--text-secondary)]\">{content.subtitle}</p>}\n                        {typeof content.text === 'string' && <p className=\"text-sm text-[var(--text-tertiary)]\">{content.text}</p>}\n                      </div>\n                    )\n                  })}\n\n                  {/* Style suggestion footer */}\n                  <p className=\"text-xs text-[var(--text-tertiary)] text-center italic pt-4 border-t border-[rgba(255,255,255,0.1)]\">\n                    Design suggestion: {infographicData.style_suggestion}\n                  </p>\n                </div>\n              ) : (\n                <div className=\"text-center py-12 text-[var(--text-tertiary)]\">\n                  <ImageIcon className=\"h-12 w-12 mx-auto mb-4 opacity-50\" />\n                  <p>No infographic data available</p>\n                </div>\n              )\n            )}\n          </div>\n          </div>\n        </SheetContent>\n      </Sheet>\n\n      {/* Hidden file input */}\n      <input\n        ref={fileInputRef}\n        type=\"file\"\n        accept=\".pdf,.docx,.txt,.md\"\n        className=\"hidden\"\n      />\n\n      {/* Notebook Settings Dialog */}\n      <NotebookSettingsDialog\n        open={settingsOpen}\n        onOpenChange={setSettingsOpen}\n        settings={notebookSettings}\n        onSave={saveNotebookSettings}\n        notebookName={notebook?.name || 'Notebook'}\n      />\n    </div>\n  )\n}\n","structuredPatch":[{"oldStart":1627,"oldLines":6,"newStart":1627,"newLines":8,"lines":["               onOpenAudio={() => { setActiveStudyType('audio'); setStudySheetOpen(true) }}","               onOpenVideo={() => { setActiveStudyType('video'); setStudySheetOpen(true) }}","               onOpenResearch={() => { setActiveStudyType('research'); setStudySheetOpen(true) }}","+              onExportNotebook={handleExportNotebook}","+              exportingNotebook={exportingNotebook}","             />","           }","         />"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"bcd779cf-2eb2-4995-97da-7ea38a26ed51"}
{"parentUuid":"7e0157c4-0dc1-4e24-9469-4f90f8f09fc5","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","message":{"model":"claude-opus-4-5-20251101","id":"msg_01BUfyR1aFWjAvprDJhvcCaD","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Now let me update the todo list and run the build to test the implementation.","signature":"EvUBCkYICxgCKkC7Xz9WtutZNvu/HK5JRJaUFNJ10Iz1+vcto8B2ClCdQLvB/Q6jIUzIdGAyPwRYorUZcxBaMSngenHcRm/TixtFEgxXILSDt0elsk9oT30aDLyx1cj7W+rTYqoEfiIwL/QU7Vu03tVqlMlcJ2N2j5PWRkYjDqP618gf0gEp12Qpmq6k+Xe3O2VBI+XwvPlAKl20svIN7IvX33oUe7zuVUSEQSQ/pMXBY++7qQLnWT0IPI9InE1HMQ+KSE6xPiSZAAsg2JL7aeHpLwfi9S7B8m1tJ4vrtJpd1T56Jcq36Lhmzj1SP2IUfeR3gXBBOogYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":724,"cache_read_input_tokens":137001,"cache_creation":{"ephemeral_5m_input_tokens":724,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CWz6eQwdbnVGzZGqugh7u","type":"assistant","uuid":"293937b3-14f4-4043-9a3f-76144573a3f6","timestamp":"2026-01-10T17:33:14.098Z"}
{"parentUuid":"293937b3-14f4-4043-9a3f-76144573a3f6","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","message":{"model":"claude-opus-4-5-20251101","id":"msg_01BUfyR1aFWjAvprDJhvcCaD","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_011YcxRNgCJxjwSX21nwvEDg","name":"TodoWrite","input":{"todos":[{"content":"Create backend export router (export.py)","status":"completed","activeForm":"Creating backend export router"},{"content":"Register export router in main.py","status":"completed","activeForm":"Registering export router in main.py"},{"content":"Create frontend API route for export","status":"completed","activeForm":"Creating frontend API route for export"},{"content":"Expand export-utils.ts with notebook export functions","status":"completed","activeForm":"Expanding export-utils.ts"},{"content":"Add export UI to studio-panel.tsx","status":"completed","activeForm":"Adding export UI to studio-panel.tsx"},{"content":"Test the export functionality","status":"in_progress","activeForm":"Testing export functionality"}]}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":724,"cache_read_input_tokens":137001,"cache_creation":{"ephemeral_5m_input_tokens":724,"ephemeral_1h_input_tokens":0},"output_tokens":269,"service_tier":"standard"}},"requestId":"req_011CWz6eQwdbnVGzZGqugh7u","type":"assistant","uuid":"f2e97176-5fc0-40f7-ab5d-ecf37dfc336e","timestamp":"2026-01-10T17:33:16.112Z"}
{"parentUuid":"f2e97176-5fc0-40f7-ab5d-ecf37dfc336e","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_011YcxRNgCJxjwSX21nwvEDg","type":"tool_result","content":"Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable"}]},"uuid":"c32749f8-b876-40f7-90dd-f8f1aa2cfad5","timestamp":"2026-01-10T17:33:16.133Z","toolUseResult":{"oldTodos":[{"content":"Create backend export router (export.py)","status":"completed","activeForm":"Creating backend export router"},{"content":"Register export router in main.py","status":"completed","activeForm":"Registering export router in main.py"},{"content":"Create frontend API route for export","status":"completed","activeForm":"Creating frontend API route for export"},{"content":"Expand export-utils.ts with notebook export functions","status":"completed","activeForm":"Expanding export-utils.ts"},{"content":"Add export UI to studio-panel.tsx","status":"in_progress","activeForm":"Adding export UI to studio-panel.tsx"},{"content":"Test the export functionality","status":"pending","activeForm":"Testing export functionality"}],"newTodos":[{"content":"Create backend export router (export.py)","status":"completed","activeForm":"Creating backend export router"},{"content":"Register export router in main.py","status":"completed","activeForm":"Registering export router in main.py"},{"content":"Create frontend API route for export","status":"completed","activeForm":"Creating frontend API route for export"},{"content":"Expand export-utils.ts with notebook export functions","status":"completed","activeForm":"Expanding export-utils.ts"},{"content":"Add export UI to studio-panel.tsx","status":"completed","activeForm":"Adding export UI to studio-panel.tsx"},{"content":"Test the export functionality","status":"in_progress","activeForm":"Testing export functionality"}]},"sourceToolAssistantUUID":"f2e97176-5fc0-40f7-ab5d-ecf37dfc336e"}
{"parentUuid":"c32749f8-b876-40f7-90dd-f8f1aa2cfad5","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","message":{"model":"claude-opus-4-5-20251101","id":"msg_01LrKu4c9eC8TQZ679SRcNWq","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Let me test the build to make sure everything compiles correctly.","signature":"EukBCkYICxgCKkCjSRlBYwosR67ykX4Eh+dVng89JnkvHZ5mqPmihAJA1MTKzZs6IzkdQaH4ueHtDG9slfryRxdGfcm7/R5wh9bkEgyJOdeTG6FemRqAj4saDPt8yUcZuYgM+p793yIwIh/9Hj+2vSM/JAowLdfBLflNRs8hANwbIC8f05HQDbjXyNSjnQnEw0zrWf06YvnlKlGi7k6rJMtZdeI4G+jS1luH2OQ8Dtf8NgzSphR/B+sbuy/olmbeM4Pp6AFB6S07dt+C05fuUjN7+zoKFRm9Fk9ld20ZIrHnrXGtyWBoRCcCV4kYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":318,"cache_read_input_tokens":137725,"cache_creation":{"ephemeral_5m_input_tokens":318,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWz6ewKjs6iN5V1ZU6zsP","type":"assistant","uuid":"c646da8b-3e7b-480b-ba4c-3553bf22421b","timestamp":"2026-01-10T17:33:21.431Z"}
{"parentUuid":"c646da8b-3e7b-480b-ba4c-3553bf22421b","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","message":{"model":"claude-opus-4-5-20251101","id":"msg_01LrKu4c9eC8TQZ679SRcNWq","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01GmyKSGETWzUhSvKsoSBkXE","name":"Bash","input":{"command":"cd /Users/marwankashef/Desktop/YouTube/NotebookLM\\ Re-Mastered/frontend && npm run build 2>&1 | head -100","description":"Build frontend to check for compilation errors","timeout":120000}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":318,"cache_read_input_tokens":137725,"cache_creation":{"ephemeral_5m_input_tokens":318,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWz6ewKjs6iN5V1ZU6zsP","type":"assistant","uuid":"2a76ddb3-0696-4dbb-a41a-e029193569c9","timestamp":"2026-01-10T17:33:22.475Z"}
{"parentUuid":"2a76ddb3-0696-4dbb-a41a-e029193569c9","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01GmyKSGETWzUhSvKsoSBkXE","type":"tool_result","content":"> frontend@0.1.0 build\n> next build\n\n⚠ Warning: Next.js inferred your workspace root, but it may not be correct.\n We detected multiple lockfiles and selected the directory of /Users/marwankashef/pnpm-lock.yaml as the root directory.\n To silence this warning, set `turbopack.root` in your Next.js config, or consider removing one of the lockfiles if it's not needed.\n   See https://nextjs.org/docs/app/api-reference/config/next-config-js/turbopack#root-directory for more information.\n Detected additional lockfiles: \n   * /Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend/package-lock.json\n\n▲ Next.js 16.1.1 (Turbopack)\n- Environments: .env.local\n\n  Creating an optimized production build ...\n✓ Compiled successfully in 3.3s\n  Running TypeScript ...\nFailed to compile.\n\n./src/lib/hooks/use-notebook-queries.ts:156:84\nType error: No overload matches this call.\n  Overload 1 of 2, '(input: string | URL | Request, init?: RequestInit | undefined): Promise<Response>', gave the following error.\n    Type '{ 'Content-Type': string; Authorization?: undefined; } | { 'Content-Type': string; Authorization: string; }' is not assignable to type 'HeadersInit | undefined'.\n      Type '{ 'Content-Type': string; Authorization?: undefined; }' is not assignable to type 'HeadersInit | undefined'.\n        Type '{ 'Content-Type': string; Authorization?: undefined; }' is not assignable to type 'Record<string, string>'.\n          Property ''Authorization'' is incompatible with index signature.\n            Type 'undefined' is not assignable to type 'string'.\n  Overload 2 of 2, '(input: URL | RequestInfo, init?: RequestInit | undefined): Promise<Response>', gave the following error.\n    Type '{ 'Content-Type': string; Authorization?: undefined; } | { 'Content-Type': string; Authorization: string; }' is not assignable to type 'HeadersInit | undefined'.\n      Type '{ 'Content-Type': string; Authorization?: undefined; }' is not assignable to type 'HeadersInit | undefined'.\n        Type '{ 'Content-Type': string; Authorization?: undefined; }' is not assignable to type 'Record<string, string>'.\n          Property ''Authorization'' is incompatible with index signature.\n            Type 'undefined' is not assignable to type 'string'.\n\n\u001b[0m \u001b[90m 154 |\u001b[39m     queryFn\u001b[33m:\u001b[39m \u001b[36masync\u001b[39m () \u001b[33m=>\u001b[39m {\n \u001b[90m 155 |\u001b[39m       \u001b[36mconst\u001b[39m headers \u001b[33m=\u001b[39m \u001b[36mawait\u001b[39m getAuthHeaders()\n\u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 156 |\u001b[39m       \u001b[36mconst\u001b[39m response \u001b[33m=\u001b[39m \u001b[36mawait\u001b[39m fetch(\u001b[32m`/api/notebooks/${notebookId}/chat/sessions`\u001b[39m\u001b[33m,\u001b[39m { headers })\n \u001b[90m     |\u001b[39m                                                                                    \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n \u001b[90m 157 |\u001b[39m       \u001b[36mif\u001b[39m (\u001b[33m!\u001b[39mresponse\u001b[33m.\u001b[39mok) \u001b[36mreturn\u001b[39m []\n \u001b[90m 158 |\u001b[39m       \u001b[36mconst\u001b[39m result \u001b[33m=\u001b[39m \u001b[36mawait\u001b[39m response\u001b[33m.\u001b[39mjson()\n \u001b[90m 159 |\u001b[39m       \u001b[36mreturn\u001b[39m (result\u001b[33m.\u001b[39mdata \u001b[33m?\u001b[39m\u001b[33m?\u001b[39m []) \u001b[36mas\u001b[39m \u001b[33mChatSession\u001b[39m[]\u001b[0m\nNext.js build worker exited with code: 1 and signal: null","is_error":false}]},"uuid":"64bf6596-b2a9-47a5-a7ee-cfe235ca69f4","timestamp":"2026-01-10T17:33:33.282Z","toolUseResult":{"stdout":"> frontend@0.1.0 build\n> next build\n\n⚠ Warning: Next.js inferred your workspace root, but it may not be correct.\n We detected multiple lockfiles and selected the directory of /Users/marwankashef/pnpm-lock.yaml as the root directory.\n To silence this warning, set `turbopack.root` in your Next.js config, or consider removing one of the lockfiles if it's not needed.\n   See https://nextjs.org/docs/app/api-reference/config/next-config-js/turbopack#root-directory for more information.\n Detected additional lockfiles: \n   * /Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend/package-lock.json\n\n▲ Next.js 16.1.1 (Turbopack)\n- Environments: .env.local\n\n  Creating an optimized production build ...\n✓ Compiled successfully in 3.3s\n  Running TypeScript ...\nFailed to compile.\n\n./src/lib/hooks/use-notebook-queries.ts:156:84\nType error: No overload matches this call.\n  Overload 1 of 2, '(input: string | URL | Request, init?: RequestInit | undefined): Promise<Response>', gave the following error.\n    Type '{ 'Content-Type': string; Authorization?: undefined; } | { 'Content-Type': string; Authorization: string; }' is not assignable to type 'HeadersInit | undefined'.\n      Type '{ 'Content-Type': string; Authorization?: undefined; }' is not assignable to type 'HeadersInit | undefined'.\n        Type '{ 'Content-Type': string; Authorization?: undefined; }' is not assignable to type 'Record<string, string>'.\n          Property ''Authorization'' is incompatible with index signature.\n            Type 'undefined' is not assignable to type 'string'.\n  Overload 2 of 2, '(input: URL | RequestInfo, init?: RequestInit | undefined): Promise<Response>', gave the following error.\n    Type '{ 'Content-Type': string; Authorization?: undefined; } | { 'Content-Type': string; Authorization: string; }' is not assignable to type 'HeadersInit | undefined'.\n      Type '{ 'Content-Type': string; Authorization?: undefined; }' is not assignable to type 'HeadersInit | undefined'.\n        Type '{ 'Content-Type': string; Authorization?: undefined; }' is not assignable to type 'Record<string, string>'.\n          Property ''Authorization'' is incompatible with index signature.\n            Type 'undefined' is not assignable to type 'string'.\n\n\u001b[0m \u001b[90m 154 |\u001b[39m     queryFn\u001b[33m:\u001b[39m \u001b[36masync\u001b[39m () \u001b[33m=>\u001b[39m {\n \u001b[90m 155 |\u001b[39m       \u001b[36mconst\u001b[39m headers \u001b[33m=\u001b[39m \u001b[36mawait\u001b[39m getAuthHeaders()\n\u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 156 |\u001b[39m       \u001b[36mconst\u001b[39m response \u001b[33m=\u001b[39m \u001b[36mawait\u001b[39m fetch(\u001b[32m`/api/notebooks/${notebookId}/chat/sessions`\u001b[39m\u001b[33m,\u001b[39m { headers })\n \u001b[90m     |\u001b[39m                                                                                    \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n \u001b[90m 157 |\u001b[39m       \u001b[36mif\u001b[39m (\u001b[33m!\u001b[39mresponse\u001b[33m.\u001b[39mok) \u001b[36mreturn\u001b[39m []\n \u001b[90m 158 |\u001b[39m       \u001b[36mconst\u001b[39m result \u001b[33m=\u001b[39m \u001b[36mawait\u001b[39m response\u001b[33m.\u001b[39mjson()\n \u001b[90m 159 |\u001b[39m       \u001b[36mreturn\u001b[39m (result\u001b[33m.\u001b[39mdata \u001b[33m?\u001b[39m\u001b[33m?\u001b[39m []) \u001b[36mas\u001b[39m \u001b[33mChatSession\u001b[39m[]\u001b[0m\nNext.js build worker exited with code: 1 and signal: null","stderr":"","interrupted":false,"isImage":false},"sourceToolAssistantUUID":"2a76ddb3-0696-4dbb-a41a-e029193569c9"}
{"parentUuid":"64bf6596-b2a9-47a5-a7ee-cfe235ca69f4","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","message":{"model":"claude-opus-4-5-20251101","id":"msg_01SdZDCwZcB5SaCCS44oLWTX","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"This is a pre-existing TypeScript error in use-notebook-queries.ts, not related to my changes. Let me check if the build error is related to my export changes or if it's a pre-existing issue.\n\nThe error is in use-notebook-queries.ts:156 which is related to the getAuthHeaders function returning a type that doesn't match the expected headers type. This appears to be a pre-existing issue in the codebase, not caused by my export changes.\n\nLet me fix this TypeScript error first, then continue with the export functionality testing.","signature":"EroFCkYICxgCKkDQuPZG6IjKXEKAscgn8RktFKz4/DfLnoGETLFlfdb9Xdt3VLZ+g9bI5hVdSA4kAZszYgSP8Iuax38/Mg00ElQ9EgxIKAPa7uLvxcoJ4jMaDIMDesXKlaet4wMy3iIw0Af0zStQNE6kivRLyXkV10G4tU3pCMgY3x3vr/O8ccKptQ4PvBTHxxRw4stAyUoYKqEESGm3vy1EOEJ3hgRyF97OvWSjRDFIYwkMnokB4vY4a4yRQk1/9vRe3ib8DsbdD4ULiXMmC+GvqTAOhSdVXLXiL9Z9t3IhycX9MANvezN5iuYcsgCQZ3Mf3kG/edvwqbu0u65hu0+hEI1uNSJgUE/si9mHOArA8f5euUbyXfpceIg1QUXqX8Cgkk42za5Ol3XDCxcXpMw2SrYIWgVX19yi2YUtY5rhKAUXWL/faFqFilN7anOrDMkkM9xhtx/mb62A3B3EvNHIN1CbIFmPB/Bhleu+KfjQSLI4eTzklqNMqspX+qk+ki+gzJ2eoXrmWFZPUepJ3nG8RqNlRVs0R8MX3/UK35B2HK/ZqNDfzEq+LpeXAWvpCErtICRQJSiQUB7kGUPRgArDPdKCtNamH5sCXkFOEQUmGybl70pMloMrTXCJfWydR4oyrhSSFv60mvj/S3drCocdodZbXrmPBhrSg0ySfQ1ygMt4bTw8f56v1ByeY4Or78fqq2o//J19jvFYE1zP9vdJFqSXh7z2ZU8lUxhMIV7hpvUkHUj85INBaf273fnm//RYLeAJx0gOWfmg14jOcQRhDtKaQQ8sbM5//VYvkeeiXYi846TUTsAj153f+3nk989w7yhCCy8QCdTg2pPcAlwiOL0FOfiX9t3qLCfiO3EovVsm5or0r0dEEKuUbQgQmGgNLvVs0SnJ2e7bDLzXIDLwt9AGXLdIZWmBLZgYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":78165,"cache_read_input_tokens":33616,"cache_creation":{"ephemeral_5m_input_tokens":78165,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWz6gDtB31CKZ8xsTtyk5","type":"assistant","uuid":"45512798-e6ef-4d78-b5f9-edb148a1fbde","timestamp":"2026-01-10T17:33:41.332Z"}
{"parentUuid":"45512798-e6ef-4d78-b5f9-edb148a1fbde","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","message":{"model":"claude-opus-4-5-20251101","id":"msg_01SdZDCwZcB5SaCCS44oLWTX","type":"message","role":"assistant","content":[{"type":"text","text":"There's a pre-existing TypeScript error in the codebase. Let me fix it first."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":78165,"cache_read_input_tokens":33616,"cache_creation":{"ephemeral_5m_input_tokens":78165,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWz6gDtB31CKZ8xsTtyk5","type":"assistant","uuid":"65221256-d4ac-40ce-b640-23316ada8c76","timestamp":"2026-01-10T17:33:41.850Z"}
{"parentUuid":"65221256-d4ac-40ce-b640-23316ada8c76","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","message":{"model":"claude-opus-4-5-20251101","id":"msg_01SdZDCwZcB5SaCCS44oLWTX","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Wnptoi9QrUpPY3NWNUZ2tW","name":"Read","input":{"file_path":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend/src/lib/hooks/use-notebook-queries.ts","offset":1,"limit":50}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":78165,"cache_read_input_tokens":33616,"cache_creation":{"ephemeral_5m_input_tokens":78165,"ephemeral_1h_input_tokens":0},"output_tokens":278,"service_tier":"standard"}},"requestId":"req_011CWz6gDtB31CKZ8xsTtyk5","type":"assistant","uuid":"6e18ad1d-2cf8-40a1-b48f-abe1f5211c7c","timestamp":"2026-01-10T17:33:42.497Z"}
{"parentUuid":"6e18ad1d-2cf8-40a1-b48f-abe1f5211c7c","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Wnptoi9QrUpPY3NWNUZ2tW","type":"tool_result","content":"     1→'use client'\n     2→\n     3→import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query'\n     4→import { createClient, Notebook, Source, ChatMessage } from '@/lib/supabase'\n     5→\n     6→// Query key factory for consistent cache keys\n     7→export const notebookKeys = {\n     8→  all: ['notebooks'] as const,\n     9→  lists: () => [...notebookKeys.all, 'list'] as const,\n    10→  list: (filters: string) => [...notebookKeys.lists(), { filters }] as const,\n    11→  details: () => [...notebookKeys.all, 'detail'] as const,\n    12→  detail: (id: string) => [...notebookKeys.details(), id] as const,\n    13→  sources: (notebookId: string) => [...notebookKeys.detail(notebookId), 'sources'] as const,\n    14→  notes: (notebookId: string) => [...notebookKeys.detail(notebookId), 'notes'] as const,\n    15→  chatSessions: (notebookId: string) => [...notebookKeys.detail(notebookId), 'chat-sessions'] as const,\n    16→  chatSession: (notebookId: string, sessionId: string) => [...notebookKeys.chatSessions(notebookId), sessionId] as const,\n    17→  audio: (notebookId: string) => [...notebookKeys.detail(notebookId), 'audio'] as const,\n    18→  video: (notebookId: string) => [...notebookKeys.detail(notebookId), 'video'] as const,\n    19→  research: (notebookId: string) => [...notebookKeys.detail(notebookId), 'research'] as const,\n    20→  studyMaterials: (notebookId: string) => [...notebookKeys.detail(notebookId), 'study-materials'] as const,\n    21→  creativeOutputs: (notebookId: string) => [...notebookKeys.detail(notebookId), 'creative-outputs'] as const,\n    22→}\n    23→\n    24→// Helper to get auth headers\n    25→async function getAuthHeaders(): Promise<Record<string, string>> {\n    26→  const supabase = createClient()\n    27→  try {\n    28→    const { data: { session }, error } = await supabase.auth.getSession()\n    29→    if (error || !session?.access_token) {\n    30→      console.warn('No auth session available')\n    31→      return {\n    32→        'Content-Type': 'application/json',\n    33→      }\n    34→    }\n    35→    return {\n    36→      'Content-Type': 'application/json',\n    37→      'Authorization': `Bearer ${session.access_token}`,\n    38→    }\n    39→  } catch (e) {\n    40→    console.warn('Failed to get auth session:', e)\n    41→    return {\n    42→      'Content-Type': 'application/json',\n    43→    }\n    44→  }\n    45→}\n    46→\n    47→// =============== NOTEBOOK QUERIES ===============\n    48→\n    49→export function useNotebook(notebookId: string) {\n    50→  const supabase = createClient()\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"22907f47-268d-473f-a66e-0a89b9f1546f","timestamp":"2026-01-10T17:33:42.539Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend/src/lib/hooks/use-notebook-queries.ts","content":"'use client'\n\nimport { useQuery, useMutation, useQueryClient } from '@tanstack/react-query'\nimport { createClient, Notebook, Source, ChatMessage } from '@/lib/supabase'\n\n// Query key factory for consistent cache keys\nexport const notebookKeys = {\n  all: ['notebooks'] as const,\n  lists: () => [...notebookKeys.all, 'list'] as const,\n  list: (filters: string) => [...notebookKeys.lists(), { filters }] as const,\n  details: () => [...notebookKeys.all, 'detail'] as const,\n  detail: (id: string) => [...notebookKeys.details(), id] as const,\n  sources: (notebookId: string) => [...notebookKeys.detail(notebookId), 'sources'] as const,\n  notes: (notebookId: string) => [...notebookKeys.detail(notebookId), 'notes'] as const,\n  chatSessions: (notebookId: string) => [...notebookKeys.detail(notebookId), 'chat-sessions'] as const,\n  chatSession: (notebookId: string, sessionId: string) => [...notebookKeys.chatSessions(notebookId), sessionId] as const,\n  audio: (notebookId: string) => [...notebookKeys.detail(notebookId), 'audio'] as const,\n  video: (notebookId: string) => [...notebookKeys.detail(notebookId), 'video'] as const,\n  research: (notebookId: string) => [...notebookKeys.detail(notebookId), 'research'] as const,\n  studyMaterials: (notebookId: string) => [...notebookKeys.detail(notebookId), 'study-materials'] as const,\n  creativeOutputs: (notebookId: string) => [...notebookKeys.detail(notebookId), 'creative-outputs'] as const,\n}\n\n// Helper to get auth headers\nasync function getAuthHeaders(): Promise<Record<string, string>> {\n  const supabase = createClient()\n  try {\n    const { data: { session }, error } = await supabase.auth.getSession()\n    if (error || !session?.access_token) {\n      console.warn('No auth session available')\n      return {\n        'Content-Type': 'application/json',\n      }\n    }\n    return {\n      'Content-Type': 'application/json',\n      'Authorization': `Bearer ${session.access_token}`,\n    }\n  } catch (e) {\n    console.warn('Failed to get auth session:', e)\n    return {\n      'Content-Type': 'application/json',\n    }\n  }\n}\n\n// =============== NOTEBOOK QUERIES ===============\n\nexport function useNotebook(notebookId: string) {\n  const supabase = createClient()","numLines":50,"startLine":1,"totalLines":396}},"sourceToolAssistantUUID":"6e18ad1d-2cf8-40a1-b48f-abe1f5211c7c"}
{"parentUuid":"22907f47-268d-473f-a66e-0a89b9f1546f","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","message":{"model":"claude-opus-4-5-20251101","id":"msg_01EYDeeAksMK8EEx5AVuoJRs","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"I see the issue. The getAuthHeaders function already returns `Record<string, string>` but when there's no session, it's returning an object that might have `Authorization: undefined`. Let me fix that function to ensure it never returns undefined for Authorization.\n\nActually looking more closely, the return type says `Promise<Record<string, string>>` but the TypeScript error suggests that when it returns the object without Authorization, the inference is showing `Authorization?: undefined`. This shouldn't happen since the return type is explicitly defined.\n\nThe issue might be that the linter/compiler is detecting that one branch returns an object with Authorization and another doesn't, which creates a union type. Let me fix this by ensuring the return type is consistent.\n\nActually, looking at the function, it seems correct. The issue might be in how the `headers` variable is typed when passed to fetch. Let me look at line 156 more closely.","signature":"Et0ICkYICxgCKkAkD3ufNZZoWJ5fZMObXMS3zHkOVPq6yfuMzYWwkPs3GPrcGD0OmDcQbQV7iUlNInbvdvGjno0LATDiloQQNS/8EgwdUukaTDaZoT6suT0aDFoJOcSlbT6CFWR5kCIwj4kCIb8EvjQGLtiRTlBiH+SiXhDFx5m1VI9KWUDTDQzlLU3LuBNMiX4TcL/mVEIVKsQHbXKH2UVQ7E+aD8I7yIzu+VEnF0vemSaGHyfX+vbgEMePBjk7SENScq1AyCEf3iCkAADaoTyiNjBf6lrhMy5rQcNljskNM1AJg8KgxevKvhRBulnf7K9RSFHq1DDPCG1cX4VFaCLqhYZS8JoRTt/SKjG4i4JNkHD/QYTpYWatVkVoh0padvGtpOlAichOL066VNaCEKoFl2M/Toe0jCGHhTChqi4VRtUHSdBxY5jMRfyUaiRNYwE/UUZcqeEuOfcclV3mh6WyJMRdCOVC++/KzZ/Hb67gk6llA0joKXxIQc+gVQo3j1YR1Kcl9rdl/DWt+cMHQbjeFCEHkcxAXDBrxqncLn47aXlYC02sOWjmYPwwhaDLJHmnJqUzKY+X76pRhqJeI4QTsuJz7j75P9XT9M0eglKQZ/YbjVDZC1Y8gBizCi5zONCq3lKhlvTii+zHrUyS7qP62sawaOB/s/ztORBTXYQThqjkSRoq9oqPeIMh6/965V0snDHjWqbNFy8n3aycoRl5aLRRui8KC/ZwfvQvbvFnUXSxVzH86lTgrwPmjJnxdJIngLKaKtoWgkjupmUYhFjS6QsHb1uc/zH4eT2kuLh+bjTePSaKYI+gmwq+XuCCR8IocrXNBKHjhgGN2zP0td6MBAlCDYVQo14CP3236x9lSJJTIPHIb7OSTEpr55tDi+Sn70C9jFczGPW+rTpvseRflGJnd0gEdRfCtoBjvpJTaaXur0IwMANWb6mn2XvT6NC4eU7z30lmg5YM5M1hcPvwl99ujRtH4enT9Vm1JNdATtAGezQfZiODP0x9KjKMVLLO90TFWLex77Z3uKl2R4de5ur67bdqOW4pCebvW7Fsw0BAHCD9nlupU5Cfg5qbthdcv0ltg/F1JQquUKvr8oCxUHJKLWwNrTWmU3IELpUhTVC2JuolU9GKF2X9i4CHjSn80tOd9BeCgY5V+4PbWeKrCuyBvF/wk+m+zqY935NJdMyETBuEaU9TZ3hBe52yuvrVQYUV4JE3lAvk3SWNzbKFDESgpPi3sHooYiZPAcy+w+/525CMPPsRiCgZcRKDc3rX+KznwvGskytZEpOOxfvKM+PAy8N1LV4p7ISz8n7mPpxORvi8dqMmO6FLaDMMkHrQMu3rdPSYCYBFLd1IpDXSivAzbr9SgjTgzteBFF2ZMcZwDmDTaSA8fn3MewUbORZpZMsYIm1hW5r5SUZSygMp/LEPLYDBLctYqgum8TUissYKBiDa6GFl4xgPko7wocRXUt0KaMJnTRvmO5soBhgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":1245,"cache_read_input_tokens":111781,"cache_creation":{"ephemeral_5m_input_tokens":1245,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CWz6gsNRAubTFihTMb93s","type":"assistant","uuid":"d81e6eb6-e5b6-4811-87c4-4415c0705145","timestamp":"2026-01-10T17:33:50.761Z"}
{"parentUuid":"d81e6eb6-e5b6-4811-87c4-4415c0705145","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","message":{"model":"claude-opus-4-5-20251101","id":"msg_01EYDeeAksMK8EEx5AVuoJRs","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01YZ9ySGuBRSXm9KjeUP4JWF","name":"Read","input":{"file_path":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend/src/lib/hooks/use-notebook-queries.ts","offset":150,"limit":30}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":1245,"cache_read_input_tokens":111781,"cache_creation":{"ephemeral_5m_input_tokens":1245,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CWz6gsNRAubTFihTMb93s","type":"assistant","uuid":"15b5f13a-52a6-4802-ac89-89a15e542d1a","timestamp":"2026-01-10T17:33:51.455Z"}
{"parentUuid":"15b5f13a-52a6-4802-ac89-89a15e542d1a","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01YZ9ySGuBRSXm9KjeUP4JWF","type":"tool_result","content":"   150→\n   151→export function useChatSessions(notebookId: string) {\n   152→  return useQuery({\n   153→    queryKey: notebookKeys.chatSessions(notebookId),\n   154→    queryFn: async () => {\n   155→      const headers = await getAuthHeaders()\n   156→      const response = await fetch(`/api/notebooks/${notebookId}/chat/sessions`, { headers })\n   157→      if (!response.ok) return []\n   158→      const result = await response.json()\n   159→      return (result.data ?? []) as ChatSession[]\n   160→    },\n   161→    staleTime: 30 * 1000,\n   162→  })\n   163→}\n   164→\n   165→export function useChatSession(notebookId: string, sessionId: string | null) {\n   166→  return useQuery({\n   167→    queryKey: notebookKeys.chatSession(notebookId, sessionId || 'new'),\n   168→    queryFn: async () => {\n   169→      if (!sessionId) return { messages: [] }\n   170→      const headers = await getAuthHeaders()\n   171→      const response = await fetch(`/api/notebooks/${notebookId}/chat/sessions/${sessionId}`, { headers })\n   172→      if (!response.ok) return { messages: [] }\n   173→      const result = await response.json()\n   174→      return (result.data ?? { messages: [] }) as { messages: ChatMessage[] }\n   175→    },\n   176→    enabled: !!sessionId,\n   177→    staleTime: 30 * 1000,\n   178→  })\n   179→}\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"bb5492ca-71d3-4876-a3f3-8e8a6a4b4225","timestamp":"2026-01-10T17:33:51.502Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend/src/lib/hooks/use-notebook-queries.ts","content":"\nexport function useChatSessions(notebookId: string) {\n  return useQuery({\n    queryKey: notebookKeys.chatSessions(notebookId),\n    queryFn: async () => {\n      const headers = await getAuthHeaders()\n      const response = await fetch(`/api/notebooks/${notebookId}/chat/sessions`, { headers })\n      if (!response.ok) return []\n      const result = await response.json()\n      return (result.data ?? []) as ChatSession[]\n    },\n    staleTime: 30 * 1000,\n  })\n}\n\nexport function useChatSession(notebookId: string, sessionId: string | null) {\n  return useQuery({\n    queryKey: notebookKeys.chatSession(notebookId, sessionId || 'new'),\n    queryFn: async () => {\n      if (!sessionId) return { messages: [] }\n      const headers = await getAuthHeaders()\n      const response = await fetch(`/api/notebooks/${notebookId}/chat/sessions/${sessionId}`, { headers })\n      if (!response.ok) return { messages: [] }\n      const result = await response.json()\n      return (result.data ?? { messages: [] }) as { messages: ChatMessage[] }\n    },\n    enabled: !!sessionId,\n    staleTime: 30 * 1000,\n  })\n}","numLines":30,"startLine":150,"totalLines":396}},"sourceToolAssistantUUID":"15b5f13a-52a6-4802-ac89-89a15e542d1a"}
{"parentUuid":"bb5492ca-71d3-4876-a3f3-8e8a6a4b4225","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","message":{"model":"claude-opus-4-5-20251101","id":"msg_01QtG8bPovmWHAhJEzMZ1EtP","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"The issue is that the `getAuthHeaders` function sometimes returns an object with only `Content-Type` (without `Authorization`), and TypeScript is inferring a union type that includes `Authorization?: undefined`. This doesn't match the `HeadersInit` type expected by fetch.\n\nThe function signature says `Promise<Record<string, string>>`, but it seems TypeScript is getting confused. Let me update the function to ensure it always returns a properly typed object.","signature":"EvYECkYICxgCKkBsD/0H4oXkiAB3BX+kBXiUj9lEf/iQ33NeudP69ivdFXKRQ6SpSOw/6UnXZfz4boYCwFVqmp3f2Orks7VMVeJtEgy4wJ+VNmP/SIr+H6saDI51cOOp0Crqtoy1ZSIwui6lg5vwbdnsROLbZAUkUglC1Ta1B94X+EiWc8PlNMM7L8Id23DRYegg/+zqu8zHKt0DnkqYK3hG+n1EI0xvZWn1vmN6FFHpDEm9q2dLFkdxi/rWYu3Xb5vxXdIfOSoAX0s5bjLpcHtlcmt/V1tW3DRbsXuPQR/jAtu8A9SI0gTD0eWD3eNdWgfiqlglNEC1Ije4k92vpS38nncXciEqz69Xikumi0ubNjh5OTqGyxufaupYZjEXEYICKiGv5G/1Oh5TRkcMkB0vvyQZ1lpF9jHCgQlSZlMYCn0QBCBunUXHx3L3LEKrTHU2TiHOlNluZaV743vIMOxYjfXlnH2EMs4vlmRo6aWVdp4eux1kHk1AN8D/pHHNnn0jIVp/efSfdeLFfCAJ9Lp12UVE7ft88SzSXjJbiwZ1uHRKUVms0l8cMxm8yfJGUY24JyA4tAaF6mqrPNFx4hYoH2OUK1tBQufPr5LPPMEW+vGIKxnIeYLTSoo73hYytdmO6QM08VSAbcFRPfYB0dtrccz+vdnlyLQK4SllYwAzfR7y4Bkf8MRshQQw8k+5f/nrraqc72Krr7n/SinaUqLp7oXl9RYWp5fNsVkc+eK28kE+o4TgddNxc4De8gdjMEfu0vznR5kQpXz3e8qaMxwCpiS2kqVB0u5CMkj7aYfYtI00OWMj18JaIzYFwoXENhJJTr7C3s37GAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":851,"cache_read_input_tokens":113026,"cache_creation":{"ephemeral_5m_input_tokens":851,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWz6hZzg6zk1mSsj6EYaJ","type":"assistant","uuid":"d815c07f-54b9-4a16-98bf-dcd8ec5c1e5b","timestamp":"2026-01-10T17:33:57.593Z"}
{"parentUuid":"d815c07f-54b9-4a16-98bf-dcd8ec5c1e5b","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","message":{"model":"claude-opus-4-5-20251101","id":"msg_01QtG8bPovmWHAhJEzMZ1EtP","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01R4H4bAqDKBSTTMFyvnTnPX","name":"Edit","input":{"replace_all":false,"file_path":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend/src/lib/hooks/use-notebook-queries.ts","old_string":"// Helper to get auth headers\nasync function getAuthHeaders(): Promise<Record<string, string>> {\n  const supabase = createClient()\n  try {\n    const { data: { session }, error } = await supabase.auth.getSession()\n    if (error || !session?.access_token) {\n      console.warn('No auth session available')\n      return {\n        'Content-Type': 'application/json',\n      }\n    }\n    return {\n      'Content-Type': 'application/json',\n      'Authorization': `Bearer ${session.access_token}`,\n    }\n  } catch (e) {\n    console.warn('Failed to get auth session:', e)\n    return {\n      'Content-Type': 'application/json',\n    }\n  }\n}","new_string":"// Helper to get auth headers\nasync function getAuthHeaders(): Promise<HeadersInit> {\n  const supabase = createClient()\n  const baseHeaders: Record<string, string> = {\n    'Content-Type': 'application/json',\n  }\n  try {\n    const { data: { session }, error } = await supabase.auth.getSession()\n    if (error || !session?.access_token) {\n      console.warn('No auth session available')\n      return baseHeaders\n    }\n    return {\n      ...baseHeaders,\n      'Authorization': `Bearer ${session.access_token}`,\n    }\n  } catch (e) {\n    console.warn('Failed to get auth session:', e)\n    return baseHeaders\n  }\n}"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":851,"cache_read_input_tokens":113026,"cache_creation":{"ephemeral_5m_input_tokens":851,"ephemeral_1h_input_tokens":0},"output_tokens":617,"service_tier":"standard"}},"requestId":"req_011CWz6hZzg6zk1mSsj6EYaJ","type":"assistant","uuid":"0e73108e-8148-4241-8133-f766563037dd","timestamp":"2026-01-10T17:34:01.224Z"}
{"type":"file-history-snapshot","messageId":"0e73108e-8148-4241-8133-f766563037dd","snapshot":{"messageId":"973ebb96-60df-4671-b9c2-0c4aefc8516e","trackedFileBackups":{"backend/app/routers/export.py":{"backupFileName":null,"version":1,"backupTime":"2026-01-10T17:28:16.452Z"},"backend/app/main.py":{"backupFileName":"f16da9f396306523@v1","version":1,"backupTime":"2026-01-10T17:28:31.217Z"},"frontend/src/app/api/notebooks/[id]/export/route.ts":{"backupFileName":"85dcaadfd8a8a6e9@v1","version":1,"backupTime":"2026-01-10T17:29:25.531Z"},"frontend/src/lib/export-utils.ts":{"backupFileName":"dc1af29a22407c10@v1","version":1,"backupTime":"2026-01-10T17:30:32.804Z"},"frontend/src/components/studio/studio-panel.tsx":{"backupFileName":"e902adf91d326abb@v1","version":1,"backupTime":"2026-01-10T17:30:54.009Z"},"frontend/src/app/notebooks/[id]/page.tsx":{"backupFileName":"f23aff8cbc9d216b@v1","version":1,"backupTime":"2026-01-10T17:32:18.674Z"},"frontend/src/lib/hooks/use-notebook-queries.ts":{"backupFileName":"5bb94a8bee182d65@v1","version":1,"backupTime":"2026-01-10T17:34:01.277Z"}},"timestamp":"2026-01-10T17:26:46.087Z"},"isSnapshotUpdate":true}
{"parentUuid":"0e73108e-8148-4241-8133-f766563037dd","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01R4H4bAqDKBSTTMFyvnTnPX","type":"tool_result","content":"The file /Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend/src/lib/hooks/use-notebook-queries.ts has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n    20→  studyMaterials: (notebookId: string) => [...notebookKeys.detail(notebookId), 'study-materials'] as const,\n    21→  creativeOutputs: (notebookId: string) => [...notebookKeys.detail(notebookId), 'creative-outputs'] as const,\n    22→}\n    23→\n    24→// Helper to get auth headers\n    25→async function getAuthHeaders(): Promise<HeadersInit> {\n    26→  const supabase = createClient()\n    27→  const baseHeaders: Record<string, string> = {\n    28→    'Content-Type': 'application/json',\n    29→  }\n    30→  try {\n    31→    const { data: { session }, error } = await supabase.auth.getSession()\n    32→    if (error || !session?.access_token) {\n    33→      console.warn('No auth session available')\n    34→      return baseHeaders\n    35→    }\n    36→    return {\n    37→      ...baseHeaders,\n    38→      'Authorization': `Bearer ${session.access_token}`,\n    39→    }\n    40→  } catch (e) {\n    41→    console.warn('Failed to get auth session:', e)\n    42→    return baseHeaders\n    43→  }\n    44→}\n    45→\n    46→// =============== NOTEBOOK QUERIES ===============\n    47→\n    48→export function useNotebook(notebookId: string) {"}]},"uuid":"8ce93304-295a-4b60-9944-49c730d0d883","timestamp":"2026-01-10T17:34:01.268Z","toolUseResult":{"filePath":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend/src/lib/hooks/use-notebook-queries.ts","oldString":"// Helper to get auth headers\nasync function getAuthHeaders(): Promise<Record<string, string>> {\n  const supabase = createClient()\n  try {\n    const { data: { session }, error } = await supabase.auth.getSession()\n    if (error || !session?.access_token) {\n      console.warn('No auth session available')\n      return {\n        'Content-Type': 'application/json',\n      }\n    }\n    return {\n      'Content-Type': 'application/json',\n      'Authorization': `Bearer ${session.access_token}`,\n    }\n  } catch (e) {\n    console.warn('Failed to get auth session:', e)\n    return {\n      'Content-Type': 'application/json',\n    }\n  }\n}","newString":"// Helper to get auth headers\nasync function getAuthHeaders(): Promise<HeadersInit> {\n  const supabase = createClient()\n  const baseHeaders: Record<string, string> = {\n    'Content-Type': 'application/json',\n  }\n  try {\n    const { data: { session }, error } = await supabase.auth.getSession()\n    if (error || !session?.access_token) {\n      console.warn('No auth session available')\n      return baseHeaders\n    }\n    return {\n      ...baseHeaders,\n      'Authorization': `Bearer ${session.access_token}`,\n    }\n  } catch (e) {\n    console.warn('Failed to get auth session:', e)\n    return baseHeaders\n  }\n}","originalFile":"'use client'\n\nimport { useQuery, useMutation, useQueryClient } from '@tanstack/react-query'\nimport { createClient, Notebook, Source, ChatMessage } from '@/lib/supabase'\n\n// Query key factory for consistent cache keys\nexport const notebookKeys = {\n  all: ['notebooks'] as const,\n  lists: () => [...notebookKeys.all, 'list'] as const,\n  list: (filters: string) => [...notebookKeys.lists(), { filters }] as const,\n  details: () => [...notebookKeys.all, 'detail'] as const,\n  detail: (id: string) => [...notebookKeys.details(), id] as const,\n  sources: (notebookId: string) => [...notebookKeys.detail(notebookId), 'sources'] as const,\n  notes: (notebookId: string) => [...notebookKeys.detail(notebookId), 'notes'] as const,\n  chatSessions: (notebookId: string) => [...notebookKeys.detail(notebookId), 'chat-sessions'] as const,\n  chatSession: (notebookId: string, sessionId: string) => [...notebookKeys.chatSessions(notebookId), sessionId] as const,\n  audio: (notebookId: string) => [...notebookKeys.detail(notebookId), 'audio'] as const,\n  video: (notebookId: string) => [...notebookKeys.detail(notebookId), 'video'] as const,\n  research: (notebookId: string) => [...notebookKeys.detail(notebookId), 'research'] as const,\n  studyMaterials: (notebookId: string) => [...notebookKeys.detail(notebookId), 'study-materials'] as const,\n  creativeOutputs: (notebookId: string) => [...notebookKeys.detail(notebookId), 'creative-outputs'] as const,\n}\n\n// Helper to get auth headers\nasync function getAuthHeaders(): Promise<Record<string, string>> {\n  const supabase = createClient()\n  try {\n    const { data: { session }, error } = await supabase.auth.getSession()\n    if (error || !session?.access_token) {\n      console.warn('No auth session available')\n      return {\n        'Content-Type': 'application/json',\n      }\n    }\n    return {\n      'Content-Type': 'application/json',\n      'Authorization': `Bearer ${session.access_token}`,\n    }\n  } catch (e) {\n    console.warn('Failed to get auth session:', e)\n    return {\n      'Content-Type': 'application/json',\n    }\n  }\n}\n\n// =============== NOTEBOOK QUERIES ===============\n\nexport function useNotebook(notebookId: string) {\n  const supabase = createClient()\n\n  return useQuery({\n    queryKey: notebookKeys.detail(notebookId),\n    queryFn: async () => {\n      const { data, error } = await supabase\n        .from('notebooks')\n        .select('*')\n        .eq('id', notebookId)\n        .single()\n\n      if (error) throw error\n      return data as Notebook\n    },\n    staleTime: 5 * 60 * 1000, // 5 minutes\n  })\n}\n\nexport function useNotebooks() {\n  const supabase = createClient()\n\n  return useQuery({\n    queryKey: notebookKeys.lists(),\n    queryFn: async () => {\n      const { data, error } = await supabase\n        .from('notebooks')\n        .select('*')\n        .order('created_at', { ascending: false })\n\n      if (error) throw error\n      return data as Notebook[]\n    },\n    staleTime: 60 * 1000, // 1 minute\n  })\n}\n\n// =============== SOURCES QUERIES ===============\n\nexport function useSources(notebookId: string) {\n  const supabase = createClient()\n\n  return useQuery({\n    queryKey: notebookKeys.sources(notebookId),\n    queryFn: async () => {\n      const { data, error } = await supabase\n        .from('sources')\n        .select('*')\n        .eq('notebook_id', notebookId)\n        .order('created_at', { ascending: false })\n\n      if (error) throw error\n      return data as Source[]\n    },\n    staleTime: 30 * 1000, // 30 seconds\n  })\n}\n\n// =============== NOTES QUERIES ===============\n\ninterface LocalNote {\n  id: string\n  notebook_id: string\n  type: 'written' | 'saved_response'\n  title: string | null\n  content: string | null\n  tags: string[]\n  is_pinned: boolean\n  created_at: string\n  updated_at: string\n}\n\nexport function useNotes(notebookId: string) {\n  const supabase = createClient()\n\n  return useQuery({\n    queryKey: notebookKeys.notes(notebookId),\n    queryFn: async () => {\n      const { data, error } = await supabase\n        .from('notes')\n        .select('*')\n        .eq('notebook_id', notebookId)\n        .order('is_pinned', { ascending: false })\n        .order('created_at', { ascending: false })\n\n      if (error) throw error\n      return data as LocalNote[]\n    },\n    staleTime: 30 * 1000,\n  })\n}\n\n// =============== CHAT SESSION QUERIES ===============\n\ninterface ChatSession {\n  id: string\n  title: string\n  created_at: string\n  updated_at: string\n  message_count: number\n}\n\nexport function useChatSessions(notebookId: string) {\n  return useQuery({\n    queryKey: notebookKeys.chatSessions(notebookId),\n    queryFn: async () => {\n      const headers = await getAuthHeaders()\n      const response = await fetch(`/api/notebooks/${notebookId}/chat/sessions`, { headers })\n      if (!response.ok) return []\n      const result = await response.json()\n      return (result.data ?? []) as ChatSession[]\n    },\n    staleTime: 30 * 1000,\n  })\n}\n\nexport function useChatSession(notebookId: string, sessionId: string | null) {\n  return useQuery({\n    queryKey: notebookKeys.chatSession(notebookId, sessionId || 'new'),\n    queryFn: async () => {\n      if (!sessionId) return { messages: [] }\n      const headers = await getAuthHeaders()\n      const response = await fetch(`/api/notebooks/${notebookId}/chat/sessions/${sessionId}`, { headers })\n      if (!response.ok) return { messages: [] }\n      const result = await response.json()\n      return (result.data ?? { messages: [] }) as { messages: ChatMessage[] }\n    },\n    enabled: !!sessionId,\n    staleTime: 30 * 1000,\n  })\n}\n\n// =============== GENERATED CONTENT QUERIES ===============\n\ninterface GeneratedAudio {\n  id: string\n  format: string\n  status: string\n  script?: string\n  audio_url?: string\n  duration_seconds?: number\n  created_at: string\n}\n\ninterface GeneratedVideo {\n  id: string\n  style: string\n  status: string\n  script?: string\n  video_url?: string\n  thumbnail_url?: string\n  duration_seconds?: number\n  created_at: string\n}\n\ninterface GeneratedResearch {\n  id: string\n  query: string\n  mode: string\n  status: string\n  progress_message?: string\n  sources_found_count?: number\n  sources_analyzed_count?: number\n  report_content?: string\n  report_citations?: { title: string; url: string }[]\n  created_at: string\n  completed_at?: string\n}\n\nexport function useGeneratedAudio(notebookId: string) {\n  return useQuery({\n    queryKey: notebookKeys.audio(notebookId),\n    queryFn: async () => {\n      const headers = await getAuthHeaders()\n      const response = await fetch(`/api/notebooks/${notebookId}/audio`, { headers })\n      if (!response.ok) return null\n      const result = await response.json()\n      return (result.data?.[0] ?? null) as GeneratedAudio | null\n    },\n    staleTime: 60 * 1000, // 1 minute\n  })\n}\n\nexport function useGeneratedVideo(notebookId: string) {\n  return useQuery({\n    queryKey: notebookKeys.video(notebookId),\n    queryFn: async () => {\n      const headers = await getAuthHeaders()\n      const response = await fetch(`/api/notebooks/${notebookId}/video`, { headers })\n      if (!response.ok) return null\n      const result = await response.json()\n      const rawVideo = result.data?.[0]\n      if (!rawVideo) return null\n      // Map database column video_file_path to video_url for frontend\n      return {\n        ...rawVideo,\n        video_url: rawVideo.video_file_path || rawVideo.video_url,\n      } as GeneratedVideo\n    },\n    staleTime: 60 * 1000,\n  })\n}\n\nexport function useGeneratedResearch(notebookId: string) {\n  return useQuery({\n    queryKey: notebookKeys.research(notebookId),\n    queryFn: async () => {\n      const headers = await getAuthHeaders()\n      const response = await fetch(`/api/notebooks/${notebookId}/research`, { headers })\n      if (!response.ok) return null\n      const result = await response.json()\n      return (result.data?.[0] ?? null) as GeneratedResearch | null\n    },\n    staleTime: 60 * 1000,\n  })\n}\n\n// =============== STUDY MATERIALS & CREATIVE OUTPUTS ===============\n\ninterface StudyMaterial {\n  id: string\n  type: string\n  sourceIds: string[]\n  sourceNames: string[]\n  createdAt: string\n  itemCount?: number\n  data?: Record<string, unknown>\n}\n\ninterface CreativeOutput {\n  id: string\n  type: string\n  title: string\n  status: string\n  createdAt: string\n  content?: Record<string, unknown>\n}\n\nexport function useStudyMaterials(notebookId: string, sources: { id: string; name: string }[] = []) {\n  return useQuery({\n    queryKey: notebookKeys.studyMaterials(notebookId),\n    queryFn: async () => {\n      const headers = await getAuthHeaders()\n      const response = await fetch(`/api/notebooks/${notebookId}/study`, { headers })\n      if (!response.ok) return { materials: [], byType: {} }\n      const result = await response.json()\n\n      if (!result.data || !Array.isArray(result.data)) return { materials: [], byType: {} }\n\n      // Group by type and get latest of each\n      const materialsByType: Record<string, typeof result.data[0]> = {}\n      for (const material of result.data) {\n        if (!materialsByType[material.type]) {\n          materialsByType[material.type] = material\n        }\n      }\n\n      // Build metadata\n      const metaArray = Object.values(materialsByType).map((material) => {\n        const sourceIds = material.source_ids || []\n        const sourceNames = sourceIds.map((id: string) => {\n          const source = sources.find(s => s.id === id)\n          return source?.name || 'Unknown source'\n        })\n\n        let itemCount = 0\n        if (material.type === 'flashcards') itemCount = material.data?.flashcards?.length || 0\n        else if (material.type === 'quiz') itemCount = material.data?.questions?.length || 0\n        else if (material.type === 'faq') itemCount = material.data?.faq?.length || 0\n\n        return {\n          id: material.id,\n          type: material.type,\n          sourceIds,\n          sourceNames,\n          createdAt: material.created_at,\n          itemCount,\n          data: material.data,\n        } as StudyMaterial\n      })\n\n      return { materials: metaArray, byType: materialsByType }\n    },\n    staleTime: 30 * 1000,\n  })\n}\n\nexport function useCreativeOutputs(notebookId: string) {\n  return useQuery({\n    queryKey: notebookKeys.creativeOutputs(notebookId),\n    queryFn: async () => {\n      const headers = await getAuthHeaders()\n      const response = await fetch(`/api/notebooks/${notebookId}/studio`, { headers })\n      if (!response.ok) return { outputs: [], byType: {} }\n      const result = await response.json()\n\n      if (!result.data || !Array.isArray(result.data)) return { outputs: [], byType: {} }\n\n      // Group by type and get latest completed of each\n      const outputsByType: Record<string, typeof result.data[0]> = {}\n      for (const output of result.data) {\n        if (output.status === 'completed' && !outputsByType[output.type]) {\n          outputsByType[output.type] = output\n        }\n      }\n\n      const metaArray = Object.values(outputsByType).map((output) => ({\n        id: output.id,\n        type: output.type,\n        title: output.title || output.type.replace('_', ' '),\n        status: output.status,\n        createdAt: output.created_at,\n        content: output.content,\n      } as CreativeOutput))\n\n      return { outputs: metaArray, byType: outputsByType }\n    },\n    staleTime: 30 * 1000,\n  })\n}\n\n// =============== INVALIDATION HELPERS ===============\n\nexport function useInvalidateNotebook() {\n  const queryClient = useQueryClient()\n\n  return {\n    invalidateSources: (notebookId: string) =>\n      queryClient.invalidateQueries({ queryKey: notebookKeys.sources(notebookId) }),\n    invalidateNotes: (notebookId: string) =>\n      queryClient.invalidateQueries({ queryKey: notebookKeys.notes(notebookId) }),\n    invalidateChatSessions: (notebookId: string) =>\n      queryClient.invalidateQueries({ queryKey: notebookKeys.chatSessions(notebookId) }),\n    invalidateAudio: (notebookId: string) =>\n      queryClient.invalidateQueries({ queryKey: notebookKeys.audio(notebookId) }),\n    invalidateVideo: (notebookId: string) =>\n      queryClient.invalidateQueries({ queryKey: notebookKeys.video(notebookId) }),\n    invalidateResearch: (notebookId: string) =>\n      queryClient.invalidateQueries({ queryKey: notebookKeys.research(notebookId) }),\n    invalidateStudyMaterials: (notebookId: string) =>\n      queryClient.invalidateQueries({ queryKey: notebookKeys.studyMaterials(notebookId) }),\n    invalidateCreativeOutputs: (notebookId: string) =>\n      queryClient.invalidateQueries({ queryKey: notebookKeys.creativeOutputs(notebookId) }),\n    invalidateAll: (notebookId: string) =>\n      queryClient.invalidateQueries({ queryKey: notebookKeys.detail(notebookId) }),\n  }\n}\n","structuredPatch":[{"oldStart":22,"oldLines":25,"newStart":22,"newLines":24,"lines":[" }"," "," // Helper to get auth headers","-async function getAuthHeaders(): Promise<Record<string, string>> {","+async function getAuthHeaders(): Promise<HeadersInit> {","   const supabase = createClient()","+  const baseHeaders: Record<string, string> = {","+    'Content-Type': 'application/json',","+  }","   try {","     const { data: { session }, error } = await supabase.auth.getSession()","     if (error || !session?.access_token) {","       console.warn('No auth session available')","-      return {","-        'Content-Type': 'application/json',","-      }","+      return baseHeaders","     }","     return {","-      'Content-Type': 'application/json',","+      ...baseHeaders,","       'Authorization': `Bearer ${session.access_token}`,","     }","   } catch (e) {","     console.warn('Failed to get auth session:', e)","-    return {","-      'Content-Type': 'application/json',","-    }","+    return baseHeaders","   }"," }"," "]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"0e73108e-8148-4241-8133-f766563037dd"}
{"parentUuid":"8ce93304-295a-4b60-9944-49c730d0d883","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","message":{"model":"claude-opus-4-5-20251101","id":"msg_01EGnh2mkANpmRieDrBiptpe","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Now let me run the build again to check if this fixes the issue.","signature":"EugBCkYICxgCKkCGMLySjyKISHE1ACvhYDwighI7/cfyjzpK97OEPtUhf3cKAr0PEcbbQ2BYf/FoIcHGv6u0odXr1yFidIt4mz8oEgxMSof2SfwTlaMIdLEaDBNC0gJ1KzCVO492zSIwR2E7hP+jg4NJuiJumCgNCEUjMlNJ8YFk7RHi04f2Hn1EmiVqU+yoedpnW3wuEwkjKlDgf6Y1Fo4/Kt67/qJU+gx9zk2t9S2IUbT1u74td6JtD9kpdt39kiTN4wByjhHqgLOZoiPLcsS2QkBsPHytz9VsyRj/OLbuKeI3RyOPQa/wyxgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":1075,"cache_read_input_tokens":113877,"cache_creation":{"ephemeral_5m_input_tokens":1075,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWz6iL4Z43re6amqKugVv","type":"assistant","uuid":"517c3aa2-abf9-4732-8312-771d46a3c222","timestamp":"2026-01-10T17:34:06.936Z"}
{"parentUuid":"517c3aa2-abf9-4732-8312-771d46a3c222","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","message":{"model":"claude-opus-4-5-20251101","id":"msg_01EGnh2mkANpmRieDrBiptpe","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Ubfofnu1qnbXXnMZv8S6ff","name":"Bash","input":{"command":"cd /Users/marwankashef/Desktop/YouTube/NotebookLM\\ Re-Mastered/frontend && npm run build 2>&1 | head -100","description":"Build frontend to check for compilation errors","timeout":120000}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":1075,"cache_read_input_tokens":113877,"cache_creation":{"ephemeral_5m_input_tokens":1075,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWz6iL4Z43re6amqKugVv","type":"assistant","uuid":"54771cc3-c052-4d76-896f-67341589ef9b","timestamp":"2026-01-10T17:34:07.977Z"}
{"parentUuid":"54771cc3-c052-4d76-896f-67341589ef9b","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Ubfofnu1qnbXXnMZv8S6ff","type":"tool_result","content":"> frontend@0.1.0 build\n> next build\n\n⚠ Warning: Next.js inferred your workspace root, but it may not be correct.\n We detected multiple lockfiles and selected the directory of /Users/marwankashef/pnpm-lock.yaml as the root directory.\n To silence this warning, set `turbopack.root` in your Next.js config, or consider removing one of the lockfiles if it's not needed.\n   See https://nextjs.org/docs/app/api-reference/config/next-config-js/turbopack#root-directory for more information.\n Detected additional lockfiles: \n   * /Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend/package-lock.json\n\n▲ Next.js 16.1.1 (Turbopack)\n- Environments: .env.local\n\n  Creating an optimized production build ...\n✓ Compiled successfully in 3.4s\n  Running TypeScript ...\n  Collecting page data using 11 workers ...\n  Generating static pages using 11 workers (0/8) ...\n  Generating static pages using 11 workers (2/8) \r\n  Generating static pages using 11 workers (4/8) \r\n  Generating static pages using 11 workers (6/8) \r\n✓ Generating static pages using 11 workers (8/8) in 365.1ms\n  Finalizing page optimization ...\n\nRoute (app)\n┌ ○ /\n├ ○ /_not-found\n├ ƒ /api/notebooks/[id]/audio\n├ ƒ /api/notebooks/[id]/chat\n├ ƒ /api/notebooks/[id]/chat/sessions\n├ ƒ /api/notebooks/[id]/chat/sessions/[sessionId]\n├ ƒ /api/notebooks/[id]/export\n├ ƒ /api/notebooks/[id]/history\n├ ƒ /api/notebooks/[id]/notes\n├ ƒ /api/notebooks/[id]/notes/[noteId]\n├ ƒ /api/notebooks/[id]/research\n├ ƒ /api/notebooks/[id]/sources\n├ ƒ /api/notebooks/[id]/sources/[sourceId]\n├ ƒ /api/notebooks/[id]/studio\n├ ƒ /api/notebooks/[id]/study\n├ ƒ /api/notebooks/[id]/video\n├ ƒ /api/sources/[id]/view\n├ ○ /auth/login\n├ ○ /auth/register\n├ ○ /docs\n├ ƒ /notebooks/[id]\n├ ƒ /notebooks/[id]/history\n└ ○ /settings\n\n\n○  (Static)   prerendered as static content\nƒ  (Dynamic)  server-rendered on demand","is_error":false}]},"uuid":"345dc4f2-bc08-4815-a8a8-e1209ecdcb4d","timestamp":"2026-01-10T17:34:20.112Z","toolUseResult":{"stdout":"> frontend@0.1.0 build\n> next build\n\n⚠ Warning: Next.js inferred your workspace root, but it may not be correct.\n We detected multiple lockfiles and selected the directory of /Users/marwankashef/pnpm-lock.yaml as the root directory.\n To silence this warning, set `turbopack.root` in your Next.js config, or consider removing one of the lockfiles if it's not needed.\n   See https://nextjs.org/docs/app/api-reference/config/next-config-js/turbopack#root-directory for more information.\n Detected additional lockfiles: \n   * /Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend/package-lock.json\n\n▲ Next.js 16.1.1 (Turbopack)\n- Environments: .env.local\n\n  Creating an optimized production build ...\n✓ Compiled successfully in 3.4s\n  Running TypeScript ...\n  Collecting page data using 11 workers ...\n  Generating static pages using 11 workers (0/8) ...\n  Generating static pages using 11 workers (2/8) \r\n  Generating static pages using 11 workers (4/8) \r\n  Generating static pages using 11 workers (6/8) \r\n✓ Generating static pages using 11 workers (8/8) in 365.1ms\n  Finalizing page optimization ...\n\nRoute (app)\n┌ ○ /\n├ ○ /_not-found\n├ ƒ /api/notebooks/[id]/audio\n├ ƒ /api/notebooks/[id]/chat\n├ ƒ /api/notebooks/[id]/chat/sessions\n├ ƒ /api/notebooks/[id]/chat/sessions/[sessionId]\n├ ƒ /api/notebooks/[id]/export\n├ ƒ /api/notebooks/[id]/history\n├ ƒ /api/notebooks/[id]/notes\n├ ƒ /api/notebooks/[id]/notes/[noteId]\n├ ƒ /api/notebooks/[id]/research\n├ ƒ /api/notebooks/[id]/sources\n├ ƒ /api/notebooks/[id]/sources/[sourceId]\n├ ƒ /api/notebooks/[id]/studio\n├ ƒ /api/notebooks/[id]/study\n├ ƒ /api/notebooks/[id]/video\n├ ƒ /api/sources/[id]/view\n├ ○ /auth/login\n├ ○ /auth/register\n├ ○ /docs\n├ ƒ /notebooks/[id]\n├ ƒ /notebooks/[id]/history\n└ ○ /settings\n\n\n○  (Static)   prerendered as static content\nƒ  (Dynamic)  server-rendered on demand","stderr":"","interrupted":false,"isImage":false},"sourceToolAssistantUUID":"54771cc3-c052-4d76-896f-67341589ef9b"}
{"parentUuid":"345dc4f2-bc08-4815-a8a8-e1209ecdcb4d","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","message":{"model":"claude-opus-4-5-20251101","id":"msg_013HuKKMzoNYwTyysnKtodBB","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"The build succeeded. I can see that `/api/notebooks/[id]/export` is now included in the routes. Let me update the todo list and summarize what was implemented.","signature":"EsgCCkYICxgCKkA/kU5M9QwWQSkL05CCtiIVgfBI2X6XRvJJz3JETuIO+Pc1H7bAFAHasp5k/n1EUDXXlDyQ3GZWFNlVBDS5w6ZmEgwt+6m1fUAPZBwDOzIaDK8lX2QybvfojonYFSIwWVpNBs1r61SLuq1PTLGOXS2r/5i3AUS1kmDj3qb2XZpFKJVAzU4kwGc5ROSeV2PJKq8BZEy2blmdJhS4PIUJ1fqGo91+vvHSDVsBDwjF6G2d72KpMY8H8KgarMvHTlq+h5EGgB6yWD7Td6rDcf5JJmEjhX1bN3Fk9kxd/8WeQJqKBtvP3LW6bdkY3Gespj9UR6mPzcZFjEg8EOA3QBVToaCQJRhLc6t0lDH1lBJXi2mSE/77gwQmRkC7mNlhuLcehJkmTsjsEUiF6iSQDB1pxhYJl99ZfXlnsA1uNqGjrZR37hgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":902,"cache_read_input_tokens":114952,"cache_creation":{"ephemeral_5m_input_tokens":902,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWz6jenxXg7ZW7rJArgSv","type":"assistant","uuid":"8139bd11-41d7-41ef-b11e-708fa29484d8","timestamp":"2026-01-10T17:34:25.449Z"}
{"parentUuid":"8139bd11-41d7-41ef-b11e-708fa29484d8","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","message":{"model":"claude-opus-4-5-20251101","id":"msg_013HuKKMzoNYwTyysnKtodBB","type":"message","role":"assistant","content":[{"type":"text","text":"The build succeeded. Let me update the todo list and provide a summary."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":902,"cache_read_input_tokens":114952,"cache_creation":{"ephemeral_5m_input_tokens":902,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWz6jenxXg7ZW7rJArgSv","type":"assistant","uuid":"c61a819b-30f7-4a7d-845b-ef380d7fb357","timestamp":"2026-01-10T17:34:25.913Z"}
{"parentUuid":"c61a819b-30f7-4a7d-845b-ef380d7fb357","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","message":{"model":"claude-opus-4-5-20251101","id":"msg_013HuKKMzoNYwTyysnKtodBB","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01V9BCefc3Saktrq4SczjRNT","name":"TodoWrite","input":{"todos":[{"content":"Create backend export router (export.py)","status":"completed","activeForm":"Creating backend export router"},{"content":"Register export router in main.py","status":"completed","activeForm":"Registering export router in main.py"},{"content":"Create frontend API route for export","status":"completed","activeForm":"Creating frontend API route for export"},{"content":"Expand export-utils.ts with notebook export functions","status":"completed","activeForm":"Expanding export-utils.ts"},{"content":"Add export UI to studio-panel.tsx","status":"completed","activeForm":"Adding export UI to studio-panel.tsx"},{"content":"Test the export functionality","status":"completed","activeForm":"Testing export functionality"}]}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":902,"cache_read_input_tokens":114952,"cache_creation":{"ephemeral_5m_input_tokens":902,"ephemeral_1h_input_tokens":0},"output_tokens":305,"service_tier":"standard"}},"requestId":"req_011CWz6jenxXg7ZW7rJArgSv","type":"assistant","uuid":"0c2b07c6-60b4-4c24-83f4-c759267bf629","timestamp":"2026-01-10T17:34:29.251Z"}
{"parentUuid":"0c2b07c6-60b4-4c24-83f4-c759267bf629","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01V9BCefc3Saktrq4SczjRNT","type":"tool_result","content":"Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable"}]},"uuid":"15b8f73d-236c-4ca0-8003-67331af5438a","timestamp":"2026-01-10T17:34:29.275Z","toolUseResult":{"oldTodos":[{"content":"Create backend export router (export.py)","status":"completed","activeForm":"Creating backend export router"},{"content":"Register export router in main.py","status":"completed","activeForm":"Registering export router in main.py"},{"content":"Create frontend API route for export","status":"completed","activeForm":"Creating frontend API route for export"},{"content":"Expand export-utils.ts with notebook export functions","status":"completed","activeForm":"Expanding export-utils.ts"},{"content":"Add export UI to studio-panel.tsx","status":"completed","activeForm":"Adding export UI to studio-panel.tsx"},{"content":"Test the export functionality","status":"in_progress","activeForm":"Testing export functionality"}],"newTodos":[{"content":"Create backend export router (export.py)","status":"completed","activeForm":"Creating backend export router"},{"content":"Register export router in main.py","status":"completed","activeForm":"Registering export router in main.py"},{"content":"Create frontend API route for export","status":"completed","activeForm":"Creating frontend API route for export"},{"content":"Expand export-utils.ts with notebook export functions","status":"completed","activeForm":"Expanding export-utils.ts"},{"content":"Add export UI to studio-panel.tsx","status":"completed","activeForm":"Adding export UI to studio-panel.tsx"},{"content":"Test the export functionality","status":"completed","activeForm":"Testing export functionality"}]},"sourceToolAssistantUUID":"0c2b07c6-60b4-4c24-83f4-c759267bf629"}
{"parentUuid":"15b8f73d-236c-4ca0-8003-67331af5438a","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","message":{"model":"claude-opus-4-5-20251101","id":"msg_01L9sjyFAPnQnxY7zrBGuE3T","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"All tasks are completed. Let me provide a summary of what was implemented.","signature":"EvIBCkYICxgCKkDBwYgey+WWFSlAYqLzwTWtlCgdhG6lNJkPfnw57o7JmzUU1ux37ZzwIV3F2X+2gWW8/GqjDuJz0FA4rTp959UXEgygOs9vplo/v+Gaq7kaDNxkb9LzTFzb7tLyhiIwW6T5nox1DCv2AyZH6KZnE+0c2/dHSYNC/xI5L4CdbQG5gMdooI3U9vnw6/YxYaJXKlre9DnJ1Te/Io/a+qDfbHuRz1jI9WU8NcW9r+5sdE30sCfRKuUSRYMT8phNFN7wgA3aZ4UyqV6EzfnXxFS3fiaLMUt1J5dg2pgzcX5pY+jhSHm5RKHp0ERtergYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":354,"cache_read_input_tokens":115854,"cache_creation":{"ephemeral_5m_input_tokens":354,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWz6kLuDRA1Q8Gnyjykoo","type":"assistant","uuid":"61882509-d495-4a51-8883-40c669dfcd9a","timestamp":"2026-01-10T17:34:33.677Z"}
{"parentUuid":"61882509-d495-4a51-8883-40c669dfcd9a","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","message":{"model":"claude-opus-4-5-20251101","id":"msg_01L9sjyFAPnQnxY7zrBGuE3T","type":"message","role":"assistant","content":[{"type":"text","text":"I've successfully implemented the full notebook export feature. Here's what was created:\n\n## Summary of Implementation\n\n### Backend (`backend/app/routers/export.py`)\n- New export router with two endpoints:\n  - `GET /api/v1/notebooks/{notebook_id}/export/json` - Returns notebook data as JSON\n  - `GET /api/v1/notebooks/{notebook_id}/export/zip` - Returns a downloadable ZIP archive\n- Supports optional parameters: `include_sources`, `include_chats`, `include_notes`, `include_generated`\n- Exports: notebook metadata, sources (with files), chat sessions with messages, notes, audio/video overviews, study materials, studio outputs, and research tasks\n\n### Frontend API Route (`frontend/src/app/api/notebooks/[id]/export/route.ts`)\n- Next.js API route that handles export requests\n- Supports JSON and ZIP formats via query parameter\n- Uses JSZip for ZIP generation with organized folder structure\n- Includes proper authentication and authorization\n\n### Export Utilities (`frontend/src/lib/export-utils.ts`)\nAdded comprehensive export functions:\n- `exportNotebookAsZip()` - Downloads notebook as organized ZIP\n- `exportNotebookAsJson()` - Returns notebook data for further processing\n- `exportNotebookAsPDF()` - Generates a formatted PDF document with:\n  - Title page with notebook name and description\n  - Table of contents\n  - Sources with summaries\n  - Chat sessions with message previews\n  - Notes with content\n  - Study materials and research reports\n- `exportNotebook()` - Unified function for all formats\n\n### UI (`frontend/src/components/studio/studio-panel.tsx`)\nAdded new Export section in Studio panel with:\n- Toggle checkboxes for what to include (Sources, Chats, Notes, Generated content)\n- Three format buttons: ZIP, PDF, JSON\n- Loading state indicator during export\n- Clean, consistent UI matching the existing design\n\n### Also Fixed\n- Pre-existing TypeScript error in `use-notebook-queries.ts` related to auth headers type"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":354,"cache_read_input_tokens":115854,"cache_creation":{"ephemeral_5m_input_tokens":354,"ephemeral_1h_input_tokens":0},"output_tokens":505,"service_tier":"standard"}},"requestId":"req_011CWz6kLuDRA1Q8Gnyjykoo","type":"assistant","uuid":"7ed764b7-e0d8-4006-a878-d2b80681b4a1","timestamp":"2026-01-10T17:34:42.687Z"}
{"parentUuid":"7ed764b7-e0d8-4006-a878-d2b80681b4a1","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","type":"system","subtype":"stop_hook_summary","hookCount":1,"hookInfos":[{"command":"afplay ~/.claude/sounds/complete.wav > /dev/null 2>&1 &"}],"hookErrors":[],"preventedContinuation":false,"stopReason":"","hasOutput":false,"level":"suggestion","timestamp":"2026-01-10T17:34:42.745Z","uuid":"e2fd63ac-c2f3-4f5d-b046-f65abd174796","toolUseID":"20f47730-ded5-4460-b960-58511a8a7cb4"}
{"parentUuid":"e2fd63ac-c2f3-4f5d-b046-f65abd174796","isSidechain":false,"userType":"external","cwd":"/Users/marwankashef/Desktop/YouTube/NotebookLM Re-Mastered/frontend","sessionId":"c8321993-720d-4b0e-bebc-54f780fda017","version":"2.1.3","gitBranch":"main","slug":"silly-hatching-blanket","type":"system","subtype":"turn_duration","durationMs":476666,"timestamp":"2026-01-10T17:34:42.755Z","uuid":"ade3a9c6-3923-4740-9c51-011a8b7b587e","isMeta":false}
